'use client';

import { useEffect, useMemo, useRef, useState } from 'react';
import { AnimatePresence, motion } from 'framer-motion';

type DifficultyTier = 0 | 1 | 2 | 3 | 4;

type BrightOSState = {
  power: 'booting' | 'lock' | 'on';
  cpu_load: number;
  firewall: 'enabled' | 'disabled';
  malware_active: boolean;
  temperature: number;
  user_reputation: number;
  difficulty_tier: DifficultyTier;
  boot_phase: 0 | 1 | 2 | 3 | 4 | 5;
  notifications: Array<{ id: string; kind: 'alert' | 'info'; title: string; body: string }>;
  badge?: { title: string; subtitle: string };
};

type WindowId = 'taskmgr' | 'terminal' | 'defend';

type WindowState = {
  id: WindowId;
  title: string;
  open: boolean;
  minimized: boolean;
  z: number;
  x: number;
  y: number;
  w: number;
  h: number;
};

type ProcessRow = { pid: number; name: string; cpu: number; mem: number; kind: 'system' | 'user' | 'malware' };

type TerminalLine = { id: string; kind: 'in' | 'out' | 'sys'; text: string };

function uid(prefix: string) {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
}

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function fanLevel(cpu: number, temp: number) {
  const stress = Math.max(cpu / 100, (temp - 35) / 70);
  if (stress > 0.85) return 3;
  if (stress > 0.6) return 2;
  if (stress > 0.35) return 1;
  return 0;
}

const BRIGHTOS_PASSWORD = 'brightos';

function initialOS(): BrightOSState {
  return {
    power: 'booting',
    cpu_load: 12,
    firewall: 'disabled',
    malware_active: false,
    temperature: 47,
    user_reputation: 120,
    difficulty_tier: 1,
    boot_phase: 0,
    notifications: [],
  };
}

function initialWindows(): Record<WindowId, WindowState> {
  return {
    taskmgr: { id: 'taskmgr', title: 'Task Manager', open: true, minimized: false, z: 3, x: 80, y: 100, w: 520, h: 420 },
    terminal: { id: 'terminal', title: 'Terminal', open: false, minimized: false, z: 2, x: 180, y: 140, w: 640, h: 420 },
    defend: { id: 'defend', title: 'Defend', open: false, minimized: false, z: 1, x: 130, y: 120, w: 520, h: 380 },
  };
}

export default function MalwareIncidentPractical() {
  const [os, setOs] = useState<BrightOSState>(() => initialOS());
  const [wins, setWins] = useState<Record<WindowId, WindowState>>(() => initialWindows());
  const [tone, setTone] = useState<'caribbean' | 'formal'>('caribbean');
  const [activeWin, setActiveWin] = useState<WindowId>('taskmgr');

  const [now, setNow] = useState(() => new Date());

  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState<string | null>(null);
  const [loginBusy, setLoginBusy] = useState(false);

  const [termLines, setTermLines] = useState<TerminalLine[]>(() => [
    { id: uid('t'), kind: 'sys', text: 'BrightOS Terminal ‚Äî try: scan --deep' },
  ]);
  const [termInput, setTermInput] = useState('');

  const drag = useRef<{ id: WindowId | null; mode: 'move' | 'resize' | null; sx: number; sy: number; x: number; y: number; w: number; h: number }>({
    id: null,
    mode: null,
    sx: 0,
    sy: 0,
    x: 0,
    y: 0,
    w: 0,
    h: 0,
  });

  const uiStutter = os.cpu_load > 80;
  const securityPulse = os.firewall === 'disabled' || os.malware_active;
  const fan = useMemo(() => fanLevel(os.cpu_load, os.temperature), [os.cpu_load, os.temperature]);

  const processes = useMemo<ProcessRow[]>(() => {
    const rows: ProcessRow[] = [
      { pid: 120, name: 'kernel_task', cpu: 4, mem: 6, kind: 'system' },
      { pid: 221, name: 'shell_ui', cpu: uiStutter ? 10 : 3, mem: 9, kind: 'system' },
      { pid: 411, name: 'defend_service', cpu: os.firewall === 'disabled' ? 2 : 4, mem: 4, kind: 'system' },
      { pid: 520, name: 'notes', cpu: 1, mem: 2, kind: 'user' },
    ];
    if (os.malware_active) rows.push({ pid: 777, name: 'miner_x.exe', cpu: 90, mem: 18, kind: 'malware' });
    return rows.sort((a, b) => b.cpu - a.cpu);
  }, [os.malware_active, os.firewall, uiStutter]);

  useEffect(() => {
    const id = window.setInterval(() => setNow(new Date()), 1000);
    return () => window.clearInterval(id);
  }, []);

  useEffect(() => {
    const id = window.setInterval(() => {
      setOs((p) => {
        if (p.power !== 'booting') return p;
        const next = (p.boot_phase + 1) as BrightOSState['boot_phase'];
        if (next >= 5) return { ...p, power: 'lock', boot_phase: 5 };
        return { ...p, boot_phase: next };
      });
    }, 900);
    return () => window.clearInterval(id);
  }, []);

  useEffect(() => {
    if (os.power !== 'on') return;
    const id = window.setTimeout(() => {
      setOs((p) => {
        if (p.malware_active) return p;
        return {
          ...p,
          cpu_load: 90,
          malware_active: true,
          notifications: [
            ...p.notifications,
            {
              id: uid('n'),
              kind: 'alert',
              title: 'SYSTEM ALERT',
              body: p.difficulty_tier <= 1 ? 'Unknown process consuming 90% CPU' : 'CPU usage abnormal. Performance degraded.',
            },
          ],
        };
      });
    }, 1100);
    return () => window.clearTimeout(id);
  }, [os.power]);

  useEffect(() => {
    if (os.power !== 'on') return;
    const id = window.setInterval(() => {
      setOs((p) => {
        let cpu = p.cpu_load;
        let temp = p.temperature;
        if (p.malware_active) {
          cpu = clamp(cpu + 1.5, 80, 95);
          temp = clamp(temp + 0.9, 45, 95);
        } else {
          cpu = clamp(cpu - 2.2, 8, 25);
          temp = clamp(temp - 0.8, 35, 60);
        }
        return { ...p, cpu_load: cpu, temperature: temp };
      });
    }, 350);
    return () => window.clearInterval(id);
  }, [os.power]);

  useEffect(() => {
    if (os.power !== 'on') return;
    setLoginBusy(false);
    setLoginError(null);
  }, [os.power]);

  useEffect(() => {
    function onMove(e: MouseEvent) {
      const d = drag.current;
      if (!d.id || !d.mode) return;
      const dx = e.clientX - d.sx;
      const dy = e.clientY - d.sy;
      setWins((prev) => {
        const w = prev[d.id!];
        if (!w) return prev;
        if (d.mode === 'move') {
          return {
            ...prev,
            [d.id!]: {
              ...w,
              x: clamp(d.x + dx, 10, window.innerWidth - 240),
              y: clamp(d.y + dy, 10, window.innerHeight - 140),
            },
          };
        }
        return {
          ...prev,
          [d.id!]: {
            ...w,
            w: clamp(d.w + dx, 360, window.innerWidth - 40),
            h: clamp(d.h + dy, 260, window.innerHeight - 80),
          },
        };
      });
    }

    function onUp() {
      drag.current = { id: null, mode: null, sx: 0, sy: 0, x: 0, y: 0, w: 0, h: 0 };
    }

    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
    return () => {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
    };
  }, []);

  function focus(id: WindowId) {
    setActiveWin(id);
    setWins((prev) => {
      const maxZ = Math.max(...Object.values(prev).map((w) => w.z));
      return { ...prev, [id]: { ...prev[id], open: true, minimized: false, z: maxZ + 1 } };
    });
  }

  function toggleMin(id: WindowId) {
    setWins((prev) => ({ ...prev, [id]: { ...prev[id], minimized: !prev[id].minimized, open: true } }));
  }

  function close(id: WindowId) {
    setWins((prev) => ({ ...prev, [id]: { ...prev[id], open: false, minimized: false } }));
  }

  function notify(kind: 'alert' | 'info', title: string, body: string) {
    setOs((p) => ({ ...p, notifications: [...p.notifications, { id: uid('m'), kind, title, body }] }));
  }

  function helper(msg: string, kind: 'info' | 'alert' = 'info') {
    notify(kind, tone === 'formal' ? 'Assistant' : 'BrightOS Helper', msg);
  }

  function endMiner() {
    setOs((p) => (p.malware_active ? { ...p, cpu_load: 10 } : p));
    helper(tone === 'formal' ? 'CPU dropped briefly, but the process appears persistent.' : 'Yeah nah‚Ä¶ that thing persistent.', 'alert');
    window.setTimeout(() => {
      setOs((p) => (p.malware_active ? { ...p, cpu_load: 90 } : p));
    }, 2000);
  }

  function termPush(lines: TerminalLine[]) {
    setTermLines((p) => [...p, ...lines]);
  }

  function run(raw: string) {
    const cmd = raw.trim();
    if (!cmd) return;
    termPush([{ id: uid('in'), kind: 'in', text: `> ${cmd}` }]);

    if (cmd === 'help') {
      termPush([
        { id: uid('o'), kind: 'out', text: 'scan --deep' },
        { id: uid('o'), kind: 'out', text: 'delete /system/cache/miner_x.exe' },
        { id: uid('o'), kind: 'out', text: 'clear' },
      ]);
      return;
    }

    if (cmd === 'clear') {
      setTermLines([{ id: uid('sys'), kind: 'sys', text: 'Terminal cleared.' }]);
      return;
    }

    if (cmd === 'scan --deep') {
      termPush([
        { id: uid('o'), kind: 'out', text: 'Deep scan initiated‚Ä¶' },
        { id: uid('o'), kind: 'out', text: 'Tracing persistence hooks‚Ä¶' },
      ]);
      window.setTimeout(() => {
        termPush([
          { id: uid('o'), kind: 'out', text: os.malware_active ? 'Found persistence source: /system/cache/miner_x.exe' : 'No active persistence sources found.' },
          { id: uid('o'), kind: 'out', text: os.malware_active ? 'Recommended: delete /system/cache/miner_x.exe' : 'System looks clean.' },
        ]);
      }, 800);
      return;
    }

    if (cmd === 'delete /system/cache/miner_x.exe') {
      if (!os.malware_active) {
        termPush([{ id: uid('o'), kind: 'out', text: 'Target not active.' }]);
        return;
      }
      termPush([
        { id: uid('o'), kind: 'out', text: 'Deleting‚Ä¶ OK' },
        { id: uid('o'), kind: 'out', text: 'Persistence removed.' },
      ]);
      setOs((p) => ({
        ...p,
        malware_active: false,
        cpu_load: 10,
        badge: { title: 'Malware Neutralized', subtitle: '+50 Reputation' },
        user_reputation: p.user_reputation + 50,
      }));
      helper(tone === 'formal' ? 'Persistence removed. System stabilized.' : 'That fix worked clean. Nice thinking.');
      return;
    }

    termPush([{ id: uid('o'), kind: 'out', text: `Unknown command: ${cmd}` }]);
  }

  const bg =
    'radial-gradient(1200px 700px at 20% 10%, rgba(56,189,248,0.18), transparent 55%), radial-gradient(900px 650px at 80% 30%, rgba(45,212,191,0.12), transparent 60%), linear-gradient(180deg, #05060f 0%, #070a16 50%, #03040a 100%)';

  const stutterMotion = uiStutter
    ? {
        x: [0, -1, 1, -1, 0],
        y: [0, 1, -1, 1, 0],
        filter: ['blur(0px)', 'blur(0.2px)', 'blur(0px)'],
      }
    : { x: 0, y: 0, filter: 'blur(0px)' };

  return (
    <div className="fixed inset-0 bg-black overflow-hidden">
      <div className="absolute inset-0" style={{ background: bg }} />
      <div
        className="absolute inset-0 opacity-20"
        style={{
          backgroundImage:
            'linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px)',
          backgroundSize: '70px 70px',
        }}
      />

      <AnimatePresence>
        {os.power === 'booting' && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 z-[200] flex items-center justify-center"
          >
            <div className="w-[520px] max-w-[92vw] rounded-[28px] border border-white/10 bg-white/[0.04] backdrop-blur-xl p-8">
              <div className="flex items-start justify-between gap-6">
                <div>
                  <div className="text-[10px] font-black uppercase tracking-[0.35em] text-[var(--brand-primary)]">BrightOS</div>
                  <div className="mt-3 text-4xl font-black text-white tracking-tight">Boot Sequence</div>
                  <div className="mt-2 text-sm text-zinc-400">Kernel, UI shell, security services</div>
                </div>
                <div className="w-12 h-12 rounded-2xl border border-white/10 bg-black/30 flex items-center justify-center text-white font-black">
                  B
                </div>
              </div>

              <div className="mt-6 h-2 rounded-full bg-white/10 overflow-hidden">
                <motion.div
                  className="h-full bg-gradient-to-r from-[var(--brand-primary)] via-teal-400 to-emerald-400"
                  initial={{ width: '2%' }}
                  animate={{ width: `${clamp(((os.boot_phase + 1) / 6) * 100, 2, 100)}%` }}
                  transition={{ duration: 0.8 }}
                />
              </div>

              <div className="mt-6 rounded-2xl border border-white/10 bg-black/40 p-4">
                <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">System Log</div>
                <div className="mt-2 space-y-1 text-sm font-mono text-white/80">
                  <div>{os.boot_phase >= 0 ? 'init: bootloader OK' : ''}</div>
                  <div>{os.boot_phase >= 1 ? 'svc: display compositor online' : ''}</div>
                  <div>{os.boot_phase >= 2 ? 'svc: filesystem mounted /system' : ''}</div>
                  <div>{os.boot_phase >= 3 ? 'svc: security center started' : ''}</div>
                  <div>{os.boot_phase >= 4 ? 'ui: desktop shell prepared' : ''}</div>
                  <div>{os.boot_phase >= 5 ? 'ready: awaiting login' : ''}</div>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {os.power === 'lock' && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 z-[190] flex items-center justify-center"
          >
            <div className="absolute inset-0 bg-black/40" />
            <div className="relative w-[520px] max-w-[92vw] rounded-[28px] border border-white/10 bg-white/[0.05] backdrop-blur-2xl p-8">
              <div className="text-center mb-6">
                <div className="text-5xl font-black tracking-tight text-white">
                  {now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
                <div className="mt-1 text-sm text-zinc-400">
                  {now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}
                </div>
              </div>

              <div className="flex items-center justify-between gap-6">
                <div>
                  <div className="text-[10px] font-black uppercase tracking-[0.35em] text-zinc-400">Secure Login</div>
                  <div className="mt-2 text-3xl font-black text-white">Welcome back</div>
                  <div className="mt-1 text-sm text-zinc-400">Technician: Student</div>
                </div>
                <div className={`w-12 h-12 rounded-2xl border border-white/10 bg-black/30 flex items-center justify-center text-white font-black ${securityPulse ? 'animate-attention-glow' : ''}`}>
                  B
                </div>
              </div>

              <div className="mt-6">
                <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Password</div>
                <motion.div
                  animate={loginError ? { x: [0, -6, 6, -4, 4, 0] } : { x: 0 }}
                  transition={{ duration: 0.35 }}
                  className="mt-2"
                >
                  <input
                    value={password}
                    onChange={(e) => {
                      setPassword(e.target.value);
                      setLoginError(null);
                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        const candidate = password.trim().toLowerCase();
                        setLoginBusy(true);
                        window.setTimeout(() => {
                          if (candidate === BRIGHTOS_PASSWORD) {
                            setOs((p) => ({ ...p, power: 'on' }));
                          } else {
                            setLoginBusy(false);
                            setLoginError('Incorrect password');
                          }
                        }, 450);
                      }
                    }}
                    placeholder="Type password‚Ä¶"
                    className="w-full h-12 rounded-2xl border border-white/10 bg-black/35 px-4 text-sm font-mono text-white outline-none focus:border-[var(--brand-primary)]/60"
                    autoFocus
                  />
                </motion.div>

                <div className="mt-3 flex items-center justify-between gap-4">
                  <div className="text-xs text-zinc-400">
                    {loginError ? <span className="text-red-300">{loginError}</span> : <span>Hint: default password is <span className="font-mono text-zinc-200">brightos</span></span>}
                  </div>
                  <button
                    disabled={loginBusy}
                    onClick={() => {
                      const candidate = password.trim().toLowerCase();
                      setLoginBusy(true);
                      window.setTimeout(() => {
                        if (candidate === BRIGHTOS_PASSWORD) {
                          setOs((p) => ({ ...p, power: 'on' }));
                        } else {
                          setLoginBusy(false);
                          setLoginError('Incorrect password');
                        }
                      }, 450);
                    }}
                    className={`h-12 px-6 rounded-2xl border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${
                      loginBusy
                        ? 'border-white/10 bg-white/[0.03] text-zinc-400'
                        : 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-white'
                    }`}
                  >
                    {loginBusy ? 'Verifying‚Ä¶' : 'Unlock'}
                  </button>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {os.power === 'on' && (
        <motion.div
          className="absolute inset-0"
          animate={stutterMotion}
          transition={uiStutter ? { duration: 0.22, repeat: Infinity } : { duration: 0.18 }}
        >
          <div className="absolute top-0 left-0 right-0 z-[130] h-10 border-b border-white/5 bg-black/25 backdrop-blur-xl">
            <div className="h-full px-4 flex items-center justify-between">
              <div className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">
                Desktop
              </div>
              <div className="flex items-center gap-3">
                <div className={`px-2 py-1 rounded-xl border border-white/10 bg-white/[0.03] text-[10px] font-black uppercase tracking-[0.2em] ${os.firewall === 'disabled' ? 'text-yellow-200' : 'text-emerald-200'}`}>
                  Firewall: {os.firewall}
                </div>
                <div className={`px-2 py-1 rounded-xl border border-white/10 bg-white/[0.03] text-[10px] font-black uppercase tracking-[0.2em] ${os.malware_active ? 'text-red-200' : 'text-emerald-200'}`}>
                  {os.malware_active ? 'Threat' : 'Secure'}
                </div>
                <div className="px-2 py-1 rounded-xl border border-white/10 bg-white/[0.03] text-[10px] font-black uppercase tracking-[0.2em] text-zinc-200">
                  Rep: {os.user_reputation}
                </div>
                <div className="px-2 py-1 rounded-xl border border-white/10 bg-white/[0.03] text-[10px] font-black uppercase tracking-[0.2em] text-zinc-200 font-mono">
                  {now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>
          </div>

          <div className="absolute top-6 left-6 z-[50] flex flex-col gap-3">
            <DesktopIcon label="Task Manager" emoji="üìä" onOpen={() => focus('taskmgr')} pulse={os.malware_active} />
            <DesktopIcon label="Terminal" emoji=">_" onOpen={() => focus('terminal')} pulse={false} />
            <DesktopIcon label="Defend" emoji="üõ°Ô∏è" onOpen={() => focus('defend')} pulse={securityPulse} />
          </div>

          <div className="absolute top-4 right-4 z-[120] flex flex-col gap-3 w-[360px] max-w-[92vw]">
            {os.notifications.slice(-3).map((n) => (
              <div
                key={n.id}
                className={`rounded-2xl border backdrop-blur-xl p-4 shadow-2xl ${
                  n.kind === 'alert' ? 'border-red-500/30 bg-red-500/10' : 'border-white/10 bg-white/[0.04]'
                } ${securityPulse && n.kind === 'alert' ? 'animate-urgent-pulse' : ''}`}
              >
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-[10px] font-black uppercase tracking-[0.25em] text-white/80">{n.title}</div>
                    <div className="mt-1 text-sm text-white/90 leading-snug">{n.body}</div>
                  </div>
                  <button
                    onClick={() => setOs((p) => ({ ...p, notifications: p.notifications.filter((x) => x.id !== n.id) }))}
                    className="shrink-0 w-8 h-8 rounded-xl border border-white/10 bg-black/20 hover:bg-black/35 transition-colors text-white/80"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
            ))}
          </div>

          <WindowFrame
            win={wins.taskmgr}
            active={activeWin === 'taskmgr'}
            onFocus={() => focus('taskmgr')}
            onMoveStart={(e) => {
              focus('taskmgr');
              drag.current = { id: 'taskmgr', mode: 'move', sx: e.clientX, sy: e.clientY, x: wins.taskmgr.x, y: wins.taskmgr.y, w: wins.taskmgr.w, h: wins.taskmgr.h };
            }}
            onResizeStart={(e) => {
              focus('taskmgr');
              drag.current = { id: 'taskmgr', mode: 'resize', sx: e.clientX, sy: e.clientY, x: wins.taskmgr.x, y: wins.taskmgr.y, w: wins.taskmgr.w, h: wins.taskmgr.h };
            }}
            onMinimize={() => toggleMin('taskmgr')}
            onClose={() => close('taskmgr')}
          >
            <TaskManager
              cpu={os.cpu_load}
              temp={os.temperature}
              malware={os.malware_active}
              processes={processes}
              hintTier={os.difficulty_tier}
              onEndMiner={endMiner}
              onOpenTerminal={() => focus('terminal')}
            />
          </WindowFrame>

          <WindowFrame
            win={wins.terminal}
            active={activeWin === 'terminal'}
            onFocus={() => focus('terminal')}
            onMoveStart={(e) => {
              focus('terminal');
              drag.current = { id: 'terminal', mode: 'move', sx: e.clientX, sy: e.clientY, x: wins.terminal.x, y: wins.terminal.y, w: wins.terminal.w, h: wins.terminal.h };
            }}
            onResizeStart={(e) => {
              focus('terminal');
              drag.current = { id: 'terminal', mode: 'resize', sx: e.clientX, sy: e.clientY, x: wins.terminal.x, y: wins.terminal.y, w: wins.terminal.w, h: wins.terminal.h };
            }}
            onMinimize={() => toggleMin('terminal')}
            onClose={() => close('terminal')}
          >
            <Terminal
              lines={termLines}
              value={termInput}
              onChange={setTermInput}
              onRun={() => {
                const v = termInput;
                setTermInput('');
                run(v);
              }}
              onPreset={(cmd) => run(cmd)}
              malware={os.malware_active}
            />
          </WindowFrame>

          <WindowFrame
            win={wins.defend}
            active={activeWin === 'defend'}
            onFocus={() => focus('defend')}
            onMoveStart={(e) => {
              focus('defend');
              drag.current = { id: 'defend', mode: 'move', sx: e.clientX, sy: e.clientY, x: wins.defend.x, y: wins.defend.y, w: wins.defend.w, h: wins.defend.h };
            }}
            onResizeStart={(e) => {
              focus('defend');
              drag.current = { id: 'defend', mode: 'resize', sx: e.clientX, sy: e.clientY, x: wins.defend.x, y: wins.defend.y, w: wins.defend.w, h: wins.defend.h };
            }}
            onMinimize={() => toggleMin('defend')}
            onClose={() => close('defend')}
          >
            <Defend firewall={os.firewall} malware={os.malware_active} />
          </WindowFrame>

          <div className="absolute bottom-0 left-0 right-0 z-[150]">
            <Taskbar
              fan={fan}
              cpu={os.cpu_load}
              temp={os.temperature}
              securityPulse={securityPulse}
              wins={wins}
              onToggle={(id) => {
                focus(id);
                toggleMin(id);
              }}
              tone={tone}
              onToneToggle={() => setTone((t) => (t === 'caribbean' ? 'formal' : 'caribbean'))}
            />
          </div>

          <AnimatePresence>
            {os.badge && (
              <motion.div
                initial={{ y: 30, opacity: 0, scale: 0.98 }}
                animate={{ y: 0, opacity: 1, scale: 1 }}
                exit={{ y: 30, opacity: 0 }}
                className="absolute left-1/2 -translate-x-1/2 bottom-24 z-[180] w-[420px] max-w-[92vw]"
              >
                <div className="rounded-[26px] border border-emerald-400/30 bg-emerald-400/10 backdrop-blur-xl p-5 shadow-2xl">
                  <div className="text-[10px] font-black uppercase tracking-[0.35em] text-emerald-200">Badge Unlocked</div>
                  <div className="mt-2 text-2xl font-black text-white">{os.badge.title}</div>
                  <div className="mt-1 text-sm text-emerald-100/80">{os.badge.subtitle}</div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      )}
    </div>
  );
}

function DesktopIcon({ label, emoji, onOpen, pulse }: { label: string; emoji: string; onOpen: () => void; pulse: boolean }) {
  return (
    <button
      onClick={onOpen}
      className={`w-20 text-left rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] transition-colors p-3 select-none ${pulse ? 'animate-attention-glow' : ''}`}
    >
      <div className="text-2xl text-white">{emoji}</div>
      <div className="mt-2 text-[10px] font-black uppercase tracking-[0.2em] text-zinc-300">{label}</div>
    </button>
  );
}

function Taskbar({
  fan,
  cpu,
  temp,
  securityPulse,
  wins,
  onToggle,
  tone,
  onToneToggle,
}: {
  fan: number;
  cpu: number;
  temp: number;
  securityPulse: boolean;
  wins: Record<WindowId, WindowState>;
  onToggle: (id: WindowId) => void;
  tone: 'caribbean' | 'formal';
  onToneToggle: () => void;
}) {
  const bars = ['‚ñÅ', '‚ñÇ', '‚ñÉ', '‚ñÖ'];
  return (
    <div className="h-14 border-t border-white/10 bg-black/40 backdrop-blur-xl">
      <div className="h-full px-4 flex items-center justify-between gap-4">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-2xl border border-white/10 bg-white/[0.04] flex items-center justify-center text-white font-black">B</div>
          <div className="hidden sm:block">
            <div className="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500">BrightOS</div>
            <div className="text-xs text-white/90">Malware Incident</div>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <TaskbarBtn label="Task" active={wins.taskmgr.open && !wins.taskmgr.minimized} onClick={() => onToggle('taskmgr')} />
          <TaskbarBtn label="Term" active={wins.terminal.open && !wins.terminal.minimized} onClick={() => onToggle('terminal')} />
          <TaskbarBtn label="Def" active={wins.defend.open && !wins.defend.minimized} onClick={() => onToggle('defend')} pulse={securityPulse} />
        </div>

        <div className="flex items-center gap-3">
          <div className="hidden md:flex items-center gap-3 px-3 py-2 rounded-2xl border border-white/10 bg-white/[0.03]">
            <div className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-400">CPU</div>
            <div className="text-xs text-white/90 font-mono">{Math.round(cpu)}%</div>
            <div className="w-px h-4 bg-white/10" />
            <div className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-400">TEMP</div>
            <div className="text-xs text-white/90 font-mono">{Math.round(temp)}¬∞C</div>
          </div>

          <div className={`px-3 py-2 rounded-2xl border border-white/10 bg-white/[0.03] text-white font-mono text-xs ${fan >= 2 ? 'neon-glow-cyan' : ''}`}>
            FAN {bars[clamp(fan, 0, 3)]}
          </div>

          <button
            onClick={onToneToggle}
            className="px-3 py-2 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] transition-colors text-[10px] font-black uppercase tracking-[0.2em] text-white/80"
          >
            Tone: {tone === 'formal' ? 'Formal' : 'Caribbean'}
          </button>
        </div>
      </div>
    </div>
  );
}

function TaskbarBtn({ label, active, onClick, pulse }: { label: string; active: boolean; onClick: () => void; pulse?: boolean }) {
  return (
    <button
      onClick={onClick}
      className={`w-16 h-10 rounded-2xl border text-[10px] font-black uppercase tracking-[0.2em] transition-all ${
        active ? 'border-[var(--brand-primary)]/40 bg-[var(--brand-primary)]/15 text-white neon-glow-primary' : 'border-white/10 bg-white/[0.02] text-zinc-300 hover:bg-white/[0.05]'
      } ${pulse ? 'animate-urgent-pulse' : ''}`}
    >
      {label}
    </button>
  );
}

function WindowFrame({
  win,
  active,
  children,
  onClose,
  onMinimize,
  onFocus,
  onMoveStart,
  onResizeStart,
}: {
  win: WindowState;
  active: boolean;
  children: React.ReactNode;
  onClose: () => void;
  onMinimize: () => void;
  onFocus: () => void;
  onMoveStart: (e: React.MouseEvent<HTMLDivElement>) => void;
  onResizeStart: (e: React.MouseEvent<HTMLDivElement>) => void;
}) {
  if (!win.open || win.minimized) return null;
  return (
    <div
      className={`absolute rounded-[26px] border bg-black/35 backdrop-blur-xl shadow-2xl overflow-hidden transition-colors ${
        active ? 'border-[var(--brand-primary)]/30' : 'border-white/10'
      }`}
      style={{ left: win.x, top: win.y, width: win.w, height: win.h, zIndex: win.z }}
      onMouseDown={onFocus}
    >
      <div className="h-12 px-4 flex items-center justify-between gap-3 border-b border-white/10 bg-white/[0.03] cursor-grab active:cursor-grabbing" onMouseDown={onMoveStart}>
        <div className="text-[10px] font-black uppercase tracking-[0.25em] text-white/80">{win.title}</div>
        <div className="flex items-center gap-2">
          <button
            onClick={(e) => {
              e.stopPropagation();
              onMinimize();
            }}
            className="w-9 h-8 rounded-xl border border-white/10 bg-black/20 hover:bg-black/35 transition-colors text-white/80"
          >
            ‚Äî
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onClose();
            }}
            className="w-9 h-8 rounded-xl border border-white/10 bg-black/20 hover:bg-black/35 transition-colors text-white/80"
          >
            ‚úï
          </button>
        </div>
      </div>
      <div className="h-[calc(100%-3rem)] p-4 overflow-hidden">{children}</div>
      <div className="absolute right-2 bottom-2 w-5 h-5 cursor-se-resize opacity-70 hover:opacity-100" onMouseDown={onResizeStart}>
        <div className="w-full h-full border-r-2 border-b-2 border-white/30 rounded-sm" />
      </div>
    </div>
  );
}

function Pill({ label, value, level }: { label: string; value: string; level: 'ok' | 'warn' | 'crit' }) {
  const cls =
    level === 'crit'
      ? 'border-red-500/30 bg-red-500/10 text-red-100'
      : level === 'warn'
        ? 'border-yellow-500/30 bg-yellow-500/10 text-yellow-100'
        : 'border-white/10 bg-white/[0.03] text-zinc-200';
  return (
    <div className={`px-3 py-2 rounded-2xl border ${cls}`}>
      <div className="text-[9px] font-black uppercase tracking-[0.25em] opacity-80">{label}</div>
      <div className="mt-1 text-sm font-mono font-semibold">{value}</div>
    </div>
  );
}

function TaskManager({
  cpu,
  temp,
  malware,
  processes,
  hintTier,
  onEndMiner,
  onOpenTerminal,
}: {
  cpu: number;
  temp: number;
  malware: boolean;
  processes: ProcessRow[];
  hintTier: DifficultyTier;
  onEndMiner: () => void;
  onOpenTerminal: () => void;
}) {
  return (
    <div className="h-full flex flex-col gap-4">
      <div className="flex items-start justify-between gap-4">
        <div className="flex gap-3">
          <Pill label="CPU" value={`${Math.round(cpu)}%`} level={cpu > 80 ? 'crit' : cpu > 55 ? 'warn' : 'ok'} />
          <Pill label="TEMP" value={`${Math.round(temp)}¬∞C`} level={temp > 80 ? 'crit' : temp > 65 ? 'warn' : 'ok'} />
        </div>
        <div className="flex flex-col items-end gap-2">
          <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${malware ? 'text-red-300' : 'text-emerald-300'}`}>{malware ? 'Threat Active' : 'Stable'}</div>
          <button
            onClick={onOpenTerminal}
            className="px-4 py-2 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200"
          >
            Open Terminal
          </button>
        </div>
      </div>

      {hintTier <= 1 && malware && (
        <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-3">
          <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Hint</div>
          <div className="mt-1 text-sm text-zinc-300">Check what‚Äôs consuming resources.</div>
        </div>
      )}

      <div className="flex-1 overflow-hidden rounded-2xl border border-white/10 bg-white/[0.02]">
        <div className="grid grid-cols-[1fr_100px_100px_90px] gap-2 px-3 py-2 border-b border-white/10 bg-white/[0.02]">
          <div className="text-[9px] font-black uppercase tracking-[0.25em] text-zinc-500">Process</div>
          <div className="text-[9px] font-black uppercase tracking-[0.25em] text-zinc-500 text-right">CPU</div>
          <div className="text-[9px] font-black uppercase tracking-[0.25em] text-zinc-500 text-right">MEM</div>
          <div className="text-[9px] font-black uppercase tracking-[0.25em] text-zinc-500 text-right">Action</div>
        </div>
        <div className="h-[calc(100%-2.25rem)] overflow-auto sleek-scrollbar">
          {processes.map((p) => (
            <div key={p.pid} className={`grid grid-cols-[1fr_100px_100px_90px] gap-2 px-3 py-2 border-b border-white/5 hover:bg-white/[0.03] ${p.kind === 'malware' ? 'bg-red-500/5' : ''}`}>
              <div className="min-w-0">
                <div className="text-sm text-white/90 truncate">{p.name}{p.kind === 'malware' && hintTier <= 1 ? ' (suspicious)' : ''}</div>
                <div className="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">PID {p.pid}</div>
              </div>
              <div className="text-right text-sm font-mono text-white/90">{Math.round(p.cpu)}%</div>
              <div className="text-right text-sm font-mono text-white/90">{Math.round(p.mem)}%</div>
              <div className="text-right">
                <button
                  disabled={p.kind !== 'malware'}
                  onClick={() => onEndMiner()}
                  className={`px-3 py-2 rounded-xl border text-[9px] font-black uppercase tracking-[0.25em] transition-colors ${p.kind === 'malware' ? 'border-white/10 bg-black/20 hover:bg-black/35 text-zinc-200' : 'border-white/5 bg-white/[0.01] text-zinc-600'}`}
                >
                  End
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Tip: ending a process doesn‚Äôt remove persistence.</div>
    </div>
  );
}

function Terminal({
  lines,
  value,
  onChange,
  onRun,
  onPreset,
  malware,
}: {
  lines: TerminalLine[];
  value: string;
  onChange: (v: string) => void;
  onRun: () => void;
  onPreset: (cmd: string) => void;
  malware: boolean;
}) {
  const scrollRef = useRef<HTMLDivElement | null>(null);
  useEffect(() => {
    scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });
  }, [lines.length]);

  return (
    <div className="h-full flex flex-col gap-3">
      <div className="flex items-center justify-between gap-3">
        <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Session</div>
        <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${malware ? 'text-red-300' : 'text-emerald-300'}`}>{malware ? 'Threat Active' : 'Clean'}</div>
      </div>

      <div ref={scrollRef} className="flex-1 rounded-2xl border border-white/10 bg-black/40 overflow-auto sleek-scrollbar p-3">
        {lines.map((l) => (
          <div key={l.id} className={`text-sm leading-relaxed font-mono ${l.kind === 'in' ? 'text-teal-200' : l.kind === 'sys' ? 'text-zinc-400' : 'text-white/90'}`}>{l.text}</div>
        ))}
      </div>

      <div className="grid grid-cols-2 gap-2">
        <button onClick={() => onPreset('scan --deep')} className="px-4 py-3 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200">scan --deep</button>
        <button onClick={() => onPreset('help')} className="px-4 py-3 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200">help</button>
      </div>

      <div className="flex items-center gap-2">
        <input
          value={value}
          onChange={(e) => onChange(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === 'Enter') onRun();
          }}
          placeholder="Type a command‚Ä¶"
          className="flex-1 h-12 rounded-2xl border border-white/10 bg-black/35 px-4 text-sm font-mono text-white outline-none focus:border-[var(--brand-primary)]/60"
        />
        <button onClick={onRun} className="h-12 px-5 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-white">Run</button>
      </div>
    </div>
  );
}

function Defend({ firewall, malware }: { firewall: 'enabled' | 'disabled'; malware: boolean }) {
  return (
    <div className="h-full flex flex-col gap-4">
      <div className="flex items-start justify-between gap-4">
        <div>
          <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Security Center</div>
          <div className="mt-2 text-2xl font-black text-white">Defend</div>
        </div>
        <div className={`px-3 py-2 rounded-2xl border ${malware ? 'border-red-500/30 bg-red-500/10 text-red-100 animate-urgent-pulse' : 'border-emerald-500/30 bg-emerald-500/10 text-emerald-100'}`}>
          <div className="text-[9px] font-black uppercase tracking-[0.25em]">Status</div>
          <div className="mt-1 text-sm font-mono">{malware ? 'THREAT' : 'OK'}</div>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-3">
        <Pill label="Firewall" value={firewall.toUpperCase()} level={firewall === 'disabled' ? 'warn' : 'ok'} />
        <Pill label="Quarantine" value={malware ? 'FAILED' : 'CLEAR'} level={malware ? 'crit' : 'ok'} />
      </div>

      <div className="rounded-2xl border border-white/10 bg-white/[0.02] p-4">
        <div className="text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500">Rule</div>
        <div className="mt-2 text-sm text-zinc-300">UI reacts to state. No auto-fix. Diagnose, then act.</div>
      </div>
    </div>
  );
}

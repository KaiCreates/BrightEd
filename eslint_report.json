[{"filePath":"/home/kai/Documents/BrightEd/app/achievements/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[205,219],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'checkAchievement' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"checkAchievement"},"fix":{"range":[412,430],"text":""},"desc":"Remove unused variable \"checkAchievement\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1746,1749],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1746,1749],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { db } from '@/lib/firebase';\nimport { doc, getDoc, updateDoc, arrayUnion, arrayRemove } from 'firebase/firestore';\n\nimport { ALL_ACHIEVEMENTS, Achievement, checkAchievement } from '@/lib/achievements';\n\nconst RARITY_COLORS = {\n    common: 'from-slate-500 to-slate-700',\n    rare: 'from-cyan-500 to-blue-600',\n    epic: 'from-fuchsia-500 to-purple-700',\n    legendary: 'from-amber-400 via-orange-500 to-red-600'\n};\n\nconst RARITY_GLOW = {\n    common: 'shadow-slate-500/20',\n    rare: 'shadow-blue-500/40',\n    epic: 'shadow-purple-500/60',\n    legendary: 'shadow-orange-500/80'\n};\n\n\nexport default function AchievementsPage() {\n    const { user, userData } = useAuth();\n    const [achievements, setAchievements] = useState<Achievement[]>(ALL_ACHIEVEMENTS);\n    const [pinnedAchievements, setPinnedAchievements] = useState<string[]>([]);\n    const [selectedCategory, setSelectedCategory] = useState<string>('all');\n\n    useEffect(() => {\n        if (!user || !userData) return;\n\n        // Check which achievements are unlocked\n        const checkAchievements = async () => {\n            let isTop10 = false;\n            try {\n                const token = await user.getIdToken();\n                const res = await fetch('/api/leaderboards?type=xp&limit=10', {\n                    headers: { 'Authorization': `Bearer ${token}` }\n                });\n                if (res.ok) {\n                    const data = await res.json();\n                    isTop10 = (data.entries || []).some((e: any) => e.id === user.uid);\n                }\n            } catch (err) {\n                console.error('Failed to check rank', err);\n            }\n\n            const userRef = doc(db, 'users', user.uid);\n            const userSnap = await getDoc(userRef);\n            const userDoc = userSnap.data() || {};\n\n            const unlockedIds = userDoc.unlockedAchievements || [];\n            const pinned = userDoc.pinnedAchievements || [];\n\n            setPinnedAchievements(pinned);\n\n            // Get business data for business achievements\n            let businessValuation = 0;\n            if (userData.businessID) {\n                const bizRef = doc(db, 'businesses', userData.businessID);\n                const bizSnap = await getDoc(bizRef);\n                if (bizSnap.exists()) {\n                    businessValuation = bizSnap.data().valuation || 0;\n                }\n            }\n\n            const updated = ALL_ACHIEVEMENTS.map(ach => {\n                const isUnlocked = unlockedIds.includes(ach.id);\n                let shouldUnlock = false;\n\n                // Check requirements\n                switch (ach.id) {\n                    case 'streak-king':\n                        shouldUnlock = (userData.streak || 0) >= 30;\n                        break;\n                    case 'first-million':\n                        shouldUnlock = businessValuation >= 1000000;\n                        break;\n                    case 'master-pob':\n                        shouldUnlock = (userData.subjectProgress?.['Principles of Business'] || 0) >= 9.0;\n                        break;\n                    case 'community-leader':\n                        shouldUnlock = (userDoc.helpCount || 0) >= 50;\n                        break;\n                    case 'seed-founder':\n                        shouldUnlock = userData.hasBusiness === true;\n                        break;\n                    case 'profit-first':\n                        shouldUnlock = (userData.bCoins || 0) >= 1000;\n                        break;\n                    case 'market-entry':\n                        shouldUnlock = businessValuation >= 10000;\n                        break;\n                    case 'math-master':\n                        shouldUnlock = (userData.subjectProgress?.['Mathematics'] || 0) >= 9.0;\n                        break;\n                    case 'week-warrior':\n                        shouldUnlock = (userData.streak || 0) >= 7;\n                        break;\n                    case 'centurion':\n                        shouldUnlock = (userData.questionsCorrect || 0) >= 100;\n                        break;\n                    case 'polymath':\n                        const highMasteryCount = Object.values(userData.subjectProgress || {}).filter(m => m >= 9.0).length;\n                        shouldUnlock = highMasteryCount >= 3;\n                        break;\n                    case 'high-roller':\n                        shouldUnlock = (userData.bCoins || 0) >= 10000000; // Updated to 10M for consistency with plan\n                        break;\n                    case 'social-butterfly':\n                        shouldUnlock = (userDoc.connections?.length || 0) >= 10;\n                        break;\n                    case 'night-owl':\n                        shouldUnlock = userDoc.unlockedAchievements?.includes('night-owl') || false;\n                        break;\n                    case 'top-rank':\n                        shouldUnlock = isTop10;\n                        break;\n                }\n\n                // Auto-unlock if requirement met\n                if (shouldUnlock && !isUnlocked) {\n                    updateDoc(userRef, {\n                        unlockedAchievements: arrayUnion(ach.id)\n                    }).catch(() => { });\n                }\n\n                return {\n                    ...ach,\n                    unlocked: isUnlocked || shouldUnlock,\n                    unlockedAt: isUnlocked ? userDoc.achievementUnlockDates?.[ach.id] : undefined\n                };\n            });\n\n            setAchievements(updated);\n        };\n\n        checkAchievements();\n    }, [user, userData]);\n\n    const togglePin = async (achievementId: string) => {\n        if (!user) return;\n\n        const userRef = doc(db, 'users', user.uid);\n        const isPinned = pinnedAchievements.includes(achievementId);\n\n        if (isPinned) {\n            if (pinnedAchievements.length <= 1) {\n                alert('You must have at least one pinned achievement');\n                return;\n            }\n            await updateDoc(userRef, {\n                pinnedAchievements: arrayRemove(achievementId)\n            });\n            setPinnedAchievements(prev => prev.filter(id => id !== achievementId));\n        } else {\n            if (pinnedAchievements.length >= 3) {\n                alert('You can only pin up to 3 achievements');\n                return;\n            }\n            await updateDoc(userRef, {\n                pinnedAchievements: arrayUnion(achievementId)\n            });\n            setPinnedAchievements(prev => [...prev, achievementId]);\n        }\n    };\n\n    const filteredAchievements = selectedCategory === 'all'\n        ? achievements\n        : achievements.filter(a => a.category === selectedCategory);\n\n    const categories = ['all', 'streak', 'business', 'mastery', 'social'];\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] py-20 px-4\">\n            <div className=\"max-w-7xl mx-auto\">\n                <motion.div\n                    initial={{ opacity: 0, y: 20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className=\"text-center mb-12\"\n                >\n                    <BrightHeading level={1} className=\"mb-4\">\n                        üèÜ The Locker Room üèÜ\n                    </BrightHeading>\n                    <p className=\"text-[var(--text-secondary)] font-medium text-lg\">\n                        Your digital trophy case. Flex your achievements and show off your progress.\n                    </p>\n                </motion.div>\n\n                {/* Category Filter */}\n                <div className=\"flex gap-2 mb-8 justify-center flex-wrap\">\n                    {categories.map((cat) => (\n                        <button\n                            key={cat}\n                            onClick={() => setSelectedCategory(cat)}\n                            className={`px-6 py-3 rounded-xl font-bold uppercase tracking-wider transition-all ${selectedCategory === cat\n                                ? 'bg-[var(--brand-primary)] text-white shadow-lg'\n                                : 'bg-white/5 text-[var(--text-secondary)] hover:bg-white/10'\n                                }`}\n                        >\n                            {cat === 'all' ? 'All' : cat}\n                        </button>\n                    ))}\n                </div>\n\n                {/* Pinned Achievements (Top 3) */}\n                {pinnedAchievements.length > 0 && (\n                    <div className=\"mb-12\">\n                        <BrightHeading level={3} className=\"mb-6 text-center\">\n                            ‚≠ê Pinned Achievements\n                        </BrightHeading>\n                        <div className=\"grid md:grid-cols-3 gap-6\">\n                            {pinnedAchievements.map((achId) => {\n                                const ach = achievements.find(a => a.id === achId);\n                                if (!ach) return null;\n                                return (\n                                    <AchievementCard\n                                        key={ach.id}\n                                        achievement={ach}\n                                        isPinned={true}\n                                        onTogglePin={togglePin}\n                                    />\n                                );\n                            })}\n                        </div>\n                    </div>\n                )}\n\n                {/* All Achievements Grid */}\n                <div className=\"grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n                    <AnimatePresence>\n                        {filteredAchievements.map((achievement, index) => (\n                            <AchievementCard\n                                key={achievement.id}\n                                achievement={achievement}\n                                isPinned={pinnedAchievements.includes(achievement.id)}\n                                onTogglePin={togglePin}\n                                index={index}\n                            />\n                        ))}\n                    </AnimatePresence>\n                </div>\n            </div>\n        </div>\n    );\n}\n\nfunction AchievementCard({\n    achievement,\n    isPinned,\n    onTogglePin,\n    index = 0\n}: {\n    achievement: Achievement;\n    isPinned: boolean;\n    onTogglePin: (id: string) => void;\n    index?: number;\n}) {\n    return (\n        <motion.div\n            initial={{ opacity: 0, scale: 0.9, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.9 }}\n            transition={{ delay: index * 0.05 }}\n            className={`relative ${achievement.unlocked ? '' : 'grayscale blur-sm'} transition-all duration-500`}\n        >\n            <BrightLayer\n                variant=\"glass\"\n                padding=\"md\"\n                className={`\n                    h-full cursor-pointer group\n                    ${achievement.unlocked\n                        ? `bg-gradient-to-br ${RARITY_COLORS[achievement.rarity]} ${RARITY_GLOW[achievement.rarity]} shadow-2xl`\n                        : 'bg-white/5 opacity-60'\n                    }\n                    ${isPinned ? 'ring-4 ring-yellow-400 ring-opacity-50' : ''}\n                `}\n            >\n                {/* Pin Button */}\n                {achievement.unlocked && (\n                    <button\n                        onClick={(e) => {\n                            e.stopPropagation();\n                            onTogglePin(achievement.id);\n                        }}\n                        className={`absolute top-2 right-2 p-2 rounded-full transition-all ${isPinned\n                            ? 'bg-yellow-400 text-yellow-900'\n                            : 'bg-white/10 hover:bg-white/20 text-white/60'\n                            }`}\n                    >\n                        {isPinned ? 'üìå' : 'üìç'}\n                    </button>\n                )}\n\n                {/* Achievement Icon */}\n                <div className=\"text-center mb-4\">\n                    <div className={`\n                        text-6xl mb-2 transition-transform group-hover:scale-110\n                        ${achievement.unlocked ? 'animate-bounce-subtle' : ''}\n                    `}>\n                        {achievement.icon}\n                    </div>\n                    <h3 className=\"text-xl font-black text-white mb-1\">\n                        {achievement.name}\n                    </h3>\n                    <p className=\"text-sm text-white/80 mb-2\">\n                        {achievement.description}\n                    </p>\n                    <span className={`\n                        text-xs font-black uppercase tracking-widest px-3 py-1 rounded-full\n                        ${achievement.rarity === 'legendary'\n                            ? 'bg-yellow-400/20 text-yellow-200 border border-yellow-400/50'\n                            : achievement.rarity === 'epic'\n                                ? 'bg-purple-400/20 text-purple-200 border border-purple-400/50'\n                                : achievement.rarity === 'rare'\n                                    ? 'bg-blue-400/20 text-blue-200 border border-blue-400/50'\n                                    : 'bg-gray-400/20 text-gray-200 border border-gray-400/50'\n                        }\n                    `}>\n                        {achievement.rarity}\n                    </span>\n                </div>\n\n                {/* Locked Overlay */}\n                {!achievement.unlocked && (\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/50 rounded-2xl\">\n                        <div className=\"text-center\">\n                            <div className=\"text-4xl mb-2\">üîí</div>\n                            <p className=\"text-sm font-bold text-white/80\">\n                                Locked\n                            </p>\n                        </div>\n                    </div>\n                )}\n\n                {/* Unlocked Badge */}\n                {achievement.unlocked && achievement.unlockedAt && (\n                    <div className=\"text-xs text-white/60 text-center mt-2\">\n                        Unlocked {new Date(achievement.unlockedAt).toLocaleDateString()}\n                    </div>\n                )}\n            </BrightLayer>\n        </motion.div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/beta/signup/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/brightos/wallpaper/[file]/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/employees/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7492,7495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7492,7495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7897,7900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7897,7900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport * as admin from 'firebase-admin';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport { assignSpecialization, initializeEmployeeSkills } from '@/lib/economy/employee-skills';\nimport { Employee } from '@/lib/economy/economy-types';\n\nconst EmployeeActionSchema = z.object({\n  businessId: z.string().min(1, 'Business ID is required'),\n  action: z.enum(['hire', 'decline', 'pay', 'pay_all', 'fire', 'assign_specialization']),\n  candidateId: z.string().optional(),\n  employeeId: z.string().optional(),\n  specialization: z.string().optional()\n});\n\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 120, 60000, 'business:employees:POST');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const body = await request.json();\n\n    const result = EmployeeActionSchema.safeParse(body);\n    if (!result.success) {\n      return NextResponse.json({ error: 'Invalid request data', details: result.error.format() }, { status: 400 });\n    }\n\n    const { businessId, action, candidateId, employeeId, specialization } = result.data;\n\n    const businessRef = adminDb.collection('businesses').doc(businessId);\n    const businessSnap = await businessRef.get();\n\n    if (!businessSnap.exists) {\n      return NextResponse.json({ error: 'Business not found' }, { status: 404 });\n    }\n\n    const data = businessSnap.data() || {};\n    if (data.ownerId !== decodedToken.uid) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });\n    }\n\n    const employees: Employee[] = Array.isArray(data.employees) ? data.employees : [];\n    const recruitmentPool: Employee[] = Array.isArray(data.recruitmentPool) ? data.recruitmentPool : [];\n    const cashBalance = Number(data.cashBalance ?? data.balance ?? 0);\n    const FieldValue = admin.firestore.FieldValue;\n    const nowIso = new Date().toISOString();\n\n    switch (action) {\n      case 'hire': {\n        if (!candidateId) {\n          return NextResponse.json({ error: 'candidateId is required' }, { status: 400 });\n        }\n        const candidate = recruitmentPool.find((c) => c.id === candidateId);\n        if (!candidate) {\n          return NextResponse.json({ error: 'Candidate not found' }, { status: 404 });\n        }\n\n        const hiringCost = Math.floor((candidate.salaryPerDay || 0) * 1);\n        if (cashBalance < hiringCost) {\n          return NextResponse.json({ error: 'Insufficient funds for hiring deposit' }, { status: 400 });\n        }\n\n        const employeeRecord: Employee = {\n          ...candidate,\n          unpaidWages: 0,\n          hiredAt: nowIso,\n          stats: {\n            speed: candidate.stats?.speed ?? 50,\n            quality: candidate.stats?.quality ?? 50,\n            morale: 100\n          },\n          skills:\n            candidate.skills && Object.keys(candidate.skills).length > 0\n              ? candidate.skills\n              : initializeEmployeeSkills(candidate.role)\n        };\n\n        const updatedPool = recruitmentPool.filter((c) => c.id !== candidateId);\n        const updatedEmployees = [...employees, employeeRecord];\n\n        await businessRef.update({\n          employees: updatedEmployees,\n          recruitmentPool: updatedPool,\n          staffCount: FieldValue.increment(1),\n          cashBalance: FieldValue.increment(-hiringCost),\n          balance: FieldValue.increment(-hiringCost),\n          updatedAt: nowIso\n        });\n\n        return NextResponse.json({ success: true, employee: employeeRecord });\n      }\n\n      case 'decline': {\n        if (!candidateId) {\n          return NextResponse.json({ error: 'candidateId is required' }, { status: 400 });\n        }\n\n        const updatedPool = recruitmentPool.filter((c) => c.id !== candidateId);\n        await businessRef.update({ recruitmentPool: updatedPool, updatedAt: nowIso });\n        return NextResponse.json({ success: true });\n      }\n\n      case 'pay': {\n        if (!employeeId) {\n          return NextResponse.json({ error: 'employeeId is required' }, { status: 400 });\n        }\n\n        const employee = employees.find((e) => e.id === employeeId);\n        if (!employee) {\n          return NextResponse.json({ error: 'Employee not found' }, { status: 404 });\n        }\n\n        const wage = Number(employee.unpaidWages ?? 0);\n        if (wage <= 0) {\n          return NextResponse.json({ error: 'No wages due' }, { status: 400 });\n        }\n\n        if (cashBalance < wage) {\n          return NextResponse.json({ error: 'Insufficient funds' }, { status: 400 });\n        }\n\n        const updatedEmployees = employees.map((e) =>\n          e.id === employeeId\n            ? {\n                ...e,\n                unpaidWages: 0,\n                stats: {\n                  ...e.stats,\n                  morale: Math.min(100, (e.stats?.morale ?? 0) + 10)\n                }\n              }\n            : e\n        );\n\n        await businessRef.update({\n          employees: updatedEmployees,\n          cashBalance: FieldValue.increment(-wage),\n          balance: FieldValue.increment(-wage),\n          updatedAt: nowIso\n        });\n\n        return NextResponse.json({ success: true, paid: wage });\n      }\n\n      case 'pay_all': {\n        const totalOwed = employees.reduce((sum, e) => sum + (e.unpaidWages || 0), 0);\n        if (totalOwed <= 0) {\n          return NextResponse.json({ success: true, paid: 0 });\n        }\n\n        if (cashBalance < totalOwed) {\n          return NextResponse.json({ error: 'Insufficient funds' }, { status: 400 });\n        }\n\n        const updatedEmployees = employees.map((e) => ({\n          ...e,\n          unpaidWages: 0,\n          stats: {\n            ...e.stats,\n            morale: Math.min(100, (e.stats?.morale ?? 0) + 12)\n          }\n        }));\n\n        await businessRef.update({\n          employees: updatedEmployees,\n          cashBalance: FieldValue.increment(-totalOwed),\n          balance: FieldValue.increment(-totalOwed),\n          updatedAt: nowIso\n        });\n\n        return NextResponse.json({ success: true, paid: totalOwed });\n      }\n\n      case 'fire': {\n        if (!employeeId) {\n          return NextResponse.json({ error: 'employeeId is required' }, { status: 400 });\n        }\n\n        const employee = employees.find((e) => e.id === employeeId);\n        if (!employee) {\n          return NextResponse.json({ error: 'Employee not found' }, { status: 404 });\n        }\n\n        const updatedEmployees = employees.filter((e) => e.id !== employeeId);\n        const nextStaffCount = Math.max(0, Number(data.staffCount ?? employees.length) - 1);\n\n        await businessRef.update({\n          employees: updatedEmployees,\n          staffCount: nextStaffCount,\n          updatedAt: nowIso\n        });\n\n        return NextResponse.json({ success: true });\n      }\n\n      case 'assign_specialization': {\n        if (!employeeId || !specialization) {\n          return NextResponse.json({ error: 'employeeId and specialization are required' }, { status: 400 });\n        }\n\n        const employee = employees.find((e) => e.id === employeeId);\n        if (!employee) {\n          return NextResponse.json({ error: 'Employee not found' }, { status: 404 });\n        }\n\n        const updatedEmployee = assignSpecialization(employee, specialization as any);\n        const updatedEmployees = employees.map((e) => (e.id === employeeId ? updatedEmployee : e));\n\n        await businessRef.update({ employees: updatedEmployees, updatedAt: nowIso });\n        return NextResponse.json({ success: true, employee: updatedEmployee });\n      }\n\n      default:\n        return NextResponse.json({ error: 'Unsupported action' }, { status: 400 });\n    }\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Employee action error:', error);\n    return NextResponse.json({ error: 'Failed to process employee action' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/insights/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1964,1967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1964,1967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport async function POST(request: NextRequest) {\n    try {\n        const limiter = rateLimit(request, 20, 60000, 'business:insights:POST');\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        const body = await request.json();\n        const { businessId } = body;\n\n        if (!businessId) {\n            return NextResponse.json({ error: 'Missing businessId' }, { status: 400 });\n        }\n\n        // 1. Fetch live business metrics\n        const bizDoc = await adminDb.collection('businesses').doc(businessId).get();\n        if (!bizDoc.exists) {\n            return NextResponse.json({ error: 'Business not found' }, { status: 404 });\n        }\n\n        const data = bizDoc.data();\n\n        if (data?.ownerId !== userId) {\n            return NextResponse.json({ error: 'Business not found' }, { status: 404 });\n        }\n\n        // 2. Mock AI Logic (In a real scenario, this would call Gemini/GPT)\n        // Here we simulate professional suggestions based on actual metrics\n        const suggestions = [\n            `Since your current phase is '${data?.phase}', focus on customer acquisition to boost your $${data?.cashflow} monthly cashflow.`,\n            `With ${data?.employeeCount} employee(s), consider automating repeated processes before your next hire to preserve your ‡∏ø ${data?.balance} balance.`,\n            `Your entity valuation of ‡∏ø ${data?.valuation.toLocaleString()} suggests you are ready for Series A expansion.`\n        ];\n\n        return NextResponse.json({\n            success: true,\n            suggestions,\n            timestamp: new Date().toISOString()\n        });\n\n    } catch (error: any) {\n        if (error.message?.includes('Unauthorized')) {\n            return NextResponse.json({ error: error.message }, { status: 401 });\n        }\n        console.error('AI Insights error');\n        return NextResponse.json({ error: 'Failed to generate insights' }, { status: 500 });\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/register/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3154,3157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3154,3157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5906,5909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5906,5909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { z } from 'zod';\nimport * as admin from 'firebase-admin';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport { getBusinessType } from '@/lib/economy';\nimport { getNetWorthSnapshot } from '@/lib/economy/valuation';\nimport { initStockMarketState, initStockPortfolio } from '@/lib/economy/stock-market';\n\nconst RegistrationSchema = z.object({\n  name: z.string().min(3).max(50),\n  businessTypeId: z.string().min(1).max(50),\n  branding: z\n    .object({\n      themeColor: z.string().min(1).max(32).optional(),\n      logoUrl: z.string().url().optional(),\n      icon: z.string().min(1).max(16).optional(),\n    })\n    .optional(),\n});\n\nexport async function POST(request: NextRequest) {\n  try {\n    // 1. Rate Limit Check (5 registrations per minute per IP)\n    const limiter = rateLimit(request, 5, 60000);\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const body = await request.json();\n    const result = RegistrationSchema.safeParse(body);\n\n    if (!result.success) {\n      return NextResponse.json({ error: 'Invalid data', details: result.error.format() }, { status: 400 });\n    }\n\n    const { name, businessTypeId, branding } = result.data;\n    const FieldValue = admin.firestore.FieldValue;\n\n    const businessesRef = adminDb.collection('businesses');\n\n    const nameQuery = await businessesRef.where('name', '==', name).get();\n    if (!nameQuery.empty) {\n      return NextResponse.json({ error: `The name \"${name}\" is already taken.` }, { status: 400 });\n    }\n\n    const selectedType = getBusinessType(businessTypeId);\n    if (!selectedType) {\n      return NextResponse.json({ error: 'Invalid business type' }, { status: 400 });\n    }\n\n    // ATOMIC BATCH - Ensure data consistency\n    const newBizId = adminDb.collection('businesses').doc().id;\n    const nowIso = new Date().toISOString();\n\n    const userRef = adminDb.collection('users').doc(userId);\n    const userDoc = await userRef.get();\n    if (!userDoc.exists) {\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\n    }\n\n    const userData = userDoc.data() || {};\n    const ownerName = userData.firstName || userData.displayName || \"Founder\";\n    const userBCoins = typeof userData.bCoins === 'number' ? userData.bCoins : 0;\n\n    if (userData.hasBusiness && userData.businessID) {\n      return NextResponse.json({ error: 'Business already registered' }, { status: 403 });\n    }\n\n    const REGISTRATION_COST = 250;\n    if (userBCoins < REGISTRATION_COST) {\n      return NextResponse.json({\n        error: `Insufficient B-Coins. You need ${REGISTRATION_COST} B-Coins to register a business (you have ${userBCoins}).`\n      }, { status: 403 });\n    }\n\n    const cleanBranding = branding\n      ? Object.fromEntries(Object.entries(branding).filter(([_, v]) => v !== undefined))\n      : {};\n\n    const startingCapital = selectedType.startingCapital;\n\n    const businessData: any = {\n      // Ownership\n      id: newBizId,\n      ownerId: userId,\n      ownerName,\n      playerId: userId,\n\n      // Economy model\n      businessTypeId: selectedType.id,\n      businessName: name,\n      branding: cleanBranding,\n      cashBalance: startingCapital,\n      totalRevenue: 0,\n      totalExpenses: 0,\n      reputation: 50,\n      customerSatisfaction: 70,\n      reviewCount: 0,\n      operatingHours: { open: 8, close: 20 },\n      staffCount: 1,\n      maxConcurrentOrders: selectedType.demandConfig.maxConcurrentOrders,\n      inventory: {},\n      employees: [\n        {\n          id: `emp_${Date.now()}`,\n          name: `${userId.slice(0, 5)} Manager`,\n          role: 'manager',\n          salaryPerDay: selectedType.operatingCosts.staffPerHour\n            ? selectedType.operatingCosts.staffPerHour * 8\n            : 200,\n          stats: { speed: 50, quality: 50, morale: 100 },\n          unpaidWages: 0,\n          hiredAt: nowIso,\n        },\n      ],\n      marketState: {\n        lastRestock: nowIso,\n        nextRestock: new Date(Date.now() + 300000).toISOString(),\n        items: [],\n      },\n      ownedTools: [],\n      stockMarket: initStockMarketState(),\n      stockPortfolio: initStockPortfolio(),\n      netWorth: startingCapital,\n      recruitmentPool: [],\n      lastRecruitmentTime: nowIso,\n      lastPayrollTime: nowIso,\n      reviews: [],\n      activeOrders: [],\n      ordersCompleted: 0,\n      ordersFailed: 0,\n\n      // Compatibility (legacy fields used by some UI)\n      name,\n      balance: startingCapital,\n      valuation: startingCapital,\n      category: selectedType.name,\n      phase: 'Startup',\n      cashflow: 0,\n      employeeCount: 1,\n      founded: nowIso,\n\n      // Status\n      status: 'active',\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n    };\n\n    const netWorthSnapshot = getNetWorthSnapshot(businessData);\n    businessData.netWorth = netWorthSnapshot.netWorth;\n    businessData.valuation = netWorthSnapshot.valuation;\n\n    // ATOMIC BATCH OPERATION\n    const batch = adminDb.batch();\n\n    // Create business document\n    batch.set(adminDb.collection('businesses').doc(newBizId), businessData);\n\n    // Update user document atomically\n    batch.update(userRef, {\n      hasBusiness: true,\n      businessID: newBizId,\n      xp: FieldValue.increment(100),\n      bCoins: FieldValue.increment(-250), // Deduct registration cost\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n    });\n\n    // Commit all operations atomically - all succeed or all fail\n    await batch.commit();\n\n    return NextResponse.json({\n      success: true,\n      business: businessData,\n      businessId: newBizId\n    });\n\n  } catch (error: any) {\n    console.error('Registration Error');\n\n    // Better error handling for specific cases\n    if (error.code === 'permission-denied') {\n      return NextResponse.json({ error: 'Permission denied' }, { status: 403 });\n    }\n\n    if (error.code === 'resource-exhausted') {\n      return NextResponse.json({ error: 'Rate limit exceeded' }, { status: 429 });\n    }\n\n    return NextResponse.json({ error: 'Registration failed' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/shutdown/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1732,1735],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1732,1735],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport * as admin from 'firebase-admin';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport async function POST(request: NextRequest) {\n    try {\n        const limiter = rateLimit(request, 2, 60000, 'business:shutdown:POST');\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        const userRef = adminDb.collection('users').doc(userId);\n        const userDoc = await userRef.get();\n\n        if (!userDoc.exists) {\n            return NextResponse.json({ error: 'User not found' }, { status: 404 });\n        }\n\n        const userData = userDoc.data() || {};\n        const businessId = userData.businessID;\n\n        if (!userData.hasBusiness || !businessId) {\n            return NextResponse.json({ error: 'No active business found' }, { status: 404 });\n        }\n\n        // ATOMIC BATCH - Delete business and update user\n        const batch = adminDb.batch();\n\n        // 1. Delete the business document\n        const businessRef = adminDb.collection('businesses').doc(businessId);\n        batch.delete(businessRef);\n\n        // 2. Update user document - Reset business flags\n        batch.update(userRef, {\n            hasBusiness: false,\n            businessID: admin.firestore.FieldValue.delete(),\n            updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n        });\n\n        await batch.commit();\n\n        return NextResponse.json({ success: true, message: 'Business shut down successfully' });\n\n    } catch (error: any) {\n        console.error('Shutdown Error:', error);\n        return NextResponse.json({ error: 'Failed to shut down business' }, { status: 500 });\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/status/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1109,1112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1109,1112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'business:status:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    // Get user's business from Firestore\n    const bizSnap = await adminDb.collection('businesses')\n      .where('ownerId', '==', userId)\n      .limit(1)\n      .get();\n\n    if (bizSnap.empty) {\n      return NextResponse.json({\n        business: null,\n        has_business: false\n      });\n    }\n\n    const business = bizSnap.docs[0].data();\n\n    return NextResponse.json({\n      business: {\n        ...business,\n        business_name: business.name // Map to match frontend expectation if needed\n      },\n      has_business: true\n    });\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Admin SDK Business status fetch error:', error);\n    return NextResponse.json({ error: 'Failed to fetch business status' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/business/toggle-status/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1668,1671],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1668,1671],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport async function POST(request: NextRequest) {\n    try {\n        const limiter = rateLimit(request, 10, 60000, 'business:toggle-status:POST');\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        const userRef = adminDb.collection('users').doc(userId);\n        const userDoc = await userRef.get();\n\n        if (!userDoc.exists) {\n            return NextResponse.json({ error: 'User not found' }, { status: 404 });\n        }\n\n        const userData = userDoc.data() || {};\n        const businessId = userData.businessID;\n\n        if (!userData.hasBusiness || !businessId) {\n            return NextResponse.json({ error: 'No active business found' }, { status: 404 });\n        }\n\n        const businessRef = adminDb.collection('businesses').doc(businessId);\n        const businessDoc = await businessRef.get();\n\n        if (!businessDoc.exists) {\n            return NextResponse.json({ error: 'Business document missing' }, { status: 404 });\n        }\n\n        const currentStatus = businessDoc.data()?.status || 'active';\n        const newStatus = currentStatus === 'active' ? 'paused' : 'active';\n\n        await businessRef.update({\n            status: newStatus,\n            updatedAt: new Date().toISOString()\n        });\n\n        return NextResponse.json({ success: true, status: newStatus });\n\n    } catch (error: any) {\n        console.error('Toggle Status Error:', error);\n        return NextResponse.json({ error: 'Failed to toggle business status' }, { status: 500 });\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/cloudinary/sign/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1588,1591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1588,1591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport crypto from 'crypto'\nimport { verifyAuth } from '@/lib/auth-server'\n\nexport const dynamic = 'force-dynamic'\n\nfunction requireEnv(name: string) {\n  const v = process.env[name]\n  if (!v) throw new Error(`Missing env var: ${name}`)\n  return v\n}\n\nfunction sha1(input: string) {\n  return crypto.createHash('sha1').update(input).digest('hex')\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const decoded = await verifyAuth(request)\n    const uid = decoded.uid\n\n    const cloudName = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME\n    if (!cloudName) return NextResponse.json({ error: 'Missing Cloudinary cloud name' }, { status: 500 })\n\n    const apiKey = requireEnv('CLOUDINARY_API_KEY')\n    const apiSecret = requireEnv('CLOUDINARY_API_SECRET')\n\n    const timestamp = Math.floor(Date.now() / 1000)\n\n    // Cost control: use a stable public_id so we overwrite instead of creating infinite assets.\n    const folder = 'brighted/avatars'\n    const publicId = `${folder}/${uid}`\n\n    // Cloudinary signature is sha1 of sorted params joined with & plus api_secret.\n    // We enforce folder/public_id/overwrite from the server so clients can't upload arbitrary assets.\n    const paramsToSign = [`folder=${folder}`, `overwrite=true`, `public_id=${publicId}`, `timestamp=${timestamp}`].join('&')\n    const signature = sha1(paramsToSign + apiSecret)\n\n    return NextResponse.json({\n      cloudName,\n      apiKey,\n      timestamp,\n      signature,\n      folder,\n      publicId,\n      overwrite: true,\n    })\n  } catch (e: any) {\n    const msg = e?.message || 'Failed to sign upload'\n    const status = msg.startsWith('Unauthorized') ? 401 : 500\n    return NextResponse.json({ error: msg }, { status })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/content/clean/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":179,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":179,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":196,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6255,6258],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6255,6258],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\n\ninterface CleanRequest {\n  content: string;\n  useAI?: boolean;\n}\n\nfunction aiCleaningEnabled() {\n  return process.env.ALLOW_LOCAL_AI_CLEANING === 'true';\n}\n\n// Pattern detection for mangled PDF text\nconst MANGLE_PATTERNS = [\n  /(\\d+)x(\\d+)/g, // 3x2 -> 3x¬≤\n  /(\\d+)\\^(\\d+)/g, // 3^2 -> 3¬≤\n  /([a-z])(\\d+)/g, // x2 -> x¬≤\n  /(\\d+)\\s*([a-z])\\s*(\\d+)/g, // 3 x 2 -> 3x¬≤\n  /\\b[A-Za-z]+-\\s*\\n\\s*[A-Za-z]+\\b/g, // hyphenated words across lines\n];\n\n// Fallback cleaning function (works without AI)\nfunction cleanContentFallback(content: string): string {\n  if (!content || content.trim().length === 0) {\n    return content;\n  }\n\n  let cleaned = content;\n\n  // 1. Fix Broken layout and Hyphenation\n  cleaned = cleaned\n    // Join words split by hyphenation at line breaks (e.g. \"contin-\\nued\" -> \"continued\")\n    .replace(/([a-z]+)-\\s*\\n\\s*([a-z]+)/gi, '$1$2')\n    // Remove excessive newlines that break sentences (simple heuristic: newline not preceded by punctuation)\n    .replace(/([^\\.\\!\\?\\:])\\n+([a-z])/g, '$1 $2');\n\n  // 2. Fix Ligatures and Encoding Artifacts\n  cleaned = cleaned\n    .replace(/Ô¨Å/g, 'fi')\n    .replace(/Ô¨Ç/g, 'fl')\n    .replace(/Ô¨Ä/g, 'ff')\n    .replace(/Ô¨É/g, 'ffi')\n    .replace(/Ô¨Ñ/g, 'ffl')\n    .replace(/‚Äô/g, \"'\")\n    .replace(/[‚Äú‚Äù]/g, '\"')\n    .replace(/‚Äî/g, '-');\n\n  // 3. Mathematical Notation Repair\n  cleaned = cleaned\n    // Fix superscripts: 3x2 -> 3x¬≤, x^2 -> x¬≤\n    .replace(/(\\d+)x(\\d+)/g, (match, base, exp) => {\n      const superscripts: { [key: string]: string } = {\n        '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',\n        '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ'\n      };\n      return `${base}x${superscripts[exp] || exp}`;\n    })\n    .replace(/([a-z])2/g, '$1¬≤')\n    .replace(/([a-z])3/g, '$1¬≥')\n    .replace(/\\^(\\d+)/g, (match, exp) => {\n      const superscripts: { [key: string]: string } = {\n        '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',\n        '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ'\n      };\n      return exp.split('').map((n: string) => superscripts[n] || n).join('');\n    })\n    // Fix subscripts: H2O -> H‚ÇÇO (chemical or variable indices)\n    .replace(/([A-Zn])(\\d+)/g, (match, letter, num) => {\n      const subscripts: { [key: string]: string } = {\n        '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',\n        '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ'\n      };\n      // Simple heuristic: Assume capital letter + number often equals subscript (H2O, P1)\n      // but avoid common algebra like 3X or dates like Y2K unless strictly defined context\n      // For safety, we stick to common chemical or variable patterns\n      return letter + num.split('').map((n: string) => subscripts[n] || n).join('');\n    })\n    // Fix standard fractions: 1/2 -> ¬Ω\n    .replace(/\\b1\\/2\\b/g, '¬Ω')\n    .replace(/\\b1\\/4\\b/g, '¬º')\n    .replace(/\\b3\\/4\\b/g, '¬æ')\n    // Fix common operators\n    .replace(/x\\s*\\*\\s*x/g, '√ó') // poor man's multiplication check\n    .replace(/<=/g, '‚â§')\n    .replace(/>=/g, '‚â•')\n    .replace(/!=/g, '‚â†')\n    .replace(/\\+-/g, '¬±');\n\n  // 4. General Formatting\n  cleaned = cleaned\n    .replace(/\\.\\.\\./g, '‚Ä¶')\n    .replace(/\\s+/g, ' ') // Collapse multiple spaces\n    .trim();\n\n  return cleaned;\n}\n\n// Check if content looks mangled\nfunction isMangled(content: string): boolean {\n  if (!content || content.length < 3) return false;\n\n  // Check for common mangling patterns\n  const hasManglePattern = MANGLE_PATTERNS.some(pattern => pattern.test(content));\n  const hasMultipleNumbers = (content.match(/\\d+/g) || []).length > 2;\n  const hasNoSpacesBetweenNumbers = /\\d+[a-z]\\d+/.test(content);\n  // Check for broken ligatures or odd spacing\n  const hasHyphenation = /\\b[a-z]+-\\s+/.test(content);\n\n  return hasManglePattern || (hasMultipleNumbers && hasNoSpacesBetweenNumbers) || hasHyphenation;\n}\n\n// Call Ollama Llama 3 API\nasync function cleanWithAI(content: string): Promise<string> {\n  try {\n    const response = await fetch('http://localhost:11434/api/generate', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: 'llama3',\n        prompt: `System: You are an expert academic text cleaner. Your goal is to repair text extracted from PDFs that may have encoding issues, broken lines, or mangled mathematical notation.\n        \nInstructions:\n1. Fix broken hyphenation (e.g., \"con- tinued\" -> \"continued\").\n2. Convert pseudo-math to proper unicode (e.g., \"x^2\" -> \"x¬≤\", \"1/2\" -> \"¬Ω\", \"3x2\" -> \"3x¬≤\").\n3. Fix chemical formulas if present (e.g., \"H2O\" -> \"H‚ÇÇO\").\n4. Remove excessive headers/footers if they interrupt the flow.\n5. maintain the original meaning precisely. Do not summarize.\n\nOriginal Text:\n\"${content}\"\n\nCleaned Text:`,\n        stream: false,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error('Ollama API error');\n    }\n\n    const data = await response.json();\n    return data.response?.trim() || content;\n  } catch (error) {\n    console.error('Ollama API error:', error);\n    throw error;\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    await verifyAuth(request);\n\n    const body: CleanRequest = await request.json();\n    const { content, useAI = false } = body;\n\n    if (!content) {\n      return NextResponse.json({ error: 'Content is required' }, { status: 400 });\n    }\n\n    // Check if content needs cleaning\n    if (!isMangled(content)) {\n      return NextResponse.json({\n        cleaned: content,\n        wasMangled: false,\n        method: 'none'\n      });\n    }\n\n    let cleaned: string;\n    let method: string;\n\n    // Try AI cleaning if requested and available\n    if (useAI && aiCleaningEnabled()) {\n      try {\n        cleaned = await cleanWithAI(content);\n        method = 'ai';\n      } catch (error) {\n        // Fallback to rule-based cleaning\n        cleaned = cleanContentFallback(content);\n        method = 'fallback (AI failed)';\n      }\n    } else {\n      // Use fallback cleaning\n      cleaned = cleanContentFallback(content);\n      method = 'fallback';\n    }\n\n    return NextResponse.json({\n      original: content,\n      cleaned,\n      wasMangled: true,\n      method\n    });\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Error cleaning content:', error);\n    return NextResponse.json(\n      { error: 'Failed to clean content' },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/economy/calculate/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1446,1449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1446,1449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":92,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":210,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":210,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":210,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6823,6826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6823,6826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'businessUpdate' is never reassigned. Use 'const' instead.","line":257,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":257,"endColumn":47,"fix":{"range":[8401,8449],"text":"const businessUpdate: Partial<BusinessState> = {};"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":315,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":315,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":315,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10434,10437],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10434,10437],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { z } from 'zod';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport { \n  generateOrdersForTick, \n  acceptOrder, \n  rejectOrder, \n  startOrder, \n  completeOrder, \n  failOrder,\n  checkExpiredOrders\n} from '@/lib/economy/order-engine';\nimport { \n  BusinessState,\n  Order \n} from '@/lib/economy/economy-types';\nimport { getBusinessType } from '@/lib/economy/business-templates';\n\n// Request validation schemas\nconst CalculateOrdersSchema = z.object({\n  businessId: z.string().min(1, 'Business ID is required'),\n  simHour: z.number().min(0).max(23),\n  tickMinutes: z.number().min(1).max(60).default(15)\n});\n\nconst OrderActionSchema = z.object({\n  businessId: z.string().min(1, 'Business ID is required'),\n  orderId: z.string().min(1, 'Order ID is required'),\n  action: z.enum(['accept', 'reject', 'start', 'complete', 'fail']),\n  qualityScore: z.number().min(0).max(100).optional(),\n  reason: z.string().optional()\n});\n\n// Get business state from Firestore\nasync function getBusinessState(businessId: string): Promise<BusinessState | null> {\n  try {\n    const businessDoc = await adminDb.collection('businesses').doc(businessId).get();\n    if (!businessDoc.exists) return null;\n    \n    const data = businessDoc.data();\n    if (!data) return null;\n\n    const toIso = (v: any): string => {\n      if (!v) return new Date().toISOString();\n      if (typeof v === 'string') return v;\n      if (typeof v?.toDate === 'function') return v.toDate().toISOString();\n      return new Date().toISOString();\n    };\n\n    return {\n      id: businessId,\n      playerId: data.ownerId,\n      businessTypeId: data.businessTypeId || 'retail',\n      businessName: data.name || 'Business',\n\n      cashBalance: Number(data.balance ?? 0),\n      totalRevenue: Number(data.totalRevenue ?? 0),\n      totalExpenses: Number(data.totalExpenses ?? 0),\n\n      reputation: Number(data.reputation ?? 50),\n      customerSatisfaction: Number(data.customerSatisfaction ?? 70),\n      reviewCount: Number(data.reviewCount ?? 0),\n\n      operatingHours: data.operatingHours || { open: 8, close: 20 },\n      staffCount: Number(data.staffCount ?? 1),\n      maxConcurrentOrders: Number(data.maxConcurrentOrders ?? 3),\n\n      employees: Array.isArray(data.employees) ? data.employees : [],\n\n      inventory: data.inventory && typeof data.inventory === 'object' ? data.inventory : {},\n      marketState: {\n        lastRestock: toIso(data.marketState?.lastRestock ?? data.lastRestock),\n        nextRestock: toIso(data.marketState?.nextRestock ?? data.nextRestock),\n        items: Array.isArray(data.marketState?.items) ? data.marketState.items : (Array.isArray(data.items) ? data.items : [])\n      },\n\n      recruitmentPool: Array.isArray(data.recruitmentPool) ? data.recruitmentPool : [],\n      lastRecruitmentTime: toIso(data.lastRecruitmentTime),\n\n      lastPayrollTime: toIso(data.lastPayrollTime),\n      reviews: Array.isArray(data.reviews) ? data.reviews : [],\n\n      activeOrders: Array.isArray(data.activeOrders) ? data.activeOrders : [],\n      ordersCompleted: Number(data.ordersCompleted ?? 0),\n      ordersFailed: Number(data.ordersFailed ?? 0),\n\n      createdAt: toIso(data.createdAt),\n      lastActiveAt: toIso(data.lastActiveAt)\n    };\n  } catch (error) {\n    console.error('Error getting business state');\n    return null;\n  }\n}\n\n// Update business state in Firestore\nasync function updateBusinessState(businessId: string, updates: Partial<BusinessState>): Promise<void> {\n  try {\n    const businessRef = adminDb.collection('businesses').doc(businessId);\n    await businessRef.update({\n      ...updates,\n      updatedAt: new Date()\n    });\n  } catch (error) {\n    console.error('Error updating business state');\n    throw error;\n  }\n}\n\n// Calculate new orders for a business tick\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'economy:calculate:POST');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const body = await request.json();\n    \n    const result = CalculateOrdersSchema.safeParse(body);\n    if (!result.success) {\n      return NextResponse.json({ \n        error: 'Invalid request data', \n        details: result.error.format() \n      }, { status: 400 });\n    }\n\n    const { businessId, simHour, tickMinutes } = result.data;\n\n    // Get business state\n    const businessState = await getBusinessState(businessId);\n    if (!businessState) {\n      return NextResponse.json({ error: 'Business not found' }, { status: 404 });\n    }\n\n    // Verify ownership\n    if (businessState.playerId !== decodedToken.uid) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });\n    }\n\n    // Get business type\n    const businessType = getBusinessType(businessState.businessTypeId);\n    if (!businessType) {\n      return NextResponse.json({ error: 'Business type not found' }, { status: 404 });\n    }\n\n    // Get current active orders\n    const activeOrderCount = businessState.activeOrders?.length || 0;\n\n    // Generate new orders\n    const newOrders = generateOrdersForTick(\n      businessType,\n      businessState,\n      simHour,\n      activeOrderCount,\n      tickMinutes\n    );\n\n    // Save new orders to Firestore\n    if (newOrders.length > 0) {\n      const batch = adminDb.batch();\n      const ordersRef = adminDb.collection('businesses').doc(businessId).collection('orders');\n      \n      newOrders.forEach(order => {\n        const orderRef = ordersRef.doc();\n        batch.set(orderRef, {\n          ...order,\n          createdAt: new Date(),\n          updatedAt: new Date()\n        });\n      });\n\n      await batch.commit();\n    }\n\n    // Check for expired orders\n    const allOrdersRef = adminDb.collection('businesses').doc(businessId).collection('orders');\n    const allOrdersSnapshot = await allOrdersRef\n      .where('status', 'in', ['pending', 'accepted', 'in_progress'])\n      .get();\n    \n    const allOrders = allOrdersSnapshot.docs.map(doc => ({\n      id: doc.id,\n      ...doc.data()\n    } as Order));\n\n    const { expired, active } = checkExpiredOrders(allOrders);\n\n    // Update expired orders\n    if (expired.length > 0) {\n      const updateBatch = adminDb.batch();\n      expired.forEach(order => {\n        const orderRef = allOrdersRef.doc(order.id);\n        updateBatch.update(orderRef, {\n          status: 'expired',\n          updatedAt: new Date()\n        });\n      });\n      await updateBatch.commit();\n    }\n\n    return NextResponse.json({\n      success: true,\n      newOrders: newOrders.length,\n      expiredOrders: expired.length,\n      activeOrders: active.length\n    });\n\n  } catch (error: any) {\n    console.error('Economy calculation error');\n    return NextResponse.json({ error: 'Failed to calculate economy' }, { status: 500 });\n  }\n}\n\n// Handle order actions (accept, reject, start, complete, fail)\nexport async function PUT(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 120, 60000, 'economy:calculate:PUT');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const body = await request.json();\n    \n    const result = OrderActionSchema.safeParse(body);\n    if (!result.success) {\n      return NextResponse.json({ \n        error: 'Invalid request data', \n        details: result.error.format() \n      }, { status: 400 });\n    }\n\n    const { businessId, orderId, action, qualityScore, reason } = result.data;\n\n    // Get business state\n    const businessState = await getBusinessState(businessId);\n    if (!businessState) {\n      return NextResponse.json({ error: 'Business not found' }, { status: 404 });\n    }\n\n    // Verify ownership\n    if (businessState.playerId !== decodedToken.uid) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });\n    }\n\n    // Get the order\n    const orderRef = adminDb.collection('businesses').doc(businessId).collection('orders').doc(orderId);\n    const orderDoc = await orderRef.get();\n    \n    if (!orderDoc.exists) {\n      return NextResponse.json({ error: 'Order not found' }, { status: 404 });\n    }\n\n    const order = { id: orderId, ...orderDoc.data() } as Order;\n\n    let updatedOrder: Order;\n    let businessUpdate: Partial<BusinessState> = {};\n\n    // Process the action\n    switch (action) {\n      case 'accept':\n        updatedOrder = acceptOrder(order);\n        break;\n        \n      case 'reject':\n        const rejectResult = rejectOrder(order);\n        updatedOrder = rejectResult.order;\n        businessUpdate.reputation = Math.max(0, businessState.reputation - rejectResult.reputationPenalty);\n        break;\n        \n      case 'start':\n        updatedOrder = startOrder(order);\n        break;\n        \n      case 'complete':\n        if (qualityScore === undefined) {\n          return NextResponse.json({ error: 'Quality score is required for completion' }, { status: 400 });\n        }\n        const completeResult = completeOrder(order, qualityScore);\n        updatedOrder = completeResult.order;\n        businessUpdate.cashBalance = businessState.cashBalance + completeResult.payment;\n        businessUpdate.ordersCompleted = businessState.ordersCompleted + 1;\n        break;\n        \n      case 'fail':\n        const failReason = (reason as 'deadline_missed' | 'stockout' | 'cancelled_by_business') || 'cancelled_by_business';\n        const failResult = failOrder(order, failReason);\n        updatedOrder = failResult.order;\n        businessUpdate.cashBalance = businessState.cashBalance - failResult.refund;\n        businessUpdate.reputation = Math.max(0, businessState.reputation - failResult.reputationPenalty);\n        businessUpdate.ordersFailed = businessState.ordersFailed + 1;\n        break;\n        \n      default:\n        return NextResponse.json({ error: 'Invalid action' }, { status: 400 });\n    }\n\n    // Update order in Firestore\n    await orderRef.update({\n      ...updatedOrder,\n      updatedAt: new Date()\n    });\n\n    // Update business state if needed\n    if (Object.keys(businessUpdate).length > 0) {\n      await updateBusinessState(businessId, businessUpdate);\n    }\n\n    return NextResponse.json({\n      success: true,\n      order: updatedOrder,\n      businessUpdate\n    });\n\n  } catch (error: any) {\n    console.error('Order action error');\n    return NextResponse.json({ error: 'Failed to process order action' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/labs/complete/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3338,3341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3338,3341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { z } from 'zod';\nimport { calculateXPUpdate, getDayKey } from '@/lib/xp-utils';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\n// Schema for lab completion XP\nconst LabCompleteSchema = z.object({\n    labId: z.string().min(1),\n    xpReward: z.number().min(1).max(500),\n    score: z.number().min(0).max(100).optional()\n});\n\nexport async function POST(request: NextRequest) {\n    try {\n        const limiter = rateLimit(request, 10, 60000, 'labs:complete');\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        const body = await request.json();\n        const result = LabCompleteSchema.safeParse(body);\n\n        if (!result.success) {\n            return NextResponse.json({\n                error: 'Invalid request',\n                details: result.error.format()\n            }, { status: 400 });\n        }\n\n        const { labId, xpReward, score } = result.data;\n        const todayKey = getDayKey();\n\n        // Fetch user data\n        const userRef = adminDb.collection('users').doc(userId);\n        const userSnap = await userRef.get();\n\n        if (!userSnap.exists) {\n            return NextResponse.json({ error: 'User not found' }, { status: 404 });\n        }\n\n        const userData = userSnap.data() || {};\n\n        // Check if lab already completed today\n        const completedLabs = userData.completedLabs || {};\n        if (completedLabs[labId] === todayKey) {\n            return NextResponse.json({\n                success: true,\n                alreadyCompleted: true,\n                message: 'Lab already completed today, no XP awarded',\n                xpGain: 0\n            });\n        }\n\n        // Calculate XP with daily cap\n        const { xpGain, xpToday, isCapped, updates } = calculateXPUpdate(userData, xpReward, todayKey);\n\n        // Calculate B-Coins reward (25-45 coins randomized)\n        const coinsEarned = Math.floor(Math.random() * (45 - 25 + 1)) + 25;\n\n        // Add lab completion tracking\n        updates[`completedLabs.${labId}`] = todayKey;\n        updates[`labScores.${labId}`] = {\n            score: score || 100,\n            completedAt: new Date().toISOString()\n        };\n\n        // Update user balances (assuming user model has cashBalance/balance like business)\n        // If not, we'll create them or increment them. \n        // Note: FieldValue.increment() works even if field doesn't exist (treats as 0)\n        updates['cashBalance'] = FieldValue.increment(coinsEarned);\n        updates['balance'] = FieldValue.increment(coinsEarned);\n\n        // Apply updates\n        await userRef.update(updates);\n\n        return NextResponse.json({\n            success: true,\n            xpGain,\n            xpToday,\n            isCapped,\n            coinsEarned,\n            newTotal: (userData.xp || 0) + xpGain,\n            message: isCapped\n                ? `Daily cap reached! Earned ${xpGain} XP & ‡∏ø${coinsEarned}`\n                : `Earned ${xpGain} XP & ‡∏ø${coinsEarned} for completing ${labId}`\n        });\n\n    } catch (error: any) {\n        if (error.message?.includes('Unauthorized')) {\n            return NextResponse.json({ error: error.message }, { status: 401 });\n        }\n        console.error('Lab complete error:', error);\n        return NextResponse.json(\n            { error: 'Failed to save lab completion' },\n            { status: 500 }\n        );\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/leaderboards/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[864,867],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[864,867],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fallbackId' is defined but never used. Allowed unused args must match /^_/u.","line":27,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2614,2617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2614,2617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3507,3510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3507,3510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8018,8021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8018,8021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8043,8046],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8043,8046],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { adminDb } from '@/lib/firebase-admin'\nimport { verifyAuth } from '@/lib/auth-server'\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit'\n\nexport const dynamic = 'force-dynamic'\n\ntype LeaderboardType = 'xp' | 'streak' | 'mastery' | 'schools'\n\nfunction clampInt(value: unknown, opts: { min: number; max: number; fallback: number }) {\n  const n = typeof value === 'string' ? Number(value) : typeof value === 'number' ? value : NaN\n  if (!Number.isFinite(n)) return opts.fallback\n  const i = Math.floor(n)\n  return Math.min(opts.max, Math.max(opts.min, i))\n}\n\nfunction normalizeSchoolId(school: string) {\n  return school\n    .trim()\n    .toLowerCase()\n    .replace(/[^a-z0-9\\s-]/g, '')\n    .replace(/\\s+/g, '-')\n    .replace(/-+/g, '-')\n    .slice(0, 64)\n}\n\nfunction displayNameFromUser(data: any, fallbackId: string) {\n  return (\n    data?.displayName ||\n    data?.fullName ||\n    data?.username ||\n    (typeof data?.firstName === 'string' && data.firstName) ||\n    'Explorer'\n  ) as string\n}\n\n/**\n * Try to read from pre-aggregated leaderboards collection first.\n * Falls back to direct user queries if cache doesn't exist.\n * \n * Pre-aggregated leaderboards are updated every 15 minutes via:\n * npx tsx scripts/aggregate-leaderboards.ts\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const type = (searchParams.get('type') || 'xp') as LeaderboardType\n    const limit = clampInt(searchParams.get('limit'), { min: 1, max: 50, fallback: 20 })\n\n    const limiter = rateLimit(request, type === 'schools' ? 3 : 20, 60000, `leaderboards:${type}`)\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!)\n\n    await verifyAuth(request)\n\n    if (!['xp', 'streak', 'mastery', 'schools'].includes(type)) {\n      return NextResponse.json({ error: 'Invalid leaderboard type' }, { status: 400 })\n    }\n\n    // Determine the cache document ID based on type\n    let cacheDocId = 'global' // default for xp\n    if (type === 'streak') cacheDocId = 'global_streak'\n    else if (type === 'mastery') cacheDocId = 'global_mastery'\n    else if (type === 'schools') cacheDocId = 'global_schools'\n\n    // Try to read from pre-aggregated cache first (MUCH cheaper - 1 read vs 5000+)\n    try {\n      const cachedDoc = await adminDb.collection('leaderboards').doc(cacheDocId).get()\n\n      if (cachedDoc.exists) {\n        const data = cachedDoc.data()\n\n        if (type === 'schools' && data?.schools) {\n          // Schools leaderboard format\n          const schools = (data.schools as any[]).slice(0, limit).map((s, idx) => ({\n            id: s.schoolId,\n            name: s.schoolName,\n            value: s.totalXP,\n            subtext: `${s.studentCount} Students ‚Ä¢ ${Math.round((s.averageMastery || 0) * 100)}% Avg Mastery`,\n            rank: idx + 1,\n            icon: 'üè´',\n            studentCount: s.studentCount,\n            averageMastery: s.averageMastery\n          }))\n\n          return NextResponse.json({\n            type,\n            entries: schools,\n            cached: true,\n            lastUpdated: data.lastUpdated?.toDate?.()?.toISOString() || null\n          }, {\n            headers: {\n              'Cache-Control': 'public, s-maxage=900, stale-while-revalidate=1800' // 15 min cache\n            }\n          })\n        }\n\n        if (data?.users && Array.isArray(data.users)) {\n          // User leaderboard format\n          const entries = (data.users as any[]).slice(0, limit).map((user, idx) => ({\n            id: user.userId,\n            name: user.displayName || 'Explorer',\n            value: type === 'xp' ? user.xp : type === 'streak' ? user.streak : user.mastery,\n            subtext: type === 'xp'\n              ? `${user.xp || 0} XP`\n              : type === 'streak'\n                ? `${user.streak || 0} Day Streak`\n                : `${Math.round((user.mastery || 0) * 100)}% Mastery`,\n            rank: idx + 1,\n            icon: type === 'xp' ? '‚ö°' : type === 'streak' ? 'üî•' : 'üß†',\n            avatarUrl: user.avatarUrl || null,\n            avatarCustomization: user.avatarCustomization || null,\n          }))\n\n          return NextResponse.json({\n            type,\n            entries,\n            cached: true,\n            lastUpdated: data.lastUpdated?.toDate?.()?.toISOString() || null\n          }, {\n            headers: {\n              'Cache-Control': 'public, s-maxage=900, stale-while-revalidate=1800' // 15 min cache\n            }\n          })\n        }\n      }\n    } catch (cacheError) {\n      // Cache read failed, fall through to direct query\n      console.warn('Leaderboard cache miss, falling back to direct query:', cacheError)\n    }\n\n    // FALLBACK: Direct query (expensive but ensures functionality)\n    // This runs if cache doesn't exist yet\n    if (type === 'schools') {\n      if (process.env.NODE_ENV === 'production') {\n        return NextResponse.json(\n          { error: 'Schools leaderboard cache not ready yet. Please try again shortly.' },\n          { status: 503 }\n        )\n      }\n\n      // Note: Firestore has no server-side group-by. This aggregates in memory.\n      // For large datasets, run aggregate-leaderboards.ts to pre-compute.\n      const usersSnap = await adminDb.collection('users').get()\n\n      const bySchool = new Map<\n        string,\n        { schoolId: string; schoolName: string; totalXP: number; studentCount: number; masterySum: number; masteryCount: number }\n      >()\n\n      usersSnap.forEach((doc) => {\n        const d = doc.data() || {}\n        const schoolNameRaw = (d.school as string | undefined) || ''\n        const schoolName = schoolNameRaw.trim()\n        if (!schoolName) return\n\n        const schoolId = (d.schoolId as string | undefined) || normalizeSchoolId(schoolName)\n        const xp = typeof d.xp === 'number' ? d.xp : 0\n        const gm = typeof d.globalMastery === 'number' ? d.globalMastery : undefined\n\n        const cur = bySchool.get(schoolId) || {\n          schoolId,\n          schoolName,\n          totalXP: 0,\n          studentCount: 0,\n          masterySum: 0,\n          masteryCount: 0,\n        }\n\n        cur.totalXP += xp\n        cur.studentCount += 1\n        if (typeof gm === 'number' && Number.isFinite(gm)) {\n          cur.masterySum += gm\n          cur.masteryCount += 1\n        }\n\n        bySchool.set(schoolId, cur)\n      })\n\n      const schools = Array.from(bySchool.values())\n        .sort((a, b) => b.totalXP - a.totalXP)\n        .slice(0, limit)\n        .map((s, idx) => {\n          const avgMastery = s.masteryCount ? s.masterySum / s.masteryCount : 0\n          return {\n            id: s.schoolId,\n            name: s.schoolName,\n            value: s.totalXP,\n            subtext: `${s.studentCount} Students ‚Ä¢ ${Math.round(avgMastery * 100)}% Avg Mastery`,\n            rank: idx + 1,\n            icon: 'üè´',\n            studentCount: s.studentCount,\n            averageMastery: avgMastery,\n          }\n        })\n\n      return NextResponse.json({ type, entries: schools, cached: false })\n    }\n\n    const field = type === 'xp' ? 'xp' : type === 'streak' ? 'streak' : 'globalMastery'\n\n    const snap = await adminDb.collection('users').orderBy(field, 'desc').limit(limit).get()\n\n    const entries = snap.docs.map((doc, idx) => {\n      const d = doc.data() || {}\n\n      const valueRaw = d[field]\n      const value = typeof valueRaw === 'number' ? valueRaw : 0\n\n      const subtext =\n        type === 'xp'\n          ? `${value} XP`\n          : type === 'streak'\n            ? `${value} Day Streak`\n            : `${Math.round(value * 100)}% Mastery`\n\n      return {\n        id: doc.id,\n        name: displayNameFromUser(d, doc.id),\n        value,\n        subtext,\n        rank: idx + 1,\n        icon: type === 'xp' ? '‚ö°' : type === 'streak' ? 'üî•' : 'üß†',\n        avatarUrl: d.avatarUrl || null,\n        avatarCustomization: d.avatarCustomization || null,\n      }\n    })\n\n    return NextResponse.json({ type, entries, cached: false })\n  } catch (error: any) {\n    if ((error as any).name === 'AuthError' || error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 })\n    }\n    console.error('Leaderboards error:', error)\n    return NextResponse.json({ error: 'Failed to fetch leaderboards' }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/learning-path/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[345,348],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[345,348],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3452,3455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3452,3455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3591,3594],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3591,3594],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3923,3926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3923,3926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3977,3980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3977,3980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4032,4035],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4032,4035],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4090,4093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4090,4093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4165,4168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4165,4168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'req' is defined but never used. Allowed unused args must match /^_/u.","line":234,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":234,"endColumn":8},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":363,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":363,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[12009,12068],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":365,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12106,12109],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12106,12109],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":420,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":420,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[13891,13944],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":425,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":425,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14061,14113],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'authError' is defined but never used. Allowed unused caught errors must match /^_/u.","line":426,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":426,"endColumn":23},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":428,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":428,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14200,14259],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":431,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":431,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14271,14320],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":433,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":433,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[14364,14456],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":441,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":441,"endColumn":15},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":457,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":457,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15249,15346],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":463,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":463,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15471,15560],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":465,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":465,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15566,15624],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":467,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":467,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15675,15750],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":470,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":470,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15799,15861],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":472,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":472,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[15959,16039],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":475,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":475,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[16115,16205],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":501,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":501,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[17214,17322],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":503,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":503,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17381,17384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17381,17384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'authError' is defined but never used. Allowed unused caught errors must match /^_/u.","line":530,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":530,"endColumn":23},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":532,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":532,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[18489,18554],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":558,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":558,"endColumn":15},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":574,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":574,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[19857,19953],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":612,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":612,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21324,21327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21324,21327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":614,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":614,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21446,21449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21446,21449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\nimport fs from 'fs';\nimport path from 'path';\nimport { getSubjectFromSourceFile } from '@/lib/subject-utils';\n// Note: adminDb import removed - objective IDs now loaded from file cache\n\n// Simple in-memory cache for learning paths (cleared on server restart)\nconst pathCache = new Map<string, { data: any; timestamp: number }>();\nconst CACHE_TTL = 5 * 60 * 1000; // 5 minutes\n\n// File-based objective ID cache (generated by scripts/cache-objective-ids.ts)\nlet objectiveIdsCacheData: { ids: string[]; timestamp: number } | null = null;\nconst OBJECTIVE_CACHE_FILE_TTL = 24 * 60 * 60 * 1000; // 24 hours\n\n// ============================================================================\n// CONSTANTS\n// ============================================================================\n\nconst MASTERY_THRESHOLD = 70;\nconst MAX_OBJECTIVES_PER_SUBJECT = 30;\nconst SYLLABUS_FILE_PATH = path.join(process.cwd(), 'syllabuses', 'output', 'combined_syllabuses.json');\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface SyllabusObjective {\n  id: string;\n  section: string;\n  subsection: string;\n  objective: string;\n  content: string;\n  specific_objectives: string[];\n  content_items: string[];\n  difficulty: number;\n  page_number: number;\n  keywords: string[];\n  hash: string;\n  source_file: string;\n  extraction_date: string;\n}\n\ninterface UserProgress {\n  [objectiveId: string]: {\n    mastery: number;\n    attempts: number;\n    lastAttempt: string;\n    stability: number;\n  };\n}\n\ninterface LearningPathResponse {\n  paths: { [subject: string]: SyllabusObjective[] };\n  subjects: string[];\n  total: number;\n  warnings?: string[];\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Maps user-selected subject names to patterns used in source files\n * @param subject - User-friendly subject name\n * @returns Array of lowercase patterns to match against source files\n */\nfunction mapSubjectToSourceFile(subject: string): string[] {\n  const lowerSubject = subject.toLowerCase();\n\n  if (lowerSubject.includes('math') || lowerSubject.includes('mathematics')) {\n    return ['mathematics', 'math'];\n  }\n  if (lowerSubject.includes('english') || lowerSubject.includes('language')) {\n    return ['english', 'language'];\n  }\n  if (lowerSubject.includes('business') || lowerSubject.includes('pob') || lowerSubject.includes('principles of business')) {\n    return ['business', 'pob', 'principles'];\n  }\n  if (lowerSubject.includes('economic')) {\n    return ['economic'];\n  }\n  if (lowerSubject.includes('science') || lowerSubject.includes('biology') || lowerSubject.includes('chemistry')) {\n    return ['biology', 'chemistry', 'science'];\n  }\n  if (lowerSubject.includes('social') || lowerSubject.includes('studies')) {\n    return ['social', 'studies'];\n  }\n  if (lowerSubject.includes('it') || lowerSubject.includes('information') || lowerSubject.includes('technology')) {\n    return ['information', 'technology', 'it'];\n  }\n  if (lowerSubject.includes('geography')) {\n    return ['geography'];\n  }\n\n  return [];\n}\n\n/**\n * Validates and sanitizes user input\n * @param body - Request body\n * @returns Validated subjects and userProgress\n */\nfunction validateInput(body: any): { subjects: string[], userProgress: UserProgress } {\n  const subjects = Array.isArray(body?.subjects)\n    ? body.subjects.filter((s: any) => typeof s === 'string' && s.trim())\n    : [];\n\n  const userProgress: UserProgress = {};\n\n  if (body?.userProgress && typeof body.userProgress === 'object') {\n    for (const [key, value] of Object.entries(body.userProgress)) {\n      if (\n        typeof value === 'object' &&\n        value !== null &&\n        typeof (value as any).mastery === 'number' &&\n        typeof (value as any).attempts === 'number' &&\n        typeof (value as any).lastAttempt === 'string' &&\n        typeof (value as any).stability === 'number'\n      ) {\n        userProgress[key] = value as any;\n      }\n    }\n  }\n\n  return { subjects, userProgress };\n}\n\n/**\n * Derives subject from objective ID prefix\n */\nfunction getSubjectFromId(id: string): string {\n  if (!id) return 'General';\n  const prefix = id.split('-')[0].toUpperCase();\n\n  if (prefix === 'MATH') return 'Mathematics';\n  if (prefix === 'BIO' || prefix === 'BIOL') return 'Biology';\n  if (prefix === 'CHEM') return 'Chemistry';\n  if (prefix === 'PHYS') return 'Physics';\n  if (prefix === 'ENG' || prefix === 'ENGL') return 'English';\n  if (prefix === 'IT' || prefix === 'INFO') return 'Information Technology';\n  if (prefix === 'POB' || prefix === 'BUS') return 'Principles of Business';\n  if (prefix === 'ECON') return 'Economics';\n  if (prefix === 'SOC' || prefix === 'SS') return 'Social Studies';\n  if (prefix === 'GEO' || prefix === 'GEOG') return 'Geography';\n  if (prefix === 'HIST') return 'History';\n  if (prefix === 'AGRI') return 'Agricultural Science';\n  if (prefix === 'POA' || prefix === 'ACCT') return 'Principles of Accounts';\n\n  return 'General';\n}\n\n/**\n * Groups objectives by subject and removes duplicates\n * @param objectives - All syllabus objectives\n * @returns Objectives grouped by subject with duplicates removed\n */\nfunction groupObjectivesBySubject(\n  objectives: SyllabusObjective[]\n): { [subject: string]: SyllabusObjective[] } {\n  const bySubject: { [subject: string]: SyllabusObjective[] } = {};\n  const globalSeenIds = new Set<string>(); // Prevent cross-subject duplicates\n\n  for (const obj of objectives) {\n    let subject: string = getSubjectFromSourceFile(obj.source_file);\n\n    // Fallback to ID-based detection if source_file is missing or returns General\n    if ((!subject || subject === 'General') && obj.id) {\n      subject = getSubjectFromId(obj.id);\n    }\n\n    if (subject === 'General') {\n      // Try one last check on content keywords if both fail? \n      // For now, let's stick to ID as it's reliable for our syllabus data\n    }\n\n    if (!bySubject[subject]) {\n      bySubject[subject] = [];\n    }\n\n    // Deduplicate globally across all subjects\n    if (!globalSeenIds.has(obj.id)) {\n      bySubject[subject].push(obj);\n      globalSeenIds.add(obj.id);\n    }\n  }\n\n  return bySubject;\n}\n\n/**\n * Filters subjects based on user selection\n * @param bySubject - All objectives grouped by subject\n * @param requestedSubjects - User-selected subjects\n * @returns Filtered subject names and warnings\n */\nfunction filterSubjects(\n  bySubject: { [subject: string]: SyllabusObjective[] },\n  requestedSubjects: string[]\n): { filteredSubjects: string[], warnings: string[] } {\n  const warnings: string[] = [];\n\n  // If no subjects requested, return all\n  if (requestedSubjects.length === 0) {\n    return { filteredSubjects: Object.keys(bySubject), warnings };\n  }\n\n  // Generate patterns from requested subjects\n  const subjectPatterns = requestedSubjects.flatMap(mapSubjectToSourceFile);\n\n  // Filter available subjects\n  const filteredSubjects = Object.keys(bySubject).filter(subject => {\n    const subjectLower = subject.toLowerCase();\n    return subjectPatterns.some(pattern => subjectLower.includes(pattern)) ||\n      requestedSubjects.some(s => subjectLower.includes(s.toLowerCase()));\n  });\n\n  // Check if any matches were found\n  if (filteredSubjects.length === 0) {\n    const available = Object.keys(bySubject).join(', ');\n    warnings.push(\n      `No matching subjects found for: ${requestedSubjects.join(', ')}. ` +\n      `Available subjects: ${available}`\n    );\n    // Return all subjects as fallback\n    return { filteredSubjects: Object.keys(bySubject), warnings };\n  }\n\n  // Check for requested subjects that weren't found\n  const foundPatterns = new Set(\n    filteredSubjects.flatMap(s => mapSubjectToSourceFile(s))\n  );\n  const missingSubjects = requestedSubjects.filter(\n    req => !subjectPatterns.some(p => foundPatterns.has(p))\n  );\n\n  if (missingSubjects.length > 0) {\n    warnings.push(`Some requested subjects not found: ${missingSubjects.join(', ')}`);\n  }\n\n  return { filteredSubjects, warnings };\n}\n\n/**\n * Sorts objectives for optimal learning progression\n * Priority: 1) Incomplete objectives, 2) Lower stability, 3) Difficulty level\n */\nfunction sortObjectivesForLearning(\n  objectives: SyllabusObjective[],\n  userProgress: UserProgress\n): SyllabusObjective[] {\n  return objectives.sort((a, b) => {\n    const progressA = userProgress[a.id]?.mastery || 0;\n    const progressB = userProgress[b.id]?.mastery || 0;\n\n    // First: Prioritize incomplete objectives (mastery < threshold)\n    const incompleteA = progressA < MASTERY_THRESHOLD;\n    const incompleteB = progressB < MASTERY_THRESHOLD;\n\n    if (incompleteA && !incompleteB) return -1;\n    if (!incompleteA && incompleteB) return 1;\n\n    // Second: Lower stability = needs more review\n    const stabilityA = userProgress[a.id]?.stability || 0;\n    const stabilityB = userProgress[b.id]?.stability || 0;\n\n    if (stabilityA !== stabilityB) {\n      return stabilityA - stabilityB;\n    }\n\n    // Third: Difficulty level (easier first)\n    return (a.difficulty ?? 5) - (b.difficulty ?? 5);\n  });\n}\n\n/**\n * Generates personalized learning paths separated by subject\n * @param objectives - All syllabus objectives\n * @param userProgress - User's progress data\n * @param subjects - Requested subjects (empty = all subjects)\n * @returns Learning paths organized by subject with warnings\n */\nfunction generateLearningPath(\n  objectives: SyllabusObjective[],\n  userProgress: UserProgress = {},\n  subjects: string[] = []\n): { paths: { [subject: string]: SyllabusObjective[] }, warnings: string[] } {\n  const warnings: string[] = [];\n\n  // Group by subject and remove duplicates\n  const bySubject = groupObjectivesBySubject(objectives);\n\n  // Filter by requested subjects\n  const { filteredSubjects, warnings: filterWarnings } = filterSubjects(bySubject, subjects);\n  warnings.push(...filterWarnings);\n\n  // Generate path for each subject\n  const paths: { [subject: string]: SyllabusObjective[] } = {};\n\n  for (const subject of filteredSubjects) {\n    const subjectObjectives = bySubject[subject];\n\n    // Group by difficulty\n    const byDifficulty: { [difficulty: string]: SyllabusObjective[] } = {};\n    for (const obj of subjectObjectives) {\n      // Default difficulty to 5 if not specified\n      const difficulty = obj.difficulty ?? 5;\n      const key = difficulty.toString();\n      if (!byDifficulty[key]) {\n        byDifficulty[key] = [];\n      }\n      byDifficulty[key].push(obj);\n    }\n\n    // Sort difficulties (easier to harder)\n    const sortedDifficulties = Object.keys(byDifficulty)\n      .map(d => parseInt(d))\n      .sort((a, b) => a - b);\n\n    // Build path for this subject\n    const path: SyllabusObjective[] = [];\n\n    for (const difficulty of sortedDifficulties) {\n      const group = byDifficulty[difficulty.toString()];\n\n      // Sort within difficulty group for optimal learning\n      const sortedGroup = sortObjectivesForLearning(group, userProgress);\n\n      // Add all objectives from this difficulty level\n      path.push(...sortedGroup);\n    }\n\n    paths[subject] = path;\n  }\n\n  return { paths, warnings };\n}\n\n/**\n * Loads syllabus data from file\n */\nfunction loadSyllabusData(): SyllabusObjective[] {\n  try {\n    if (!fs.existsSync(SYLLABUS_FILE_PATH)) {\n      console.error('Syllabus file not found at:', SYLLABUS_FILE_PATH);\n      throw new Error('Syllabus data not found');\n    }\n\n    const fileContents = fs.readFileSync(SYLLABUS_FILE_PATH, 'utf8');\n\n    if (!fileContents || fileContents.trim().length === 0) {\n      console.error('Syllabus file is empty');\n      throw new Error('Syllabus data is empty');\n    }\n\n    const parsed = JSON.parse(fileContents);\n\n    if (!Array.isArray(parsed)) {\n      console.error('Syllabus data is not an array, got:', typeof parsed);\n      throw new Error('Invalid syllabus format');\n    }\n\n    console.log(`Loaded ${parsed.length} syllabus objectives`);\n    return parsed;\n  } catch (error: any) {\n    console.error('Error loading syllabus data:', {\n      message: error.message,\n      path: SYLLABUS_FILE_PATH,\n      stack: error.stack\n    });\n    throw error;\n  }\n}\n\n/**\n * Load objective IDs from pre-computed cache file\n * This eliminates ~2000 Firebase reads per request\n * Cache file generated by: npx tsx scripts/cache-objective-ids.ts\n */\nfunction getObjectiveIdsWithQuestions(): Set<string> {\n  const now = Date.now();\n\n  // Return cached data if still fresh\n  if (objectiveIdsCacheData && (now - objectiveIdsCacheData.timestamp) < OBJECTIVE_CACHE_FILE_TTL) {\n    return new Set(objectiveIdsCacheData.ids);\n  }\n\n  try {\n    const cachePath = path.join(process.cwd(), 'data', 'objective-ids-cache.json');\n    if (fs.existsSync(cachePath)) {\n      const rawData = fs.readFileSync(cachePath, 'utf8');\n      const parsed = JSON.parse(rawData);\n\n      if (Array.isArray(parsed.ids)) {\n        objectiveIdsCacheData = { ids: parsed.ids, timestamp: now };\n        return new Set(parsed.ids);\n      }\n    }\n  } catch (error) {\n    console.warn('Failed to load objective IDs cache:', error);\n  }\n\n  // Return empty set if cache unavailable (filtering will be skipped)\n  return new Set();\n}\n\n// ============================================================================\n// API ROUTES\n// ============================================================================\nimport { verifyAuth } from '@/lib/auth-server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { NextRequest } from 'next/server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 10, 60000, 'learning-path:POST');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    console.log('[Learning Path POST] Starting request');\n\n    // Auth is optional - learning paths use public syllabus data\n    try {\n      await verifyAuth(request);\n      console.log('[Learning Path POST] Auth successful');\n    } catch (authError) {\n      // Allow unauthenticated access for signup flow\n      console.log('[Learning Path POST] Auth skipped (allowed)');\n    }\n\n    console.log('[Learning Path POST] Parsing body');\n    const body = await request.json();\n    console.log('[Learning Path POST] Body parsed:', { subjects: body?.subjects?.length || 0 });\n\n    const { subjects, userProgress } = validateInput(body);\n\n    let userId: string | null = null;\n    try {\n      const decoded = await verifyAuth(request);\n      userId = decoded.uid;\n    } catch (e) {\n      // Optional auth: User ID is null if not authenticated\n    }\n\n    if (userId) {\n      try {\n        const progressSnap = await adminDb.collection('users').doc(userId).collection('progress').get();\n        progressSnap.forEach(doc => {\n          const data = doc.data();\n          userProgress[doc.id] = {\n            mastery: typeof data.mastery === 'number' ? data.mastery : 0,\n            attempts: typeof data.attempts === 'number' ? data.attempts : 0,\n            lastAttempt: data.lastAttempt || '',\n            stability: data.stability || 0\n          };\n        });\n        console.log(`[Learning Path POST] Hydrated ${progressSnap.size} progress records for ${userId}`);\n      } catch (err) {\n        console.error('[Learning Path POST] Failed to fetch user progress:', err);\n      }\n    }\n\n    console.log('[Learning Path POST] Input validated:', { subjectsCount: subjects.length });\n\n    console.log('[Learning Path POST] Loading syllabus data');\n    const allObjectives = loadSyllabusData();\n    console.log('[Learning Path POST] Syllabus loaded:', allObjectives.length);\n\n    // Generate paths separated by subject\n    console.log('[Learning Path POST] Generating learning paths');\n    const { paths, warnings } = generateLearningPath(allObjectives, userProgress, subjects);\n    console.log('[Learning Path POST] Paths generated:', Object.keys(paths).length);\n\n    const objectiveIdsWithQuestions = getObjectiveIdsWithQuestions();\n    console.log('[Learning Path POST] Objective IDs loaded:', objectiveIdsWithQuestions.size);\n\n    // Limit each subject to max objectives\n    const limitedPaths: { [subject: string]: SyllabusObjective[] } = {};\n    for (const [subject, path] of Object.entries(paths)) {\n      // Only filter if THIS subject has questions. \n      // This prevents hiding syllabus for subjects that are WIP (like POA) when others (Chem) have many questions.\n      const subjectMatchCount = path.filter(o => objectiveIdsWithQuestions.has(o.id)).length;\n      const isLive = subjectMatchCount >= 5; // Threshold to consider subject \"live\"\n\n      const filtered = isLive\n        ? path.filter((o) => objectiveIdsWithQuestions.has(o.id))\n        : path;\n      limitedPaths[subject] = filtered.slice(0, MAX_OBJECTIVES_PER_SUBJECT);\n    }\n\n    const response: LearningPathResponse = {\n      paths: limitedPaths,\n      subjects: Object.keys(limitedPaths),\n      total: Object.values(limitedPaths).reduce((sum, path) => sum + path.length, 0)\n    };\n\n    if (warnings.length > 0) {\n      response.warnings = warnings;\n    }\n\n    console.log('[Learning Path POST] Success:', { subjects: response.subjects.length, total: response.total });\n    return NextResponse.json(response);\n  } catch (error: any) {\n    // Detailed error logging for debugging\n    console.error('[Learning Path POST] Error:', {\n      message: error.message,\n      stack: error.stack,\n      name: error.name\n    });\n\n    if (error instanceof Error && (error.message.includes('Unauthorized') || error.name === 'AuthError')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    const isNotFound = error instanceof Error && error.message === 'Syllabus data not found';\n    return NextResponse.json({\n      error: isNotFound ? 'Syllabus data not found' : 'Failed to generate learning path',\n      details: process.env.NODE_ENV === 'development' ? error.message : undefined\n    }, { status: isNotFound ? 404 : 500 });\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'learning-path:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    // Auth is optional - learning paths use public syllabus data\n    try {\n      await verifyAuth(request);\n    } catch (authError) {\n      // Allow unauthenticated access\n      console.log('Learning path GET accessed without auth (allowed)');\n    }\n\n    const { searchParams } = new URL(request.url);\n\n    const subjectsParam = searchParams.get('subjects');\n    const subjects = subjectsParam\n      ? subjectsParam.split(',').map(s => s.trim()).filter(Boolean)\n      : [];\n\n    // Check cache\n    const cacheKey = subjects.sort().join(',');\n    const cached = pathCache.get(cacheKey);\n    if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n      return NextResponse.json(cached.data);\n    }\n\n    const allObjectives = loadSyllabusData();\n\n    // Fetch userProgress from database based on user session\n    const userProgress: UserProgress = {};\n\n    let userId: string | null = null;\n    try {\n      const decoded = await verifyAuth(request);\n      userId = decoded.uid;\n    } catch (e) {\n      // Optional auth\n    }\n\n    if (userId) {\n      try {\n        const progressSnap = await adminDb.collection('users').doc(userId).collection('progress').get();\n        progressSnap.forEach(doc => {\n          const data = doc.data();\n          userProgress[doc.id] = {\n            mastery: typeof data.mastery === 'number' ? data.mastery : 0,\n            attempts: typeof data.attempts === 'number' ? data.attempts : 0,\n            lastAttempt: data.lastAttempt || '',\n            stability: data.stability || 0\n          };\n        });\n        console.log(`[Learning Path GET] Hydrated ${progressSnap.size} progress records for ${userId}`);\n      } catch (err) {\n        console.error('[Learning Path GET] Failed to fetch user progress:', err);\n      }\n    }\n\n    // Generate paths separated by subject\n    const { paths, warnings } = generateLearningPath(allObjectives, userProgress, subjects);\n\n    const objectiveIdsWithQuestions = getObjectiveIdsWithQuestions();\n\n    // Limit each subject to max objectives\n    const limitedPaths: { [subject: string]: SyllabusObjective[] } = {};\n    for (const [subject, path] of Object.entries(paths)) {\n      // Only filter if THIS subject has questions.\n      const subjectMatchCount = path.filter(o => objectiveIdsWithQuestions.has(o.id)).length;\n      const isLive = subjectMatchCount >= 5; // Threshold to consider subject \"live\"\n\n      const filtered = isLive\n        ? path.filter((o) => objectiveIdsWithQuestions.has(o.id))\n        : path;\n      limitedPaths[subject] = filtered.slice(0, MAX_OBJECTIVES_PER_SUBJECT);\n    }\n\n    const response: LearningPathResponse = {\n      paths: limitedPaths,\n      subjects: Object.keys(limitedPaths),\n      total: Object.values(limitedPaths).reduce((sum, path) => sum + path.length, 0)\n    };\n\n    if (warnings.length > 0) {\n      response.warnings = warnings;\n    }\n\n    // Cache the response\n    pathCache.set(cacheKey, { data: response, timestamp: Date.now() });\n\n    return NextResponse.json(response);\n  } catch (error: any) {\n    console.error('Learning Path GET Error:', error);\n    if (error.message?.includes('Unauthorized') || (error as any).name === 'AuthError') {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    const isNotFound = error instanceof Error && error.message === 'Syllabus data not found';\n    return NextResponse.json({ error: isNotFound ? 'Syllabus data not found' : 'Failed to generate learning path' }, { status: isNotFound ? 404 : 500 });\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/metadata/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'proficiencies' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":33,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":48},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":36,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":36,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1288,1487],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1819,1822],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1819,1822],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { verifyAuth } from '@/lib/auth-server'\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit'\nimport { z } from 'zod'\n\nconst MetadataSchema = z.object({\n    subjects: z.array(z.string().min(1).max(100)).max(20).optional(),\n    source: z.string().min(1).max(200).optional(),\n    proficiencies: z.record(z.string(), z.string()).optional(),\n    timestamp: z.string().max(50).optional(),\n})\n\nexport async function POST(request: NextRequest) {\n    try {\n        // Rate limit: 10 requests per minute per IP\n        const limiter = rateLimit(request, 10, 60000)\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!)\n\n        // Require authentication\n        const decodedToken = await verifyAuth(request)\n        const userId = decodedToken.uid\n\n        const body = await request.json()\n        const result = MetadataSchema.safeParse(body)\n\n        if (!result.success) {\n            return NextResponse.json(\n                { error: 'Invalid data', details: result.error.format() },\n                { status: 400 }\n            )\n        }\n\n        const { subjects, source, proficiencies, timestamp } = result.data\n\n        // Log metadata (in production, you might store this differently)\n        console.log(`[Metadata] User ${userId} saved preferences:`, {\n            subjects: subjects?.length || 0,\n            source,\n            timestamp: timestamp || new Date().toISOString(),\n        })\n\n        // Instead of writing to filesystem (security risk), we just acknowledge receipt\n        // In production, this could be stored in Firestore under the user's document\n        return NextResponse.json({\n            success: true,\n            message: 'Metadata received',\n            userId,\n        })\n    } catch (error: any) {\n        if (error.message?.includes('Unauthorized')) {\n            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n        }\n        console.error('Metadata API error:', error)\n        return NextResponse.json(\n            { error: 'Failed to save metadata' },\n            { status: 500 }\n        )\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/nable/evaluate/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getDayKey' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getDayKey"},"fix":{"range":[577,588],"text":""},"desc":"Remove unused variable \"getDayKey\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":115,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":118,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6954,6957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6954,6957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":207,"column":110,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":113,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9068,9071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9068,9071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":218,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9748,9751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9748,9751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":293,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":293,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12700,12703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12700,12703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { z } from 'zod';\nimport * as admin from 'firebase-admin';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport {\n    evaluate,\n    loadState,\n    NABLEState,\n    createInitialState,\n    NABLEEvaluateRequest\n} from '@/lib/nable';\nimport { GlobalIntelligence } from '@/lib/nable/global-intelligence';\nimport { createInitialSubSkillScore } from '@/lib/nable/mastery-tracker';\nimport { calculateXPUpdate, getDayKey } from '@/lib/xp-utils';\n\nfunction dayKeyUTC(d: Date) {\n    const y = d.getUTCFullYear();\n    const m = String(d.getUTCMonth() + 1).padStart(2, '0');\n    const day = String(d.getUTCDate()).padStart(2, '0');\n    return `${y}-${m}-${day}`;\n}\n\nfunction isWithinRollingWindowUTC(dayKey: string, today: Date, windowDays: number) {\n    const [y, m, d] = dayKey.split('-').map((n) => Number(n));\n    if (!y || !m || !d) return false;\n    const dayDate = new Date(Date.UTC(y, m - 1, d));\n    const todayDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));\n    const diffDays = (todayDate.getTime() - dayDate.getTime()) / (1000 * 60 * 60 * 24);\n    return diffDays >= 0 && diffDays < windowDays;\n}\n\nconst EvaluateSchema = z.object({\n    questionId: z.string(),\n    objectiveId: z.string(),\n    selectedAnswer: z.number(),\n    options: z.array(z.string()).optional().default([]),\n    timeToAnswer: z.number().optional().default(5),\n    subSkills: z.array(z.string()).optional().default([]),\n    questionDifficulty: z.number().optional().default(5)\n});\n\nexport async function POST(request: NextRequest) {\n    try {\n        // 1. Rate Limit Check\n        const limiter = rateLimit(request, 20, 60000);\n        if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n        // 2. Strict Auth Verification\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n        const body = await request.json();\n\n        // 3. Validation\n        const result = EvaluateSchema.safeParse(body);\n        if (!result.success) {\n            return NextResponse.json({ error: 'Invalid data', details: result.error }, { status: 400 });\n        }\n\n        const {\n            questionId,\n            objectiveId,\n            selectedAnswer,\n            options,\n            timeToAnswer,\n            subSkills,\n            questionDifficulty\n        } = result.data;\n\n        // 4. Load NABLE State PROTECTED (Ignore client-sent state)\n        const nableRef = adminDb.collection('users').doc(userId).collection('nable').doc('state');\n        const nableDoc = await nableRef.get();\n        let nableState: NABLEState;\n\n        if (nableDoc.exists) {\n            nableState = loadState(userId, nableDoc.data() as Partial<NABLEState>);\n        } else {\n            nableState = createInitialState(userId);\n        }\n\n        // 5. Fetch Question Truth from DB (Prevent CorrectAnswer Injection)\n        const questionDoc = await adminDb.collection('questions').doc(questionId).get();\n        if (!questionDoc.exists) {\n            return NextResponse.json({ error: 'Question not found in database' }, { status: 404 });\n        }\n        const questionData = questionDoc.data()!;\n        const realCorrectAnswer = questionData.correctAnswer;\n        const realSubSkills = questionData.subSkills || subSkills || [];\n\n        // 6. Evaluate with NABLE Engine (Using REAL correctness)\n        const isCorrect = selectedAnswer === realCorrectAnswer;\n\n        // Ensure subSkills has at least the objectiveId\n        const activeSubSkills = realSubSkills.length > 0 ? realSubSkills : [objectiveId];\n\n        // Pre-fill missing Sub-Skills with Global Intelligence Priors\n        const missingSkills = activeSubSkills.filter((id: string) => !nableState.knowledgeGraph[id]);\n        if (missingSkills.length > 0) {\n            for (const skillId of missingSkills) {\n                const prior = await GlobalIntelligence.getPriorMastery(skillId);\n                nableState.knowledgeGraph[skillId] = createInitialSubSkillScore(prior);\n            }\n        }\n\n        const nableRequest: NABLEEvaluateRequest = {\n            userId,\n            questionId,\n            objectiveId,\n            selectedAnswer,\n            correctAnswer: realCorrectAnswer,\n            options,\n            timeToAnswer,\n            subSkills: activeSubSkills,\n            questionDifficulty: questionData.difficultyWeight || questionDifficulty\n        };\n\n        const { response: nableResponse, newState: newNableState, learningEvent } = evaluate(\n            nableState,\n            nableRequest\n        );\n\n        // Emit Learning Event to Global Brain (Fire & Forget to avoid latency)\n        GlobalIntelligence.emitLearningEvent(learningEvent).catch(err =>\n            console.error(\"Global Intelligence Emit Failed:\", err)\n        );\n\n        // 6. Atomic Persistence (NABLE State + Legacy Stats)\n        const userRef = adminDb.collection('users').doc(userId);\n\n        let responseProgress: { objectiveId: string; stars: number; completed: boolean } | null = null;\n\n        await adminDb.runTransaction(async (transaction) => {\n            const userDoc = await transaction.get(userRef);\n            if (!userDoc.exists) throw new Error(\"User not found\");\n            const userData = userDoc.data() || {};\n\n            const now = new Date();\n            const todayKey = dayKeyUTC(now);\n\n            // A. Save NABLE State\n            transaction.set(nableRef, newNableState);\n\n            // B. Map NABLE Mastery to Stars (Strict)\n            // 3 stars: mastery > 0.8 AND confidence > 0.6\n            // 2 stars: mastery > 0.6 AND confidence > 0.4\n            // 1 star: mastery > 0.3\n            // 0 stars: default\n\n            const currentProgress = userData.progress || {};\n            const objProgress = currentProgress[objectiveId] || { stars: 0 };\n\n            const prevMasteryMap = (userData.mastery && typeof userData.mastery === 'object') ? userData.mastery : {};\n            const prevObjMasteryRaw = prevMasteryMap?.[objectiveId];\n            const prevObjMastery = typeof prevObjMasteryRaw === 'number' ? prevObjMasteryRaw : 0.2;\n\n            const baseGain = 0.08;\n            const adaptiveGain = baseGain * (1 - Math.max(0, Math.min(1, prevObjMastery)));\n            const masteryFloor = 0.2;\n            const masteryDelta = isCorrect ? adaptiveGain : -0.5 * adaptiveGain;\n            const nextObjMastery = Math.max(masteryFloor, Math.min(1, prevObjMastery + masteryDelta));\n\n            const objMastery = nextObjMastery;\n            const objConfidence = newNableState.knowledgeGraph[objectiveId]?.confidence || 0;\n\n            if (!newNableState.knowledgeGraph[objectiveId]) {\n                newNableState.knowledgeGraph[objectiveId] = { mastery: objMastery, confidence: objConfidence } as any;\n            } else {\n                newNableState.knowledgeGraph[objectiveId].mastery = objMastery;\n            }\n\n            // Calculate potential new stars based on mastery\n            let calculatedStars = 0;\n            if (objMastery >= 0.8 && objConfidence >= 0.6) calculatedStars = 3;\n            else if (objMastery >= 0.6 && objConfidence >= 0.4) calculatedStars = 2;\n            else if (objMastery >= 0.3) calculatedStars = 1;\n\n            // STARS (Unlock mechanic): increment by 1 per correct answer (max 3)\n            // This matches the client UX and guarantees objectives unlock reliably.\n            const prevStars = typeof objProgress.stars === 'number' ? objProgress.stars : 0;\n            const earnedThisAttempt = isCorrect ? 1 : 0;\n            const starsByAttempts = Math.min(3, prevStars + earnedThisAttempt);\n\n            // Keep mastery-based stars as a floor (optional), but never decrease.\n            const newStars = Math.max(prevStars, calculatedStars, starsByAttempts);\n\n            responseProgress = {\n                objectiveId,\n                stars: newStars,\n                completed: newStars >= 3\n            };\n\n            // Rewards - Base XP for correct (50), Incorrect (10), Star Bonus (100)\n            // Updated to meet user request of 50-100 XP per question\n            const starIncrease = Math.max(0, newStars - (objProgress.stars || 0));\n            const rawXpGain = (isCorrect ? 50 : 10) + (starIncrease * 50);\n\n            const xpUpdate = calculateXPUpdate(userData, rawXpGain, todayKey);\n            const xpGain = xpUpdate.xpGain;\n            const bCoinGain = isCorrect ? 10 : 0;\n\n            const prevStreak = typeof userData.streak === 'number' ? userData.streak : 0;\n            const lastStreakDay = typeof userData.lastStreakDay === 'string' ? userData.lastStreakDay : '';\n            const shouldIncrementStreak = lastStreakDay !== todayKey;\n            const nextStreak = shouldIncrementStreak ? prevStreak + 1 : prevStreak;\n\n            const prevActiveDays30 = Array.isArray(userData.activeDays30) ? userData.activeDays30.filter((v: any) => typeof v === 'string') : [];\n            const nextActiveDays30 = Array.from(new Set([...prevActiveDays30, todayKey]))\n                .filter((k) => isWithinRollingWindowUTC(k, now, 30))\n                .sort();\n            const consistency = Math.round((nextActiveDays30.length / 30) * 100);\n\n            const nextMasteryMap = { ...prevMasteryMap, [objectiveId]: objMastery };\n            const masteryValues = Object.values(nextMasteryMap).filter((v) => typeof v === 'number') as number[];\n            const globalMastery = masteryValues.length ? masteryValues.reduce((a, b) => a + b, 0) / masteryValues.length : 0;\n\n            // Updates\n            const updates: any = {\n                [`progress.${objectiveId}`]: {\n                    ...objProgress,\n                    stars: newStars,\n                    mastery: objMastery, // Sync NABLE mastery to legacy field\n                    confidence: objConfidence,\n                    lastAttempt: new Date().toISOString(),\n                    completed: newStars >= 3\n                },\n                [`mastery.${objectiveId}`]: objMastery, // Direct access map\n                // ATOMIC UPDATES: Use FieldValue.increment to prevent race conditions\n                ...xpUpdate.updates,\n                bCoins: admin.firestore.FieldValue.increment(bCoinGain),\n                streak: nextStreak,\n                lastStreakDay: shouldIncrementStreak ? todayKey : lastStreakDay,\n                lastLearningDay: todayKey,\n                lastLearningAt: admin.firestore.FieldValue.serverTimestamp(),\n                lastActive: now.toISOString(),\n                activeDays30: nextActiveDays30,\n                consistency,\n                globalMastery,\n                updatedAt: new Date().toISOString()\n            };\n\n            // Enhanced Activity Log for analytics\n            const logRef = userRef.collection('activity_logs').doc();\n            transaction.set(logRef, {\n                type: 'evaluate',\n                objectiveId,\n                questionId,\n                isCorrect,\n                selectedAnswer,\n                correctAnswer: realCorrectAnswer,\n                timeToAnswer,\n                mastery: objMastery,\n                confidence: objConfidence,\n                starsEarned: newStars,\n                xpGained: xpGain,\n                timestamp: admin.firestore.FieldValue.serverTimestamp()\n            });\n\n            // Track attempts so we can avoid immediate repeats.\n            const attemptRef = userRef.collection('question_attempts').doc();\n            transaction.set(attemptRef, {\n                questionId,\n                objectiveId,\n                isCorrect,\n                selectedAnswer,\n                correctAnswer: realCorrectAnswer,\n                timestamp: admin.firestore.FieldValue.serverTimestamp()\n            });\n\n            // Track correct questions so we can permanently exclude them.\n            if (isCorrect) {\n                const correctRef = userRef.collection('correct_questions').doc(questionId);\n                transaction.set(correctRef, {\n                    questionId,\n                    objectiveId,\n                    lastCorrectAt: admin.firestore.FieldValue.serverTimestamp()\n                }, { merge: true });\n            }\n\n            transaction.update(userRef, updates);\n        });\n\n        // 7. Response\n        return NextResponse.json({\n            ...nableResponse,\n            progress: responseProgress || {\n                objectiveId,\n                stars: 0,\n                completed: false\n            }\n        });\n\n    } catch (error: any) {\n        console.error(\"Evaluation Error\");\n        if (error.message?.includes(\"Unauthorized\")) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n        return NextResponse.json({ error: 'Evaluation failed' }, { status: 500 });\n    }\n}","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/nable/recommend/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4066,4069],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4066,4069],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * NABLE Recommend API\n * GET /api/nable/recommend\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { z } from 'zod';\nimport {\n    recommend,\n    loadState,\n    getStatus,\n    createInitialState,\n    type NABLEState,\n    type ContentItem\n} from '@/lib/nable';\n\nexport const dynamic = 'force-dynamic';\n\n// 1. Validation Schema\nconst QuerySchema = z.object({\n    subject: z.string(),\n    exclude: z.string().optional().default(''),\n});\n\nexport async function GET(request: NextRequest) {\n    try {\n        // 2. Auth Check\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        // 3. Parse and Validate Query Params\n        const { searchParams } = new URL(request.url);\n        const query = QuerySchema.safeParse({\n            subject: searchParams.get('subject'),\n            exclude: searchParams.get('exclude'),\n        });\n\n        if (!query.success) {\n            return NextResponse.json({ error: 'Invalid query parameters' }, { status: 400 });\n        }\n\n        const { subject, exclude } = query.data;\n        const excludeIds = exclude ? exclude.split(',') : [];\n\n        // Security check: Users can only request their own recommendations\n        // Removed this check as userId is now derived from auth token\n\n        // 4. Load NABLE State from Firestore\n        const nableRef = adminDb.collection('users').doc(userId).collection('nable').doc('state');\n        const nableDoc = await nableRef.get();\n\n        let state: NABLEState;\n        if (nableDoc.exists) {\n            state = loadState(userId, nableDoc.data() as Partial<NABLEState>);\n        } else {\n            state = createInitialState(userId);\n        }\n\n        // 5. Fetch Question Pool from DB (Instead of Mock)\n        // Optimization: Fetch only questions relevant to the current subject\n        const questionsSnapshot = await adminDb.collection('questions')\n            .where('subjectId', '==', subject)\n            .limit(50) // Fetch a reasonable pool for the engine to pick from\n            .get();\n\n        const questionPool: ContentItem[] = questionsSnapshot.docs.map(doc => {\n            const data = doc.data();\n            return {\n                questionId: doc.id,\n                objectiveId: data.objectiveId,\n                difficultyWeight: data.difficultyWeight ?? data.difficulty ?? 5,\n                subSkills: Array.isArray(data.subSkills) ? data.subSkills : [],\n                contentType: data.contentType || 'standard',\n                distractorSimilarity: data.distractorSimilarity ?? 0.5,\n                expectedTime: data.expectedTime ?? 45\n            };\n        });\n\n        if (questionPool.length === 0) {\n            return NextResponse.json({ error: 'No questions available for this subject' }, { status: 404 });\n        }\n\n        // 6. Execute NABLE Recommendation Logic\n        const { question, refreshFirst, refreshQueue } = recommend(\n            state,\n            { userId, subject, excludeQuestionIds: excludeIds },\n            questionPool\n        );\n\n        // 7. Get Learner Status\n        const status = getStatus(state);\n\n        // 8. Final Response\n        return NextResponse.json({\n            success: true,\n            recommendation: question,\n            refreshFirst,\n            refreshQueueLength: refreshQueue.length,\n            status: {\n                overallMastery: Math.round(status.overallMastery * 100) / 100,\n                overallConfidence: Math.round(status.overallConfidence * 100) / 100,\n                weakestSkills: status.weakestSkills.slice(0, 3),\n                progressionBlocked: status.progressionBlocked,\n                recommendedFocus: status.recommendedFocus\n            },\n            session: {\n                currentStreak: state.currentStreak,\n                questionsAnswered: state.sessionQuestions.length,\n                lastDifficulty: state.lastDifficulty\n            }\n        });\n\n    } catch (error: any) {\n        console.error('NABLE Recommend Error');\n\n        if (error.message?.includes(\"Unauthorized\")) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        return NextResponse.json(\n            { error: 'Failed to get recommendation' },\n            { status: 500 }\n        );\n    }\n}","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/nable/status/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3046,3049],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3046,3049],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * NABLE Status API\n * \n * GET /api/nable/status\n * Get user's NABLE status including mastery, confidence, and recommendations.\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport {\n    loadState,\n    getStatus,\n    checkSessionRefresh,\n    createInitialState,\n    type NABLEState\n} from '@/lib/nable';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { adminDb } from '@/lib/firebase-admin';\n\nexport async function GET(request: NextRequest) {\n    try {\n        const decodedToken = await verifyAuth(request);\n        const userId = decodedToken.uid;\n\n        // We can still support an optional override for admins if needed later, \n        // but for now strict auth is safer.\n        // const { searchParams } = new URL(request.url);\n        // const requestedUser = searchParams.get('userId');\n\n        // Load from Database\n        const nableRef = adminDb.collection('users').doc(userId).collection('nable').doc('state');\n        const nableDoc = await nableRef.get();\n\n        let state: NABLEState;\n        if (nableDoc.exists) {\n            state = loadState(userId, nableDoc.data() as Partial<NABLEState>);\n        } else {\n            state = createInitialState(userId);\n        }\n\n        // Get overall status\n        const status = getStatus(state);\n\n        // Check for refresh needs\n        const refreshCheck = checkSessionRefresh(state.knowledgeGraph, 5);\n\n        // Build skill details\n        const skillDetails = Object.entries(state.knowledgeGraph).map(([id, score]) => ({\n            id,\n            mastery: Math.round(score.mastery * 100),\n            confidence: Math.round(score.confidence * 100),\n            streak: score.streakCount,\n            lastTested: score.lastTested,\n            theoreticalOnly: score.theoreticalOnly,\n            memoryDecay: Math.round(score.memoryDecay * 100)\n        }));\n\n        return NextResponse.json({\n            success: true,\n            overview: {\n                overallMastery: Math.round(status.overallMastery * 100),\n                overallConfidence: Math.round(status.overallConfidence * 100),\n                progressionBlocked: status.progressionBlocked,\n                totalSkillsTracked: Object.keys(state.knowledgeGraph).length\n            },\n            skills: {\n                weakest: status.weakestSkills,\n                strongest: status.strongestSkills,\n                recommendedFocus: status.recommendedFocus,\n                details: skillDetails\n            },\n            spacedRepetition: {\n                skillsNeedingRefresh: refreshCheck.totalDecayedSkills,\n                hasRefreshQuestions: refreshCheck.hasRefreshQuestions,\n                refreshQueueLength: refreshCheck.refreshQueue.length\n            },\n            session: {\n                currentStreak: state.currentStreak,\n                consecutiveErrors: state.consecutiveErrors,\n                questionsAnswered: state.sessionQuestions.length,\n                sessionStarted: state.sessionStarted\n            }\n        });\n\n    } catch (error: any) {\n        if (error.message?.includes('Unauthorized')) {\n            return NextResponse.json({ error: error.message }, { status: 401 });\n        }\n        if (process.env.NODE_ENV === 'development') console.error('NABLE Status Error');\n        return NextResponse.json({ error: 'Failed to get status' }, { status: 500 });\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/profile/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1250,1253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1250,1253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3028,3031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3028,3031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { getOrCreateProfile, parseProfile, updateProfile } from '@/lib/stories-engine';\nimport type { AgeBracket } from '@/lib/stories-engine/types';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\n// Removed DEFAULT_USER - strictly authenticated now\n\nasync function getUserId(request: NextRequest): Promise<string> {\n  const decodedToken = await verifyAuth(request);\n  return decodedToken.uid;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'stories:profile:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const userId = await getUserId(request);\n    const profile = await getOrCreateProfile(userId);\n    const parsed = parseProfile(profile);\n    return NextResponse.json({\n      profile: {\n        userId: profile.userId,\n        ageBracket: profile.ageBracket,\n        skills: parsed.skills,\n        reputation: parsed.reputation,\n        resources: parsed.resources,\n        activeConsequences: parsed.activeConsequences,\n        lastSimulatedAt: profile.lastSimulatedAt?.toISOString() ?? null,\n      },\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] profile GET', e);\n    return NextResponse.json(\n      { error: e instanceof Error ? e.message : 'Failed to get profile' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'stories:profile:PATCH');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const userId = await getUserId(request);\n\n    const body = (await request.json()) as {\n      ageBracket?: AgeBracket;\n      skills?: Record<string, number>;\n      reputation?: Record<string, number>;\n      bCoins?: number;\n      timeUnits?: number;\n      energy?: number;\n    };\n\n    const updates: Parameters<typeof updateProfile>[1] = {};\n    if (body.ageBracket) updates.ageBracket = body.ageBracket;\n    if (body.skills) updates.skills = body.skills;\n    if (body.reputation) updates.reputation = body.reputation;\n    if (body.bCoins !== undefined) updates.bCoins = body.bCoins;\n    if (body.timeUnits !== undefined) updates.timeUnits = body.timeUnits;\n    if (body.energy !== undefined) updates.energy = body.energy;\n\n    await updateProfile(userId, updates);\n    const profile = await getOrCreateProfile(userId);\n    const parsed = parseProfile(profile);\n    return NextResponse.json({\n      profile: {\n        userId: profile.userId,\n        ageBracket: profile.ageBracket,\n        skills: parsed.skills,\n        reputation: parsed.reputation,\n        resources: parsed.resources,\n        activeConsequences: parsed.activeConsequences,\n        lastSimulatedAt: profile.lastSimulatedAt?.toISOString() ?? null,\n      },\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] profile PATCH', e);\n    return NextResponse.json(\n      { error: e instanceof Error ? e.message : 'Failed to update profile' },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/sessions/[id]/decision/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3292,3295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3292,3295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4012,4015],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4012,4015],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport {\n  getSessionById,\n  updateSession,\n  getPlayerProfile,\n  updatePlayerProfile,\n  createConsequence,\n  createDecisionLog,\n} from '@/lib/stories-store';\nimport {\n  resolveChoice,\n  applyResourceDelta,\n} from '@/lib/stories-engine';\nimport { BUSINESS_STORY_SLUG } from '@/lib/stories-engine/simulations/business';\nimport type { BusinessSimState, ConsequenceEffect } from '@/lib/stories-engine/types';\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'stories:decision');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const { id: sessionId } = await params;\n    const body = (await request.json()) as {\n      choiceId: string;\n      payload?: Record<string, unknown>;\n    };\n\n    // const userId = body.userId ?? DEFAULT_USER; // REMOVED insecure fallback\n\n    const { choiceId, payload = {} } = body;\n    if (!choiceId) {\n      return NextResponse.json({ error: 'Missing choiceId' }, { status: 400 });\n    }\n\n    const session = await getSessionById(sessionId);\n    if (!session || session.userId !== userId) {\n      return NextResponse.json({ error: 'Session not found' }, { status: 404 });\n    }\n    if (session.state !== 'active') {\n      return NextResponse.json({ error: 'Session not active' }, { status: 400 });\n    }\n\n    const profile = await getPlayerProfile(userId);\n    const { immediate, delayed } = resolveChoice({\n      choiceId,\n      payload,\n      sessionId,\n      profile: {\n        skills: profile.skills,\n        reputation: profile.reputation,\n      },\n    });\n\n    const snapshot = session.snapshot || {};\n    let resources = snapshot.resources || {\n      bCoins: profile.bCoins,\n      timeUnits: profile.timeUnits,\n      inventory: profile.inventory,\n      energy: profile.energy,\n    };\n    resources = applyResourceDelta(resources, immediate);\n\n    let businessState = session.businessState as BusinessSimState | null;\n\n    if (choiceId === 'business_register' && session.story?.slug === BUSINESS_STORY_SLUG) {\n      const name = (payload.businessName as string) || 'My Business';\n      businessState = {\n        ...(businessState ?? {\n          registrationStatus: 'none',\n          cashBalance: 500,\n          inventory: {},\n          loans: [],\n          taxObligations: [],\n          marketExposure: 0,\n          lastMarketUpdate: new Date().toISOString(),\n        }),\n        registrationStatus: 'pending',\n        registrationSubmittedAt: new Date().toISOString(),\n        businessName: name,\n      };\n    }\n\n    const newSnapshot = { ...snapshot, resources };\n    await updateSession(sessionId, {\n      snapshot: JSON.stringify(newSnapshot),\n      ...(businessState && { businessState: JSON.stringify(businessState) }),\n    });\n\n    // Create Decision Log\n    const decisionId = await createDecisionLog({\n      sessionId,\n      choiceId,\n      payload,\n      resolved: true\n    });\n\n    // Persist delayed consequences\n    for (const c of (delayed as any[])) {\n      const scheduledAt = new Date(Date.now() + (c.delayMinutes || 0) * 60000).toISOString();\n      await createConsequence({\n        decisionId,\n        sessionId,\n        type: 'delayed',\n        scheduledAt,\n        ruleId: c.ruleId,\n        effects: c.effects,\n      });\n    }\n\n    await updatePlayerProfile(userId, {\n      bCoins: resources.bCoins,\n      timeUnits: resources.timeUnits,\n      energy: resources.energy,\n      inventory: JSON.stringify(resources.inventory),\n    });\n\n    return NextResponse.json({\n      choiceId,\n      immediate: immediate as ConsequenceEffect[],\n      delayedCount: delayed.length,\n      resources,\n      businessState,\n      snapshot: newSnapshot,\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] decision POST', e);\n    return NextResponse.json(\n      { error: e instanceof Error ? e.message : 'Failed to process decision' },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/sessions/[id]/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getDayKey' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getDayKey"},"fix":{"range":[445,456],"text":""},"desc":"Remove unused variable \"getDayKey\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2402,2405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2402,2405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3145,3148],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3145,3148],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3360,3363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3360,3363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":138,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4750,4753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4750,4753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport { getSessionById, updateSession } from '@/lib/stories-store';\nimport {\n  tickRegistration,\n  registrationRemainingMinutes,\n  marketFluctuation,\n} from '@/lib/stories-engine/simulations/business';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { calculateXPUpdate, getDayKey } from '@/lib/xp-utils';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'stories:session:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const { id } = await params;\n    const session = await getSessionById(id);\n\n    if (!session || session.userId !== userId) {\n      return NextResponse.json({ error: 'Session not found' }, { status: 404 });\n    }\n\n    const config = session.story?.config ?? {};\n    let businessState = session.businessState;\n    const now = new Date();\n\n    if (businessState && session.story?.slug === 'business-financial-literacy') {\n      businessState = tickRegistration(businessState, config, now);\n\n      if (session.state === 'active' && businessState.lastMarketUpdate) {\n        const exposure = businessState.marketExposure ?? 0;\n        const delta = marketFluctuation(exposure);\n        businessState = {\n          ...businessState,\n          cashBalance: Math.max(0, businessState.cashBalance + delta),\n          lastMarketUpdate: now.toISOString(),\n        };\n      }\n\n      await updateSession(id, {\n        businessState: JSON.stringify(businessState),\n        lastPlayedAt: now.toISOString(),\n      });\n    }\n\n    return NextResponse.json({\n      session: {\n        ...session,\n        businessState,\n        startedAt: new Date(session.startedAt).toISOString(),\n        lastPlayedAt: new Date(session.lastPlayedAt).toISOString(),\n        completedAt: session.completedAt ? new Date(session.completedAt).toISOString() : null,\n        registrationRemainingMinutes:\n          businessState && session.story?.slug === 'business-financial-literacy'\n            ? registrationRemainingMinutes(businessState, config, now)\n            : null,\n      },\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] session GET', e);\n    return NextResponse.json({ error: 'Failed to get session' }, { status: 500 });\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'stories:session:PATCH');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const { id } = await params;\n    const body = (await request.json()) as {\n      state?: string;\n      businessState?: any;\n    };\n\n    const session = await getSessionById(id);\n    if (!session || session.userId !== userId) {\n      return NextResponse.json({ error: 'Session not found' }, { status: 404 });\n    }\n\n    const updates: any = {};\n    if (body.state) {\n      updates.state = body.state;\n      if (body.state === 'completed' || body.state === 'failed') {\n        updates.completedAt = new Date().toISOString();\n\n        // Award XP for practical completion\n        if (body.state === 'completed') {\n          try {\n            const userRef = adminDb.collection('users').doc(userId);\n            const userSnap = await userRef.get();\n            const userData = userSnap.data() || {};\n\n            // Significant reward for practical completion: 150 raw points -> ~75 points after modifier\n            const rawXpGain = 150;\n            const xpUpdate = calculateXPUpdate(userData, rawXpGain);\n\n            // Use FieldValue.increment for atomic updates\n            await userRef.update(xpUpdate.updates);\n          } catch (error) {\n            console.error('[XP Reward] Failed to award practical XP:', error);\n          }\n        }\n      }\n    }\n    if (body.businessState) {\n      updates.businessState = JSON.stringify(body.businessState);\n    }\n\n    await updateSession(id, updates);\n    const updated = await getSessionById(id);\n\n    return NextResponse.json({\n      session: {\n        id: updated.id,\n        state: updated.state,\n        businessState: updated.businessState,\n        completedAt: updated.completedAt ? new Date(updated.completedAt).toISOString() : null,\n      },\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] session PATCH', e);\n    return NextResponse.json({ error: 'Failed to update session' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/sessions/[id]/tick/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2239,2242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2239,2242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport {\n  getSessionById,\n  updateSession,\n  getDueConsequences,\n  updateConsequence,\n  getPlayerProfile,\n  updatePlayerProfile\n} from '@/lib/stories-store';\nimport {\n  applyResourceDelta,\n} from '@/lib/stories-engine';\nimport type { ConsequenceEffect } from '@/lib/stories-engine/types';\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const limiter = rateLimit(request, 180, 60000, 'stories:tick');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const { id: sessionId } = await params;\n\n    // We don't trust body userId anymore, we use the token's userId\n    // const body = (await request.json()) as { userId?: string };\n\n    const session = await getSessionById(sessionId);\n    if (!session || session.userId !== userId) {\n      return NextResponse.json({ error: 'Session not found' }, { status: 404 });\n    }\n\n    const now = new Date().toISOString();\n    const due = await getDueConsequences(sessionId);\n\n    const profile = await getPlayerProfile(userId);\n    const snapshot = session.snapshot || {};\n    let resources = snapshot.resources ?? {\n      bCoins: profile.bCoins,\n      timeUnits: profile.timeUnits,\n      energy: profile.energy,\n      inventory: profile.inventory,\n    };\n\n    for (const c of due) {\n      const effects = c.effects as ConsequenceEffect[];\n      resources = applyResourceDelta(resources, effects);\n      await updateConsequence(c.id, { appliedAt: now });\n    }\n\n    const newSnapshot = { ...snapshot, resources };\n    await updateSession(sessionId, {\n      snapshot: JSON.stringify(newSnapshot),\n      lastPlayedAt: now\n    });\n\n    await updatePlayerProfile(userId, {\n      bCoins: resources.bCoins,\n      timeUnits: resources.timeUnits,\n      energy: resources.energy,\n      inventory: resources.inventory,\n    });\n\n    return NextResponse.json({\n      applied: due.length,\n      resources,\n      snapshot: newSnapshot,\n    });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] tick POST', e);\n    return NextResponse.json(\n      { error: e instanceof Error ? e.message : 'Failed to tick' },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/sessions/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1107,1110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1107,1110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3125,3128],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3125,3128],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3212,3215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3212,3215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\nimport {\n  getSessions,\n  createSession,\n  ensureDefaultStory,\n  getStoryBySlug,\n  getPlayerProfile,\n  updatePlayerProfile\n} from '@/lib/stories-store';\nimport {\n  INITIAL_BUSINESS_STATE,\n  BUSINESS_STORY_SLUG,\n} from '@/lib/stories-engine/simulations/business';\nimport type { DifficultyContext, AgeBracket } from '@/lib/stories-engine/types';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'stories:sessions:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const { searchParams } = new URL(request.url);\n    const storyId = searchParams.get('storyId') ?? undefined;\n    const state = searchParams.get('state') ?? undefined;\n\n    const sessions = await getSessions(userId, { storyId, state });\n\n    return NextResponse.json({ sessions });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] sessions GET', e);\n    return NextResponse.json({ error: 'Failed to list sessions' }, { status: 500 });\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 15, 60000, 'stories:sessions:POST');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    await ensureDefaultStory();\n    const body = (await request.json()) as {\n      storySlug?: string;\n      storyId?: string;\n      ageBracket?: AgeBracket;\n    };\n    const storySlug = body.storySlug ?? BUSINESS_STORY_SLUG;\n\n    const story = await getStoryBySlug(storySlug);\n    if (!story) {\n      return NextResponse.json(\n        { error: `Story not found: ${storySlug}` },\n        { status: 404 }\n      );\n    }\n\n    const profile = await getPlayerProfile(userId);\n    const difficultyContext: DifficultyContext = {\n      ageBracket: (body.ageBracket ?? profile.ageBracket) as AgeBracket,\n      skillLevel: profile.skills.financialLiteracy ?? 50,\n      riskAppetite: 50,\n    };\n\n    const snapshot = {\n      resources: {\n        bCoins: profile.bCoins,\n        timeUnits: profile.timeUnits,\n        inventory: profile.inventory,\n        energy: profile.energy,\n      },\n      reputation: profile.reputation,\n    };\n    const businessState =\n      story.slug === BUSINESS_STORY_SLUG ? INITIAL_BUSINESS_STATE : undefined;\n\n    const sessionId = await createSession({\n      userId,\n      storyId: story.id,\n      state: 'active',\n      snapshot,\n      businessState,\n      difficultyContext,\n    });\n\n    // Mock updateLastSimulated\n    await updatePlayerProfile(userId, { lastSimulatedAt: new Date().toISOString() });\n\n    const sessions = await getSessions(userId, { storyId: story.id, state: 'active' });\n    const session = sessions.find((s: any) => s.id === sessionId);\n\n    return NextResponse.json({ session });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] sessions POST', e);\n    return NextResponse.json({ error: 'Failed to create session' }, { status: 500 });\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/practicals/stories/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[443,446],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[443,446],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { getAllStories, ensureDefaultStory } from '@/lib/stories-store';\nimport { verifyAuth } from '@/lib/auth-server';\n\n export const dynamic = 'force-dynamic';\n\nexport async function GET(request: NextRequest) {\n  try {\n    await verifyAuth(request);\n\n    await ensureDefaultStory();\n    const stories = await getAllStories();\n    return NextResponse.json({ stories });\n  } catch (e: any) {\n    if (e.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: e.message }, { status: 401 });\n    }\n    console.error('[stories] stories GET error:', e);\n    return NextResponse.json({ error: 'Failed to list stories' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/progress/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1095,1098],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1095,1098],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1120,1123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1120,1123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2225,2228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2225,2228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2250,2253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2250,2253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'progress:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decoded = await verifyAuth(request);\n    const { searchParams } = new URL(request.url);\n\n    const requestedUserId = searchParams.get('userId');\n    const uid = decoded.uid;\n\n    if (requestedUserId && requestedUserId !== uid) {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    const userRef = adminDb.collection('users').doc(uid);\n    const userSnap = await userRef.get();\n    const data = userSnap.exists ? (userSnap.data() || {}) : {};\n\n    return NextResponse.json(\n      {\n        progress: data.progress || {},\n      },\n      {\n        headers: {\n          'Cache-Control': 'no-store',\n        },\n      }\n    );\n  } catch (error: any) {\n    if ((error as any).name === 'AuthError' || error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    return NextResponse.json({ error: 'Failed to load progress' }, { status: 500 });\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 5, 60000, 'progress:DELETE');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decoded = await verifyAuth(request);\n    const { searchParams } = new URL(request.url);\n\n    const requestedUserId = searchParams.get('userId');\n    const uid = decoded.uid;\n\n    if (requestedUserId && requestedUserId !== uid) {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    const userRef = adminDb.collection('users').doc(uid);\n\n    await userRef.set(\n      {\n        progress: {},\n        mastery: {},\n        subjectProgress: {},\n        globalMastery: 0,\n        updatedAt: new Date().toISOString(),\n      },\n      { merge: true }\n    );\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    if ((error as any).name === 'AuthError' || error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    return NextResponse.json({ error: 'Failed to reset progress' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/questions/generate/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/syllabus/clean/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":58,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2560,2563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2560,2563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport fs from 'fs';\nimport path from 'path';\nimport { verifyAuth } from '@/lib/auth-server';\n\nfunction aiCleaningEnabled() {\n  return process.env.ALLOW_LOCAL_AI_CLEANING === 'true';\n}\n\n// Batch clean syllabus content\nexport async function POST(request: NextRequest) {\n  try {\n    await verifyAuth(request);\n\n    const { useAI = false, limit = 100 } = await request.json();\n\n    const filePath = path.join(process.cwd(), 'syllabuses', 'output', 'combined_syllabuses.json');\n\n    if (!fs.existsSync(filePath)) {\n      return NextResponse.json({ error: 'Syllabus file not found' }, { status: 404 });\n    }\n\n    const fileContents = fs.readFileSync(filePath, 'utf8');\n    const objectives = JSON.parse(fileContents);\n\n    const cleaned = [];\n    const toClean = objectives.slice(0, limit);\n\n    for (const obj of toClean) {\n      if (!obj.content || obj.content.trim().length === 0) {\n        cleaned.push({ ...obj, cleanedContent: obj.content });\n        continue;\n      }\n\n      // Check if content needs cleaning\n      const needsCleaning = /(\\d+)x(\\d+)|([a-z])(\\d+)|(\\d+)\\^(\\d+)/.test(obj.content);\n\n      if (needsCleaning) {\n        let cleanedContent = obj.content;\n\n        if (useAI && aiCleaningEnabled()) {\n          try {\n            // Try Ollama API\n            const response = await fetch('http://localhost:11434/api/generate', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({\n                model: 'llama3',\n                prompt: `Fix this mangled PDF text into proper mathematical notation: \"${obj.content}\"\\n\\nCleaned:`,\n                stream: false,\n              }),\n            });\n\n            if (response.ok) {\n              const data = await response.json();\n              cleanedContent = data.response?.trim() || obj.content;\n            }\n          } catch (error) {\n            // Fallback to rule-based\n            cleanedContent = cleanContentFallback(obj.content);\n          }\n        } else {\n          cleanedContent = cleanContentFallback(obj.content);\n        }\n\n        cleaned.push({\n          ...obj,\n          cleanedContent,\n          wasCleaned: true\n        });\n      } else {\n        cleaned.push({\n          ...obj,\n          cleanedContent: obj.content,\n          wasCleaned: false\n        });\n      }\n    }\n\n    return NextResponse.json({\n      cleaned,\n      total: cleaned.length,\n      cleanedCount: cleaned.filter(c => c.wasCleaned).length\n    });\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Error cleaning syllabus:', error);\n    return NextResponse.json(\n      { error: 'Failed to clean syllabus' },\n      { status: 500 }\n    );\n  }\n}\n\nfunction cleanContentFallback(content: string): string {\n  return content\n    .replace(/(\\d+)x(\\d+)/g, (match, base, exp) => {\n      const superscripts: { [key: string]: string } = {\n        '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',\n        '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ'\n      };\n      return `${base}x${superscripts[exp] || exp}`;\n    })\n    .replace(/([a-z])2/g, '$1¬≤')\n    .replace(/([a-z])3/g, '$1¬≥')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/syllabus/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1997,2000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1997,2000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport fs from 'fs';\nimport path from 'path';\nimport { verifyAuth } from '@/lib/auth-server';\n\n export const dynamic = 'force-dynamic';\n\ninterface SyllabusObjective {\n  id: string;\n  section: string;\n  subsection: string;\n  objective: string;\n  content: string;\n  specific_objectives: string[];\n  content_items: string[];\n  difficulty: number;\n  page_number: number;\n  keywords: string[];\n  hash: string;\n  source_file: string;\n  extraction_date: string;\n}\n\nconst mockData: SyllabusObjective[] = [\n  {\n    id: \"OBJ-00001\",\n    objective: \"Algebra Fundamentals\",\n    section: \"Mathematics\",\n    subsection: \"Unknown\",\n    difficulty: 1,\n    content: \"Understanding variables and equations.\",\n    specific_objectives: [],\n    content_items: [],\n    page_number: 1,\n    keywords: [],\n    hash: \"\",\n    source_file: \"Mathematics.pdf\",\n    extraction_date: \"\"\n  }\n];\n\nexport async function GET(request: NextRequest) {\n  try {\n    await verifyAuth(request);\n\n    const { searchParams } = new URL(request.url);\n    const subject = searchParams.get('subject');\n    const difficulty = searchParams.get('difficulty');\n\n    const filePath = path.join(process.cwd(), 'syllabuses', 'output', 'combined_syllabuses.json');\n\n    if (!fs.existsSync(filePath)) {\n      return NextResponse.json(mockData);\n    }\n\n    const fileContents = fs.readFileSync(filePath, 'utf8');\n    let data: SyllabusObjective[] = JSON.parse(fileContents);\n\n    // Filter by subject if provided\n    if (subject) {\n      data = data.filter(obj =>\n        obj.source_file.toLowerCase().includes(subject.toLowerCase()) ||\n        obj.section.toLowerCase().includes(subject.toLowerCase())\n      );\n    }\n\n    // Filter by difficulty if provided\n    if (difficulty) {\n      const diffNum = parseInt(difficulty);\n      data = data.filter(obj => obj.difficulty === diffNum);\n    }\n\n    // Limit results for performance\n    return NextResponse.json(data.slice(0, 1000));\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Error loading syllabus');\n    return NextResponse.json({ error: 'Failed to load syllabus data' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/training/update/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'today' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":42,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3238,3241],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3238,3241],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3882,3885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3882,3885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { db } from '@/lib/firebase';\nimport { doc, getDoc, updateDoc, setDoc, increment, serverTimestamp } from 'firebase/firestore';\nimport { calculateXPGain, getDayKey } from '@/lib/xp-utils';\n\ninterface TrainingUpdate {\n  objectiveId: string;\n  correct: boolean;\n  timeSpent: number; // seconds\n  attempts: number;\n}\n\n// XP Calculation Logic - Reduced values to encourage grinding\nfunction calculateXP(correct: boolean, timeSpent: number, attemptCount: number): number {\n  if (!correct) return 1; // Participation award (effort) (Reduced from 2)\n\n  let baseXP = 8; // Reduced from 15\n\n  // Speed bonus (if under 30s)\n  if (timeSpent < 30) baseXP += 2; // Reduced from 5\n  if (timeSpent < 10) baseXP += 2; // Reduced from 5\n\n  // First try bonus\n  if (attemptCount === 1) baseXP += 5; // Reduced from 10\n\n  return baseXP;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authUser = await verifyAuth(request);\n    const uid = authUser.uid;\n\n    const body: TrainingUpdate = await request.json();\n    const { objectiveId, correct, timeSpent, attempts } = body;\n\n    if (!objectiveId) {\n      return NextResponse.json({ error: 'Objective ID is required' }, { status: 400 });\n    }\n\n    const today = new Date().toISOString().split('T')[0];\n    const userRef = doc(db, 'users', uid);\n    const progressRef = doc(db, 'users', uid, 'progress', objectiveId);\n\n    // 1. Calculate XP Gained\n    const xpGained = calculateXP(correct, timeSpent, attempts);\n\n    // 2. Fetch current Objective Progress\n    const progressSnap = await getDoc(progressRef);\n    const currentData = progressSnap.exists() ? progressSnap.data() : {\n      mastery: 0,\n      attempts: 0,\n      correctCount: 0,\n      streak: 0\n    };\n\n    // 3. Update Objective Stats\n    const newAttempts = (currentData.attempts || 0) + 1;\n    const newCorrect = (currentData.correctCount || 0) + (correct ? 1 : 0);\n    const currentStreak = correct ? (currentData.streak || 0) + 1 : 0; // Objective-specific streak\n\n    // Simple mastery calculation: heavily weighted by recent streak\n    let newMastery = (correct ? (currentData.mastery || 0) + 5 : (currentData.mastery || 0) - 2);\n    newMastery = Math.min(100, Math.max(0, newMastery));\n\n    // 4. Update Mastery Document\n    await setDoc(progressRef, {\n      objectiveId,\n      mastery: newMastery,\n      attempts: newAttempts,\n      correctCount: newCorrect,\n      streak: currentStreak,\n      lastAttempt: serverTimestamp(),\n      updatedAt: serverTimestamp()\n    }, { merge: true });\n\n    // 5. Update User Global Stats (XP, Daily Goal, User Streak)\n    const userSnap = await getDoc(userRef);\n    const userData = userSnap.data() || {};\n    const todayKey = getDayKey();\n\n    // Check for global streak update (if daily goal crossed)\n    const rawXpGained = calculateXP(correct, timeSpent, attempts);\n    const { xpGain, isNewDay } = calculateXPGain(userData, rawXpGained, todayKey);\n    const currentDailyXP = (isNewDay ? 0 : (userData?.xp_today || 0)) + xpGain;\n    const dailyGoal = userData?.dailyGoal || 500;\n\n    // Streak logic handled in daily reset, but we update XP here\n    const updates: any = {\n      xp: increment(xpGain),\n      xp_today: isNewDay ? xpGain : increment(xpGain),\n      lastLearningDay: todayKey,\n      lastLearningAt: serverTimestamp(),\n      lastActive: new Date().toISOString(),\n      // Update local subject progress (denormalized for UI speed)\n      [`subjectProgress.${objectiveId}`]: newMastery\n    };\n\n    await updateDoc(userRef, updates);\n\n    return NextResponse.json({\n      success: true,\n      xpGained,\n      newMastery,\n      dailyProgress: {\n        current: currentDailyXP,\n        goal: dailyGoal,\n        percent: Math.round((currentDailyXP / dailyGoal) * 100)\n      }\n    });\n\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Error updating training:', error);\n    return NextResponse.json(\n      { error: 'Failed to update training' },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/user/profile/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1730,1733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1730,1733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1931,1934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1931,1934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2286,2289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2286,2289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2359,2362],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2359,2362],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2872,2875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2872,2875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3307,3310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3307,3310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { adminDb } from '@/lib/firebase-admin'\nimport { verifyAuth } from '@/lib/auth-server'\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit'\n\nexport const dynamic = 'force-dynamic'\n\nfunction normalizeUsername(input: string) {\n  return input.trim().toLowerCase()\n}\n\nfunction isValidUsername(username: string) {\n  return /^[a-z0-9_]{3,20}$/.test(username)\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 20, 60000, 'user:profile:POST')\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!)\n\n    const decoded = await verifyAuth(request)\n    const uid = decoded.uid\n\n    const body = await request.json().catch(() => ({}))\n    const displayNameRaw = typeof body?.displayName === 'string' ? body.displayName : ''\n    const usernameRaw = typeof body?.username === 'string' ? body.username : ''\n\n    const displayName = displayNameRaw.trim()\n    const username = normalizeUsername(usernameRaw)\n\n    if (displayName && displayName.length < 2) {\n      return NextResponse.json({ error: 'Display name must be at least 2 characters.' }, { status: 400 })\n    }\n\n    if (username && !isValidUsername(username)) {\n      return NextResponse.json(\n        { error: 'Username must be 3-20 chars and only contain letters, numbers, and underscores.' },\n        { status: 400 }\n      )\n    }\n\n    const usersRef = adminDb.collection('users')\n    const usernamesRef = adminDb.collection('usernames')\n\n    const userRef = usersRef.doc(uid)\n\n    const result = await adminDb.runTransaction(async (tx) => {\n      const userSnap = await tx.get(userRef)\n      const userData = userSnap.exists ? (userSnap.data() as any) : {}\n\n      const currentUsername = typeof userData?.username === 'string' ? normalizeUsername(userData.username) : ''\n      const nextUsername = username || currentUsername\n\n      const updates: any = {\n        updatedAt: new Date().toISOString(),\n      }\n\n      if (displayName) updates.displayName = displayName\n\n      if (nextUsername && nextUsername !== currentUsername) {\n        const newRef = usernamesRef.doc(nextUsername)\n        const newSnap = await tx.get(newRef)\n\n        if (newSnap.exists) {\n          const owner = (newSnap.data() as any)?.uid\n          if (owner && owner !== uid) {\n            const err: any = new Error('Username already taken')\n            err.code = 'USERNAME_TAKEN'\n            throw err\n          }\n        }\n\n        tx.set(\n          newRef,\n          {\n            uid,\n            username: nextUsername,\n            updatedAt: new Date().toISOString(),\n          },\n          { merge: true }\n        )\n\n        if (currentUsername) {\n          const oldRef = usernamesRef.doc(currentUsername)\n          const oldSnap = await tx.get(oldRef)\n          if (oldSnap.exists && (oldSnap.data() as any)?.uid === uid) {\n            tx.delete(oldRef)\n          }\n        }\n\n        updates.username = nextUsername\n      }\n\n      tx.set(userRef, updates, { merge: true })\n\n      return {\n        uid,\n        displayName: updates.displayName ?? (userData?.displayName || null),\n        username: updates.username ?? (userData?.username || null),\n      }\n    })\n\n    return NextResponse.json({ ok: true, profile: result })\n  } catch (e: any) {\n    if (e?.code === 'USERNAME_TAKEN') {\n      return NextResponse.json({ error: 'Username already taken' }, { status: 409 })\n    }\n\n    const msg = e?.message || 'Failed to update profile'\n    const status = (e?.name === 'AuthError' || msg.startsWith('Unauthorized')) ? 401 : 500\n    return NextResponse.json({ error: msg }, { status })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/user/stats/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1387,1390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1387,1390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1412,1415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1412,1415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'user:stats:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const { searchParams } = new URL(request.url);\n    const userId = searchParams.get('userId') || decodedToken.uid;\n\n    // Users can only view their own stats unless they're an admin\n    if (userId !== decodedToken.uid) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });\n    }\n\n    const userDoc = await adminDb.collection('users').doc(userId).get();\n\n    if (!userDoc.exists) {\n      return NextResponse.json({ error: 'User not found' }, { status: 404 });\n    }\n\n    const data = userDoc.data() || {};\n\n    return NextResponse.json({\n      stats: {\n        xp_total: data.xp || 0,\n        b_coins_balance: data.bCoins || 0,\n        streak_count: data.streak || 0,\n        mastery_score: data.mastery || 0.1,\n        questions_correct: data.questionsCorrect || 0,\n        questions_wrong: data.questionsWrong || 0\n      }\n    });\n  } catch (error: any) {\n    if ((error as any).name === 'AuthError' || error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    return NextResponse.json({ error: 'Failed to fetch stats' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/api/xp/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateXP' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2022,2025],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2022,2025],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3248,3251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3248,3251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { verifyAuth } from '@/lib/auth-server';\nimport { z } from 'zod';\nimport { rateLimit, handleRateLimit } from '@/lib/rate-limit';\n\n// Request validation schemas\nconst XPUpdateSchema = z.object({\n  objectiveId: z.string().min(1, 'Objective ID is required'),\n  xpEarned: z.number().min(0, 'XP earned must be non-negative'),\n  reason: z.string().min(1, 'Reason is required').max(100, 'Reason must be 100 characters or less')\n});\n\nconst XPQuerySchema = z.object({\n  userId: z.string().optional()\n});\n\n// XP calculation based on performance\nfunction calculateXP(correct: boolean, difficulty: number, timeSpent: number): number {\n  let baseXP = 0;\n\n  if (correct) {\n    // Base XP for correct answer\n    baseXP = 50;\n\n    // Difficulty bonus\n    baseXP += difficulty * 10;\n\n    // Time bonus (faster = more XP, but capped)\n    if (timeSpent < 60) {\n      baseXP += 20; // Quick and correct\n    } else if (timeSpent < 120) {\n      baseXP += 10;\n    }\n  } else {\n    // Partial XP for incorrect (learning still happened)\n    baseXP = 25;\n    baseXP += difficulty * 5;\n  }\n\n  return Math.round(baseXP);\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 30, 60000, 'xp:POST');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    const body = await request.json();\n    const result = XPUpdateSchema.safeParse(body);\n\n    if (!result.success) {\n      return NextResponse.json({ \n        error: 'Invalid request data', \n        details: result.error.format() \n      }, { status: 400 });\n    }\n\n    const { objectiveId, xpEarned, reason } = result.data;\n\n    // In production, this would update database\n    // For now, return the XP calculation\n    return NextResponse.json({\n      userId,\n      objectiveId,\n      xpEarned,\n      reason,\n      timestamp: new Date().toISOString()\n    });\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    console.error('Error updating XP:', error);\n    return NextResponse.json(\n      { error: 'Failed to update XP' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const limiter = rateLimit(request, 60, 60000, 'xp:GET');\n    if (!limiter.success) return handleRateLimit(limiter.retryAfter!);\n\n    const decodedToken = await verifyAuth(request);\n    const userId = decodedToken.uid;\n\n    // Validate query parameters\n    const { searchParams } = new URL(request.url);\n    const queryResult = XPQuerySchema.safeParse({\n      userId: searchParams.get('userId') || undefined\n    });\n\n    if (!queryResult.success) {\n      return NextResponse.json({ \n        error: 'Invalid query parameters', \n        details: queryResult.error.format() \n      }, { status: 400 });\n    }\n\n    // In production, fetch from database\n    // For now, calculate from localStorage data\n    return NextResponse.json({\n      userId,\n      totalXP: 0, // Would calculate from user's progress\n      message: 'XP is tracked per completion'\n    });\n  } catch (error: any) {\n    if (error.message?.includes('Unauthorized')) {\n      return NextResponse.json({ error: error.message }, { status: 401 });\n    }\n    return NextResponse.json(\n      { error: 'Failed to get XP' },\n      { status: 500 }\n    );\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/business/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/community/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[97,114],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2515,2518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2515,2518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2532,2535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2532,2535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'reportUser' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":155,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":155,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":286,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9815,9818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9815,9818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":332,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":332,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11005,11008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11005,11008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13519,13522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13519,13522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":429,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":429,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13759,13762],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13759,13762],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleBlockToggle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":434,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":434,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":443,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":443,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14098,14101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14098,14101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleMuteToggle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":448,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":448,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":457,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":457,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14435,14438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14435,14438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":468,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":468,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14736,14739],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14736,14739],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'bubbleBase' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":670,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":670,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'bubbleCornersMine' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":671,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":671,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'bubbleCornersOther' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":672,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":672,"endColumn":41},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1226,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1226,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[54717,54720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[54717,54720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useEffect, useMemo, useRef, useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport Image from 'next/image'\nimport Link from 'next/link'\nimport { SocialHubProvider, useSocialHub } from '@/lib/social-hub-context'\nimport { useAuth } from '@/lib/auth-context'\nimport { DMWindow } from '@/components/social/DMWindow'\nimport { storage } from '@/lib/firebase'\nimport { getDownloadURL, ref } from 'firebase/storage'\nimport { WhiteboardSession } from '@/components/whiteboard/WhiteboardSession'\nimport { createAvatar } from '@dicebear/core'\nimport { avataaars } from '@dicebear/collection'\n\ntype DistrictId = 'lobby' | 'business' | 'tech' | 'science' | 'exam'\n\ntype DistrictChannel = {\n  id: string\n  name: string\n}\n\ntype District = {\n  id: DistrictId\n  name: string\n  icon: string\n  accent: 'cyan' | 'gold'\n  channels: DistrictChannel[]\n  color: string\n  shadow: string\n}\n\nconst DISTRICTS: District[] = [\n  {\n    id: 'lobby',\n    name: 'The Lobby',\n    icon: 'üè†',\n    accent: 'cyan',\n    channels: [{ id: 'announcements', name: 'announcements' }, { id: 'introductions', name: 'introductions' }],\n    color: '#58CC02', // Duo Green\n    shadow: '#46A302',\n  },\n  {\n    id: 'business',\n    name: 'Business District',\n    icon: 'üíº',\n    accent: 'gold',\n    channels: [{ id: 'pob-help', name: 'pob-help' }, { id: 'poe-help', name: 'poe-help' }, { id: 'accounts-help', name: 'accounts-help' }],\n    color: '#1CB0F6', // Duo Blue\n    shadow: '#1899D6',\n  },\n  {\n    id: 'tech',\n    name: 'Tech Hub',\n    icon: 'üîå',\n    accent: 'cyan',\n    channels: [\n      { id: 'network-help', name: 'network-help' },\n      { id: 'programming-logic', name: 'programming-logic' },\n      { id: 'hardware-repair', name: 'hardware-repair' },\n    ],\n    color: '#CE82FF', // Duo Purple\n    shadow: '#A568CC',\n  },\n  {\n    id: 'science',\n    name: 'Science Lab',\n    icon: 'üß™',\n    accent: 'cyan',\n    channels: [{ id: 'chemistry', name: 'chemistry' }, { id: 'biology', name: 'biology' }, { id: 'physics', name: 'physics' }],\n    color: '#FF9600', // Duo Orange\n    shadow: '#CC7800',\n  },\n  {\n    id: 'exam',\n    name: 'Exam HQ',\n    icon: 'üéì',\n    accent: 'cyan',\n    channels: [{ id: 'past-paper-help', name: 'past-paper-help' }, { id: 'exam-strategy', name: 'exam-strategy' }],\n    color: '#FF4B4B', // Duo Red\n    shadow: '#D33131',\n  },\n]\n\nfunction getRoomId(districtId: string, channelId: string) {\n  return `community_${districtId}_${channelId}`\n}\n\nfunction isSameGroup(prev: any | null, cur: any) {\n  if (!prev) return false\n  if (prev.senderId !== cur.senderId) return false\n  const prevTs = prev.timestamp?.toDate?.() as Date | undefined\n  const curTs = cur.timestamp?.toDate?.() as Date | undefined\n  if (!prevTs || !curTs) return false\n  return curTs.getTime() - prevTs.getTime() < 2 * 60 * 1000\n}\n\nfunction TypingIndicator({ names, className }: { names: string[]; className?: string }) {\n  if (names.length === 0) return null\n  const label = names.length === 1 ? `${names[0]} is typing` : `${names[0]} and ${names.length - 1} others are typing`\n  return (\n    <div className={className || \"px-6 pb-2\"}>\n      <div className=\"inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-black/10 border border-white/5 backdrop-blur-md\">\n        <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">{label}</span>\n        <span className=\"inline-flex items-end gap-1\">\n          <span className=\"w-1 h-1 rounded-full bg-[var(--brand-primary)]\" style={{ animation: 'bounce 0.6s infinite', animationDelay: '0ms' }} />\n          <span className=\"w-1 h-1 rounded-full bg-[var(--brand-primary)]\" style={{ animation: 'bounce 0.6s infinite', animationDelay: '100ms' }} />\n          <span className=\"w-1 h-1 rounded-full bg-[var(--brand-primary)]\" style={{ animation: 'bounce 0.6s infinite', animationDelay: '200ms' }} />\n        </span>\n      </div>\n    </div>\n  )\n}\n\nfunction RankPill({ rank }: { rank: number }) {\n  if (rank === 1) {\n    return (\n      <span className=\"inline-flex items-center gap-1 px-2 py-1 rounded-[var(--radius-pill)] text-[10px] font-black uppercase tracking-widest text-black bg-gradient-to-r from-yellow-400 to-orange-400 shadow-[0_0_16px_rgba(255,191,0,0.20)]\">\n        <span aria-hidden=\"true\">üëë</span>\n        #1 Scholar\n      </span>\n    )\n  }\n  if (rank <= 10) {\n    return (\n      <span className=\"inline-flex items-center px-2 py-1 rounded-[var(--radius-pill)] text-[10px] font-black uppercase tracking-widest text-white bg-gradient-to-r from-slate-300/30 to-indigo-400/30 border border-white/10\">\n        Top 10\n      </span>\n    )\n  }\n  return null\n}\n\nfunction CommunityHubInner() {\n  const {\n    activeRoom,\n    setActiveRoom,\n    messages,\n    sendMessage,\n    addReaction,\n    editMessage,\n    deleteMessage,\n    openDM,\n    dmWindows,\n    closeDM,\n    toggleDMMinimize,\n    onlineUsers,\n    typingUsers,\n    setTyping,\n    blockUser,\n    unblockUser,\n    muteUser,\n    unmuteUser,\n    reportMessage,\n    reportUser,\n    reportRoom,\n    blockedUsers,\n    mutedUsers,\n    createPrivateRoom,\n    joinRoom,\n  } = useSocialHub()\n\n  const { user, userData } = useAuth()\n\n  const [activeDistrictId, setActiveDistrictId] = useState<DistrictId>('lobby')\n  const [activeChannelId, setActiveChannelId] = useState<string>(DISTRICTS[0].channels[0]?.id || 'announcements')\n\n  const [messageText, setMessageText] = useState('')\n  const [isOffline, setIsOffline] = useState(false)\n\n  const [rankByUserId, setRankByUserId] = useState<Record<string, number>>({})\n\n  const [isWhiteboardOpen, setIsWhiteboardOpen] = useState(false)\n  const [whiteboardSeed, setWhiteboardSeed] = useState(0)\n  const [whiteboardBoardId, setWhiteboardBoardId] = useState<string | null>(null)\n  const [whiteboardBoardName, setWhiteboardBoardName] = useState<string>('Untitled Board')\n  const [pendingWhiteboardAnnounce, setPendingWhiteboardAnnounce] = useState(false)\n\n  const createBoardId = () => {\n    if (typeof crypto !== 'undefined' && 'randomUUID' in crypto) {\n      return crypto.randomUUID()\n    }\n    return `${Date.now()}_${Math.random().toString(16).slice(2)}`\n  }\n\n  const openNewWhiteboard = () => {\n    const id = createBoardId()\n    setWhiteboardBoardId(id)\n    setWhiteboardBoardName('Untitled Board')\n    setWhiteboardSeed((s) => s + 1)\n    setIsWhiteboardOpen(true)\n    setPendingWhiteboardAnnounce(true)\n  }\n\n  const openExistingWhiteboard = (id: string, name?: string | null) => {\n    setWhiteboardBoardId(id)\n    setWhiteboardBoardName(name || 'Untitled Board')\n    setWhiteboardSeed((s) => s + 1)\n    setIsWhiteboardOpen(true)\n    setPendingWhiteboardAnnounce(false)\n  }\n\n  useEffect(() => {\n    if (!pendingWhiteboardAnnounce) return\n    if (!isWhiteboardOpen) return\n    if (!activeRoom?.id) return\n    if (!whiteboardBoardId) return\n\n    sendMessage(`üß† Whiteboard session started: ${whiteboardBoardName}`, undefined, {\n      kind: 'whiteboard',\n      whiteboardId: whiteboardBoardId,\n      whiteboardName: whiteboardBoardName,\n    }).catch(() => { })\n\n    setPendingWhiteboardAnnounce(false)\n  }, [activeRoom?.id, isWhiteboardOpen, pendingWhiteboardAnnounce, sendMessage, whiteboardBoardId, whiteboardBoardName])\n\n  const [fileUploading, setFileUploading] = useState(false)\n  const [uploadProgress, setUploadProgress] = useState(0)\n  const fileInputRef = useRef<HTMLInputElement>(null)\n  const messagesEndRef = useRef<HTMLDivElement>(null)\n\n  const [editingId, setEditingId] = useState<string | null>(null)\n  const [editingText, setEditingText] = useState('')\n\n  const [showReactionsFor, setShowReactionsFor] = useState<string | null>(null)\n  const [mobileActionsFor, setMobileActionsFor] = useState<string | null>(null)\n\n  const xpPct = useMemo(() => {\n    const xp = typeof userData?.xp === 'number' ? userData.xp : 0\n    const levelSize = 1000\n    const prev = Math.floor(xp / levelSize) * levelSize\n    const next = prev + levelSize\n    const pct = next === prev ? 0 : (xp - prev) / (next - prev)\n    return Math.max(0, Math.min(1, pct))\n  }, [userData?.xp])\n\n  const activeDistrict = useMemo(() => DISTRICTS.find((d) => d.id === activeDistrictId) || DISTRICTS[0], [activeDistrictId])\n  const channels = activeDistrict.channels\n\n  useEffect(() => {\n    const onOnline = () => setIsOffline(false)\n    const onOffline = () => setIsOffline(true)\n\n    setIsOffline(typeof navigator !== 'undefined' ? !navigator.onLine : false)\n\n    window.addEventListener('online', onOnline)\n    window.addEventListener('offline', onOffline)\n\n    return () => {\n      window.removeEventListener('online', onOnline)\n      window.removeEventListener('offline', onOffline)\n    }\n  }, [])\n\n  useEffect(() => {\n    if (messages.length > 0 && messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' })\n    }\n  }, [messages.length])\n\n  useEffect(() => {\n    let cancelled = false\n\n    const fetchRanks = async () => {\n      if (!user) return\n      try {\n        const cacheKey = 'brighted_rank_xp_top10'\n        const cacheRaw = typeof window !== 'undefined' ? sessionStorage.getItem(cacheKey) : null\n        if (cacheRaw) {\n          const cached = JSON.parse(cacheRaw)\n          if (cached?.at && Date.now() - Number(cached.at) < 10 * 60 * 1000 && cached?.map) {\n            if (!cancelled) setRankByUserId(cached.map)\n            return\n          }\n        }\n\n        const token = await user.getIdToken()\n        const res = await fetch('/api/leaderboards?' + new URLSearchParams({ type: 'xp', limit: '10' }), {\n          headers: { Authorization: `Bearer ${token}` },\n        })\n        if (!res.ok) return\n        const payload = await res.json()\n        const entries = Array.isArray(payload?.entries) ? payload.entries : []\n        const map: Record<string, number> = {}\n        entries.forEach((e: any) => {\n          if (e?.id) map[String(e.id)] = Number(e.rank) || 0\n        })\n        if (!cancelled) setRankByUserId(map)\n        try {\n          sessionStorage.setItem(cacheKey, JSON.stringify({ at: Date.now(), map }))\n        } catch {\n          // ignore\n        }\n      } catch {\n        // ignore\n      }\n    }\n\n    fetchRanks()\n    const t = window.setInterval(fetchRanks, 10 * 60_000)\n    return () => {\n      cancelled = true\n      window.clearInterval(t)\n    }\n  }, [user])\n\n  useEffect(() => {\n    const channel = channels.find((c) => c.id === activeChannelId) || channels[0]\n    if (!channel) return\n\n    const roomId = getRoomId(activeDistrict.id, channel.id)\n    const roomName = `#${channel.name}`\n\n    setActiveRoom({\n      id: roomId,\n      name: roomName,\n      type: 'public',\n      subject: activeDistrict.name,\n      members: [],\n      createdAt: null,\n    }).catch(() => { })\n  }, [activeDistrict.id, activeDistrict.name, activeChannelId, channels, setActiveRoom])\n\n  const handleSendMessage = async () => {\n    if (!messageText.trim()) return\n\n    try {\n      await setTyping(false)\n      await sendMessage(messageText)\n      setMessageText('')\n    } catch (err: any) {\n      alert(err?.message || 'Failed to send message')\n    }\n  }\n\n  useEffect(() => {\n    if (!activeRoom?.id) return\n    if (!user?.uid) return\n    if (!messageText.trim()) {\n      setTyping(false).catch(() => { })\n      return\n    }\n\n    setTyping(true).catch(() => { })\n    const t = window.setTimeout(() => {\n      setTyping(false).catch(() => { })\n    }, 2000)\n\n    return () => window.clearTimeout(t)\n  }, [activeRoom?.id, messageText, setTyping, user?.uid])\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0]\n    if (!file) return\n\n    if (file.size > 20 * 1024 * 1024) {\n      alert('File size must be less than 20MB')\n      return\n    }\n\n    const allowedTypes = ['.pdf', '.png', '.jpg', '.jpeg', '.docx']\n    const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase()\n    if (!allowedTypes.includes(fileExtension)) {\n      alert('Only PDF, PNG, JPG, and DOCX files are allowed')\n      return\n    }\n\n    setFileUploading(true)\n    setUploadProgress(0)\n\n    try {\n      const fileRef = ref(storage, `community/${Date.now()}_${file.name}`)\n\n      const { uploadBytesResumable } = await import('firebase/storage')\n      const uploadTask = uploadBytesResumable(fileRef, file)\n\n      uploadTask.on(\n        'state_changed',\n        (snapshot) => {\n          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100\n          setUploadProgress(Math.round(progress))\n        },\n        (error) => {\n          console.error('Upload error:', error)\n          alert('Failed to upload file')\n          setFileUploading(false)\n          setUploadProgress(0)\n        },\n        async () => {\n          const downloadURL = await getDownloadURL(uploadTask.snapshot.ref)\n          await sendMessage(`üìé ${file.name}`, downloadURL)\n          setFileUploading(false)\n          setUploadProgress(0)\n        }\n      )\n    } catch (error) {\n      console.error('Error uploading file:', error)\n      alert('Failed to upload file')\n      setFileUploading(false)\n      setUploadProgress(0)\n    } finally {\n      if (fileInputRef.current) {\n        fileInputRef.current.value = ''\n      }\n    }\n  }\n\n  const handleStartEdit = (messageId: string, currentText: string) => {\n    setEditingId(messageId)\n    setEditingText(currentText)\n  }\n\n  const handleCommitEdit = async () => {\n    if (!editingId) return\n    try {\n      await editMessage(editingId, editingText)\n      setEditingId(null)\n      setEditingText('')\n    } catch (err: any) {\n      alert(err?.message || 'Failed to edit message')\n    }\n  }\n\n  const handleDelete = async (messageId: string) => {\n    if (!confirm('Delete this message?')) return\n    try {\n      await deleteMessage(messageId)\n    } catch (err: any) {\n      alert(err?.message || 'Failed to delete message')\n    }\n  }\n\n  const handleBlockToggle = async (userId: string) => {\n    if (!userId || userId === user?.uid) return\n\n    try {\n      if (blockedUsers.includes(userId)) {\n        await unblockUser(userId)\n      } else {\n        await blockUser(userId)\n      }\n    } catch (err: any) {\n      alert(err?.message || 'Failed to update block list')\n    }\n  }\n\n  const handleMuteToggle = async (userId: string) => {\n    if (!userId || userId === user?.uid) return\n\n    try {\n      if (mutedUsers.includes(userId)) {\n        await unmuteUser(userId)\n      } else {\n        await muteUser(userId)\n      }\n    } catch (err: any) {\n      alert(err?.message || 'Failed to update mute list')\n    }\n  }\n\n  const handleJoinStudyRoom = async () => {\n    try {\n      const code = await createPrivateRoom()\n      await joinRoom(code)\n      alert(`Study room created. Share code: ${code}`)\n      openNewWhiteboard()\n    } catch (err: any) {\n      alert(err?.message || 'Failed to create study room')\n    }\n  }\n\n  const reactionsPalette = ['üî•', 'üíØ', 'üëè', 'üí°']\n\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)\n  const [isRightPanelOpen, setIsRightPanelOpen] = useState(false)\n\n  return (\n    <div className=\"min-h-[calc(100vh-96px)] w-full text-[var(--text-primary)] relative\">\n      {isOffline && (\n        <div className=\"w-full bg-red-500/10 border-b border-red-500/20 text-red-200 text-xs font-bold uppercase tracking-widest px-4 py-2\">\n          Offline. Trying to reconnect...\n        </div>\n      )}\n\n      <div className=\"flex w-full h-[calc(100vh-96px)] overflow-hidden\">\n\n        {/* MOBILE OVERLAY */}\n        {isMobileMenuOpen && (\n          <div\n            className=\"fixed inset-0 bg-black/60 z-50 md:hidden backdrop-blur-sm\"\n            onClick={() => setIsMobileMenuOpen(false)}\n          />\n        )}\n\n        {/* RIGHT PANEL MOBILE OVERLAY */}\n        {isRightPanelOpen && (\n          <div\n            className=\"fixed inset-0 bg-black/60 z-50 lg:hidden backdrop-blur-sm\"\n            onClick={() => setIsRightPanelOpen(false)}\n          />\n        )}\n\n        {/* DRAWER CONTAINER (Districts + Channels) */}\n        <div className={`\n          fixed inset-y-0 left-0 z-[60] flex h-full\n          transition-transform duration-300 ease-in-out transform \n          ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} \n          md:relative md:translate-x-0\n        `}>\n          {/* LEFT SIDEBAR: DISTRICTS */}\n          <aside className=\"w-20 bg-[var(--bg-primary)] border-r border-white/5 flex flex-col items-center py-6 gap-5 shrink-0 relative z-20\">\n            {DISTRICTS.map((d) => {\n              const isActive = d.id === activeDistrictId\n              return (\n                <button\n                  key={d.id}\n                  onClick={() => {\n                    setActiveDistrictId(d.id)\n                    setActiveChannelId(d.channels[0]?.id || 'announcements')\n                  }}\n                  className={`\n                    relative w-12 h-12 rounded-2xl transition-all duration-150 group\n                    ${isActive\n                      ? 'translate-y-[2px]'\n                      : 'hover:translate-y-[-2px] active:translate-y-[4px]'}\n                  `}\n                  style={{\n                    backgroundColor: isActive ? d.color : 'rgba(255,255,255,0.03)',\n                    boxShadow: isActive\n                      ? `0 4px 0 ${d.shadow}`\n                      : `0 4px 0 rgba(0,0,0,0.2)`,\n                    border: '2px solid rgba(255,255,255,0.05)'\n                  }}\n                  aria-pressed={isActive}\n                  aria-label={d.name}\n                >\n                  {/* Tooltip-like highlight */}\n                  <div className={`\n                    absolute left-[-4px] top-1/2 -translate-y-1/2 w-2 h-8 rounded-r-xl transition-transform\n                    ${isActive ? 'scale-y-100 bg-white' : 'scale-y-0 group-hover:scale-y-50 bg-white/20'}\n                  `} />\n\n                  <span className={`text-2xl transition-transform ${isActive ? 'scale-110 drop-shadow-md' : 'grayscale group-hover:grayscale-0'}`}>\n                    {d.icon}\n                  </span>\n                </button>\n              )\n            })}\n          </aside>\n\n          {/* SECONDARY SIDEBAR: CHANNELS */}\n          <aside className=\"w-60 bg-[var(--bg-glass)] backdrop-blur-xl border-r border-white/5 flex flex-col relative z-10\">\n            <div className=\"px-6 py-8 border-b border-white/5 flex justify-between items-center bg-black/10\">\n              <div className=\"flex flex-col\">\n                <span className=\"text-[10px] font-black uppercase tracking-[0.2em] text-[var(--text-muted)] mb-1\">District</span>\n                <h2 className=\"text-xl font-black text-[var(--text-primary)] tracking-tight\">{activeDistrict.name}</h2>\n              </div>\n              {/* Close button for mobile inside drawer */}\n              <button\n                onClick={() => setIsMobileMenuOpen(false)}\n                className=\"md:hidden p-2 text-[var(--text-muted)] hover:text-[var(--text-primary)]\"\n              >\n                ‚úï\n              </button>\n            </div>\n\n            <div className=\"flex-1 overflow-y-auto px-3 py-6 space-y-2\">\n              <div className=\"px-3 mb-4 text-[10px] font-black uppercase tracking-[0.2em] text-[var(--text-muted)] opacity-50\">\n                Study Channels\n              </div>\n              {channels.map((c) => {\n                const isActive = c.id === activeChannelId\n                return (\n                  <button\n                    key={c.id}\n                    onClick={() => {\n                      setActiveChannelId(c.id)\n                      setIsMobileMenuOpen(false) // Auto-close on mobile selection\n                    }}\n                    className={`\n                      w-full text-left px-4 py-3 rounded-xl text-sm font-bold transition-all relative group\n                      ${isActive\n                        ? 'bg-[var(--brand-primary)]/10 text-[var(--brand-primary)]'\n                        : 'text-[var(--text-secondary)] hover:bg-white/[0.03] hover:text-[var(--text-primary)]'}\n                    `}\n                  >\n                    {isActive && (\n                      <motion.div\n                        layoutId=\"activeChannel\"\n                        className=\"absolute inset-0 bg-white/[0.03] rounded-xl border-l-[3px] border-[var(--brand-primary)]\"\n                      />\n                    )}\n                    <span className=\"relative z-10 flex items-center gap-2\">\n                      <span className={`text-lg transition-transform ${isActive ? 'scale-110' : 'opacity-40 group-hover:opacity-100'}`}>\n                        {isActive ? 'üåü' : '#'}\n                      </span>\n                      {c.name}\n                    </span>\n                  </button>\n                )\n              })}\n            </div>\n          </aside>\n        </div>\n\n        {/* MAIN CHAT AREA */}\n        <main className=\"flex-1 flex flex-col min-w-0 w-full\">\n          <div className=\"px-6 py-5 border-b border-white/5 flex items-center justify-between bg-[var(--bg-primary)]/40 backdrop-blur-xl sticky top-0 z-30\">\n            <div className=\"flex items-center gap-4 min-w-0\">\n              {/* HAMBURGER BUTTON */}\n              <button\n                onClick={() => setIsMobileMenuOpen(true)}\n                className=\"md:hidden p-2 -ml-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] rounded-xl active:bg-white/[0.06]\"\n                aria-label=\"Open menu\"\n              >\n                <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 6h16M4 12h16M4 18h16\" /></svg>\n              </button>\n\n              <div className=\"min-w-0\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-xl\">üåü</span>\n                  <div className=\"text-[var(--text-primary)] font-black truncate text-xl tracking-tight\">{activeRoom?.name || '#channel'}</div>\n                </div>\n                <div className=\"text-[10px] font-black uppercase tracking-[0.2em] text-[var(--text-muted)] mt-1\">{activeDistrict.name} District</div>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-4\">\n              <div className=\"hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/[0.03] border border-white/5\">\n                <span className=\"w-2 h-2 rounded-full bg-green-400 animate-pulse\" />\n                <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-secondary)]\">\n                  {Math.max(1, Object.keys(onlineUsers).length)} Online\n                </span>\n              </div>\n              <button\n                onClick={() => setIsRightPanelOpen(true)}\n                className=\"lg:hidden text-[10px] font-black uppercase tracking-[0.2em] px-4 py-2 rounded-full bg-white/[0.03] hover:bg-white/[0.06] text-[var(--text-secondary)] transition-colors border border-white/10\"\n                aria-label=\"Open active scholars\"\n              >\n                Scholars\n              </button>\n              <button\n                onClick={() => {\n                  const should = confirm('Report this channel?')\n                  if (should && activeRoom?.id) {\n                    reportRoom(activeRoom.id, 'User reported channel from header').catch(() => { })\n                    alert('Thanks. Our moderation team will review.')\n                  }\n                }}\n                className=\"text-[10px] font-black uppercase tracking-[0.2em] px-4 py-2 rounded-full bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors border border-red-500/20\"\n              >\n                Report\n              </button>\n            </div>\n          </div>\n\n          <div className=\"flex-1 overflow-y-auto px-4 py-4\" style={{ paddingBottom: '184px' }}>\n            <div className=\"space-y-3\">\n              {messages.map((m, idx) => {\n                const prev = idx > 0 ? messages[idx - 1] : null\n                const groupStart = !isSameGroup(prev, m)\n                const isMine = m.senderId === user?.uid\n                const isBounty = m.kind === 'bounty'\n                const isWhiteboard = m.kind === 'whiteboard'\n                const rank = rankByUserId[m.senderId] || 0\n\n                const auraClass = rank === 1 ? 'aura-glow aura-gold' : rank === 2 ? 'aura-glow aura-silver' : rank === 3 ? 'aura-glow aura-bronze' : ''\n\n                const bubbleBase = `nebula-stroke bg-white/[0.04] border border-white/10 ${auraClass}`\n                const bubbleCornersMine = 'rounded-[var(--radius-bubble)] rounded-tr-md'\n                const bubbleCornersOther = 'rounded-[var(--radius-bubble)] rounded-tl-md'\n\n                const wrapperJustify = isMine ? 'justify-end' : 'justify-start'\n\n                return (\n                  <div key={m.id} className={`flex ${wrapperJustify} px-2`}>\n                    <div className={`flex items-end gap-3 max-w-full ${isMine ? 'flex-row-reverse' : 'flex-row'}`}>\n                      <div className=\"w-10 shrink-0\">\n                        {groupStart ? (\n                          <div className={`\n                            relative w-10 h-10 rounded-xl bg-[var(--bg-secondary)] border-b-[3px] border-black/20 overflow-hidden flex items-center justify-center text-sm font-black transition-transform hover:scale-110 active:scale-95\n                            ${rank === 1 ? 'ring-2 ring-yellow-400 shadow-[0_0_10px_rgba(255,191,0,0.3)]' : ''}\n                          `}>\n                            {m.senderAvatarCustomization ? (\n                              <AvatarRenderer\n                                customization={m.senderAvatarCustomization}\n                                username={m.senderName || 'User'}\n                              />\n                            ) : m.senderAvatarUrl ? (\n                              <Image\n                                src={m.senderAvatarUrl}\n                                alt=\"Avatar\"\n                                fill\n                                sizes=\"40px\"\n                                className=\"object-cover\"\n                              />\n                            ) : (\n                              (m.senderName || 'U').charAt(0).toUpperCase()\n                            )}\n                            {m.senderId === user?.uid ? (\n                              <div className=\"absolute left-1 right-1 -bottom-0.5 h-[2px] rounded-full bg-white/10 overflow-hidden\">\n                                <div className=\"h-full bg-[var(--hero)]\" style={{ width: `${Math.round(xpPct * 100)}%` }} />\n                              </div>\n                            ) : null}\n                          </div>\n                        ) : (\n                          <div className=\"w-10 h-10\" />\n                        )}\n                      </div>\n\n                      <div className={`flex flex-col ${isMine ? 'items-end' : 'items-start'}`}>\n                        {groupStart ? (\n                          <div className={`mb-1 flex items-center gap-2 ${isMine ? 'justify-end' : 'justify-start'}`}>\n                            <div className=\"flex items-center gap-2\">\n                              <div className=\"text-sm font-black text-[var(--text-primary)] truncate\">{m.senderName || 'User'}</div>\n                              {rank > 0 ? <RankPill rank={rank} /> : null}\n                              {isBounty && (\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-[#1CB0F6] border border-[#1CB0F6]/30 bg-[#1CB0F6]/10 px-2 py-1 rounded-full\">\n                                  Bounty {m.bountyPoints ? `${m.bountyPoints} RP` : ''}\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"text-[10px] text-[var(--text-muted)] whitespace-nowrap\">{m.timestamp?.toDate().toLocaleTimeString()}</div>\n                          </div>\n                        ) : null}\n\n                        <div className={`\n                          group relative inline-block max-w-[85vw] sm:max-w-[70%] \n                          ${isMine\n                            ? 'bg-[#1CB0F6] border-[#1899D6] border-b-[4px]'\n                            : 'bg-[#37464F] border-[#202F36] border-b-[4px]'} \n                          ${isBounty ? 'border-yellow-500/40 bg-yellow-50/10' : ''}\n                          ${groupStart ? (isMine ? 'rounded-[20px] rounded-tr-sm' : 'rounded-[20px] rounded-tl-sm') : 'rounded-[20px] mx-2'}\n                          transition-all duration-200\n                        `}>\n                          <div className=\"px-5 py-4\">\n                            {editingId === m.id ? (\n                              <div>\n                                <textarea\n                                  value={editingText}\n                                  onChange={(e) => setEditingText(e.target.value)}\n                                  className=\"w-full bg-black/20 border border-white/10 rounded-[var(--radius-main)] px-3 py-2 text-sm text-[var(--text-primary)]\"\n                                  rows={3}\n                                />\n                                <div className=\"mt-2 flex gap-2 justify-end\">\n                                  <button\n                                    onClick={handleCommitEdit}\n                                    className=\"text-xs px-3 py-2 rounded-[var(--radius-pill)] bg-[var(--hero)]/10 text-[var(--hero)] nebula-stroke hover:bg-[var(--hero)]/15\"\n                                  >\n                                    Save\n                                  </button>\n                                  <button\n                                    onClick={() => {\n                                      setEditingId(null)\n                                      setEditingText('')\n                                    }}\n                                    className=\"text-xs px-3 py-2 rounded-[var(--radius-pill)] bg-white/[0.03] nebula-stroke hover:bg-white/[0.06] text-[var(--text-secondary)]\"\n                                  >\n                                    Cancel\n                                  </button>\n                                </div>\n                              </div>\n                            ) : (\n                              <div className={`text-sm font-medium whitespace-pre-wrap text-white`}>\n                                {m.text}\n                              </div>\n                            )}\n\n                            {m.fileUrl && (\n                              <div className=\"mt-3\">\n                                <a\n                                  href={m.fileUrl}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"inline-flex items-center gap-2 text-sm px-3 py-2 rounded-[var(--radius-pill)] bg-black/20 border border-white/10 hover:bg-black/30\"\n                                >\n                                  <span>üìé</span>\n                                  <span className=\"text-[var(--hero)]\">{m.text.replace('üìé ', '')}</span>\n                                </a>\n                              </div>\n                            )}\n\n                            {isWhiteboard && (\n                              <div className=\"mt-3 border border-white/10 rounded-[var(--radius-main)] p-3 bg-black/10\">\n                                <div className=\"flex items-center justify-between gap-3\">\n                                  <div className=\"min-w-0\">\n                                    <div className=\"font-black truncate text-white uppercase tracking-tight\">{m.whiteboardName || 'Whiteboard'}</div>\n                                    <div className=\"text-[10px] font-black uppercase text-white/50\">Whiteboard Preview</div>\n                                  </div>\n                                  <button\n                                    onClick={() => {\n                                      if (m.whiteboardId) {\n                                        openExistingWhiteboard(m.whiteboardId, m.whiteboardName)\n                                      }\n                                    }}\n                                    className=\"text-xs px-3 py-2 rounded-[var(--radius-pill)] bg-white/[0.03] nebula-stroke hover:bg-white/[0.06]\"\n                                  >\n                                    Open\n                                  </button>\n                                </div>\n                                {m.whiteboardThumbnailUrl ? (\n                                  <div className=\"mt-3\">\n                                    <Image\n                                      src={m.whiteboardThumbnailUrl}\n                                      alt=\"Whiteboard thumbnail\"\n                                      width={360}\n                                      height={240}\n                                      className=\"w-full max-w-[360px] h-auto rounded-[var(--radius-main)] border border-white/10\"\n                                      unoptimized\n                                    />\n                                  </div>\n                                ) : null}\n                              </div>\n                            )}\n\n                            <div className=\"mt-3 flex items-center gap-2 flex-wrap\">\n                              {reactionsPalette.map((emoji) => {\n                                const count = m.reactions?.[emoji]?.length || 0\n                                const hasReacted = (m.reactions?.[emoji] || []).includes(user?.uid || '')\n                                if (showReactionsFor !== m.id && count === 0) return null\n\n                                return (\n                                  <button\n                                    key={emoji}\n                                    onClick={() => addReaction(m.id, emoji)}\n                                    className={`text-sm px-2 py-1 rounded-xl border transition-all ${hasReacted\n                                      ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)]/20 text-white'\n                                      : isMine\n                                        ? 'border-white/10 bg-black/20 text-white/60 hover:bg-black/40 hover:text-white'\n                                        : 'border-white/10 bg-black/20 text-white/60 hover:bg-black/40 hover:text-white'\n                                      }`}\n                                  >\n                                    {emoji} {count > 0 ? <span className=\"text-xs font-bold\">{count}</span> : null}\n                                  </button>\n                                )\n                              })}\n\n                              <button\n                                onClick={() => setShowReactionsFor((prevId) => (prevId === m.id ? null : m.id))}\n                                className={`text-xs font-bold transition-opacity text-white/40 hover:text-white`}\n                              >\n                                {showReactionsFor === m.id ? 'Done' : 'React'}\n                              </button>\n                            </div>\n                          </div>\n\n                          <div className={`absolute bottom-1 right-1 hidden md:flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200`}>\n                            <button\n                              onClick={() => openDM(m.senderId, m.senderName || 'User')}\n                              className=\"text-sm p-1.5 rounded bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition-all backdrop-blur-sm\"\n                              title=\"Direct Message\"\n                            >\n                              üí¨\n                            </button>\n\n                            {isMine ? (\n                              <>\n                                <button\n                                  onClick={() => handleStartEdit(m.id, m.text)}\n                                  className=\"text-sm p-1.5 rounded bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition-all backdrop-blur-sm\"\n                                  disabled={editingId === m.id}\n                                  title=\"Edit Message\"\n                                >\n                                  ‚úèÔ∏è\n                                </button>\n                                <button\n                                  onClick={() => handleDelete(m.id)}\n                                  className=\"text-sm p-1.5 rounded bg-red-500/10 hover:bg-red-500/20 text-red-200 hover:text-red-100 transition-all backdrop-blur-sm\"\n                                  title=\"Delete Message\"\n                                >\n                                  üóëÔ∏è\n                                </button>\n                              </>\n                            ) : (\n                              <button\n                                onClick={() => reportMessage(m.id, 'Inappropriate content')}\n                                className=\"text-sm p-1.5 rounded bg-red-500/10 hover:bg-red-500/20 text-red-200 hover:text-red-100 transition-all backdrop-blur-sm\"\n                                title=\"Report Message\"\n                              >\n                                üö©\n                              </button>\n                            )}\n                          </div>\n\n                          <div className={`absolute top-2 ${isMine ? 'left-2' : 'right-2'} md:hidden`}>\n                            <button\n                              onClick={() => setMobileActionsFor((curId) => (curId === m.id ? null : m.id))}\n                              className=\"w-8 h-8 rounded-[var(--radius-pill)] bg-white/[0.02] border border-white/10\"\n                              aria-label=\"Actions\"\n                            >\n                              ‚ãØ\n                            </button>\n                          </div>\n\n                          {mobileActionsFor === m.id ? (\n                            <div className={`md:hidden absolute top-12 ${isMine ? 'left-2' : 'right-2'} z-20 min-w-[160px] rounded-[var(--radius-main)] bg-[var(--bg-glass)] backdrop-blur-xl border border-white/10 nebula-stroke overflow-hidden`}>\n                              <button\n                                onClick={() => {\n                                  openDM(m.senderId, m.senderName || 'User')\n                                  setMobileActionsFor(null)\n                                }}\n                                className=\"w-full text-left px-4 py-3 text-sm hover:bg-white/[0.06]\"\n                              >\n                                DM\n                              </button>\n\n                              {isMine ? (\n                                <>\n                                  <button\n                                    onClick={() => {\n                                      handleStartEdit(m.id, m.text)\n                                      setMobileActionsFor(null)\n                                    }}\n                                    className=\"w-full text-left px-4 py-3 text-sm hover:bg-white/[0.06]\"\n                                  >\n                                    Edit\n                                  </button>\n                                  <button\n                                    onClick={() => {\n                                      handleDelete(m.id)\n                                      setMobileActionsFor(null)\n                                    }}\n                                    className=\"w-full text-left px-4 py-3 text-sm text-red-200 hover:bg-red-500/10\"\n                                  >\n                                    Delete\n                                  </button>\n                                </>\n                              ) : (\n                                <button\n                                  onClick={() => {\n                                    reportMessage(m.id, 'Inappropriate content')\n                                    setMobileActionsFor(null)\n                                  }}\n                                  className=\"w-full text-left px-4 py-3 text-sm text-red-200 hover:bg-red-500/10\"\n                                >\n                                  Report\n                                </button>\n                              )}\n                            </div>\n                          ) : null}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n\n            <div ref={messagesEndRef} />\n          </div>\n\n          <TypingIndicator names={typingUsers.map((u) => u.name)} />\n\n          <div className=\"hidden md:block border-t border-white/5 px-6 py-5\">\n            {fileUploading && (\n              <div className=\"mb-4\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-[10px] font-black uppercase text-[var(--text-muted)]\">Uploading...</span>\n                  <span className=\"text-[10px] font-black text-[var(--brand-primary)]\">{uploadProgress}%</span>\n                </div>\n                <div className=\"w-full bg-white/5 rounded-full h-1.5 overflow-hidden\">\n                  <div className=\"h-full bg-[var(--brand-primary)] transition-all duration-300\" style={{ width: `${uploadProgress}%` }} />\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex items-end gap-3\">\n              <button\n                onClick={() => fileInputRef.current?.click()}\n                disabled={fileUploading}\n                className=\"w-12 h-12 flex items-center justify-center bg-white/[0.03] border border-white/10 rounded-2xl hover:bg-white/[0.06] transition-all disabled:opacity-50\"\n                aria-label=\"Upload file\"\n              >\n                üìé\n              </button>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                className=\"hidden\"\n                onChange={handleFileUpload}\n                accept=\".pdf,.png,.jpg,.jpeg,.docx\"\n              />\n\n              <button\n                onClick={() => {\n                  openNewWhiteboard()\n                }}\n                className=\"px-5 h-12 rounded-2xl bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] border border-[var(--brand-primary)]/20 hover:bg-[var(--brand-primary)]/20 text-[10px] font-black uppercase tracking-[0.2em] transition-all\"\n              >\n                ‚úèÔ∏è Draw\n              </button>\n\n              <div className=\"flex-1 relative\">\n                <textarea\n                  value={messageText}\n                  onChange={(e) => setMessageText(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !e.shiftKey) {\n                      e.preventDefault()\n                      handleSendMessage()\n                    }\n                  }}\n                  placeholder=\"Type your message...\"\n                  className=\"w-full bg-white/[0.03] border border-white/10 rounded-2xl px-5 py-4 text-sm resize-none focus:outline-none focus:border-[var(--brand-primary)]/50 text-[var(--text-primary)] placeholder:text-[var(--text-muted)] min-h-[56px] transition-all\"\n                  rows={1}\n                />\n              </div>\n\n              <button\n                onClick={handleSendMessage}\n                disabled={!messageText.trim() || fileUploading}\n                className=\"h-12 px-8 rounded-2xl bg-[var(--brand-primary)] border-b-[4px] border-[#1899D6] text-white font-black text-[10px] uppercase tracking-[0.2em] transition-all hover:brightness-110 active:border-b-0 active:translate-y-[4px] disabled:opacity-50 disabled:grayscale\"\n              >\n                Send\n              </button>\n            </div>\n          </div>\n\n          <div className=\"md:hidden fixed left-0 right-0 bottom-[72px] px-4 z-40\">\n            <TypingIndicator names={typingUsers.map((u) => u.name)} className=\"px-0 pb-2\" />\n            {fileUploading ? (\n              <div className=\"mb-2 px-3 py-2 rounded-[var(--radius-main)] bg-white/[0.03] border border-white/10\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-xs text-[var(--text-secondary)]\">Uploading...</span>\n                  <span className=\"text-xs font-black text-[var(--hero)]\">{uploadProgress}%</span>\n                </div>\n                <div className=\"mt-2 w-full bg-white/5 rounded-full h-2 overflow-hidden\">\n                  <div className=\"h-full bg-[var(--hero)]\" style={{ width: `${uploadProgress}%` }} />\n                </div>\n              </div>\n            ) : null}\n\n            <div className=\"flex items-end gap-2 px-3 py-3 rounded-[var(--radius-main)] bg-white/[0.03] backdrop-blur-xl border border-white/10 nebula-stroke\">\n              <button\n                onClick={() => fileInputRef.current?.click()}\n                disabled={fileUploading}\n                className=\"w-10 h-10 rounded-[var(--radius-pill)] bg-white/[0.03] border border-white/10\"\n                aria-label=\"Open attachments\"\n              >\n                +\n              </button>\n\n              <textarea\n                value={messageText}\n                onChange={(e) => setMessageText(e.target.value)}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault()\n                    handleSendMessage()\n                  }\n                }}\n                placeholder=\"Type your message...\"\n                className=\"flex-1 bg-transparent text-sm resize-none focus:outline-none text-[var(--text-primary)] placeholder:text-[var(--text-muted)] max-h-[96px]\"\n                rows={1}\n              />\n\n              <button\n                onClick={handleSendMessage}\n                disabled={!messageText.trim() || fileUploading}\n                className=\"w-10 h-10 rounded-[var(--radius-pill)] bg-[var(--hero)] text-black font-black disabled:opacity-50\"\n                aria-label=\"Send\"\n              >\n                ‚û§\n              </button>\n            </div>\n          </div>\n\n          <div className=\"md:hidden fixed left-0 right-0 bottom-0 z-50 border-t border-white/10 bg-[var(--bg-primary)]/70 backdrop-blur-xl\">\n            <div className=\"grid grid-cols-4 px-2 py-2\">\n              <Link href=\"/community\" className=\"flex flex-col items-center justify-center py-2 rounded-[var(--radius-main)] bg-white/[0.03] border border-white/10\">\n                <div className=\"text-lg\">üí¨</div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-secondary)]\">Chat</div>\n              </Link>\n              <Link href=\"/leaderboard\" className=\"flex flex-col items-center justify-center py-2 rounded-[var(--radius-main)] hover:bg-white/[0.03]\">\n                <div className=\"text-lg\">üèÜ</div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Board</div>\n              </Link>\n              <Link href=\"/practicals\" className=\"flex flex-col items-center justify-center py-2 rounded-[var(--radius-main)] hover:bg-white/[0.03]\">\n                <div className=\"text-lg\">üéÆ</div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Sim</div>\n              </Link>\n              <Link href=\"/profile\" className=\"flex flex-col items-center justify-center py-2 rounded-[var(--radius-main)] hover:bg-white/[0.03]\">\n                <div className=\"text-lg\">üë§</div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Profile</div>\n              </Link>\n            </div>\n          </div>\n        </main>\n\n        {/* RIGHT PANEL: ACTIVE SCHOLARS */}\n        <aside\n          className={`\n            fixed inset-y-0 right-0 z-[60] w-80 max-w-[85vw]\n            bg-[var(--bg-primary)] border-l border-white/5 p-6 flex flex-col gap-8 relative overflow-hidden\n            transition-transform duration-300 ease-in-out transform\n            ${isRightPanelOpen ? 'translate-x-0' : 'translate-x-full'}\n            lg:static lg:translate-x-0 lg:w-72 lg:max-w-none\n          `}\n        >\n          {/* Subtle background glow */}\n          <div className=\"absolute top-0 right-0 w-32 h-32 bg-[var(--brand-primary)]/5 blur-3xl rounded-full\" />\n\n          <button\n            onClick={() => setIsRightPanelOpen(false)}\n            className=\"lg:hidden absolute top-4 right-4 w-10 h-10 rounded-[var(--radius-pill)] bg-white/[0.03] border border-white/10 text-[var(--text-secondary)]\"\n            aria-label=\"Close active scholars\"\n          >\n            ‚úï\n          </button>\n\n          <button\n            onClick={handleJoinStudyRoom}\n            className=\"w-full px-6 py-4 rounded-2xl bg-[#58cc02] border-b-[5px] border-[#46a302] text-white font-black text-xs uppercase tracking-[0.2em] transition-all hover:brightness-110 active:border-b-0 active:translate-y-[4px] shadow-lg shadow-green-500/10\"\n          >\n            üöÄ Launch Study Room\n          </button>\n\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between pl-1\">\n              <h3 className=\"text-[10px] font-black uppercase tracking-[0.2em] text-[var(--text-muted)]\">Active Scholars</h3>\n              <span className=\"text-[10px] font-black text-[var(--brand-primary)] bg-[var(--brand-primary)]/10 px-2 py-0.5 rounded-full\">\n                {Object.keys(onlineUsers).length}\n              </span>\n            </div>\n\n            <div className=\"space-y-3 overflow-y-auto max-h-[calc(100vh-400px)] no-scrollbar\">\n              {Object.entries(onlineUsers).length > 0 ? (\n                Object.entries(onlineUsers).map(([uid, data]) => (\n                  <button\n                    key={uid}\n                    onClick={() => openDM(uid, data.name)}\n                    className=\"w-full flex items-center gap-3 p-3 rounded-2xl hover:bg-white/[0.03] transition-all group\"\n                  >\n                    <div className=\"relative\">\n                      <div className=\"relative w-10 h-10 rounded-xl bg-gradient-to-br from-white/10 to-white/5 border border-white/10 flex items-center justify-center text-sm font-black text-[var(--text-primary)] shadow-sm overflow-hidden\">\n                        {data.avatarCustomization ? (\n                          <AvatarRenderer customization={data.avatarCustomization} username={data.name} />\n                        ) : data.avatarUrl ? (\n                          <Image src={data.avatarUrl} alt={data.name} fill sizes=\"40px\" className=\"object-cover\" />\n                        ) : (\n                          data.name?.charAt(0)?.toUpperCase() || 'U'\n                        )}\n                      </div>\n                      <span className=\"absolute -right-1 -bottom-1 w-4 h-4 rounded-full bg-green-500 border-[3px] border-[var(--bg-primary)] shadow-sm\" />\n                    </div>\n                    <div className=\"flex flex-col items-start min-w-0\">\n                      <span className=\"text-sm font-bold text-[var(--text-primary)] truncate group-hover:text-[var(--brand-primary)] transition-colors\">\n                        {data.name}\n                      </span>\n                      <span className=\"text-[10px] font-black uppercase text-[var(--text-muted)]\">Learning...</span>\n                    </div>\n                  </button>\n                ))\n              ) : (\n                <div className=\"text-center py-10 opacity-50\">\n                  <span className=\"text-4xl block mb-2\">ü¶â</span>\n                  <p className=\"text-xs font-bold\">Waiting for scholars...</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"mt-auto border-t border-white/5 pt-6\">\n            <div className=\"bg-white/[0.03] border border-white/5 rounded-2xl p-4 relative overflow-hidden group\">\n              <div className=\"absolute top-0 right-0 w-20 h-20 bg-[var(--brand-accent)]/10 blur-2xl rounded-full\" />\n              <h4 className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)] mb-3\">Community Quest</h4>\n              <div className=\"flex items-center gap-3\">\n                <span className=\"text-2xl\">üî•</span>\n                <div className=\"flex-1\">\n                  <div className=\"text-sm font-black text-[var(--text-primary)]\">{userData?.streak || 0}-Day Streak</div>\n                  <div className=\"h-1.5 w-full bg-white/10 rounded-full mt-1 overflow-hidden\">\n                    <div\n                      className=\"h-full bg-orange-500 rounded-full transition-all duration-1000\"\n                      style={{ width: `${Math.min(100, ((userData?.streak || 0) / 7) * 100)}%` }}\n                    />\n                  </div>\n                  <div className=\"text-[8px] font-black uppercase tracking-widest text-[var(--text-muted)] mt-1\">Goal: 7 Days</div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </aside>\n\n        {/* DM WINDOWS */}\n        {dmWindows.map((dm) => (\n          <DMWindow\n            key={dm.userId}\n            userId={dm.userId}\n            userName={dm.userName}\n            roomId={dm.roomId}\n            isMinimized={dm.isMinimized}\n            onClose={() => closeDM(dm.userId)}\n            onMinimize={() => toggleDMMinimize(dm.userId)}\n          />\n        ))}\n\n        {user?.uid ? (\n          <WhiteboardSession\n            key={whiteboardSeed}\n            uid={user.uid}\n            isOpen={isWhiteboardOpen}\n            initialBoardId={whiteboardBoardId || undefined}\n            initialBoardName={whiteboardBoardName}\n            roomId={activeRoom?.id || null}\n            activeRoomIdForPosting={activeRoom?.id || null}\n            onPostToHub={async ({ whiteboardId, whiteboardName, whiteboardThumbnailUrl }) => {\n              if (!activeRoom?.id) return\n              await sendMessage(`üß† Whiteboard: ${whiteboardName}`, undefined, {\n                kind: 'whiteboard',\n                whiteboardId,\n                whiteboardName,\n                whiteboardThumbnailUrl,\n              })\n            }}\n            onClose={() => {\n              setIsWhiteboardOpen(false)\n            }}\n          />\n        ) : null}\n      </div>\n    </div>\n  )\n}\n\nfunction AvatarRenderer({ customization, username }: { customization: any, username: string }) {\n  const svg = useMemo(() => {\n    const c = customization;\n    const avatar = createAvatar(avataaars, {\n      seed: username,\n      backgroundColor: [c.backgroundColor || 'FF8A8A'],\n      top: [c.top || 'shortFlat'],\n      hairColor: [c.hairColor || '2c1b18'],\n      clothing: [c.clothing || 'blazerAndShirt'],\n      clothesColor: [c.clothingColor || c.clothesColor || '262e33'],\n      accessories: [c.accessories || 'blank'],\n      eyes: [c.eyes || 'default'],\n      mouth: [c.mouth || 'smile'],\n      skinColor: [c.skinColor || 'ffdbb4'],\n      facialHair: [c.facialHair || 'blank'],\n      backgroundType: ['solid']\n    });\n    return avatar.toString();\n  }, [customization, username]);\n\n  return (\n    <div\n      className=\"w-full h-full\"\n      dangerouslySetInnerHTML={{ __html: svg }}\n    />\n  );\n}\n\nexport default function CommunityPage() {\n  return (\n    <SocialHubProvider>\n      <CommunityHubInner />\n    </SocialHubProvider>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/home/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Image' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":13,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Image"},"fix":{"range":[170,201],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[875,878],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[875,878],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3963,3966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3963,3966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4131,4134],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4131,4134],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6923,6926],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6923,6926],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7001,7004],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7001,7004],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useEffect, useState } from 'react'\nimport { useRouter } from 'next/navigation'\nimport Link from 'next/link'\nimport { motion } from 'framer-motion'\nimport Image from 'next/image'\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system'\nimport { useAuth } from '@/lib/auth-context'\nimport { db } from '@/lib/firebase'\nimport { collection, getDocs, limit, orderBy, query } from 'firebase/firestore'\nimport { ProfessorBrightMascot } from '@/components/learning'\nimport { FeedbackResponse } from '@/lib/professor-bright'\nimport { ALL_ACHIEVEMENTS, checkAchievement } from '@/lib/achievements'\nimport { resolveMasteryPercent } from '@/lib/user-stats'\n\nexport default function HomePage() {\n    const router = useRouter()\n    const { user, userData, loading: authLoading } = useAuth()\n    const [learningPath, setLearningPath] = useState<any[]>([])\n    const [welcomeText, setWelcomeText] = useState<string>('Keep Shining')\n    const [mascotFeedback, setMascotFeedback] = useState<FeedbackResponse | null>(null)\n\n    const [leaderPreview, setLeaderPreview] = useState<{\n        xpTop: { name: string; value: number } | null\n        streakTop: { name: string; value: number } | null\n        topBusiness: { name: string; value: number } | null\n        loading: boolean\n    }>({ xpTop: null, streakTop: null, topBusiness: null, loading: true })\n\n    const masteryPercent = resolveMasteryPercent(userData);\n\n    const HOME_STATS = [\n        { label: 'Mastery', value: masteryPercent.toString(), unit: '%', icon: 'üß†', color: 'text-purple-500' },\n        { label: 'Consistency', value: Math.round(userData?.consistency || 0).toString(), unit: '%', icon: 'üìà', color: 'text-blue-500' },\n        { label: 'Streak', value: (userData?.streak || 0).toString(), unit: 'Days', icon: 'üî•', color: 'text-orange-500' },\n        { label: 'Wealth', value: (userData?.xp || 0).toLocaleString(), unit: 'Total', icon: '‚ö°', color: 'text-yellow-500' },\n    ]\n\n    const ACHIEVEMENT_PREVIEWS = ALL_ACHIEVEMENTS.slice(0, 4).map(ach => ({\n        ...ach,\n        unlocked: checkAchievement(ach, userData, leaderPreview.topBusiness?.value || 0),\n        progress: 0 // We can add progress calculation logic later if needed\n    }))\n\n    useEffect(() => {\n        if (authLoading) return\n        if (!user) {\n            router.push('/')\n            return\n        }\n\n        // Mascot Greeting\n        const timer = setTimeout(() => {\n            const streak = userData?.streak || 0\n            const firstName = userData?.firstName || 'Explorer'\n\n            setMascotFeedback({\n                tone: 'encouraging',\n                message: streak > 0\n                    ? `Day ${streak}! Keep that fire burning, ${firstName}! üî•`\n                    : `Welcome back, ${firstName}! Ready to conquer the day? üöÄ`,\n                emoji: streak > 0 ? 'üî•' : 'üëã',\n                spriteClass: streak > 0 ? 'owl-magic' : 'owl-neutral'\n            })\n        }, 1500)\n\n        // Fetch Learning Path Preview (Real-time data comes from userData)\n        // Use AbortController to prevent duplicate calls\n        const abortController = new AbortController();\n        const subjects = userData?.subjectProgress ? Object.keys(userData.subjectProgress) : []\n\n        if (subjects.length > 0) {\n            // Get auth token for the API call\n            user.getIdToken().then(token => {\n                fetch('/api/learning-path?' + new URLSearchParams({\n                    subjects: subjects.join(',')\n                }), {\n                    signal: abortController.signal,\n                    cache: 'force-cache', // Use browser cache\n                    headers: {\n                        'Authorization': `Bearer ${token}`\n                    }\n                })\n                    .then(res => res.json())\n                    .then(pathData => {\n                        const allPaths = pathData.paths || {}\n                        const preview: any[] = []\n\n                        for (const [subject, objectives] of Object.entries(allPaths)) {\n                            const subjectObjectives = objectives as any[]\n                            if (subjectObjectives.length > 0) {\n                                preview.push({\n                                    title: subjectObjectives[0].objective?.substring(0, 40) || `${subject} - Objective 1`,\n                                    subject: subject,\n                                    level: subjectObjectives[0].difficulty || 1,\n                                    objectiveId: subjectObjectives[0].id,\n                                    icon: getSubjectIcon(subject),\n                                    color: getSubjectColor(subject),\n                                    // Calculate actual progress from mastery data (0.1-10.0 scale -> 0-100%)\n                                    progress: userData?.subjectProgress?.[subject]\n                                        ? Math.min(100, Math.round(((userData.subjectProgress[subject] || 0.1) / 10.0) * 100))\n                                        : 0\n                                })\n                            }\n                        }\n                        setLearningPath(preview.slice(0, 3))\n                    })\n                    .catch((err) => {\n                        // Ignore abort errors\n                        if (err.name !== 'AbortError') {\n                            console.error('Learning path error:', err);\n                            // Silent fail - learning path is not critical\n                        }\n                    })\n            }).catch(err => {\n                console.error('Token error:', err);\n            });\n        }\n\n        return () => {\n            abortController.abort();\n            clearTimeout(timer);\n        };\n\n    }, [user, userData, authLoading, router])\n\n    useEffect(() => {\n        if (authLoading) return\n        if (!user) return\n\n        let cancelled = false\n\n        const load = async () => {\n            setLeaderPreview((p) => ({ ...p, loading: true }))\n            try {\n                const token = await user.getIdToken()\n\n                const [xpRes, streakRes, bizSnap] = await Promise.all([\n                    fetch(`/api/leaderboards?` + new URLSearchParams({ type: 'xp', limit: '1' }), {\n                        headers: { Authorization: `Bearer ${token}` },\n                    }),\n                    fetch(`/api/leaderboards?` + new URLSearchParams({ type: 'streak', limit: '1' }), {\n                        headers: { Authorization: `Bearer ${token}` },\n                    }),\n                    getDocs(query(collection(db, 'businesses'), orderBy('valuation', 'desc'), limit(1))),\n                ])\n\n                if (cancelled) return\n\n                const [xpJson, streakJson] = await Promise.all([xpRes.json(), streakRes.json()])\n\n                const xpEntry = (xpJson?.entries?.[0] as any) || null\n                const streakEntry = (streakJson?.entries?.[0] as any) || null\n\n                const topBizDoc = bizSnap.docs[0]\n                const topBiz = topBizDoc ? topBizDoc.data() : null\n\n                setLeaderPreview({\n                    xpTop: xpEntry ? { name: String(xpEntry.name || 'Explorer'), value: Number(xpEntry.value || 0) } : null,\n                    streakTop: streakEntry ? { name: String(streakEntry.name || 'Explorer'), value: Number(streakEntry.value || 0) } : null,\n                    topBusiness: topBiz ? { name: String(topBiz.name || 'Business'), value: Number(topBiz.valuation || 0) } : null,\n                    loading: false,\n                })\n            } catch {\n                if (cancelled) return\n                setLeaderPreview((p) => ({ ...p, loading: false }))\n            }\n        }\n\n        load()\n        return () => {\n            cancelled = true\n        }\n    }, [authLoading, user])\n\n    useEffect(() => {\n        if (!user) return\n        const options = [\n            'Keep Shining',\n            'You‚Äôve Got This',\n            'Let‚Äôs Level Up',\n            'Today Is Yours',\n            'Small Steps, Big Wins',\n            'Stay Locked In',\n            'Build Your Future',\n            'Make Today Count',\n        ]\n        setWelcomeText(options[Math.floor(Math.random() * options.length)] || 'Keep Shining')\n    }, [user])\n\n    function getSubjectIcon(subject: string): string {\n        const lower = subject.toLowerCase()\n        if (lower.includes('math')) return 'üìê'\n        if (lower.includes('business')) return 'üíº'\n        if (lower.includes('economic')) return 'üìä'\n        if (lower.includes('english')) return 'üìù'\n        if (lower.includes('science') || lower.includes('biology') || lower.includes('chemistry')) return 'üî¨'\n        if (lower.includes('social')) return 'üåç'\n        if (lower.includes('it') || lower.includes('information')) return 'üíª'\n        return 'üìö'\n    }\n\n    function getSubjectColor(subject: string): string {\n        const lower = subject.toLowerCase()\n        if (lower.includes('math')) return 'bg-green-500'\n        if (lower.includes('business')) return 'bg-purple-500'\n        if (lower.includes('economic')) return 'bg-blue-500'\n        if (lower.includes('english')) return 'bg-orange-500'\n        if (lower.includes('science') || lower.includes('biology') || lower.includes('chemistry')) return 'bg-teal-500'\n        if (lower.includes('social')) return 'bg-yellow-500'\n        if (lower.includes('it') || lower.includes('information')) return 'bg-indigo-500'\n        return 'bg-gray-500'\n    }\n\n    const dailyGoal = userData?.dailyGoal || 500\n    const xpToday = userData?.xp_today || 0\n    const dailyGoalPercent = dailyGoal > 0 ? Math.min(100, Math.round((xpToday / dailyGoal) * 100)) : 0\n    const dailyGoalRemaining = Math.max(0, dailyGoal - xpToday)\n\n    if (authLoading) {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center\">\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n            </div>\n        )\n    }\n\n    return (\n        <div className=\"min-h-screen min-h-[100dvh] bg-[var(--bg-primary)] pb-24 safe-padding\">\n            <div className=\"max-w-7xl mx-auto px-4 md:px-8 py-6 md:py-10\">\n                <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6 md:gap-8\">\n                    {/* Main Content Area */}\n                    <div className=\"lg:col-span-3 space-y-12\">\n                        {/* Welcome Card */}\n                        <BrightLayer variant=\"glass\" padding=\"none\" className=\"p-8 relative overflow-hidden group border-b-[8px] border-[var(--brand-primary)]\">\n                            <div className=\"absolute top-0 right-0 w-80 h-80 bg-[var(--brand-primary)] opacity-[0.05] group-hover:opacity-[0.10] rounded-full blur-3xl transition-opacity animate-pulse-slow\" />\n                            <div className=\"absolute -bottom-20 -left-20 w-60 h-60 bg-[var(--brand-accent)] opacity-[0.03] rounded-full blur-2xl\" />\n\n                            <div className=\"flex flex-col md:flex-row items-center justify-between gap-8 relative z-10\">\n                                <div className=\"max-w-xl\">\n                                    <div className=\"inline-flex items-center gap-2 bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-widest mb-4\">\n                                        <span className=\"relative flex h-2 w-2\">\n                                            <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--brand-primary)] opacity-75\"></span>\n                                            <span className=\"relative inline-flex rounded-full h-2 w-2 bg-[var(--brand-primary)]\"></span>\n                                        </span>\n                                        Live Status: Learning\n                                    </div>\n                                    <BrightHeading level={1} className=\"mb-4 text-center md:text-left leading-tight\">\n                                        {welcomeText}, <span className=\"text-[var(--brand-primary)]\">{userData?.firstName || 'Explorer'}</span>! üöÄ\n                                    </BrightHeading>\n                                    <p className=\"text-[var(--text-secondary)] font-medium text-lg md:text-xl text-center md:text-left mb-6 leading-relaxed\">\n                                        {learningPath.length > 0\n                                            ? `You're crushing ${learningPath[0]?.subject}. Just ${dailyGoalRemaining} more XP to hit your daily goal!`\n                                            : 'Your journey to financial mastery starts here. Ready for today\\'s challenge?'}\n                                    </p>\n                                    <div className=\"flex flex-col sm:flex-row gap-4 justify-center md:justify-start w-full\">\n                                        <Link href=\"/learn\" className=\"w-full sm:w-auto\">\n                                            <BrightButton variant=\"primary\" size=\"lg\" className=\"w-full sm:min-w-[180px] border-b-[6px] border-[#1F7A85] active:border-b-0 active:translate-y-[6px]\">\n                                                Resume Journey\n                                            </BrightButton>\n                                        </Link>\n                                        <Link href=\"/leaderboard\" className=\"w-full sm:w-auto\">\n                                            <BrightButton variant=\"outline\" size=\"lg\" className=\"w-full sm:min-w-[180px] border-b-[6px] active:border-b-2 active:translate-y-[4px]\">\n                                                View Rankings\n                                            </BrightButton>\n                                        </Link>\n                                    </div>\n                                </div>\n                                <div className=\"relative w-48 h-48 md:w-56 md:h-56 lg:w-64 lg:h-64\">\n                                    <motion.div\n                                        animate={{\n                                            y: [0, -15, 0],\n                                            rotate: [0, 3, -3, 0],\n                                            scale: [1, 1.05, 1]\n                                        }}\n                                        transition={{ duration: 6, repeat: Infinity, ease: \"easeInOut\" }}\n                                        className=\"relative w-full h-full\"\n                                    >\n                                        <div className=\"absolute inset-0 bg-[var(--brand-primary)] opacity-20 blur-2xl rounded-full scale-75 animate-pulse\" />\n                                        {/* Professor Bright Sprite */}\n                                        <div\n                                            className=\"owl-sprite owl-happy relative z-10 filter drop-shadow-2xl\"\n                                            style={{\n                                                transform: 'scale(1.35) translateY(10%)',\n                                                width: '100%',\n                                                height: '100%'\n                                            }}\n                                        />\n                                    </motion.div>\n\n                                    {/* Professor Bright Badge */}\n                                    <div className=\"absolute -bottom-6 -right-6 bg-white dark:bg-slate-900 px-4 py-2 rounded-xl shadow-xl border border-black/5 flex items-center gap-2 transform rotate-[-6deg] z-20\">\n                                        <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-[var(--brand-primary)] to-[var(--brand-accent)] flex items-center justify-center\">\n                                            <div className=\"owl-sprite owl-happy\" style={{ width: '40px', height: '40px' }} />\n                                        </div>\n                                        <div className=\"flex flex-col\">\n                                            <span className=\"text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-wider\">Mascot</span>\n                                            <span className=\"text-sm font-black text-[var(--brand-primary)]\">Professor Bright</span>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </BrightLayer>\n\n                        {/* Duolingo-Style Statistics Grid */}\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8\">\n                            {HOME_STATS.map((stat, i) => (\n                                <BrightLayer key={i} variant=\"elevated\" padding=\"md\" className=\"flex flex-col items-center hover:scale-105 transition-transform cursor-pointer border-b-[6px] border-black/10 active:border-b-0 active:translate-y-[6px]\">\n                                    <span className={`text-3xl mb-2 ${stat.color}`}>{stat.icon}</span>\n                                    <span className=\"text-2xl font-black text-[var(--text-primary)]\">{stat.value}{stat.unit === '%' ? '%' : ''}</span>\n                                    <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">{stat.label}</span>\n                                </BrightLayer>\n                            ))}\n                        </div>\n\n                        {/* Achievements Row */}\n                        <div className=\"space-y-6\">\n                            <div className=\"flex justify-between items-end pl-2\">\n                                <div>\n                                    <BrightHeading level={2} className=\"text-xl\">Achievements</BrightHeading>\n                                    <p className=\"text-[var(--text-muted)] text-sm font-bold\">Your latest milestones</p>\n                                </div>\n                                <Link href=\"/achievements\" className=\"text-[var(--brand-primary)] font-black uppercase text-xs tracking-widest hover:underline\">View All</Link>\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                                {ACHIEVEMENT_PREVIEWS.map((ach) => (\n                                    <BrightLayer key={ach.id} variant=\"glass\" padding=\"md\" className={`group ${ach.unlocked ? 'border-[var(--brand-primary)]' : ''}`}>\n                                        <div className=\"flex items-center gap-4\">\n                                            <div className={`text-4xl group-hover:scale-110 transition-transform ${!ach.unlocked && 'grayscale opacity-50'}`}>{ach.icon}</div>\n                                            <div className=\"flex-1\">\n                                                <div className=\"flex justify-between mb-1\">\n                                                    <span className=\"font-black text-sm\">{ach.name}</span>\n                                                    <span className=\"text-[var(--brand-primary)] text-xs font-black\">{ach.unlocked ? '100%' : 'Locked'}</span>\n                                                </div>\n                                                <div className=\"w-full bg-white/5 rounded-full h-2.5 border border-white/5\">\n                                                    <div className={`${ach.unlocked ? 'bg-[var(--brand-primary)]' : 'bg-white/10'} h-full rounded-full transition-all duration-1000`} style={{ width: ach.unlocked ? '100%' : '5%' }} />\n                                                </div>\n                                                <p className=\"text-[10px] font-bold text-[var(--text-muted)] mt-1 uppercase tracking-wider\">{ach.description}</p>\n                                            </div>\n                                        </div>\n                                    </BrightLayer>\n                                ))}\n                            </div>\n                        </div>\n\n                        {/* Hall of Fame Preview Section */}\n                        <div className=\"relative overflow-hidden group\">\n                            <div className=\"flex justify-between items-end mb-6 pl-2\">\n                                <div>\n                                    <BrightHeading level={2} className=\"mb-2\">\n                                        Leaderboard\n                                    </BrightHeading>\n                                    <p className=\"text-[var(--text-secondary)] font-medium\">Top performers are making moves. See where you stand!</p>\n                                </div>\n                                <Link href=\"/leaderboard\" className=\"text-[var(--brand-primary)] font-black uppercase text-sm tracking-widest hover:underline flex items-center gap-2\">\n                                    See All <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M9 5l7 7-7 7\" /></svg>\n                                </Link>\n                            </div>\n\n                            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                                <BrightLayer variant=\"elevated\" className=\"border-b-[6px] hover:border-[var(--brand-primary)] transition-all cursor-pointer\">\n                                    <div className=\"flex items-center gap-4\">\n                                        <div className=\"text-3xl\">ü•á</div>\n                                        <div>\n                                            <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest\">Global Rank #1</p>\n                                            <p className=\"text-lg font-bold\">{leaderPreview.xpTop?.name || (leaderPreview.loading ? 'Loading...' : '‚Äî')}</p>\n                                            <p className=\"text-[var(--brand-primary)] font-black text-xs\">{leaderPreview.xpTop ? `${leaderPreview.xpTop.value.toLocaleString()} XP` : (leaderPreview.loading ? '‚Äî' : '0 XP')}</p>\n                                        </div>\n                                    </div>\n                                </BrightLayer>\n                                <BrightLayer variant=\"elevated\" className=\"border-b-[6px] hover:border-[var(--brand-accent)] transition-all cursor-pointer\">\n                                    <div className=\"flex items-center gap-4\">\n                                        <div className=\"text-3xl\">üíπ</div>\n                                        <div>\n                                            <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest\">Top Business</p>\n                                            <p className=\"text-lg font-bold\">{leaderPreview.topBusiness?.name || (leaderPreview.loading ? 'Loading...' : '‚Äî')}</p>\n                                            <p className=\"text-[var(--brand-accent)] font-black text-xs\">{leaderPreview.topBusiness ? `$${leaderPreview.topBusiness.value.toLocaleString()} Value` : (leaderPreview.loading ? '‚Äî' : '$0 Value')}</p>\n                                        </div>\n                                    </div>\n                                </BrightLayer>\n                                <BrightLayer variant=\"elevated\" className=\"border-b-[6px] hover:border-purple-500 transition-all cursor-pointer\">\n                                    <div className=\"flex items-center gap-4\">\n                                        <div className=\"text-3xl\">üî•</div>\n                                        <div>\n                                            <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest\">Streak Leader</p>\n                                            <p className=\"text-lg font-bold\">{leaderPreview.streakTop?.name || (leaderPreview.loading ? 'Loading...' : '‚Äî')}</p>\n                                            <p className=\"text-purple-500 font-black text-xs\">{leaderPreview.streakTop ? `${leaderPreview.streakTop.value.toLocaleString()} Day Streak` : (leaderPreview.loading ? '‚Äî' : '0 Day Streak')}</p>\n                                        </div>\n                                    </div>\n                                </BrightLayer>\n                            </div>\n                        </div>\n\n                        {/* Learning Path Preview */}\n                        <div className=\"relative\">\n                            <div className=\"absolute left-10 top-20 bottom-0 w-1 bg-gradient-to-b from-[var(--brand-primary)] to-transparent opacity-20 hidden sm:block\" />\n                            <BrightHeading level={2} className=\"mb-8 pl-2 flex items-center gap-4\">\n                                <span className=\"bg-[var(--brand-primary)] text-white w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-lg shadow-[var(--brand-primary)]/40\">üìç</span>\n                                Your Active Missions\n                            </BrightHeading>\n                            {learningPath.length > 0 ? (\n                                <div className=\"space-y-6\">\n                                    {learningPath.map((skill, index) => (\n                                        <Link\n                                            key={index}\n                                            href={`/lesson?objectiveId=${skill.objectiveId}&subject=${encodeURIComponent(skill.subject)}`}\n                                            className=\"block\"\n                                        >\n                                            <motion.div\n                                                initial={{ opacity: 0, x: -20 }}\n                                                animate={{ opacity: 1, x: 0 }}\n                                                transition={{ delay: 0.2 + index * 0.1 }}\n                                            >\n                                                <BrightLayer variant=\"elevated\" padding=\"md\" className=\"group border-b-[8px] hover:border-[var(--brand-primary)] active:border-b-2 active:translate-y-[4px] cursor-pointer relative overflow-hidden\">\n                                                    <div className=\"absolute top-0 right-0 w-32 h-32 bg-[var(--brand-primary)] opacity-0 group-hover:opacity-[0.03] rounded-full blur-2xl transition-opacity\" />\n\n                                                    <div className=\"flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-6 relative z-10\">\n                                                        <div className={`w-20 h-20 sm:w-24 sm:h-24 rounded-[2rem] ${skill.color} flex items-center justify-center text-4xl sm:text-5xl shadow-xl shadow-black/20 text-white flex-shrink-0 group-hover:scale-110 transition-transform`}>\n                                                            {skill.icon}\n                                                        </div>\n                                                        <div className=\"flex-1 w-full space-y-4\">\n                                                            <div className=\"flex flex-col sm:flex-row justify-between items-center sm:items-start gap-2\">\n                                                                <div>\n                                                                    <BrightHeading level={3} className=\"text-2xl group-hover:text-[var(--brand-primary)] transition-colors text-center sm:text-left\">\n                                                                        {skill.title}\n                                                                    </BrightHeading>\n                                                                    <p className=\"text-[var(--text-muted)] text-sm font-bold uppercase tracking-wider\">{skill.subject}</p>\n                                                                </div>\n                                                                <span className=\"bg-[var(--brand-accent)] text-[var(--bg-primary)] text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-[0.2em] shadow-lg shadow-[var(--brand-accent)]/20\">\n                                                                    Level {skill.level}\n                                                                </span>\n                                                            </div>\n                                                            <div className=\"space-y-2\">\n                                                                <div className=\"flex justify-between text-xs font-black uppercase tracking-widest mb-1\">\n                                                                    <span className=\"text-[var(--text-muted)]\">Mastery Progress</span>\n                                                                    <span className=\"text-[var(--brand-primary)]\">{skill.progress}%</span>\n                                                                </div>\n                                                                <div className=\"w-full bg-[var(--bg-secondary)] rounded-2xl h-4 overflow-hidden border border-[var(--border-subtle)] p-1\">\n                                                                    <motion.div\n                                                                        initial={{ width: 0 }}\n                                                                        animate={{ width: `${Math.min(skill.progress || 0, 100)}%` }}\n                                                                        transition={{ duration: 1, delay: 0.5 }}\n                                                                        className={`h-full rounded-full ${skill.color} shadow-lg relative`}\n                                                                    >\n                                                                        <div className=\"absolute inset-0 bg-white/20 animate-pulse\" />\n                                                                    </motion.div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                        <div className=\"hidden lg:flex items-center justify-center w-12 h-12 rounded-full bg-[var(--bg-secondary)] border border-[var(--border-subtle)] text-[var(--text-muted)] group-hover:bg-[var(--brand-primary)] group-hover:text-white group-hover:scale-110 transition-all self-center\">\n                                                            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={4} d=\"M9 5l7 7-7 7\" />\n                                                            </svg>\n                                                        </div>\n                                                    </div>\n                                                </BrightLayer>\n                                            </motion.div>\n                                        </Link>\n                                    ))}\n                                </div>\n                            ) : (\n                                <BrightLayer variant=\"elevated\" padding=\"md\" className=\"border-b-[8px] border-[var(--border-subtle)]\">\n                                    <div className=\"space-y-4 text-center\">\n                                        <BrightHeading level={3} className=\"text-2xl\">Your missions are loading</BrightHeading>\n                                        <p className=\"text-[var(--text-muted)] text-sm font-bold\">Jump into a lesson to generate your first mission preview.</p>\n                                        <Link href=\"/learn\" className=\"inline-block\">\n                                            <BrightButton variant=\"primary\" size=\"lg\" className=\"border-b-[6px] border-[#1F7A85] active:border-b-0 active:translate-y-[6px]\">\n                                                Start Learning\n                                            </BrightButton>\n                                        </Link>\n                                    </div>\n                                </BrightLayer>\n                            )}\n                        </div>\n                    </div>\n\n                    {/* Sidebar */}\n                    <div className=\"lg:col-span-1 space-y-8\">\n                        {/* Daily Goal */}\n                        <motion.div\n                            initial={{ opacity: 0, x: 20 }}\n                            animate={{ opacity: 1, x: 0 }}\n                        >\n                            <BrightLayer variant=\"elevated\" padding=\"md\" className=\"border-b-[6px] border-[var(--brand-accent)] bg-[#0F172A] relative overflow-hidden group\">\n                                <div className=\"absolute -top-10 -right-10 w-32 h-32 bg-[var(--brand-accent)] opacity-[0.05] rounded-full blur-2xl\" />\n\n                                <div className=\"flex items-center justify-between mb-8\">\n                                    <BrightHeading level={3}>Daily Goal</BrightHeading>\n                                    {userData?.streak && userData.streak > 0 && (\n                                        <div className=\"flex flex-col items-end\">\n                                            <span className=\"text-[var(--brand-accent)] font-black text-xs uppercase tracking-widest animate-bounce\">Streak Flame</span>\n                                            <span className=\"text-2xl font-black text-white\">{userData.streak}üî•</span>\n                                        </div>\n                                    )}\n                                </div>\n                                <div className=\"relative w-48 h-48 mx-auto group-hover:scale-105 transition-transform\">\n                                    <svg className=\"w-full h-full transform -rotate-90\">\n                                        <circle cx=\"96\" cy=\"96\" r=\"85\" stroke=\"rgba(255,255,255,0.05)\" strokeWidth=\"16\" fill=\"none\" />\n                                        <motion.circle\n                                            cx=\"96\" cy=\"96\" r=\"85\"\n                                            stroke=\"var(--brand-accent)\"\n                                            strokeWidth=\"16\"\n                                            fill=\"none\"\n                                            strokeLinecap=\"round\"\n                                            initial={{ strokeDashoffset: 2 * Math.PI * 85 }}\n                                            animate={{ strokeDashoffset: 2 * Math.PI * 85 * (1 - Math.min(1, xpToday / dailyGoal)) }}\n                                            transition={{ duration: 1.5, ease: \"easeOut\" }}\n                                            strokeDasharray={`${2 * Math.PI * 85}`}\n                                            className=\"drop-shadow-[0_0_10px_rgba(255,165,0,0.5)]\"\n                                        />\n                                    </svg>\n                                    <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\n                                        <span className=\"text-5xl font-black text-white tracking-tighter\">\n                                            {dailyGoalPercent}%\n                                        </span>\n                                        <span className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-[0.3em]\">Missions Clear</span>\n                                    </div>\n                                </div>\n                                <div className=\"mt-8 text-center bg-white/5 rounded-2xl p-4\">\n                                    <p className=\"text-white font-bold text-sm\">{xpToday} / {dailyGoal} XP</p>\n                                    <p className=\"text-[var(--text-muted)] text-[10px] uppercase font-black tracking-widest mt-1\">Today&apos;s Progress</p>\n                                </div>\n                            </BrightLayer>\n                        </motion.div>\n\n                        {/* Quick Stats Grid */}\n                        <div className=\"grid grid-cols-1 gap-4\">\n                            {/* XP Summary */}\n                            <motion.div\n                                initial={{ opacity: 0, x: 20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                transition={{ delay: 0.2 }}\n                            >\n                                <BrightLayer variant=\"elevated\" padding=\"md\" className=\"border-b-[6px] border-[var(--brand-primary)] bg-[#0F172A]\">\n                                    <BrightHeading level={4} className=\"mb-2\">Total Wealth (XP)</BrightHeading>\n                                    <div className=\"flex items-baseline gap-2\">\n                                        <span className=\"text-4xl font-black text-[var(--brand-primary)] tracking-tighter\">\n                                            {(userData?.xp || 0).toLocaleString()}\n                                        </span>\n                                        <span className=\"text-[var(--text-muted)] text-xs font-bold uppercase\">XP</span>\n                                    </div>\n                                </BrightLayer>\n                            </motion.div>\n\n                            {/* B-Coins */}\n                            <motion.div\n                                initial={{ opacity: 0, x: 20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                transition={{ delay: 0.3 }}\n                            >\n                                <BrightLayer variant=\"elevated\" padding=\"md\" className=\"border-b-[6px] border-yellow-500 bg-[#0F172A]\">\n                                    <BrightHeading level={4} className=\"mb-2\">Business Cash</BrightHeading>\n                                    <div className=\"flex items-baseline gap-2\">\n                                        <span className=\"text-4xl font-black text-yellow-500 tracking-tighter\">\n                                            {(userData?.bCoins || 0).toLocaleString()}\n                                        </span>\n                                        <span className=\"text-[var(--text-muted)] text-xs font-bold uppercase\">B-Coins</span>\n                                    </div>\n                                </BrightLayer>\n                            </motion.div>\n                        </div>\n\n                        {/* Achievement Teaser */}\n                        <Link href=\"/achievements\">\n                            <motion.div\n                                initial={{ opacity: 0, x: 20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                transition={{ delay: 0.4 }}\n                                className=\"block\"\n                            >\n                                <BrightLayer variant=\"glass\" padding=\"md\" className=\"border-b-[6px] border-purple-500 hover:scale-[1.02] transition-transform text-center cursor-pointer\">\n                                    <div className=\"text-4xl mb-2\">üèÜ</div>\n                                    <BrightHeading level={4}>The Locker Room</BrightHeading>\n                                    <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest mt-2\">See your trophies ¬ª</p>\n                                </BrightLayer>\n                            </motion.div>\n                        </Link>\n                    </div>\n                </div>\n            </div>\n\n            {/* Professor Bright Pop-out Mascot */}\n            <ProfessorBrightMascot feedback={mascotFeedback} />\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/leaderboard/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'StreakCelebration' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"StreakCelebration"},"fix":{"range":[430,449],"text":""},"desc":"Remove unused variable \"StreakCelebration\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[865,868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[865,868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2989,2992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2989,2992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":338,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19580,19583],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19580,19583],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { useAuth } from '@/lib/auth-context';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { db } from '@/lib/firebase';\nimport { collection, query, orderBy, limit, getDocs } from 'firebase/firestore';\nimport { ProfessorBrightMascot, StreakCelebration } from '@/components/learning';\nimport { FeedbackResponse } from '@/lib/professor-bright';\nimport { createAvatar } from '@dicebear/core';\nimport { avataaars } from '@dicebear/collection';\n\ninterface LeaderboardEntry {\n    id: string;\n    name: string;\n    value: number;\n    subtext: string;\n    icon?: string;\n    rank: number;\n    isCurrentUser?: boolean;\n    avatarUrl?: string | null;\n    avatarCustomization?: any | null;\n}\n\ntype LeaderboardType = 'xp' | 'streak' | 'mastery' | 'schools' | 'business';\n\nexport default function LeaderboardPage() {\n    const { user, userData } = useAuth();\n    const [activeTab, setActiveTab] = useState<LeaderboardType>('xp');\n    const [loading, setLoading] = useState(true);\n    const [data, setData] = useState<LeaderboardEntry[]>([]);\n    const [mascotFeedback, setMascotFeedback] = useState<FeedbackResponse | null>(null);\n\n    useEffect(() => {\n        if (!user) return;\n\n        const fetchData = async () => {\n            setLoading(true);\n            try {\n                if (activeTab === 'business') {\n                    // Business Leaderboard\n                    const bizRef = collection(db, 'businesses');\n                    const q = query(bizRef, orderBy('valuation', 'desc'), limit(20));\n                    const snapshot = await getDocs(q);\n                    const entries: LeaderboardEntry[] = snapshot.docs.map((doc, index) => ({\n                        id: doc.id,\n                        name: doc.data().name || 'Unnamed Venture',\n                        value: doc.data().valuation || 0,\n                        subtext: doc.data().industry || 'Business',\n                        icon: 'üè¢',\n                        rank: index + 1,\n                        isCurrentUser: doc.data().ownerId === user?.uid\n                    }));\n                    setData(entries);\n                } else {\n                    const token = await user.getIdToken();\n                    const res = await fetch(`/api/leaderboards?` + new URLSearchParams({\n                        type: activeTab,\n                        limit: '20'\n                    }), {\n                        headers: {\n                            'Authorization': `Bearer ${token}`\n                        }\n                    });\n\n                    if (!res.ok) {\n                        throw new Error('Failed to fetch leaderboard');\n                    }\n\n                    const payload = await res.json();\n                    const entries: LeaderboardEntry[] = (payload.entries || []).map((entry: any) => {\n                        const value = typeof entry.value === 'number' ? entry.value : 0;\n                        return {\n                            id: entry.id,\n                            name: entry.name,\n                            value,\n                            subtext: entry.subtext,\n                            icon: entry.icon,\n                            rank: entry.rank,\n                            isCurrentUser: entry.id === user.uid,\n                        };\n                    });\n\n                    setData(entries);\n                }\n            } catch (error) {\n                console.error(\"Error fetching leaderboard:\", error);\n            }\n            setLoading(false);\n        };\n\n        fetchData();\n    }, [activeTab, user]);\n\n    useEffect(() => {\n        // Mascot Greeting\n        const timeout = setTimeout(() => {\n            if (activeTab === 'xp') {\n                setMascotFeedback({\n                    tone: 'encouraging',\n                    message: \"The XP leaderboard shows who's putting in the most work! Keep grinding! ‚ö°\",\n                    emoji: 'üîã',\n                    spriteClass: 'owl-magic'\n                });\n            } else if (activeTab === 'streak') {\n                setMascotFeedback({\n                    tone: 'supportive',\n                    message: \"Consistency is key. Don't let your flame go out! üî•\",\n                    emoji: 'üî•',\n                    spriteClass: 'owl-neutral'\n                });\n            } else if (activeTab === 'business') {\n                setMascotFeedback({\n                    tone: 'celebratory',\n                    message: \"Look at those valuations! You're building an empire! üè¢\",\n                    emoji: 'üí∞',\n                    spriteClass: 'owl-happy'\n                });\n            }\n        }, 1000);\n        return () => clearTimeout(timeout);\n    }, [activeTab]);\n\n    const getRankColor = (rank: number) => {\n        if (rank === 1) return 'border-yellow-400 bg-yellow-400/5 shadow-yellow-400/20';\n        if (rank === 2) return 'border-slate-300 bg-slate-300/5 shadow-slate-300/20';\n        if (rank === 3) return 'border-orange-400 bg-orange-400/5 shadow-orange-400/20';\n        return 'border-[var(--border-subtle)] bg-[var(--bg-secondary)]/30';\n    };\n\n    const getRankIconBg = (rank: number) => {\n        if (rank === 1) return 'bg-yellow-400 text-[#543b00]';\n        if (rank === 2) return 'bg-slate-300 text-[#334155]';\n        if (rank === 3) return 'bg-orange-400 text-[#5c2a00]';\n        return 'bg-[var(--bg-elevated)] text-[var(--text-muted)]';\n    };\n\n    return (\n        <div className=\"min-h-screen min-h-[100dvh] bg-[var(--bg-primary)] py-8 pb-32 md:py-16 safe-padding overflow-x-hidden\">\n            {/* Background Decorations */}\n            <div className=\"fixed inset-0 z-0 pointer-events-none opacity-[0.03]\">\n                <div className=\"absolute top-[10%] left-[5%] w-[40%] h-[40%] bg-[var(--brand-primary)] rounded-full blur-[120px]\" />\n                <div className=\"absolute bottom-[20%] right-[10%] w-[30%] h-[30%] bg-[var(--brand-accent)] rounded-full blur-[100px]\" />\n            </div>\n\n            <div className=\"container-responsive relative z-10 max-w-4xl mx-auto\">\n                {/* Hero Header */}\n                <motion.div\n                    initial={{ opacity: 0, y: -30 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className=\"text-center mb-12\"\n                >\n                    <div className=\"inline-flex items-center gap-3 px-4 py-2 rounded-2xl bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] text-xs font-black uppercase tracking-[0.2em] mb-6 border border-[var(--brand-primary)]/20 shadow-sm\">\n                        <span className=\"text-xl\">üèÜ</span> Arena of Excellence\n                    </div>\n                    <BrightHeading level={1} className=\"mb-4 text-5xl md:text-7xl\">\n                        Hall of <span className=\"text-[var(--brand-primary)] text-shadow-glow\">Fame</span>\n                    </BrightHeading>\n                    <p className=\"text-[var(--text-secondary)] text-lg md:text-xl font-medium max-w-2xl mx-auto leading-relaxed\">\n                        The elite scholars and visionaries of BrightEd. Where will your name be remembered?\n                    </p>\n                </motion.div>\n\n                {/* Tactile Tab System */}\n                <BrightLayer variant=\"glass\" padding=\"none\" className=\"p-2 mb-12 border-b-[8px] border-[var(--border-subtle)] ring-1 ring-white/5\">\n                    <div className=\"flex flex-wrap md:flex-nowrap gap-2\">\n                        {(['xp', 'streak', 'mastery', 'schools', 'business'] as LeaderboardType[]).map((tab) => (\n                            <button\n                                key={tab}\n                                onClick={() => setActiveTab(tab)}\n                                className={`\n                                    flex-1 min-w-[120px] py-4 px-4 rounded-2xl font-black uppercase tracking-wider transition-all relative overflow-hidden\n                                    ${activeTab === tab\n                                        ? 'text-white shadow-lg'\n                                        : 'text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:bg-white/5'\n                                    }\n                                `}\n                            >\n                                {activeTab === tab && (\n                                    <motion.div\n                                        layoutId=\"leaderboard-tab-bg\"\n                                        className=\"absolute inset-0 bg-[var(--brand-primary)] border-b-[4px] border-[#1F7A85]\"\n                                        transition={{ type: 'spring', bounce: 0.2, duration: 0.6 }}\n                                    />\n                                )}\n                                <span className=\"relative z-10\">\n                                    {tab === 'xp' ? '‚ö° XP' :\n                                        tab === 'streak' ? 'üî• Streak' :\n                                            tab === 'mastery' ? 'üß† Mastery' :\n                                                tab === 'schools' ? 'üè´ Schools' : 'üè¢ Business'}\n                                </span>\n                            </button>\n                        ))}\n                    </div>\n                </BrightLayer>\n\n                {/* Main Leaderboard List */}\n                <div className=\"space-y-4\">\n                    {loading ? (\n                        <div className=\"py-32 flex flex-col items-center justify-center space-y-4\">\n                            <div className=\"w-16 h-16 border-4 border-[var(--brand-primary)] border-t-transparent rounded-full animate-spin shadow-[0_0_15px_rgba(45,155,168,0.3)]\" />\n                            <p className=\"text-[var(--text-muted)] font-black uppercase tracking-widest text-sm animate-pulse\">Consulting the Sages...</p>\n                        </div>\n                    ) : data.length > 0 ? (\n                        <AnimatePresence mode=\"popLayout\">\n                            {data.map((entry, index) => (\n                                <motion.div\n                                    key={entry.id}\n                                    initial={{ opacity: 0, scale: 0.95, y: 20 }}\n                                    animate={{ opacity: 1, scale: 1, y: 0 }}\n                                    transition={{ delay: index * 0.05 }}\n                                    className=\"group\"\n                                >\n                                    <BrightLayer\n                                        variant=\"elevated\"\n                                        padding=\"none\"\n                                        className={`\n                                            relative flex items-center p-4 md:p-6 transition-all hover:-translate-y-1 active:translate-y-0\n                                            border-b-[8px] ${getRankColor(entry.rank)}\n                                            ${entry.isCurrentUser ? 'ring-2 ring-[var(--brand-primary)] shadow-[0_0_20px_rgba(45,155,168,0.2)]' : ''}\n                                        `}\n                                    >\n                                        {/* Rank Badge */}\n                                        <div className={`\n                                            w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center text-xl md:text-2xl font-black mr-4 md:mr-6 shrink-0\n                                            shadow-lg border-b-[4px] border-black/10 transition-transform group-hover:scale-110\n                                            ${getRankIconBg(entry.rank)}\n                                        `}>\n                                            {entry.rank === 1 ? 'ü•á' : entry.rank === 2 ? 'ü•à' : entry.rank === 3 ? 'ü•â' : entry.rank}\n                                        </div>\n\n                                        {/* Entry Avatar/Icon */}\n                                        <div className=\"relative w-12 h-12 md:w-14 md:h-14 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mr-4 md:mr-6 shadow-inner overflow-hidden\">\n                                            {entry.avatarCustomization ? (\n                                                <AvatarRenderer\n                                                    customization={entry.avatarCustomization}\n                                                    username={entry.name}\n                                                />\n                                            ) : entry.avatarUrl ? (\n                                                <Image\n                                                    src={entry.avatarUrl}\n                                                    alt={entry.name}\n                                                    fill\n                                                    sizes=\"56px\"\n                                                    className=\"object-cover\"\n                                                />\n                                            ) : (\n                                                <span className=\"text-2xl\">{entry.icon || 'üë§'}</span>\n                                            )}\n                                        </div>\n\n                                        {/* Name and Subtext */}\n                                        <div className=\"flex-1 min-w-0\">\n                                            <div className=\"flex items-center gap-2 mb-1\">\n                                                <h3 className=\"text-lg md:text-2xl font-black text-[var(--text-primary)] truncate group-hover:text-[var(--brand-primary)] transition-colors\">\n                                                    {entry.name}\n                                                </h3>\n                                                {entry.isCurrentUser && (\n                                                    <span className=\"bg-[var(--brand-primary)] text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-tighter shadow-sm\">YOU</span>\n                                                )}\n                                            </div>\n                                            <p className=\"text-[var(--text-muted)] text-xs md:text-sm font-bold uppercase tracking-widest truncate\">\n                                                {entry.subtext}\n                                            </p>\n                                        </div>\n\n                                        {/* Value Display */}\n                                        <div className=\"text-right ml-4\">\n                                            <div className={`text-2xl md:text-4xl font-black tracking-tighter ${entry.rank <= 3 ? 'text-[var(--text-primary)]' : 'text-[var(--brand-primary)]'}`}>\n                                                {activeTab === 'business'\n                                                    ? `$${entry.value.toLocaleString()}`\n                                                    : activeTab === 'mastery'\n                                                        ? `${Math.round(entry.value * 100)}%`\n                                                        : entry.value.toLocaleString()}\n                                            </div>\n                                            <p className=\"text-[var(--text-muted)] text-[10px] md:text-[11px] font-black uppercase tracking-[0.2em]\">\n                                                {activeTab === 'business' ? 'Net Worth' : activeTab === 'streak' ? 'Current Streak' : activeTab === 'mastery' ? 'Overall Mastery' : 'Academic XP'}\n                                            </p>\n                                        </div>\n                                    </BrightLayer>\n                                </motion.div>\n                            ))}\n                        </AnimatePresence>\n                    ) : (\n                        <BrightLayer variant=\"glass\" className=\"py-20 text-center text-[var(--text-muted)] border-b-[8px] border-[var(--border-subtle)]\">\n                            <span className=\"text-5xl block mb-4\">üèúÔ∏è</span>\n                            <p className=\"font-black uppercase tracking-widest\">No legends have claimed this path yet.</p>\n                            <p className=\"text-xs font-medium mt-2\">Start learning to be the first name etched in history!</p>\n                        </BrightLayer>\n                    )}\n                </div>\n\n                {/* Personal Standing Card (Bottom Sticky) */}\n                {!loading && userData && (activeTab === 'xp' || activeTab === 'streak' || activeTab === 'mastery') && (\n                    <motion.div\n                        initial={{ opacity: 0, y: 50 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        className=\"mt-12\"\n                    >\n                        <BrightLayer variant=\"elevated\" className=\"border-b-[8px] border-[var(--brand-primary)] bg-[var(--bg-elevated)]/90 backdrop-blur-xl ring-1 ring-[var(--brand-primary)]/50 shadow-2xl\">\n                            <div className=\"flex flex-col md:flex-row justify-between items-center gap-6\">\n                                <div className=\"flex items-center gap-4\">\n                                    <div className=\"w-14 h-14 rounded-2xl bg-[var(--brand-primary)] text-white flex items-center justify-center text-2xl font-black shadow-lg\">\n                                        üëã\n                                    </div>\n                                    <div>\n                                        <p className=\"text-[var(--text-muted)] text-xs font-black uppercase tracking-widest mb-1\">Your Standing</p>\n                                        <h4 className=\"text-2xl font-black text-[var(--text-primary)]\">Keep rising, {userData.firstName}!</h4>\n                                    </div>\n                                </div>\n                                <div className=\"flex gap-10\">\n                                    <div className=\"text-left\">\n                                        <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest mb-1\">Total XP</p>\n                                        <p className=\"text-2xl font-black text-[var(--brand-primary)] tracking-tighter\">{userData.xp?.toLocaleString()}</p>\n                                    </div>\n                                    <div className=\"text-left\">\n                                        <p className=\"text-[var(--text-muted)] text-[10px] font-black uppercase tracking-widest mb-1\">Streak</p>\n                                        <p className=\"text-2xl font-black text-[var(--brand-accent)] tracking-tighter\">{userData.streak || 0}d üî•</p>\n                                    </div>\n                                    <BrightButton onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} size=\"sm\">\n                                        Top ‚¨ÜÔ∏è\n                                    </BrightButton>\n                                </div>\n                            </div>\n                        </BrightLayer>\n                    </motion.div>\n                )}\n            </div>\n\n            {/* Professor Bright Mascot Feedback */}\n            <ProfessorBrightMascot feedback={mascotFeedback} />\n        </div>\n    );\n}\n\nfunction AvatarRenderer({ customization, username }: { customization: any, username: string }) {\n    const svg = React.useMemo(() => {\n        const c = customization;\n        // Normalize for v9 local rendering which might expect clothesColor\n        const avatar = createAvatar(avataaars, {\n            seed: username,\n            backgroundColor: [c.backgroundColor || 'FF8A8A'],\n            top: [c.top || 'shortFlat'],\n            hairColor: [c.hairColor || '2c1b18'],\n            clothing: [c.clothing || 'blazerAndShirt'],\n            clothesColor: [c.clothingColor || c.clothesColor || '262e33'],\n            accessories: [c.accessories || 'blank'],\n            eyes: [c.eyes || 'default'],\n            mouth: [c.mouth || 'smile'],\n            skinColor: [c.skinColor || 'ffdbb4'],\n            facialHair: [c.facialHair || 'blank'],\n            backgroundType: ['solid']\n        });\n        return avatar.toString();\n    }, [customization, username]);\n\n    return (\n        <div\n            className=\"w-full h-full\"\n            dangerouslySetInnerHTML={{ __html: svg }}\n        />\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/learn/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[90,107],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2648,2651],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2648,2651],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":254,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7942,7945],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7942,7945],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'subjectName' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":314,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":314,"endColumn":28}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport Link from 'next/link'\nimport { useEffect, useState, Suspense } from 'react'\nimport { getSubjectFromSourceFile, getSubjectStyle } from '@/lib/subject-utils'\nimport { useAuth } from '@/lib/auth-context'\nimport { LearningPathNode, DailyTip, type NodeType, GuidebookModal, type GuidebookObjective } from '@/components/learning'\nimport MascotIllustration, { type MascotEmotion } from '@/components/learning/MascotIllustration'\n\ninterface SyllabusObjective {\n  id: string\n  objective: string\n  section: string\n  subsection: string\n  content: string\n  difficulty: number\n  source_file: string\n}\n\ninterface LearningModule {\n  id: string | number\n  title: string\n  subject: string\n  level: number\n  status: 'completed' | 'current' | 'locked'\n  stars: number\n  icon: string\n  color: string\n  borderColor: string\n  nodeType: NodeType\n  lastVisited?: string\n  mastery?: number\n}\n\n// =============================================================================\n// SKELETON LOADER COMPONENT\n// =============================================================================\n\nfunction SkeletonNode({ index }: { index: number }) {\n  const offsets = [0, -80, 0, 80]\n  const offset = offsets[index % 4]\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      transition={{ delay: index * 0.05 }}\n      className=\"flex flex-col items-center my-4\"\n      style={{ marginLeft: offset }}\n    >\n      <div className=\"w-20 h-20 rounded-full skeleton\" />\n      <div className=\"w-16 h-4 rounded-full skeleton mt-3\" />\n    </motion.div>\n  )\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <div className=\"max-w-2xl mx-auto px-6 py-8\">\n      {/* Header skeleton */}\n      <div className=\"text-center mb-12\">\n        <div className=\"w-48 h-10 skeleton mx-auto mb-4\" />\n        <div className=\"w-64 h-5 skeleton mx-auto\" />\n      </div>\n\n      {/* Subject filter skeleton */}\n      <div className=\"flex gap-3 mb-8 overflow-hidden\">\n        {[1, 2, 3].map(i => (\n          <div key={i} className=\"w-28 h-12 skeleton rounded-full flex-shrink-0\" />\n        ))}\n      </div>\n\n      {/* Nodes skeleton */}\n      <div className=\"relative\">\n        {Array.from({ length: 8 }).map((_, i) => (\n          <SkeletonNode key={i} index={i} />\n        ))}\n      </div>\n    </div>\n  )\n}\n\n// =============================================================================\n// STATS BAR COMPONENT\n// =============================================================================\n\nfunction StatsBar({ userData }: { userData: any }) {\n  const streak = userData?.streak || 0\n  const totalXp = userData?.totalXp || 0\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: -20 }}\n      animate={{ opacity: 1, y: 0 }}\n      className=\"flex justify-center gap-6 mb-8\"\n    >\n      {/* Streak */}\n      <div className=\"flex items-center gap-2 px-4 py-2 rounded-2xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\">\n        <span className=\"text-2xl\">üî•</span>\n        <div>\n          <div className=\"font-black text-lg text-orange-500\">{streak}</div>\n          <div className=\"text-xs font-bold text-[var(--text-muted)] uppercase\">Streak</div>\n        </div>\n      </div>\n\n      {/* XP */}\n      <div className=\"flex items-center gap-2 px-4 py-2 rounded-2xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\">\n        <span className=\"text-2xl\">‚ö°</span>\n        <div>\n          <div className=\"font-black text-lg text-[var(--brand-primary)]\">{totalXp.toLocaleString()}</div>\n          <div className=\"text-xs font-bold text-[var(--text-muted)] uppercase\">XP</div>\n        </div>\n      </div>\n    </motion.div>\n  )\n}\n\n// =============================================================================\n// SUBJECT FILTER COMPONENT\n// =============================================================================\n\nfunction SubjectFilter({\n  subjects,\n  selected,\n  onSelect\n}: {\n  subjects: string[]\n  selected: string | null\n  onSelect: (subject: string | null) => void\n}) {\n  if (subjects.length <= 1) return null\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ delay: 0.1 }}\n      className=\"relative px-6 mb-8\"\n    >\n      <div className=\"flex gap-3 overflow-x-auto pb-2 no-scrollbar\">\n        <button\n          onClick={() => onSelect(null)}\n          className={`filter-pill ${selected === null ? 'filter-pill-active' : 'filter-pill-inactive'}`}\n        >\n          All Subjects\n        </button>\n        {subjects.map((subject) => (\n          <button\n            key={subject}\n            onClick={() => onSelect(subject)}\n            className={`filter-pill ${selected === subject ? 'filter-pill-active' : 'filter-pill-inactive'}`}\n          >\n            {subject}\n          </button>\n        ))}\n      </div>\n    </motion.div>\n  )\n}\n\n// =============================================================================\n// HELPER FUNCTIONS\n// =============================================================================\n\n// Deterministic seeded random to prevent SSR/CSR hydration mismatches\nconst seededRandom = (id: string, salt: number): number => {\n  let hash = 0\n  const str = `${id}-${salt}`\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i)\n    hash = ((hash << 5) - hash) + char\n    hash |= 0 // Convert to 32-bit integer\n  }\n  return Math.abs(hash % 1000) / 1000\n}\n\nconst getHorizontalOffset = (index: number, nodeType: NodeType) => {\n  if (nodeType === 'boss') return 0\n  // Sine wave distribution for a smoother \"winding\" road\n  // Using 100 amplitude for better visual flow while staying within bounds\n  const amplitude = 100\n  const phase = (index * Math.PI) / 2.5 // Slightly offset phase for natural winding\n  return Math.sin(phase) * amplitude\n}\n\nconst getMascotEmotion = (index: number): MascotEmotion => {\n  const emotions: MascotEmotion[] = ['happy', 'thinking', 'idea', 'wink', 'smart', 'studying', 'reading', 'magic']\n  return emotions[index % emotions.length]\n}\n\n// =============================================================================\n// MAIN PAGE COMPONENTS\n// =============================================================================\n\nexport default function LearnPage() {\n  return (\n    <Suspense fallback={<LoadingSkeleton />}>\n      <LearnContent />\n    </Suspense>\n  )\n}\n\nfunction LearnContent() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const [isMounted, setIsMounted] = useState(false)\n\n  useEffect(() => {\n    setIsMounted(true)\n  }, [])\n\n  const shouldAnimateUnlock = isMounted && searchParams?.get('animation') === 'unlock'\n  const { user, userData, loading: authLoading } = useAuth()\n  const onboardingCompleted = userData?.onboardingCompleted === true\n\n  const [learningModules, setLearningModules] = useState<LearningModule[]>([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n  const [subjects, setSubjects] = useState<string[]>([])\n  const [selectedSubject, setSelectedSubject] = useState<string | null>(null)\n  const [guidebookState, setGuidebookState] = useState<{\n    isOpen: boolean\n    moduleNumber: number\n    title: string\n    objectives: GuidebookObjective[]\n    theme: 'startup' | 'growth' | 'mastery' | 'default'\n  }>({\n    isOpen: false,\n    moduleNumber: 1,\n    title: '',\n    objectives: [],\n    theme: 'default'\n  })\n\n  useEffect(() => {\n    if (authLoading) return\n    if (!user) {\n      router.push('/')\n      return\n    }\n\n    const currentUser = user\n\n    async function fetchLearningPath() {\n      try {\n        setLoading(true)\n\n        const onboardingData = localStorage.getItem('brighted_onboarding')\n        const uid = currentUser.uid\n        const token = await currentUser.getIdToken()\n\n        let userProgress: Record<string, any> = {}\n        try {\n          const progressRes = await fetch(`/api/progress?userId=${uid}`, {\n            headers: { 'Authorization': `Bearer ${token}` },\n            cache: 'no-store'\n          })\n          if (progressRes.ok) {\n            const progressJson = await progressRes.json()\n            userProgress = progressJson?.progress && typeof progressJson.progress === 'object'\n              ? progressJson.progress\n              : {}\n          }\n        } catch {\n          userProgress = {}\n        }\n\n        let userSubjects: string[] = []\n        const firestoreSubjects = userData?.subjects\n        if (Array.isArray(firestoreSubjects) && firestoreSubjects.length > 0) {\n          userSubjects = firestoreSubjects\n        } else if (onboardingData) {\n          const data = JSON.parse(onboardingData)\n          userSubjects = data.subjects || []\n        }\n\n        const params = new URLSearchParams()\n        if (userSubjects.length > 0) params.set('subjects', userSubjects.join(','))\n\n        const res = await fetch('/api/learning-path?' + params, {\n          headers: { 'Authorization': `Bearer ${token}` }\n        })\n        if (!res.ok) throw new Error('Failed to fetch learning path')\n\n        const pathData = await res.json()\n        const pathsBySubject: { [subject: string]: SyllabusObjective[] } = pathData.paths || {}\n\n        const availableSubjects = Object.keys(pathsBySubject)\n        setSubjects(availableSubjects)\n\n        let currentSubject = selectedSubject\n        if (!currentSubject && availableSubjects.length > 0) {\n          currentSubject = availableSubjects[0]\n          setSelectedSubject(currentSubject)\n        }\n\n        let objectives: SyllabusObjective[] = []\n        if (currentSubject && pathsBySubject[currentSubject]) {\n          objectives = pathsBySubject[currentSubject]\n        } else {\n          objectives = Object.values(pathsBySubject).flat()\n        }\n\n        const mappedModules: LearningModule[] = objectives.map((obj, index) => {\n          const style = getSubjectStyle(getSubjectFromSourceFile(obj.source_file))\n          const progress = userProgress[obj.id]\n          const prevObj = index > 0 ? objectives[index - 1] : null\n          const prevProgress = prevObj ? userProgress[prevObj.id] : null\n          const stars = progress?.stars ?? 0\n          const prevStars = prevProgress?.stars ?? 0\n\n          const subjectName = getSubjectFromSourceFile(obj.source_file)\n          const isProgressEmpty = Object.keys(userProgress).length === 0\n\n          let title = obj.objective || 'Untitled Objective'\n          title = title.replace(/\\(.*?mark.*?\\)/gi, '').trim()\n          title = title.replace(/^[‚Ä¢\\-\\*]\\s*/, '').trim()\n\n          if (isProgressEmpty && index === 0) {\n            title = \"Module 1: Orientation\"\n          }\n          if (title.length > 50) title = title.substring(0, 47) + '...'\n          if (title.length === 0) title = `Objective ${obj.id}`\n\n          let status: LearningModule['status'] = 'locked'\n          if (index === 0) {\n            status = stars >= 3 ? 'completed' : 'current'\n          } else if (prevStars >= 3) {\n            status = stars >= 3 ? 'completed' : 'current'\n          }\n\n          let nodeType: NodeType = 'standard'\n          if ((index + 1) % 5 === 0) {\n            nodeType = 'boss'\n          } else if (obj.difficulty >= 3 && seededRandom(obj.id, index) < 0.15) {\n            nodeType = 'crisis'\n          } else if (\n            obj.content?.toLowerCase().includes('rapid') ||\n            obj.content?.toLowerCase().includes('speed') ||\n            seededRandom(obj.id, index + 1000) < 0.1\n          ) {\n            nodeType = 'crunch'\n          } else if (status === 'completed' && progress?.lastVisited) {\n            const daysSinceVisit = Math.floor(\n              (Date.now() - new Date(progress.lastVisited).getTime()) / (1000 * 60 * 60 * 24)\n            )\n            if (daysSinceVisit >= 3) {\n              nodeType = 'maintenance'\n            }\n          }\n\n          return {\n            id: obj.id,\n            title,\n            subject: getSubjectFromSourceFile(obj.source_file),\n            level: obj.difficulty || 1,\n            status,\n            stars,\n            mastery: progress?.mastery || 0,\n            nodeType,\n            lastVisited: progress?.lastVisited,\n            ...style\n          }\n        })\n\n        setLearningModules(mappedModules)\n      } catch (err) {\n        console.error(\"Error fetching learning path:\", err)\n        setError(err instanceof Error ? err.message : 'Failed to load learning path.')\n      } finally {\n        setLoading(false)\n      }\n    }\n\n    fetchLearningPath()\n  }, [selectedSubject, user, userData, authLoading, router])\n\n  const handleResetProgress = async () => {\n    if (!confirm('Are you sure you want to reset your learning progress? This cannot be undone.')) {\n      return\n    }\n\n    try {\n      if (!user) throw new Error('Not authenticated')\n      const token = await user.getIdToken()\n      await fetch(`/api/progress?userId=${user.uid}`, {\n        method: 'DELETE',\n        headers: { 'Authorization': `Bearer ${token}` }\n      })\n      window.location.reload()\n    } catch (e) {\n      alert('Failed to reset progress')\n      console.error(e)\n    }\n  }\n\n  // Loading state\n  if (loading) {\n    return <LoadingSkeleton />\n  }\n\n  // Error state\n  if (error) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"text-center max-w-md p-8 rounded-3xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\"\n        >\n          <div className=\"text-6xl mb-4\">üòÖ</div>\n          <h2 className=\"text-2xl font-black mb-2 text-[var(--text-primary)]\">Oops!</h2>\n          <p className=\"text-[var(--text-secondary)] mb-6\">{error}</p>\n          {!onboardingCompleted ? (\n            <Link href=\"/welcome\" className=\"duo-btn duo-btn-primary\">\n              Complete Onboarding\n            </Link>\n          ) : (\n            <button\n              onClick={() => window.location.reload()}\n              className=\"duo-btn duo-btn-primary\"\n            >\n              Try Again\n            </button>\n          )}\n        </motion.div>\n      </div>\n    )\n  }\n\n  // Empty state\n  if (learningModules.length === 0) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"text-center max-w-md p-8 rounded-3xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\"\n        >\n          <div className=\"text-6xl mb-4\">üìö</div>\n          <h2 className=\"text-2xl font-black mb-2 text-[var(--text-primary)]\">No Lessons Yet</h2>\n          <p className=\"text-[var(--text-secondary)] mb-6\">Complete your onboarding to start learning!</p>\n          <Link href=\"/welcome\" className=\"duo-btn duo-btn-primary\">\n            Get Started\n          </Link>\n        </motion.div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] overflow-x-hidden\">\n      {/* Gradient Background */}\n      <div className=\"fixed inset-0 pointer-events-none\">\n        <div className=\"absolute inset-0 bg-gradient-to-b from-[var(--brand-primary)]/5 via-transparent to-transparent\" />\n      </div>\n\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"relative pt-8 pb-4 px-6\"\n      >\n        <div className=\"max-w-2xl mx-auto text-center\">\n          <motion.h1\n            className=\"text-4xl md:text-5xl font-black mb-2\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.1 }}\n          >\n            <span className=\"text-gradient\">Learning Path</span>\n          </motion.h1>\n          <motion.p\n            className=\"text-[var(--text-secondary)] text-lg\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ delay: 0.2 }}\n          >\n            Your personalized journey to CXC success\n          </motion.p>\n        </div>\n      </motion.header>\n\n      {/* Stats Bar */}\n      <StatsBar userData={userData} />\n\n      {/* Subject Filter */}\n      <SubjectFilter\n        subjects={subjects}\n        selected={selectedSubject}\n        onSelect={setSelectedSubject}\n      />\n\n      {/* Daily Tip */}\n      <div className=\"relative px-6 mb-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <DailyTip />\n        </div>\n      </div>\n\n      {/* Learning Path */}\n      <div className=\"relative max-w-3xl mx-auto px-6 pb-32 flex flex-col items-center w-full\">\n        {learningModules.map((module, index) => {\n          const isUnlocking = shouldAnimateUnlock && module.status === 'current' && index > 0\n\n          const currentOffset = getHorizontalOffset(index, module.nodeType)\n\n          // Determine if we should show a mascot near this node\n          // Show every 4 nodes, alternating sides\n          const showMascot = index > 0 && index % 4 === 0\n          const mascotSide = (index / 4) % 2 === 0 ? 'right' : 'left'\n          const mascotOffset = mascotSide === 'right' ? currentOffset + 180 : currentOffset - 180\n\n          return (\n            <div\n              key={module.id}\n              className=\"relative flex flex-col items-center z-10 w-full min-h-[180px]\"\n            >\n              {/* Mascot Decoration */}\n              {showMascot && (\n                <div\n                  className=\"absolute top-0 pointer-events-none z-0\"\n                  style={{ left: `calc(50% + ${mascotOffset}px)`, transform: 'translateX(-50%)' }}\n                >\n                  <MascotIllustration\n                    emotion={getMascotEmotion(index)}\n                    scale={0.8}\n                  />\n                </div>\n              )}\n\n              {/* Node itself */}\n              <div style={{ transform: `translateX(${currentOffset}px)` }}>\n                <LearningPathNode\n                  {...module}\n                  id={String(module.id)}\n                  index={index}\n                  isUnlocking={isUnlocking}\n                />\n              </div>\n\n\n            </div>\n          )\n        })}\n      </div>\n\n      {/* Reset Progress Button */}\n      <div className=\"fixed bottom-6 right-6 z-50\">\n        <details className=\"bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded-2xl shadow-xl\">\n          <summary className=\"px-4 py-2 cursor-pointer text-sm font-bold text-[var(--text-muted)] hover:text-[var(--text-primary)]\">\n            ‚öôÔ∏è Options\n          </summary>\n          <div className=\"p-4 border-t border-[var(--border-subtle)]\">\n            <button\n              onClick={handleResetProgress}\n              className=\"text-sm font-bold text-red-500 hover:text-red-400\"\n            >\n              Reset Progress\n            </button>\n          </div>\n        </details>\n      </div>\n\n      {/* Guidebook Modal */}\n      <GuidebookModal\n        isOpen={guidebookState.isOpen}\n        onClose={() => setGuidebookState(prev => ({ ...prev, isOpen: false }))}\n        moduleNumber={guidebookState.moduleNumber}\n        title={guidebookState.title}\n        subject={selectedSubject || 'General'}\n        objectives={guidebookState.objectives}\n        theme={guidebookState.theme}\n      />\n    </div>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/lesson/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[31,42],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DuoProgressBar' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DuoProgressBar"},"fix":{"range":[367,383],"text":""},"desc":"Remove unused variable \"DuoProgressBar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'starJustEarned' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":107,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":107,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isTransitioning' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":124,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":124,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9302,9305],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9302,9305],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useRef, useCallback, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport Link from 'next/link'\nimport { useAuth } from '@/lib/auth-context'\nimport { useQuestionLoader } from '@/hooks/useQuestionLoader'\nimport { DuoSessionLayout, DuoProgressBar } from '@/components/simulation/DuoSessionLayout'\nimport DecisionCard from '@/components/simulation/DecisionCard'\nimport { DuoActionBar } from '@/components/simulation/DuoActionBar'\nimport { DuoMascotBubble } from '@/components/simulation/DuoMascotBubble'\nimport ExplanationPanel from '@/components/learning/ExplanationPanel'\nimport { LevelCompletionScreen, StreakCelebration } from '@/components/learning'\nimport { getProfessorBrightFeedback, FeedbackResponse } from '@/lib/professor-bright'\n\ninterface SimulationStep {\n  id: number\n  type: 'decision' | 'outcome' | 'explanation' | 'reflection'\n  content: string\n  options?: string[]\n  correctAnswer?: number\n  subSkills?: string[]\n  questionDifficulty?: number\n  explanation?: string\n  relatedConcepts?: string[]\n}\n\ninterface SessionStats {\n  questionsAnswered: number\n  correctAnswers: number\n  streak: number\n  xpGained: number\n}\n\nfunction LessonLoadingFallback() {\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n      <div className=\"text-center\">\n        <div className=\"w-16 h-16 rounded-full border-4 border-t-[var(--brand-primary)] border-r-transparent border-b-[var(--brand-primary)] border-l-transparent animate-spin mx-auto mb-6\" />\n        <h2 className=\"text-2xl font-black text-[var(--text-primary)] mb-2\">Loading Lesson</h2>\n        <p className=\"text-[var(--text-muted)] animate-pulse\">Professor Bright is finding the perfect question...</p>\n      </div>\n    </div>\n  )\n}\n\nexport default function LessonPageWrapper() {\n  return (\n    <Suspense fallback={<LessonLoadingFallback />}>\n      <LessonPage />\n    </Suspense>\n  )\n}\n\nfunction LessonPage() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const objectiveId = searchParams?.get('objective') || searchParams?.get('objectiveId') || null\n  const subjectId = searchParams?.get('subject') || searchParams?.get('subjectId') || null\n  const { user, userData, loading: authLoading } = useAuth()\n\n  // Token Cache for authenticated requests\n  const tokenCache = useRef<{ token: string | null; expiry: number }>({ token: null, expiry: 0 })\n\n  const authenticatedFetch = useCallback(async (url: string, options: RequestInit = {}) => {\n    if (!user) throw new Error(\"No user found\")\n\n    let token = tokenCache.current.token\n    const now = Date.now()\n\n    if (!token || now > tokenCache.current.expiry) {\n      try {\n        token = await user.getIdToken(true)\n        tokenCache.current = { token, expiry: now + 5 * 60 * 1000 }\n      } catch (tokenError) {\n        console.error(\"Failed to refresh Firebase token:\", tokenError)\n        tokenCache.current = { token: null, expiry: 0 }\n        throw new Error(\"Authentication expired. Please log in again.\")\n      }\n    }\n\n    return fetch(url, {\n      ...options,\n      headers: {\n        ...options.headers,\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json',\n      },\n    })\n  }, [user])\n\n  // Question loader hook\n  const {\n    loading,\n    error,\n    simulationSteps,\n    setSimulationSteps,\n    objectiveInfo,\n    setObjectiveInfo,\n    questionVariation,\n    setQuestionVariation,\n    earnedStars,\n    setEarnedStars,\n    isComplete,\n    setIsComplete,\n    starJustEarned,\n    setStarJustEarned,\n    setLoading,\n    setError,\n  } = useQuestionLoader({\n    objectiveId,\n    subjectId,\n    user,\n    userData,\n    authLoading,\n    authenticatedFetch\n  })\n\n  // UI State\n  const [currentStep, setCurrentStep] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showFeedback, setShowFeedback] = useState(false)\n  const [isTransitioning, setIsTransitioning] = useState(false)\n  const [questionBuffer, setQuestionBuffer] = useState<SimulationStep[][]>([])\n  const [isAnswerCorrect, setIsAnswerCorrect] = useState<boolean | null>(null)\n  const [answerStartTime, setAnswerStartTime] = useState<number>(Date.now())\n\n  // Enhanced State\n  const [showExplanation, setShowExplanation] = useState(false)\n  const [sessionStats, setSessionStats] = useState<SessionStats>({\n    questionsAnswered: 0,\n    correctAnswers: 0,\n    streak: 0,\n    xpGained: 0\n  })\n\n  // NABLE State\n  const [nableResponse, setNableResponse] = useState<{\n    recommendedUIMood: string\n    currentStreak: number\n    confidence: number\n  } | null>(null)\n\n  // Professor Bright feedback and streak celebration\n  const [showStreakCelebration, setShowStreakCelebration] = useState(false)\n  const [professorFeedback, setProfessorFeedback] = useState<FeedbackResponse | null>(null)\n  const previousStreakRef = useRef<number>(0)\n\n  const step = simulationSteps[currentStep]\n\n  // Generate variation based on timestamp and objective\n  const variation = (parseInt(objectiveId?.replace(/\\D/g, '') || '0') || 0) % 10\n\n  // Prefetch next question\n  const prefetchNextQuestion = useCallback(async () => {\n    if (!objectiveId || !subjectId) return\n\n    const subjectParam = `&subjectId=${encodeURIComponent(subjectId)}`\n    const nextVariation = variation + questionBuffer.length + 1\n\n    try {\n      const masteryParam = userData?.mastery ? `&mastery=${userData.mastery}` : ''\n      const res = await authenticatedFetch(`/api/questions/generate?objectiveId=${objectiveId}&variation=${nextVariation}&useAI=false${subjectParam}${masteryParam}`)\n      if (res.ok) {\n        const data = await res.json()\n        if (data.simulationSteps && (data.objective?.subject === subjectId || !data.objective?.subject)) {\n          setQuestionBuffer(prev => [...prev, data.simulationSteps])\n        }\n      }\n    } catch (err) {\n      console.warn('Failed to prefetch next question:', err)\n    }\n  }, [objectiveId, subjectId, userData?.mastery, questionBuffer.length, variation, authenticatedFetch])\n\n  // Generate new question\n  const generateNewQuestion = useCallback(async () => {\n    if (!subjectId) {\n      setError('Subject information is missing. Please go back and select a subject.')\n      return\n    }\n\n    if (questionBuffer.length > 0) {\n      const nextQuestion = questionBuffer[0]\n      setQuestionBuffer(prev => prev.slice(1))\n      setSimulationSteps(nextQuestion)\n      setCurrentStep(0)\n      setSelectedAnswer(null)\n      setShowFeedback(false)\n      setShowExplanation(false)\n      setIsAnswerCorrect(null)\n      setAnswerStartTime(Date.now())\n\n      if (questionBuffer.length <= 2) {\n        prefetchNextQuestion()\n      }\n    } else {\n      setQuestionVariation(prev => prev + 1)\n      setCurrentStep(0)\n      setSelectedAnswer(null)\n      setShowFeedback(false)\n      setShowExplanation(false)\n      setIsAnswerCorrect(null)\n      setAnswerStartTime(Date.now())\n      setLoading(true)\n\n      try {\n        const subjectParam = `&subjectId=${encodeURIComponent(subjectId)}`\n        const masteryParam = userData?.mastery ? `&mastery=${userData.mastery}` : ''\n        const newVariation = questionVariation + 1\n        const res = await authenticatedFetch(`/api/questions/generate?objectiveId=${objectiveId}&variation=${newVariation}&useAI=false${subjectParam}${masteryParam}`)\n\n        if (!res.ok) {\n          const errorData = await res.json().catch(() => ({}))\n          throw new Error(errorData.error || 'Failed to generate question')\n        }\n\n        const data = await res.json()\n\n        if (data.objective?.subject && data.objective.subject !== subjectId) {\n          setError(`Subject mismatch: Got ${data.objective.subject} but expected ${subjectId}`)\n          return\n        }\n\n        if (data.simulationSteps && data.simulationSteps.length > 0) {\n          setSimulationSteps(data.simulationSteps)\n          setObjectiveInfo(data.objective)\n          setLoading(false)\n        } else {\n          throw new Error('No questions generated')\n        }\n      } catch (err) {\n        console.error('Error generating new question:', err)\n        setError('Failed to generate new question. Please try again.')\n        setLoading(false)\n      }\n    }\n  }, [subjectId, questionBuffer, questionVariation, objectiveId, userData?.mastery, setSimulationSteps, setObjectiveInfo, setLoading, setError, prefetchNextQuestion, authenticatedFetch, setQuestionVariation])\n\n  // Handle answer submission\n  const handleAnswer = async (answerIndex: number) => {\n    if (!user || !step) return\n\n    setSelectedAnswer(answerIndex)\n    setShowFeedback(true)\n    setIsTransitioning(true)\n\n    const isCorrect = answerIndex === step.correctAnswer\n    setIsAnswerCorrect(isCorrect)\n\n    const timeToAnswer = Math.round((Date.now() - answerStartTime) / 1000)\n\n    // Update session stats\n    setSessionStats(prev => ({\n      questionsAnswered: prev.questionsAnswered + 1,\n      correctAnswers: isCorrect ? prev.correctAnswers + 1 : prev.correctAnswers,\n      streak: isCorrect ? prev.streak + 1 : 0,\n      xpGained: prev.xpGained + (isCorrect ? 50 : 10)\n    }))\n\n    // Call NABLE Engine\n    try {\n      const resolvedQuestionId = (step as any)?.questionId || `${objectiveId}-${questionVariation}`\n      const nableRes = await authenticatedFetch('/api/nable/evaluate', {\n        method: 'POST',\n        body: JSON.stringify({\n          userId: user.uid,\n          questionId: resolvedQuestionId,\n          objectiveId: objectiveId,\n          selectedAnswer: answerIndex,\n          options: step.options || [],\n          timeToAnswer,\n          subSkills: Array.isArray(step.subSkills) && step.subSkills.length > 0 ? step.subSkills : [objectiveId].filter(Boolean),\n          questionDifficulty: step.questionDifficulty || objectiveInfo?.difficulty || 5\n        })\n      })\n\n      if (nableRes.ok) {\n        const nableData = await nableRes.json()\n\n        const nextStars = nableData?.progress?.stars\n        if (typeof nextStars === 'number') {\n          if (nextStars > earnedStars) {\n            setStarJustEarned(true)\n            setTimeout(() => setStarJustEarned(false), 1500)\n          }\n          setEarnedStars(nextStars)\n        }\n\n        if (nableData?.progress?.completed === true) {\n          setIsComplete(true)\n        }\n\n        setNableResponse({\n          recommendedUIMood: nableData.recommendedUIMood || 'Encouraging',\n          currentStreak: nableData.currentStreak || 0,\n          confidence: nableData.confidence,\n        })\n\n        // Generate Professor Bright feedback\n        const currentStreak = nableData.currentStreak || 0\n        const mastery = nableData.masteryDelta?.[objectiveId || ''] || 0.5\n        const feedback = getProfessorBrightFeedback(\n          isCorrect,\n          nableData.errorClassification,\n          currentStreak,\n          mastery,\n          timeToAnswer\n        )\n        setProfessorFeedback(feedback)\n\n        // Trigger streak celebration on milestones\n        const isMilestone = [5, 10, 15, 20].includes(currentStreak)\n        const wasNotAtMilestone = ![5, 10, 15, 20].includes(previousStreakRef.current)\n        if (isCorrect && isMilestone && wasNotAtMilestone) {\n          setShowStreakCelebration(true)\n        }\n        previousStreakRef.current = currentStreak\n\n        setTimeout(() => {\n          setShowExplanation(true)\n          setIsTransitioning(false)\n        }, 800)\n      }\n    } catch (err) {\n      const feedback = getProfessorBrightFeedback(isCorrect, null, 0, 0.5, timeToAnswer)\n      setProfessorFeedback(feedback)\n      console.warn('NABLE evaluation failed:', err)\n\n      setTimeout(() => {\n        setShowExplanation(true)\n        setIsTransitioning(false)\n      }, 800)\n    }\n\n    if (questionBuffer.length <= 2 && subjectId) {\n      prefetchNextQuestion()\n    }\n  }\n\n  const handleContinue = () => {\n    if (isComplete) {\n      return\n    }\n\n    if (earnedStars >= 3) {\n      setIsComplete(true)\n      return\n    }\n\n    setIsTransitioning(true)\n    setShowExplanation(false)\n    setShowFeedback(false)\n    setSelectedAnswer(null)\n    setIsAnswerCorrect(null)\n\n    setTimeout(() => {\n      generateNewQuestion()\n      setIsTransitioning(false)\n    }, 300)\n  }\n\n  const handleLevelComplete = () => {\n    router.push('/learn?animation=unlock')\n  }\n\n  const handleRetry = () => {\n    setIsComplete(false)\n    setEarnedStars(0)\n    setSessionStats({\n      questionsAnswered: 0,\n      correctAnswers: 0,\n      streak: 0,\n      xpGained: 0\n    })\n    generateNewQuestion()\n  }\n\n  // Loading state\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <div className=\"w-16 h-16 rounded-full border-4 border-t-[var(--brand-primary)] border-r-transparent border-b-[var(--brand-primary)] border-l-transparent animate-spin mx-auto mb-6\" />\n          <h2 className=\"text-2xl font-black text-[var(--text-primary)] mb-2\">Loading Lesson</h2>\n          <p className=\"text-[var(--text-muted)] animate-pulse\">Professor Bright is finding the perfect question...</p>\n        </div>\n      </div>\n    )\n  }\n\n  // Error state\n  if (error && simulationSteps.length === 0) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n        <div className=\"text-center max-w-md p-8 rounded-3xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\">\n          <div className=\"text-6xl mb-4\">üòÖ</div>\n          <h2 className=\"text-2xl font-black mb-2 text-[var(--text-primary)]\">Oops!</h2>\n          <p className=\"text-[var(--text-secondary)] mb-6\">{error}</p>\n          <Link\n            href=\"/learn\"\n            className=\"inline-block w-full py-4 rounded-2xl font-black text-white bg-[var(--brand-primary)] border-b-[6px] border-[#0284c7] hover:bg-[#0ea5e9] active:border-b-0 active:translate-y-[4px] transition-all uppercase tracking-widest\"\n          >\n            Go Back\n          </Link>\n        </div>\n      </div>\n    )\n  }\n\n  // Level Complete state\n  if (isComplete) {\n    const accuracy = sessionStats.questionsAnswered > 0\n      ? Math.round((sessionStats.correctAnswers / sessionStats.questionsAnswered) * 100)\n      : 0\n\n    return (\n      <LevelCompletionScreen\n        levelName={objectiveInfo?.title || 'Learning Objective'}\n        subject={subjectId || 'General'}\n        starsEarned={earnedStars}\n        totalStars={3}\n        streak={nableResponse?.currentStreak || sessionStats.streak}\n        masteryPercentage={Math.round((nableResponse?.confidence || 0.5) * 100)}\n        consistencyPercentage={userData?.consistency || 0}\n        xpGained={sessionStats.xpGained}\n        questionsAnswered={sessionStats.questionsAnswered}\n        accuracy={accuracy}\n        onContinue={handleLevelComplete}\n        onRetry={handleRetry}\n      />\n    )\n  }\n\n  if (!step) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n        <div className=\"text-center max-w-md p-8 rounded-3xl bg-[var(--bg-elevated)] border border-[var(--border-subtle)]\">\n          <p className=\"text-[var(--text-secondary)] mb-6\">No question available for this objective.</p>\n          <Link\n            href=\"/learn\"\n            className=\"inline-block w-full py-4 rounded-2xl font-black text-white bg-[var(--brand-primary)] border-b-[6px] border-[#0284c7] hover:bg-[#0ea5e9] active:border-b-0 active:translate-y-[4px] transition-all uppercase tracking-widest\"\n          >\n            Back to Path\n          </Link>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <DuoSessionLayout\n      currentStep={currentStep}\n      totalSteps={simulationSteps.length}\n      hearts={5} // Placeholder for lives system\n      streak={sessionStats.streak}\n      onClose={() => router.push('/learn')}\n    >\n      <div className=\"w-full py-4 md:py-8 max-w-2xl mx-auto\">\n        <AnimatePresence mode=\"wait\">\n          {showExplanation ? (\n            <ExplanationPanel\n              key=\"explanation\"\n              question={step.content}\n              selectedAnswer={step.options?.[selectedAnswer || 0] || 'No answer'}\n              correctAnswer={step.options?.[step.correctAnswer || 0] || 'Unknown'}\n              explanation={step.explanation || `The correct answer is \"${step.options?.[step.correctAnswer || 0]}\".`}\n              isCorrect={isAnswerCorrect || false}\n              relatedConcepts={step.relatedConcepts || []}\n              onContinue={handleContinue}\n              onTryAgain={!isAnswerCorrect ? handleRetry : undefined}\n            />\n          ) : (\n            <motion.div\n              key=\"question\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              transition={{ type: 'spring', stiffness: 300, damping: 30 }}\n            >\n              <DuoMascotBubble\n                content={step.content}\n                emotion={professorFeedback?.spriteClass || 'owl-happy'}\n              />\n\n              <div className=\"grid gap-4 mt-8\">\n                {step.options?.map((option: string, index: number) => (\n                  <DecisionCard\n                    key={index}\n                    option={option}\n                    index={index}\n                    isSelected={selectedAnswer === index}\n                    isCorrect={index === step.correctAnswer}\n                    showResult={showFeedback}\n                    disabled={showFeedback}\n                    onSelect={() => !showFeedback && setSelectedAnswer(index)}\n                  />\n                ))}\n              </div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n\n      {!showExplanation && (\n        <DuoActionBar\n          status={\n            showFeedback\n              ? (isAnswerCorrect ? 'correct' : 'wrong')\n              : (selectedAnswer !== null ? 'selected' : 'idle')\n          }\n          onCheck={() => selectedAnswer !== null && handleAnswer(selectedAnswer)}\n          onContinue={handleContinue}\n          feedbackTitle={isAnswerCorrect ? 'Excellent!' : 'Correct solution:'}\n          feedbackMessage={isAnswerCorrect ? professorFeedback?.message : step.options?.[step.correctAnswer || 0]}\n        />\n      )}\n\n      <div className=\"fixed inset-0 pointer-events-none z-50 flex items-center justify-center\">\n        <StreakCelebration\n          streak={sessionStats.streak}\n          show={showStreakCelebration}\n          onClose={() => setShowStreakCelebration(false)}\n        />\n      </div>\n    </DuoSessionLayout>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/login/forgot-password/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'sendPasswordResetEmail' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"sendPasswordResetEmail"},"fix":{"range":[119,175],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[813,816],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[813,816],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport Link from 'next/link';\nimport { motion } from 'framer-motion';\nimport { sendPasswordResetEmail } from 'firebase/auth';\n\nexport default function ForgotPasswordPage() {\n  const [email, setEmail] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [sent, setSent] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n    setLoading(true);\n\n    try {\n      const { sendPasswordResetEmail } = await import('firebase/auth');\n      const { getFirebaseAuth } = await import('@/lib/firebase');\n      const auth = getFirebaseAuth();\n      await sendPasswordResetEmail(auth, email);\n      setSent(true);\n    } catch (err: any) {\n      console.error('Password reset error:', err);\n      if (err?.code === 'auth/user-not-found') {\n        setError('No account found with this email address.');\n      } else if (err?.code === 'auth/invalid-email') {\n        setError('Please enter a valid email address.');\n      } else {\n        setError(err?.message ?? 'Failed to send reset email. Please try again.');\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col items-center justify-center p-6\">\n      <div className=\"w-full max-w-sm\">\n        <Link href=\"/login\" className=\"inline-block text-[var(--text-muted)] font-bold uppercase tracking-wider text-sm hover:text-[var(--text-primary)] transition-colors mb-8\">\n          ‚Üê Back to Log in\n        </Link>\n\n        <h1 className=\"text-3xl font-heading font-extrabold text-[var(--text-primary)] mb-2\">\n          Forgot password?\n        </h1>\n        <p className=\"text-[var(--text-muted)] text-sm mb-8\">\n          Enter your email and we&apos;ll send you a link to reset your password.\n        </p>\n\n        {sent ? (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"p-4 bg-green-100 text-green-800 rounded-2xl border-2 border-green-200 text-sm font-medium mb-6\"\n          >\n            Check your inbox. We&apos;ve sent a password reset link to <strong>{email}</strong>. If you don&apos;t see it, check your spam folder.\n          </motion.div>\n        ) : (\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <input\n              type=\"email\"\n              placeholder=\"Email\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              className=\"w-full bg-[var(--bg-elevated)] border-[2px] border-[var(--border-subtle)] rounded-2xl px-4 py-3.5 text-[var(--text-primary)] placeholder-[var(--text-muted)] font-medium outline-none focus:border-[var(--brand-secondary)] transition-all\"\n              required\n              autoComplete=\"email\"\n            />\n\n            {error && (\n              <motion.div\n                initial={{ opacity: 0, y: -10 }}\n                animate={{ opacity: 1, y: 0 }}\n                className=\"p-3 bg-red-100 text-red-600 rounded-xl text-sm font-bold border-2 border-red-200\"\n              >\n                {error}\n              </motion.div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white border-b-[4px] border-[#4338ca] active:border-b-0 active:translate-y-[4px] font-extrabold tracking-widest uppercase rounded-2xl px-6 py-3.5 text-sm transition-all disabled:opacity-50 disabled:grayscale\"\n            >\n              {loading ? 'SENDING...' : 'SEND RESET LINK'}\n            </button>\n          </form>\n        )}\n\n        <p className=\"text-center mt-6\">\n          <Link href=\"/login\" className=\"text-[var(--brand-secondary)] font-bold text-sm hover:underline\">\n            Back to Log in\n          </Link>\n        </p>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/login/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[32,43],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":11,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'authLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":11,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1141,1144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1141,1144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7099,7102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7099,7102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport { motion } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\n\nexport default function LoginPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [formData, setFormData] = useState({\n    email: '',\n    password: ''\n  });\n\n  // Redirect handled by AuthGate\n  /*\n  useEffect(() => {\n    if (!authLoading && user) {\n      router.push('/home');\n    }\n  }, [user, authLoading, router]);\n  */\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n\n    setLoading(true);\n\n    try {\n      const { signInWithEmailAndPassword } = await import('firebase/auth');\n      const { getFirebaseAuth } = await import('@/lib/firebase');\n      const auth = getFirebaseAuth();\n\n      await signInWithEmailAndPassword(auth, formData.email, formData.password);\n      router.push('/home');\n    } catch (err: any) {\n      console.error('Login error:', err);\n      if (err.message.includes('Firebase configuration is missing')) {\n        setError('Authentication service is temporarily unavailable. Please try again later.');\n      } else {\n        setError('Invalid email or password');\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col md:flex-row\">\n      {/* Left Panel: Branding & Mascot (Hidden on mobile) */}\n      <div className=\"hidden md:flex w-1/2 lg:w-[45%] bg-[var(--bg-secondary)] items-center justify-center p-8 relative overflow-hidden\">\n        <div className=\"absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10\" />\n\n        <div className=\"text-center relative z-10\">\n          <motion.div\n            initial={{ opacity: 0, scale: 0.8 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ duration: 0.5 }}\n            className=\"mb-8\"\n          >\n            <div className=\"owl-sprite owl-happy w-[200px] h-[200px] mx-auto scale-[1.5]\" />\n          </motion.div>\n\n          <h1 className=\"text-5xl font-heading font-extrabold text-[var(--brand-secondary)] mb-4\">BrightEd</h1>\n          <p className=\"text-xl font-bold text-[var(--text-secondary)] max-w-md mx-auto\">\n            The free, fun, and effective way to learn.\n          </p>\n        </div>\n      </div>\n\n      {/* Right Panel: Login Form */}\n      <div className=\"flex-1 flex flex-col items-center justify-center p-6 bg-[var(--bg-primary)] relative\">\n        {/* Mobile Header (Mascot) */}\n        <div className=\"md:hidden mb-8 text-center\">\n          <div className=\"owl-sprite owl-happy scale-[0.8] mx-auto mb-4\" />\n          <h1 className=\"text-3xl font-heading font-extrabold text-[var(--text-primary)]\">BrightEd</h1>\n        </div>\n\n        <div className=\"w-full max-w-sm\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <Link href=\"/\" className=\"text-[var(--text-muted)] font-bold uppercase tracking-wider text-sm hover:text-[var(--text-primary)] transition-colors\">\n              ‚Üê Back\n            </Link>\n            <Link href=\"/signup\" className=\"text-[var(--brand-secondary)] font-bold uppercase tracking-wider text-sm hover:brightness-110 transition-all\">\n              Create Account\n            </Link>\n          </div>\n\n          <h2 className=\"text-3xl font-heading font-extrabold text-[var(--text-primary)] mb-8 text-center md:text-left\">\n            Log in\n          </h2>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-4\">\n              <div className=\"relative group\">\n                <input\n                  type=\"email\"\n                  placeholder=\"Email\"\n                  value={formData.email}\n                  onChange={(e) => setFormData(p => ({ ...p, email: e.target.value }))}\n                  className=\"w-full bg-[var(--bg-elevated)] border-[2px] border-[var(--border-subtle)] rounded-2xl px-4 py-3.5 text-[var(--text-primary)] placeholder-[var(--text-muted)] font-medium outline-none focus:border-[var(--brand-secondary)] transition-all\"\n                  required\n                />\n              </div>\n\n              <div className=\"relative group\">\n                <input\n                  type=\"password\"\n                  placeholder=\"Password\"\n                  value={formData.password}\n                  onChange={(e) => setFormData(p => ({ ...p, password: e.target.value }))}\n                  className=\"w-full bg-[var(--bg-elevated)] border-[2px] border-[var(--border-subtle)] rounded-2xl px-4 py-3.5 text-[var(--text-primary)] placeholder-[var(--text-muted)] font-medium outline-none focus:border-[var(--brand-secondary)] transition-all\"\n                  required\n                />\n                <div className=\"absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] text-base\">\n                  {/* Icon placeholder if needed */}\n                </div>\n              </div>\n            </div>\n\n            {/* Error Message */}\n            {error && (\n              <motion.div\n                initial={{ opacity: 0, y: -10 }}\n                animate={{ opacity: 1, y: 0 }}\n                className=\"p-3 bg-red-100 text-red-600 rounded-xl text-sm font-bold border-2 border-red-200\"\n              >\n                {error}\n              </motion.div>\n            )}\n\n            <div className=\"pt-4\">\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white border-b-[4px] border-[#4338ca] active:border-b-0 active:translate-y-[4px] font-extrabold tracking-widest uppercase rounded-2xl px-6 py-3.5 text-sm transition-all disabled:opacity-50 disabled:grayscale\"\n              >\n                {loading ? 'SIGNING IN...' : 'LOG IN'}\n              </button>\n            </div>\n\n            <div className=\"flex items-center justify-between mt-6\">\n              <span className=\"h-[2px] flex-1 bg-[var(--border-subtle)]\" />\n              <span className=\"px-4 text-[var(--text-muted)] text-xs font-bold uppercase tracking-wider\">OR</span>\n              <span className=\"h-[2px] flex-1 bg-[var(--border-subtle)]\" />\n            </div>\n\n            <div className=\"flex justify-center mt-4\">\n              <button\n                type=\"button\"\n                onClick={async () => {\n                  try {\n                    setLoading(true);\n                    const { GoogleAuthProvider, signInWithPopup } = await import('firebase/auth');\n                    const { getFirebaseAuth } = await import('@/lib/firebase');\n                    \n                    const auth = getFirebaseAuth();\n                    const provider = new GoogleAuthProvider();\n                    await signInWithPopup(auth, provider);\n                    router.push('/home');\n                  } catch (err: any) {\n                    console.error('Google login error:', err);\n                    if (err.message.includes('Firebase configuration is missing')) {\n                      setError('Authentication service is temporarily unavailable. Please try again later.');\n                    } else {\n                      setError(err.message || 'Failed to sign in with Google');\n                    }\n                  } finally {\n                    setLoading(false);\n                  }\n                }}\n                className=\"bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] text-[var(--text-primary)] border-[2px] border-[var(--border-subtle)] border-b-[4px] active:border-b-[2px] active:translate-y-[2px] rounded-2xl px-6 py-3 flex items-center justify-center gap-2 transition-all\"\n              >\n                <svg viewBox=\"0 0 24 24\" width=\"24\" height=\"24\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <g transform=\"matrix(1, 0, 0, 1, 27.009001, -39.238998)\">\n                    <path fill=\"#4285F4\" d=\"M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z\" />\n                    <path fill=\"#34A853\" d=\"M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.444 63.239 -14.754 63.239 Z\" />\n                    <path fill=\"#FBBC05\" d=\"M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.724 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z\" />\n                    <path fill=\"#EA4335\" d=\"M -14.754 43.989 C -12.984 43.989 -11.404 44.599 -10.154 45.799 L -6.734 42.379 C -8.804 40.439 -11.514 39.239 -14.754 39.239 C -19.444 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z\" />\n                  </g>\n                </svg>\n                <span className=\"font-bold\">Google</span>\n              </button>\n            </div>\n\n            <div className=\"text-center mt-8\">\n              <Link href=\"/login/forgot-password\" className=\"text-[var(--brand-secondary)] font-bold text-sm hover:underline uppercase tracking-wide\">\n                Forgot password?\n              </Link>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":19,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useEffect"},"fix":{"range":[15,50],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useAuth' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":17,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useAuth"},"fix":{"range":[50,96],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRouter' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":19,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useRouter"},"fix":{"range":[96,141],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect } from 'react';\nimport { useAuth } from '@/lib/auth-context';\nimport { useRouter } from 'next/navigation';\nimport LandingDuolingo from '@/components/landing/LandingDuolingo';\n\nexport default function RootPage() {\n  return <LandingDuolingo />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/credit/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/market/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/meetings/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/operations/BusinessOperationsCommandCenter.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[125,155],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'collectDuePayments' is defined but never used. Allowed unused vars must match /^_/u.","line":37,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"collectDuePayments"},"fix":{"range":[1463,1485],"text":""},"desc":"Remove unused variable \"collectDuePayments\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'lastPayrollRunRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":69,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3642,3645],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3642,3645],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":143,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":143,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5231,5234],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5231,5234],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5442,5445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5442,5445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":159,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6199,6202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6199,6202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":185,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7220,7223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7220,7223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8794,8797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8794,8797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'newReview' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":242,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":242,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":277,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11475,11478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11475,11478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":283,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":283,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11777,11780],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11777,11780],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":328,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":328,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13492,13495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13492,13495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":469,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":469,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18468,18471],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18468,18471],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Link from 'next/link';\nimport { BrightHeading, BrightButton, BrightLayer } from '@/components/system';\nimport BusinessRegistration from '@/components/business/BusinessRegistration';\nimport BusinessDuolingoLayout from '@/components/business/BusinessDuolingoLayout';\nimport {\n  CinematicProvider,\n  useCinematic,\n  DashboardAmbience\n} from '@/components/cinematic';\nimport { OrderDashboard } from '@/components/business/OrderDashboard';\nimport { LoyaltyDashboard } from '@/components/business/LoyaltyDashboard';\nimport BusinessCard3D from '@/components/business/BusinessCard3D';\nimport { useAuth } from '@/lib/auth-context';\nimport { useBusiness } from '@/lib/business-context';\nimport { db } from '@/lib/firebase';\nimport { updateDoc, deleteDoc, doc } from 'firebase/firestore';\nimport BusinessWorkspace from '@/components/business/BusinessWorkspace';\nimport OrgChart from '@/components/business/OrgChart';\nimport PayrollManager from '@/components/business/PayrollManager';\nimport { BusinessStatsBar } from '@/components/business/BusinessStatsBar';\nimport InventoryPanel from '@/components/business/InventoryPanel';\nimport { useDialog } from '@/components/system';\nimport {\n  Order,\n  generateOrdersForTick,\n  saveNewOrders,\n  acceptOrder,\n  rejectOrder,\n  completeOrder,\n  failOrder,\n  updateBusinessFinancials,\n  updateOrderStatus,\n  collectDuePayments,\n  CustomerProfile,\n  createCustomerProfile,\n  updateEmployeeAfterTask,\n  initializeEmployeeSkills,\n  getLoyaltyTier\n} from '@/lib/economy';\n\nexport default function BusinessOperationsCommandCenter() {\n  return (\n    <CinematicProvider>\n      <CommandCenterContent />\n    </CinematicProvider>\n  );\n}\n\nfunction CommandCenterContent() {\n  const { user, userData, loading: authLoading } = useAuth();\n  const { economyRuntimeActive, economyBusiness, economyBusinessType, economyOrders, loading: businessLoading } = useBusiness();\n  const { showInterrupt } = useCinematic();\n  const { showConfirm, showAlert } = useDialog();\n  const [isRegistering, setIsRegistering] = useState(false);\n  const [activeFulfillmentOrder, setActiveFulfillmentOrder] = useState<Order | null>(null);\n\n  const [simHour, setSimHour] = useState(() => {\n    const h = new Date().getHours();\n    if (h < 6) return 6;\n    if (h > 22) return 22;\n    return h;\n  });\n  const lastTickRef = useRef<number>(Date.now());\n  const isPausedRef = useRef(false);\n  const lastPayrollRunRef = useRef<number>(0);\n  const lastAutoWorkRef = useRef<number>(0);\n  const lastWageAccrualRef = useRef<number>(0);\n\n  useEffect(() => {\n    if (!economyRuntimeActive) return;\n\n    const interval = setInterval(() => {\n      const h = new Date().getHours();\n      setSimHour(h < 6 ? 6 : h > 22 ? 22 : h);\n    }, 60000);\n\n    return () => clearInterval(interval);\n  }, [economyRuntimeActive]);\n\n  const business = economyBusiness;\n  const businessType = economyBusinessType;\n  const orders = economyOrders;\n  const loading = authLoading || businessLoading;\n\n  useEffect(() => {\n    if (!business || !businessType) return;\n    if (economyRuntimeActive) return;\n\n    const interval = setInterval(() => {\n      if (isPausedRef.current) return;\n\n      const now = Date.now();\n      const lastRecruit = business.lastRecruitmentTime ? new Date(business.lastRecruitmentTime).getTime() : 0;\n\n      if (now - lastRecruit >= 120000) {\n        const currentPool = business.recruitmentPool || [];\n        if (currentPool.length < 10) {\n          const numNew = Math.floor(Math.random() * 2) + 2;\n          const newCandidates: any[] = [];\n\n          for (let i = 0; i < numNew; i++) {\n            const roles = ['trainee', 'speedster', 'specialist', 'manager'];\n            const role = roles[Math.floor(Math.random() * roles.length)];\n            const baseStat = Math.floor(Math.random() * 40) + 30;\n\n            newCandidates.push({\n              id: `cand_${Date.now()}_${i}_${Math.random()}`,\n              name:\n                ['Alex', 'Sam', 'Jordan', 'Taylor', 'Casey', 'Riley'][Math.floor(Math.random() * 6)] +\n                ' ' +\n                ['Smith', 'Doe', 'Lee', 'Wong', 'Garcia', 'Patel'][Math.floor(Math.random() * 6)],\n              role: role,\n              salaryPerDay: Math.floor(baseStat * 1.5),\n              stats: {\n                speed: role === 'speedster' ? baseStat + 20 : baseStat,\n                quality: role === 'specialist' ? baseStat + 20 : baseStat,\n                morale: 100,\n              },\n              unpaidWages: 0,\n              hiredAt: new Date().toISOString(),\n            });\n          }\n\n          const bizRef = doc(db, 'businesses', business.id);\n          const updatedPool = [...currentPool, ...newCandidates].slice(0, 10);\n\n          updateDoc(bizRef, {\n            recruitmentPool: updatedPool,\n            lastRecruitmentTime: new Date().toISOString(),\n          });\n\n          if (newCandidates.length > 0) {\n            showInterrupt('luka', 'New candidates available in Recruitment!', 'happy');\n          }\n        }\n      }\n\n      if (business.employees && business.employees.length > 0) {\n        const hasManager = business.employees.some((e: any) => e.role === 'manager');\n\n        const roleCaps: Record<string, number> = { trainee: 2, speedster: 2, specialist: 3, manager: 4 };\n        const totalCapacity = business.employees.reduce((acc: number, e: any) => acc + (roleCaps[e.role] || 2), 0);\n        const activeOrderCount = orders.filter((o) => o.status === 'accepted' || o.status === 'in_progress').length;\n\n        if (hasManager && activeOrderCount < totalCapacity) {\n          const pendingOrders = orders\n            .filter((o) => o.status === 'pending')\n            .sort((a, b) => b.totalAmount - a.totalAmount);\n          const slotsAvailable = totalCapacity - activeOrderCount;\n          const toAccept = pendingOrders.slice(0, slotsAvailable);\n\n          if (toAccept.length > 0) {\n            toAccept.forEach((order) => {\n              const accepted = { ...order, status: 'accepted', acceptedAt: new Date().toISOString() };\n              updateOrderStatus(business.id, order.id, accepted as any);\n            });\n\n            if (Math.random() > 0.7) {\n              showInterrupt('luka', `Manager accepted ${toAccept.length} orders automatically.`, 'neutral');\n            }\n          }\n        }\n\n        if (now - lastAutoWorkRef.current >= 2000) {\n          const acceptedOrders = orders\n            .filter((o) => o.status === 'accepted')\n            .sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());\n\n          if (acceptedOrders.length > 0) {\n            const workPower = Math.max(1, Math.floor(business.employees.length / 1.5));\n            const ordersToComplete = acceptedOrders.slice(0, workPower);\n\n            if (ordersToComplete.length > 0) {\n              lastAutoWorkRef.current = now;\n\n              let cashEarned = 0;\n              let revenueEarned = 0;\n              let completedCount = 0;\n              let reputationDelta = 0;\n              const inventoryDeltas: Record<string, number> = {};\n              const customerProfileUpdates: Record<string, any> = {};\n\n              ordersToComplete.forEach((orderToProcess) => {\n                const reqInventory: Record<string, number> = {};\n                orderToProcess.items.forEach((item) => {\n                  const product = businessType.products.find((p) => p.id === item.productId);\n                  if (product?.requiresInventory && product.inventoryItemId) {\n                    reqInventory[product.inventoryItemId] =\n                      (reqInventory[product.inventoryItemId] || 0) + (product.inventoryPerUnit || 1) * item.quantity;\n                  }\n                });\n\n                const hasStock = Object.entries(reqInventory).every(\n                  ([itemId, qty]) => (business.inventory?.[itemId] || 0) >= qty\n                );\n\n                if (!hasStock) {\n                  const { order: failed, reputationPenalty } = failOrder(orderToProcess, 'stockout');\n                  updateOrderStatus(business.id, orderToProcess.id, failed);\n\n                  updateBusinessFinancials(business.id, {\n                    reputation: Math.max(0, business.reputation - reputationPenalty),\n                  });\n\n                  if (Math.random() > 0.5) {\n                    showInterrupt(\n                      'keisha',\n                      `We're out of stock for ${orderToProcess.customerName}'s order! I had to cancel it.`,\n                      'concerned'\n                    );\n                  }\n                  return;\n                }\n\n                const avgQuality =\n                  business.employees.reduce((acc: number, e: any) => acc + (e.stats?.quality || 50), 0) /\n                  business.employees.length;\n                const qualityScore = Math.min(100, Math.floor(avgQuality + (Math.random() * 20 - 10)));\n\n                // Get or create customer profile\n                const customerProfiles = business.customerProfiles || {};\n                let customerProfile = customerProfiles[orderToProcess.customerId] as CustomerProfile | undefined;\n                if (!customerProfile) {\n                  customerProfile = createCustomerProfile(orderToProcess.customerId, orderToProcess.customerName);\n                }\n\n                const completionResult = completeOrder(\n                  orderToProcess,\n                  qualityScore,\n                  businessType,\n                  customerProfile\n                );\n\n                const { order: completed, payment, tip, inventoryDeductions, loyaltyUpdate } = completionResult;\n\n                const stars = qualityScore >= 95 ? 6 : Math.ceil((qualityScore / 100) * 5);\n                const reviewText = stars === 6 ? 'Fast service!' : 'Good auto-service.';\n                const newReview = {\n                  id: `rev_${Date.now()}_${Math.random()}`,\n                  orderId: orderToProcess.id,\n                  customerName: orderToProcess.customerName,\n                  rating: stars,\n                  text: reviewText,\n                  timestamp: new Date().toISOString(),\n                };\n\n                cashEarned += payment + tip;\n                revenueEarned += payment + tip;\n                completedCount += 1;\n                if (stars >= 5) reputationDelta += 1;\n\n                Object.entries(inventoryDeductions).forEach(([itemId, qty]) => {\n                  inventoryDeltas[itemId] = (inventoryDeltas[itemId] || 0) - qty;\n                });\n\n                // Track customer profile updates\n                if (loyaltyUpdate) {\n                  const updatedProfile: CustomerProfile = {\n                    ...customerProfile,\n                    loyaltyScore: loyaltyUpdate.newScore,\n                    currentTier: getLoyaltyTier(loyaltyUpdate.newScore).tier,\n                    lastOrderDate: new Date().toISOString(),\n                    totalOrders: customerProfile.totalOrders + 1,\n                    lifetimeValue: customerProfile.lifetimeValue + orderToProcess.totalAmount,\n                  };\n                  customerProfileUpdates[orderToProcess.customerId] = updatedProfile;\n                }\n\n                updateOrderStatus(business.id, orderToProcess.id, completed);\n              });\n\n              // Update customer profiles in batch\n              const profileUpdates: any = {};\n              Object.entries(customerProfileUpdates).forEach(([customerId, profile]) => {\n                profileUpdates[`customerProfiles.${customerId}`] = profile;\n              });\n\n              // Award XP to employees\n              const updatedEmployees = business.employees.map((emp: any) => {\n                if (!emp.skills || Object.keys(emp.skills).length === 0) {\n                  emp.skills = initializeEmployeeSkills(emp.role);\n                }\n\n                const taskDifficulty = 'easy'; // Auto-work is easier\n                const primarySkill = emp.role === 'speedster' ? 'speed' : emp.role === 'specialist' ? 'quality' : 'customer_service';\n                const result = updateEmployeeAfterTask(emp, taskDifficulty, primarySkill);\n\n                return result.updatedEmployee;\n              });\n\n              const bizRef = doc(db, 'businesses', business.id);\n              updateDoc(bizRef, {\n                ...profileUpdates,\n                employees: updatedEmployees\n              });\n\n              updateBusinessFinancials(business.id, {\n                cashDelta: cashEarned,\n                totalRevenueDelta: revenueEarned,\n                ordersCompletedDelta: completedCount,\n                reputationDelta,\n                inventoryDeltas,\n              });\n\n              if (Math.random() > 0.7) {\n                showInterrupt('mendy', `Staff cleared ${ordersToComplete.length} orders. +‡∏ø${cashEarned}`, 'neutral');\n              }\n            }\n          }\n        }\n      }\n\n      if (now - lastTickRef.current >= 5000) {\n        lastTickRef.current = now;\n\n        setSimHour((prev) => {\n          const next = prev >= 22 ? 6 : prev + 1;\n          return next;\n        });\n\n        if (business.employees && business.employees.length > 0 && now - lastWageAccrualRef.current >= 360000) {\n          lastWageAccrualRef.current = now;\n          const bizRef = doc(db, 'businesses', business.id);\n          const updatedEmployees = business.employees.map((emp: any) => {\n            // Wage accumulates every 6 minutes (representing 1 sim hour)\n            // Daily wage is split over ~12 hours of operation\n            const hourlyWage = Math.floor(emp.salaryPerDay / 12);\n\n            // Unpaid wages pile up\n            const newUnpaid = (emp.unpaidWages || 0) + hourlyWage;\n\n            // Morale only drops if wages are severely overdue (> 2 days worth)\n            let moraleDrop = 0;\n            if (newUnpaid > emp.salaryPerDay * 2) moraleDrop = 5;\n\n            return {\n              ...emp,\n              unpaidWages: newUnpaid,\n              stats: {\n                ...emp.stats,\n                morale: Math.max(0, (emp.stats.morale || 100) - moraleDrop),\n              },\n            };\n          });\n\n          updateDoc(bizRef, { employees: updatedEmployees });\n          showInterrupt('mendy', 'Payroll updated. Check HR to pay staff.', 'neutral');\n        }\n\n        const activeCount = orders.filter((o) => o.status === 'accepted' || o.status === 'in_progress').length;\n\n        // Convert customer profiles to Map\n        const customerProfilesMap = new Map<string, CustomerProfile>();\n        if (business.customerProfiles) {\n          Object.entries(business.customerProfiles).forEach(([id, profile]) => {\n            customerProfilesMap.set(id, profile as CustomerProfile);\n          });\n        }\n\n        const newOrders = generateOrdersForTick(businessType, business, simHour, activeCount, 15, customerProfilesMap);\n\n        if (newOrders.length > 0) {\n          saveNewOrders(business.id, newOrders);\n          if (Math.random() > 0.7) {\n            showInterrupt('luka', `New order from ${newOrders[0].customerName}!`, 'happy');\n          }\n        }\n      }\n    }, 1000);\n\n    return () => clearInterval(interval);\n  }, [business, businessType, simHour, orders, showInterrupt, economyRuntimeActive]);\n\n  const handleAcceptOrder = async (orderId: string) => {\n    if (!business) return;\n    const order = orders.find((o) => o.id === orderId);\n    if (!order) return;\n\n    const accepted = acceptOrder(order);\n    await updateOrderStatus(business.id, orderId, accepted);\n\n    showInterrupt('luka', 'Order accepted! Watch the deadline.', 'neutral');\n  };\n\n  const handleRejectOrder = async (orderId: string) => {\n    if (!business) return;\n    const order = orders.find((o) => o.id === orderId);\n    if (!order) return;\n\n    const { order: rejected, reputationPenalty } = rejectOrder(order);\n    await updateOrderStatus(business.id, orderId, rejected);\n\n    const newRep = Math.max(0, business.reputation - reputationPenalty);\n    await updateBusinessFinancials(business.id, { reputation: newRep });\n\n    if (reputationPenalty > 2) {\n      showInterrupt('keisha', `${order.customerName} wasn't happy about the rejection.`, 'concerned');\n    }\n  };\n\n  const handleCompleteOrder = async (orderId: string, customQuality?: number) => {\n    if (!business) return;\n    const order = orders.find((o) => o.id === orderId);\n    if (!order) return;\n\n    const qualityScore = customQuality ?? Math.floor(60 + Math.random() * 40);\n\n    // Get or create customer profile\n    const customerProfiles = business.customerProfiles || {};\n    let customerProfile = customerProfiles[order.customerId] as CustomerProfile | undefined;\n    if (!customerProfile) {\n      customerProfile = createCustomerProfile(order.customerId, order.customerName);\n    }\n\n    const completionResult = completeOrder(\n      order,\n      qualityScore,\n      businessType ?? undefined,\n      customerProfile\n    );\n\n    const { order: completed, payment, tip, inventoryDeductions, loyaltyUpdate } = completionResult;\n\n    const currentInv = business.inventory || {};\n    const insufficientStock = Object.entries(inventoryDeductions).some(\n      ([itemId, qty]) => (currentInv[itemId] || 0) < qty\n    );\n\n    if (insufficientStock) {\n      showInterrupt('keisha', \"Wait! We don't have enough stock to fulfill this order!\", 'concerned');\n      return;\n    }\n\n    const stars = qualityScore >= 95 ? 6 : Math.ceil((qualityScore / 100) * 5);\n    const reviewText =\n      stars === 6\n        ? 'Absolutely legendary service!'\n        : stars === 5\n          ? 'Great experience, would recommend.'\n          : stars === 4\n            ? 'Good service.'\n            : stars === 3\n              ? 'Okay, but could be better.'\n              : 'Disappointing.';\n\n    const newReview = {\n      id: `rev_${Date.now()}`,\n      orderId: orderId,\n      customerName: order.customerName,\n      rating: stars,\n      text: reviewText,\n      timestamp: new Date().toISOString(),\n    };\n\n    const currentReviews = business.reviews || [];\n\n    await updateOrderStatus(business.id, orderId, completed);\n\n    const inventoryDeltas: Record<string, number> = {};\n    Object.entries(inventoryDeductions).forEach(([itemId, qty]) => {\n      inventoryDeltas[itemId] = (inventoryDeltas[itemId] || 0) - qty;\n    });\n\n    // Update customer profile if loyalty changed\n    const updates: any = {\n      cashDelta: payment + tip,\n      totalRevenueDelta: payment + tip,\n      reputation: Math.min(100, business.reputation + (stars >= 5 ? 2 : stars <= 2 ? -2 : 0)),\n      ordersCompletedDelta: 1,\n      reviews: [newReview, ...currentReviews].slice(0, 20),\n      inventoryDeltas,\n    };\n\n    if (loyaltyUpdate) {\n      // Update the customer profile with new loyalty data\n      const updatedProfile: CustomerProfile = {\n        ...customerProfile,\n        loyaltyScore: loyaltyUpdate.newScore,\n        currentTier: getLoyaltyTier(loyaltyUpdate.newScore).tier,\n        lastOrderDate: new Date().toISOString(),\n        totalOrders: customerProfile.totalOrders + 1,\n        lifetimeValue: customerProfile.lifetimeValue + order.totalAmount,\n      };\n\n      updates.customerProfileUpdate = {\n        customerId: order.customerId,\n        profile: updatedProfile\n      };\n    }\n\n    // Award XP to employees who worked on this order\n    if (business.employees && business.employees.length > 0) {\n      const taskDifficulty = order.totalAmount > 200 ? 'hard' : order.totalAmount > 100 ? 'medium' : 'easy';\n      const updatedEmployees = business.employees.map(emp => {\n        // Initialize skills if not present\n        if (!emp.skills || Object.keys(emp.skills).length === 0) {\n          emp.skills = initializeEmployeeSkills(emp.role);\n        }\n\n        // Award XP based on role\n        const primarySkill = emp.role === 'speedster' ? 'speed' : emp.role === 'specialist' ? 'quality' : 'customer_service';\n        const result = updateEmployeeAfterTask(emp, taskDifficulty, primarySkill, ['speed', 'quality']);\n\n        return result.updatedEmployee;\n      });\n\n      const bizRef = doc(db, 'businesses', business.id);\n      updateDoc(bizRef, { employees: updatedEmployees });\n    }\n\n    await updateBusinessFinancials(business.id, updates);\n\n    if (loyaltyUpdate && loyaltyUpdate.tierChanged) {\n      showInterrupt('luka', `${order.customerName} ${loyaltyUpdate.message}`, 'happy');\n    } else if (stars === 6) {\n      showInterrupt('luka', `WOAH! A 6-Star Legendary Review from ${order.customerName}!`, 'happy');\n    } else if (stars <= 2) {\n      showInterrupt('keisha', `Ouch. ${order.customerName} left a ${stars}-star review.`, 'concerned');\n    } else if (tip > 0) {\n      showInterrupt('mendy', `Awesome! Received ‡∏ø${payment} plus a ‡∏ø${tip} tip!`, 'happy');\n    }\n\n    setActiveFulfillmentOrder(null);\n  };\n\n  const handleStartFulfillment = (order: Order) => {\n    setActiveFulfillmentOrder(order);\n  };\n\n  if (authLoading || loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n      </div>\n    );\n  }\n\n  if (!business && !isRegistering) {\n    // Check for Orphaned State: User has flag but no business data found\n    if (userData?.hasBusiness && !loading) {\n      return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] relative overflow-hidden flex items-center justify-center\">\n          <DashboardAmbience cashBalance={0} />\n          <BrightLayer variant=\"glass\" padding=\"lg\" className=\"max-w-md w-full text-center border-red-500/30\">\n            <div className=\"text-4xl mb-4\">‚ö†Ô∏è</div>\n            <BrightHeading level={3} className=\"mb-2\">Data Sync Error</BrightHeading>\n            <p className=\"text-[var(--text-secondary)] mb-6 text-sm\">\n              Your account is flagged as having a business, but the operation center cannot find your files. This usually happens if a previous shutdown was interrupted.\n            </p>\n            <BrightButton\n              variant=\"danger\"\n              className=\"w-full\"\n              onClick={() => {\n                showConfirm(\n                  'Reset registration synchronization? This will restart your onboarding flow.',\n                  async () => {\n                    const token = await user?.getIdToken();\n                    if (!token) return;\n\n                    try {\n                      const res = await fetch('/api/business/shutdown', {\n                        method: 'POST',\n                        headers: { 'Authorization': 'Bearer ' + token }\n                      });\n\n                      if (res.ok) {\n                        window.location.reload();\n                      } else {\n                        showAlert('Failed to reset. Please try again.');\n                      }\n                    } catch (e) {\n                      console.error(e);\n                      showAlert('Connection error. Please check your network.');\n                    }\n                  },\n                  { title: 'RESET DATA?', type: 'danger' }\n                );\n              }}\n            >\n              Reset Registration\n            </BrightButton>\n          </BrightLayer>\n        </div>\n      )\n    }\n\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] relative overflow-hidden\">\n        <DashboardAmbience cashBalance={0} />\n\n        <main className=\"relative z-10 pt-32 pb-32 px-4 max-w-4xl mx-auto text-center\">\n          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className=\"py-20\">\n            <div className=\"max-w-md mx-auto mt-12\">\n              <BrightLayer\n                variant=\"glass\"\n                padding=\"lg\"\n                className=\"border-dashed border-2 border-[var(--brand-primary)]/30 backdrop-blur-sm\"\n              >\n                <div className=\"text-6xl mb-6\">üöÄ</div>\n                <BrightHeading level={2} className=\"mb-4\">\n                  Empire Awaits\n                </BrightHeading>\n                <p className=\"text-[var(--text-secondary)] mb-8 leading-relaxed\">\n                  Create your first legal entity to start playing through real-world business crises and opportunities.\n                </p>\n                <BrightButton variant=\"primary\" size=\"lg\" className=\"w-full\" onClick={() => setIsRegistering(true)}>\n                  Register First Venture\n                </BrightButton>\n              </BrightLayer>\n            </div>\n          </motion.div>\n        </main>\n      </div>\n    );\n  }\n\n  if (isRegistering) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] relative overflow-hidden pt-20\">\n        <div className=\"fixed top-8 right-8 z-50\">\n          <button onClick={() => setIsRegistering(false)} className=\"text-[var(--text-muted)] hover:text-white\">\n            ‚úï Close\n          </button>\n        </div>\n        <BusinessRegistration onComplete={() => setIsRegistering(false)} />\n      </div>\n    );\n  }\n\n  return (\n    <BusinessDuolingoLayout>\n      <div className=\"relative operations-page\">\n        <DashboardAmbience cashBalance={business!.cashBalance} />\n\n        <main className=\"relative z-10 pt-4 md:pt-10 pb-32 px-4 max-w-[1600px] mx-auto\">\n          <div className=\"mb-8 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4\">\n            <div>\n              <div className=\"text-xs font-black uppercase tracking-widest text-[var(--brand-primary)]\">Operations</div>\n              <BrightHeading level={1} className=\"leading-tight\">\n                Command Center\n              </BrightHeading>\n            </div>\n          </div>\n\n          {business && (\n            <div className=\"mb-8 grid grid-cols-1 lg:grid-cols-12 gap-8 items-end\">\n              <div className=\"lg:col-span-4 max-w-sm mx-auto w-full\">\n                <BusinessCard3D\n                  businessName={business.businessName}\n                  tier=\"Startup\"\n                  ownerName={user?.displayName || 'Unknown Director'}\n                  themeColor={business.branding?.themeColor}\n                  logoUrl={business.branding?.logoUrl}\n                  icon={business.branding?.icon}\n                />\n              </div>\n\n              <div className=\"lg:col-span-8 flex flex-col gap-6 w-full\">\n                <div className=\"flex flex-wrap justify-end items-center gap-4\">\n                  <BrightButton\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      isPausedRef.current = !isPausedRef.current;\n                      const btn = document.getElementById('pause-btn-text');\n                      if (btn) btn.innerText = isPausedRef.current ? 'RESUME OPERATION' : 'PAUSE OPERATION';\n                    }}\n                    className=\"text-[var(--text-muted)] hover:text-white border border-[var(--border-subtle)] flex-1 sm:flex-none justify-center\"\n                  >\n                    <span className=\"mr-2\">‚è∏</span> <span id=\"pause-btn-text\">PAUSE OPERATION</span>\n                  </BrightButton>\n                  <BrightButton\n                    variant=\"danger\"\n                    size=\"sm\"\n                    onClick={() => {\n                      showConfirm(\n                        'ARE YOU SURE? This will liquidate your business and delete all progress permanently.',\n                        async () => {\n                          await deleteDoc(doc(db, 'businesses', business.id));\n                        },\n                        { title: 'SHUTDOWN ENTITY', type: 'danger', confirmLabel: 'LIQUIDATE' }\n                      );\n                    }}\n                    className=\"bg-red-500/10 text-red-500 border-red-500/50 hover:bg-red-500 hover:text-white flex-1 sm:flex-none justify-center\"\n                  >\n                    SHUTDOWN\n                  </BrightButton>\n                </div>\n\n                <BusinessStatsBar\n                  businessState={business}\n                  pendingRevenue={orders\n                    .filter((o) => ['accepted', 'in_progress'].includes(o.status))\n                    .reduce((acc, o) => acc + o.totalAmount, 0)}\n                  earnedToday={business.ordersCompleted * 50}\n                />\n              </div>\n            </div>\n          )}\n\n          <div className=\"space-y-12\">\n            <div>\n              <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Workflow</div>\n              <BrightHeading level={2} className=\"text-3xl m-0\">Operations Console</BrightHeading>\n              {business && businessType && (\n                <div className=\"mt-6\">\n                  <OrderDashboard\n                    businessState={business}\n                    businessType={businessType}\n                    orders={orders}\n                    onAcceptOrder={handleAcceptOrder}\n                    onRejectOrder={handleRejectOrder}\n                    onCompleteOrder={handleCompleteOrder}\n                    onFulfill={handleStartFulfillment}\n                  />\n                </div>\n              )}\n            </div>\n\n            {/* Customer Loyalty Dashboard */}\n            {business && business.customerProfiles && Object.keys(business.customerProfiles).length > 0 && (\n              <div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">CRM</div>\n                <BrightHeading level={2} className=\"text-3xl m-0\">Customer Relationships</BrightHeading>\n                <div className=\"mt-6\">\n                  <LoyaltyDashboard\n                    customers={Object.values(business.customerProfiles).map(p => ({\n                      id: p.id,\n                      name: p.name,\n                      avatarSeed: p.avatarSeed,\n                      loyaltyScore: p.loyaltyScore,\n                      currentTier: p.currentTier,\n                      lastOrderDate: p.lastOrderDate,\n                      totalOrders: p.totalOrders,\n                      lifetimeValue: p.lifetimeValue\n                    }))}\n                  />\n                </div>\n              </div>\n            )}\n\n            <div className=\"space-y-12\">\n              <div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Team Management</div>\n                <BrightHeading level={2} className=\"text-3xl m-0\">Human Resources</BrightHeading>\n                <div className=\"mt-6 flex flex-col gap-10\">\n                  {business && <OrgChart business={business} />}\n                  {business && <PayrollManager business={business} />}\n                </div>\n              </div>\n\n              <div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Logistics</div>\n                <BrightHeading level={2} className=\"text-3xl m-0\">Warehouse Management</BrightHeading>\n                <div className=\"mt-6\">\n                  {business && <InventoryPanel inventory={business.inventory || {}} />}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <AnimatePresence>\n            {activeFulfillmentOrder && businessType && (\n              <BusinessWorkspace\n                order={activeFulfillmentOrder}\n                businessType={businessType}\n                onComplete={(quality) => handleCompleteOrder(activeFulfillmentOrder.id, quality)}\n                onCancel={() => setActiveFulfillmentOrder(null)}\n              />\n            )}\n          </AnimatePresence>\n        </main>\n      </div>\n    </BusinessDuolingoLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/operations/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/register/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightHeading' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightHeading"},"fix":{"range":[139,192],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[238,268],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'name' is defined but never used. Allowed unused args must match /^_/u.","line":14,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":31}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useRouter } from 'next/navigation';\nimport BusinessRegistration from '@/components/business/BusinessRegistration';\nimport { BrightHeading } from '@/components/system';\nimport { useAuth } from '@/lib/auth-context';\nimport Link from 'next/link';\nimport BusinessDuolingoLayout from '@/components/business/BusinessDuolingoLayout';\n\nexport default function BusinessRegisterPage() {\n  const router = useRouter();\n  const { user, loading } = useAuth();\n\n  const handleComplete = (name: string) => {\n    router.push('/practicals/business');\n    router.refresh();\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n      </div>\n    );\n  }\n\n  // Redirect if not logged in\n  if (!user) {\n    router.push('/login');\n    return null;\n  }\n\n  return (\n    <BusinessDuolingoLayout>\n      <div className=\"max-w-6xl mx-auto\">\n        <BusinessRegistration onComplete={handleComplete} />\n      </div>\n    </BusinessDuolingoLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/reports/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/stocks/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/supply/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/business/team/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-breathing-rate/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRef"},"fix":{"range":[50,58],"text":""},"desc":"Remove unused variable \"useRef\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[90,107],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useSensor' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useSensor"},"fix":{"range":[145,155],"text":""},"desc":"Remove unused variable \"useSensor\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useSensors' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useSensors"},"fix":{"range":[154,170],"text":""},"desc":"Remove unused variable \"useSensors\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PointerSensor' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PointerSensor"},"fix":{"range":[170,189],"text":""},"desc":"Remove unused variable \"PointerSensor\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TouchSensor' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"TouchSensor"},"fix":{"range":[132,231],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'exerciseTimer' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":118,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":118,"endColumn":25}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype ActivityLevel = 'rest' | 'walk' | 'jog' | 'sprint';\n\ninterface SubjectState {\n    activity: ActivityLevel;\n    breathRate: number; // Breaths per minute target\n    stamina: number; // 0-100\n    status: 'idle' | 'exercising' | 'recovering';\n}\n\nconst ACTIVITIES: { id: ActivityLevel; name: string; targetRate: number; duration: number; color: string; icon: string }[] = [\n    { id: 'rest', name: 'Resting', targetRate: 15, duration: 5, color: 'bg-blue-500', icon: 'üßò' },\n    { id: 'walk', name: 'Light Walk', targetRate: 25, duration: 10, color: 'bg-emerald-500', icon: 'üö∂' },\n    { id: 'jog', name: 'Jogging', targetRate: 45, duration: 15, color: 'bg-orange-500', icon: 'üèÉ' },\n    { id: 'sprint', name: 'Sprinting', targetRate: 65, duration: 10, color: 'bg-red-500', icon: '‚ö°' }\n];\n\n// ==========================================\n// BREATHING SUBJECT\n// ==========================================\n\nfunction BreathingSubject({\n    rate,\n    activity,\n    isExercising\n}: {\n    rate: number;\n    activity: ActivityLevel;\n    isExercising: boolean;\n}) {\n    // Animation duration for one breath cycle (in seconds)\n    // 60 seconds / breaths per minute = seconds per breath\n    const cycleDuration = 60 / (rate || 15);\n\n    return (\n        <div className=\"relative w-64 h-96 flex flex-col items-center justify-center\">\n            {/* Stick Figure / Subject Representation */}\n            <div className=\"relative z-10\">\n                {/* Head */}\n                <div className=\"w-20 h-20 rounded-full bg-zinc-200 border-4 border-zinc-400 mb-2 relative overflow-hidden\">\n                    {/* Face Expression */}\n                    <div className=\"absolute top-6 left-5 w-3 h-3 bg-zinc-800 rounded-full\" />\n                    <div className=\"absolute top-6 right-5 w-3 h-3 bg-zinc-800 rounded-full\" />\n                    <div className={`absolute bottom-5 left-1/2 -translate-x-1/2 w-8 h-2 bg-zinc-800 rounded-full transition-all ${rate > 40 ? 'h-6 rounded-3xl' : ''}`} />\n\n                    {/* Sweat Drops */}\n                    {(activity === 'jog' || activity === 'sprint') && isExercising && (\n                        <motion.div\n                            animate={{ y: [0, 20], opacity: [1, 0] }}\n                            transition={{ repeat: Infinity, duration: 0.8 }}\n                            className=\"absolute top-2 right-2 text-blue-400 text-xl\"\n                        >\n                            üíß\n                        </motion.div>\n                    )}\n                </div>\n\n                {/* Torso (Lungs) */}\n                <motion.div\n                    animate={{\n                        scaleX: [1, 1.15, 1],\n                        scaleY: [1, 1.05, 1],\n                        backgroundColor: rate > 50 ? '#ef4444' : rate > 30 ? '#f97316' : '#3b82f6'\n                    }}\n                    transition={{\n                        duration: cycleDuration,\n                        ease: \"easeInOut\",\n                        repeat: Infinity\n                    }}\n                    className=\"w-32 h-40 rounded-3xl bg-blue-500 border-4 border-blue-700 relative z-20 flex items-center justify-center\"\n                >\n                    <div className=\"text-white/20 font-black text-4xl tracking-tighter\">LUNGS</div>\n                </motion.div>\n\n                {/* Arms */}\n                <motion.div\n                    animate={isExercising ? { rotate: [0, 20, -20, 0] } : { rotate: 0 }}\n                    transition={{ duration: 0.5, repeat: Infinity }}\n                    className=\"absolute top-24 -left-8 w-8 h-32 bg-zinc-300 rounded-full z-0 origin-top\"\n                />\n                <motion.div\n                    animate={isExercising ? { rotate: [0, -20, 20, 0] } : { rotate: 0 }}\n                    transition={{ duration: 0.5, repeat: Infinity, delay: 0.25 }}\n                    className=\"absolute top-24 -right-8 w-8 h-32 bg-zinc-300 rounded-full z-0 origin-top\"\n                />\n            </div>\n\n            {/* Ground Shadow */}\n            <div className=\"absolute bottom-0 w-48 h-8 bg-black/20 rounded-full blur-xl\" />\n        </div>\n    );\n}\n\n// ==========================================\n// MAIN LAB: BREATHING RATE\n// ==========================================\n\nexport default function BreathingRateLabPage() {\n    const [status, setStatus] = useState<SubjectState['status']>('idle');\n    const [activeActivity, setActiveActivity] = useState<ActivityLevel>('rest');\n    const [currentRate, setCurrentRate] = useState(15);\n    const [exerciseTimer, setExerciseTimer] = useState(0);\n\n    // Stopwatch\n    const [stopwatchTime, setStopwatchTime] = useState(0);\n    const [isStopwatchRunning, setIsStopwatchRunning] = useState(false);\n\n    // Data\n    const [recordedData, setRecordedData] = useState<{ activity: string; rate: number }[]>([]);\n    const [userGuess, setUserGuess] = useState(\"\");\n    const [showSuccess, setShowSuccess] = useState(false);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint } = useProfessor({\n        initialMessage: \"Select an activity to perform, then use the stopwatch to count the breathing rate!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    // Exercise Simulation\n    useEffect(() => {\n        let interval: NodeJS.Timeout;\n\n        if (status === 'exercising') {\n            interval = setInterval(() => {\n                setExerciseTimer(prev => {\n                    const next = prev - 1;\n                    if (next <= 0) {\n                        setStatus('recovering');\n                        // Set target rate based on activity\n                        const target = ACTIVITIES.find(a => a.id === activeActivity)?.targetRate || 15;\n                        setCurrentRate(target);\n                        showProfessorSuccess(\"Exercise complete! Measure the breathing rate now.\");\n                        return 0;\n                    }\n                    return next;\n                });\n            }, 1000);\n        } else if (status === 'recovering') {\n            // Slowly return to rest rate over time\n            interval = setInterval(() => {\n                setCurrentRate(prev => {\n                    if (prev <= 15) {\n                        setStatus('idle');\n                        return 15;\n                    }\n                    return prev - 0.5; // Cool down\n                });\n            }, 1000);\n        }\n\n        return () => clearInterval(interval);\n    }, [status, activeActivity, showProfessorSuccess]);\n\n    // Stopwatch logic\n    useEffect(() => {\n        let interval: NodeJS.Timeout;\n        if (isStopwatchRunning) {\n            interval = setInterval(() => {\n                setStopwatchTime(prev => prev + 1);\n            }, 1000);\n        }\n        return () => clearInterval(interval);\n    }, [isStopwatchRunning]);\n\n    const handleStartExercise = (activityId: ActivityLevel) => {\n        if (status === 'exercising') return;\n\n        const activity = ACTIVITIES.find(a => a.id === activityId);\n        if (!activity) return;\n\n        setActiveActivity(activityId);\n        setExerciseTimer(activity.duration);\n        setStatus('exercising');\n        // Ramp up rate visually during exercise\n        setCurrentRate(activity.targetRate);\n    };\n\n    const handleRecord = () => {\n        const rate = parseInt(userGuess);\n        if (isNaN(rate) || rate <= 0) {\n            showWarning(\"Enter a valid number for breaths per minute.\");\n            return;\n        }\n\n        // Logic check: Is the guess close to the actual rate? (Simulated margin of error)\n        // Rate changes during recovery so we check against currentRate\n        const margin = 10;\n        if (Math.abs(rate - currentRate) > margin) {\n            showHint(`That seems off. Count the chest movements for 15 seconds and multiply by 4. (Current approx: ~${Math.round(currentRate)})`);\n        } else {\n            setRecordedData(prev => [...prev, { activity: ACTIVITIES.find(a => a.id === activeActivity)?.name || 'Unknown', rate }]);\n            showProfessorSuccess(`Great measurement! ${rate} bpm recorded.`);\n            setUserGuess(\"\");\n\n            if (recordedData.length >= 2) {\n                setTimeout(() => handleFinish(), 2000);\n            }\n        }\n    };\n\n    const handleFinish = async () => {\n        await completeLab('bio-breathing-rate', 250);\n        setShowSuccess(true);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-red-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">ü´Å‚úÖ</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-red-400 mb-4 uppercase tracking-tight\">\n                        Physiology Lab Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You&apos;ve analyzed the relationship between physical activity and respiration rate.\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Data Points</div>\n                            <div className=\"text-3xl font-black text-white\">{recordedData.length}</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+250'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden flex flex-col\">\n            {/* Header */}\n            <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6 shrink-0\">\n                <div className=\"flex items-center gap-4\">\n                    <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                        ‚Üê Exit Lab\n                    </a>\n                    <div className=\"h-6 w-px bg-zinc-700\" />\n                    <div className=\"text-sm font-black tracking-tight text-white\">Respiration & Exercise</div>\n                </div>\n            </header>\n\n            <div className=\"flex-1 flex overflow-hidden\">\n                {/* Left Controls */}\n                <aside className=\"w-80 bg-[#131325] border-r-4 border-[#3D3D5C] p-6 flex flex-col gap-8 overflow-y-auto\">\n\n                    {/* Activity Select */}\n                    <div>\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Select Activity</div>\n                        <div className=\"grid grid-cols-1 gap-3\">\n                            {ACTIVITIES.map(act => (\n                                <button\n                                    key={act.id}\n                                    onClick={() => handleStartExercise(act.id)}\n                                    disabled={status === 'exercising'}\n                                    className={`\n                                        p-4 rounded-2xl border-2 text-left transition-all\n                                        ${activeActivity === act.id ? 'border-white bg-white/10' : 'border-[#3D3D5C] bg-[#1B1B2F] hover:bg-white/5'}\n                                        ${status === 'exercising' ? 'opacity-50 cursor-not-allowed' : ''}\n                                    `}\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${act.color} bg-opacity-20 text-white`}>\n                                            {act.icon}\n                                        </div>\n                                        <div>\n                                            <div className=\"text-sm font-black text-white\">{act.name}</div>\n                                            <div className=\"text-[10px] text-zinc-500\">Target: ~{act.targetRate} bpm</div>\n                                        </div>\n                                    </div>\n                                    {status === 'exercising' && activeActivity === act.id && (\n                                        <div className=\"mt-2 w-full h-1 bg-zinc-800 rounded-full overflow-hidden\">\n                                            <motion.div\n                                                className=\"h-full bg-emerald-500\"\n                                                initial={{ width: '100%' }}\n                                                animate={{ width: '0%' }}\n                                                transition={{ duration: act.duration, ease: 'linear' }}\n                                            />\n                                        </div>\n                                    )}\n                                </button>\n                            ))}\n                        </div>\n                    </div>\n\n                    {/* Stopwatch Tool */}\n                    <div className=\"p-6 rounded-3xl bg-black/40 border border-white/10\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Stopwatch</div>\n                        <div className=\"text-4xl font-mono font-black text-white text-center mb-6\">\n                            00:{stopwatchTime.toString().padStart(2, '0')}\n                        </div>\n                        <div className=\"flex gap-2\">\n                            {!isStopwatchRunning ? (\n                                <button\n                                    onClick={() => setIsStopwatchRunning(true)}\n                                    className=\"flex-1 py-3 rounded-xl bg-emerald-500 text-white font-black text-xs uppercase tracking-widest hover:bg-emerald-400\"\n                                >\n                                    Start\n                                </button>\n                            ) : (\n                                <button\n                                    onClick={() => setIsStopwatchRunning(false)}\n                                    className=\"flex-1 py-3 rounded-xl bg-red-500 text-white font-black text-xs uppercase tracking-widest hover:bg-red-400\"\n                                >\n                                    Stop\n                                </button>\n                            )}\n                            <button\n                                onClick={() => { setIsStopwatchRunning(false); setStopwatchTime(0); }}\n                                className=\"px-4 py-3 rounded-xl bg-zinc-700 text-white font-black text-xs uppercase tracking-widest hover:bg-zinc-600\"\n                            >\n                                Reset\n                            </button>\n                        </div>\n                    </div>\n\n                </aside>\n\n                {/* Main View */}\n                <main className=\"flex-1 flex flex-col items-center justify-center relative bg-gradient-to-b from-blue-900/20 to-black/20\">\n\n                    <div className=\"mb-8 p-12 bg-white/5 rounded-[3rem] border border-white/10 shadow-2xl backdrop-blur-sm\">\n                        <BreathingSubject\n                            rate={currentRate}\n                            activity={activeActivity}\n                            isExercising={status === 'exercising'}\n                        />\n                    </div>\n\n                    {/* Data Entry */}\n                    <div className=\"absolute bottom-8 left-8 right-8 flex justify-center\">\n                        <div className=\"bg-[#131325] p-2 rounded-2xl border border-[#3D3D5C] flex items-center gap-2 max-w-md w-full shadow-2xl\">\n                            <input\n                                type=\"number\"\n                                placeholder=\"Enter Breaths per Minute...\"\n                                value={userGuess}\n                                onChange={(e) => setUserGuess(e.target.value)}\n                                className=\"flex-1 bg-transparent px-4 py-3 text-white placeholder-zinc-500 outline-none font-bold\"\n                            />\n                            <button\n                                onClick={handleRecord}\n                                className=\"px-6 py-3 rounded-xl bg-blue-600 text-white font-black text-xs uppercase tracking-widest hover:bg-blue-500\"\n                            >\n                                Record\n                            </button>\n                        </div>\n                    </div>\n                </main>\n            </div>\n\n            <ProfessorBright state={professor} />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-classification/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[39,52],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[84,101],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":167,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":167,"endColumn":80},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'resetToIdle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":167,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":167,"endColumn":93},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7145,7148],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7145,7148],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\ninterface Organism {\n    id: string;\n    name: string;\n    icon: string;\n    kingdom: 'Plantae' | 'Animalia' | 'Fungi';\n    features: string[];\n}\n\nconst ORGANISMS: Organism[] = [\n    { id: 'fern', name: 'Fern', icon: 'üåø', kingdom: 'Plantae', features: ['Non-flowering', 'Spore reproduction', 'Vascular'] },\n    { id: 'hibiscus', name: 'Hibiscus', icon: 'üå∫', kingdom: 'Plantae', features: ['Flowering', 'Dicot', 'Broad leaves'] },\n    { id: 'corn', name: 'Corn', icon: 'üåΩ', kingdom: 'Plantae', features: ['Flowering', 'Monocot', 'Parallel veins'] },\n    { id: 'mushroom', name: 'Mushroom', icon: 'üçÑ', kingdom: 'Fungi', features: ['No chlorophyll', 'Spore reproduction', 'Decomposer'] },\n    { id: 'butterfly', name: 'Butterfly', icon: 'ü¶ã', kingdom: 'Animalia', features: ['Invertebrate', 'Exoskeleton', 'Metamorphosis'] },\n    { id: 'lizard', name: 'Lizard', icon: 'ü¶é', kingdom: 'Animalia', features: ['Vertebrate', 'Cold-blooded', 'Scales'] },\n];\n\n// ==========================================\n// DRAGGABLE SPECIMEN\n// ==========================================\n\nfunction DraggableSpecimen({ organism, isOverlay }: { organism: Organism; isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n        id: organism.id\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-6 rounded-3xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F]  border border-[#3D3D5C]\n        transition-all select-none flex flex-col items-center gap-3\n        hover:bg-white/[0.08] hover:border-emerald-500/30\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20 scale-110' : ''}\n      `}\n        >\n            <span className=\"text-5xl\">{organism.icon}</span>\n            <div className=\"text-center\">\n                <div className=\"text-sm font-black text-white\">{organism.name}</div>\n                <div className=\"text-[9px] text-zinc-500 mt-1\">{organism.features.slice(0, 2).join(' ‚Ä¢ ')}</div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// KINGDOM JAR (DROP TARGET)\n// ==========================================\n\ntype Kingdom = 'Plantae' | 'Animalia' | 'Fungi';\n\nconst kingdomConfig: Record<Kingdom, { color: string; icon: string; bgColor: string }> = {\n    Plantae: { color: 'emerald', icon: 'üå±', bgColor: 'from-emerald-500/20 to-green-600/20' },\n    Animalia: { color: 'orange', icon: 'ü¶Å', bgColor: 'from-orange-500/20 to-amber-600/20' },\n    Fungi: { color: 'purple', icon: 'üçÑ', bgColor: 'from-purple-500/20 to-violet-600/20' }\n};\n\nfunction KingdomJar({\n    kingdom,\n    organisms,\n    isHovering,\n    isReject\n}: {\n    kingdom: Kingdom;\n    organisms: Organism[];\n    isHovering: boolean;\n    isReject: boolean;\n}) {\n    const { setNodeRef } = useDroppable({ id: kingdom });\n    const config = kingdomConfig[kingdom];\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={\n                isReject\n                    ? { x: [0, -5, 5, -5, 5, 0], borderColor: 'rgba(239, 68, 68, 0.5)' }\n                    : isHovering\n                        ? { scale: 1.05, borderColor: 'rgba(16, 185, 129, 0.8)' }\n                        : { scale: 1, borderColor: 'rgba(255, 255, 255, 0.1)' }\n            }\n            transition={{ duration: 0.3 }}\n            className={`\n        relative p-6 rounded-[2rem] border-2 transition-all min-h-[250px]\n        bg-gradient-to-br ${config.bgColor} \n        ${isHovering ? 'shadow-2xl shadow-emerald-500/20' : ''}\n      `}\n        >\n            {/* Jar Lid Animation */}\n            <motion.div\n                animate={isHovering ? { y: -10, rotate: -15 } : { y: 0, rotate: 0 }}\n                className=\"absolute -top-4 left-1/2 -translate-x-1/2 w-24 h-6 rounded-t-xl bg-white/10 border border-white/20\"\n            />\n\n            <div className=\"flex items-center gap-3 mb-6\">\n                <span className=\"text-3xl\">{config.icon}</span>\n                <div>\n                    <div className=\"text-lg font-black text-white\">{kingdom}</div>\n                    <div className=\"text-[10px] font-bold text-white/50 uppercase tracking-widest\">\n                        {organisms.length} collected\n                    </div>\n                </div>\n            </div>\n\n            {/* Collected Organisms */}\n            <div className=\"flex flex-wrap gap-2\">\n                {organisms.map((org) => (\n                    <motion.div\n                        key={org.id}\n                        initial={{ scale: 0, opacity: 0 }}\n                        animate={{ scale: 1, opacity: 1 }}\n                        className=\"w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center text-2xl\"\n                    >\n                        {org.icon}\n                    </motion.div>\n                ))}\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// MAIN CLASSIFICATION LAB V2\n// ==========================================\n\nexport default function ClassificationLabV2Page() {\n    const [unclassified, setUnclassified] = useState<Organism[]>(ORGANISMS);\n    const [classified, setClassified] = useState<Record<Kingdom, Organism[]>>({\n        Plantae: [],\n        Animalia: [],\n        Fungi: []\n    });\n    const [activeOrganism, setActiveOrganism] = useState<Organism | null>(null);\n    const [hoveringKingdom, setHoveringKingdom] = useState<Kingdom | null>(null);\n    const [rejectKingdom, setRejectKingdom] = useState<Kingdom | null>(null);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [score, setScore] = useState(100);\n    const [showSuccess, setShowSuccess] = useState(false);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint, resetToIdle } = useProfessor({\n        initialMessage: \"Drag each specimen into the correct kingdom jar!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    const handleDragStart = (event: DragStartEvent) => {\n        const org = unclassified.find(o => o.id === event.active.id);\n        setActiveOrganism(org || null);\n    };\n\n    const handleDragOver = (event: any) => {\n        const { over, active } = event;\n        if (!over || !active) {\n            setHoveringKingdom(null);\n            setRejectKingdom(null);\n            return;\n        }\n\n        const organism = unclassified.find(o => o.id === active.id);\n        const targetKingdom = over.id as Kingdom;\n\n        if (['Plantae', 'Animalia', 'Fungi'].includes(targetKingdom)) {\n            if (organism?.kingdom === targetKingdom) {\n                setHoveringKingdom(targetKingdom);\n                setRejectKingdom(null);\n            } else {\n                setHoveringKingdom(null);\n                setRejectKingdom(targetKingdom);\n            }\n        } else {\n            setHoveringKingdom(null);\n            setRejectKingdom(null);\n        }\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { active, over } = event;\n        setActiveOrganism(null);\n        setHoveringKingdom(null);\n        setRejectKingdom(null);\n\n        if (!over) return;\n\n        const organism = unclassified.find(o => o.id === active.id);\n        const targetKingdom = over.id as Kingdom;\n\n        if (!organism || !['Plantae', 'Animalia', 'Fungi'].includes(targetKingdom)) return;\n\n        if (organism.kingdom === targetKingdom) {\n            // CORRECT!\n            setUnclassified(prev => prev.filter(o => o.id !== organism.id));\n            setClassified(prev => ({\n                ...prev,\n                [targetKingdom]: [...prev[targetKingdom], organism]\n            }));\n\n            // Particle explosion\n            const color = targetKingdom === 'Plantae' ? '#10B981' :\n                targetKingdom === 'Animalia' ? '#F97316' : '#8B5CF6';\n            setParticles(createParticles(400, 300, 30, color));\n            setTimeout(() => setParticles([]), 1000);\n\n            showProfessorSuccess(`Excellent! ${organism.name} belongs to Kingdom ${targetKingdom}!`);\n\n            // Check if all classified\n            if (unclassified.length === 1) {\n                completeLab('bio-classification', 150, score);\n                setTimeout(() => setShowSuccess(true), 1500);\n            }\n        } else {\n            // WRONG!\n            setScore(prev => prev - 10);\n            showWarning(`Careful! ${organism.name} doesn't belong in ${targetKingdom}. Look at its features!`);\n        }\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-emerald-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <motion.div\n                        animate={{ rotate: [0, 10, -10, 0] }}\n                        transition={{ repeat: 2, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        üî¨‚úÖ\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-emerald-400 mb-4 uppercase tracking-tight\">\n                        Classification Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You correctly classified all organisms into their kingdoms!\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Score</div>\n                            <div className=\"text-3xl font-black text-emerald-400\">{score}/100</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+150'}\n                            </div>\n                        </div>\n                    </div>\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Background Effects */}\n                <div className=\"absolute inset-0\">\n                    <div className=\"absolute top-0 left-1/3 w-1/2 h-1/3 bg-emerald-500/5 blur-[200px] rounded-full\" />\n                    <div className=\"absolute bottom-0 right-1/4 w-1/3 h-1/3 bg-purple-500/5 blur-[150px] rounded-full\" />\n                </div>\n\n                {/* Header */}\n                <header className=\"relative z-50 h-16 bg-[#131325]  border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-white/10\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Classification of Organisms</div>\n                    </div>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                            Score: <span className=\"text-emerald-400\">{score}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2 bg-black/30 px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                            <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                            <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                                {unclassified.length} to classify\n                            </span>\n                        </div>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] p-8 flex flex-col\">\n                    {/* Kingdom Jars */}\n                    <div className=\"grid grid-cols-3 gap-6 mb-8\">\n                        {(['Plantae', 'Animalia', 'Fungi'] as Kingdom[]).map((kingdom) => (\n                            <KingdomJar\n                                key={kingdom}\n                                kingdom={kingdom}\n                                organisms={classified[kingdom]}\n                                isHovering={hoveringKingdom === kingdom}\n                                isReject={rejectKingdom === kingdom}\n                            />\n                        ))}\n                    </div>\n\n                    {/* Specimen Garden */}\n                    <div className=\"flex-1 p-8 rounded-[2rem] bg-gradient-to-b from-green-900/20 to-green-950/30 border border-[#3D3D5C] overflow-hidden relative\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-600 mb-6\">\n                            üå≥ Virtual Garden ‚Äî Drag specimens to their kingdom\n                        </div>\n                        <div className=\"grid grid-cols-6 gap-4\">\n                            {unclassified.map((org) => (\n                                <DraggableSpecimen key={org.id} organism={org} />\n                            ))}\n                        </div>\n\n                        {/* Particle Effect */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{\n                                    x: p.x + p.velocity.x,\n                                    y: p.y + p.velocity.y,\n                                    scale: 0,\n                                    opacity: 0\n                                }}\n                                transition={{ duration: 0.8, ease: \"easeOut\" }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{\n                                    width: p.size,\n                                    height: p.size,\n                                    backgroundColor: p.color\n                                }}\n                            />\n                        ))}\n                    </div>\n                </div>\n\n                {/* Drag Overlay */}\n                <DragOverlay>\n                    {activeOrganism && (\n                        <DraggableSpecimen organism={activeOrganism} isOverlay />\n                    )}\n                </DragOverlay>\n\n                {/* Professor Bright */}\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-diffusion/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[50,63],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6199,6202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6199,6202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// DRAGGABLE CRYSTAL\n// ==========================================\n\nfunction DraggableCrystal({ isOverlay }: { isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id: 'crystal' });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-6 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-purple-500/20 border-2 border-b-4 border-purple-500\n        transition-all select-none text-center\n        hover:bg-purple-500/30\n        ${isOverlay ? 'shadow-2xl scale-110' : ''}\n      `}\n        >\n            <div className=\"text-4xl mb-2\">üíé</div>\n            <div className=\"text-sm font-black text-purple-300\">KMnO‚ÇÑ Crystal</div>\n            <div className=\"text-[9px] text-purple-300/70 mt-1\">Potassium Permanganate</div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// BEAKER DROP ZONE\n// ==========================================\n\nfunction BeakerZone({\n    diffusionProgress,\n    isHovering,\n    hasCrystal\n}: {\n    diffusionProgress: number;\n    isHovering: boolean;\n    hasCrystal: boolean;\n}) {\n    const { setNodeRef } = useDroppable({ id: 'beaker' });\n\n    // Create gradient rings based on diffusion\n    const rings = Array.from({ length: 5 }, (_, i) => {\n        const size = 20 + i * 30;\n        const opacity = Math.max(0, (diffusionProgress - i * 20) / 100);\n        return { size, opacity };\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={isHovering ? { scale: 1.02, borderColor: '#A855F7' } : { scale: 1 }}\n            className=\"relative w-80 h-80 mx-auto rounded-full border-4 border-b-8 border-[#3D3D5C] bg-blue-400/30 overflow-hidden\"\n        >\n            {/* Water */}\n            <div className=\"absolute inset-0 bg-gradient-to-b from-blue-300/20 to-blue-500/40\" />\n\n            {/* Diffusion Rings */}\n            <AnimatePresence>\n                {hasCrystal && rings.map((ring, i) => (\n                    <motion.div\n                        key={i}\n                        initial={{ scale: 0, opacity: 0 }}\n                        animate={{\n                            scale: 1,\n                            opacity: ring.opacity,\n                            transition: { delay: i * 0.5, duration: 2 }\n                        }}\n                        className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full border-4 border-purple-500/60\"\n                        style={{\n                            width: `${ring.size}%`,\n                            height: `${ring.size}%`,\n                            background: `radial-gradient(circle, rgba(168,85,247,${ring.opacity * 0.8}) 0%, transparent 70%)`\n                        }}\n                    />\n                ))}\n            </AnimatePresence>\n\n            {/* Crystal in center */}\n            {hasCrystal && (\n                <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-purple-900 rounded-lg shadow-lg\"\n                />\n            )}\n\n            {/* Label */}\n            <div className=\"absolute bottom-4 left-0 right-0 text-center\">\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-white/70\">\n                    {!hasCrystal ? 'Drop Crystal Here' : `Diffusion: ${diffusionProgress}%`}\n                </div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// MAIN DIFFUSION LAB\n// ==========================================\n\nexport default function DiffusionLabPage() {\n    const [hasCrystal, setHasCrystal] = useState(false);\n    const [diffusionProgress, setDiffusionProgress] = useState(0);\n    const [activeCrystal, setActiveCrystal] = useState(false);\n    const [hoveringBeaker, setHoveringBeaker] = useState(false);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [timeElapsed, setTimeElapsed] = useState(0);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning } = useProfessor({\n        initialMessage: \"Drop the potassium permanganate crystal into the water and observe diffusion!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    // Diffusion simulation\n    useEffect(() => {\n        if (!hasCrystal || diffusionProgress >= 100) return;\n\n        const interval = setInterval(() => {\n            setDiffusionProgress(prev => Math.min(100, prev + 2));\n            setTimeElapsed(prev => prev + 1);\n        }, 500);\n\n        return () => clearInterval(interval);\n    }, [hasCrystal, diffusionProgress]);\n\n    // Check completion\n    useEffect(() => {\n        if (diffusionProgress >= 100 && !showSuccess) {\n            setTimeout(() => setShowSuccess(true), 1000);\n        }\n    }, [diffusionProgress, showSuccess]);\n\n    const handleDragStart = (event: DragStartEvent) => {\n        if (event.active.id === 'crystal') setActiveCrystal(true);\n    };\n\n    const handleDragOver = (event: any) => {\n        setHoveringBeaker(event.over?.id === 'beaker');\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        setActiveCrystal(false);\n        setHoveringBeaker(false);\n\n        if (event.over?.id !== 'beaker') return;\n\n        if (hasCrystal) {\n            showWarning(\"Crystal already in the beaker!\");\n            return;\n        }\n\n        setHasCrystal(true);\n        setParticles(createParticles(400, 250, 20, '#A855F7'));\n        setTimeout(() => setParticles([]), 1000);\n\n        showProfessorSuccess(\"Watch the purple color spread through the water!\");\n    };\n\n    const handleComplete = async () => {\n        await completeLab('bio-diffusion', 150);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-purple-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">üíß‚úÖ</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-purple-400 mb-4 uppercase tracking-tight\">\n                        Diffusion Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You observed <span className=\"text-purple-400 font-bold\">diffusion</span> ‚Äî particles moving from\n                        high to low concentration until evenly distributed!\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Time</div>\n                            <div className=\"text-3xl font-black text-white\">{timeElapsed}s</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+150'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        onClick={handleComplete}\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-purple-500 text-white font-black uppercase tracking-widest hover:bg-purple-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Header - solid bg, high z-index */}\n                <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-zinc-700\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Diffusion in Liquids</div>\n                    </div>\n                    <div className=\"flex items-center gap-2 bg-[#1B1B2F] px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                        <div className={`w-2 h-2 rounded-full ${hasCrystal ? 'bg-purple-500 animate-pulse' : 'bg-zinc-600'}`} />\n                        <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                            {!hasCrystal ? 'Waiting' : diffusionProgress < 100 ? 'Diffusing...' : 'Complete'}\n                        </span>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Equipment */}\n                    <aside className=\"w-72 bg-[#131325] border-r-4 border-[#3D3D5C] p-6\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Equipment</div>\n                        {!hasCrystal && <DraggableCrystal />}\n                        {hasCrystal && (\n                            <div className=\"p-6 rounded-2xl bg-purple-500/10 border border-purple-500/30 text-center\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-purple-400\">\n                                    Crystal Added ‚úì\n                                </div>\n                            </div>\n                        )}\n\n                        <div className=\"mt-8 p-4 rounded-2xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-3\">What&apos;s Happening?</div>\n                            <p className=\"text-xs text-zinc-400 leading-relaxed\">\n                                KMnO‚ÇÑ molecules have kinetic energy and move randomly, spreading from high concentration (crystal) to low (water).\n                            </p>\n                        </div>\n\n                        {hasCrystal && (\n                            <div className=\"mt-6 p-4 rounded-2xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                                <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Progress</div>\n                                <div className=\"w-full h-3 rounded-full bg-zinc-800 overflow-hidden\">\n                                    <motion.div\n                                        animate={{ width: `${diffusionProgress}%` }}\n                                        className=\"h-full bg-purple-500\"\n                                    />\n                                </div>\n                                <div className=\"text-center mt-2 text-xs text-zinc-400\">\n                                    {diffusionProgress}% diffused\n                                </div>\n                            </div>\n                        )}\n                    </aside>\n\n                    {/* Center: Beaker */}\n                    <main className=\"flex-1 flex items-center justify-center p-8 relative\">\n                        <BeakerZone\n                            diffusionProgress={diffusionProgress}\n                            isHovering={hoveringBeaker}\n                            hasCrystal={hasCrystal}\n                        />\n\n                        {/* Particles */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{ x: p.x + p.velocity.x, y: p.y + p.velocity.y, scale: 0, opacity: 0 }}\n                                transition={{ duration: 0.8 }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{ width: p.size, height: p.size, backgroundColor: p.color }}\n                            />\n                        ))}\n                    </main>\n                </div>\n\n                <DragOverlay>\n                    {activeCrystal && <DraggableCrystal isOverlay />}\n                </DragOverlay>\n\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-enzymes-temp/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[50,63],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[95,112],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'timer' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":201,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":201,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setTimer' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":201,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":201,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showWarning' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":203,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":203,"endColumn":70},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":203,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":203,"endColumn":80},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'resetToIdle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":203,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":203,"endColumn":93},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":242,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":242,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9115,9118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9115,9118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ninterface WaterBath {\n    id: string;\n    name: string;\n    temperature: number;\n    icon: string;\n    color: string;\n    enzymeStatus: 'inactive' | 'optimal' | 'denatured';\n}\n\ninterface TestTube {\n    id: string;\n    bathId: string;\n    hasAmylase: boolean;\n    hasStarch: boolean;\n    timeElapsed: number;\n    starchBroken: boolean;\n}\n\nconst WATER_BATHS: WaterBath[] = [\n    { id: 'ice', name: 'Ice Bath', temperature: 0, icon: 'üßä', color: 'from-blue-500/30 to-cyan-500/30', enzymeStatus: 'inactive' },\n    { id: 'room', name: 'Room Temperature', temperature: 37, icon: 'üå°Ô∏è', color: 'from-emerald-500/30 to-green-500/30', enzymeStatus: 'optimal' },\n    { id: 'boiling', name: 'Boiling Water', temperature: 100, icon: '‚ô®Ô∏è', color: 'from-red-500/30 to-orange-500/30', enzymeStatus: 'denatured' }\n];\n\n// ==========================================\n// DRAGGABLE REAGENT\n// ==========================================\n\ninterface Reagent {\n    id: string;\n    name: string;\n    icon: string;\n}\n\nconst REAGENTS: Reagent[] = [\n    { id: 'amylase', name: 'Amylase Enzyme', icon: 'üß¨' },\n    { id: 'starch', name: 'Starch Solution', icon: 'ü´ß' },\n    { id: 'iodine', name: 'Iodine', icon: 'üü§' }\n];\n\nfunction DraggableReagent({ reagent, isOverlay }: { reagent: Reagent; isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n        id: reagent.id\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-4 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F]  border border-[#3D3D5C]\n        transition-all select-none\n        hover:bg-white/[0.08] hover:border-emerald-500/30\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20 scale-110' : ''}\n      `}\n        >\n            <div className=\"flex items-center gap-3\">\n                <span className=\"text-2xl\">{reagent.icon}</span>\n                <span className=\"text-sm font-black text-white\">{reagent.name}</span>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// WATER BATH DROP ZONE\n// ==========================================\n\nfunction WaterBathZone({\n    bath,\n    testTube,\n    isHovering,\n    onTest\n}: {\n    bath: WaterBath;\n    testTube: TestTube | null;\n    isHovering: boolean;\n    onTest: () => void;\n}) {\n    const { setNodeRef } = useDroppable({ id: bath.id });\n\n    const statusLabel: Record<string, { text: string; color: string }> = {\n        inactive: { text: 'Too Cold - Slow Reaction', color: 'text-blue-400' },\n        optimal: { text: 'Optimal - Fast Reaction', color: 'text-emerald-400' },\n        denatured: { text: 'Denatured - No Reaction', color: 'text-red-400' }\n    };\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={isHovering ? { scale: 1.02, borderColor: 'rgba(16, 185, 129, 0.6)' } : { scale: 1 }}\n            className={`\n        relative p-6 rounded-[2rem] border-2 transition-all\n        bg-gradient-to-br ${bath.color} \n        border-[#3D3D5C] min-h-[280px]\n        ${isHovering ? 'shadow-2xl shadow-emerald-500/20' : ''}\n      `}\n        >\n            {/* Temperature Display */}\n            <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"flex items-center gap-3\">\n                    <span className=\"text-4xl\">{bath.icon}</span>\n                    <div>\n                        <div className=\"text-lg font-black text-white\">{bath.name}</div>\n                        <div className=\"text-[10px] font-bold text-white/50 uppercase tracking-widest\">\n                            {bath.temperature}¬∞C\n                        </div>\n                    </div>\n                </div>\n                <div className={`text-[9px] font-black uppercase tracking-widest ${statusLabel[bath.enzymeStatus].color}`}>\n                    {statusLabel[bath.enzymeStatus].text}\n                </div>\n            </div>\n\n            {/* Test Tube Slot */}\n            <div className=\"mt-6 p-6 rounded-2xl bg-white/5 border border-[#3D3D5C] min-h-[140px] flex flex-col items-center justify-center\">\n                {testTube ? (\n                    <motion.div\n                        initial={{ scale: 0 }}\n                        animate={{ scale: 1 }}\n                        className=\"text-center\"\n                    >\n                        <div className=\"text-4xl mb-3\">üß™</div>\n                        <div className=\"text-xs text-zinc-400 mb-2\">\n                            {testTube.hasAmylase && testTube.hasStarch ? 'Amylase + Starch' : 'Empty'}\n                        </div>\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                            {testTube.timeElapsed}s elapsed\n                        </div>\n                        <button\n                            onClick={onTest}\n                            className=\"mt-4 px-4 py-2 rounded-xl bg-amber-500/20 border border-amber-500/30 text-[10px] font-black uppercase tracking-widest text-amber-400 hover:bg-amber-500/30\"\n                        >\n                            üü§ Test with Iodine\n                        </button>\n                    </motion.div>\n                ) : (\n                    <div className=\"text-center\">\n                        <div className=\"text-3xl opacity-30 mb-2\">üß™</div>\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-600\">\n                            Drop reagents here\n                        </div>\n                    </div>\n                )}\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// SPOTTING TILE RESULT\n// ==========================================\n\ninterface SpottingResult {\n    bathId: string;\n    color: 'blue_black' | 'yellow_brown';\n    starchPresent: boolean;\n}\n\n// ==========================================\n// MAIN ENZYME TEMPERATURE LAB V2\n// ==========================================\n\nexport default function EnzymeLabV2Page() {\n    const [testTubes, setTestTubes] = useState<Record<string, TestTube>>({});\n    const [activeReagent, setActiveReagent] = useState<Reagent | null>(null);\n    const [hoveringBath, setHoveringBath] = useState<string | null>(null);\n    const [results, setResults] = useState<SpottingResult[]>([]);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [timer, setTimer] = useState<NodeJS.Timeout | null>(null);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint, resetToIdle } = useProfessor({\n        initialMessage: \"Let's test how temperature affects enzyme activity. Add amylase and starch to each water bath!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    // Timer for elapsed time\n    useEffect(() => {\n        const interval = setInterval(() => {\n            setTestTubes(prev => {\n                const updated = { ...prev };\n                Object.keys(updated).forEach(key => {\n                    if (updated[key].hasAmylase && updated[key].hasStarch) {\n                        const bath = WATER_BATHS.find(b => b.id === updated[key].bathId);\n                        updated[key] = {\n                            ...updated[key],\n                            timeElapsed: updated[key].timeElapsed + 10,\n                            // Starch breaks down at optimal temp after ~60s\n                            starchBroken: bath?.enzymeStatus === 'optimal' && updated[key].timeElapsed >= 50\n                        };\n                    }\n                });\n                return updated;\n            });\n        }, 1000); // Speed up for simulation\n\n        return () => clearInterval(interval);\n    }, []);\n\n    const handleDragStart = (event: DragStartEvent) => {\n        const reagent = REAGENTS.find(r => r.id === event.active.id);\n        setActiveReagent(reagent || null);\n    };\n\n    const handleDragOver = (event: any) => {\n        if (event.over && WATER_BATHS.some(b => b.id === event.over.id)) {\n            setHoveringBath(event.over.id);\n        } else {\n            setHoveringBath(null);\n        }\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { active, over } = event;\n        setActiveReagent(null);\n        setHoveringBath(null);\n\n        if (!over) return;\n\n        const reagentId = active.id as string;\n        const bathId = over.id as string;\n        const bath = WATER_BATHS.find(b => b.id === bathId);\n\n        if (!bath) return;\n\n        setTestTubes(prev => {\n            const existing = prev[bathId] || {\n                id: `tube-${bathId}`,\n                bathId,\n                hasAmylase: false,\n                hasStarch: false,\n                timeElapsed: 0,\n                starchBroken: false\n            };\n\n            if (reagentId === 'amylase') {\n                return { ...prev, [bathId]: { ...existing, hasAmylase: true } };\n            }\n            if (reagentId === 'starch') {\n                return { ...prev, [bathId]: { ...existing, hasStarch: true } };\n            }\n            return prev;\n        });\n\n        if (reagentId === 'amylase' || reagentId === 'starch') {\n            showProfessorSuccess(`Added ${reagentId} to the ${bath.name}!`);\n        }\n    };\n\n    const handleTest = (bathId: string) => {\n        const tube = testTubes[bathId];\n        const bath = WATER_BATHS.find(b => b.id === bathId);\n\n        if (!tube || !bath) return;\n\n        const starchPresent = bath.enzymeStatus !== 'optimal' || !tube.starchBroken;\n        const color = starchPresent ? 'blue_black' : 'yellow_brown';\n\n        setResults(prev => [...prev, { bathId, color, starchPresent }]);\n\n        // Particle effect\n        const particleColor = starchPresent ? '#3730A3' : '#D97706';\n        setParticles(createParticles(400, 200, 25, particleColor));\n        setTimeout(() => setParticles([]), 1000);\n\n        if (starchPresent) {\n            showProfessorSuccess(`Blue-black! Starch is still present at ${bath.temperature}¬∞C.`);\n        } else {\n            showProfessorSuccess(`Yellow-brown! Starch was digested at ${bath.temperature}¬∞C. This is the optimal temperature!`);\n        }\n\n        // Check if all 3 tested\n        if (results.length + 1 >= 3) {\n            completeLab('bio-enzymes-temp', 300);\n            setTimeout(() => setShowSuccess(true), 2000);\n        }\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-emerald-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <motion.div\n                        animate={{ rotate: [0, 10, -10, 0] }}\n                        transition={{ repeat: 2, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        üß¨‚úÖ\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-emerald-400 mb-4 uppercase tracking-tight\">\n                        Lab Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You demonstrated that enzymes have an <span className=\"text-emerald-400 font-bold\">optimal temperature</span> and\n                        <span className=\"text-red-400 font-bold\"> denature at high temperatures</span>.\n                    </p>\n\n                    <div className=\"grid grid-cols-3 gap-4 mb-10 max-w-xl mx-auto\">\n                        {WATER_BATHS.map(bath => {\n                            const result = results.find(r => r.bathId === bath.id);\n                            return (\n                                <div key={bath.id} className={`p-4 rounded-2xl bg-gradient-to-br ${bath.color} border border-[#3D3D5C]`}>\n                                    <div className=\"text-3xl mb-2\">{bath.icon}</div>\n                                    <div className=\"text-sm font-black text-white\">{bath.temperature}¬∞C</div>\n                                    <div className={`text-[10px] font-bold mt-1 ${result?.starchPresent ? 'text-indigo-400' : 'text-amber-400'}`}>\n                                        {result?.starchPresent ? 'Starch Present' : 'Starch Digested'}\n                                    </div>\n                                </div>\n                            );\n                        })}\n                    </div>\n\n                    <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C] mb-10\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                        <div className=\"text-3xl font-black text-amber-400\">\n                            {result?.xpGain !== undefined ? `+${result.xpGain}` : '+300'}\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Background */}\n                <div className=\"absolute inset-0\">\n                    <div className=\"absolute top-0 left-1/4 w-1/2 h-1/3 bg-emerald-500/5 blur-[200px] rounded-full\" />\n                    <div className=\"absolute bottom-0 right-1/4 w-1/3 h-1/3 bg-blue-500/5 blur-[150px] rounded-full\" />\n                </div>\n\n                {/* Header */}\n                <header className=\"relative z-50 h-16 bg-[#131325]  border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-white/10\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Effect of Temperature on Enzymes</div>\n                    </div>\n                    <div className=\"flex items-center gap-2 bg-black/30 px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                        <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                        <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                            {results.length}/3 tests done\n                        </span>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Reagent Shelf */}\n                    <aside className=\"w-64 bg-[#131325]  border-r border-[#3D3D5C] p-6\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Reagents\n                        </div>\n                        <div className=\"space-y-3\">\n                            {REAGENTS.map((reagent) => (\n                                <DraggableReagent key={reagent.id} reagent={reagent} />\n                            ))}\n                        </div>\n                    </aside>\n\n                    {/* Center: Water Baths */}\n                    <main className=\"flex-1 p-8 overflow-y-auto\">\n                        <div className=\"grid grid-cols-3 gap-6\">\n                            {WATER_BATHS.map((bath) => (\n                                <WaterBathZone\n                                    key={bath.id}\n                                    bath={bath}\n                                    testTube={testTubes[bath.id] || null}\n                                    isHovering={hoveringBath === bath.id}\n                                    onTest={() => handleTest(bath.id)}\n                                />\n                            ))}\n                        </div>\n\n                        {/* Spotting Tile Results */}\n                        {results.length > 0 && (\n                            <div className=\"mt-8 p-6 rounded-2xl bg-[#131325] border border-[#3D3D5C]\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">\n                                    Spotting Tile Results\n                                </div>\n                                <div className=\"flex gap-4\">\n                                    {results.map((r, i) => {\n                                        const bath = WATER_BATHS.find(b => b.id === r.bathId);\n                                        return (\n                                            <motion.div\n                                                key={i}\n                                                initial={{ scale: 0 }}\n                                                animate={{ scale: 1 }}\n                                                className={`w-16 h-16 rounded-2xl flex flex-col items-center justify-center ${r.color === 'blue_black' ? 'bg-indigo-900' : 'bg-amber-600'\n                                                    }`}\n                                            >\n                                                <span className=\"text-xs font-black text-white\">{bath?.temperature}¬∞C</span>\n                                            </motion.div>\n                                        );\n                                    })}\n                                </div>\n                            </div>\n                        )}\n\n                        {/* Particles */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{ x: p.x + p.velocity.x, y: p.y + p.velocity.y, scale: 0, opacity: 0 }}\n                                transition={{ duration: 0.8 }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{ width: p.size, height: p.size, backgroundColor: p.color }}\n                            />\n                        ))}\n                    </main>\n                </div>\n\n                {/* Drag Overlay */}\n                <DragOverlay>\n                    {activeReagent && <DraggableReagent reagent={activeReagent} isOverlay />}\n                </DragOverlay>\n\n                {/* Professor Bright */}\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-food-tests/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[39,50],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[91,108],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":194,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7466,7469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7466,7469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype Nutrient = 'starch' | 'protein' | 'lipid' | 'sugar' | 'none';\ntype ReagentType = 'iodine' | 'biuret' | 'benedicts' | 'ethanol' | 'water';\n\ninterface FoodSample {\n    id: string;\n    name: string;\n    icon: string;\n    nutrients: Nutrient[];\n    color: string;\n}\n\ninterface Reagent {\n    id: ReagentType;\n    name: string;\n    color: string; // TailWind class for liquid color\n}\n\ninterface TestTube {\n    id: string;\n    contents: {\n        food: string | null;\n        reagent: ReagentType | null;\n        heated: boolean;\n    };\n    color: string; // Current visual color\n    result: 'none' | 'positive' | 'negative' | 'cloudy';\n}\n\nconst FOODS: FoodSample[] = [\n    { id: 'potato', name: 'Potato Slice', icon: 'ü•î', nutrients: ['starch'], color: 'bg-amber-100' },\n    { id: 'egg', name: 'Egg White', icon: 'ü•ö', nutrients: ['protein'], color: 'bg-yellow-50' },\n    { id: 'oil', name: 'Cooking Oil', icon: 'üåª', nutrients: ['lipid'], color: 'bg-yellow-200' },\n    { id: 'glucose', name: 'Glucose Solution', icon: 'üç¨', nutrients: ['sugar'], color: 'bg-blue-50' } // Clear liquid initially\n];\n\nconst REAGENTS: Reagent[] = [\n    { id: 'iodine', name: 'Iodine Solution', color: 'bg-amber-700' },\n    { id: 'biuret', name: 'Biuret Reagent', color: 'bg-blue-500' },\n    { id: 'benedicts', name: 'Benedict\\'s Solution', color: 'bg-blue-400' },\n    { id: 'ethanol', name: 'Ethanol', color: 'bg-gray-100' }, // Clear\n    { id: 'water', name: 'Distilled Water', color: 'bg-blue-100' }\n];\n\n// ==========================================\n// DRAGGABLES\n// ==========================================\n\nfunction DraggableItem({ id, name, icon, isOverlay, type }: { id: string; name: string; icon: string; isOverlay?: boolean; type: 'food' | 'reagent' }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-4 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F] border border-[#3D3D5C]\n        transition-all select-none\n        hover:bg-white/[0.08] hover:border-emerald-500/30\n        flex items-center gap-3\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20 scale-110 z-50' : ''}\n      `}\n        >\n            <span className=\"text-2xl\">{icon}</span>\n            <div>\n                <div className=\"text-sm font-black text-white\">{name}</div>\n                <div className=\"text-[9px] font-bold text-zinc-500 uppercase tracking-widest\">{type}</div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// TEST TUBE ZONE\n// ==========================================\n\nfunction TestTubeZone({\n    tube,\n    isHovering,\n    onClick\n}: {\n    tube: TestTube;\n    isHovering: boolean;\n    onClick: () => void;\n}) {\n    const { setNodeRef } = useDroppable({ id: tube.id });\n\n    return (\n        <div className=\"flex flex-col items-center\">\n            <motion.div\n                ref={setNodeRef}\n                animate={isHovering ? { scale: 1.05, borderColor: '#3B82F6' } : { scale: 1 }}\n                onClick={onClick}\n                className={`\n          relative w-16 h-48 rounded-b-3xl border-x-4 border-b-4 border-zinc-600/50 \n          bg-zinc-800/20 overflow-hidden cursor-pointer transition-colors\n          ${isHovering ? 'border-zinc-500' : ''}\n        `}\n            >\n                {/* Liquid Content */}\n                {tube.color && (\n                    <motion.div\n                        initial={{ height: 0 }}\n                        animate={{ height: tube.contents.reagent ? '60%' : tube.contents.food ? '30%' : '0%', backgroundColor: tube.color }}\n                        className={`absolute bottom-0 w-full transition-all duration-1000 ${tube.contents.reagent ? '' : 'opacity-80'}`}\n                        style={{ backgroundColor: tube.color }} // Use inline style for dynamic hex colors if needed\n                    />\n                )}\n\n                {/* Cloudy Effect for Lipids */}\n                {tube.result === 'cloudy' && (\n                    <div className=\"absolute inset-0 bg-white/30 backdrop-blur-sm bottom-0 h-3/5 top-auto\" />\n                )}\n\n            </motion.div>\n            <div className=\"mt-3 text-center\">\n                <div className=\"text-[10px] font-black uppercase text-zinc-500\">Tube {tube.id.split('-')[1]}</div>\n                <div className=\"text-[9px] text-zinc-600\">\n                    {tube.contents.food ? FOODS.find(f => f.id === tube.contents.food)?.name : 'Empty'}\n                </div>\n            </div>\n        </div>\n    );\n}\n\n// ==========================================\n// MAIN LAB: FOOD TESTS\n// ==========================================\n\nexport default function FoodTestsLabPage() {\n    const [tubes, setTubes] = useState<TestTube[]>([\n        { id: 'tube-1', contents: { food: null, reagent: null, heated: false }, color: '', result: 'none' },\n        { id: 'tube-2', contents: { food: null, reagent: null, heated: false }, color: '', result: 'none' },\n        { id: 'tube-3', contents: { food: null, reagent: null, heated: false }, color: '', result: 'none' },\n        { id: 'tube-4', contents: { food: null, reagent: null, heated: false }, color: '', result: 'none' }\n    ]);\n\n    const [activeId, setActiveId] = useState<string | null>(null);\n    const [hoveringTube, setHoveringTube] = useState<string | null>(null);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [completedTests, setCompletedTests] = useState<string[]>([]); // Track nutrients identified\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint } = useProfessor({\n        initialMessage: \"Identify the nutrients in these food samples using the correct reagents!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    const activeItem = useMemo(() => {\n        const food = FOODS.find(f => f.id === activeId);\n        if (food) return { ...food, type: 'food' as const };\n        const reagent = REAGENTS.find(r => r.id === activeId);\n        if (reagent) return { ...reagent, icon: 'üß™', type: 'reagent' as const };\n        return null;\n    }, [activeId]);\n\n    const handleDragStart = (event: DragStartEvent) => setActiveId(event.active.id as string);\n\n    const handleDragOver = (event: any) => {\n        setHoveringTube(event.over?.id ? (event.over.id as string) : null);\n    };\n\n    const calculateResult = (tube: TestTube): TestTube => {\n        const { food: foodId, reagent, heated } = tube.contents;\n        if (!foodId || !reagent) return tube;\n\n        const food = FOODS.find(f => f.id === foodId);\n        if (!food) return tube;\n\n        let newColor = tube.color;\n        let newResult: 'none' | 'positive' | 'negative' | 'cloudy' = 'none';\n        let message = '';\n\n        // Iodine -> Starch (Blue-Black)\n        if (reagent === 'iodine') {\n            if (food.nutrients.includes('starch')) {\n                newColor = '#1e1b4b'; // Indigo-950\n                newResult = 'positive';\n                message = `Blue-Black! ${food.name} contains Starch.`;\n            } else {\n                newColor = '#b45309'; // Amber-700 (Iodine color)\n                newResult = 'negative';\n                message = `No change (Amber). ${food.name} has no Starch.`;\n            }\n        }\n\n        // Biuret -> Protein (Purple)\n        else if (reagent === 'biuret') {\n            if (food.nutrients.includes('protein')) {\n                newColor = '#9333ea'; // Purple-600\n                newResult = 'positive';\n                message = `Purple! ${food.name} contains Protein.`;\n            } else {\n                newColor = '#3b82f6'; // Blue-500 (Biuret color)\n                newResult = 'negative';\n                message = `Stays Blue. ${food.name} has no Protein.`;\n            }\n        }\n\n        // Ethanol -> Lipids (White Emulsion)\n        else if (reagent === 'ethanol') {\n            // Need water added too? For sim simplicity, let's assume ethanol + water step combined or just ethanol check\n            // Standard: Ethanol -> Shake -> Water -> Cloudy. \n            // Let's make it simpler: Add Ethanol -> Result.\n            if (food.nutrients.includes('lipid')) {\n                newColor = '#ffffff';\n                newResult = 'cloudy';\n                message = `Cloudy Emulsion! ${food.name} contains Lipids.`;\n            } else {\n                newColor = 'transparent';\n                newResult = 'negative';\n                message = `Stays Clear. ${food.name} has no Lipids.`;\n            }\n        }\n\n        // Benedict's -> Glucose (Brick Red IF HEATED)\n        else if (reagent === 'benedicts') {\n            if (!heated) {\n                newColor = '#60a5fa'; // Blue-400\n                newResult = 'none'; // Pending heat\n                message = `Added Benedict's. Now you must HEAT it!`;\n                showHint(\"Benedict's solution requires heat to work! Click the heat button.\");\n                return { ...tube, color: newColor, result: newResult };\n            } else {\n                if (food.nutrients.includes('sugar')) {\n                    newColor = '#ef4444'; // Red-500\n                    newResult = 'positive';\n                    message = `Brick Red! ${food.name} contains Reducing Sugars.`;\n                } else {\n                    newColor = '#60a5fa'; // Stays Blue\n                    newResult = 'negative';\n                    message = `Stays Blue. ${food.name} has no Reducing Sugars.`;\n                }\n            }\n        }\n\n        if (message && reagent !== 'benedicts') showProfessorSuccess(message);\n\n        // Track completion\n        if (newResult === 'positive' || newResult === 'cloudy') {\n            setCompletedTests(prev => Array.from(new Set([...prev, food.nutrients[0]])));\n        }\n\n        return { ...tube, color: newColor, result: newResult };\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        setActiveId(null);\n        setHoveringTube(null);\n\n        const { active, over } = event;\n        if (!over) return;\n\n        const targetTubeId = over.id as string;\n        const tubeIndex = tubes.findIndex(t => t.id === targetTubeId);\n        if (tubeIndex === -1) return;\n\n        const tube = tubes[tubeIndex];\n        const draggedId = active.id as string;\n\n        const draggedFood = FOODS.find(f => f.id === draggedId);\n        const draggedReagent = REAGENTS.find(r => r.id === draggedId);\n\n        const newTubes = [...tubes];\n        let updatedTube = { ...tube };\n\n        if (draggedFood) {\n            if (tube.contents.food) {\n                showWarning(\"Tube already contains food! Use a fresh tube.\");\n                return;\n            }\n            updatedTube.contents = { ...tube.contents, food: draggedFood.id };\n            // Initial color visual (crushed food)\n            updatedTube.color = draggedFood.id === 'oil' ? '#fef08a' : '#e5e7eb';\n            showProfessorSuccess(`Added ${draggedFood.name} to Tube ${tube.id.split('-')[1]}.`);\n        }\n        else if (draggedReagent) {\n            if (!tube.contents.food) {\n                showWarning(\"Add a food sample first!\");\n                return;\n            }\n            if (tube.contents.reagent) {\n                showWarning(\"Reagent already added! Start over for a new test.\");\n                return;\n            }\n            updatedTube.contents = { ...tube.contents, reagent: draggedReagent.id };\n\n            // Calculate Reaction\n            updatedTube = calculateResult(updatedTube);\n\n            // Particles\n            setParticles(createParticles(400, 300, 30, updatedTube.color === 'transparent' ? '#ffffff' : updatedTube.color));\n            setTimeout(() => setParticles([]), 1000);\n        }\n\n        newTubes[tubeIndex] = updatedTube;\n        setTubes(newTubes);\n\n        // Check All Found\n        if (completedTests.length >= 4) { // starch, protein, lipid, sugar\n            setTimeout(() => setShowSuccess(true), 2000);\n        }\n    };\n\n    const handleHeat = (tubeId: string) => {\n        setTubes(prev => prev.map(tube => {\n            if (tube.id !== tubeId) return tube;\n            if (!tube.contents.reagent) {\n                showWarning(\"Add reagents first!\");\n                return tube;\n            }\n            if (tube.contents.reagent !== 'benedicts') {\n                showWarning(\"Only Benedict's test requires heat!\");\n                return tube;\n            }\n\n            const heatedTube = { ...tube, contents: { ...tube.contents, heated: true } };\n            const resultTube = calculateResult(heatedTube);\n\n            if (resultTube.result === 'positive') {\n                showProfessorSuccess(\"Heat Applied! Look at that color change!\");\n                setParticles(createParticles(400, 300, 40, '#ef4444'));\n                setTimeout(() => setParticles([]), 1000);\n            } else {\n                showProfessorSuccess(\"Heat Applied! No color change observed.\");\n            }\n\n            return resultTube;\n        }));\n    };\n\n    const handleClear = () => {\n        setTubes(prev => prev.map(t => ({\n            ...t,\n            contents: { food: null, reagent: null, heated: false },\n            color: '',\n            result: 'none'\n        })));\n    };\n\n    const handleFinish = async () => {\n        await completeLab('bio-food-tests', 300);\n        setShowSuccess(true);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-blue-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">üç±‚úÖ</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-blue-400 mb-4 uppercase tracking-tight\">\n                        Food Analysis Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You successfully identified <span className=\"text-blue-400 font-bold\">Starch, Protein, Lipids, and Sugars</span>!\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Tests Mastered</div>\n                            <div className=\"text-3xl font-black text-white\">{completedTests.length}/4</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+300'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-blue-500 text-white font-black uppercase tracking-widest hover:bg-blue-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Header - Solid & High Z-Index */}\n                <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-zinc-700\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Food Tests Practical</div>\n                    </div>\n                    <div className=\"flex items-center gap-4\">\n                        <button\n                            onClick={handleClear}\n                            className=\"px-4 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-[10px] font-black uppercase tracking-widest text-red-500 hover:bg-red-500/20\"\n                        >\n                            üóëÔ∏è Rinse Tubes\n                        </button>\n                        <div className=\"flex items-center gap-2 bg-[#1B1B2F] px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                            <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                                identified:\n                            </span>\n                            <div className=\"flex gap-1\">\n                                {['starch', 'protein', 'lipid', 'sugar'].map(n => (\n                                    <div key={n} className={`w-2 h-2 rounded-full ${completedTests.includes(n) ? 'bg-emerald-500' : 'bg-zinc-700'}`} />\n                                ))}\n                            </div>\n                        </div>\n                        {completedTests.length >= 4 && (\n                            <button\n                                onClick={handleFinish}\n                                className=\"px-6 py-2 rounded-xl bg-emerald-500 text-white text-[10px] font-black uppercase tracking-widest hover:bg-emerald-400\"\n                            >\n                                Finish\n                            </button>\n                        )}\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Reagents & Food */}\n                    <aside className=\"w-80 bg-[#131325] border-r-4 border-[#3D3D5C] p-6 overflow-y-auto\">\n\n                        <div className=\"mb-8\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Food Samples</div>\n                            <div className=\"grid grid-cols-1 gap-3\">\n                                {FOODS.map(f => (\n                                    <DraggableItem key={f.id} {...f} type=\"food\" />\n                                ))}\n                            </div>\n                        </div>\n\n                        <div>\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Reagents</div>\n                            <div className=\"grid grid-cols-1 gap-3\">\n                                {REAGENTS.map(r => (\n                                    <DraggableItem key={r.id} {...r} icon=\"üß™\" type=\"reagent\" />\n                                ))}\n                            </div>\n                        </div>\n\n                    </aside>\n\n                    {/* Center: Test Tube Rack */}\n                    <main className=\"flex-1 p-8 flex flex-col items-center justify-center relative\">\n\n                        {/* Rack Visual */}\n                        <div className=\"relative flex justify-center gap-8 p-8 rounded-3xl bg-[#1B1B2F] border border-[#3D3D5C] w-full max-w-4xl\">\n                            <div className=\"absolute -top-6 left-0 right-0 h-4 bg-zinc-800 rounded-lg mx-4\" /> {/* Top bar sim */}\n\n                            {tubes.map(tube => (\n                                <div key={tube.id} className=\"flex flex-col items-center gap-2\">\n                                    <TestTubeZone\n                                        tube={tube}\n                                        isHovering={hoveringTube === tube.id}\n                                        onClick={() => { }} // Click interaction if needed\n                                    />\n                                    {tube.contents.reagent === 'benedicts' && !tube.contents.heated && (\n                                        <button\n                                            onClick={() => handleHeat(tube.id)}\n                                            className=\"mt-2 text-2xl hover:scale-110 active:scale-90 transition-transform\"\n                                            title=\"Heat with Bunsen Burner\"\n                                        >\n                                            üî•\n                                        </button>\n                                    )}\n                                </div>\n                            ))}\n                        </div>\n\n                        <div className=\"mt-12 text-center max-w-xl\">\n                            <h3 className=\"text-zinc-400 font-bold mb-2\">Instructions</h3>\n                            <p className=\"text-zinc-500 text-xs leading-relaxed\">\n                                1. Drag a <span className=\"text-zinc-300\">Food Sample</span> into a test tube.<br />\n                                2. Drag the correct <span className=\"text-zinc-300\">Reagent</span> to test for nutrients.<br />\n                                3. For Benedict&apos;s solution, click the <span className=\"text-red-400\">üî• Flame</span> icon to heat.<br />\n                                4. Observe the color change to identify the nutrient!\n                            </p>\n                        </div>\n\n                        {/* Particles */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{ x: p.x + p.velocity.x, y: p.y + p.velocity.y, scale: 0, opacity: 0 }}\n                                transition={{ duration: 0.8 }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{ width: p.size, height: p.size, backgroundColor: p.color }}\n                            />\n                        ))}\n\n                    </main>\n                </div>\n\n                <DragOverlay>\n                    {activeItem && <DraggableItem {...activeItem} isOverlay />}\n                </DragOverlay>\n\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-osmosis-potato/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[104,121],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'scoreEquipmentChoice' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":30,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"scoreEquipmentChoice"},"fix":{"range":[331,399],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'cuttingActive' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setCuttingActive' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showResults' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":33,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":402,"column":122,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":402,"endColumn":125,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23019,23022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23019,23022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useCallback, useMemo, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport ScienceLabLayout from '@/components/science/ScienceLabLayout';\nimport { BrightLayer } from '@/components/system';\nimport { simulateOsmosis } from '@/lib/science/chemical-logic';\nimport { scoreEquipmentChoice } from '@/lib/science/lab-inventory';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\ninterface PotatoStrip {\n    id: string;\n    initialLength: number;\n    currentLength: number;\n    solution: 'hypotonic' | 'isotonic' | 'hypertonic' | null;\n    texture: 'turgid' | 'normal' | 'flaccid';\n}\n\ninterface DataEntry {\n    solution: string;\n    initialLength: number;\n    finalLength: number;\n    change: number;\n    changePercent: number;\n}\n\nexport default function OsmosisLabPage() {\n    const [currentStep, setCurrentStep] = useState(0);\n    const [score, setScore] = useState(100);\n    const [strips, setStrips] = useState<PotatoStrip[]>([]);\n    const [cuttingActive, setCuttingActive] = useState(false);\n    const [stripLength, setStripLength] = useState<number>(5.0);\n    const [showResults, setShowResults] = useState(false);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [labLog, setLabLog] = useState<string[]>([]);\n\n    const { completeLab, result } = useLabCompletion();\n\n    const solutions = [\n        { id: 'hypotonic', name: 'Distilled Water', color: 'bg-blue-400', icon: 'üíß' },\n        { id: 'isotonic', name: '0.5M Sucrose', color: 'bg-gray-400', icon: 'üßÇ' },\n        { id: 'hypertonic', name: '1M Sucrose', color: 'bg-amber-500', icon: 'üßÇ' }\n    ];\n\n    const [isMounted, setIsMounted] = useState(false);\n    \n    useEffect(() => {\n        setIsMounted(true);\n    }, []);\n\n    const addLog = useCallback((entry: string) => {\n        const timestamp = isMounted ? new Date().toLocaleTimeString() : '--:--';\n        setLabLog(prev => [...prev, `[${timestamp}] ${entry}`]);\n    }, [isMounted]);\n\n    const handleCutStrip = () => {\n        if (strips.length >= 3) {\n            addLog('Maximum 3 strips cut. Proceed to the next step.');\n            return;\n        }\n\n        // Check for uniformity\n        const variance = Math.abs(((strips.length * 7) % 40) * 0.01 - 0.2); // Deterministic based on strip count\n        const actualLength = +(stripLength + variance).toFixed(1);\n\n        const newStrip: PotatoStrip = {\n            id: `strip-${strips.length + 1}`,\n            initialLength: actualLength,\n            currentLength: actualLength,\n            solution: null,\n            texture: 'normal'\n        };\n\n        setStrips(prev => [...prev, newStrip]);\n        addLog(`Potato strip #${strips.length + 1} cut to ${actualLength} cm.`);\n\n        if (strips.length === 2) {\n            // After 3rd strip, advance\n            setCurrentStep(1);\n        }\n    };\n\n    const handlePlaceInSolution = (stripId: string, solutionType: 'hypotonic' | 'isotonic' | 'hypertonic') => {\n        setStrips(prev => prev.map(strip => {\n            if (strip.id === stripId) {\n                addLog(`Strip #${stripId.split('-')[1]} placed in ${solutionType === 'hypotonic' ? 'Distilled Water' : solutionType === 'isotonic' ? '0.5M Sucrose' : '1M Sucrose'}.`);\n                return { ...strip, solution: solutionType };\n            }\n            return strip;\n        }));\n\n        // Check if all strips are placed\n        const allPlaced = strips.filter(s => s.solution !== null).length === 2;\n        if (allPlaced) {\n            setCurrentStep(2);\n        }\n    };\n\n    const handleFastForward = () => {\n        addLog('Fast-forwarding 45 minutes...');\n        setCurrentStep(3);\n\n        // Simulate osmosis for each strip\n        setStrips(prev => prev.map(strip => {\n            if (strip.solution) {\n                const result = simulateOsmosis(strip.solution, strip.initialLength, 45);\n                return {\n                    ...strip,\n                    currentLength: result.finalLength,\n                    texture: result.texture\n                };\n            }\n            return strip;\n        }));\n\n        addLog('Time elapsed. Strips are ready for measurement.');\n    };\n\n    const handleMeasure = () => {\n        setShowResults(true);\n        setCurrentStep(4);\n        addLog('All strips measured. Compiling results into data table.');\n    };\n\n    const data: DataEntry[] = useMemo(() => {\n        return strips.map(strip => ({\n            solution: strip.solution === 'hypotonic' ? 'Distilled Water' : strip.solution === 'isotonic' ? '0.5M Sucrose' : '1M Sucrose',\n            initialLength: strip.initialLength,\n            finalLength: strip.currentLength,\n            change: +(strip.currentLength - strip.initialLength).toFixed(1),\n            changePercent: +((strip.currentLength - strip.initialLength) / strip.initialLength * 100).toFixed(1)\n        }));\n    }, [strips]);\n\n    const handleComplete = async () => {\n        await completeLab('bio-osmosis-potato', 250, score);\n        setShowSuccess(true);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-emerald-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <motion.div\n                        animate={{ rotate: [0, 10, -10, 0] }}\n                        transition={{ repeat: 2, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        ü•î‚úÖ\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-emerald-400 mb-4 uppercase tracking-tight\">\n                        Practical Complete\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8 leading-relaxed\">\n                        You demonstrated that water moves by <span className=\"text-emerald-400 font-bold\">osmosis</span> from\n                        regions of high water potential to regions of low water potential.\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Final Score</div>\n                            <div className=\"text-3xl font-black text-emerald-400\">{score}/100</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+250'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <div className=\"p-6 rounded-3xl bg-blue-900/30 border border-blue-500/20 text-left mb-8\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-blue-400 mb-3\">Key Conclusion</div>\n                        <p className=\"text-zinc-200 font-medium\">\n                            In <span className=\"text-blue-400 font-bold\">hypotonic solutions</span> (distilled water), water enters the potato cells, making them turgid.\n                            In <span className=\"text-amber-400 font-bold\">hypertonic solutions</span> (concentrated salt), water leaves the cells, causing them to become flaccid.\n                        </p>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <ScienceLabLayout\n            labTitle=\"Osmosis: Potato Strip Experiment\"\n            syllabusSection=\"Section B: Life Processes\"\n            objectives={[\n                'Cut uniform potato strips',\n                'Place strips in solutions of varying concentrations',\n                'Measure changes in length and texture',\n                'Graph and analyze results'\n            ]}\n            equipment={[\n                { name: 'Cork Borer', icon: '‚≠ï' },\n                { name: 'Ruler', icon: 'üìè' },\n                { name: 'Scalpel', icon: 'üî™' },\n                { name: 'Beakers (3)', icon: 'ü´ô' },\n                { name: 'Distilled Water', icon: 'üíß' },\n                { name: 'Sucrose Solutions', icon: 'üßÇ' },\n                { name: 'Forceps', icon: 'ü•¢' }\n            ]}\n            currentStep={currentStep}\n            totalSteps={5}\n        >\n            <div className=\"h-full flex flex-col p-8 overflow-y-auto\">\n                {/* Active Step Instruction */}\n                <div className=\"mb-8\">\n                    <div className=\"inline-flex items-center gap-3 px-5 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 mb-4\">\n                        <span className=\"text-[10px] font-black uppercase tracking-widest text-emerald-500\">Step {currentStep + 1} of 5</span>\n                    </div>\n                    <h2 className=\"text-2xl font-black tracking-tight text-white mb-2\">\n                        {currentStep === 0 && 'Cut Potato Strips'}\n                        {currentStep === 1 && 'Place Strips in Solutions'}\n                        {currentStep === 2 && 'Wait for Osmosis'}\n                        {currentStep === 3 && 'Measure & Record'}\n                        {currentStep === 4 && 'Analyze Results'}\n                    </h2>\n                    <p className=\"text-zinc-400 font-medium\">\n                        {currentStep === 0 && 'Use the cork borer to cut 3 uniform potato strips of identical length.'}\n                        {currentStep === 1 && 'Drag each strip into a different solution beaker.'}\n                        {currentStep === 2 && 'Fast-forward time to allow osmosis to occur.'}\n                        {currentStep === 3 && 'Measure the final length of each strip.'}\n                        {currentStep === 4 && 'Review the data table and answer the analysis question.'}\n                    </p>\n                </div>\n\n                {/* Main Workbench */}\n                <div className=\"flex-1 grid grid-cols-2 gap-8\">\n                    {/* Left: Cutting Station / Strips */}\n                    <div>\n                        {currentStep === 0 && (\n                            <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"h-full\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Cutting Station</div>\n\n                                <div className=\"flex flex-col items-center justify-center h-[calc(100%-4rem)]\">\n                                    <div className=\"w-48 h-48 bg-amber-700 rounded-3xl flex items-center justify-center text-6xl mb-8 shadow-2xl\">\n                                        ü•î\n                                    </div>\n\n                                    <div className=\"w-full max-w-xs mb-6\">\n                                        <label className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 mb-2 block\">Target Length (cm)</label>\n                                        <div className=\"flex items-center gap-4\">\n                                            <input\n                                                type=\"range\"\n                                                min={3}\n                                                max={7}\n                                                step={0.5}\n                                                value={stripLength}\n                                                onChange={(e) => setStripLength(parseFloat(e.target.value))}\n                                                className=\"flex-1 accent-emerald-500\"\n                                            />\n                                            <span className=\"text-xl font-black text-white w-16 text-center\">{stripLength}</span>\n                                        </div>\n                                    </div>\n\n                                    <button\n                                        onClick={handleCutStrip}\n                                        disabled={strips.length >= 3}\n                                        className={`px-10 py-4 rounded-2xl font-black text-sm uppercase tracking-widest transition-all ${strips.length >= 3\n                                            ? 'bg-zinc-800 text-zinc-600 cursor-not-allowed'\n                                            : 'bg-emerald-500 text-white hover:bg-emerald-400'\n                                            }`}\n                                    >\n                                        Cut Strip ({strips.length}/3)\n                                    </button>\n                                </div>\n                            </BrightLayer>\n                        )}\n\n                        {currentStep >= 1 && currentStep < 4 && (\n                            <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"h-full\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Potato Strips</div>\n                                <div className=\"space-y-4\">\n                                    {strips.map((strip, i) => (\n                                        <div key={strip.id} className=\"p-4 rounded-2xl bg-white/5 border border-[#3D3D5C] flex items-center justify-between\">\n                                            <div className=\"flex items-center gap-4\">\n                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl ${strip.texture === 'turgid' ? 'bg-blue-500' : strip.texture === 'flaccid' ? 'bg-amber-800' : 'bg-amber-600'\n                                                    }`}>\n                                                    ü•î\n                                                </div>\n                                                <div>\n                                                    <div className=\"text-sm font-black text-white\">Strip #{i + 1}</div>\n                                                    <div className=\"text-xs text-zinc-400\">\n                                                        {strip.solution ? (\n                                                            <span className={`${strip.solution === 'hypotonic' ? 'text-blue-400' : strip.solution === 'hypertonic' ? 'text-amber-400' : 'text-zinc-400'}`}>\n                                                                In {strip.solution === 'hypotonic' ? 'Distilled Water' : strip.solution === 'isotonic' ? '0.5M Sucrose' : '1M Sucrose'}\n                                                            </span>\n                                                        ) : 'Not placed'}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                            <div className=\"text-right\">\n                                                <div className=\"text-lg font-black text-white\">{strip.currentLength} cm</div>\n                                                {currentStep >= 3 && strip.solution && (\n                                                    <div className={`text-xs font-black ${strip.currentLength > strip.initialLength ? 'text-blue-400' : strip.currentLength < strip.initialLength ? 'text-red-400' : 'text-zinc-400'}`}>\n                                                        {strip.currentLength > strip.initialLength ? '+' : ''}{(strip.currentLength - strip.initialLength).toFixed(1)} cm\n                                                    </div>\n                                                )}\n                                            </div>\n                                        </div>\n                                    ))}\n                                </div>\n\n                                {currentStep === 2 && (\n                                    <button\n                                        onClick={handleFastForward}\n                                        className=\"mt-8 w-full px-8 py-4 rounded-2xl bg-blue-500 text-white font-black text-sm uppercase tracking-widest hover:bg-blue-400 transition-all\"\n                                    >\n                                        ‚è© Fast Forward 45 Minutes\n                                    </button>\n                                )}\n\n                                {currentStep === 3 && (\n                                    <button\n                                        onClick={handleMeasure}\n                                        className=\"mt-8 w-full px-8 py-4 rounded-2xl bg-emerald-500 text-white font-black text-sm uppercase tracking-widest hover:bg-emerald-400 transition-all\"\n                                    >\n                                        üìè Measure All Strips\n                                    </button>\n                                )}\n                            </BrightLayer>\n                        )}\n\n                        {currentStep === 4 && (\n                            <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"h-full\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Data Table</div>\n                                <table className=\"w-full text-sm\">\n                                    <thead>\n                                        <tr className=\"text-left text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                                            <th className=\"pb-4\">Solution</th>\n                                            <th className=\"pb-4\">Initial (cm)</th>\n                                            <th className=\"pb-4\">Final (cm)</th>\n                                            <th className=\"pb-4\">Change (%)</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        {data.map((row, i) => (\n                                            <tr key={i} className=\"border-t border-white/5\">\n                                                <td className=\"py-3 font-bold text-white\">{row.solution}</td>\n                                                <td className=\"py-3 text-zinc-400\">{row.initialLength}</td>\n                                                <td className=\"py-3 text-zinc-400\">{row.finalLength}</td>\n                                                <td className={`py-3 font-black ${row.changePercent > 0 ? 'text-emerald-400' : row.changePercent < 0 ? 'text-red-400' : 'text-zinc-400'}`}>\n                                                    {row.changePercent > 0 ? '+' : ''}{row.changePercent}%\n                                                </td>\n                                            </tr>\n                                        ))}\n                                    </tbody>\n                                </table>\n                            </BrightLayer>\n                        )}\n                    </div>\n\n                    {/* Right: Solutions / Analysis */}\n                    <div>\n                        {currentStep === 1 && (\n                            <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"h-full\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Solution Beakers</div>\n                                <div className=\"space-y-4\">\n                                    {solutions.map((sol) => {\n                                        const stripInSolution = strips.find(s => s.solution === sol.id);\n                                        return (\n                                            <div\n                                                key={sol.id}\n                                                className={`p-6 rounded-3xl border-2 transition-all ${stripInSolution\n                                                    ? 'border-emerald-500/50 bg-emerald-500/5'\n                                                    : 'border-[#3D3D5C] bg-[#131325] hover:border-white/20'\n                                                    }`}\n                                            >\n                                                <div className=\"flex items-center justify-between mb-4\">\n                                                    <div className=\"flex items-center gap-3\">\n                                                        <div className={`w-12 h-12 rounded-2xl ${sol.color} flex items-center justify-center text-2xl`}>\n                                                            {sol.icon}\n                                                        </div>\n                                                        <div>\n                                                            <div className=\"text-sm font-black text-white\">{sol.name}</div>\n                                                            <div className=\"text-[10px] font-bold text-zinc-500 uppercase\">\n                                                                {sol.id === 'hypotonic' ? 'Hypotonic' : sol.id === 'isotonic' ? 'Isotonic' : 'Hypertonic'}\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    {stripInSolution && (\n                                                        <span className=\"text-[10px] font-black uppercase tracking-widest text-emerald-400\">‚úì Strip Added</span>\n                                                    )}\n                                                </div>\n                                                {!stripInSolution && (\n                                                    <div className=\"flex gap-2\">\n                                                        {strips.filter(s => !s.solution).map((strip, i) => (\n                                                            <button\n                                                                key={strip.id}\n                                                                onClick={() => handlePlaceInSolution(strip.id, sol.id as any)}\n                                                                className=\"flex-1 px-4 py-2 rounded-xl bg-white/5 border border-[#3D3D5C] text-xs font-black text-zinc-300 hover:bg-white/10 transition-all\"\n                                                            >\n                                                                Add Strip #{i + 1}\n                                                            </button>\n                                                        ))}\n                                                    </div>\n                                                )}\n                                            </div>\n                                        );\n                                    })}\n                                </div>\n                            </BrightLayer>\n                        )}\n\n                        {currentStep === 4 && (\n                            <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"h-full flex flex-col\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Analysis Question</div>\n\n                                <div className=\"p-6 rounded-3xl bg-indigo-500/10 border border-indigo-500/20 mb-6\">\n                                    <p className=\"text-white font-medium leading-relaxed\">\n                                        Why did the potato strip in the <span className=\"text-amber-400 font-bold\">concentrated sucrose solution</span> become shorter and floppier?\n                                    </p>\n                                </div>\n\n                                <div className=\"space-y-4\">\n                                    <button\n                                        onClick={() => {\n                                            addLog('Incorrect answer selected: Sugar entered the potato.');\n                                            setScore(prev => prev - 10);\n                                        }}\n                                        className=\"w-full p-4 rounded-2xl bg-white/5 border border-[#3D3D5C] text-left hover:bg-red-500/10 hover:border-red-500/20 transition-all\"\n                                    >\n                                        <span className=\"text-sm font-bold text-zinc-300\">A) Sugar entered the potato cells.</span>\n                                    </button>\n                                    <button\n                                        onClick={() => {\n                                            addLog('Correct answer: Water left the potato by osmosis.');\n                                            handleComplete();\n                                        }}\n                                        className=\"w-full p-4 rounded-2xl bg-white/5 border border-[#3D3D5C] text-left hover:bg-emerald-500/10 hover:border-emerald-500/20 transition-all\"\n                                    >\n                                        <span className=\"text-sm font-bold text-zinc-300\">B) Water left the potato cells by osmosis, moving to the region of lower water potential.</span>\n                                    </button>\n                                    <button\n                                        onClick={() => {\n                                            addLog('Incorrect answer selected.');\n                                            setScore(prev => prev - 10);\n                                        }}\n                                        className=\"w-full p-4 rounded-2xl bg-white/5 border border-[#3D3D5C] text-left hover:bg-red-500/10 hover:border-red-500/20 transition-all\"\n                                    >\n                                        <span className=\"text-sm font-bold text-zinc-300\">C) The potato cells absorbed salt.</span>\n                                    </button>\n                                </div>\n                            </BrightLayer>\n                        )}\n                    </div>\n                </div>\n\n                {/* Lab Log */}\n                <div className=\"mt-8 p-4 rounded-2xl bg-black/40 border border-white/5 max-h-32 overflow-y-auto font-mono text-xs text-zinc-400\">\n                    {labLog.length === 0 ? (\n                        <div className=\"text-zinc-600\">Lab session started. Awaiting actions...</div>\n                    ) : (\n                        labLog.map((entry, i) => <div key={i}>{entry}</div>)\n                    )}\n                </div>\n            </div>\n        </ScienceLabLayout>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-photosynthesis/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[50,63],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[95,112],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":177,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":177,"endColumn":80},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'resetToIdle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":177,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":177,"endColumn":93},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":211,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7724,7727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7724,7727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype LeafState = 'fresh' | 'boiled' | 'decolorized' | 'rinsed' | 'stained';\ntype LeafColor = 'green' | 'pale_green' | 'white' | 'soft_white' | 'blue_black';\n\ninterface LabTool {\n    id: string;\n    name: string;\n    icon: string;\n    type: 'solution' | 'heat' | 'tool';\n}\n\nconst TOOLS: LabTool[] = [\n    { id: 'boiling_water', name: 'Boiling Water', icon: '‚ô®Ô∏è', type: 'heat' },\n    { id: 'water_bath', name: 'Water Bath', icon: 'ü´ß', type: 'heat' },\n    { id: 'ethanol', name: 'Ethanol', icon: 'üß™', type: 'solution' },\n    { id: 'warm_water', name: 'Warm Water', icon: 'üíß', type: 'solution' },\n    { id: 'iodine', name: 'Iodine', icon: 'üü§', type: 'solution' },\n    { id: 'forceps', name: 'Forceps', icon: 'ü•¢', type: 'tool' },\n];\n\n// ==========================================\n// DRAGGABLE TOOL\n// ==========================================\n\nfunction DraggableTool({ tool, isOverlay }: { tool: LabTool; isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n        id: tool.id\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-4 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F]  border border-[#3D3D5C]\n        transition-all select-none\n        hover:bg-white/[0.08] hover:border-emerald-500/30\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20 scale-110' : ''}\n      `}\n        >\n            <div className=\"flex items-center gap-3\">\n                <span className=\"text-2xl\">{tool.icon}</span>\n                <span className=\"text-sm font-black text-white\">{tool.name}</span>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// LEAF SPECIMEN (DROP TARGET)\n// ==========================================\n\nfunction LeafSpecimen({\n    state,\n    color,\n    isHovering,\n    isReject\n}: {\n    state: LeafState;\n    color: LeafColor;\n    isHovering: boolean;\n    isReject: boolean;\n}) {\n    const { setNodeRef } = useDroppable({ id: 'leaf' });\n\n    const colorMap: Record<LeafColor, string> = {\n        green: 'bg-green-500',\n        pale_green: 'bg-green-400/70',\n        white: 'bg-gray-200',\n        soft_white: 'bg-gray-100',\n        blue_black: 'bg-indigo-900'\n    };\n\n    const stateLabels: Record<LeafState, string> = {\n        fresh: 'Fresh Leaf',\n        boiled: 'Boiled (Enzymes Killed)',\n        decolorized: 'Decolorized (Chlorophyll Removed)',\n        rinsed: 'Rinsed (Softened)',\n        stained: 'Stained with Iodine'\n    };\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={\n                isReject\n                    ? { x: [0, -10, 10, -10, 10, 0], borderColor: 'rgba(239, 68, 68, 0.5)' }\n                    : isHovering\n                        ? { scale: 1.05, borderColor: 'rgba(16, 185, 129, 0.8)' }\n                        : { scale: 1, borderColor: 'rgba(255, 255, 255, 0.1)' }\n            }\n            className={`\n        relative p-8 rounded-[3rem] border-4 transition-all\n        bg-gradient-to-br from-white/5 to-white/[0.02] \n        flex flex-col items-center justify-center min-h-[300px]\n        ${isHovering ? 'shadow-2xl shadow-emerald-500/30' : ''}\n      `}\n        >\n            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                Specimen\n            </div>\n\n            <motion.div\n                animate={{\n                    rotate: state === 'boiled' ? [0, 2, -2, 0] : 0,\n                    scale: state === 'stained' ? [1, 1.05, 1] : 1\n                }}\n                transition={{ duration: 0.5 }}\n                className={`\n          w-40 h-40 rounded-[2.5rem] ${colorMap[color]} \n          flex items-center justify-center text-6xl\n          shadow-2xl transition-all duration-500 relative overflow-hidden\n        `}\n            >\n                {color === 'blue_black' && (\n                    <div className=\"absolute inset-0 bg-[radial-gradient(circle,transparent_30%,rgba(0,0,0,0.5)_100%)]\" />\n                )}\n                üçÉ\n            </motion.div>\n\n            <div className=\"mt-6 text-center\">\n                <div className=\"text-lg font-black text-white\">{stateLabels[state]}</div>\n                <div className=\"text-[10px] text-zinc-500 mt-1 uppercase tracking-widest\">\n                    Color: {color.replace('_', ' ')}\n                </div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// MAIN PHOTOSYNTHESIS LAB V2\n// ==========================================\n\nexport default function PhotosynthesisLabV2Page() {\n    const [leafState, setLeafState] = useState<LeafState>('fresh');\n    const [leafColor, setLeafColor] = useState<LeafColor>('green');\n    const [activeTool, setActiveTool] = useState<LabTool | null>(null);\n    const [hoveringLeaf, setHoveringLeaf] = useState(false);\n    const [rejectAction, setRejectAction] = useState(false);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [score, setScore] = useState(100);\n    const [currentStep, setCurrentStep] = useState(0);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [showFailure, setShowFailure] = useState(false);\n    const [labLog, setLabLog] = useState<string[]>([]);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint, resetToIdle } = useProfessor({\n        initialMessage: \"We need to test this leaf for starch. Start by boiling it!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    const [isMounted, setIsMounted] = useState(false);\n    \n    useEffect(() => {\n        setIsMounted(true);\n    }, []);\n\n    const addLog = (entry: string) => {\n        const timestamp = isMounted ? new Date().toLocaleTimeString() : '--:--';\n        setLabLog(prev => [...prev, `[${timestamp}] ${entry}`]);\n    };\n\n    const steps = [\n        { id: 0, tool: 'boiling_water', nextState: 'boiled', nextColor: 'pale_green', message: 'Leaf boiled! Enzymes denatured.' },\n        { id: 1, tool: 'water_bath', nextState: 'decolorized', nextColor: 'white', message: 'Ethanol in water bath decolorized the leaf!' },\n        { id: 2, tool: 'warm_water', nextState: 'rinsed', nextColor: 'soft_white', message: 'Leaf softened in warm water!' },\n        { id: 3, tool: 'iodine', nextState: 'stained', nextColor: 'blue_black', message: 'Starch detected! The leaf turned blue-black!' }\n    ];\n\n    const handleDragStart = (event: DragStartEvent) => {\n        const tool = TOOLS.find(t => t.id === event.active.id);\n        setActiveTool(tool || null);\n    };\n\n    const handleDragOver = (event: any) => {\n        if (event.over?.id === 'leaf') {\n            setHoveringLeaf(true);\n        } else {\n            setHoveringLeaf(false);\n        }\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { active, over } = event;\n        setActiveTool(null);\n        setHoveringLeaf(false);\n        setRejectAction(false);\n\n        if (!over || over.id !== 'leaf') return;\n\n        const toolId = active.id as string;\n        const currentStepConfig = steps[currentStep];\n\n        // SAFETY CHECK: Ethanol directly (without water bath first)\n        if (toolId === 'ethanol' && currentStep < 1) {\n            setShowFailure(true);\n            return;\n        }\n\n        // Check if correct tool for current step\n        if (currentStepConfig && toolId === currentStepConfig.tool) {\n            // SUCCESS!\n            setLeafState(currentStepConfig.nextState as LeafState);\n            setLeafColor(currentStepConfig.nextColor as LeafColor);\n            addLog(currentStepConfig.message);\n\n            // Particle effect\n            const color = currentStep === 3 ? '#3730A3' : '#10B981';\n            setParticles(createParticles(400, 250, 25, color));\n            setTimeout(() => setParticles([]), 1000);\n\n            showProfessorSuccess(currentStepConfig.message);\n            setCurrentStep(prev => prev + 1);\n\n            if (currentStep === 3) {\n                completeLab('bio-photosynthesis', 150, score);\n                setTimeout(() => setShowSuccess(true), 2000);\n            }\n        } else {\n            // Wrong tool\n            setRejectAction(true);\n            setTimeout(() => setRejectAction(false), 500);\n            setScore(prev => prev - 5);\n\n            const expectedTool = TOOLS.find(t => t.id === currentStepConfig?.tool);\n            showWarning(`That's not the right step! Try using ${expectedTool?.name} first.`);\n        }\n    };\n\n    if (showFailure) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0 }}\n                    animate={{ scale: 1 }}\n                    className=\"text-center max-w-2xl px-8\"\n                >\n                    <motion.div\n                        animate={{ scale: [1, 1.2, 1], opacity: [1, 0.8, 1] }}\n                        transition={{ repeat: Infinity, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        üî•\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-red-500 mb-6 uppercase tracking-tight\">\n                        Lab Safety Violation!\n                    </h1>\n                    <p className=\"text-xl text-white mb-8 leading-relaxed\">\n                        üß™ Ethanol is highly flammable! Never heat it with a direct flame.\n                    </p>\n                    <div className=\"p-6 rounded-3xl bg-red-500/10 border-2 border-red-500/30 mb-8\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-red-500 mb-3\">What You Should Have Done</div>\n                        <p className=\"text-zinc-300 font-medium leading-relaxed\">\n                            Use a <span className=\"text-white font-bold\">water bath</span>: Heat water first, then place the ethanol container in the hot water. This indirectly warms the ethanol safely.\n                        </p>\n                    </div>\n                    <button\n                        onClick={() => window.location.reload()}\n                        className=\"px-10 py-4 rounded-2xl bg-red-500 text-white font-black uppercase tracking-widest hover:bg-red-400 transition-colors\"\n                    >\n                        Restart Lab\n                    </button>\n                </motion.div>\n            </div>\n        );\n    }\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-indigo-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <motion.div\n                        animate={{ rotate: [0, 10, -10, 0] }}\n                        transition={{ repeat: 2, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        üß™‚úÖ\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-indigo-400 mb-4 uppercase tracking-tight\">\n                        Starch Detected!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        The leaf turned <span className=\"text-indigo-400 font-bold\">blue-black</span>, proving that\n                        <span className=\"text-white font-bold\"> photosynthesis</span> occurred and starch was produced!\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Score</div>\n                            <div className=\"text-3xl font-black text-emerald-400\">{score}/100</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+150'}\n                            </div>\n                        </div>\n                    </div>\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-indigo-500 text-white font-black uppercase tracking-widest hover:bg-indigo-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1220] to-[#050A12] overflow-hidden\">\n                {/* Background Effects */}\n                <div className=\"absolute inset-0\">\n                    <div className=\"absolute top-0 left-1/4 w-1/2 h-1/3 bg-emerald-500/5 blur-[200px] rounded-full\" />\n                    <div className=\"absolute bottom-0 right-1/3 w-1/3 h-1/3 bg-indigo-500/5 blur-[150px] rounded-full\" />\n                </div>\n\n                {/* Header */}\n                <header className=\"relative z-50 h-16 bg-[#131325]  border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-white/10\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Testing a Leaf for Starch</div>\n                    </div>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                            Step: <span className=\"text-emerald-400\">{currentStep + 1}/4</span>\n                        </div>\n                        <div className=\"flex items-center gap-2 bg-black/30 px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                            <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                            <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                                Lab Active\n                            </span>\n                        </div>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Tool Shelf */}\n                    <aside className=\"w-72 bg-[#131325]  border-r border-[#3D3D5C] p-6 overflow-y-auto\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Equipment Shelf\n                        </div>\n                        <div className=\"space-y-3\">\n                            {TOOLS.map((tool) => (\n                                <DraggableTool key={tool.id} tool={tool} />\n                            ))}\n                        </div>\n\n                        {/* Step Guide */}\n                        <div className=\"mt-8 p-4 rounded-2xl bg-emerald-500/5 border border-emerald-500/20\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-emerald-500 mb-2\">Current Step</div>\n                            <p className=\"text-xs text-zinc-400\">\n                                {currentStep === 0 && \"Boil the leaf to kill enzymes\"}\n                                {currentStep === 1 && \"Use water bath to decolorize with ethanol\"}\n                                {currentStep === 2 && \"Rinse in warm water to soften\"}\n                                {currentStep === 3 && \"Add iodine to test for starch\"}\n                            </p>\n                        </div>\n                    </aside>\n\n                    {/* Center: Workbench */}\n                    <main className=\"flex-1 flex items-center justify-center p-8 relative\">\n                        <LeafSpecimen\n                            state={leafState}\n                            color={leafColor}\n                            isHovering={hoveringLeaf}\n                            isReject={rejectAction}\n                        />\n\n                        {/* Particle Effects */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{\n                                    x: p.x + p.velocity.x,\n                                    y: p.y + p.velocity.y,\n                                    scale: 0,\n                                    opacity: 0\n                                }}\n                                transition={{ duration: 0.8, ease: \"easeOut\" }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{\n                                    width: p.size,\n                                    height: p.size,\n                                    backgroundColor: p.color\n                                }}\n                            />\n                        ))}\n                    </main>\n\n                    {/* Right: Lab Log */}\n                    <aside className=\"w-80 bg-[#131325]  border-l border-[#3D3D5C] p-6 overflow-y-auto\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Lab Notebook\n                        </div>\n                        <div className=\"space-y-2 font-mono text-xs\">\n                            {labLog.length === 0 ? (\n                                <div className=\"text-zinc-600\">Awaiting first action...</div>\n                            ) : (\n                                labLog.map((entry, i) => (\n                                    <div key={i} className=\"text-zinc-400\">{entry}</div>\n                                ))\n                            )}\n                        </div>\n                    </aside>\n                </div>\n\n                {/* Drag Overlay */}\n                <DragOverlay>\n                    {activeTool && <DraggableTool tool={activeTool} isOverlay />}\n                </DragOverlay>\n\n                {/* Professor Bright */}\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-pulse-rate/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRef"},"fix":{"range":[50,58],"text":""},"desc":"Remove unused variable \"useRef\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'HeartRateData' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'taps' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":84,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showWarning' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":149,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":70}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype ActivityState = 'rest' | 'light' | 'intense';\n\ninterface HeartRateData {\n    time: number;\n    bpm: number;\n}\n\nconst ACTIVITIES: { id: ActivityState; name: string; targetBPM: number; icon: string; description: string }[] = [\n    { id: 'rest', name: 'Resting', targetBPM: 70, icon: 'üßò', description: 'Sit quietly and relax.' },\n    { id: 'light', name: 'Light Exercise', targetBPM: 110, icon: 'üö∂', description: 'Walk in place for 1 minute.' },\n    { id: 'intense', name: 'Intense Exercise', targetBPM: 150, icon: 'üèÉ', description: 'Jumping jacks for 1 minute!' }\n];\n\n// ==========================================\n// PULSE VISUALIZER\n// ==========================================\n\nfunction PulseVisualizer({ bpm, isActive }: { bpm: number; isActive: boolean }) {\n    // Calculate pulse duration in seconds (e.g., 60bpm = 1s, 120bpm = 0.5s)\n    const duration = 60 / (bpm || 60);\n\n    return (\n        <div className=\"relative w-64 h-64 flex items-center justify-center\">\n            {/* Heart Icon with Pulse Animation */}\n            <motion.div\n                animate={{\n                    scale: [1, 1.2, 1],\n                    color: bpm > 130 ? '#ef4444' : bpm > 100 ? '#f97316' : '#ec4899'\n                }}\n                transition={{\n                    duration: duration,\n                    ease: \"easeInOut\",\n                    repeat: Infinity,\n                    times: [0, 0.2, 1] // Quick beat, slower relax\n                }}\n                className=\"text-9xl relative z-10 drop-shadow-[0_0_30px_rgba(236,72,153,0.5)]\"\n            >\n                ‚ù§Ô∏è\n            </motion.div>\n\n            {/* Ripple Rings */}\n            <AnimatePresence>\n                {isActive && (\n                    <>\n                        <motion.div\n                            animate={{ scale: [1, 2], opacity: [0.5, 0] }}\n                            transition={{ duration: 1, repeat: Infinity, ease: \"easeOut\" }}\n                            className=\"absolute inset-0 rounded-full border-2 border-pink-500/50\"\n                        />\n                        <motion.div\n                            animate={{ scale: [1, 2.5], opacity: [0.3, 0] }}\n                            transition={{ duration: 1, repeat: Infinity, delay: 0.2, ease: \"easeOut\" }}\n                            className=\"absolute inset-0 rounded-full border border-pink-500/30\"\n                        />\n                    </>\n                )}\n            </AnimatePresence>\n\n            {/* BPM Display */}\n            <div className=\"absolute -bottom-12 text-center\">\n                <div className=\"text-4xl font-black text-white font-mono\">{Math.round(bpm)}</div>\n                <div className=\"text-[10px] font-black uppercase text-zinc-500 tracking-widest\">Est. BPM</div>\n            </div>\n        </div>\n    );\n}\n\n// ==========================================\n// TAP TEMPO BUTTON\n// ==========================================\n\nfunction TapCounter({ onComplete }: { onComplete: (bpm: number) => void }) {\n    const [taps, setTaps] = useState<number[]>([]);\n    const [calculatedBPM, setCalculatedBPM] = useState(0);\n\n    const handleTap = () => {\n        const now = Date.now();\n        setTaps(prev => {\n            // Keep only taps within last 5 seconds for moving average\n            const newTaps = [...prev, now].filter(t => now - t < 5000);\n\n            if (newTaps.length > 2) {\n                // Calculate BPM based on intervals\n                const intervals = [];\n                for (let i = 1; i < newTaps.length; i++) {\n                    intervals.push(newTaps[i] - newTaps[i - 1]);\n                }\n                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;\n                const bpm = Math.round(60000 / avgInterval);\n                setCalculatedBPM(bpm);\n            }\n            return newTaps;\n        });\n    };\n\n    return (\n        <div className=\"flex flex-col items-center gap-4\">\n            <button\n                onClick={handleTap}\n                className=\"w-48 h-48 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 border-4 border-white/20 shadow-2xl active:scale-95 transition-transform flex flex-col items-center justify-center group\"\n            >\n                <span className=\"text-4xl mb-2 group-active:scale-125 transition-transform\">üëÜ</span>\n                <span className=\"text-sm font-black text-white uppercase tracking-widest\">Tap Pulse</span>\n            </button>\n            <div className=\"text-center\">\n                <div className=\"text-[10px] text-zinc-500 uppercase tracking-widest mb-1\">Measured BPM</div>\n                <div className={`text-3xl font-black font-mono ${calculatedBPM > 0 ? 'text-white' : 'text-zinc-600'}`}>\n                    {calculatedBPM > 0 ? calculatedBPM : '--'}\n                </div>\n            </div>\n            {calculatedBPM > 0 && (\n                <button\n                    onClick={() => onComplete(calculatedBPM)}\n                    className=\"px-8 py-2 rounded-xl bg-emerald-500 text-white text-xs font-black uppercase tracking-widest hover:bg-emerald-400\"\n                >\n                    Confirm Measurement\n                </button>\n            )}\n        </div>\n    );\n}\n\n// ==========================================\n// MAIN LAB: PULSE RATE\n// ==========================================\n\nexport default function PulseRateLabPage() {\n    const [step, setStep] = useState<number>(0); // 0: Select, 1: Activity, 2: Measure, 3: Results\n    const [currentActivity, setCurrentActivity] = useState<ActivityState>('rest');\n    const [recordedData, setRecordedData] = useState<{ activity: string; bpm: number }[]>([]);\n\n    const [simulationBPM, setSimulationBPM] = useState(70);\n    const [isExercising, setIsExercising] = useState(false);\n    const [exerciseTimer, setExerciseTimer] = useState(0);\n\n    const [showSuccess, setShowSuccess] = useState(false);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint } = useProfessor({\n        initialMessage: \"Let's investigate how exercise affects your heart rate. Start by measuring your resting pulse!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    // Simulation Loop\n    useEffect(() => {\n        let interval: NodeJS.Timeout;\n\n        if (isExercising) {\n            interval = setInterval(() => {\n                setExerciseTimer(prev => {\n                    if (prev <= 0) {\n                        setIsExercising(false);\n                        setStep(2); // Go to Measure\n                        showProfessorSuccess(\"Time's up! Quickly measure your pulse now.\");\n                        return 0;\n                    }\n                    return prev - 1;\n                });\n            }, 1000);\n        }\n\n        return () => clearInterval(interval);\n    }, [isExercising, showProfessorSuccess]);\n\n    const selectActivity = (activity: ActivityState) => {\n        // If we already did this activity, warn\n        if (recordedData.find(d => d.activity === ACTIVITIES.find(a => a.id === activity)?.name)) {\n            showHint(\"You've already measured this. Try a different intensity!\");\n            // Allow retry if they really want, but hint strongly.\n        }\n\n        const act = ACTIVITIES.find(a => a.id === activity)!;\n        setCurrentActivity(activity);\n\n        if (activity === 'rest') {\n            setSimulationBPM(70);\n            setStep(2); // Skip straight to measure for rest\n            showProfessorSuccess(\"Relax... Now tap the button in time with your pulse.\");\n        } else {\n            setSimulationBPM(act.targetBPM);\n            setExerciseTimer(10); // Short burst for simulation\n            setStep(1); // Go to exercise\n        }\n    };\n\n    const startExercise = () => {\n        setIsExercising(true);\n    };\n\n    const handleMeasurement = (bpm: number) => {\n        const actName = ACTIVITIES.find(a => a.id === currentActivity)?.name || 'Unknown';\n\n        // Validation (Simulated logic)\n        // If the user taps terribly off rhythm compared to the \"target\" (simulationBPM), we could warn?\n        // But for gameplay fairness, we accept their measurement if it's within reason, \n        // OR we just assume they are measuring the *simulated* pulse which isn't there?\n        // Actually, this lab is tricky virtually.\n        // Let's assume the \"Tap Pulse\" button *generates* a simulated pulse haptic/visual cue they must match?\n        // OR simpler: The TapCounter *IS* the measurement tool. They just tap at a steady rhythm they \"feel\".\n        // Let's refine: We show the PulseVisualizer pulsating at the TARGET rate. The user must TAP to match it.\n\n        const diff = Math.abs(bpm - simulationBPM);\n        if (diff > 20) {\n            showHint(`Your measurement (${bpm}) is quite far from the expected pulse (~${simulationBPM}). Try to tap in sync with the heart animation!`);\n        } else {\n            setRecordedData(prev => [...prev, { activity: actName, bpm }]);\n            setStep(0); // Back to menu\n            showProfessorSuccess(`Recorded ${bpm} BPM for ${actName}.`);\n\n            if (recordedData.length + 1 >= 3) {\n                setTimeout(() => handleFinish(), 1500);\n            }\n        }\n    };\n\n    const handleFinish = async () => {\n        await completeLab('bio-pulse-rate', 250);\n        setShowSuccess(true);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-pink-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">üíì‚úÖ</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-pink-400 mb-4 uppercase tracking-tight\">\n                        Heart Rate Analyzed!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You confirmed that heart rate increases with exercise intensity to supply more oxygen to muscles.\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Activities</div>\n                            <div className=\"text-3xl font-black text-white\">{recordedData.length}/3</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+250'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden flex flex-col\">\n            {/* Header */}\n            <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6 shrink-0\">\n                <div className=\"flex items-center gap-4\">\n                    <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                        ‚Üê Exit Lab\n                    </a>\n                    <div className=\"h-6 w-px bg-zinc-700\" />\n                    <div className=\"text-sm font-black tracking-tight text-white\">Pulse Rate Investigation</div>\n                </div>\n                <div className=\"flex gap-2\">\n                    {recordedData.map((d, i) => (\n                        <div key={i} className=\"px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] text-zinc-400\">\n                            {d.activity}: <span className=\"text-pink-400 font-bold\">{d.bpm}</span>\n                        </div>\n                    ))}\n                </div>\n            </header>\n\n            <main className=\"flex-1 flex flex-col items-center justify-center p-8 relative\">\n\n                {/* Background Beat */}\n                <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none opacity-20\">\n                    {/* Can place a giant ECG line graphic here */}\n                </div>\n\n                <AnimatePresence mode=\"wait\">\n\n                    {/* STEP 0: SELECT ACTIVITY */}\n                    {step === 0 && (\n                        <motion.div\n                            key=\"select\"\n                            initial={{ opacity: 0, y: 20 }}\n                            animate={{ opacity: 1, y: 0 }}\n                            exit={{ opacity: 0, y: -20 }}\n                            className=\"w-full max-w-4xl grid grid-cols-3 gap-6\"\n                        >\n                            {ACTIVITIES.map(act => (\n                                <button\n                                    key={act.id}\n                                    onClick={() => selectActivity(act.id)}\n                                    className=\"group relative p-8 rounded-[2.5rem] bg-[#1B1B2F] border-2 border-[#3D3D5C] hover:border-pink-500 hover:bg-pink-500/10 transition-all text-left flex flex-col gap-4 overflow-hidden\"\n                                >\n                                    <div className=\"text-6xl mb-4 group-hover:scale-110 transition-transform duration-500\">{act.icon}</div>\n                                    <div className=\"relative z-10\">\n                                        <div className=\"text-xl font-black text-white mb-2\">{act.name}</div>\n                                        <div className=\"text-xs text-zinc-400 font-medium leading-relaxed\">{act.description}</div>\n                                    </div>\n                                    <div className=\"absolute top-0 right-0 p-6 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                        <div className=\"w-8 h-8 rounded-full bg-pink-500 flex items-center justify-center text-white\">‚ûú</div>\n                                    </div>\n                                </button>\n                            ))}\n                        </motion.div>\n                    )}\n\n                    {/* STEP 1: EXERCISE SIMULATION */}\n                    {step === 1 && (\n                        <motion.div\n                            key=\"exercise\"\n                            initial={{ scale: 0.9, opacity: 0 }}\n                            animate={{ scale: 1, opacity: 1 }}\n                            exit={{ scale: 1.1, opacity: 0 }}\n                            className=\"text-center\"\n                        >\n                            <h2 className=\"text-4xl font-black text-white mb-12 uppercase tracking-tight\">\n                                Perform Activity: <span className=\"text-pink-400\">{ACTIVITIES.find(a => a.id === currentActivity)?.name}</span>\n                            </h2>\n\n                            {!isExercising ? (\n                                <button\n                                    onClick={startExercise}\n                                    className=\"px-16 py-8 rounded-full bg-pink-600 text-white font-black text-2xl uppercase tracking-widest hover:bg-pink-500 shadow-[0_0_50px_rgba(236,72,153,0.4)] animate-pulse\"\n                                >\n                                    Start {exerciseTimer}s Timer\n                                </button>\n                            ) : (\n                                <div className=\"text-9xl font-black font-mono text-white tabular-nums\">\n                                    00:{exerciseTimer.toString().padStart(2, '0')}\n                                </div>\n                            )}\n\n                            <p className=\"mt-12 text-zinc-500 max-w-md mx-auto\">\n                                Run in place visually represented by the timer. Get your heart rate up!\n                            </p>\n                        </motion.div>\n                    )}\n\n                    {/* STEP 2: MEASURE PULSE */}\n                    {step === 2 && (\n                        <motion.div\n                            key=\"measure\"\n                            className=\"flex flex-col items-center gap-12\"\n                        >\n                            <div className=\"text-center\">\n                                <h3 className=\"text-zinc-400 font-bold uppercase tracking-widest mb-2\">Measurement Phase</h3>\n                                <h2 className=\"text-3xl font-black text-white\">Sync your tap with the heart!</h2>\n                            </div>\n\n                            <div className=\"flex items-center gap-24\">\n                                {/* Visual Target (The \"Patient's Pulse\") */}\n                                <div className=\"flex flex-col items-center\">\n                                    <div className=\"text-[10px] font-black uppercase text-zinc-500 mb-4 tracking-widest\">Target Rhythm</div>\n                                    <PulseVisualizer bpm={simulationBPM} isActive={true} />\n                                </div>\n\n                                {/* Arrow */}\n                                <div className=\"text-4xl text-zinc-700\">‚ûú</div>\n\n                                {/* User Input */}\n                                <TapCounter onComplete={handleMeasurement} />\n                            </div>\n                        </motion.div>\n                    )}\n\n                </AnimatePresence>\n\n            </main>\n\n            <ProfessorBright state={professor} />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-quadrat/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[93,110],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentCount' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":160,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":162,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":162,"endColumn":80},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7368,7371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7368,7371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useMemo, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ninterface WeedPatch {\n    id: string;\n    x: number;\n    y: number;\n}\n\ninterface QuadratSample {\n    id: number;\n    position: { x: number; y: number };\n    count: number;\n}\n\n// ==========================================\n// DRAGGABLE QUADRAT TOOL\n// ==========================================\n\nfunction DraggableQuadrat({ isOverlay }: { isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n        id: 'quadrat'\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-6 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-yellow-500/20  border-2 border-yellow-500/50\n        transition-all select-none text-center\n        hover:bg-yellow-500/30 hover:border-yellow-500\n        ${isOverlay ? 'shadow-2xl shadow-yellow-500/30 scale-110' : ''}\n      `}\n        >\n            <div className=\"text-4xl mb-2\">üî≤</div>\n            <div className=\"text-sm font-black text-yellow-400\">1m¬≤ Quadrat</div>\n            <div className=\"text-[9px] text-yellow-400/70 mt-1\">Drag to field</div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// FIELD DROP ZONE\n// ==========================================\n\nfunction FieldZone({\n    weeds,\n    samples,\n    isHovering,\n    hoverPosition\n}: {\n    weeds: WeedPatch[];\n    samples: QuadratSample[];\n    isHovering: boolean;\n    hoverPosition: { x: number; y: number } | null;\n}) {\n    const { setNodeRef } = useDroppable({ id: 'field' });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            className=\"relative w-full h-full rounded-[2rem] overflow-hidden border-2 border-[#3D3D5C]\"\n        >\n            {/* Grass Background */}\n            <div className=\"absolute inset-0 bg-gradient-to-b from-green-900/60 to-green-950/80\">\n                <div\n                    className=\"absolute inset-0 opacity-40\"\n                    style={{\n                        backgroundImage: `radial-gradient(circle, #22c55e 1px, transparent 1px)`,\n                        backgroundSize: '12px 12px'\n                    }}\n                />\n            </div>\n\n            {/* Weed Patches */}\n            {weeds.map((weed) => (\n                <div\n                    key={weed.id}\n                    className=\"absolute text-xl transition-transform hover:scale-125\"\n                    style={{ left: `${weed.x}%`, top: `${weed.y}%` }}\n                >\n                    üåø\n                </div>\n            ))}\n\n            {/* Previous Quadrat Samples */}\n            {samples.map((sample) => (\n                <motion.div\n                    key={sample.id}\n                    initial={{ opacity: 0 }}\n                    animate={{ opacity: 0.3 }}\n                    className=\"absolute w-[18%] h-[18%] border-2 border-dashed border-yellow-500/50 bg-yellow-500/5 rounded-lg\"\n                    style={{ left: `${sample.position.x}%`, top: `${sample.position.y}%` }}\n                />\n            ))}\n\n            {/* Hover Preview */}\n            {isHovering && hoverPosition && (\n                <motion.div\n                    initial={{ opacity: 0, scale: 0.9 }}\n                    animate={{ opacity: 1, scale: 1 }}\n                    className=\"absolute w-[18%] h-[18%] border-4 border-yellow-400 bg-yellow-400/20 rounded-lg pointer-events-none\"\n                    style={{ left: `${hoverPosition.x}%`, top: `${hoverPosition.y}%` }}\n                >\n                    <div className=\"absolute -top-6 left-0 text-[9px] font-black uppercase tracking-widest text-yellow-400 bg-black/60 px-2 py-1 rounded\">\n                        Drop Here\n                    </div>\n                </motion.div>\n            )}\n\n            {/* Field Label */}\n            <div className=\"absolute top-4 left-4 bg-black/50 px-3 py-1 rounded-lg\">\n                <span className=\"text-[9px] font-black uppercase tracking-widest text-white/70\">\n                    Virtual Field (5m √ó 5m)\n                </span>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// MAIN QUADRAT LAB V2\n// ==========================================\n\nexport default function QuadratLabV2Page() {\n    const [samples, setSamples] = useState<QuadratSample[]>([]);\n    const [hoveringField, setHoveringField] = useState(false);\n    const [hoverPosition, setHoverPosition] = useState<{ x: number; y: number } | null>(null);\n    const [isDraggingQuadrat, setIsDraggingQuadrat] = useState(false);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n    const [currentCount, setCurrentCount] = useState<number | null>(null);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint, resetToIdle } = useProfessor({\n        initialMessage: \"Drag the quadrat onto the field to sample different areas. We need at least 10 samples for reliable data!\"\n    });\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    // Generate random weed patches\n    const weeds = useMemo(() => {\n        const patches: WeedPatch[] = [];\n        const numWeeds = 50;\n        for (let i = 0; i < numWeeds; i++) {\n            patches.push({\n                id: `weed-${i}`,\n                x: (i * 17) % 95, // Deterministic based on index\n                y: ((i * 23) % 95) // Deterministic based on index\n            });\n        }\n        return patches;\n    }, []);\n\n    // Count weeds in a quadrat at position\n    const countWeedsInQuadrat = useCallback((x: number, y: number): number => {\n        const quadratSize = 18; // 18% of field\n        return weeds.filter(w =>\n            w.x >= x && w.x <= x + quadratSize &&\n            w.y >= y && w.y <= y + quadratSize\n        ).length;\n    }, [weeds]);\n\n    const averageCount = useMemo(() => {\n        if (samples.length === 0) return 0;\n        return +(samples.reduce((sum, s) => sum + s.count, 0) / samples.length).toFixed(1);\n    }, [samples]);\n\n    const estimatedPopulation = useMemo(() => {\n        return Math.round(averageCount * 25); // 25 quadrats fit in field\n    }, [averageCount]);\n\n    const handleDragStart = (event: DragStartEvent) => {\n        if (event.active.id === 'quadrat') {\n            setIsDraggingQuadrat(true);\n        }\n    };\n\n    const handleDragOver = (event: any) => {\n        if (event.over?.id === 'field') {\n            setHoveringField(true);\n            // Deterministic position for preview based on timestamp\n            const time = Date.now() / 1000;\n            setHoverPosition({\n                x: (time * 7) % 75,\n                y: (time * 11) % 75\n            });\n        } else {\n            setHoveringField(false);\n            setHoverPosition(null);\n        }\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { over } = event;\n        setIsDraggingQuadrat(false);\n        setHoveringField(false);\n\n        if (over?.id !== 'field') {\n            setHoverPosition(null);\n            return;\n        }\n\n        // Deterministic placement\n        const x = (samples.length * 13) % 75;\n        const y = (samples.length * 17) % 75;\n        const count = countWeedsInQuadrat(x, y);\n\n        const newSample: QuadratSample = {\n            id: samples.length + 1,\n            position: { x, y },\n            count\n        };\n\n        setSamples(prev => [...prev, newSample]);\n        setCurrentCount(count);\n\n        // Particle effect\n        setParticles(createParticles(400, 300, 20, '#22C55E'));\n        setTimeout(() => setParticles([]), 1000);\n\n        showProfessorSuccess(`Sample #${newSample.id}: ${count} organisms counted!`);\n\n        // Check completion\n        if (samples.length + 1 >= 10) {\n            setTimeout(() => resetToIdle(\"Great work! You have enough samples. Click 'Complete Study' when ready.\"), 1500);\n        }\n\n        setHoverPosition(null);\n    };\n\n    const { completeLab, result } = useLabCompletion();\n\n    const handleComplete = async () => {\n        if (samples.length < 5) {\n            showWarning(\"You need at least 5 samples for any meaningful data!\");\n            return;\n        }\n        await completeLab('bio-quadrat', 200, Math.min(100, samples.length * 10));\n        setShowSuccess(true);\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-green-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <motion.div\n                        animate={{ rotate: [0, 10, -10, 0] }}\n                        transition={{ repeat: 2, duration: 0.5 }}\n                        className=\"text-9xl mb-8\"\n                    >\n                        üåø‚úÖ\n                    </motion.div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-emerald-400 mb-4 uppercase tracking-tight\">\n                        Field Study Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        Using <span className=\"text-emerald-400 font-bold\">random sampling</span>, you estimated the weed population!\n                    </p>\n\n                    <div className=\"grid grid-cols-3 gap-4 mb-10 max-w-lg mx-auto\">\n                        <div className=\"p-4 rounded-2xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Samples</div>\n                            <div className=\"text-2xl font-black text-white\">{samples.length}</div>\n                        </div>\n                        <div className=\"p-4 rounded-2xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Avg/m¬≤</div>\n                            <div className=\"text-2xl font-black text-emerald-400\">{averageCount}</div>\n                        </div>\n                        <div className=\"p-4 rounded-2xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Est. Total</div>\n                            <div className=\"text-2xl font-black text-amber-400\">{estimatedPopulation}</div>\n                        </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+200'}\n                            </div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Reliability</div>\n                            <div className=\"text-3xl font-black text-emerald-400\">{samples.length >= 10 ? 'High' : 'Medium'}</div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Background */}\n                <div className=\"absolute inset-0\">\n                    <div className=\"absolute top-0 left-1/3 w-1/2 h-1/3 bg-green-500/5 blur-[200px] rounded-full\" />\n                </div>\n\n                {/* Header */}\n                <header className=\"relative z-50 h-16 bg-[#131325]  border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-white/10\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Quadrat Sampling</div>\n                    </div>\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                            Samples: <span className={samples.length >= 10 ? 'text-emerald-400' : 'text-amber-400'}>{samples.length}</span>\n                        </div>\n                        {samples.length >= 5 && (\n                            <button\n                                onClick={handleComplete}\n                                className=\"px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/30 text-[10px] font-black uppercase tracking-widest text-emerald-400 hover:bg-emerald-500/30\"\n                            >\n                                Complete Study\n                            </button>\n                        )}\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Tool Shelf */}\n                    <aside className=\"w-72 bg-[#131325]  border-r border-[#3D3D5C] p-6\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Equipment\n                        </div>\n                        <DraggableQuadrat />\n\n                        {/* Live Stats */}\n                        <div className=\"mt-8 p-4 rounded-2xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Live Data</div>\n                            <div className=\"space-y-3\">\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-xs text-zinc-400\">Avg. per m¬≤:</span>\n                                    <span className=\"text-sm font-black text-emerald-400\">{averageCount}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span className=\"text-xs text-zinc-400\">Est. Total:</span>\n                                    <span className=\"text-sm font-black text-white\">{estimatedPopulation}</span>\n                                </div>\n                            </div>\n                        </div>\n\n                        {/* Sample Log */}\n                        <div className=\"mt-6 p-4 rounded-2xl bg-white/5 border border-[#3D3D5C] max-h-40 overflow-y-auto\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-3\">Sample Log</div>\n                            <div className=\"space-y-2 text-xs\">\n                                {samples.slice(-5).map((s) => (\n                                    <div key={s.id} className=\"text-zinc-400\">\n                                        #{s.id}: {s.count} organisms\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    </aside>\n\n                    {/* Center: Field */}\n                    <main className=\"flex-1 p-8 relative\">\n                        <FieldZone\n                            weeds={weeds}\n                            samples={samples}\n                            isHovering={hoveringField}\n                            hoverPosition={hoverPosition}\n                        />\n\n                        {/* Particles */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{ x: p.x + p.velocity.x, y: p.y + p.velocity.y, scale: 0, opacity: 0 }}\n                                transition={{ duration: 0.8 }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{ width: p.size, height: p.size, backgroundColor: p.color }}\n                            />\n                        ))}\n                    </main>\n                </div>\n\n                {/* Drag Overlay */}\n                <DragOverlay>\n                    {isDraggingQuadrat && <DraggableQuadrat isOverlay />}\n                </DragOverlay>\n\n                {/* Professor Bright */}\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-soil-water/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[39,52],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[95,112],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isSubmitting' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":153,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":191,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7229,7232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7229,7232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useCallback, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype SoilType = 'clay' | 'loam' | 'sand';\n\ninterface SoilFunnel {\n    id: SoilType;\n    name: string;\n    color: string;\n    drainageRate: number; // ml per 10s\n    waterRetention: number; // percentage kept\n    status: 'empty' | 'draining' | 'complete';\n    waterDrained: number;\n}\n\nconst SOILS: SoilFunnel[] = [\n    { id: 'clay', name: 'Clay Soil', color: 'bg-orange-700', drainageRate: 5, waterRetention: 80, status: 'empty', waterDrained: 0 },\n    { id: 'loam', name: 'Loam Soil', color: 'bg-amber-800', drainageRate: 15, waterRetention: 50, status: 'empty', waterDrained: 0 },\n    { id: 'sand', name: 'Sandy Soil', color: 'bg-yellow-600', drainageRate: 30, waterRetention: 20, status: 'empty', waterDrained: 0 }\n];\n\n// ==========================================\n// DRAGGABLE WATER BEAKER\n// ==========================================\n\nfunction DraggableWater({ isOverlay }: { isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id: 'water' });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-6 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-blue-500/20 border-2 border-b-4 border-blue-500\n        transition-all select-none text-center\n        hover:bg-blue-500/30\n        ${isOverlay ? 'shadow-2xl scale-110' : ''}\n      `}\n        >\n            <div className=\"text-4xl mb-2\">üíß</div>\n            <div className=\"text-sm font-black text-blue-300\">100ml Water</div>\n            <div className=\"text-[9px] text-blue-300/70 mt-1\">Drag to funnel</div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// SOIL FUNNEL DROP ZONE\n// ==========================================\n\nfunction SoilFunnelZone({\n    soil,\n    isHovering,\n    drainedWater\n}: {\n    soil: SoilFunnel;\n    isHovering: boolean;\n    drainedWater: number;\n}) {\n    const { setNodeRef } = useDroppable({ id: soil.id });\n    const waterHeight = Math.min(80, (drainedWater / 100) * 80);\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={isHovering ? { scale: 1.02, borderColor: '#3B82F6' } : { scale: 1 }}\n            className=\"relative p-6 rounded-[2rem] border-2 border-b-4 border-[#3D3D5C] bg-[#1B1B2F] min-h-[350px]\"\n        >\n            <div className=\"flex items-center gap-3 mb-6\">\n                <div className={`w-12 h-12 rounded-xl ${soil.color} flex items-center justify-center text-2xl`}>üß±</div>\n                <div>\n                    <div className=\"text-lg font-black text-white\">{soil.name}</div>\n                    <div className=\"text-[10px] font-bold text-zinc-500 uppercase tracking-widest\">\n                        {soil.status === 'complete' ? 'Test Complete' : soil.status === 'draining' ? 'Draining...' : 'Add Water'}\n                    </div>\n                </div>\n            </div>\n\n            {/* Funnel Visual */}\n            <div className=\"relative h-32 flex justify-center\">\n                <div className=\"w-20 h-full border-l-4 border-r-4 border-b-4 rounded-b-xl border-zinc-600 relative overflow-hidden\">\n                    {soil.status !== 'empty' && (\n                        <motion.div\n                            initial={{ height: '100%' }}\n                            animate={{ height: `${100 - (drainedWater / 100) * 100}%` }}\n                            transition={{ duration: 0.5 }}\n                            className=\"absolute bottom-0 w-full bg-blue-400/60\"\n                        />\n                    )}\n                </div>\n            </div>\n\n            {/* Collection Beaker */}\n            <div className=\"mt-4 relative h-24 flex justify-center\">\n                <div className=\"w-16 h-full border-2 border-zinc-600 rounded-b-lg relative overflow-hidden bg-zinc-900\">\n                    <motion.div\n                        animate={{ height: `${waterHeight}%` }}\n                        className=\"absolute bottom-0 w-full bg-blue-500/80\"\n                    />\n                </div>\n            </div>\n\n            <div className=\"text-center mt-4\">\n                <div className=\"text-2xl font-black text-blue-400\">{drainedWater}ml</div>\n                <div className=\"text-[10px] text-zinc-500 uppercase tracking-widest\">Collected</div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// MAIN SOIL WATER LAB\n// ==========================================\n\nexport default function SoilWaterLabPage() {\n    const [soils, setSoils] = useState(SOILS);\n    const [activeWater, setActiveWater] = useState(false);\n    const [hoveringFunnel, setHoveringFunnel] = useState<string | null>(null);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning } = useProfessor({\n        initialMessage: \"Pour water into each soil sample and observe the drainage rate!\"\n    });\n\n    const { completeLab, isSubmitting, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    // Drainage simulation\n    useEffect(() => {\n        const interval = setInterval(() => {\n            setSoils(prev => prev.map(soil => {\n                if (soil.status !== 'draining') return soil;\n\n                const newDrained = Math.min(100 - (100 * soil.waterRetention / 100), soil.waterDrained + soil.drainageRate);\n                const isComplete = newDrained >= (100 - (100 * soil.waterRetention / 100));\n\n                return {\n                    ...soil,\n                    waterDrained: Math.round(newDrained),\n                    status: isComplete ? 'complete' : 'draining'\n                };\n            }));\n        }, 1000);\n\n        return () => clearInterval(interval);\n    }, []);\n\n    // Check all complete\n    useEffect(() => {\n        if (soils.every(s => s.status === 'complete') && !showSuccess) {\n            setTimeout(() => setShowSuccess(true), 1500);\n        }\n    }, [soils, showSuccess]);\n\n    const handleDragStart = (event: DragStartEvent) => {\n        if (event.active.id === 'water') setActiveWater(true);\n    };\n\n    const handleDragOver = (event: any) => {\n        const id = event.over?.id;\n        if (['clay', 'loam', 'sand'].includes(id)) {\n            setHoveringFunnel(id);\n        } else {\n            setHoveringFunnel(null);\n        }\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { over } = event;\n        setActiveWater(false);\n        setHoveringFunnel(null);\n\n        if (!over || !['clay', 'loam', 'sand'].includes(over.id as string)) return;\n\n        const soilId = over.id as SoilType;\n        const soil = soils.find(s => s.id === soilId);\n\n        if (soil?.status !== 'empty') {\n            showWarning(\"This funnel already has water!\");\n            return;\n        }\n\n        setSoils(prev => prev.map(s =>\n            s.id === soilId ? { ...s, status: 'draining' } : s\n        ));\n\n        setParticles(createParticles(400, 200, 20, '#3B82F6'));\n        setTimeout(() => setParticles([]), 1000);\n\n        showProfessorSuccess(`Water added to ${soil?.name}! Watch it drain...`);\n    };\n\n    const handleComplete = async () => {\n        const res = await completeLab('bio-soil-water', 200);\n        if (res?.success) {\n            showProfessorSuccess(res.message);\n        }\n    };\n\n    if (showSuccess) {\n        const bestSoil = soils.reduce((a, b) => a.waterRetention > b.waterRetention ? a : b);\n\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-amber-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">üå±‚úÖ</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-amber-400 mb-4 uppercase tracking-tight\">\n                        Experiment Complete!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        <span className=\"text-amber-400 font-bold\">{bestSoil.name}</span> retains the most water,\n                        making it ideal for water-loving plants!\n                    </p>\n\n                    <div className=\"grid grid-cols-3 gap-4 mb-10 max-w-lg mx-auto\">\n                        {soils.map(soil => (\n                            <div key={soil.id} className={`p-4 rounded-2xl bg-[#1B1B2F] border border-[#3D3D5C]`}>\n                                <div className={`w-10 h-10 rounded-lg ${soil.color} mx-auto mb-2`} />\n                                <div className=\"text-sm font-black text-white\">{soil.name}</div>\n                                <div className=\"text-xs text-zinc-400\">{soil.waterRetention}% retained</div>\n                            </div>\n                        ))}\n                    </div>\n\n                    <div className=\"flex items-center justify-center gap-6 mb-10\">\n                        <div className=\"p-6 rounded-3xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+200'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        onClick={handleComplete}\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-amber-500 text-white font-black uppercase tracking-widest hover:bg-amber-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragOver={handleDragOver}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Header - fixed z-index and no transparency */}\n                <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-zinc-700\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Soil Water Capacity</div>\n                    </div>\n                    <div className=\"flex items-center gap-2 bg-[#1B1B2F] px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                        <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                        <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                            {soils.filter(s => s.status === 'complete').length}/3 complete\n                        </span>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Equipment */}\n                    <aside className=\"w-72 bg-[#131325] border-r-4 border-[#3D3D5C] p-6\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Equipment</div>\n                        <DraggableWater />\n\n                        <div className=\"mt-8 p-4 rounded-2xl bg-[#1B1B2F] border border-[#3D3D5C]\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-3\">Instructions</div>\n                            <p className=\"text-xs text-zinc-400 leading-relaxed\">\n                                Pour 100ml of water into each soil type and observe which drains fastest.\n                            </p>\n                        </div>\n                    </aside>\n\n                    {/* Center: Funnels */}\n                    <main className=\"flex-1 p-8\">\n                        <div className=\"grid grid-cols-3 gap-6 h-full\">\n                            {soils.map((soil) => (\n                                <SoilFunnelZone\n                                    key={soil.id}\n                                    soil={soil}\n                                    isHovering={hoveringFunnel === soil.id}\n                                    drainedWater={soil.waterDrained}\n                                />\n                            ))}\n                        </div>\n\n                        {/* Particles */}\n                        {particles.map((p) => (\n                            <motion.div\n                                key={p.id}\n                                initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                                animate={{ x: p.x + p.velocity.x, y: p.y + p.velocity.y, scale: 0, opacity: 0 }}\n                                transition={{ duration: 0.8 }}\n                                className=\"absolute pointer-events-none rounded-full\"\n                                style={{ width: p.size, height: p.size, backgroundColor: p.color }}\n                            />\n                        ))}\n                    </main>\n                </div>\n\n                <DragOverlay>\n                    {activeWater && <DraggableWater isOverlay />}\n                </DragOverlay>\n\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/lab/bio-transpiration/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRef' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRef"},"fix":{"range":[50,58],"text":""},"desc":"Remove unused variable \"useRef\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[103,120],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'createParticles' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"createParticles"},"fix":{"range":[446,462],"text":""},"desc":"Remove unused variable \"createParticles\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Particle' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Particle"},"fix":{"range":[461,471],"text":""},"desc":"Remove unused variable \"Particle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Environment' is defined but never used. Allowed unused vars must match /^_/u.","line":27,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'timer' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":153,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":160,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":80}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\nimport { createParticles, Particle, itemVariants } from '@/lib/science/virtual-lab.types';\nimport { useLabCompletion } from '@/hooks/useLabCompletion';\n\n// ==========================================\n// TYPES\n// ==========================================\n\ntype EnvFactor = 'fan' | 'heater' | 'bag' | 'lamp' | 'none';\n\ninterface Environment {\n    factor: EnvFactor;\n    intensity: 'off' | 'on';\n}\n\ninterface DraggableTool {\n    id: string;\n    factor: EnvFactor;\n    name: string;\n    icon: string;\n}\n\nconst TOOLS: DraggableTool[] = [\n    { id: 'tool-fan', factor: 'fan', name: 'Electric Fan', icon: 'üí®' },\n    { id: 'tool-lamp', factor: 'lamp', name: 'Bright Lamp', icon: 'üí°' },\n    { id: 'tool-bag', factor: 'bag', name: 'Plastic Bag', icon: 'üõçÔ∏è' },\n    { id: 'tool-heater', factor: 'heater', name: 'Heater', icon: 'üî•' }\n];\n\n// ==========================================\n// DRAGGABLE TOOL\n// ==========================================\n\nfunction DraggableEnvironment({ tool, isOverlay }: { tool: DraggableTool; isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id: tool.id });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover=\"hover\"\n            className={`\n        p-4 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F] border border-[#3D3D5C]\n        transition-all select-none\n        hover:bg-white/[0.08] hover:border-emerald-500/30\n        flex items-center gap-3\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20 scale-110 z-50' : ''}\n      `}\n        >\n            <span className=\"text-2xl\">{tool.icon}</span>\n            <div>\n                <div className=\"text-sm font-black text-white\">{tool.name}</div>\n                <div className=\"text-[9px] font-bold text-zinc-500 uppercase tracking-widest\">Environmental Factor</div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// POTOMETER SETUP\n// ==========================================\n\nfunction PotometerDisplay({\n    bubblePos,\n    activeFactor,\n    isRunning\n}: {\n    bubblePos: number; // 0 to 100\n    activeFactor: EnvFactor;\n    isRunning: boolean;\n}) {\n    const { setNodeRef, isOver } = useDroppable({ id: 'potometer-zone' });\n\n    return (\n        <div\n            ref={setNodeRef}\n            className={`\n                relative w-full max-w-3xl h-80 rounded-3xl border-2 transition-all p-8\n                ${isOver ? 'border-emerald-500 bg-emerald-500/10' : 'border-[#3D3D5C] bg-[#1B1B2F]'}\n                flex items-center justify-center\n            `}\n        >\n            {/* Plant Shoot */}\n            <div className=\"absolute top-10 left-20 text-9xl z-10 drop-shadow-2xl\">üå±</div>\n\n            {/* Capillary Tube */}\n            <div className=\"absolute bottom-20 left-20 right-20 h-4 bg-blue-900/30 rounded-full border border-blue-500/30 overflow-hidden\">\n                <div className=\"w-full h-full flex items-center px-2\">\n                    {/* Ruler Markings */}\n                    {[...Array(20)].map((_, i) => (\n                        <div key={i} className=\"flex-1 border-r border-white/20 h-2 last:border-0\" />\n                    ))}\n                </div>\n                {/* Air Bubble */}\n                <motion.div\n                    className=\"absolute top-0 bottom-0 w-2 bg-white/80 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.8)]\"\n                    animate={{ left: `${bubblePos}%` }}\n                    transition={{ ease: \"linear\", duration: 0.5 }}\n                />\n            </div>\n\n            {/* Reservoir / Beaker */}\n            <div className=\"absolute bottom-10 right-10 w-24 h-32 bg-blue-500/20 border-2 border-blue-400 rounded-b-xl backdrop-blur-sm z-0\">\n                <div className=\"absolute inset-0 bg-blue-500/10 animate-pulse\" />\n            </div>\n\n            {/* Active Factor Indicator */}\n            <div className=\"absolute top-4 right-4\">\n                {activeFactor === 'fan' && <div className=\"text-6xl animate-pulse\">üí®</div>}\n                {activeFactor === 'lamp' && <div className=\"text-6xl animate-pulse text-yellow-500 drop-shadow-[0_0_30px_rgba(234,179,8,0.5)]\">üí°</div>}\n                {activeFactor === 'bag' && <div className=\"text-6xl opacity-80\">üõçÔ∏è</div>}\n                {activeFactor === 'heater' && <div className=\"text-6xl animate-bounce\">üî•</div>}\n                {activeFactor === 'none' && <div className=\"text-xs font-black uppercase text-zinc-600\">Control Conditions</div>}\n            </div>\n\n            {/* Status Text */}\n            <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                {isRunning ? 'Measuring Transpiration...' : 'Potometer Ready'}\n            </div>\n        </div>\n    );\n}\n\n// ==========================================\n// MAIN LAB: TRANSPIRATION\n// ==========================================\n\nexport default function TranspirationLabPage() {\n    const [activeFactor, setActiveFactor] = useState<EnvFactor>('none');\n    const [bubblePos, setBubblePos] = useState(0);\n    const [isRunning, setIsRunning] = useState(false);\n    const [timer, setTimer] = useState(0);\n    const [results, setResults] = useState<{ factor: string; distance: number }[]>([]);\n    const [showSuccess, setShowSuccess] = useState(false);\n\n    // Dragging state\n    const [activeDraggable, setActiveDraggable] = useState<DraggableTool | null>(null);\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint } = useProfessor({\n        initialMessage: \"Use the potometer to measure transpiration rates. Try adding different environmental factors!\"\n    });\n\n    const { completeLab, result } = useLabCompletion();\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    const handleFinish = useCallback(async () => {\n        await completeLab('bio-transpiration', 300);\n        setShowSuccess(true);\n    }, [completeLab]);\n\n    const handleStop = useCallback(() => {\n        setIsRunning(false);\n        const distance = Math.round(bubblePos); // Simplified distance\n        setResults(prev => [...prev, { factor: activeFactor === 'none' ? 'Control' : activeFactor, distance }]);\n        showProfessorSuccess(`Measurement complete! Bubble moved ${distance}mm.`);\n\n        // Complete Lab Condition: 3 different tests\n        const factorsTested = new Set([...results.map(r => r.factor), activeFactor === 'none' ? 'Control' : activeFactor]);\n        if (factorsTested.size >= 3) {\n            setTimeout(() => handleFinish(), 1500);\n        }\n    }, [bubblePos, activeFactor, results, showProfessorSuccess, handleFinish]);\n\n    // Simulation Loop\n    useEffect(() => {\n        let interval: NodeJS.Timeout;\n\n        if (isRunning) {\n            interval = setInterval(() => {\n                setTimer(prev => prev + 1);\n\n                // Calculate Rate based on factor\n                // Base rate = 0.5 per tick\n                let rate = 0.5;\n                if (activeFactor === 'fan') rate = 1.2; // Wind increases transpiration\n                if (activeFactor === 'lamp') rate = 0.9; // Light opens stomata\n                if (activeFactor === 'heater') rate = 1.5; // Heat increases evaporation\n                if (activeFactor === 'bag') rate = 0.1; // Humidity decreases transpiration\n\n                setBubblePos(prev => {\n                    const next = prev + rate;\n                    if (next >= 100) {\n                        handleStop();\n                        return 100;\n                    }\n                    return next;\n                });\n\n            }, 100);\n        }\n\n        return () => clearInterval(interval);\n    }, [isRunning, activeFactor, handleStop]);\n\n    const handleStart = () => {\n        if (bubblePos >= 100) {\n            handleReset(); // Auto reset if full\n        }\n        setIsRunning(true);\n        showProfessorSuccess(\"Measurement started! Watch the air bubble move.\");\n    };\n\n\n    const handleReset = () => {\n        setIsRunning(false);\n        setBubblePos(0);\n        setTimer(0);\n    };\n\n    const handleDragStart = (event: DragStartEvent) => {\n        const tool = TOOLS.find(t => t.id === event.active.id);\n        setActiveDraggable(tool || null);\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        setActiveDraggable(null);\n        const { over, active } = event;\n\n        if (over && over.id === 'potometer-zone') {\n            const tool = TOOLS.find(t => t.id === active.id);\n            if (tool) {\n                if (isRunning) {\n                    showWarning(\"Stop the current measurement before changing factors!\");\n                    return;\n                }\n                setActiveFactor(tool.factor);\n                handleReset();\n                showProfessorSuccess(`Applied ${tool.name}. Transpiration rate should change!`);\n            }\n        }\n    };\n\n    const removeFactor = () => {\n        if (isRunning) {\n            showWarning(\"Stop the measurement first!\");\n            return;\n        }\n        setActiveFactor('none');\n        handleReset();\n        showProfessorSuccess(\"Returning to Control conditions (Normal room environment).\");\n    };\n\n    if (showSuccess) {\n        return (\n            <div className=\"fixed inset-0 z-[200] bg-gradient-to-br from-blue-900 to-black flex items-center justify-center\">\n                <motion.div\n                    initial={{ scale: 0.8, opacity: 0 }}\n                    animate={{ scale: 1, opacity: 1 }}\n                    className=\"text-center max-w-3xl px-8\"\n                >\n                    <div className=\"text-9xl mb-8\">üåøüíß</div>\n                    <h1 className=\"text-4xl md:text-6xl font-black text-emerald-400 mb-4 uppercase tracking-tight\">\n                        Transpiration Analyzed!\n                    </h1>\n                    <p className=\"text-xl text-zinc-300 mb-8\">\n                        You investigated how wind, light, and humidity affect water loss in plants.\n                    </p>\n\n                    <div className=\"grid grid-cols-2 gap-6 mb-10 max-w-md mx-auto\">\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">Variables Tested</div>\n                            <div className=\"text-3xl font-black text-white\">{new Set(results.map(r => r.factor)).size}</div>\n                        </div>\n                        <div className=\"p-6 rounded-3xl bg-white/5 border border-[#3D3D5C]\">\n                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-2\">XP Earned</div>\n                            <div className=\"text-3xl font-black text-amber-400\">\n                                {result?.xpGain !== undefined ? `+${result.xpGain}` : '+300'}\n                            </div>\n                        </div>\n                    </div>\n\n                    <a\n                        href=\"/practicals/science/biology\"\n                        className=\"inline-block px-10 py-4 rounded-2xl bg-emerald-500 text-white font-black uppercase tracking-widest hover:bg-emerald-400 transition-colors\"\n                    >\n                        Return to Lab Portfolio\n                    </a>\n                </motion.div>\n            </div>\n        );\n    }\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-gradient-to-b from-[#0A1628] to-[#050A12] overflow-hidden\">\n                {/* Header */}\n                <header className=\"relative z-50 h-16 bg-[#131325] border-b-4 border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-zinc-700\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">Transpiration Potometer</div>\n                    </div>\n\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                            Tests: <span className=\"text-emerald-400\">{results.length}</span>\n                        </div>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 h-[calc(100vh-4rem)] flex\">\n                    {/* Left: Environmental Factors */}\n                    <aside className=\"w-72 bg-[#131325] border-r-4 border-[#3D3D5C] p-6\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Environment Tools</div>\n\n                        <div className=\"space-y-4\">\n                            {TOOLS.map(tool => (\n                                <DraggableEnvironment key={tool.id} tool={tool} />\n                            ))}\n                        </div>\n\n                        <div className=\"mt-8 p-4 rounded-2xl bg-zinc-900/50 border border-zinc-800\">\n                            <h4 className=\"text-zinc-400 font-bold mb-2 text-xs\">Simulated Conditions</h4>\n                            <div className=\"space-y-2 text-[10px] text-zinc-500\">\n                                <div className=\"flex justify-between\">\n                                    <span>Variable:</span>\n                                    <span className=\"text-white font-bold uppercase\">{activeFactor === 'none' ? 'Control' : activeFactor}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span>Temperature:</span>\n                                    <span className=\"text-white\">{activeFactor === 'heater' ? '35¬∞C' : '22¬∞C'}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span>Wind Speed:</span>\n                                    <span className=\"text-white\">{activeFactor === 'fan' ? '5 m/s' : '0 m/s'}</span>\n                                </div>\n                                <div className=\"flex justify-between\">\n                                    <span>Humidity:</span>\n                                    <span className=\"text-white\">{activeFactor === 'bag' ? '95%' : '40%'}</span>\n                                </div>\n                            </div>\n\n                            {activeFactor !== 'none' && (\n                                <button\n                                    onClick={removeFactor}\n                                    className=\"mt-4 w-full py-2 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-[10px] font-black uppercase hover:bg-red-500/20\"\n                                >\n                                    Remove Factor\n                                </button>\n                            )}\n                        </div>\n                    </aside>\n\n                    {/* Main: Potometer */}\n                    <main className=\"flex-1 flex flex-col items-center p-12 relative overflow-hidden\">\n                        {/* Background Ambience */}\n                        <div className=\"absolute inset-0 z-0\">\n                            {activeFactor === 'fan' && <div className=\"absolute inset-0 bg-blue-500/5 animate-pulse\" />} {/* Wind effect */}\n                            {activeFactor === 'lamp' && <div className=\"absolute inset-0 bg-yellow-500/5\" />} {/* Light effect */}\n                            {activeFactor === 'heater' && <div className=\"absolute inset-0 bg-red-500/5\" />} {/* Heat effect */}\n                        </div>\n\n                        <div className=\"z-10 w-full flex flex-col items-center\">\n                            <PotometerDisplay\n                                bubblePos={bubblePos}\n                                activeFactor={activeFactor}\n                                isRunning={isRunning}\n                            />\n\n                            <div className=\"mt-8 flex gap-4\">\n                                {!isRunning ? (\n                                    <button\n                                        onClick={handleStart}\n                                        className=\"px-12 py-4 rounded-2xl bg-emerald-500 text-white font-black text-lg uppercase tracking-widest shadow-xl shadow-emerald-500/20 hover:scale-105 transition-transform\"\n                                    >\n                                        Start Timer\n                                    </button>\n                                ) : (\n                                    <button\n                                        onClick={handleStop}\n                                        className=\"px-12 py-4 rounded-2xl bg-red-500 text-white font-black text-lg uppercase tracking-widest shadow-xl shadow-red-500/20 hover:scale-105 transition-transform\"\n                                    >\n                                        Stop\n                                    </button>\n                                )}\n\n                                <button\n                                    onClick={handleReset}\n                                    className=\"px-6 py-4 rounded-2xl bg-zinc-800 text-zinc-400 font-black text-lg uppercase tracking-widest hover:bg-zinc-700 transition-colors\"\n                                >\n                                    Reset\n                                </button>\n                            </div>\n                        </div>\n\n                        {/* Results Table */}\n                        {results.length > 0 && (\n                            <div className=\"mt-12 w-full max-w-2xl bg-[#1B1B2F] border border-[#3D3D5C] rounded-3xl p-6 z-10\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Recorded Data</div>\n                                <div className=\"grid grid-cols-2 gap-x-12 gap-y-2\">\n                                    <div className=\"flex justify-between text-xs font-bold text-zinc-400 border-b border-white/10 pb-2\">\n                                        <span>Condition</span>\n                                        <span>Distance Moved</span>\n                                    </div>\n                                    <div />\n                                    {results.map((r, i) => (\n                                        <div key={i} className=\"flex justify-between text-sm text-zinc-300 py-1\">\n                                            <span className=\"capitalize\">{r.factor}</span>\n                                            <span className=\"font-mono text-emerald-400\">{r.distance} mm</span>\n                                        </div>\n                                    ))}\n                                </div>\n                            </div>\n                        )}\n\n                    </main>\n                </div>\n\n                <DragOverlay>\n                    {activeDraggable && <DraggableEnvironment tool={activeDraggable} isOverlay />}\n                </DragOverlay>\n\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/science/biology/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BiologyLab' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BiologyLab"},"fix":{"range":[166,178],"text":""},"desc":"Remove unused variable \"BiologyLab\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Link from 'next/link';\nimport { useMemo, useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { BIOLOGY_LABS, BiologyLab } from '@/lib/science/biology-labs';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { getAllMissionCompletions } from '@/lib/brightos/mission-progress';\n\nexport default function BiologyRoadmapPage() {\n    const [selectedId, setSelectedId] = useState<string>(BIOLOGY_LABS[0]?.id || '');\n\n    const completions = useMemo(() => getAllMissionCompletions(), []);\n\n    const selected = useMemo(() => {\n        return BIOLOGY_LABS.find((l) => l.id === selectedId) || null;\n    }, [selectedId]);\n\n    const sections = ['Section A', 'Section B', 'Section C'] as const;\n\n    return (\n        <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden safe-padding pb-32\">\n            {/* Dynamic Background Elements */}\n            <div className=\"fixed inset-0 z-0\">\n                <div className=\"absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-emerald-500/10 rounded-full blur-[120px] animate-pulse-slow\" />\n                <div className=\"absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-teal-500/5 rounded-full blur-[100px]\" />\n            </div>\n\n            <div className=\"relative z-10 max-w-7xl mx-auto px-4 md:px-8 py-12 pt-20 md:pt-28\">\n                {/* Breadcrumbs & Header */}\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-12\">\n                    <Link\n                        href=\"/practicals\"\n                        className=\"group flex items-center gap-2 text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 hover:text-white transition-colors\"\n                    >\n                        <span className=\"group-hover:-translate-x-1 transition-transform\">‚Üê</span> Back to Practicals\n                    </Link>\n                    <div className=\"text-[10px] font-black uppercase tracking-[0.3em] text-emerald-500/60 bg-emerald-500/5 px-4 py-1.5 rounded-full border border-emerald-500/10 backdrop-blur-sm\">\n                        Science / <span className=\"text-emerald-400\">Biology Portfolio</span>\n                    </div>\n                </div>\n\n                <div className=\"mb-12\">\n                    <motion.div\n                        initial={{ opacity: 0, x: -20 }}\n                        animate={{ opacity: 1, x: 0 }}\n                    >\n                        <BrightHeading level={1} className=\"text-4xl md:text-6xl font-black tracking-tighter leading-none mb-6\">\n                            SBA Lab <span className=\"text-emerald-400\">Portfolio</span>\n                        </BrightHeading>\n                        <p className=\"text-zinc-400 max-w-2xl text-base md:text-lg leading-relaxed font-medium\">\n                            Complete the required practical activities for your School-Based Assessment.\n                            Earn XP and build a digital record of your observations and reports.\n                        </p>\n                    </motion.div>\n                </div>\n\n                {/* Lab Grid */}\n                <div className=\"grid gap-8 lg:grid-cols-[1fr_450px]\">\n                    {/* Lab List by Section */}\n                    <div className=\"space-y-12\">\n                        {sections.map((section) => (\n                            <div key={section} className=\"space-y-6\">\n                                <div className=\"flex items-center gap-4\">\n                                    <h2 className=\"text-sm font-black uppercase tracking-[0.4em] text-zinc-500\">{section}</h2>\n                                    <div className=\"h-px flex-1 bg-gradient-to-r from-zinc-800 to-transparent\" />\n                                </div>\n\n                                <div className=\"grid gap-4 sm:grid-cols-2\">\n                                    {BIOLOGY_LABS.filter(l => l.section === section).map((lab) => {\n                                        const isCompleted = completions.some(c => c.objectiveId === `science:biology:${lab.id}`);\n                                        const isSelected = selectedId === lab.id;\n\n                                        return (\n                                            <button\n                                                key={lab.id}\n                                                onClick={() => setSelectedId(lab.id)}\n                                                className={`text-left group relative transition-all duration-300 ${isSelected ? 'scale-[1.02]' : 'hover:scale-[1.01]'\n                                                    }`}\n                                            >\n                                                <BrightLayer\n                                                    variant={isSelected ? \"elevated\" : \"glass\"}\n                                                    padding=\"md\"\n                                                    className={`h-full border-b-[8px] transition-all overflow-hidden ${isSelected\n                                                        ? 'border-emerald-500 bg-emerald-500/5'\n                                                        : 'border-zinc-800 hover:border-zinc-600 bg-white/[0.02]'\n                                                        }`}\n                                                >\n                                                    <div className=\"flex flex-col h-full relative z-10\">\n                                                        <div className=\"flex items-start justify-between mb-6\">\n                                                            <div className=\"space-y-2\">\n                                                                <div className=\"flex flex-wrap gap-2\">\n                                                                    {lab.skills.map(skill => (\n                                                                        <span key={skill} className=\"px-2 py-0.5 rounded bg-zinc-800 text-[8px] font-black uppercase tracking-widest text-zinc-400\">\n                                                                            {skill}\n                                                                        </span>\n                                                                    ))}\n                                                                </div>\n                                                                <h3 className={`text-xl font-black tracking-tight leading-tight group-hover:text-emerald-400 transition-colors ${isSelected ? 'text-emerald-400' : 'text-white'\n                                                                    }`}>\n                                                                    {lab.title}\n                                                                </h3>\n                                                            </div>\n                                                            <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl transition-all ${isSelected ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-zinc-900 text-zinc-500'\n                                                                }`}>\n                                                                {isCompleted ? '‚úÖ' : 'üß™'}\n                                                            </div>\n                                                        </div>\n\n                                                        <div className=\"mt-auto flex items-center justify-between pt-4 border-t border-white/5\">\n                                                            <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500\">\n                                                                {lab.xpReward} XP Reward\n                                                            </div>\n                                                            <div className={`text-[10px] font-black uppercase tracking-widest ${isCompleted ? 'text-emerald-500' : 'text-zinc-600'\n                                                                }`}>\n                                                                {isCompleted ? 'CLEAR' : 'OPEN'}\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                </BrightLayer>\n                                            </button>\n                                        );\n                                    })}\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n\n                    {/* Details Sidebar */}\n                    <div className=\"relative\">\n                        <div className=\"sticky top-28 space-y-6\">\n                            <AnimatePresence mode=\"wait\">\n                                {selected && (\n                                    <motion.div\n                                        key={selected.id}\n                                        initial={{ opacity: 0, y: 20 }}\n                                        animate={{ opacity: 1, y: 0 }}\n                                        exit={{ opacity: 0, y: -20 }}\n                                    >\n                                        <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"border-b-[8px] border-emerald-700 bg-gradient-to-br from-emerald-500/5 to-transparent\">\n                                            <div className=\"mb-8\">\n                                                <div className=\"text-[10px] font-black uppercase tracking-[0.3em] text-emerald-500 mb-4 flex items-center gap-2\">\n                                                    <span className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                                                    Lab Details\n                                                </div>\n                                                <h2 className=\"text-3xl font-black text-white tracking-tighter leading-none mb-4\">{selected.title}</h2>\n                                                <p className=\"text-zinc-400 text-sm font-medium leading-relaxed\">\n                                                    {selected.description}\n                                                </p>\n                                            </div>\n\n                                            <div className=\"space-y-6 mb-8\">\n                                                <div>\n                                                    <div className=\"text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-3\">Syllabus Objectives</div>\n                                                    <ul className=\"space-y-3\">\n                                                        {selected.objectives.map((obj, i) => (\n                                                            <li key={i} className=\"flex gap-3 text-xs text-zinc-300 font-medium\">\n                                                                <span className=\"text-emerald-500 font-black\">‚Ä¢</span>\n                                                                {obj}\n                                                            </li>\n                                                        ))}\n                                                    </ul>\n                                                </div>\n\n                                                <div className=\"grid grid-cols-2 gap-4\">\n                                                    <div className=\"p-4 rounded-3xl bg-white/[0.03] border border-white/5\">\n                                                        <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-1\">Marked Skill</div>\n                                                        <div className=\"text-xs font-black text-white\">{selected.skills.join(', ')}</div>\n                                                    </div>\n                                                    <div className=\"p-4 rounded-3xl bg-white/[0.03] border border-white/5\">\n                                                        <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500 mb-1\">XP Potential</div>\n                                                        <div className=\"text-xs font-black text-emerald-400\">+{selected.xpReward}</div>\n                                                    </div>\n                                                </div>\n                                            </div>\n\n                                            <Link href={`/practicals/science/biology/lab/${selected.id}`} className=\"block\">\n                                                <BrightButton variant=\"primary\" size=\"lg\" className=\"w-full h-14 bg-emerald-500 hover:bg-emerald-400 text-[11px] font-black uppercase tracking-[0.3em]\">\n                                                    Run Practical Session ‚Üí\n                                                </BrightButton>\n                                            </Link>\n                                        </BrightLayer>\n                                    </motion.div>\n                                )}\n                            </AnimatePresence>\n\n                            {/* Lab Guidelines Tip */}\n                            <BrightLayer variant=\"glass\" padding=\"md\" className=\"border-zinc-800\">\n                                <div className=\"flex gap-4\">\n                                    <span className=\"text-2xl\">üí°</span>\n                                    <div>\n                                        <div className=\"text-[10px] font-black uppercase tracking-widest text-emerald-500 mb-1\">Lab Tip</div>\n                                        <p className=\"text-[10px] font-bold text-zinc-400 uppercase tracking-widest leading-relaxed\">\n                                            SBA drawings must use <span className=\"text-zinc-200\">solid lines</span>. Sketching or shading will result in a point deduction.\n                                        </p>\n                                    </div>\n                                </div>\n                            </BrightLayer>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/technology-practicality/csec-roadmap/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/technology-practicality/csec/[id]/MissionClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ReactMouseEvent' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ReactMouseEvent"},"fix":{"range":[211,241],"text":""},"desc":"Remove unused variable \"ReactMouseEvent\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3679,3682],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3679,3682],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BriefingOverlay' is defined but never used. Allowed unused vars must match /^_/u.","line":800,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":800,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'listByPrefix' is defined but never used. Allowed unused vars must match /^_/u.","line":1053,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1053,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1408,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1408,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59730,59733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59730,59733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'evalCondition' is defined but never used. Allowed unused vars must match /^_/u.","line":1424,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1424,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'lockedByStuck' is defined but never used. Allowed unused args must match /^_/u.","line":1850,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":1850,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isLight' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1871,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1871,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mission' is defined but never used. Allowed unused args must match /^_/u.","line":2009,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":2009,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'id' is defined but never used. Allowed unused args must match /^_/u.","line":2181,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":2181,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'briefingAccepted' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":3014,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3014,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3365,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3365,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[152970,152973],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[152970,152973],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3729,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3729,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[169942,169945],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[169942,169945],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3734,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3734,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[170187,170190],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[170187,170190],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3750,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3750,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[170918,170921],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[170918,170921],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3755,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3755,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[171163,171166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[171163,171166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3785,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3785,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[172396,172399],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[172396,172399],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3790,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3790,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[172638,172641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[172638,172641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3823,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3823,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[173931,173934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[173931,173934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3828,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3828,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[174167,174170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[174167,174170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3845,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3845,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[174803,174806],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[174803,174806],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3850,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3850,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[175033,175036],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[175033,175036],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3867,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3867,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[175603,175606],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[175603,175606],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3872,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3872,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[175833,175836],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[175833,175836],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3889,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3889,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[176428,176431],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[176428,176431],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3894,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3894,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[176670,176673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[176670,176673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3919,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3919,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[177480,177483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[177480,177483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3924,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3924,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[177722,177725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[177722,177725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3993,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3993,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[180968,180971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[180968,180971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3998,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3998,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[181207,181210],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[181207,181210],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4020,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4020,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[181950,181953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[181950,181953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4025,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4025,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[182198,182201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[182198,182201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4047,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4047,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[182941,182944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[182941,182944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4052,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4052,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[183180,183183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[183180,183183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4076,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4076,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[184169,184172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[184169,184172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4081,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4081,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[184411,184414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[184411,184414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":36,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Link from 'next/link';\nimport Image from 'next/image';\nimport { useRouter } from 'next/navigation';\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport type { MouseEvent as ReactMouseEvent, ReactNode } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { doc, increment, serverTimestamp, updateDoc } from 'firebase/firestore';\n\nimport type { BrightOSMission } from '@/lib/brightos/csec-roadmap-missions';\nimport { getMissionCooldown, registerMissionCompletionAndMaybeCooldown } from '@/lib/brightos/mission-rewards';\nimport { awardFixedMissionXP } from '@/lib/brightos/mission-xp';\nimport { markMissionCompleted } from '@/lib/brightos/mission-progress';\nimport { endLiveSession, startLiveSession } from '@/lib/brightos/live-sessions';\nimport { db } from '@/lib/firebase';\nimport { useAuth } from '@/lib/auth-context';\n\nconst MISSION_XP_REWARD = 100;\nconst MISSION_BCOIN_REWARD = 50;\n\ntype WindowId =\n  | 'taskmgr'\n  | 'terminal'\n  | 'settings'\n  | 'browser'\n  | 'automation'\n  | 'explorer'\n  | 'stuck_app'\n  | 'uninstall'\n  | 'registry'\n  | 'devmgr'\n  | 'mail'\n  | 'chat';\n\ntype WindowState = {\n  id: WindowId;\n  title: string;\n  open: boolean;\n  minimized: boolean;\n  z: number;\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n};\n\ntype RuntimeState = {\n  power: 'intro' | 'booting' | 'lock' | 'on' | 'reward' | 'shutting-down' | 'off';\n  boot_phase: 0 | 1 | 2 | 3 | 4 | 5;\n  cpu_load: number;\n  network: {\n    status: 'Connected' | 'Disconnected' | 'Slow';\n    ip_renewed: boolean;\n    ip: string;\n    dns: { primary: string };\n    suspicious_connection: { active: boolean };\n  };\n  window: { stuck_app: { open: boolean } };\n  process: { high_cpu: { running: boolean } };\n  disk: { free_space_mb: number; volumes: string[] };\n  files: { tmp: { count: number }; restored: boolean; renamed_prefix: string; renamed_count: number; total: number };\n  recycle_bin: { empty: boolean };\n  file: { opened: string | null };\n  terminal: { history: string[]; last_command: string | null; last_output: string };\n  notifications: Array<{ id: string; kind: 'alert' | 'info'; title: string; body: string }>;\n  apps: Record<string, { name: string; installed: boolean; malware: boolean; reinstall: boolean; process?: string; registryKeys?: string[] }>;\n  registry: Record<string, string>;\n\n  audio: { output: boolean };\n  device: { audio: { driver_status: 'outdated' | 'updated' } };\n  display: { resolution: string };\n  power_settings: { screen_off_minutes_on_battery: number };\n  keyboard: { filter_keys: { enabled: boolean } };\n  specs: { checked: boolean };\n\n  printer: { queue: { count: number }; ip: string; reachable: boolean };\n  router: {\n    admin_password_changed: boolean;\n    wifi: { security: string };\n    port_forwarding: string[];\n    blocked_macs: string[];\n  };\n  unknown_device: { mac: string };\n  browser: { redirects: boolean; extensions: { malicious: number } };\n  mail: { flagged_phishing: boolean };\n  defend: { threats: { active: number; quarantined: number } };\n  account: { user: { password_reset: boolean } };\n  system: { restore: { completed: boolean }; crash_rate: number };\n  hardware: { ram_gb: number };\n  firewall: { inbound: { blocked_ports: number[] } };\n  folder: { encrypted_paths: string[] };\n  forensics: { bruteforce_timestamp: string };\n  web: { validation: { blocks_sql_injection: boolean } };\n  ransomware: { lock_screen: boolean };\n  incident: { pid_identified: boolean; resolved: boolean };\n  ping: { packet_loss_percent: number };\n  trace: { loss_hop_index: number };\n  ftp: { uploaded: string[] };\n  automation: { flow: { valid: boolean }; outputs: Record<string, any> };\n  validation: { rejects_common_password: boolean; min_length: number };\n  script: { output: number | null; terminates: boolean };\n  vars: { A: number; B: number };\n  list: { sorted: boolean };\n};\n\ntype TerminalLine = { id: string; kind: 'in' | 'out' | 'sys'; text: string };\n\ntype StoryEmail = {\n  id: string;\n  from: string;\n  subject: string;\n  preview: string;\n  body: string;\n  attachments?: string[];\n  unread?: boolean;\n};\n\ntype StoryChatMessage = {\n  id: string;\n  from: string;\n  text: string;\n  atOffsetMs: number;\n};\n\ntype StoryEvent =\n  | { kind: 'notify'; atOffsetMs: number; level: 'info' | 'alert'; title: string; body: string }\n  | { kind: 'email'; atOffsetMs: number; emailId: string }\n  | { kind: 'document'; atOffsetMs: number; path: string };\n\nfunction PhoneMessageOutro({\n  mission,\n  userLabel,\n  userAvatarUrl,\n  npcLabel,\n  npcAvatarUrl,\n  xpReward,\n  bCoinReward,\n  onDone,\n}: {\n  mission: BrightOSMission;\n  userLabel: string;\n  userAvatarUrl: string;\n  npcLabel: string;\n  npcAvatarUrl: string;\n  xpReward: number;\n  bCoinReward: number;\n  onDone: () => void;\n}) {\n  const script = useMemo(() => {\n    const userLine = `All set, ${mission.client.name}. Your computer is fixed and running smoothly again.`;\n    const thanks = mission.client.mood === 'Panic'\n      ? 'Thank you so much! I thought it was done for.'\n      : mission.client.mood === 'Angry'\n        ? 'Alright, it finally works. Thanks for fixing it.'\n        : mission.client.mood === 'Confused'\n          ? 'Ohhh, I see it now. Thanks for sorting it out.'\n          : 'Thanks! Everything looks perfect now.';\n\n    return [\n      { from: 'user' as const, text: userLine },\n      { from: 'npc' as const, text: thanks },\n      { from: 'npc' as const, text: `Reward sent: +${xpReward} XP and +${bCoinReward} B-Coins.` },\n    ];\n  }, [bCoinReward, mission.client.mood, mission.client.name, xpReward]);\n\n  const [msgIndex, setMsgIndex] = useState(0);\n  const [charIndex, setCharIndex] = useState(0);\n  const [closing, setClosing] = useState(false);\n  const [showRewards, setShowRewards] = useState(false);\n\n  useEffect(() => {\n    if (closing || showRewards) return;\n    const current = script[msgIndex];\n    if (!current) return;\n\n    if (charIndex < current.text.length) {\n      const id = window.setTimeout(() => setCharIndex((p) => p + 1), current.from === 'npc' ? 30 : 24);\n      return () => window.clearTimeout(id);\n    }\n\n    if (msgIndex < script.length - 1) {\n      const id = window.setTimeout(() => {\n        setMsgIndex((p) => p + 1);\n        setCharIndex(0);\n      }, 850);\n      return () => window.clearTimeout(id);\n    }\n\n    const id = window.setTimeout(() => {\n      setShowRewards(true);\n    }, 800);\n    return () => window.clearTimeout(id);\n  }, [charIndex, closing, msgIndex, script, showRewards]);\n\n  useEffect(() => {\n    if (!showRewards) return;\n    const id = window.setTimeout(() => {\n      setClosing(true);\n      window.setTimeout(() => onDone(), 800);\n    }, 4200);\n    return () => window.clearTimeout(id);\n  }, [onDone, showRewards]);\n\n  const visibleMessages = useMemo(() => {\n    const out: Array<{ from: 'npc' | 'user'; text: string }> = [];\n    script.forEach((m, i) => {\n      if (i < msgIndex) out.push(m);\n      if (i === msgIndex) out.push({ ...m, text: m.text.slice(0, charIndex) });\n    });\n    return out;\n  }, [charIndex, msgIndex, script]);\n\n  return (\n    <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n      <div className=\"absolute inset-0 bg-gradient-to-b from-emerald-500/10 via-transparent to-black\" />\n      <div className=\"relative z-10 min-h-screen flex items-center justify-center px-6\">\n        <AnimatePresence mode=\"wait\">\n          {!closing ? (\n            <motion.div\n              key=\"phone-open\"\n              initial={{ opacity: 0, scale: 0.92, y: 18 }}\n              animate={{ opacity: 1, scale: 1, y: 0 }}\n              exit={{ opacity: 0, scale: 0.92, y: 18 }}\n              transition={{ duration: 0.35 }}\n              className=\"w-full max-w-[420px]\"\n            >\n              <div className=\"rounded-[2.25rem] border border-white/15 bg-black/70 overflow-hidden shadow-[0_24px_80px_rgba(0,0,0,0.6)]\">\n                <div className=\"px-5 py-4 border-b border-white/10 flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"h-9 w-9 rounded-full border border-white/10 bg-white/5 overflow-hidden\">\n                      <Image src={npcAvatarUrl} alt={npcLabel} width={36} height={36} className=\"h-full w-full\" />\n                    </div>\n                    <div>\n                      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500\">Mission Wrap-up</div>\n                      <div className=\"mt-0.5 text-sm font-black text-white\">{npcLabel}</div>\n                    </div>\n                  </div>\n                  <button\n                    onClick={() => {\n                      setClosing(true);\n                      window.setTimeout(() => onDone(), 350);\n                    }}\n                    className=\"h-9 px-3 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200 transition-colors\"\n                  >\n                    {showRewards ? 'Continue' : 'Skip'}\n                  </button>\n                </div>\n\n                <div className=\"p-5 h-[520px] overflow-auto sleek-scrollbar flex flex-col gap-3\">\n                  {visibleMessages.map((m, idx) => {\n                    const mine = m.from === 'user';\n                    const avatar = mine ? userAvatarUrl : npcAvatarUrl;\n                    const label = mine ? userLabel : npcLabel;\n                    return (\n                      <div key={idx} className={`flex items-end gap-2 ${mine ? 'justify-end' : 'justify-start'}`}>\n                        {!mine ? (\n                          <div className=\"h-8 w-8 rounded-full border border-white/10 bg-white/5 overflow-hidden shrink-0\">\n                            <Image src={avatar} alt={label} width={32} height={32} className=\"h-full w-full\" />\n                          </div>\n                        ) : null}\n                        <div\n                          className={`max-w-[78%] rounded-2xl border px-4 py-3 text-sm leading-relaxed ${mine\n                            ? 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 text-white'\n                            : 'border-white/10 bg-white/[0.03] text-zinc-200'\n                            }`}\n                        >\n                          {m.text}\n                        </div>\n                        {mine ? (\n                          <div className=\"h-8 w-8 rounded-full border border-white/10 bg-white/5 overflow-hidden shrink-0\">\n                            <Image src={avatar} alt={label} width={32} height={32} className=\"h-full w-full\" />\n                          </div>\n                        ) : null}\n                      </div>\n                    );\n                  })}\n\n                  {showRewards ? (\n                    <div className=\"mt-4 rounded-2xl border border-emerald-500/30 bg-emerald-500/10 p-4\">\n                      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-emerald-200\">Mission Rewards</div>\n                      <div className=\"mt-4 grid grid-cols-2 gap-3\">\n                        <div className=\"rounded-xl border border-white/10 bg-black/40 p-3\">\n                          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">XP</div>\n                          <div className=\"mt-2 text-2xl font-black text-white\">+{xpReward}</div>\n                        </div>\n                        <div className=\"rounded-xl border border-white/10 bg-black/40 p-3\">\n                          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">B-Coins</div>\n                          <div className=\"mt-2 text-2xl font-black text-amber-300\">+{bCoinReward}</div>\n                        </div>\n                      </div>\n                      <div className=\"mt-4 text-xs text-emerald-100/80\">Rewards have been added to your profile.</div>\n                    </div>\n                  ) : null}\n                </div>\n              </div>\n\n              <div className=\"mt-4 text-center text-xs text-zinc-500\">Mission complete ‚Ä¢ rewards applied</div>\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"phone-close\"\n              initial={{ opacity: 1, scale: 1 }}\n              animate={{ opacity: 0, scale: 0.85 }}\n              transition={{ duration: 0.35 }}\n              className=\"w-full max-w-[420px]\"\n            >\n              <div className=\"rounded-[2.25rem] border border-white/15 bg-black/70 h-[620px]\" />\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n\nfunction PhoneMessageIntro({\n  mission,\n  userLabel,\n  userAvatarUrl,\n  npcLabel,\n  npcAvatarUrl,\n  onDone,\n}: {\n  mission: BrightOSMission;\n  userLabel: string;\n  userAvatarUrl: string;\n  npcLabel: string;\n  npcAvatarUrl: string;\n  onDone: () => void;\n}) {\n  const script = useMemo(() => {\n    const opener = mission.client.dialogue_start;\n    const userLine = mission.id === 'tech-5'\n      ? 'Ok. I‚Äôm going to check your drivers and get the audio working again.'\n      : mission.id === 'tech-6'\n        ? 'Ok. I‚Äôll adjust the display settings and fix the resolution.'\n        : mission.id === 'tech-3'\n          ? 'Ok. I‚Äôll clean up storage and free up space.'\n          : mission.id === 'tech-13'\n            ? 'Ok. I‚Äôm going to run a deep scan and quarantine anything suspicious.'\n            : 'Ok. I‚Äôm on it. I‚Äôll troubleshoot and fix it.';\n    const closer = 'Thanks. Please hurry, I really need it working.';\n\n    return [\n      { from: 'npc' as const, text: opener },\n      { from: 'user' as const, text: userLine },\n      { from: 'npc' as const, text: closer },\n    ];\n  }, [mission.client.dialogue_start, mission.id]);\n\n  const [msgIndex, setMsgIndex] = useState(0);\n  const [charIndex, setCharIndex] = useState(0);\n  const [closing, setClosing] = useState(false);\n\n  useEffect(() => {\n    if (closing) return;\n    const current = script[msgIndex];\n    if (!current) return;\n\n    if (charIndex < current.text.length) {\n      const id = window.setTimeout(() => setCharIndex((p) => p + 1), current.from === 'npc' ? 32 : 26);\n      return () => window.clearTimeout(id);\n    }\n\n    if (msgIndex < script.length - 1) {\n      const id = window.setTimeout(() => {\n        setMsgIndex((p) => p + 1);\n        setCharIndex(0);\n      }, 900);\n      return () => window.clearTimeout(id);\n    }\n\n    const id = window.setTimeout(() => {\n      setClosing(true);\n      window.setTimeout(() => onDone(), 800);\n    }, 1200);\n    return () => window.clearTimeout(id);\n  }, [charIndex, closing, msgIndex, onDone, script]);\n\n  const visibleMessages = useMemo(() => {\n    const out: Array<{ from: 'npc' | 'user'; text: string }> = [];\n    script.forEach((m, i) => {\n      if (i < msgIndex) out.push(m);\n      if (i === msgIndex) out.push({ ...m, text: m.text.slice(0, charIndex) });\n    });\n    return out;\n  }, [charIndex, msgIndex, script]);\n\n  return (\n    <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n      <div className=\"absolute inset-0 bg-gradient-to-b from-[var(--brand-primary)]/10 via-transparent to-black\" />\n      <div className=\"relative z-10 min-h-screen flex items-center justify-center px-6\">\n        <AnimatePresence mode=\"wait\">\n          {!closing ? (\n            <motion.div\n              key=\"phone-open\"\n              initial={{ opacity: 0, scale: 0.92, y: 18 }}\n              animate={{ opacity: 1, scale: 1, y: 0 }}\n              exit={{ opacity: 0, scale: 0.92, y: 18 }}\n              transition={{ duration: 0.35 }}\n              className=\"w-full max-w-[420px]\"\n            >\n              <div className=\"rounded-[2.25rem] border border-white/15 bg-black/70 overflow-hidden shadow-[0_24px_80px_rgba(0,0,0,0.6)]\">\n                <div className=\"px-5 py-4 border-b border-white/10 flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"h-9 w-9 rounded-full border border-white/10 bg-white/5 overflow-hidden\">\n                      <Image src={npcAvatarUrl} alt={npcLabel} width={36} height={36} className=\"h-full w-full\" />\n                    </div>\n                    <div>\n                      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500\">Messages</div>\n                      <div className=\"mt-0.5 text-sm font-black text-white\">{npcLabel}</div>\n                    </div>\n                  </div>\n                  <button\n                    onClick={() => {\n                      setClosing(true);\n                      window.setTimeout(() => onDone(), 350);\n                    }}\n                    className=\"h-9 px-3 rounded-xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200 transition-colors\"\n                  >\n                    Skip\n                  </button>\n                </div>\n\n                <div className=\"p-5 h-[520px] overflow-auto sleek-scrollbar flex flex-col gap-3\">\n                  {visibleMessages.map((m, idx) => {\n                    const mine = m.from === 'user';\n                    const avatar = mine ? userAvatarUrl : npcAvatarUrl;\n                    const label = mine ? userLabel : npcLabel;\n                    return (\n                      <div key={idx} className={`flex items-end gap-2 ${mine ? 'justify-end' : 'justify-start'}`}>\n                        {!mine ? (\n                          <div className=\"h-8 w-8 rounded-full border border-white/10 bg-white/5 overflow-hidden shrink-0\">\n                            <Image src={avatar} alt={label} width={32} height={32} className=\"h-full w-full\" />\n                          </div>\n                        ) : null}\n                        <div\n                          className={`max-w-[78%] rounded-2xl border px-4 py-3 text-sm leading-relaxed ${mine\n                            ? 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 text-white'\n                            : 'border-white/10 bg-white/[0.03] text-zinc-200'\n                            }`}\n                        >\n                          {m.text}\n                          {idx === visibleMessages.length - 1 && msgIndex === script.length - 1 && charIndex >= script[msgIndex]?.text.length ? null : null}\n                        </div>\n                        {mine ? (\n                          <div className=\"h-8 w-8 rounded-full border border-white/10 bg-white/5 overflow-hidden shrink-0\">\n                            <Image src={avatar} alt={label} width={32} height={32} className=\"h-full w-full\" />\n                          </div>\n                        ) : null}\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n\n              <div className=\"mt-4 text-center text-xs text-zinc-500\">Incoming support ticket‚Ä¶</div>\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"phone-close\"\n              initial={{ opacity: 1, scale: 1 }}\n              animate={{ opacity: 0, scale: 0.85 }}\n              transition={{ duration: 0.35 }}\n              className=\"w-full max-w-[420px]\"\n            >\n              <div className=\"rounded-[2.25rem] border border-white/15 bg-black/70 h-[620px]\" />\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n\nfunction DeviceManagerWindow({\n  state,\n  onState,\n  onNotify,\n}: {\n  state: RuntimeState;\n  onState: (fn: (p: RuntimeState) => RuntimeState) => void;\n  onNotify: (kind: 'alert' | 'info', title: string, body: string) => void;\n}) {\n  const driver = state.device.audio.driver_status;\n  return (\n    <div className=\"h-full flex flex-col gap-4\">\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Device Manager (Drivers)</div>\n\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 overflow-hidden\">\n        <div className=\"px-4 py-3 border-b border-white/10\">\n          <div className=\"text-sm font-black text-white\">Sound, video and game controllers</div>\n          <div className=\"mt-1 text-xs text-zinc-400\">Audio Device ‚Ä¢ Driver: <span className={driver === 'updated' ? 'text-emerald-300' : 'text-amber-200'}>{driver}</span></div>\n        </div>\n        <div className=\"p-4\">\n          <div className=\"text-xs text-zinc-400\">Status</div>\n          <div className=\"mt-2 text-sm text-zinc-200\">\n            {driver === 'updated'\n              ? 'This device is working properly.'\n              : 'Driver issue detected. Audio output may be unavailable.'}\n          </div>\n\n          <div className=\"mt-4 flex flex-wrap gap-2\">\n            <button\n              onClick={() => {\n                if (driver === 'updated') return;\n                onState((p) => ({ ...p, device: { ...p.device, audio: { driver_status: 'updated' } }, audio: { output: true } }));\n                onNotify('info', 'DEVICE MANAGER', 'Audio driver updated. Output restored.');\n              }}\n              disabled={driver === 'updated'}\n              className={`h-10 px-4 rounded-2xl border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${driver === 'updated'\n                ? 'border-white/10 bg-white/[0.03] text-zinc-500'\n                : 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-white'\n                }`}\n            >\n              Update Driver\n            </button>\n            <button\n              onClick={() => {\n                onNotify('info', 'DEVICE MANAGER', 'Scan complete.');\n              }}\n              className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n            >\n              Scan for hardware changes\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\ntype Briefing = {\n  ticketId: string;\n  category: string;\n  priority: 'P1' | 'P2' | 'P3' | 'P4';\n  urgency: 'Critical' | 'High' | 'Medium' | 'Low';\n  deviceOwner: { name: string; role: string; email: string };\n  policyBanner: string;\n  slaMinutes: number;\n  summary: string;\n  steps: string[];\n  attachments: string[];\n};\n\ntype StoryPack = {\n  briefing: Briefing;\n  emails: StoryEmail[];\n  chat: StoryChatMessage[];\n  events: StoryEvent[];\n  pinnedApps: Array<'mail' | 'chat'>;\n  accent: 'emerald' | 'amber' | 'sky' | 'red' | 'zinc';\n};\n\ntype AllowedTool = BrightOSMission['tools_allowed'][number];\n\ntype AppId = AllowedTool;\n\nfunction uid(prefix: string) {\n  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;\n}\n\nfunction pickAccent(preset: BrightOSMission['brightos_desktop']['ui_preset']): StoryPack['accent'] {\n  if (preset === 'smallbiz_admin') return 'amber';\n  if (preset === 'techfix_shop') return 'sky';\n  if (preset === 'automation_lab') return 'emerald';\n  if (preset === 'csec_soc') return 'red';\n  return 'zinc';\n}\n\nfunction inferScenario(mission: BrightOSMission) {\n  const s = mission.success_condition;\n  if (s.includes('router.')) return 'router';\n  if (s.includes('browser.redirects') || s.includes('browser.extensions')) return 'browser_cleanup';\n  if (s.includes('mail.flagged_phishing')) return 'phishing';\n  if (s.includes('defend.threats')) return 'malware_scan';\n  if (s.includes('firewall.inbound')) return 'firewall';\n  if (s.includes('ftp.uploaded')) return 'ftp';\n  if (s.includes('forensics.bruteforce_timestamp')) return 'forensics';\n  if (s.includes('folder.encrypted')) return 'encryption';\n  if (s.includes('files.restored') || s.includes('ransomware.lock_screen')) return 'ransomware';\n  if (s.includes('disk.free_space') || s.includes('files.tmp.count') || s.includes('recycle_bin')) return 'storage_cleanup';\n  if (s.includes('terminal.last_command') || s.includes('ping.') || s.includes('trace.')) return 'terminal_network';\n  if (s.includes('automation.') || s.includes('validation.') || s.includes('script.') || s.includes('vars.') || s.includes('list.')) return 'automation';\n  if (s.includes('hardware.ram_gb')) return 'hardware';\n  return 'general';\n}\n\nfunction buildStoryPack(mission: BrightOSMission, company: { name: string; dept: string; hostname: string }): StoryPack {\n  const scenario = inferScenario(mission);\n  const accent = pickAccent(mission.brightos_desktop.ui_preset);\n  const ticketId = `${company.hostname}-${String(mission.rank).padStart(2, '0')}-${mission.id.toUpperCase()}`;\n\n  const deviceOwner = {\n    name: mission.client.name,\n    role: mission.client.role,\n    email: `${mission.client.name.toLowerCase().replace(/[^a-z]+/g, '.').replace(/^\\.|\\.$/g, '') || 'user'}@${company.name.toLowerCase().replace(/[^a-z]+/g, '')}.com`,\n  };\n\n  const baseSla = mission.rank <= 1 ? 45 : mission.rank === 2 ? 35 : mission.rank === 3 ? 25 : mission.rank === 4 ? 20 : 15;\n  const slaMinutes = scenario === 'ransomware' || scenario === 'firewall' ? Math.min(20, baseSla) : baseSla;\n\n  const policyBanner =\n    scenario === 'ransomware' || scenario === 'forensics' || mission.brightos_desktop.ui_preset === 'csec_soc'\n      ? 'POLICY: Incident Response ‚Äî preserve evidence, document actions, and escalate critical events.'\n      : scenario === 'phishing'\n        ? 'POLICY: Email Security ‚Äî never share credentials, report phishing immediately.'\n        : scenario === 'encryption'\n          ? 'POLICY: Data Protection ‚Äî encrypt sensitive folders before transfer.'\n          : 'POLICY: Acceptable Use ‚Äî follow company IT guidelines and log all changes.';\n\n  const summary =\n    scenario === 'router'\n      ? 'Secure the router configuration and remove unauthorized access.'\n      : scenario === 'browser_cleanup'\n        ? 'Stop browser redirects by removing the malicious extension.'\n        : scenario === 'phishing'\n          ? 'Identify and flag a suspicious email impersonating an admin.'\n          : scenario === 'firewall'\n            ? 'Block a risky inbound port to reduce the attack surface.'\n            : scenario === 'ransomware'\n              ? 'Restore from backup and bring the system back online safely.'\n              : scenario === 'forensics'\n                ? 'Review logs and extract the timestamp of the brute force attempt.'\n                : scenario === 'ftp'\n                  ? 'Upload the required file to the server and confirm transfer.'\n                  : scenario === 'automation'\n                    ? 'Apply the correct logic and run the test simulation.'\n                    : 'Resolve the ticket using the allowed tools and confirm success.';\n\n  const priority: Briefing['priority'] = scenario === 'ransomware' ? 'P1' : mission.rank >= 4 ? 'P2' : mission.rank >= 2 ? 'P3' : 'P4';\n  const urgency: Briefing['urgency'] = priority === 'P1' ? 'Critical' : priority === 'P2' ? 'High' : priority === 'P3' ? 'Medium' : 'Low';\n\n  const attachments: string[] = [];\n  if (scenario === 'forensics') attachments.push('C:/Logs/access.log');\n  if (scenario === 'ftp') attachments.push('C:/Users/Student/Desktop/index.html');\n  if (scenario === 'encryption') attachments.push('C:/Users/Student/Documents/Clinic/Records/');\n  if (scenario === 'ransomware') attachments.push('E:/Backup/');\n  if (scenario === 'router') attachments.push('Router/Clients: 3 (one unknown)');\n\n  const emails: StoryEmail[] = [];\n  const chat: StoryChatMessage[] = [];\n  const events: StoryEvent[] = [];\n\n  const inboxBaseId = `${mission.id}-inbox-1`;\n  if (scenario === 'phishing') {\n    emails.push({\n      id: inboxBaseId,\n      from: 'admin@g00gle.com',\n      subject: 'Urgent password reset required',\n      preview: 'Your account will be disabled in 30 minutes‚Ä¶',\n      body: 'We detected unusual activity. Click the link to reset your password immediately.\\n\\n‚Äî IT Admin',\n      attachments: ['phishing_screenshot.png'],\n      unread: true,\n    });\n    events.push({ kind: 'notify', atOffsetMs: 2500, level: 'alert', title: 'MAIL', body: 'New message received: Urgent password reset required' });\n    events.push({ kind: 'email', atOffsetMs: 2500, emailId: inboxBaseId });\n  }\n\n  if (scenario === 'ransomware') {\n    emails.push({\n      id: inboxBaseId,\n      from: 'ops@caribsec.local',\n      subject: 'Ransomware outbreak - restore guidance',\n      preview: 'Use backup drive E: to restore encrypted documents‚Ä¶',\n      body: 'Do NOT pay ransom. Restore from E:/Backup/. Document every step. If you see unusual persistence, escalate to SOC.',\n      attachments: ['restore_runbook.pdf'],\n      unread: true,\n    });\n    events.push({ kind: 'notify', atOffsetMs: 3500, level: 'alert', title: 'SECURITY', body: 'Incident Severity: HIGH ‚Äî follow IR policy.' });\n  }\n\n  if (scenario === 'router') {\n    chat.push({ id: `${mission.id}-chat-1`, from: 'NetworkOps', text: 'Need the router hardened ASAP. Change admin creds + block unknown device.', atOffsetMs: 4000 });\n  }\n\n  if (scenario === 'forensics') {\n    chat.push({ id: `${mission.id}-chat-1`, from: 'SOC Analyst', text: 'Please pull first brute force timestamp from access.log and reply with the exact value.', atOffsetMs: 3500 });\n    events.push({ kind: 'document', atOffsetMs: 0, path: 'C:/Logs/access.log' });\n  }\n\n  if (scenario === 'automation') {\n    chat.push({ id: `${mission.id}-chat-1`, from: 'Trainer', text: 'Open Automation App and run the test once your logic is correct.', atOffsetMs: 2500 });\n  }\n\n  if (scenario === 'ftp') {\n    chat.push({ id: `${mission.id}-chat-1`, from: 'WebAdmin', text: 'Need index.html uploaded to /public_html via FTP. Use the sim command if needed.', atOffsetMs: 3000 });\n  }\n\n  if (scenario === 'firewall') {\n    events.push({ kind: 'notify', atOffsetMs: 2000, level: 'alert', title: 'SECURITY', body: 'Inbound Telnet traffic detected ‚Äî recommend blocking port 23.' });\n  }\n\n  return {\n    briefing: {\n      ticketId,\n      category:\n        scenario === 'router'\n          ? 'Network / Router'\n          : scenario === 'phishing'\n            ? 'Security / Email'\n            : scenario === 'firewall'\n              ? 'Security / Firewall'\n              : scenario === 'automation'\n                ? 'Programming / Logic'\n                : scenario === 'storage_cleanup'\n                  ? 'System / Storage'\n                  : 'IT Support',\n      priority,\n      urgency,\n      deviceOwner,\n      policyBanner,\n      slaMinutes,\n      summary,\n      steps: mission.steps_to_solve,\n      attachments,\n    },\n    emails,\n    chat,\n    events,\n    pinnedApps: ['mail', 'chat'],\n    accent,\n  };\n}\n\nfunction MailApp({ emails }: { emails: StoryEmail[] }) {\n  const [selected, setSelected] = useState<string | null>(emails[0]?.id ?? null);\n  const current = emails.find((e) => e.id === selected) || null;\n  return (\n    <div className=\"h-full grid grid-cols-[260px_1fr] gap-4\">\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 overflow-hidden\">\n        <div className=\"px-4 py-3 border-b border-white/10 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Inbox</div>\n        <div className=\"h-[calc(100%-2.5rem)] overflow-auto\">\n          {emails.length === 0 ? (\n            <div className=\"p-4 text-sm text-zinc-400\">No messages.</div>\n          ) : (\n            emails.map((m) => (\n              <button\n                key={m.id}\n                onClick={() => setSelected(m.id)}\n                className={`w-full text-left px-4 py-3 border-b border-white/5 hover:bg-white/[0.04] transition-colors ${selected === m.id ? 'bg-white/[0.06]' : ''}`}\n              >\n                <div className=\"text-xs font-bold text-white truncate\">{m.subject}</div>\n                <div className=\"mt-0.5 text-[11px] text-zinc-400 truncate\">{m.from}</div>\n                <div className=\"mt-1 text-[11px] text-zinc-400/80 truncate\">{m.preview}</div>\n              </button>\n            ))\n          )}\n        </div>\n      </div>\n\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4 overflow-auto\">\n        {!current ? (\n          <div className=\"text-sm text-zinc-300\">Select a message.</div>\n        ) : (\n          <div>\n            <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">From</div>\n            <div className=\"mt-1 text-sm text-white font-semibold\">{current.from}</div>\n            <div className=\"mt-4 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Subject</div>\n            <div className=\"mt-1 text-sm text-white font-semibold\">{current.subject}</div>\n            <div className=\"mt-4 whitespace-pre-wrap text-sm text-zinc-200 leading-relaxed\">{current.body}</div>\n            {current.attachments?.length ? (\n              <div className=\"mt-6\">\n                <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Attachments</div>\n                <div className=\"mt-2 flex flex-wrap gap-2\">\n                  {current.attachments.map((a) => (\n                    <div key={a} className=\"px-3 py-2 rounded-xl border border-white/10 bg-black/20 text-xs text-zinc-200 font-mono\">{a}</div>\n                  ))}\n                </div>\n              </div>\n            ) : null}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ChatApp({ messages }: { messages: Array<{ from: string; text: string }> }) {\n  return (\n    <div className=\"h-full rounded-2xl border border-white/10 bg-black/30 overflow-hidden flex flex-col\">\n      <div className=\"px-4 py-3 border-b border-white/10 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Team Chat</div>\n      <div className=\"flex-1 p-4 overflow-auto space-y-3\">\n        {messages.length === 0 ? (\n          <div className=\"text-sm text-zinc-400\">No messages.</div>\n        ) : (\n          messages.map((m, idx) => (\n            <div key={idx} className=\"rounded-2xl border border-white/10 bg-black/20 p-3\">\n              <div className=\"text-[11px] font-black text-white/80\">{m.from}</div>\n              <div className=\"mt-1 text-sm text-zinc-200\">{m.text}</div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction BriefingOverlay({\n  briefing,\n  now,\n  startAt,\n  accent,\n  onAcknowledge,\n}: {\n  briefing: Briefing;\n  now: Date;\n  startAt: number;\n  accent: StoryPack['accent'];\n  onAcknowledge: () => void;\n}) {\n  const deadline = startAt + briefing.slaMinutes * 60_000;\n  const remainingMs = Math.max(0, deadline - now.getTime());\n  const mins = Math.floor(remainingMs / 60_000);\n  const secs = Math.floor((remainingMs % 60_000) / 1000);\n  const slaLabel = `${mins}:${String(secs).padStart(2, '0')}`;\n  const accentClass =\n    accent === 'emerald'\n      ? 'border-emerald-500/30 bg-emerald-500/10 text-emerald-200'\n      : accent === 'amber'\n        ? 'border-amber-500/30 bg-amber-500/10 text-amber-200'\n        : accent === 'sky'\n          ? 'border-sky-500/30 bg-sky-500/10 text-sky-200'\n          : accent === 'red'\n            ? 'border-red-500/30 bg-red-500/10 text-red-200'\n            : 'border-white/10 bg-white/[0.03] text-zinc-200';\n\n  return (\n    <div className=\"absolute inset-0 z-[300]\">\n      <div className=\"absolute inset-0 bg-black/70\" />\n      <div className=\"absolute inset-0 flex items-center justify-center p-6\">\n        <div className=\"w-full max-w-3xl rounded-[2rem] border border-white/20 bg-black/80 overflow-hidden\">\n          <div className=\"p-6 border-b border-white/10 flex items-start justify-between gap-6\">\n            <div>\n              <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Mission Briefing</div>\n              <div className=\"mt-2 text-2xl font-black text-white\">Ticket {briefing.ticketId}</div>\n              <div className=\"mt-2 text-sm text-zinc-300/80\">{briefing.category} ‚Ä¢ Priority {briefing.priority} ‚Ä¢ Urgency {briefing.urgency}</div>\n            </div>\n            <div className={`shrink-0 rounded-2xl border px-4 py-3 ${accentClass}`}>\n              <div className=\"text-[10px] font-black uppercase tracking-[0.25em] opacity-80\">SLA Remaining</div>\n              <div className=\"mt-1 text-xl font-black\">{slaLabel}</div>\n            </div>\n          </div>\n\n          <div className=\"p-6 grid gap-5\">\n            <div className={`rounded-2xl border px-4 py-3 ${accentClass}`}>\n              <div className=\"text-[10px] font-black uppercase tracking-[0.25em]\">{briefing.policyBanner}</div>\n            </div>\n\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n                <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Device Owner</div>\n                <div className=\"mt-2 text-sm text-white font-black\">{briefing.deviceOwner.name}</div>\n                <div className=\"mt-1 text-xs text-zinc-300/80\">{briefing.deviceOwner.role}</div>\n                <div className=\"mt-2 text-xs text-zinc-300/80 font-mono\">{briefing.deviceOwner.email}</div>\n              </div>\n\n              <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n                <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Summary</div>\n                <div className=\"mt-2 text-sm text-zinc-200 leading-relaxed\">{briefing.summary}</div>\n              </div>\n            </div>\n\n            <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n              <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Steps to Solve</div>\n              <div className=\"mt-3 grid gap-1.5 text-sm text-zinc-200/90\">\n                {briefing.steps.slice(0, 8).map((s) => (\n                  <div key={s}>- {s}</div>\n                ))}\n              </div>\n            </div>\n\n            {briefing.attachments.length ? (\n              <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n                <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Attachments / Context</div>\n                <div className=\"mt-3 flex flex-wrap gap-2\">\n                  {briefing.attachments.slice(0, 8).map((a) => (\n                    <div key={a} className=\"px-3 py-2 rounded-xl border border-white/10 bg-black/20 text-xs text-zinc-200 font-mono\">{a}</div>\n                  ))}\n                </div>\n              </div>\n            ) : null}\n          </div>\n\n          <div className=\"p-6 border-t border-white/10 flex items-center justify-between gap-4\">\n            <div className=\"text-xs text-zinc-400\">Acknowledge the briefing to proceed to the lock screen.</div>\n            <button\n              onClick={onAcknowledge}\n              className=\"h-12 px-6 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-white\"\n            >\n              Acknowledge & Continue\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction BrowserWindow({\n  mission,\n  state,\n  onState,\n  onNotify,\n}: {\n  mission: BrightOSMission;\n  state: RuntimeState;\n  onState: (fn: (p: RuntimeState) => RuntimeState) => void;\n  onNotify: (kind: 'alert' | 'info', title: string, body: string) => void;\n}) {\n  const wantsRouter = mission.success_condition.includes('router.');\n  const wantsRedirectFix = mission.success_condition.includes('browser.redirects') || mission.success_condition.includes('browser.extensions');\n  const wantsPhishing = mission.success_condition.includes('mail.flagged_phishing');\n\n  return (\n    <div className=\"h-full flex flex-col gap-4\">\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Browser</div>\n\n      {wantsRouter && (\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Router Admin (192.168.0.1)</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">Device: {state.unknown_device.mac} ‚Ä¢ Wi‚ÄëFi Security: {state.router.wifi.security}</div>\n          <div className=\"mt-4 grid gap-2\">\n            <button\n              onClick={() => {\n                onState((p) => ({ ...p, router: { ...p.router, admin_password_changed: true } }));\n                onNotify('info', 'ROUTER', 'Admin password updated.');\n              }}\n              className=\"h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n            >\n              Change Admin Password\n            </button>\n            <button\n              onClick={() => {\n                onState((p) => ({ ...p, router: { ...p.router, wifi: { security: 'WPA2' } } }));\n                onNotify('info', 'ROUTER', 'Wi‚ÄëFi security set to WPA2.');\n              }}\n              className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n            >\n              Set Wi‚ÄëFi Security: WPA2\n            </button>\n            <button\n              onClick={() => {\n                onState((p) => ({ ...p, router: { ...p.router, port_forwarding: Array.from(new Set([...(p.router.port_forwarding || []), '80'])) } }));\n                onNotify('info', 'ROUTER', 'Port forwarding rule added: 80.');\n              }}\n              className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n            >\n              Add Port Forward: 80\n            </button>\n            <button\n              onClick={() => {\n                onState((p) => ({ ...p, router: { ...p.router, blocked_macs: Array.from(new Set([...(p.router.blocked_macs || []), p.unknown_device.mac])) } }));\n                onNotify('info', 'ROUTER', 'Unknown device blocked.');\n              }}\n              className=\"h-10 px-4 rounded-2xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100 transition-colors\"\n            >\n              Block MAC\n            </button>\n          </div>\n        </div>\n      )}\n\n      {wantsRedirectFix && (\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Extensions</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">Malicious: {state.browser.extensions.malicious}</div>\n          <button\n            onClick={() => {\n              onState((p) => ({ ...p, browser: { redirects: false, extensions: { malicious: 0 } } }));\n              onNotify('info', 'BROWSER', 'Malicious extension removed. Redirects stopped.');\n            }}\n            className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n          >\n            Remove Malicious Extension\n          </button>\n        </div>\n      )}\n\n      {wantsPhishing && (\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Inbox</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">From: admin@g00gle.com</div>\n          <div className=\"mt-2 text-sm text-zinc-200\">Subject: Urgent password reset required</div>\n          <button\n            onClick={() => {\n              onState((p) => ({ ...p, mail: { flagged_phishing: true } }));\n              onNotify('alert', 'MAIL', 'Email flagged as phishing.');\n            }}\n            className=\"mt-3 h-10 px-4 rounded-2xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100 transition-colors\"\n          >\n            Flag as Phishing\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction AutomationWindow({\n  mission,\n  state,\n  onState,\n  onNotify,\n}: {\n  mission: BrightOSMission;\n  state: RuntimeState;\n  onState: (fn: (p: RuntimeState) => RuntimeState) => void;\n  onNotify: (kind: 'alert' | 'info', title: string, body: string) => void;\n}) {\n  return (\n    <div className=\"h-full flex flex-col gap-4\">\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Automation App</div>\n\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n        <div className=\"text-sm font-black text-white\">Mission Lab</div>\n        <div className=\"mt-2 text-xs text-zinc-400\">Configure and run. Completion auto-checks.</div>\n\n        <div className=\"mt-4 grid gap-2\">\n          <button\n            onClick={() => {\n              if (mission.id === 'tech-31') onState((p) => ({ ...p, automation: { ...p.automation, flow: { valid: true } } }));\n              if (mission.id === 'tech-32') onState((p) => ({ ...p, automation: { ...p.automation, outputs: { ...p.automation.outputs, shutdown_triggered: true } } }));\n              if (mission.id === 'tech-33') onState((p) => ({ ...p, automation: { ...p.automation, outputs: { ...p.automation.outputs, moved_to_spam: true } } }));\n              if (mission.id === 'tech-34') onState((p) => ({ ...p, automation: { ...p.automation, outputs: { ...p.automation.outputs, fan_speed: 100 } } }));\n              if (mission.id === 'tech-35') onState((p) => ({ ...p, validation: { rejects_common_password: true, min_length: 8 } }));\n              if (mission.id === 'tech-36') onState((p) => ({ ...p, files: { ...p.files, renamed_prefix: 'img_', renamed_count: p.files.total } }));\n              if (mission.id === 'tech-37') onState((p) => ({ ...p, script: { ...p.script, output: 15 } }));\n              if (mission.id === 'tech-38') onState((p) => ({ ...p, script: { ...p.script, terminates: true }, cpu_load: 22 }));\n              if (mission.id === 'tech-39') onState((p) => ({ ...p, vars: { A: 10, B: 5 } }));\n              if (mission.id === 'tech-40') onState((p) => ({ ...p, list: { sorted: true } }));\n              if (mission.id === 'tech-48') onState((p) => ({ ...p, web: { validation: { blocks_sql_injection: true } } }));\n              onNotify('info', 'AUTOMATION', 'Simulation updated.');\n            }}\n            className=\"h-11 px-5 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-white\"\n          >\n            Apply Fix / Run Test\n          </button>\n          <div className=\"text-xs text-zinc-400\">\n            Current: flow.valid={String(state.automation.flow.valid)} ‚Ä¢ outputs={JSON.stringify(state.automation.outputs)}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction normPath(p: string) {\n  return p.replace(/\\\\/g, '/');\n}\n\nfunction listByPrefix(entries: string[], prefix: string) {\n  const base = prefix;\n  return entries\n    .map(normPath)\n    .filter((p) => p.startsWith(base))\n    .sort((a, b) => a.localeCompare(b));\n}\n\nfunction moveToRecycleBin(entries: string[], path: string) {\n  const target = normPath(path);\n  if (target.startsWith('RecycleBin:/')) return entries;\n  return entries.map((entry) => {\n    const normalized = normPath(entry);\n    if (normalized !== target) return normalized;\n    return `RecycleBin:/${normalized.replace(/^[A-Z]:\\//i, '')}`;\n  });\n}\n\nfunction DesktopIcon({\n  title,\n  subtitle,\n  icon,\n  onOpen,\n  disabled,\n}: {\n  title: string;\n  subtitle: string;\n  icon: string;\n  onOpen: () => void;\n  disabled: boolean;\n}) {\n  return (\n    <button\n      onDoubleClick={() => {\n        if (disabled) return;\n        onOpen();\n      }}\n      onClick={(e) => e.currentTarget.focus()}\n      className={`w-24 select-none text-center rounded border px-2 py-2 transition-colors ${disabled\n        ? 'border-white/20 bg-black/20 text-zinc-500 cursor-not-allowed'\n        : 'border-white/20 bg-black/25 hover:bg-black/35'\n        }`}\n      aria-disabled={disabled}\n    >\n      <div className=\"mx-auto h-10 w-10 rounded bg-white/10 border border-white/10 flex items-center justify-center text-xl text-white\">\n        {icon}\n      </div>\n      <div className=\"mt-2 text-[11px] leading-tight font-semibold text-white\">{title}</div>\n      <div className=\"mt-1 text-[10px] leading-tight text-zinc-300/80\">{subtitle}</div>\n    </button>\n  );\n}\n\nfunction UninstallPrograms({\n  apps,\n  onUninstall,\n}: {\n  apps: RuntimeState['apps'];\n  onUninstall: (appId: string) => void;\n}) {\n  const [query, setQuery] = useState('');\n\n  const rows = useMemo(() => {\n    const q = query.trim().toLowerCase();\n    return Object.entries(apps)\n      .map(([id, a]) => ({ id, ...a }))\n      .filter((a) => (q ? a.name.toLowerCase().includes(q) : true))\n      .sort((a, b) => a.name.localeCompare(b.name));\n  }, [apps, query]);\n\n  return (\n    <div className=\"h-full flex flex-col gap-3\">\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Installed Programs</div>\n      <input\n        value={query}\n        onChange={(e) => setQuery(e.target.value)}\n        placeholder=\"Search programs\"\n        className=\"h-11 rounded-2xl border border-white/10 bg-black/30 px-4 text-sm text-white outline-none focus:border-[var(--brand-primary)]/60\"\n      />\n\n      <div className=\"flex-1 rounded-2xl border border-white/10 bg-black/30 overflow-hidden\">\n        <div className=\"grid grid-cols-[1fr_140px_160px] gap-2 px-4 py-3 border-b border-white/10 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">\n          <div>Name</div>\n          <div>Status</div>\n          <div>Action</div>\n        </div>\n        <div className=\"h-[calc(100%-2.75rem)] overflow-auto\">\n          {rows.map((a) => (\n            <div key={a.id} className={`grid grid-cols-[1fr_140px_160px] gap-2 px-4 py-3 border-b border-white/5 text-sm ${a.malware && a.installed ? 'bg-red-500/5 text-zinc-100' : 'text-zinc-200'}`}>\n              <div className=\"font-semibold\">\n                {a.name}{' '}\n                {a.malware ? <span className=\"text-[10px] font-black uppercase tracking-[0.25em] text-red-200\">MALWARE</span> : null}\n              </div>\n              <div className=\"font-mono text-xs\">\n                {a.installed ? 'Installed' : 'Uninstalled'}\n              </div>\n              <div>\n                <button\n                  disabled={!a.installed}\n                  onClick={() => onUninstall(a.id)}\n                  className={`h-9 px-3 rounded-xl border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${a.installed\n                    ? 'border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-red-100'\n                    : 'border-white/10 bg-white/[0.03] text-zinc-500'\n                    }`}\n                >\n                  Uninstall\n                </button>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction RegistryEditor({\n  registry,\n  onSet,\n  onDelete,\n}: {\n  registry: RuntimeState['registry'];\n  onSet: (fullKey: string, value: string) => void;\n  onDelete: (prefix: string) => void;\n}) {\n  const [filter, setFilter] = useState('');\n  const [selected, setSelected] = useState<string | null>(null);\n  const [editValue, setEditValue] = useState('');\n\n  const keys = useMemo(() => {\n    const q = filter.trim().toLowerCase();\n    return Object.keys(registry)\n      .filter((k) => (q ? k.toLowerCase().includes(q) : true))\n      .sort((a, b) => a.localeCompare(b));\n  }, [filter, registry]);\n\n  useEffect(() => {\n    if (!selected) return;\n    setEditValue(registry[selected] ?? '');\n  }, [registry, selected]);\n\n  return (\n    <div className=\"h-full grid grid-cols-[320px_1fr] gap-4\">\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 overflow-hidden\">\n        <div className=\"p-3 border-b border-white/10\">\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Registry</div>\n          <input\n            value={filter}\n            onChange={(e) => setFilter(e.target.value)}\n            placeholder=\"Filter keys\"\n            className=\"mt-3 h-10 w-full rounded-2xl border border-white/10 bg-black/30 px-3 text-xs text-white outline-none focus:border-[var(--brand-primary)]/60\"\n          />\n        </div>\n        <div className=\"h-[calc(100%-4.5rem)] overflow-auto\">\n          {keys.slice(0, 240).map((k) => (\n            <button\n              key={k}\n              onClick={() => setSelected(k)}\n              className={`w-full text-left px-3 py-2 border-b border-white/5 text-xs font-mono transition-colors ${selected === k ? 'bg-white/[0.06] text-white' : 'hover:bg-white/[0.04] text-zinc-200'\n                }`}\n            >\n              {k}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n        <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Key Editor</div>\n\n        {!selected ? (\n          <div className=\"mt-3 text-sm text-zinc-300\">Select a key from the left.</div>\n        ) : (\n          <div className=\"mt-3\">\n            <div className=\"text-xs text-zinc-400\">Selected</div>\n            <div className=\"mt-1 text-xs font-mono text-white break-all\">{selected}</div>\n\n            <div className=\"mt-4 text-xs text-zinc-400\">Value</div>\n            <input\n              value={editValue}\n              onChange={(e) => setEditValue(e.target.value)}\n              className=\"mt-2 h-11 w-full rounded-2xl border border-white/10 bg-black/30 px-4 text-sm font-mono text-white outline-none focus:border-[var(--brand-primary)]/60\"\n            />\n\n            <div className=\"mt-4 flex flex-wrap gap-2\">\n              <button\n                onClick={() => onSet(selected, editValue)}\n                className=\"h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n              >\n                Save\n              </button>\n              <button\n                onClick={() => {\n                  onDelete(selected);\n                  setSelected(null);\n                }}\n                className=\"h-10 px-4 rounded-2xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100 transition-colors\"\n              >\n                Delete Key\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction Notifications({\n  items,\n  onDismiss,\n}: {\n  items: Array<{ id: string; kind: 'alert' | 'info'; title: string; body: string }>;\n  onDismiss: (id: string) => void;\n}) {\n  return (\n    <div className=\"absolute top-16 right-4 z-[260] w-[360px] max-w-[92vw]\">\n      <div className=\"grid gap-3\">\n        {items.slice(-4).map((n) => (\n          <div\n            key={n.id}\n            className={`border p-4 ${n.kind === 'alert' ? 'border-red-500/40 bg-red-950/60' : 'border-white/20 bg-zinc-900/90'}`}\n          >\n            <div className=\"flex items-start justify-between gap-3\">\n              <div>\n                <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">{n.title}</div>\n                <div className=\"mt-1 text-sm text-zinc-100/90\">{n.body}</div>\n              </div>\n              <button\n                onClick={() => onDismiss(n.id)}\n                className=\"h-7 w-10 border border-white/20 bg-black/20 hover:bg-black/30 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-200\"\n              >\n                X\n              </button>\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction clamp(n: number, min: number, max: number) {\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction pickBestActiveWindow(wins: Record<WindowId, WindowState>): WindowId {\n  const open = Object.values(wins)\n    .filter((w) => w.open && !w.minimized)\n    .sort((a, b) => b.z - a.z);\n  return (open[0]?.id ?? 'terminal') as WindowId;\n}\n\nfunction fanLevel(cpu: number) {\n  if (cpu > 85) return 3;\n  if (cpu > 60) return 2;\n  if (cpu > 35) return 1;\n  return 0;\n}\n\nfunction pickFromPool(pool: string[]) {\n  if (!pool.length) return '';\n  return pool[Math.floor(Math.random() * pool.length)] || pool[0] || '';\n}\n\nfunction normalizeConditionPath(path: string) {\n  const p = path.trim();\n  if (p === 'network_status') return 'network.status';\n  if (p.startsWith('power.')) return p.replace(/^power\\./, 'power_settings.');\n  return p;\n}\n\nfunction fileExistsInState(state: RuntimeState, needleRaw: string) {\n  const needle = normPath(String(needleRaw));\n  const opened = state.file.opened ? normPath(state.file.opened) : '';\n  if (opened && (opened === needle || opened.endsWith(`/${needle}`) || opened.endsWith(needle))) return true;\n  return false;\n}\n\nfunction fileExistsInFs(fs: string[], needleRaw: string) {\n  const needle = normPath(String(needleRaw));\n  return fs.some((p) => {\n    const n = normPath(p);\n    return n === needle || n.endsWith(`/${needle}`) || n.endsWith(needle);\n  });\n}\n\nfunction evalLeft(state: RuntimeState, left: string, fsEntries: string[]) {\n  const raw = left.trim();\n\n  const funcMatch = raw.match(/^([a-zA-Z_][\\w\\.]*)\\((.*)\\)$/);\n  if (funcMatch) {\n    const fn = funcMatch[1];\n    const argsRaw = funcMatch[2];\n    const args = argsRaw\n      ? argsRaw\n        .split(',')\n        .map((s) => s.trim())\n        .filter(Boolean)\n        .map(parseValue)\n      : [];\n\n    if (fn === 'file.exists') {\n      const needle = String(args[0] ?? '');\n      return fileExistsInFs(fsEntries, needle) || fileExistsInState(state, needle);\n    }\n    if (fn === 'folder.encrypted') {\n      const target = normPath(String(args[0] ?? ''));\n      return state.folder.encrypted_paths.map(normPath).includes(target);\n    }\n    if (fn === 'app.installed') {\n      const name = String(args[0] ?? '').toLowerCase();\n      const found = Object.values(state.apps).find((a) => a.name.toLowerCase() === name);\n      return Boolean(found?.installed);\n    }\n  }\n\n  const methodMatch = raw.match(/^(.+?)\\.(contains|startsWith)\\((.*)\\)$/);\n  if (methodMatch) {\n    const basePath = normalizeConditionPath(methodMatch[1] ?? '');\n    const method = methodMatch[2];\n    const parsedArg = parseValue(methodMatch[3] ?? '');\n    const arg =\n      typeof parsedArg === 'string' && parsedArg.includes('.') && getPath(state, normalizeConditionPath(parsedArg)) !== undefined\n        ? getPath(state, normalizeConditionPath(parsedArg))\n        : parsedArg;\n\n    const baseVal = basePath.startsWith('drive.')\n      ? fsEntries\n        .map(normPath)\n        .filter((p) => p.toUpperCase().startsWith(`${String(basePath.split('.')[1] ?? '').toUpperCase()}:\\/`))\n      : getPath(state, basePath);\n\n    if (method === 'contains') {\n      if (Array.isArray(baseVal)) {\n        if (typeof arg === 'string') {\n          const needle = String(arg);\n          return baseVal.some((v) => String(v).includes(needle) || String(v).endsWith(needle));\n        }\n        return baseVal.includes(arg);\n      }\n      if (typeof baseVal === 'string') return baseVal.includes(String(arg));\n      return false;\n    }\n\n    if (method === 'startsWith') {\n      if (typeof baseVal === 'string') return baseVal.startsWith(String(arg));\n      return false;\n    }\n  }\n\n  const normalized = normalizeConditionPath(raw);\n  return getPath(state, normalized);\n}\n\nfunction getPath(obj: any, path: string) {\n  return path.split('.').reduce((acc, key) => (acc == null ? undefined : acc[key]), obj);\n}\n\nfunction parseValue(raw: string) {\n  const s = raw.trim();\n  if ((s.startsWith('\"') && s.endsWith('\"')) || (s.startsWith(\"'\") && s.endsWith(\"'\"))) {\n    return s.slice(1, -1);\n  }\n  if (s === 'true') return true;\n  if (s === 'false') return false;\n  const n = Number(s);\n  if (!Number.isNaN(n)) return n;\n  return s;\n}\n\nfunction evalCondition(state: RuntimeState, cond: string) {\n  const ops = ['>=', '<=', '==', '!=', '>', '<'] as const;\n  const op = ops.find((o) => cond.includes(o));\n  if (!op) return false;\n\n  const [leftRaw, rightRaw] = cond.split(op);\n  if (!leftRaw || rightRaw == null) return false;\n\n  const leftPath = leftRaw.trim();\n  const rightVal = parseValue(rightRaw);\n  // fsEntries is not available here; evalSuccess wraps evalCondition with it\n  const leftVal = getPath(state, normalizeConditionPath(leftPath));\n\n  switch (op) {\n    case '==':\n      return leftVal === rightVal;\n    case '!=':\n      return leftVal !== rightVal;\n    case '>':\n      return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal > rightVal;\n    case '<':\n      return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal < rightVal;\n    case '>=':\n      return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal >= rightVal;\n    case '<=':\n      return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal <= rightVal;\n    default:\n      return false;\n  }\n}\n\nfunction evalSuccess(state: RuntimeState, expr: string, fsEntries: string[]) {\n  const orParts = expr.split('||').map((s) => s.trim()).filter(Boolean);\n  if (orParts.length === 0) return false;\n\n  return orParts.some((part) => {\n    const andParts = part.split('&&').map((s) => s.trim()).filter(Boolean);\n    if (andParts.length === 0) return false;\n    return andParts.every((c) => {\n      const ops = ['>=', '<=', '==', '!=', '>', '<'] as const;\n      const op = ops.find((o) => c.includes(o));\n      if (!op) return false;\n      const [leftRaw, rightRaw] = c.split(op);\n      if (!leftRaw || rightRaw == null) return false;\n      const rightVal = parseValue(rightRaw);\n      const leftVal = evalLeft(state, leftRaw, fsEntries);\n\n      switch (op) {\n        case '==':\n          return leftVal === rightVal;\n        case '!=':\n          return leftVal !== rightVal;\n        case '>':\n          return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal > rightVal;\n        case '<':\n          return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal < rightVal;\n        case '>=':\n          return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal >= rightVal;\n        case '<=':\n          return typeof leftVal === 'number' && typeof rightVal === 'number' && leftVal <= rightVal;\n        default:\n          return false;\n      }\n    });\n  });\n}\n\nfunction initRuntime(mission: BrightOSMission): RuntimeState {\n  const tmpCount = mission.initial_state.file_system.filter((p) => p.toLowerCase().endsWith('.tmp')).length;\n  const recycleHas = mission.initial_state.file_system.some((p) => p.startsWith('RecycleBin:/'));\n\n  const storageLow = mission.id === 'tech-3' || tmpCount > 0 || recycleHas;\n\n  const defaultApps: RuntimeState['apps'] = {\n    photos: { name: 'Photos', installed: true, malware: false, reinstall: false, process: 'photos.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Photos\\\\InstallPath'] },\n    stickynotes: { name: 'Sticky Notes', installed: true, malware: false, reinstall: false, process: 'stickynotes.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\StickyNotes\\\\Enabled'] },\n    notepad: { name: 'Notepad', installed: true, malware: false, reinstall: false, process: 'notepad.exe' },\n    brightos365: { name: 'BrightOS 365', installed: true, malware: false, reinstall: false, process: 'brightos365.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\365\\\\Version'] },\n    edulearner: { name: 'EduLearner', installed: true, malware: false, reinstall: false, process: 'edulearner.exe' },\n    calculator: { name: 'Calculator', installed: true, malware: false, reinstall: false, process: 'calc.exe' },\n    paint: { name: 'Paint', installed: true, malware: false, reinstall: false, process: 'mspaint.exe' },\n    mediaplayer: { name: 'Media Player', installed: true, malware: false, reinstall: false, process: 'wmplayer.exe' },\n    mail: { name: 'Mail', installed: true, malware: false, reinstall: false, process: 'mail.exe' },\n    calendar: { name: 'Calendar', installed: true, malware: false, reinstall: false, process: 'calendar.exe' },\n    camera: { name: 'Camera', installed: true, malware: false, reinstall: false, process: 'camera.exe' },\n    weather: { name: 'Weather', installed: true, malware: false, reinstall: false, process: 'weather.exe' },\n    maps: { name: 'Maps', installed: true, malware: false, reinstall: false, process: 'maps.exe' },\n    voice: { name: 'Voice Recorder', installed: true, malware: false, reinstall: false, process: 'voice.exe' },\n    scanner: { name: 'Scanner', installed: true, malware: false, reinstall: false, process: 'scanner.exe' },\n    backup: { name: 'Backup Tool', installed: true, malware: false, reinstall: false, process: 'backup.exe' },\n    security: { name: 'Security Center', installed: true, malware: false, reinstall: false, process: 'security.exe' },\n    cleaner: { name: 'Disk Cleaner', installed: true, malware: false, reinstall: false, process: 'cleaner.exe' },\n    updater: { name: 'Updater Service', installed: true, malware: false, reinstall: true, process: 'updater.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Updater\\\\AutoStart'] },\n    telemetry: { name: 'Telemetry', installed: true, malware: false, reinstall: true, process: 'telemetry.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Telemetry\\\\Enabled'] },\n    bloat1: { name: 'Coupon Companion', installed: true, malware: false, reinstall: true, process: 'coupon.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\CouponCompanion\\\\Enabled'] },\n    bloat2: { name: 'Game Bar Overlay', installed: true, malware: false, reinstall: true, process: 'gamebar.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\GameBar\\\\Enabled'] },\n    bloat3: { name: 'Smart Search', installed: true, malware: false, reinstall: true, process: 'smartsearch.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\SmartSearch\\\\Default'] },\n    bloat4: { name: 'Quick Launch', installed: true, malware: false, reinstall: true, process: 'quicklaunch.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\QuickLaunch\\\\Pin'] },\n    bloat5: { name: 'File Converter', installed: true, malware: false, reinstall: true, process: 'fileconv.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\FileConv\\\\Assoc'] },\n    bloat6: { name: 'PDF Viewer', installed: true, malware: false, reinstall: true, process: 'pdfviewer.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\PDFViewer\\\\Default'] },\n    bloat7: { name: 'Video Editor', installed: true, malware: false, reinstall: true, process: 'videoedit.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\VideoEditor\\\\LastProject'] },\n    bloat8: { name: 'Music Stream', installed: true, malware: false, reinstall: true, process: 'musicstream.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\MusicStream\\\\Service'] },\n    bloat9: { name: 'Cloud Sync', installed: true, malware: false, reinstall: true, process: 'cloudsync.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\CloudSync\\\\Folder'] },\n    bloat10: { name: 'Remote Desktop', installed: true, malware: false, reinstall: true, process: 'rdp.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\RDP\\\\Enabled'] },\n    bloat11: { name: 'Network Monitor', installed: true, malware: false, reinstall: true, process: 'netmon.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\NetMon\\\\Service'] },\n    bloat12: { name: 'System Info', installed: true, malware: false, reinstall: true, process: 'sysinfo.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\SysInfo\\\\LastScan'] },\n    bloat13: { name: 'Disk Defrag', installed: true, malware: false, reinstall: true, process: 'defrag.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Defrag\\\\Schedule'] },\n    bloat14: { name: 'Driver Updater', installed: true, malware: false, reinstall: true, process: 'driverup.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\DriverUpdater\\\\Auto'] },\n    bloat15: { name: 'Browser Helper', installed: true, malware: false, reinstall: true, process: 'browserhelper.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\BrowserHelper\\\\Ext'] },\n    bloat16: { name: 'Ad Blocker', installed: true, malware: false, reinstall: true, process: 'adblock.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\AdBlock\\\\Lists'] },\n    bloat17: { name: 'Game Booster', installed: true, malware: false, reinstall: true, process: 'gameboost.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\GameBoost\\\\Profile'] },\n    bloat18: { name: 'File Shredder', installed: true, malware: false, reinstall: true, process: 'shred.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Shred\\\\Secure'] },\n    bloat19: { name: 'VPN Client', installed: true, malware: false, reinstall: true, process: 'vpn.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\VPN\\\\Server'] },\n    bloat20: { name: 'Password Manager', installed: true, malware: false, reinstall: true, process: 'pwdmgr.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\PwdMgr\\\\Vault'] },\n    bloat21: { name: 'Screen Recorder', installed: true, malware: false, reinstall: true, process: 'screenrec.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\ScreenRec\\\\OutPath'] },\n    bloat22: { name: 'Partition Manager', installed: true, malware: false, reinstall: true, process: 'partmgr.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\PartMgr\\\\Layout'] },\n    bloat23: { name: 'Recovery Tool', installed: true, malware: false, reinstall: true, process: 'recovery.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Recovery\\\\Point'] },\n    bloat24: { name: 'Tweak Tool', installed: true, malware: false, reinstall: true, process: 'tweak.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\Tweak\\\\Profile'] },\n    bloat25: { name: 'Font Manager', installed: true, malware: false, reinstall: true, process: 'fontmgr.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\FontMgr\\\\Cache'] },\n    bloat26: { name: 'Icon Pack', installed: true, malware: false, reinstall: true, process: 'iconpack.exe', registryKeys: ['HKCU\\\\Software\\\\BrightOS\\\\IconPack\\\\Theme'] },\n    bloat27: { name: 'Theme Engine', installed: true, malware: false, reinstall: true, process: 'theme.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\Theme\\\\Current'] },\n    bloat28: { name: 'Startup Manager', installed: true, malware: false, reinstall: true, process: 'startupmgr.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\StartupMgr\\\\List'] },\n    bloat29: { name: 'Service Manager', installed: true, malware: false, reinstall: true, process: 'svc.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\SvcMgr\\\\Services'] },\n    bloat30: { name: 'Event Viewer', installed: true, malware: false, reinstall: true, process: 'eventvwr.exe', registryKeys: ['HKLM\\\\Software\\\\BrightOS\\\\EventViewer\\\\Log'] },\n    malware1: { name: 'CryptoMiner', installed: true, malware: true, reinstall: true, process: 'cryptominer.exe', registryKeys: ['HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\CryptoMiner', 'HKCU\\\\Software\\\\CryptoMiner\\\\Wallet'] },\n    malware2: { name: 'KeyLogger', installed: true, malware: true, reinstall: true, process: 'keylogger.exe', registryKeys: ['HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\KeyLogger', 'HKCU\\\\Software\\\\KeyLogger\\\\LogPath'] },\n    malware3: { name: 'RansomWare', installed: true, malware: true, reinstall: true, process: 'ransom.exe', registryKeys: ['HKLM\\\\Software\\\\Ransom\\\\Key', 'HKCU\\\\Software\\\\Ransom\\\\Target'] },\n    malware4: { name: 'Backdoor', installed: true, malware: true, reinstall: true, process: 'backdoor.exe', registryKeys: ['HKLM\\\\Software\\\\Backdoor\\\\C2', 'HKCU\\\\Software\\\\Backdoor\\\\Port'] },\n    malware5: { name: 'TrojanDownloader', installed: true, malware: true, reinstall: true, process: 'trojandl.exe', registryKeys: ['HKLM\\\\Software\\\\TrojanDL\\\\URL', 'HKCU\\\\Software\\\\TrojanDL\\\\Path'] },\n    malware6: { name: 'Spyware', installed: true, malware: true, reinstall: true, process: 'spyware.exe', registryKeys: ['HKLM\\\\Software\\\\Spyware\\\\Report', 'HKCU\\\\Software\\\\Spyware\\\\Exfil'] },\n    malware7: { name: 'AdwareInjector', installed: true, malware: true, reinstall: true, process: 'adinject.exe', registryKeys: ['HKLM\\\\Software\\\\Adware\\\\Config', 'HKCU\\\\Software\\\\Adware\\\\Ads'] },\n    malware8: { name: 'Rootkit', installed: true, malware: true, reinstall: true, process: 'rootkit.sys', registryKeys: ['HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\Rootkit', 'HKCU\\\\Software\\\\Rootkit\\\\Hide'] },\n  };\n\n  const defaultRegistry: RuntimeState['registry'] = {\n    'HKLM\\\\Software\\\\BrightOS\\\\Version': '10.0',\n    'HKLM\\\\Software\\\\BrightOS\\\\InstallPath': 'C:\\\\BrightOS',\n    'HKLM\\\\Software\\\\BrightOS\\\\Language': 'en-US',\n    'HKLM\\\\Software\\\\BrightOS\\\\TimeZone': 'UTC-04:00',\n    'HKLM\\\\Software\\\\BrightOS\\\\AutoUpdate': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Telemetry\\\\Enabled': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Telemetry\\\\Level': 'Full',\n    'HKLM\\\\Software\\\\BrightOS\\\\Security\\\\Firewall': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Security\\\\Defender': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Security\\\\RealTime': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Performance\\\\PowerPlan': 'Balanced',\n    'HKLM\\\\Software\\\\BrightOS\\\\Performance\\\\Index': '7.8',\n    'HKLM\\\\Software\\\\BrightOS\\\\Network\\\\Proxy': '',\n    'HKLM\\\\Software\\\\BrightOS\\\\Network\\\\DNS': '8.8.8.8,8.8.4.4',\n    'HKLM\\\\Software\\\\BrightOS\\\\UI\\\\Theme': 'Dark',\n    'HKLM\\\\Software\\\\BrightOS\\\\UI\\\\Accent': '#0099FF',\n    'HKLM\\\\Software\\\\BrightOS\\\\UI\\\\Transparency': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Explorer\\\\ShowHidden': '0',\n    'HKLM\\\\Software\\\\BrightOS\\\\Explorer\\\\FileExt': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Explorer\\\\Compact': '0',\n    'HKLM\\\\Software\\\\BrightOS\\\\System\\\\Restore': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\System\\\\Defrag': 'Weekly',\n    'HKLM\\\\Software\\\\BrightOS\\\\System\\\\Backup': 'Daily',\n    'HKLM\\\\Software\\\\BrightOS\\\\Drivers\\\\Signed': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Drivers\\\\AutoUpdate': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Services\\\\Indexing': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Services\\\\Search': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Services\\\\Update': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Services\\\\Sync': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Apps\\\\Store': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Apps\\\\StoreURL': 'https://store.brightos.com',\n    'HKLM\\\\Software\\\\BrightOS\\\\Apps\\\\DevMode': '0',\n    'HKLM\\\\Software\\\\BrightOS\\\\Hardware\\\\CPU': 'Intel Core i7-12700K',\n    'HKLM\\\\Software\\\\BrightOS\\\\Hardware\\\\GPU': 'NVIDIA RTX 4070',\n    'HKLM\\\\Software\\\\BrightOS\\\\Hardware\\\\RAM': '16GB',\n    'HKLM\\\\Software\\\\BrightOS\\\\Hardware\\\\Disk': '512GB SSD',\n    'HKLM\\\\Software\\\\BrightOS\\\\Hardware\\\\Motherboard': 'BrightOS Z790',\n    'HKLM\\\\Software\\\\BrightOS\\\\Licensing\\\\Key': 'XXXX-XXXX-XXXX-XXXX',\n    'HKLM\\\\Software\\\\BrightOS\\\\Licensing\\\\Activated': '1',\n    'HKLM\\\\Software\\\\BrightOS\\\\Licensing\\\\OEM': 'BrightOS Systems',\n    'HKLM\\\\Software\\\\BrightOS\\\\Debug\\\\LogLevel': 'Info',\n    'HKLM\\\\Software\\\\BrightOS\\\\Debug\\\\Dump': '0',\n    'HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\SecurityHealth': 'C:\\\\BrightOS\\\\System32\\\\securityhealth.exe',\n    'HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\Updater': 'C:\\\\BrightOS\\\\System32\\\\updater.exe',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Name': 'Student',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Email': 'student@brighted.edu',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Theme': 'Dark',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Language': 'en-US',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Desktop\\\\Wallpaper': 'C:\\\\BrightOS\\\\Web\\\\Wallpaper\\\\default.jpg',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Desktop\\\\Icons': '1',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Desktop\\\\Gadgets': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Privacy\\\\Telemetry': '1',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Privacy\\\\Location': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Privacy\\\\Ads': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Accessibility\\\\Narrator': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Accessibility\\\\Magnifier': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Accessibility\\\\HighContrast': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Network\\\\WiFi': '1',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Network\\\\Ethernet': '1',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Network\\\\VPN': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Power\\\\Battery': 'Balanced',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Power\\\\Sleep': '30',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Power\\\\Hibernate': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Sound\\\\Volume': '75',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Sound\\\\Mute': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Sound\\\\Notifications': '1',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Display\\\\Brightness': '80',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Display\\\\NightLight': '0',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Display\\\\Resolution': '1920x1080',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Input\\\\Keyboard': 'US',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Input\\\\MouseSpeed': '10',\n    'HKCU\\\\Software\\\\BrightOS\\\\User\\\\Input\\\\Touchpad': '1',\n  };\n\n  const hasDriveE = mission.initial_state.file_system.some((p) => normPath(p).toUpperCase().startsWith('E:/'));\n  const hasDriveD = mission.initial_state.file_system.some((p) => normPath(p).toUpperCase().startsWith('D:/'));\n\n  const networkInitialIp = mission.initial_state.network_status === 'Disconnected' ? '169.254.22.10' : '192.168.1.101';\n  const wantsPrinterQueue = mission.success_condition.includes('printer.queue.count');\n  const wantsThreats = mission.success_condition.includes('defend.threats');\n  const wantsBrowserFix = mission.success_condition.includes('browser.redirects') || mission.success_condition.includes('browser.extensions');\n  const wantsRansomware = mission.success_condition.includes('ransomware.');\n  const wantsFirewall = mission.success_condition.includes('firewall.');\n  const wantsEncryption = mission.success_condition.includes('folder.encrypted');\n\n  const baseVolumes = ['C:'];\n  if (hasDriveD) baseVolumes.push('D:');\n  if (hasDriveE) baseVolumes.push('E:');\n\n  return {\n    power: 'intro',\n    boot_phase: 0,\n    cpu_load: mission.initial_state.cpu_load,\n    network: {\n      status: mission.initial_state.network_status,\n      ip_renewed: false,\n      ip: networkInitialIp,\n      dns: { primary: '1.1.1.1' },\n      suspicious_connection: { active: mission.id === 'tech-41' },\n    },\n    window: { stuck_app: { open: mission.id === 'tech-1' } },\n    process: { high_cpu: { running: mission.id === 'tech-2' } },\n    disk: { free_space_mb: storageLow ? 120 : 850, volumes: baseVolumes },\n    files: { tmp: { count: tmpCount }, restored: false, renamed_prefix: '', renamed_count: 0, total: Math.max(0, mission.initial_state.file_system.length) },\n    recycle_bin: { empty: !recycleHas },\n    file: { opened: null },\n    terminal: { history: mission.initial_state.terminal_history, last_command: null, last_output: '' },\n    notifications: [],\n    apps: defaultApps,\n    registry: defaultRegistry,\n\n    audio: { output: mission.id !== 'tech-5' },\n    device: { audio: { driver_status: mission.id === 'tech-5' ? 'outdated' : 'updated' } },\n    display: { resolution: mission.id === 'tech-6' ? '800x600' : '1920x1080' },\n    power_settings: { screen_off_minutes_on_battery: mission.id === 'tech-9' ? 10 : 5 },\n    keyboard: { filter_keys: { enabled: mission.id === 'tech-12' } },\n    specs: { checked: false },\n\n    printer: { queue: { count: wantsPrinterQueue ? 6 : 0 }, ip: '192.168.0.50', reachable: false },\n    router: {\n      admin_password_changed: false,\n      wifi: { security: mission.id === 'tech-26' ? 'WEP' : 'WPA2' },\n      port_forwarding: [],\n      blocked_macs: [],\n    },\n    unknown_device: { mac: 'A4:5E:60:1C:9B:21' },\n    browser: { redirects: wantsBrowserFix, extensions: { malicious: wantsBrowserFix ? 1 : 0 } },\n    mail: { flagged_phishing: false },\n    defend: { threats: { active: wantsThreats ? 2 : 0, quarantined: 0 } },\n    account: { user: { password_reset: false } },\n    system: { restore: { completed: false }, crash_rate: 2 },\n    hardware: { ram_gb: mission.id === 'tech-20' ? 4 : 8 },\n    firewall: { inbound: { blocked_ports: wantsFirewall ? [] : [] } },\n    folder: { encrypted_paths: wantsEncryption ? [] : [] },\n    forensics: { bruteforce_timestamp: '' },\n    web: { validation: { blocks_sql_injection: false } },\n    ransomware: { lock_screen: wantsRansomware },\n    incident: { pid_identified: false, resolved: false },\n    ping: { packet_loss_percent: 0 },\n    trace: { loss_hop_index: 0 },\n    ftp: { uploaded: [] },\n    automation: { flow: { valid: false }, outputs: {} },\n    validation: { rejects_common_password: false, min_length: 0 },\n    script: { output: null, terminates: false },\n    vars: { A: 5, B: 10 },\n    list: { sorted: false },\n  } satisfies RuntimeState;\n}\n\nfunction initialWindows(mission: BrightOSMission): Record<WindowId, WindowState> {\n  const wins: Record<WindowId, WindowState> = {\n    taskmgr: { id: 'taskmgr', title: 'Task Manager', open: false, minimized: false, z: 4, x: 90, y: 120, w: 560, h: 420 },\n    terminal: { id: 'terminal', title: 'Terminal', open: false, minimized: false, z: 3, x: 150, y: 140, w: 700, h: 420 },\n    settings: { id: 'settings', title: 'Settings', open: false, minimized: false, z: 2, x: 120, y: 120, w: 620, h: 460 },\n    browser: { id: 'browser', title: 'Browser', open: false, minimized: false, z: 1, x: 180, y: 120, w: 760, h: 480 },\n    automation: { id: 'automation', title: 'Automation App', open: false, minimized: false, z: 1, x: 220, y: 130, w: 720, h: 440 },\n    devmgr: { id: 'devmgr', title: 'Device Manager', open: false, minimized: false, z: 1, x: 210, y: 140, w: 720, h: 480 },\n    mail: { id: 'mail', title: 'Mail', open: false, minimized: false, z: 1, x: 260, y: 140, w: 820, h: 520 },\n    chat: { id: 'chat', title: 'Teams', open: false, minimized: false, z: 1, x: 300, y: 160, w: 760, h: 520 },\n    explorer: { id: 'explorer', title: 'File Explorer', open: false, minimized: false, z: 1, x: 160, y: 120, w: 820, h: 520 },\n    uninstall: { id: 'uninstall', title: 'Uninstall or change a program', open: false, minimized: false, z: 1, x: 200, y: 140, w: 740, h: 500 },\n    registry: { id: 'registry', title: 'Registry Editor', open: false, minimized: false, z: 1, x: 240, y: 160, w: 680, h: 540 },\n    stuck_app: { id: 'stuck_app', title: 'Stuck Window', open: mission.id === 'tech-1', minimized: false, z: 5, x: 210, y: 180, w: 460, h: 220 },\n  };\n\n  const allowed = new Set(mission.tools_allowed);\n  // Default behavior: only Terminal starts open. Other tools are available via desktop icons / Start Menu.\n  if (allowed.has('Terminal')) wins.terminal.open = true;\n\n  return wins;\n}\n\nfunction toolToWindowId(tool: AppId): WindowId {\n  if (tool === 'Task Manager') return 'taskmgr';\n  if (tool === 'Terminal') return 'terminal';\n  if (tool === 'Settings') return 'settings';\n  if (tool === 'Browser') return 'browser';\n  return 'automation';\n}\n\nfunction toolLabel(tool: AppId) {\n  if (tool === 'Task Manager') return 'TaskMgr';\n  if (tool === 'Automation App') return 'Automation';\n  return tool;\n}\n\nfunction formatTime(now: Date) {\n  const hh = String(now.getHours()).padStart(2, '0');\n  const mm = String(now.getMinutes()).padStart(2, '0');\n  return `${hh}:${mm}`;\n}\n\nfunction StartMenu({\n  open,\n  query,\n  setQuery,\n  apps,\n  onLaunch,\n  onClose,\n  onLock,\n  onToggleTheme,\n  theme,\n}: {\n  open: boolean;\n  query: string;\n  setQuery: (v: string) => void;\n  apps: Array<{ id: WindowId; title: string; subtitle: string; disabled: boolean }>;\n  onLaunch: (id: WindowId) => void;\n  onClose: () => void;\n  onLock: () => void;\n  onToggleTheme: () => void;\n  theme: 'dark' | 'light';\n}) {\n  if (!open) return null;\n  const isLight = theme === 'light';\n  const q = query.trim().toLowerCase();\n  const filtered = q ? apps.filter((a) => `${a.title} ${a.subtitle}`.toLowerCase().includes(q)) : apps;\n\n  return (\n    <div className=\"absolute inset-0 z-[260]\" onMouseDown={onClose}>\n      <div className=\"absolute inset-0 bg-black/35\" />\n      <div className=\"absolute left-2 bottom-12\" onMouseDown={(e) => e.stopPropagation()}>\n        <div className={`w-[420px] max-w-[92vw] border shadow-2xl overflow-hidden ${isLight ? 'border-black/30 bg-zinc-50' : 'border-white/20 bg-zinc-900'}`}>\n          <div className={`px-3 py-3 border-b ${isLight ? 'border-black/20' : 'border-white/10'}`}>\n            <input\n              value={query}\n              onChange={(e) => setQuery(e.target.value)}\n              placeholder=\"Search programs and files\"\n              className={`w-full h-10 border px-3 text-sm outline-none ${isLight ? 'border-black/20 bg-white text-zinc-900' : 'border-white/20 bg-black/20 text-white'\n                }`}\n              autoFocus\n            />\n          </div>\n\n          <div className=\"p-3 grid grid-cols-1 gap-2\">\n            {filtered.slice(0, 14).map((a) => (\n              <button\n                key={a.id}\n                disabled={a.disabled}\n                onClick={() => {\n                  if (a.disabled) return;\n                  onLaunch(a.id);\n                }}\n                className={`w-full border px-3 py-2 text-left transition-colors ${a.disabled\n                  ? isLight\n                    ? 'border-black/15 bg-black/[0.03] text-zinc-500 cursor-not-allowed'\n                    : 'border-white/10 bg-white/[0.02] text-zinc-500 cursor-not-allowed'\n                  : isLight\n                    ? 'border-black/20 bg-white hover:bg-zinc-100 text-zinc-900'\n                    : 'border-white/20 bg-black/20 hover:bg-black/30 text-white'\n                  }`}\n              >\n                <div className=\"text-sm font-semibold\">{a.title}</div>\n                <div className={`mt-0.5 text-xs ${isLight ? 'text-zinc-600' : 'text-zinc-300/80'}`}>{a.subtitle}</div>\n              </button>\n            ))}\n          </div>\n\n          <div className={`px-3 py-3 border-t flex items-center justify-between gap-3 ${isLight ? 'border-black/20' : 'border-white/10'}`}>\n            <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${isLight ? 'text-zinc-700' : 'text-zinc-300'}`}>BrightOS</div>\n            <div className=\"flex items-center gap-2\">\n              <button\n                onClick={onToggleTheme}\n                className={`h-9 px-3 border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${isLight ? 'border-black/20 bg-white hover:bg-zinc-100 text-zinc-900' : 'border-white/20 bg-black/20 hover:bg-black/30 text-zinc-200'\n                  }`}\n              >\n                Theme\n              </button>\n              <button\n                onClick={onLock}\n                className={`h-9 px-3 border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${isLight ? 'border-black/20 bg-white hover:bg-zinc-100 text-zinc-900' : 'border-white/20 bg-black/20 hover:bg-black/30 text-zinc-200'\n                  }`}\n              >\n                Lock\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction Taskbar({\n  now,\n  tools,\n  wins,\n  onToggle,\n  fan,\n  cpu,\n  securityPulse,\n  lockedByStuck,\n  theme,\n  onStart,\n  startOpen,\n  batteryLabel,\n  networkLabel,\n}: {\n  now: Date;\n  tools: AppId[];\n  wins: Record<WindowId, WindowState>;\n  onToggle: (id: WindowId) => void;\n  fan: number;\n  cpu: number;\n  securityPulse: boolean;\n  lockedByStuck: boolean;\n  theme: 'dark' | 'light';\n  onStart: () => void;\n  startOpen: boolean;\n  batteryLabel: string;\n  networkLabel: string;\n}) {\n  const isLight = theme === 'light';\n  const pinned = (\n    [\n      { id: 'explorer' as const, label: 'Explorer' },\n      { id: 'uninstall' as const, label: 'Apps' },\n      { id: 'registry' as const, label: 'Reg' },\n      ...tools.map((t) => ({ id: toolToWindowId(t) as WindowId, label: toolLabel(t) })),\n    ] satisfies Array<{ id: WindowId; label: string }>\n  ).filter((v, i, arr) => arr.findIndex((x) => x.id === v.id) === i);\n\n  return (\n    <div className=\"h-12 border-t border-black/40 bg-zinc-900\">\n      <div className=\"h-full px-3 flex items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-2\">\n          <button\n            onClick={onStart}\n            className={`h-9 px-3 border text-[11px] font-semibold tracking-wide transition-colors ${startOpen\n              ? 'border-[var(--brand-primary)]/50 bg-[var(--brand-primary)]/20 text-white'\n              : 'border-white/20 bg-black/10 hover:bg-black/20 text-zinc-100'\n              }`}\n            aria-label=\"Start\"\n          >\n            Start\n          </button>\n        </div>\n\n        <div className=\"flex items-center gap-1 flex-1\">\n          {pinned.map((a) => {\n            const w = wins[a.id];\n            const active = w?.open && !w?.minimized;\n            return (\n              <button\n                key={a.id}\n                onClick={() => onToggle(a.id)}\n                className={`h-9 px-3 border text-[11px] font-semibold transition-colors ${active\n                  ? 'border-[var(--brand-primary)]/50 bg-[var(--brand-primary)]/20 text-white'\n                  : 'border-white/20 bg-black/10 hover:bg-black/20 text-zinc-100'\n                  }`}\n              >\n                {a.label}\n              </button>\n            );\n          })}\n        </div>\n\n        <div className=\"flex items-center gap-3\">\n          <div className={`h-2 w-2 rounded-full ${securityPulse ? 'bg-red-400' : 'bg-emerald-400'}`} />\n          <div className=\"text-[11px] text-zinc-100\">{networkLabel}</div>\n          <div className=\"text-[11px] text-zinc-100\">{batteryLabel}</div>\n          <div className=\"text-[11px] text-zinc-100\">CPU {Math.round(cpu)}%</div>\n          <div className=\"text-[11px] text-zinc-300\">FAN {fan}</div>\n          <div className=\"text-[11px] text-zinc-100\">{formatTime(now)}</div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction Window({\n  win,\n  active,\n  onDownMove,\n  onDownResize,\n  onFocus,\n  onClose,\n  theme,\n  children,\n}: {\n  win: WindowState;\n  active: boolean;\n  onDownMove: (e: React.MouseEvent) => void;\n  onDownResize: (e: React.MouseEvent) => void;\n  onFocus: () => void;\n  onClose: () => void;\n  theme: 'dark' | 'light';\n  children: ReactNode;\n}) {\n  const isLight = theme === 'light';\n  if (!win.open || win.minimized) return null;\n\n  return (\n    <motion.div\n      initial={{ scale: 0.95, opacity: 0 }}\n      animate={{ scale: 1, opacity: 1 }}\n      onMouseDown={onFocus}\n      style={{\n        left: win.x,\n        top: win.y,\n        width: win.w,\n        height: win.h,\n        zIndex: active ? 100 : 50,\n      }}\n      className={`absolute flex flex-col overflow-hidden rounded-[1.25rem] shadow-[0_24px_64px_rgba(0,0,0,0.4)] border transition-shadow duration-300 ${isLight\n        ? 'bg-white/80 backdrop-blur-3xl border-white/40 ring-1 ring-black/5'\n        : 'bg-zinc-900/80 backdrop-blur-3xl border-white/10 ring-1 ring-white/5'\n        } ${active ? 'shadow-[0_32px_80px_rgba(0,0,0,0.6)]' : ''}`}\n    >\n      {/* Title Bar */}\n      <div\n        onMouseDown={onDownMove}\n        className={`h-11 flex items-center justify-between px-5 select-none ${isLight ? 'bg-white/40' : 'bg-black/20'}`}\n      >\n        <div className=\"flex items-center gap-3\">\n          <span className=\"text-lg\">{win.id === 'terminal' ? 'üêö' : win.id === 'taskmgr' ? 'üìä' : win.id === 'settings' ? '‚öôÔ∏è' : 'üìÅ'}</span>\n          <div className={`text-[11px] font-black uppercase tracking-[0.15em] ${isLight ? 'text-zinc-900/60' : 'text-white/40'}`}>{win.title}</div>\n        </div>\n        <div className=\"flex items-center\">\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onClose();\n            }}\n            className=\"w-10 h-7 flex items-center justify-center rounded-lg hover:bg-red-500 hover:text-white transition-all text-xs opacity-60 hover:opacity-100\"\n          >\n            ‚úï\n          </button>\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-hidden relative\">\n        {children}\n      </div>\n\n      {/* Resize Handle */}\n      <div\n        onMouseDown={(e) => {\n          e.stopPropagation();\n          onDownResize(e);\n        }}\n        className=\"absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize z-50\"\n      >\n        <div className=\"absolute bottom-1 right-1 w-2 h-2 border-r-2 border-b-2 border-white/10 rounded-br-sm\" />\n      </div>\n    </motion.div>\n  );\n}\n\nfunction Terminal({\n  mission,\n  state,\n  fsEntries,\n  onFsEntries,\n  lines,\n  input,\n  setInput,\n  push,\n  onState,\n}: {\n  mission: BrightOSMission;\n  state: RuntimeState;\n  fsEntries: string[];\n  onFsEntries: (fn: (prev: string[]) => string[]) => void;\n  lines: TerminalLine[];\n  input: string;\n  setInput: (v: string) => void;\n  push: (l: TerminalLine[]) => void;\n  onState: (fn: (p: RuntimeState) => RuntimeState) => void;\n}) {\n  const scrollRef = useRef<HTMLDivElement | null>(null);\n  const [sessionId, setSessionId] = useState<number>(100);\n\n  useEffect(() => {\n    setSessionId(Math.floor(Math.random() * 1000));\n  }, []);\n\n  useEffect(() => {\n    scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });\n  }, [lines.length]);\n\n  function run(raw: string) {\n    const cmd = raw.trim();\n    if (!cmd) return;\n    push([{ id: uid('in'), kind: 'in', text: cmd }]);\n\n    const setTermMeta = (out: string, mut?: (p: RuntimeState) => RuntimeState) => {\n      onState((p) => {\n        const next = mut ? mut(p) : p;\n        return {\n          ...next,\n          terminal: {\n            ...next.terminal,\n            history: [...next.terminal.history, cmd],\n            last_command: cmd,\n            last_output: out,\n          },\n        };\n      });\n    };\n\n    const low = cmd.toLowerCase();\n\n    if (low === 'help') {\n      const out = 'Commands: dir, ipconfig /renew, ping google.com, tracert google.com, netstat -ano, tasklist, type <file>, del <file>, force-delete <file>, ftp upload <file>, apps, reg get/set/delete';\n      push([{ id: uid('o'), kind: 'out', text: out }]);\n      setTermMeta(out);\n      return;\n    }\n\n    if (low === 'clear') {\n      push([{ id: uid('sys'), kind: 'sys', text: 'Terminal cleared.' }]);\n      return;\n    }\n\n    if (low === 'dir') {\n      const items = fsEntries;\n      const header = ` Directory of C:/`;\n      const rows = items.slice(0, 60).map((p) => ` ${p}`);\n      const out = [header, ...rows].join('\\n');\n      push([\n        { id: uid('o'), kind: 'out', text: header },\n        ...rows.map((t) => ({ id: uid('o'), kind: 'out' as const, text: t })),\n      ]);\n      setTermMeta(out);\n      return;\n    }\n\n    if (low === 'ipconfig /renew') {\n      const out = ['Windows IP Configuration', 'Renewing adapter‚Ä¶ OK', 'IPv4 Address. . . . . . . . . . . : 192.168.0.101'].join('\\n');\n      push([\n        { id: uid('o'), kind: 'out', text: 'Windows IP Configuration' },\n        { id: uid('o'), kind: 'out', text: 'Renewing adapter‚Ä¶ OK' },\n      ]);\n      setTermMeta(out, (p) => ({ ...p, network: { ...p.network, status: 'Connected', ip_renewed: true, ip: '192.168.0.101' } }));\n      return;\n    }\n\n    if (low === 'netstat -ano') {\n      const suspicious = state.network.suspicious_connection.active;\n      const header = 'Proto  Local Address          Foreign Address        State           PID';\n      const row1 = suspicious\n        ? 'TCP    192.168.1.101:51322    203.0.113.66:4444       ESTABLISHED     1104   *FLAGGED*'\n        : 'TCP    192.168.1.101:51322    13.107.6.171:443       ESTABLISHED     1104';\n      const out = [header, row1].join('\\n');\n      push([\n        { id: uid('o'), kind: 'out', text: header },\n        { id: uid('o'), kind: 'out', text: row1 },\n      ]);\n      setTermMeta(out);\n      return;\n    }\n\n    if (low === 'tracert google.com') {\n      const header = 'Tracing route to google.com over a maximum of 30 hops:';\n      const hop = state.network.status === 'Slow' ? 3 : 1;\n      const out = [header, `Hop ${hop}: * * * Request timed out.`].join('\\n');\n      push([{ id: uid('o'), kind: 'out', text: header }, { id: uid('o'), kind: 'out', text: `Hop ${hop}: * * * Request timed out.` }]);\n      setTermMeta(out, (p) => ({ ...p, trace: { ...p.trace, loss_hop_index: hop } }));\n      return;\n    }\n\n    if (low === 'ping google.com') {\n      const loss = state.network.status === 'Disconnected' ? 100 : state.network.status === 'Slow' ? 50 : 0;\n      const out = loss === 100 ? 'Request timed out. (4/4 lost)' : loss === 50 ? 'Packets: Sent=4 Received=2 Lost=2 (50% loss)' : 'Packets: Sent=4 Received=4 Lost=0 (0% loss)';\n      push([{ id: uid('o'), kind: 'out', text: out }]);\n      setTermMeta(out, (p) => ({ ...p, ping: { ...p.ping, packet_loss_percent: loss } }));\n      return;\n    }\n\n    if (low === 'tasklist') {\n      const header = 'Image Name                     PID   Session Name        Mem Usage';\n      const row = state.network.suspicious_connection.active\n        ? 'stealth_conn.exe               1104  Console             12,512 K   *FLAGGED*'\n        : 'explorer.exe                   1400  Console             42,120 K';\n      const out = [header, row].join('\\n');\n      push([{ id: uid('o'), kind: 'out', text: header }, { id: uid('o'), kind: 'out', text: row }]);\n      setTermMeta(out, (p) => ({ ...p, incident: { ...p.incident, pid_identified: true } }));\n      return;\n    }\n\n    if (low.startsWith('type ')) {\n      const target = cmd.slice(5).trim();\n      if (target.toLowerCase().endsWith('access.log')) {\n        const ts = '2026-01-27T03:12:44Z';\n        const out = `... FAILED LOGIN ... ${ts} ...`;\n        push([{ id: uid('o'), kind: 'out', text: out }]);\n        setTermMeta(out, (p) => ({ ...p, forensics: { ...p.forensics, bruteforce_timestamp: ts } }));\n        return;\n      }\n      const out = `Cannot open ${target}`;\n      push([{ id: uid('o'), kind: 'out', text: out }]);\n      setTermMeta(out);\n      return;\n    }\n\n    if (low.startsWith('ftp upload')) {\n      const target = cmd.slice('ftp upload'.length).trim().replace(/^\"|\"$/g, '');\n      const base = normPath(target).split('/').pop() || target;\n      const out = `Uploading ${base}... OK`;\n      push([{ id: uid('o'), kind: 'out', text: out }]);\n      setTermMeta(out, (p) => ({ ...p, ftp: { ...p.ftp, uploaded: Array.from(new Set([...(p.ftp.uploaded || []), base])) } }));\n      return;\n    }\n\n    if (low.startsWith('del ') || low.startsWith('delete ') || low.startsWith('force-delete ')) {\n      const target = cmd\n        .replace(/^del\\s+/i, '')\n        .replace(/^delete\\s+/i, '')\n        .replace(/^force-delete\\s+/i, '')\n        .trim();\n      const norm = normPath(target);\n      onFsEntries((prev) => prev.map(normPath).filter((p) => p !== norm && !p.endsWith(`/${norm}`) && !p.endsWith(norm)));\n      const out = `Deleted: ${target}`;\n      push([{ id: uid('o'), kind: 'out', text: out }]);\n      setTermMeta(out);\n      return;\n    }\n\n    if (low === 'apps') {\n      const apps = Object.entries(state.apps);\n      push([\n        ...apps.map(([id, a]) => ({\n          id: uid('o'),\n          kind: 'out' as const,\n          text: `  ${a.installed ? '[+]' : '[ ]'} ${a.malware ? '[MALWARE]' : '[OK]'} ${a.name}`,\n        })),\n      ]);\n      onState((p) => ({ ...p, terminal: { ...p.terminal, history: [...p.terminal.history, cmd] } }));\n      return;\n    }\n\n    if (low.startsWith('apps uninstall')) {\n      const name = cmd.slice('apps uninstall'.length).trim().replace(/^[\"']|[\"']$/g, '');\n      const appEntry = Object.entries(state.apps).find(([, a]) => a.name.toLowerCase() === name.toLowerCase());\n      if (!appEntry) {\n        push([{ id: uid('o'), kind: 'out', text: `App not found: ${name}` }]);\n        return;\n      }\n      const [appId, app] = appEntry;\n      onState((p) => {\n        const newApps = { ...p.apps };\n        newApps[appId] = { ...app, installed: false };\n        const newRegistry = { ...p.registry };\n        if (app.registryKeys) app.registryKeys.forEach((k) => delete newRegistry[k]);\n        return { ...p, apps: newApps, registry: newRegistry, terminal: { ...p.terminal, history: [...p.terminal.history, cmd] } };\n      });\n      push([{ id: uid('o'), kind: 'out', text: `Uninstalled ${app.name}.` }]);\n      return;\n    }\n\n    // reg commands simplified for space\n    if (low.startsWith('reg get')) {\n      // ... existing logic ...\n    }\n\n    push([{ id: uid('o'), kind: 'out', text: 'Command not recognized.' }]);\n    setTermMeta('Command not recognized.');\n  }\n\n  return (\n    <div className=\"h-full flex flex-col bg-[#0c0c0c]/90 text-[#cccccc] font-mono selection:bg-white/20\">\n      <div className=\"flex-1 flex flex-col p-6 overflow-hidden\">\n        <div ref={scrollRef} className=\"flex-1 overflow-auto mb-4 sleek-scrollbar text-[13px] leading-relaxed\">\n          <div className=\"text-emerald-400 font-bold mb-4 opacity-60\">Terminal Session #{sessionId} - Secure Shell</div>\n          {lines.map((l) => (\n            <div\n              key={l.id}\n              className={`mb-1.5 animate-in fade-in slide-in-from-left-1 duration-200 ${l.kind === 'in' ? 'text-blue-400 font-bold' :\n                l.kind === 'sys' ? 'text-white/30 italic font-sans text-xs' :\n                  'text-white/90'\n                }`}\n            >\n              {l.kind === 'in' && <span className=\"mr-2\">C:\\&gt;</span>}\n              {l.text}\n            </div>\n          ))}\n        </div>\n\n        <div className=\"flex items-center gap-3 bg-white/5 border border-white/10 rounded-xl px-4 h-12 focus-within:border-[var(--brand-primary)]/50 transition-all shadow-inner\">\n          <span className=\"text-[var(--brand-primary)] text-sm font-black\">&gt;</span>\n          <input\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            onKeyDown={(e) => {\n              if (e.key === 'Enter') {\n                const v = input;\n                setInput('');\n                run(v);\n              }\n            }}\n            placeholder=\"Type command here...\"\n            className=\"flex-1 bg-transparent text-[13px] text-white outline-none caret-[var(--brand-primary)]\"\n            autoFocus\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction TaskManager({ state, onEndHighCpu }: { state: RuntimeState; onEndHighCpu: () => void }) {\n  const rows = useMemo(() => {\n    type ProcRow = { pid: number; name: string; cpu: number; kind: 'system' | 'user' | 'malware' };\n\n    const base: ProcRow[] = [\n      { pid: 120, name: 'kernel_task', cpu: 3, kind: 'system' },\n      { pid: 221, name: 'shell_ui', cpu: 5, kind: 'system' },\n      { pid: 304, name: 'brightos_cloud_sync', cpu: 2, kind: 'system' },\n      { pid: 388, name: 'coupon_tray', cpu: 1, kind: 'user' },\n      { pid: 420, name: 'game_bar_overlay', cpu: 1, kind: 'user' },\n      { pid: 512, name: 'auto_updater', cpu: 2, kind: 'system' },\n      { pid: 603, name: 'search_indexer', cpu: 3, kind: 'system' },\n    ];\n\n    const appProcs: ProcRow[] = Object.values(state.apps)\n      .filter((a) => a.installed && a.process)\n      .slice(0, 18)\n      .map((a, idx) => ({\n        pid: 900 + idx,\n        name: a.process as string,\n        cpu: a.malware ? 2 : 1,\n        kind: a.malware ? 'malware' : 'user',\n      }));\n\n    const cpuNoise = Math.max(0, Math.round((state.cpu_load - 10) / 20));\n    const noisy: ProcRow[] = base.concat(appProcs).map((r) => {\n      if (r.pid === 120) return r;\n      if (r.pid === 221) return { ...r, cpu: clamp(r.cpu + cpuNoise, 1, 18) };\n      return { ...r, cpu: clamp(r.cpu + Math.floor(cpuNoise / 2), 0, 12) };\n    });\n\n    if (state.process.high_cpu.running) {\n      noisy.unshift({ pid: 777, name: 'mystery_app.exe', cpu: Math.round(state.cpu_load), kind: 'malware' });\n    }\n    return noisy.sort((a, b) => b.cpu - a.cpu);\n  }, [state.apps, state.cpu_load, state.process.high_cpu.running]);\n\n  return (\n    <div>\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Processes</div>\n      <div className=\"mt-3 rounded-2xl border border-white/10 bg-black/30 overflow-hidden\">\n        <div className=\"grid grid-cols-[1fr_120px_120px] gap-2 px-4 py-3 border-b border-white/10 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">\n          <div>Name</div>\n          <div>CPU</div>\n          <div>Action</div>\n        </div>\n        {rows.map((r) => (\n          <div\n            key={r.pid}\n            className={`grid grid-cols-[1fr_120px_120px] gap-2 px-4 py-3 border-b border-white/5 text-sm text-zinc-200 ${r.kind === 'malware' ? 'bg-red-500/5' : ''\n              }`}\n          >\n            <div className=\"font-mono\">\n              {r.name}{' '}\n              {r.kind === 'malware' ? <span className=\"text-red-200\">(suspicious)</span> : null}\n            </div>\n            <div className=\"font-mono\">{r.cpu}%</div>\n            <div>\n              {r.pid === 777 ? (\n                <button\n                  onClick={onEndHighCpu}\n                  className=\"h-9 px-3 rounded-xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100\"\n                >\n                  End Task\n                </button>\n              ) : (\n                <div className=\"text-xs text-zinc-500\">‚Äî</div>\n              )}\n            </div>\n          </div>\n        ))}\n      </div>\n\n      <div className=\"mt-3 text-xs text-zinc-400\">\n        CPU Load: <span className=\"text-zinc-200 font-semibold\">{Math.round(state.cpu_load)}%</span>\n      </div>\n    </div>\n  );\n}\n\nfunction Settings({\n  mission,\n  state,\n  onCleanTmp,\n  onEmptyRecycle,\n  theme,\n  onToggleTheme,\n  onState,\n  onNotify,\n  onOpenWindow,\n}: {\n  mission: BrightOSMission;\n  state: RuntimeState;\n  onCleanTmp: () => void;\n  onEmptyRecycle: () => void;\n  theme: 'dark' | 'light';\n  onToggleTheme: () => void;\n  onState: (fn: (p: RuntimeState) => RuntimeState) => void;\n  onNotify: (kind: 'alert' | 'info', title: string, body: string) => void;\n  onOpenWindow: (id: WindowId) => void;\n}) {\n  const wantsResolution = mission.success_condition.includes('display.resolution');\n  const wantsPower = mission.success_condition.includes('power.screen_off_minutes_on_battery');\n  const wantsFilterKeys = mission.success_condition.includes('keyboard.filter_keys.enabled');\n  const wantsSpecs = mission.success_condition.includes('specs.checked');\n  const wantsPartition = mission.success_condition.includes('disk.volumes');\n  const wantsRestore = mission.success_condition.includes('system.restore.');\n  const wantsPasswordReset = mission.success_condition.includes('account.user.password_reset');\n  const wantsPrinter = mission.success_condition.includes('printer.queue.count') || mission.success_condition.includes('printer.ip') || mission.success_condition.includes('printer.reachable');\n  const wantsDns = mission.success_condition.includes('network.dns');\n  const wantsThreats = mission.success_condition.includes('defend.threats');\n  const wantsFirewall = mission.success_condition.includes('firewall.inbound');\n  const wantsRam = mission.success_condition.includes('hardware.ram_gb');\n\n  return (\n    <div>\n      <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Storage</div>\n      <div className=\"mt-3 grid gap-3\">\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Disk Free Space</div>\n          <div className=\"mt-1 text-2xl font-black text-[var(--brand-primary)]\">{state.disk.free_space_mb} MB</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">\n            Temp files: <span className=\"text-zinc-200 font-semibold\">{state.files.tmp.count}</span> ‚Ä¢ Recycle Bin:\n            <span className=\"text-zinc-200 font-semibold\"> {state.recycle_bin.empty ? 'Empty' : 'Not Empty'}</span>\n          </div>\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Cleanup</div>\n          <div className=\"mt-3 flex flex-wrap gap-2\">\n            <button\n              onClick={onCleanTmp}\n              disabled={state.files.tmp.count === 0}\n              className={`h-10 px-4 rounded-2xl border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${state.files.tmp.count === 0\n                ? 'border-white/10 bg-white/[0.03] text-zinc-500'\n                : 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-white'\n                }`}\n            >\n              Delete .tmp\n            </button>\n            <button\n              onClick={onEmptyRecycle}\n              disabled={state.recycle_bin.empty}\n              className={`h-10 px-4 rounded-2xl border text-[10px] font-black uppercase tracking-[0.25em] transition-colors ${state.recycle_bin.empty\n                ? 'border-white/10 bg-white/[0.03] text-zinc-500'\n                : 'border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-white'\n                }`}\n            >\n              Empty Recycle\n            </button>\n          </div>\n        </div>\n\n        <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n          <div className=\"text-sm font-black text-white\">Appearance</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">\n            Theme: <span className=\"text-zinc-200 font-semibold\">{theme === 'light' ? 'Light' : 'Dark'}</span>\n          </div>\n          <div className=\"mt-3 flex flex-wrap gap-2\">\n            <button\n              onClick={onToggleTheme}\n              className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] transition-colors text-white\"\n            >\n              Toggle Theme\n            </button>\n          </div>\n        </div>\n\n        {(wantsResolution || wantsPower || wantsFilterKeys || wantsSpecs || wantsPartition || wantsRestore || wantsPasswordReset || wantsPrinter || wantsDns || wantsThreats || wantsFirewall || wantsRam || mission.id === 'tech-5') && (\n          <div className=\"rounded-2xl border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-black text-white\">System Tools</div>\n            <div className=\"mt-2 text-xs text-zinc-400\">Quick actions for this mission.</div>\n\n            <div className=\"mt-4 grid gap-3\">\n              {(mission.id === 'tech-5' || mission.success_condition.includes('device.audio.driver_status') || mission.success_condition.includes('audio.output')) && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Device Manager</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Audio output: <span className=\"font-mono\">{String(state.audio.output)}</span> ‚Ä¢ Driver: <span className=\"font-mono\">{state.device.audio.driver_status}</span></div>\n                  <button\n                    onClick={() => onOpenWindow('devmgr')}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Open Device Manager\n                  </button>\n                </div>\n              )}\n\n              {wantsResolution && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Display</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Resolution: <span className=\"font-mono\">{state.display.resolution}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, display: { resolution: '1920x1080' } }));\n                      onNotify('info', 'SETTINGS', 'Display resolution updated to 1920x1080.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Set 1920x1080\n                  </button>\n                </div>\n              )}\n\n              {wantsPower && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Power</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Screen off (battery): <span className=\"font-mono\">{state.power_settings.screen_off_minutes_on_battery} min</span></div>\n                  <div className=\"mt-3 flex flex-wrap gap-2\">\n                    <button\n                      onClick={() => {\n                        onState((p) => ({ ...p, power_settings: { screen_off_minutes_on_battery: 2 } }));\n                        onNotify('info', 'SETTINGS', 'Battery screen-off set to 2 minutes.');\n                      }}\n                      className=\"h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                    >\n                      2 min\n                    </button>\n                    <button\n                      onClick={() => {\n                        onState((p) => ({ ...p, power_settings: { screen_off_minutes_on_battery: 5 } }));\n                        onNotify('info', 'SETTINGS', 'Battery screen-off set to 5 minutes.');\n                      }}\n                      className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                    >\n                      5 min\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {wantsFilterKeys && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Accessibility</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Filter Keys: <span className=\"font-mono\">{String(state.keyboard.filter_keys.enabled)}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, keyboard: { filter_keys: { enabled: true } } }));\n                      onNotify('info', 'SETTINGS', 'Filter Keys enabled.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Enable Filter Keys\n                  </button>\n                </div>\n              )}\n\n              {wantsSpecs && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">System Info</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Specs checked: <span className=\"font-mono\">{String(state.specs.checked)}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, specs: { checked: true } }));\n                      onNotify('info', 'SETTINGS', 'System requirements checked.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Mark Checked\n                  </button>\n                </div>\n              )}\n\n              {wantsPartition && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Disk Management</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Volumes: <span className=\"font-mono\">{state.disk.volumes.join(', ')}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => {\n                        const next = Array.from(new Set([...(p.disk.volumes || []), 'D:']));\n                        return { ...p, disk: { ...p.disk, volumes: next } };\n                      });\n                      onNotify('info', 'SETTINGS', 'Created volume D:.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Create D: Volume\n                  </button>\n                </div>\n              )}\n\n              {wantsRestore && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Recovery</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Restore completed: <span className=\"font-mono\">{String(state.system.restore.completed)}</span> ‚Ä¢ Crash rate: <span className=\"font-mono\">{state.system.crash_rate}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, system: { restore: { completed: true }, crash_rate: 0 } }));\n                      onNotify('info', 'SETTINGS', 'System Restore completed.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Run System Restore\n                  </button>\n                </div>\n              )}\n\n              {wantsPasswordReset && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Accounts</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Password reset: <span className=\"font-mono\">{String(state.account.user.password_reset)}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, account: { user: { password_reset: true } } }));\n                      onNotify('info', 'SETTINGS', 'User password reset completed.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Reset Password\n                  </button>\n                </div>\n              )}\n\n              {wantsPrinter && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Printers</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Queue: <span className=\"font-mono\">{state.printer.queue.count}</span> ‚Ä¢ IP: <span className=\"font-mono\">{state.printer.ip}</span> ‚Ä¢ Reachable: <span className=\"font-mono\">{String(state.printer.reachable)}</span></div>\n                  <div className=\"mt-3 flex flex-wrap gap-2\">\n                    <button\n                      onClick={() => {\n                        onState((p) => ({ ...p, printer: { ...p.printer, queue: { count: 0 } } }));\n                        onNotify('info', 'PRINTER', 'All print jobs cancelled.');\n                      }}\n                      className=\"h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                    >\n                      Clear Queue\n                    </button>\n                    <button\n                      onClick={() => {\n                        onState((p) => ({ ...p, printer: { ...p.printer, ip: '192.168.0.50', reachable: true } }));\n                        onNotify('info', 'PRINTER', 'Printer configured and reachable.');\n                      }}\n                      className=\"h-10 px-4 rounded-2xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                    >\n                      Set IP 192.168.0.50\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {wantsDns && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Network</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">DNS: <span className=\"font-mono\">{state.network.dns.primary}</span> ‚Ä¢ Status: <span className=\"font-mono\">{state.network.status}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, network: { ...p.network, status: 'Connected', dns: { primary: '8.8.8.8' } } }));\n                      onNotify('info', 'NETWORK', 'DNS set to 8.8.8.8.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Set DNS 8.8.8.8\n                  </button>\n                </div>\n              )}\n\n              {wantsThreats && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Defend</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Active threats: <span className=\"font-mono\">{state.defend.threats.active}</span> ‚Ä¢ Quarantined: <span className=\"font-mono\">{state.defend.threats.quarantined}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({\n                        ...p,\n                        defend: { threats: { active: 0, quarantined: Math.max(1, p.defend.threats.quarantined + Math.max(1, p.defend.threats.active)) } },\n                      }));\n                      onNotify('info', 'DEFEND', 'Deep scan complete. Threats quarantined.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100 transition-colors\"\n                  >\n                    Deep Scan & Quarantine\n                  </button>\n                </div>\n              )}\n\n              {wantsFirewall && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Firewall</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">Blocked inbound ports: <span className=\"font-mono\">{(state.firewall.inbound.blocked_ports || []).join(', ') || 'none'}</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({\n                        ...p,\n                        firewall: {\n                          inbound: {\n                            blocked_ports: Array.from(new Set([...(p.firewall.inbound.blocked_ports || []), 23])),\n                          },\n                        },\n                      }));\n                      onNotify('info', 'FIREWALL', 'Blocked inbound port 23.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/15 text-[10px] font-black uppercase tracking-[0.25em] text-red-100 transition-colors\"\n                  >\n                    Block Port 23\n                  </button>\n                </div>\n              )}\n\n              {wantsRam && (\n                <div className=\"rounded-2xl border border-white/10 bg-black/20 p-4\">\n                  <div className=\"text-xs font-black uppercase tracking-[0.25em] text-zinc-400\">Hardware</div>\n                  <div className=\"mt-2 text-sm text-zinc-200\">RAM: <span className=\"font-mono\">{state.hardware.ram_gb}GB</span></div>\n                  <button\n                    onClick={() => {\n                      onState((p) => ({ ...p, hardware: { ram_gb: 8 } }));\n                      onNotify('info', 'HARDWARE', 'Installed 8GB RAM module.');\n                    }}\n                    className=\"mt-3 h-10 px-4 rounded-2xl border border-[var(--brand-primary)]/30 bg-[var(--brand-primary)]/15 hover:bg-[var(--brand-primary)]/25 text-[10px] font-black uppercase tracking-[0.25em] text-white transition-colors\"\n                  >\n                    Install 8GB RAM\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction FileExplorer({\n  entries,\n  location,\n  onSetLocation,\n  onOpen,\n  onDeleteToRecycle,\n  onEmptyRecycle,\n  onCopyToDrive,\n  onZipFolder,\n  onEncryptFolder,\n  theme,\n}: {\n  entries: string[];\n  location: 'pc' | 'recycle';\n  onSetLocation: (v: 'pc' | 'recycle') => void;\n  onOpen: (path: string) => void;\n  onDeleteToRecycle: (path: string) => void;\n  onEmptyRecycle: () => void;\n  onCopyToDrive: (path: string, drive: 'D' | 'E') => void;\n  onZipFolder: (path: string) => void;\n  onEncryptFolder: (path: string) => void;\n  theme: 'dark' | 'light';\n}) {\n  const [selected, setSelected] = useState<string | null>(null);\n  const [currentPath, setCurrentPath] = useState('C:/');\n  const isLight = theme === 'light';\n\n  useEffect(() => {\n    if (location === 'recycle') {\n      setCurrentPath('RecycleBin:/');\n      return;\n    }\n    setCurrentPath((prev) => (prev.startsWith('C:/') || prev.startsWith('D:/') ? prev : 'C:/'));\n  }, [location]);\n\n  const normalized = useMemo(() => entries.map(normPath).sort((a, b) => a.localeCompare(b)), [entries]);\n  const driveRoots = useMemo(() => {\n    const roots = new Set<string>();\n    normalized.forEach((entry) => {\n      const match = entry.match(/^([A-Z]:\\/|[A-Z]:\\/?)/i);\n      if (match) roots.add(match[1].replace(/\\\\/g, '/').replace(/\\/?$/, '/'));\n    });\n    return Array.from(roots).sort();\n  }, [normalized]);\n\n  const listItems = useMemo(() => {\n    if (currentPath === 'ThisPC') {\n      return driveRoots.map((drive) => ({\n        path: drive,\n        name: drive.replace('/', ''),\n        type: 'drive' as const,\n      }));\n    }\n    const base = normPath(currentPath);\n    const prefix = base.endsWith('/') ? base : `${base}/`;\n    const children = new Map<string, { path: string; name: string; type: 'folder' | 'file' }>();\n\n    normalized.forEach((entry) => {\n      if (!entry.startsWith(prefix)) return;\n      const rest = entry.slice(prefix.length);\n      if (!rest) return;\n      const [first] = rest.split('/');\n      const isFolder = rest.includes('/');\n      const childPath = `${prefix}${first}${isFolder ? '/' : ''}`;\n      children.set(childPath, { path: childPath, name: first, type: isFolder ? 'folder' : 'file' });\n    });\n\n    return Array.from(children.values()).sort((a, b) => a.name.localeCompare(b.name));\n  }, [currentPath, driveRoots, normalized]);\n\n  const crumbs = useMemo(() => {\n    if (currentPath === 'ThisPC') return ['This PC'];\n    const parts = normPath(currentPath).replace(/\\/+$/, '').split('/');\n    const out: string[] = [];\n    for (let i = 0; i < parts.length; i += 1) {\n      if (!parts[i]) continue;\n      const val = parts[i];\n      out.push(i === 0 ? `${val}/` : val);\n    }\n    return out.length ? out : ['This PC'];\n  }, [currentPath]);\n\n  return (\n    <div className=\"h-full grid grid-cols-[240px_1fr] gap-4\">\n      <div className={`rounded-2xl border p-3 ${isLight ? 'border-black/10 bg-white/70' : 'border-white/10 bg-black/30'}`}>\n        <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${isLight ? 'text-zinc-600' : 'text-zinc-400'}`}>Quick Access</div>\n        <div className=\"mt-3 grid gap-2\">\n          <button\n            onClick={() => {\n              setSelected(null);\n              onSetLocation('pc');\n              setCurrentPath('ThisPC');\n            }}\n            className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left ${isLight\n              ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n              : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n              }`}\n          >\n            This PC\n          </button>\n          <button\n            onClick={() => {\n              setSelected(null);\n              onSetLocation('recycle');\n            }}\n            className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left ${isLight\n              ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n              : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n              }`}\n          >\n            Recycle Bin\n          </button>\n        </div>\n\n        <div className=\"mt-6\">\n          <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${isLight ? 'text-zinc-600' : 'text-zinc-400'}`}>This PC</div>\n          <div className=\"mt-3 grid gap-2\">\n            {driveRoots.length === 0 && (\n              <div className={`text-xs ${isLight ? 'text-zinc-500' : 'text-zinc-400'}`}>No drives found.</div>\n            )}\n            {driveRoots.map((drive) => (\n              <button\n                key={drive}\n                onClick={() => {\n                  setSelected(null);\n                  onSetLocation('pc');\n                  setCurrentPath(drive);\n                }}\n                className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left ${isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                  }`}\n              >\n                {drive}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"mt-6\">\n          <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${isLight ? 'text-zinc-600' : 'text-zinc-400'}`}>Actions</div>\n          <div className=\"mt-3 grid gap-2\">\n            <button\n              onClick={() => {\n                if (!selected) return;\n                onDeleteToRecycle(selected);\n                setSelected(null);\n              }}\n              disabled={!selected || location === 'recycle'}\n              className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left transition-colors ${!selected || location === 'recycle'\n                ? isLight\n                  ? 'border-black/10 bg-black/[0.02] text-zinc-500'\n                  : 'border-white/10 bg-white/[0.02] text-zinc-500'\n                : isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                }`}\n            >\n              Delete\n            </button>\n            <button\n              onClick={() => {\n                if (!selected) return;\n                onZipFolder(selected);\n              }}\n              disabled={!selected}\n              className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left transition-colors ${!selected\n                ? isLight\n                  ? 'border-black/10 bg-black/[0.02] text-zinc-500'\n                  : 'border-white/10 bg-white/[0.02] text-zinc-500'\n                : isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                }`}\n            >\n              Zip\n            </button>\n            <button\n              onClick={() => {\n                if (!selected) return;\n                onCopyToDrive(selected, 'E');\n              }}\n              disabled={!selected}\n              className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left transition-colors ${!selected\n                ? isLight\n                  ? 'border-black/10 bg-black/[0.02] text-zinc-500'\n                  : 'border-white/10 bg-white/[0.02] text-zinc-500'\n                : isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                }`}\n            >\n              Copy to E:\n            </button>\n            <button\n              onClick={() => {\n                if (!selected) return;\n                onEncryptFolder(selected);\n              }}\n              disabled={!selected}\n              className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left transition-colors ${!selected\n                ? isLight\n                  ? 'border-black/10 bg-black/[0.02] text-zinc-500'\n                  : 'border-white/10 bg-white/[0.02] text-zinc-500'\n                : isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                }`}\n            >\n              Encrypt\n            </button>\n            <button\n              onClick={() => {\n                if (location !== 'recycle') return;\n                onEmptyRecycle();\n                setSelected(null);\n              }}\n              disabled={location !== 'recycle'}\n              className={`h-10 px-3 rounded-2xl border text-xs font-bold text-left transition-colors ${location !== 'recycle'\n                ? isLight\n                  ? 'border-black/10 bg-black/[0.02] text-zinc-500'\n                  : 'border-white/10 bg-white/[0.02] text-zinc-500'\n                : isLight\n                  ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-900'\n                  : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-white'\n                }`}\n            >\n              Empty Bin\n            </button>\n          </div>\n        </div>\n      </div>\n\n      <div className={`rounded-2xl border overflow-hidden ${isLight ? 'border-black/10 bg-white/70' : 'border-white/10 bg-black/30'}`}>\n        <div className={`px-4 py-3 border-b ${isLight ? 'border-black/10' : 'border-white/10'}`}>\n          <div className=\"flex flex-wrap items-center gap-2\">\n            <div className={`text-[10px] font-black uppercase tracking-[0.25em] ${isLight ? 'text-zinc-600' : 'text-zinc-400'}`}>Address</div>\n            <div className={`flex-1 rounded-xl border px-3 py-1.5 text-xs ${isLight ? 'border-black/10 bg-white/70 text-zinc-800' : 'border-white/10 bg-black/30 text-zinc-200'}`}>\n              {crumbs.join(' / ')}\n            </div>\n            <button\n              onClick={() => {\n                if (currentPath === 'ThisPC') return;\n                const parts = normPath(currentPath).replace(/\\/+$/, '').split('/');\n                if (parts.length <= 1) {\n                  setCurrentPath('ThisPC');\n                  return;\n                }\n                parts.pop();\n                setCurrentPath(parts.join('/') + '/');\n              }}\n              className={`h-8 px-3 rounded-xl border text-[10px] font-black uppercase tracking-[0.25em] ${isLight\n                ? 'border-black/10 bg-black/[0.03] hover:bg-black/[0.06] text-zinc-800'\n                : 'border-white/10 bg-white/[0.03] hover:bg-white/[0.06] text-zinc-200'\n                }`}\n            >\n              Up\n            </button>\n          </div>\n        </div>\n\n        <div className=\"h-[360px] overflow-auto\">\n          {listItems.length === 0 ? (\n            <div className={`p-4 text-sm ${isLight ? 'text-zinc-500' : 'text-zinc-400'}`}>No items.</div>\n          ) : (\n            listItems.slice(0, 250).map((item) => (\n              <button\n                key={item.path}\n                onClick={() => setSelected(item.path)}\n                onDoubleClick={() => {\n                  if (item.type === 'drive' || item.type === 'folder') {\n                    setCurrentPath(item.path);\n                    onSetLocation(item.path.startsWith('RecycleBin:/') ? 'recycle' : 'pc');\n                    return;\n                  }\n                  onOpen(item.path);\n                }}\n                className={`w-full px-4 py-3 border-b text-left text-sm transition-colors ${isLight ? 'border-black/5' : 'border-white/5'\n                  } ${selected === item.path ? (isLight ? 'bg-black/[0.06]' : 'bg-white/[0.06]') : isLight ? 'hover:bg-black/[0.04]' : 'hover:bg-white/[0.04]'}`}\n              >\n                <div className={`font-semibold ${isLight ? 'text-zinc-900' : 'text-zinc-200'}`}>\n                  {item.type === 'drive' ? 'üñ¥' : item.type === 'folder' ? 'üìÅ' : 'üìÑ'} {item.name}\n                </div>\n                <div className={`text-xs ${isLight ? 'text-zinc-500' : 'text-zinc-400'}`}>{item.path}</div>\n              </button>\n            ))\n          )}\n        </div>\n        {selected && (\n          <div className={`px-4 py-3 border-t text-xs ${isLight ? 'border-black/10 text-zinc-600' : 'border-white/10 text-zinc-400'}`}>\n            Selected: <span className={`${isLight ? 'text-zinc-800' : 'text-zinc-200'} font-mono`}>{selected}</span>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default function MissionClient({ mission }: { mission: BrightOSMission }) {\n  const router = useRouter();\n  const { user, userData } = useAuth();\n\n  const [now, setNow] = useState(() => new Date());\n  const [wallpaper, setWallpaper] = useState('');\n\n  const [cooldownUntil, setCooldownUntil] = useState<number | null>(null);\n  const cooldownRemainingMs = cooldownUntil ? Math.max(0, cooldownUntil - now.getTime()) : 0;\n  const cooldownActive = cooldownUntil !== null && cooldownRemainingMs > 0;\n  const cooldownMins = Math.floor(cooldownRemainingMs / 60000);\n  const cooldownSecs = Math.floor((cooldownRemainingMs % 60000) / 1000);\n  const cooldownLabel = `${cooldownMins}:${String(cooldownSecs).padStart(2, '0')}`;\n\n  const [state, setState] = useState<RuntimeState>(() => initRuntime(mission));\n  const [wins, setWins] = useState<Record<WindowId, WindowState>>(() => initialWindows(mission));\n  const [activeWin, setActiveWin] = useState<WindowId>(() => (mission.id === 'tech-1' ? 'stuck_app' : 'terminal'));\n\n  const [theme, setTheme] = useState<'dark' | 'light'>('dark');\n  const [fsEntries, setFsEntries] = useState<string[]>(() => mission.initial_state.file_system.map(normPath));\n  const [explorerLocation, setExplorerLocation] = useState<'pc' | 'recycle'>('pc');\n\n  const [startOpen, setStartOpen] = useState(false);\n  const [startQuery, setStartQuery] = useState('');\n\n  const [password, setPassword] = useState('');\n  const [loginBusy, setLoginBusy] = useState(false);\n  const [loginError, setLoginError] = useState<string | null>(null);\n\n  const [termLines, setTermLines] = useState<TerminalLine[]>(() => [\n    { id: uid('sys'), kind: 'sys', text: `Mission loaded: ${mission.id} ‚Äî ${mission.title}` },\n    { id: uid('sys'), kind: 'sys', text: 'Terminal: try help, dir, ipconfig /renew, tracert, netstat -ano' },\n  ]);\n  const [termInput, setTermInput] = useState('');\n\n  const [briefingAccepted, setBriefingAccepted] = useState(false);\n  const briefingStartRef = useRef<number>(Date.now());\n  const eventsStartedRef = useRef(false);\n  const eventTimersRef = useRef<number[]>([]);\n  const [inbox, setInbox] = useState<StoryEmail[]>([]);\n  const [chatMessages, setChatMessages] = useState<Array<{ from: string; text: string }>>([]);\n\n  const npcSeedRef = useRef(String(Math.random()).slice(2));\n\n  const rewardGrantedRef = useRef(false);\n  const [missionComplete, setMissionComplete] = useState(false);\n\n  const liveSessionIdRef = useRef<string | null>(null);\n  const liveSessionEndedRef = useRef(false);\n\n  const drag = useRef<{\n    id: WindowId | null;\n    mode: 'move' | 'resize' | null;\n    sx: number;\n    sy: number;\n    x: number;\n    y: number;\n    w: number;\n    h: number;\n  }>({ id: null, mode: null, sx: 0, sy: 0, x: 0, y: 0, w: 0, h: 0 });\n\n  const dragRafRef = useRef<number | null>(null);\n  const dragPosRef = useRef<{ x: number; y: number }>({ x: 0, y: 0 });\n\n  useEffect(() => {\n    setWallpaper(pickFromPool(mission.brightos_desktop.wallpaper_pool));\n    const cd = getMissionCooldown();\n    setCooldownUntil(cd?.until ?? null);\n  }, [mission.brightos_desktop.wallpaper_pool]);\n\n  useEffect(() => {\n    liveSessionEndedRef.current = false;\n    const session = startLiveSession('csec', mission.id);\n    liveSessionIdRef.current = session.id;\n\n    return () => {\n      const sid = liveSessionIdRef.current;\n      if (!sid) return;\n      if (liveSessionEndedRef.current) return;\n      endLiveSession(sid, { status: 'abandoned' });\n      liveSessionEndedRef.current = true;\n    };\n  }, [mission.id]);\n\n  useEffect(() => {\n    setTheme('dark');\n    setState(initRuntime(mission));\n    setWins(initialWindows(mission));\n    setActiveWin(mission.id === 'tech-1' ? 'stuck_app' : 'terminal');\n    setFsEntries(mission.initial_state.file_system.map(normPath));\n    setExplorerLocation('pc');\n    setStartOpen(false);\n    setStartQuery('');\n    setPassword('');\n    setLoginBusy(false);\n    setLoginError(null);\n    setBriefingAccepted(false);\n    briefingStartRef.current = Date.now();\n    eventsStartedRef.current = false;\n    npcSeedRef.current = String(Math.random()).slice(2);\n    eventTimersRef.current.forEach((t) => window.clearTimeout(t));\n    eventTimersRef.current = [];\n    setInbox([]);\n    setChatMessages([]);\n  }, [mission]);\n\n  const company = useMemo(() => {\n    const preset = mission.brightos_desktop.ui_preset;\n    if (preset === 'smallbiz_admin') return { name: 'IslandMart Ltd.', dept: 'IT / Operations', hostname: `IM-${mission.id.toUpperCase()}` };\n    if (preset === 'techfix_shop') return { name: 'TechFix Service Desk', dept: 'Repairs & Support', hostname: `TFX-${mission.id.toUpperCase()}` };\n    if (preset === 'automation_lab') return { name: 'BrightEd Automation Lab', dept: 'DevOps Training', hostname: `LAB-${mission.id.toUpperCase()}` };\n    if (preset === 'csec_soc') return { name: 'CaribSec SOC', dept: 'Security Operations', hostname: `SOC-${mission.id.toUpperCase()}` };\n    return { name: 'BrightEd Home Support', dept: 'Helpdesk', hostname: `BE-${mission.id.toUpperCase()}` };\n  }, [mission.brightos_desktop.ui_preset, mission.id]);\n\n  const story = useMemo(() => buildStoryPack(mission, company), [mission, company]);\n\n  useEffect(() => {\n    const id = window.setInterval(() => {\n      setState((p) => {\n        if (p.power !== 'booting') return p;\n        const next = (p.boot_phase + 1) as RuntimeState['boot_phase'];\n        if (next >= 5) return { ...p, power: 'lock', boot_phase: 5 };\n        return { ...p, boot_phase: next };\n      });\n    }, 850);\n    return () => window.clearInterval(id);\n  }, []);\n\n  useEffect(() => {\n    if (state.power !== 'on') return;\n\n    if (!eventsStartedRef.current) {\n      eventsStartedRef.current = true;\n\n      setInbox(story.emails);\n      setChatMessages([]);\n\n      story.chat.forEach((m) => {\n        const t = window.setTimeout(() => {\n          setChatMessages((prev) => [...prev, { from: m.from, text: m.text }]);\n          notify('info', 'CHAT', `New message from ${m.from}`);\n        }, m.atOffsetMs);\n        eventTimersRef.current.push(t);\n      });\n\n      story.events.forEach((ev) => {\n        const t = window.setTimeout(() => {\n          if (ev.kind === 'notify') notify(ev.level, ev.title, ev.body);\n          if (ev.kind === 'document') {\n            setFsEntries((prev) => {\n              const next = prev.map(normPath);\n              const p = normPath(ev.path);\n              if (!next.includes(p)) next.push(p);\n              return next;\n            });\n          }\n          if (ev.kind === 'email') {\n            const msg = story.emails.find((m) => m.id === ev.emailId);\n            if (msg) notify('alert', 'MAIL', `New email: ${msg.subject}`);\n          }\n        }, ev.atOffsetMs);\n        eventTimersRef.current.push(t);\n      });\n    }\n\n    const id = window.setInterval(() => {\n      setState((p) => {\n        const base = p.process.high_cpu.running ? 92 : p.cpu_load;\n        const noise = Math.random() * 4 - 2;\n        const nextCpu = clamp(base + noise, p.process.high_cpu.running ? 80 : 8, p.process.high_cpu.running ? 99 : 35);\n        return { ...p, cpu_load: nextCpu };\n      });\n    }, 700);\n\n    return () => window.clearInterval(id);\n  }, [state.power, story]);\n\n  useEffect(() => {\n    if (state.power === 'shutting-down') {\n      const id = window.setTimeout(() => {\n        setState((p) => ({ ...p, power: 'off' }));\n      }, 2500);\n      return () => window.clearTimeout(id);\n    }\n  }, [state.power, mission]);\n\n  useEffect(() => {\n    if (state.power !== 'on') return;\n    const id = window.setInterval(() => {\n      const roll = Math.random();\n      if (roll < 0.65) return;\n\n      setState((p) => ({\n        ...p,\n        notifications: [\n          ...p.notifications,\n          {\n            id: uid('n'),\n            kind: roll > 0.92 ? 'alert' : 'info',\n            title: roll > 0.92 ? 'SECURITY NOTICE' : 'SYSTEM',\n            body:\n              roll > 0.92\n                ? 'Background service attempted an outbound connection.'\n                : 'Try BrightOS Pro Trial ‚Äî limited time offer.',\n          },\n        ],\n      }));\n    }, 9000);\n\n    return () => window.clearInterval(id);\n  }, [state.power, mission]);\n\n  useEffect(() => {\n    const id = window.setInterval(() => setNow(new Date()), 1000);\n    return () => window.clearInterval(id);\n  }, []);\n\n  useEffect(() => {\n    function onMove(e: MouseEvent) {\n      const d = drag.current;\n      if (!d.id || !d.mode) return;\n\n      dragPosRef.current = { x: e.clientX, y: e.clientY };\n      if (dragRafRef.current !== null) return;\n\n      dragRafRef.current = window.requestAnimationFrame(() => {\n        dragRafRef.current = null;\n        const p = dragPosRef.current;\n        const dx = p.x - d.sx;\n        const dy = p.y - d.sy;\n\n        setWins((prev) => {\n          const w = prev[d.id!];\n          if (!w) return prev;\n          if (d.mode === 'move') {\n            return {\n              ...prev,\n              [d.id!]: {\n                ...w,\n                x: clamp(d.x + dx, 10, window.innerWidth - 260),\n                y: clamp(d.y + dy, 10, window.innerHeight - 160),\n              },\n            };\n          }\n          return {\n            ...prev,\n            [d.id!]: {\n              ...w,\n              w: clamp(d.w + dx, 360, window.innerWidth - 40),\n              h: clamp(d.h + dy, 240, window.innerHeight - 100),\n            },\n          };\n        });\n      });\n    }\n\n    function onUp() {\n      drag.current = { id: null, mode: null, sx: 0, sy: 0, x: 0, y: 0, w: 0, h: 0 };\n      if (dragRafRef.current !== null) {\n        window.cancelAnimationFrame(dragRafRef.current);\n        dragRafRef.current = null;\n      }\n    }\n\n    window.addEventListener('mousemove', onMove);\n    window.addEventListener('mouseup', onUp);\n    return () => {\n      window.removeEventListener('mousemove', onMove);\n      window.removeEventListener('mouseup', onUp);\n    };\n  }, []);\n\n  const allowedTools = useMemo(() => mission.tools_allowed as AppId[], [mission.tools_allowed]);\n  const stuckLock = state.window.stuck_app.open;\n\n  const startApps = useMemo(() => {\n    const allowed = new Set(mission.tools_allowed);\n    return [\n      { id: 'explorer' as const, title: 'File Explorer', subtitle: 'Browse files', disabled: false },\n      { id: 'uninstall' as const, title: 'Uninstall Programs', subtitle: 'Installed apps', disabled: false },\n      { id: 'registry' as const, title: 'Registry Editor', subtitle: 'System registry', disabled: false },\n      { id: 'devmgr' as const, title: 'Device Manager', subtitle: 'Drivers', disabled: false },\n      { id: 'mail' as const, title: 'Mail', subtitle: 'Inbox', disabled: false },\n      { id: 'chat' as const, title: 'Teams', subtitle: 'Chat', disabled: false },\n      { id: 'terminal' as const, title: 'Terminal', subtitle: 'Commands', disabled: !allowed.has('Terminal') },\n      { id: 'settings' as const, title: 'Settings', subtitle: 'System', disabled: !allowed.has('Settings') },\n      { id: 'taskmgr' as const, title: 'Task Manager', subtitle: 'Processes', disabled: !allowed.has('Task Manager') },\n      { id: 'browser' as const, title: 'Browser', subtitle: 'Web', disabled: !allowed.has('Browser') },\n      { id: 'automation' as const, title: 'Automation App', subtitle: 'Blocks & Scripts', disabled: !allowed.has('Automation App') },\n    ];\n  }, [mission.tools_allowed]);\n\n  function push(lines: TerminalLine[]) {\n    setTermLines((p) => {\n      if (lines.length === 1 && lines[0]?.kind === 'sys' && lines[0]?.text === 'Terminal cleared.') {\n        return lines;\n      }\n      return [...p, ...lines];\n    });\n  }\n\n  function focus(id: WindowId) {\n    if (stuckLock && id !== 'stuck_app') {\n      notify('alert', 'SYSTEM', 'Close the stuck window before using other apps.');\n      setActiveWin('stuck_app');\n      setWins((prev) => {\n        const w = prev.stuck_app;\n        if (!w) return prev;\n        const maxZ = Math.max(...Object.values(prev).map((x) => x.z));\n        return { ...prev, stuck_app: { ...w, open: true, minimized: false, z: maxZ + 1 } };\n      });\n      return;\n    }\n    setActiveWin(id);\n    setWins((prev) => {\n      const w = prev[id];\n      if (!w) return prev;\n      const maxZ = Math.max(...Object.values(prev).map((x) => x.z));\n      return { ...prev, [id]: { ...w, open: true, minimized: false, z: maxZ + 1 } };\n    });\n  }\n\n  function close(id: WindowId) {\n    setWins((prev) => {\n      const w = prev[id];\n      if (!w) return prev;\n      const next = { ...prev, [id]: { ...w, open: false, minimized: false } };\n      return next;\n    });\n\n    if (id === 'stuck_app') {\n      setState((p) => ({ ...p, window: { ...p.window, stuck_app: { open: false } } }));\n      notify('info', 'SYSTEM', 'Stuck window closed. Desktop responsive again.');\n    }\n\n    if (activeWin === id) {\n      setWins((prev) => {\n        const nextId = pickBestActiveWindow(prev);\n        setActiveWin(nextId);\n        return prev;\n      });\n    }\n  }\n\n  function notify(kind: 'alert' | 'info', title: string, body: string) {\n    setState((p) => ({ ...p, notifications: [...p.notifications, { id: uid('n'), kind, title, body }] }));\n  }\n\n  function taskbarToggle(id: WindowId) {\n    if (stuckLock) {\n      notify('alert', 'SYSTEM', 'A stuck window is open. Some actions may be blocked until you close it.');\n    }\n    setWins((prev) => {\n      const w = prev[id];\n      if (!w) return prev;\n      const maxZ = Math.max(...Object.values(prev).map((x) => x.z));\n\n      if (!w.open) {\n        setActiveWin(id);\n        return { ...prev, [id]: { ...w, open: true, minimized: false, z: maxZ + 1 } };\n      }\n      if (w.minimized) {\n        setActiveWin(id);\n        return { ...prev, [id]: { ...w, minimized: false, z: maxZ + 1 } };\n      }\n\n      const next = { ...prev, [id]: { ...w, minimized: true } };\n      const nextId = pickBestActiveWindow(next);\n      setActiveWin(nextId);\n      return next;\n    });\n  }\n\n  const completeMissionOnce = useCallback(() => {\n    if (missionComplete) return;\n    setMissionComplete(true);\n\n    if (!rewardGrantedRef.current) {\n      rewardGrantedRef.current = true;\n      awardFixedMissionXP(`brightos:csec:${mission.id}`, MISSION_XP_REWARD, 'Mission complete');\n      markMissionCompleted(`brightos:csec:${mission.id}`, MISSION_XP_REWARD);\n\n      if (user && db) {\n        const todayKey = new Date().toISOString().slice(0, 10);\n        const isNewDay = (userData?.lastLearningDay || '') !== todayKey;\n        const updates: any = {\n          xp: increment(MISSION_XP_REWARD),\n          bCoins: increment(MISSION_BCOIN_REWARD),\n          lastLearningDay: todayKey,\n          lastLearningAt: serverTimestamp(),\n          lastActive: new Date().toISOString(),\n          updatedAt: new Date().toISOString(),\n        };\n        updates.xp_today = isNewDay ? MISSION_XP_REWARD : increment(MISSION_XP_REWARD);\n        updateDoc(doc(db, 'users', user.uid), updates).catch(() => undefined);\n      }\n\n      const sid = liveSessionIdRef.current;\n      if (sid && !liveSessionEndedRef.current) {\n        endLiveSession(sid, { status: 'completed', xpEarned: MISSION_XP_REWARD });\n        liveSessionEndedRef.current = true;\n      }\n      const { cooldown } = registerMissionCompletionAndMaybeCooldown(`brightos:csec:${mission.id}`);\n\n      push([{\n        id: uid('sys'),\n        kind: 'sys',\n        text: `Mission complete. +${MISSION_XP_REWARD} XP and +${MISSION_BCOIN_REWARD} B-Coins earned.`,\n      }]);\n\n      if (cooldown) {\n        setCooldownUntil(cooldown.until);\n        push([{ id: uid('sys'), kind: 'sys', text: `Cooldown active. Try again later.` }]);\n      }\n\n      window.setTimeout(() => {\n        setState((p) => ({ ...p, power: 'reward' }));\n      }, 900);\n    }\n  }, [mission.id, missionComplete, user, userData]);\n\n  useEffect(() => {\n    if (missionComplete) return;\n    if (state.power !== 'on') return;\n    const ok = evalSuccess(state, mission.success_condition, fsEntries);\n    if (ok) completeMissionOnce();\n  }, [mission.success_condition, state, state.power, missionComplete, completeMissionOnce, fsEntries]);\n\n  if (cooldownActive) {\n    return (\n      <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n        <div className=\"fixed inset-0 z-0 bg-gradient-to-b from-red-500/10 via-transparent to-[#050B14]\" />\n        <div className=\"relative z-10 max-w-3xl mx-auto px-6 py-20\">\n          <Link\n            href=\"/practicals/technology-practicality/csec-roadmap\"\n            className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400 hover:text-white transition-colors\"\n          >\n            ‚Üê Back to CSEC Roadmap\n          </Link>\n\n          <div className=\"mt-10 rounded-[2rem] border border-red-500/30 bg-red-500/10 p-10\">\n            <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-red-200\">Cooldown Active</div>\n            <div className=\"mt-4 text-3xl font-black text-white\">Try again in {cooldownLabel}</div>\n            <div className=\"mt-3 text-zinc-200/80\">You have completed 5 missions today. Your next mission run unlocks when the timer ends.</div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (state.power === 'intro') {\n    const userLabel = (userData?.displayName || userData?.username || user?.displayName || 'Student').trim() || 'Student';\n    const userSeed = encodeURIComponent(userLabel || 'student');\n    const userAvatarUrl = userData?.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${userSeed}&backgroundType=solid&backgroundColor=2C3E50`;\n    const npcSeed = encodeURIComponent(`${mission.client.name}-${mission.id}-${npcSeedRef.current}`);\n    const npcAvatarUrl = `https://api.dicebear.com/9.x/avataaars/svg?seed=${npcSeed}&backgroundType=solid&backgroundColor=FF8A8A`;\n    return (\n      <PhoneMessageIntro\n        mission={mission}\n        userLabel={userLabel}\n        userAvatarUrl={userAvatarUrl}\n        npcLabel={mission.client.name}\n        npcAvatarUrl={npcAvatarUrl}\n        onDone={() => {\n          setBriefingAccepted(true);\n          setState((p) => ({ ...p, power: 'booting', boot_phase: 0 }));\n        }}\n      />\n    );\n  }\n\n  if (state.power === 'booting') {\n    const pct = Math.round((state.boot_phase / 5) * 100);\n    return (\n      <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n        <div className=\"absolute inset-0\" style={{ backgroundImage: `url(${wallpaper})`, backgroundSize: 'cover', backgroundPosition: 'center' }} />\n        <div className=\"absolute inset-0 bg-black/65\" />\n        <div className=\"relative z-10 min-h-screen flex items-center justify-center px-6\">\n          <div className=\"w-full max-w-lg border border-white/20 bg-black/75 p-10\">\n            <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">BrightOS</div>\n            <div className=\"mt-2 text-3xl font-black text-white\">Booting‚Ä¶</div>\n            <div className=\"mt-6 h-3 rounded-full border border-white/10 bg-white/[0.03] overflow-hidden\">\n              <div className=\"h-full bg-[var(--brand-primary)]/60\" style={{ width: `${pct}%` }} />\n            </div>\n            <div className=\"mt-3 text-xs text-zinc-300/80\">Loading system services ({pct}%)</div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (state.power === 'lock') {\n    return (\n      <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n        <div className=\"absolute inset-0\" style={{ backgroundImage: `url(${wallpaper})`, backgroundSize: 'cover', backgroundPosition: 'center' }} />\n        <div className=\"absolute inset-0 bg-black/60\" />\n        <div className=\"relative z-10 min-h-screen flex items-center justify-center px-6\">\n          <div className=\"w-full max-w-lg border border-white/20 bg-black/75 p-10\">\n            <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">BrightOS Account</div>\n            <div className=\"mt-2 text-3xl font-black text-white\">Student</div>\n\n            <div className=\"mt-5\">\n              <input\n                value={password}\n                onChange={(e) => {\n                  setPassword(e.target.value);\n                  setLoginError(null);\n                }}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter') {\n                    if (cooldownActive) {\n                      setLoginBusy(false);\n                      setLoginError(`Cooldown active. Try again in ${cooldownLabel}.`);\n                      return;\n                    }\n                    const candidate = password.trim().toLowerCase();\n                    setLoginBusy(true);\n                    window.setTimeout(() => {\n                      if (candidate === 'brightos') {\n                        setState((p) => ({ ...p, power: 'on' }));\n                        notify('info', 'SYSTEM', 'Welcome back. Mission environment loaded.');\n                      } else {\n                        setLoginBusy(false);\n                        setLoginError('Incorrect password');\n                      }\n                    }, 450);\n                  }\n                }}\n                placeholder=\"Password\"\n                className=\"w-full h-12 border border-white/20 bg-black/20 px-4 text-sm font-mono text-white outline-none focus:border-[var(--brand-primary)]/60\"\n              />\n              <div className=\"mt-3 flex items-center justify-between gap-4\">\n                <div className=\"text-xs text-zinc-400\">\n                  {loginError ? <span className=\"text-red-300\">{loginError}</span> : <span>Hint: <span className=\"font-mono text-zinc-200\">brightos</span></span>}\n                </div>\n                <button\n                  disabled={loginBusy}\n                  onClick={() => {\n                    if (cooldownActive) {\n                      setLoginBusy(false);\n                      setLoginError(`Cooldown active. Try again in ${cooldownLabel}.`);\n                      return;\n                    }\n                    const candidate = password.trim().toLowerCase();\n                    setLoginBusy(true);\n                    window.setTimeout(() => {\n                      if (candidate === 'brightos') {\n                        setState((p) => ({ ...p, power: 'on' }));\n                        notify('info', 'SYSTEM', 'Welcome back. Mission environment loaded.');\n                      } else {\n                        setLoginBusy(false);\n                        setLoginError('Incorrect password');\n                      }\n                    }, 450);\n                  }}\n                  className=\"h-12 px-6 border border-[var(--brand-primary)]/40 bg-[var(--brand-primary)]/20 hover:bg-[var(--brand-primary)]/30 transition-colors text-[10px] font-black uppercase tracking-[0.25em] text-white\"\n                >\n                  {loginBusy ? 'Verifying‚Ä¶' : 'Unlock'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (state.power === 'reward') {\n    const userLabel = (userData?.displayName || userData?.username || user?.displayName || 'Student').trim() || 'Student';\n    const userSeed = encodeURIComponent(userLabel || 'student');\n    const userAvatarUrl = userData?.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${userSeed}&backgroundType=solid&backgroundColor=2C3E50`;\n    const npcSeed = encodeURIComponent(`${mission.client.name}-${mission.id}-${npcSeedRef.current}`);\n    const npcAvatarUrl = `https://api.dicebear.com/9.x/avataaars/svg?seed=${npcSeed}&backgroundType=solid&backgroundColor=FF8A8A`;\n    return (\n      <PhoneMessageOutro\n        mission={mission}\n        userLabel={userLabel}\n        userAvatarUrl={userAvatarUrl}\n        npcLabel={mission.client.name}\n        npcAvatarUrl={npcAvatarUrl}\n        xpReward={MISSION_XP_REWARD}\n        bCoinReward={MISSION_BCOIN_REWARD}\n        onDone={() => {\n          setState((p) => ({ ...p, power: 'shutting-down' }));\n        }}\n      />\n    );\n  }\n\n  if (state.power === 'shutting-down') {\n    return (\n      <div className=\"min-h-screen bg-black flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 border-2 border-[var(--brand-primary)] border-t-transparent rounded-full animate-spin mx-auto mb-6\" />\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500\">BrightOS</div>\n          <div className=\"mt-2 text-2xl font-black text-white\">Shutting down‚Ä¶</div>\n        </div>\n      </div>\n    );\n  }\n\n  if (state.power === 'off') {\n    return (\n      <div className=\"min-h-screen bg-[#050B14] flex items-center justify-center p-6\">\n        <div className=\"w-full max-w-xl border border-white/10 bg-black/40 p-10 text-center rounded-[2rem]\">\n          <div className=\"w-20 h-20 bg-emerald-500/20 border border-emerald-500/30 rounded-full flex items-center justify-center text-3xl mx-auto mb-8\">\n            ‚úÖ\n          </div>\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-emerald-400\">Mission Success</div>\n          <h2 className=\"mt-4 text-3xl font-black text-white\">System Safely Offline</h2>\n          <p className=\"mt-4 text-zinc-400\">Mission accomplishments have been synced. You are ready to proceed to the next research lab.</p>\n\n          <div className=\"mt-10 pt-10 border-t border-white/5 flex flex-col gap-3\">\n            <button\n              onClick={() => router.push('/practicals/technology-practicality/csec-roadmap')}\n              className=\"h-14 rounded-2xl bg-white text-black font-black uppercase tracking-[0.1em] hover:bg-zinc-200 transition-colors\"\n            >\n              Return to Roadmap\n            </button>\n            <button\n              onClick={() => window.location.reload()}\n              className=\"h-12 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500 hover:text-white transition-colors\"\n            >\n              Restart Environment\n            </button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const securityPulse = state.process.high_cpu.running || Object.values(state.apps).some((a) => a.malware && a.installed);\n  const fan = fanLevel(state.cpu_load);\n  const batteryLabel = '78%';\n  const networkLabel = state.network.status === 'Connected' ? 'WiFi' : state.network.status;\n\n  return (\n    <div className=\"min-h-screen bg-[#050B14] relative overflow-hidden\">\n      <div className=\"absolute inset-0\" style={{ backgroundImage: `url(${wallpaper})`, backgroundSize: 'cover', backgroundPosition: 'center' }} />\n      <div className=\"absolute inset-0 bg-black/60\" />\n\n      <div className=\"relative z-10 h-screen\">\n        <Notifications\n          items={state.notifications}\n          onDismiss={(id) => {\n            setState((p) => ({ ...p, notifications: p.notifications.filter((n) => n.id !== id) }));\n          }}\n        />\n\n        <StartMenu\n          open={startOpen}\n          query={startQuery}\n          setQuery={setStartQuery}\n          apps={startApps}\n          onLaunch={(id) => {\n            setStartOpen(false);\n            setStartQuery('');\n            taskbarToggle(id);\n          }}\n          onClose={() => {\n            setStartOpen(false);\n          }}\n          onLock={() => {\n            setStartOpen(false);\n            setStartQuery('');\n            setState((p) => ({ ...p, power: 'lock' }));\n          }}\n          onToggleTheme={() => {\n            setTheme((p) => (p === 'light' ? 'dark' : 'light'));\n            notify('info', 'SYSTEM', 'Theme updated.');\n          }}\n          theme={theme}\n        />\n\n        <div className=\"absolute top-4 left-4 z-[200] border border-white/20 bg-black/45 px-4 py-3\">\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">BrightOS Live Mission</div>\n          <div className=\"mt-1 text-white font-black\">{mission.title}</div>\n          <div className=\"mt-1 text-xs text-zinc-300/80\">{company.name} ‚Ä¢ {company.dept} ‚Ä¢ {company.hostname}</div>\n        </div>\n\n        <div className=\"absolute top-4 right-4 z-[200] border border-white/20 bg-black/45 px-4 py-3 max-w-[460px]\">\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Client</div>\n          <div className=\"mt-1 text-sm text-zinc-200\">{mission.client.dialogue_start}</div>\n          <div className=\"mt-2 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500\">Objective</div>\n          <div className=\"mt-1 text-xs text-zinc-200/90\">Fix the issue and the system will auto-check completion.</div>\n          <div className=\"mt-3 text-[10px] font-black uppercase tracking-[0.25em] text-zinc-500\">Steps</div>\n          <div className=\"mt-2 grid gap-1 text-xs text-zinc-300/80\">\n            {mission.steps_to_solve.slice(0, 6).map((s) => (\n              <div key={s} className=\"leading-tight\">- {s}</div>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"absolute left-4 top-24 z-[180] grid grid-cols-1 gap-3\">\n          <DesktopIcon title=\"Device Manager\" subtitle=\"Drivers\" icon=\"üß∞\" onOpen={() => taskbarToggle('devmgr')} disabled={stuckLock} />\n          <DesktopIcon\n            title=\"This PC\"\n            subtitle=\"File Explorer\"\n            icon=\"üñ•Ô∏è\"\n            onOpen={() => {\n              setExplorerLocation('pc');\n              taskbarToggle('explorer');\n            }}\n            disabled={stuckLock}\n          />\n          <DesktopIcon\n            title=\"Recycle Bin\"\n            subtitle=\"Deleted items\"\n            icon=\"üóëÔ∏è\"\n            onOpen={() => {\n              setExplorerLocation('recycle');\n              taskbarToggle('explorer');\n            }}\n            disabled={stuckLock}\n          />\n          <DesktopIcon\n            title=\"File Explorer\"\n            subtitle=\"Browse\"\n            icon=\"üìÅ\"\n            onOpen={() => {\n              taskbarToggle('explorer');\n            }}\n            disabled={stuckLock}\n          />\n          <DesktopIcon title=\"Apps\" subtitle=\"Uninstall\" icon=\"üì¶\" onOpen={() => taskbarToggle('uninstall')} disabled={stuckLock} />\n          <DesktopIcon title=\"Registry\" subtitle=\"Edit keys\" icon=\"üß©\" onOpen={() => taskbarToggle('registry')} disabled={stuckLock} />\n          {allowedTools.includes('Terminal') && (\n            <DesktopIcon title=\"Terminal\" subtitle=\"Commands\" icon=\"‚å®Ô∏è\" onOpen={() => taskbarToggle('terminal')} disabled={stuckLock} />\n          )}\n          {allowedTools.includes('Task Manager') && (\n            <DesktopIcon title=\"Task Manager\" subtitle=\"Processes\" icon=\"üìä\" onOpen={() => taskbarToggle('taskmgr')} disabled={stuckLock} />\n          )}\n          {allowedTools.includes('Settings') && (\n            <DesktopIcon title=\"Settings\" subtitle=\"System\" icon=\"‚öôÔ∏è\" onOpen={() => taskbarToggle('settings')} disabled={stuckLock} />\n          )}\n          {allowedTools.includes('Browser') && (\n            <DesktopIcon title=\"Browser\" subtitle=\"Web\" icon=\"üåê\" onOpen={() => taskbarToggle('browser')} disabled={stuckLock} />\n          )}\n          {allowedTools.includes('Automation App') && (\n            <DesktopIcon title=\"Automation\" subtitle=\"Lab\" icon=\"üß†\" onOpen={() => taskbarToggle('automation')} disabled={stuckLock} />\n          )}\n        </div>\n\n        <Window\n          win={wins.stuck_app}\n          active={activeWin === 'stuck_app'}\n          onClose={() => close('stuck_app')}\n          onFocus={() => focus('stuck_app')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.stuck_app;\n            drag.current = { id: 'stuck_app', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('stuck_app');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.stuck_app;\n            drag.current = { id: 'stuck_app', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('stuck_app');\n          }}\n        >\n          <div className=\"text-sm text-zinc-200 p-6\">This window is blocking your work. Close it to continue.</div>\n          <div className=\"mt-4 text-xs text-zinc-400 p-6\">Tip: click ‚úï in the top-right. (Simulates a stuck app on the desktop.)</div>\n        </Window>\n\n        <Window\n          win={wins.uninstall}\n          active={activeWin === 'uninstall'}\n          onClose={() => close('uninstall')}\n          onFocus={() => focus('uninstall')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.uninstall;\n            drag.current = { id: 'uninstall', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('uninstall');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.uninstall;\n            drag.current = { id: 'uninstall', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('uninstall');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <UninstallPrograms\n              apps={state.apps}\n              onUninstall={(appId) => {\n                setState((p) => {\n                  const app = p.apps[appId];\n                  if (!app || !app.installed) return p;\n                  const newApps = { ...p.apps, [appId]: { ...app, installed: false } };\n                  const newRegistry = { ...p.registry };\n                  if (app.registryKeys) app.registryKeys.forEach((k) => delete newRegistry[k]);\n                  return { ...p, apps: newApps, registry: newRegistry };\n                });\n                notify('info', 'SYSTEM', `Uninstalled ${appId}.`);\n              }}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.registry}\n          active={activeWin === 'registry'}\n          onClose={() => close('registry')}\n          onFocus={() => focus('registry')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.registry;\n            drag.current = { id: 'registry', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('registry');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.registry;\n            drag.current = { id: 'registry', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('registry');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <RegistryEditor\n              registry={state.registry}\n              onSet={(fullKey, value) => {\n                setState((p) => ({ ...p, registry: { ...p.registry, [fullKey]: value } }));\n                notify('info', 'SYSTEM', `Registry updated: ${fullKey}`);\n              }}\n              onDelete={(prefix) => {\n                setState((p) => {\n                  const next = { ...p.registry };\n                  Object.keys(next)\n                    .filter((k) => k.startsWith(prefix))\n                    .forEach((k) => delete next[k]);\n                  return { ...p, registry: next };\n                });\n                notify('info', 'SYSTEM', `Registry key deleted: ${prefix}`);\n              }}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.devmgr}\n          active={activeWin === 'devmgr'}\n          onClose={() => close('devmgr')}\n          onFocus={() => focus('devmgr')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.devmgr;\n            drag.current = { id: 'devmgr', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('devmgr');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.devmgr;\n            drag.current = { id: 'devmgr', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('devmgr');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <DeviceManagerWindow state={state} onState={(fn) => setState(fn)} onNotify={notify} />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.mail}\n          active={activeWin === 'mail'}\n          onClose={() => close('mail')}\n          onFocus={() => focus('mail')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.mail;\n            drag.current = { id: 'mail', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('mail');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.mail;\n            drag.current = { id: 'mail', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('mail');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <MailApp emails={inbox} />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.chat}\n          active={activeWin === 'chat'}\n          onClose={() => close('chat')}\n          onFocus={() => focus('chat')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.chat;\n            drag.current = { id: 'chat', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('chat');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.chat;\n            drag.current = { id: 'chat', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('chat');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <ChatApp messages={chatMessages} />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.terminal}\n          active={activeWin === 'terminal'}\n          onClose={() => close('terminal')}\n          onFocus={() => focus('terminal')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.terminal;\n            drag.current = { id: 'terminal', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('terminal');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.terminal;\n            drag.current = { id: 'terminal', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('terminal');\n          }}\n        >\n          <Terminal\n            mission={mission}\n            state={state}\n            fsEntries={fsEntries}\n            onFsEntries={(fn) => setFsEntries(fn)}\n            lines={termLines}\n            input={termInput}\n            setInput={setTermInput}\n            push={push}\n            onState={(fn) => setState(fn)}\n          />\n        </Window>\n\n        <Window\n          win={wins.explorer}\n          active={activeWin === 'explorer'}\n          onClose={() => close('explorer')}\n          onFocus={() => focus('explorer')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.explorer;\n            drag.current = { id: 'explorer', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('explorer');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.explorer;\n            drag.current = { id: 'explorer', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('explorer');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <FileExplorer\n              entries={fsEntries}\n              location={explorerLocation}\n              onSetLocation={setExplorerLocation}\n              onOpen={(path) => {\n                const name = normPath(path).split('/').filter(Boolean).pop() || path;\n                setState((p) => ({ ...p, file: { opened: name } }));\n                notify('info', 'SYSTEM', `Opened ${path}.`);\n              }}\n              onDeleteToRecycle={(path) => {\n                setFsEntries((prev) => moveToRecycleBin(prev, path));\n                setState((p) => ({ ...p, recycle_bin: { empty: false } }));\n                notify('info', 'SYSTEM', `Moved ${path} to Recycle Bin.`);\n              }}\n              onEmptyRecycle={() => {\n                setFsEntries((prev) => prev.filter((entry) => !normPath(entry).startsWith('RecycleBin:/')));\n                setState((p) => ({ ...p, recycle_bin: { empty: true } }));\n                notify('info', 'SYSTEM', 'Recycle Bin emptied.');\n              }}\n              onCopyToDrive={(path, drive) => {\n                const base = normPath(path).split('/').filter(Boolean).pop() || path;\n                setFsEntries((prev) => {\n                  const next = prev.map(normPath);\n                  const dest = `${drive}:/${base}`;\n                  if (!next.includes(dest)) next.push(dest);\n                  return next;\n                });\n                notify('info', 'SYSTEM', `Copied ${base} to ${drive}:/`);\n              }}\n              onZipFolder={(path) => {\n                const norm = normPath(path);\n                const base = norm.replace(/\\/+$/, '').split('/').filter(Boolean).pop() || 'Archive';\n                const zipName = `${base}.zip`;\n                setFsEntries((prev) => {\n                  const next = prev.map(normPath);\n                  const inSameFolder = norm.includes('/') ? norm.split('/').slice(0, -1).join('/') : 'C:';\n                  const dest = `${inSameFolder}/${zipName}`.replace(/\\/+/, '/');\n                  if (!next.includes(dest)) next.push(dest);\n                  return next;\n                });\n                notify('info', 'SYSTEM', `Created ${zipName}`);\n              }}\n              onEncryptFolder={(path) => {\n                const norm = normPath(path);\n                setState((p) => {\n                  const existing = p.folder.encrypted_paths.map(normPath);\n                  if (existing.includes(norm)) return p;\n                  return { ...p, folder: { encrypted_paths: [...p.folder.encrypted_paths, norm] } };\n                });\n                notify('info', 'SYSTEM', `Encrypted ${path}`);\n              }}\n              theme={theme}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.browser}\n          active={activeWin === 'browser'}\n          onClose={() => close('browser')}\n          onFocus={() => focus('browser')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.browser;\n            drag.current = { id: 'browser', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('browser');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.browser;\n            drag.current = { id: 'browser', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('browser');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <BrowserWindow\n              mission={mission}\n              state={state}\n              onState={(fn) => setState(fn)}\n              onNotify={notify}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.automation}\n          active={activeWin === 'automation'}\n          onClose={() => close('automation')}\n          onFocus={() => focus('automation')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.automation;\n            drag.current = { id: 'automation', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('automation');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.automation;\n            drag.current = { id: 'automation', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('automation');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <AutomationWindow\n              mission={mission}\n              state={state}\n              onState={(fn) => setState(fn)}\n              onNotify={notify}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.taskmgr}\n          active={activeWin === 'taskmgr'}\n          onClose={() => close('taskmgr')}\n          onFocus={() => focus('taskmgr')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.taskmgr;\n            drag.current = { id: 'taskmgr', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('taskmgr');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.taskmgr;\n            drag.current = { id: 'taskmgr', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('taskmgr');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <TaskManager\n              state={state}\n              onEndHighCpu={() => {\n                setState((p) => ({ ...p, cpu_load: 18, process: { ...p.process, high_cpu: { running: false } } }));\n                push([{ id: uid('sys'), kind: 'sys', text: 'Process ended. CPU load stabilizing.' }]);\n                notify('info', 'SYSTEM', 'Background process ended. Performance improved.');\n              }}\n            />\n          </div>\n        </Window>\n\n        <Window\n          win={wins.settings}\n          active={activeWin === 'settings'}\n          onClose={() => close('settings')}\n          onFocus={() => focus('settings')}\n          theme={theme}\n          onDownMove={(e: any) => {\n            const w = wins.settings;\n            drag.current = { id: 'settings', mode: 'move', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('settings');\n          }}\n          onDownResize={(e: any) => {\n            const w = wins.settings;\n            drag.current = { id: 'settings', mode: 'resize', sx: e.clientX, sy: e.clientY, x: w.x, y: w.y, w: w.w, h: w.h };\n            focus('settings');\n          }}\n        >\n          <div className=\"p-6 h-full overflow-auto sleek-scrollbar\">\n            <Settings\n              mission={mission}\n              state={state}\n              onCleanTmp={() => {\n                setFsEntries((prev) => prev.map(normPath).filter((p) => !p.toLowerCase().endsWith('.tmp')));\n                setState((p) => ({\n                  ...p,\n                  files: { ...p.files, tmp: { count: 0 } },\n                  disk: { ...p.disk, free_space_mb: p.disk.free_space_mb + 320 },\n                }));\n                push([{ id: uid('sys'), kind: 'sys', text: 'Temporary files deleted.' }]);\n                notify('info', 'SYSTEM', 'Storage cleanup completed.');\n              }}\n              onEmptyRecycle={() => {\n                setFsEntries((prev) => prev.map(normPath).filter((p) => !p.startsWith('RecycleBin:/')));\n                setState((p) => ({\n                  ...p,\n                  recycle_bin: { empty: true },\n                  disk: { ...p.disk, free_space_mb: p.disk.free_space_mb + 420 },\n                }));\n                push([{ id: uid('sys'), kind: 'sys', text: 'Recycle Bin emptied.' }]);\n                notify('info', 'SYSTEM', 'Recycle Bin emptied.');\n              }}\n              theme={theme}\n              onToggleTheme={() => {\n                setTheme((p) => (p === 'light' ? 'dark' : 'light'));\n                notify('info', 'SYSTEM', 'Theme updated.');\n              }}\n              onState={(fn) => setState(fn)}\n              onNotify={notify}\n              onOpenWindow={(id) => taskbarToggle(id)}\n            />\n          </div>\n        </Window>\n\n        <div className=\"absolute left-0 right-0 bottom-0 z-[250]\">\n          <Taskbar\n            now={now}\n            tools={allowedTools}\n            wins={wins}\n            onToggle={taskbarToggle}\n            fan={fan}\n            cpu={state.cpu_load}\n            securityPulse={securityPulse}\n            lockedByStuck={stuckLock}\n            theme={theme}\n            startOpen={startOpen}\n            onStart={() => {\n              setStartOpen((p) => !p);\n            }}\n            batteryLabel={batteryLabel}\n            networkLabel={networkLabel}\n          />\n        </div>\n\n        <div className=\"absolute bottom-14 left-4 z-[210] rounded-2xl border border-white/10 bg-black/40 px-4 py-3 max-w-[520px]\">\n          <div className=\"text-[10px] font-black uppercase tracking-[0.25em] text-zinc-400\">Free-Play Objective</div>\n          <div className=\"mt-1 text-sm text-zinc-200\">Resolve the client issue and the system will validate completion.</div>\n          <div className=\"mt-2 text-xs text-zinc-400\">Tools allowed: {mission.tools_allowed.join(', ')}</div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/technology-practicality/csec/[id]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/practicals/technology-practicality/malware-incident/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setTone' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":104,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'dragActive' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":106,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setDragActive' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":106,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'desktopRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":109,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":109,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'height' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":118,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":118,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'wallpaper' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":135,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":135,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":430,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":430,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14528,14531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14528,14531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":667,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":667,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23377,23380],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23377,23380],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":677,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":677,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23780,23783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23780,23783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":683,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":683,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24130,24133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24130,24133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'cpu' is defined but never used. Allowed unused args must match /^_/u.","line":976,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":976,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'temp' is defined but never used. Allowed unused args must match /^_/u.","line":977,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":977,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'mounted' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":993,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":993,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1107,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1107,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41431,41434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41431,41434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1108,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1108,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41466,41469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41466,41469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1774,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1774,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75271,75274],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75271,75274],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1775,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1775,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[75294,75297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[75294,75297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useMemo, useRef, useState } from 'react';\nimport { AnimatePresence, motion } from 'framer-motion';\nimport Image from 'next/image';\nimport { doc, increment, serverTimestamp, updateDoc } from 'firebase/firestore';\nimport { getSessionWallpaperUrl } from '@/lib/brightos/wallpapers';\nimport { getMissionCooldown, registerMissionCompletionAndMaybeCooldown } from '@/lib/brightos/mission-rewards';\nimport { awardFixedMissionXP } from '@/lib/brightos/mission-xp';\nimport { markMissionCompleted } from '@/lib/brightos/mission-progress';\nimport { endLiveSession, startLiveSession } from '@/lib/brightos/live-sessions';\nimport { createDefaultInstalledApps, createDefaultRegistry } from '@/lib/brightos/system-datasets';\nimport { db } from '@/lib/firebase';\nimport { useAuth } from '@/lib/auth-context';\n\ntype DifficultyTier = 0 | 1 | 2 | 3 | 4;\n\ntype BrightOSState = {\n  power: 'booting' | 'lock' | 'on' | 'shutting-down';\n  cpu_load: number;\n  firewall: 'enabled' | 'disabled';\n  malware_active: boolean;\n  temperature: number;\n  user_reputation: number;\n  difficulty_tier: DifficultyTier;\n  boot_phase: 0 | 1 | 2 | 3 | 4 | 5;\n  notifications: Array<{ id: string; kind: 'alert' | 'info'; title: string; body: string }>;\n  badge?: { title: string; subtitle: string };\n  apps: ReturnType<typeof createDefaultInstalledApps>;\n  registry: ReturnType<typeof createDefaultRegistry>;\n  startMenuOpen: boolean;\n  quickSettingsOpen: boolean;\n};\n\ntype WindowId = 'taskmgr' | 'terminal' | 'defend' | 'edge' | 'recycle';\n\ntype WindowState = {\n  id: WindowId;\n  title: string;\n  open: boolean;\n  minimized: boolean;\n  z: number;\n  x: number;\n  y: number;\n  w: number;\n  h: number;\n};\n\ntype ProcessRow = { pid: number; name: string; cpu: number; mem: number; kind: 'system' | 'user' | 'malware' };\n\ntype TerminalLine = { id: string; kind: 'in' | 'out' | 'sys'; text: string };\n\nlet uidCounter = 0;\nfunction uid(prefix: string) {\n  return `${prefix}_${String(uidCounter++).padStart(4, '0')}_static`;\n}\n\nfunction clamp(n: number, min: number, max: number) {\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction fanLevel(cpu: number, temp: number) {\n  const stress = Math.max(cpu / 100, (temp - 35) / 70);\n  if (stress > 0.85) return 3;\n  if (stress > 0.6) return 2;\n  if (stress > 0.35) return 1;\n  return 0;\n}\n\nconst BRIGHTOS_PASSWORD = 'brightos';\n\nfunction initialOS(): BrightOSState {\n  return {\n    power: 'booting',\n    cpu_load: 12,\n    firewall: 'disabled',\n    malware_active: false,\n    temperature: 47,\n    user_reputation: 120,\n    difficulty_tier: 1,\n    boot_phase: 0,\n    notifications: [],\n    apps: createDefaultInstalledApps(),\n    registry: createDefaultRegistry(),\n    startMenuOpen: false,\n    quickSettingsOpen: false,\n  };\n}\n\nfunction initialWindows(): Record<WindowId, WindowState> {\n  return {\n    taskmgr: { id: 'taskmgr', title: 'Task Manager', open: true, minimized: false, z: 3, x: 80, y: 100, w: 520, h: 420 },\n    terminal: { id: 'terminal', title: 'Terminal', open: false, minimized: false, z: 2, x: 180, y: 140, w: 640, h: 420 },\n    defend: { id: 'defend', title: 'Defend', open: false, minimized: false, z: 1, x: 130, y: 120, w: 520, h: 380 },\n    edge: { id: 'edge', title: 'Microsoft Edge', open: false, minimized: false, z: 4, x: 100, y: 80, w: 800, h: 500 },\n    recycle: { id: 'recycle', title: 'Recycle Bin', open: false, minimized: false, z: 5, x: 150, y: 150, w: 500, h: 350 },\n  };\n}\n\nexport default function MalwareIncidentPractical() {\n  const { user, userData } = useAuth();\n  const [os, setOs] = useState<BrightOSState>(() => initialOS());\n  const [wins, setWins] = useState<Record<WindowId, WindowState>>(() => initialWindows());\n  const [tone, setTone] = useState<'caribbean' | 'formal'>('caribbean');\n  const [activeWin, setActiveWin] = useState<WindowId>('taskmgr');\n  const [dragActive, setDragActive] = useState(false);\n  const [practicalScale, setPracticalScale] = useState(1);\n  const practicalScaleRef = useRef(1);\n  const desktopRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    practicalScaleRef.current = practicalScale;\n  }, [practicalScale]);\n\n  useEffect(() => {\n    const handleResize = () => {\n      const width = window.innerWidth;\n      const height = window.innerHeight;\n\n      // Target design width is 1280px. Scale down if smaller.\n      if (width < 1280) {\n        // Minimum scale to avoid making text unreadable\n        const s = Math.max(width / 1280, 0.5);\n        setPracticalScale(s);\n      } else {\n        setPracticalScale(1);\n      }\n    };\n\n    handleResize();\n    window.addEventListener('resize', handleResize);\n    return () => window.removeEventListener('resize', handleResize);\n  }, []);\n\n  const [wallpaper, setWallpaper] = useState('');\n\n  const [now, setNow] = useState<Date | null>(null);\n\n  useEffect(() => {\n    setNow(new Date());\n  }, []);\n\n  const [cooldownUntil, setCooldownUntil] = useState<number | null>(null);\n  const missionCompletedRef = useRef(false);\n\n  const liveSessionIdRef = useRef<string | null>(null);\n  const liveSessionEndedRef = useRef(false);\n\n  const [password, setPassword] = useState('');\n  const [loginError, setLoginError] = useState<string | null>(null);\n  const [loginBusy, setLoginBusy] = useState(false);\n\n  const [termLines, setTermLines] = useState<TerminalLine[]>(() => [\n    { id: uid('t'), kind: 'sys', text: 'BrightOS Terminal ‚Äî try: scan --deep' },\n  ]);\n  const [termInput, setTermInput] = useState('');\n\n  const drag = useRef<{ id: WindowId | null; mode: 'move' | 'resize' | null; sx: number; sy: number; x: number; y: number; w: number; h: number }>({\n    id: null,\n    mode: null,\n    sx: 0,\n    sy: 0,\n    x: 0,\n    y: 0,\n    w: 0,\n    h: 0,\n  });\n\n  const dragRafRef = useRef<number | null>(null);\n  const dragPosRef = useRef<{ x: number; y: number }>({ x: 0, y: 0 });\n\n  const uiStutter = os.cpu_load > 80;\n  const hasInstalledMalware = useMemo(() => Object.values(os.apps).some((a) => a.installed && a.malware), [os.apps]);\n  const securityPulse = os.firewall === 'disabled' || os.malware_active || hasInstalledMalware;\n  const fan = useMemo(() => fanLevel(os.cpu_load, os.temperature), [os.cpu_load, os.temperature]);\n\n  const processes = useMemo<ProcessRow[]>(() => {\n    const rows: ProcessRow[] = [\n      { pid: 120, name: 'kernel_task', cpu: 4, mem: 6, kind: 'system' },\n      { pid: 221, name: 'shell_ui', cpu: uiStutter ? 10 : 3, mem: 9, kind: 'system' },\n      { pid: 411, name: 'defend_service', cpu: os.firewall === 'disabled' ? 2 : 4, mem: 4, kind: 'system' },\n    ];\n\n    const appRows = Object.values(os.apps)\n      .filter((a) => a.installed && a.process)\n      .slice(0, 14)\n      .map((a, idx) => ({\n        pid: 900 + idx,\n        name: a.process as string,\n        cpu: a.malware ? 2 : 1,\n        mem: a.malware ? 6 : 2,\n        kind: a.malware ? ('malware' as const) : ('user' as const),\n      }));\n\n    rows.push(...appRows);\n    if (os.malware_active) rows.push({ pid: 777, name: 'miner_x.exe', cpu: 90, mem: 18, kind: 'malware' });\n    return rows.sort((a, b) => b.cpu - a.cpu);\n  }, [os.apps, os.malware_active, os.firewall, uiStutter]);\n\n  useEffect(() => {\n    setWallpaper(getSessionWallpaperUrl());\n  }, []);\n\n  useEffect(() => {\n    const cd = getMissionCooldown();\n    setCooldownUntil(cd?.until ?? null);\n  }, []);\n\n  useEffect(() => {\n    liveSessionEndedRef.current = false;\n    const session = startLiveSession('malware-incident');\n    liveSessionIdRef.current = session.id;\n    return () => {\n      const sid = liveSessionIdRef.current;\n      if (!sid) return;\n      if (liveSessionEndedRef.current) return;\n      endLiveSession(sid, { status: 'abandoned' });\n      liveSessionEndedRef.current = true;\n    };\n  }, []);\n\n  useEffect(() => {\n    const id = window.setInterval(() => setNow(new Date()), 1000);\n    return () => window.clearInterval(id);\n  }, []);\n\n  const cooldownRemainingMs = cooldownUntil && now ? Math.max(0, cooldownUntil - now.getTime()) : 0;\n  const cooldownActive = cooldownUntil !== null && cooldownRemainingMs > 0;\n  const cooldownMins = Math.floor(cooldownRemainingMs / 60000);\n  const cooldownSecs = Math.floor((cooldownRemainingMs % 60000) / 1000);\n  const cooldownLabel = `${cooldownMins}:${String(cooldownSecs).padStart(2, '0')}`;\n\n  useEffect(() => {\n    const id = window.setInterval(() => {\n      setOs((p) => {\n        if (p.power !== 'booting') return p;\n        const next = (p.boot_phase + 1) as BrightOSState['boot_phase'];\n        if (next >= 5) return { ...p, power: 'lock', boot_phase: 5 };\n        return { ...p, boot_phase: next };\n      });\n    }, 900);\n    return () => window.clearInterval(id);\n  }, []);\n\n  useEffect(() => {\n    if (os.power !== 'on') return;\n    const id = window.setTimeout(() => {\n      setOs((p) => {\n        if (p.malware_active) return p;\n        return {\n          ...p,\n          cpu_load: 90,\n          malware_active: true,\n          notifications: [\n            ...p.notifications,\n            {\n              id: uid('n'),\n              kind: 'alert',\n              title: 'SYSTEM ALERT',\n              body: p.difficulty_tier <= 1 ? 'Unknown process consuming 90% CPU' : 'CPU usage abnormal. Performance degraded.',\n            },\n          ],\n        };\n      });\n    }, 1100);\n    return () => window.clearTimeout(id);\n  }, [os.power]);\n\n  useEffect(() => {\n    if (os.power !== 'on') return;\n    const id = window.setInterval(() => {\n      setOs((p) => {\n        let cpu = p.cpu_load;\n        let temp = p.temperature;\n        if (p.malware_active) {\n          cpu = clamp(cpu + 1.5, 80, 95);\n          temp = clamp(temp + 0.9, 45, 95);\n        } else {\n          cpu = clamp(cpu - 2.2, 8, 25);\n          temp = clamp(temp - 0.8, 35, 60);\n        }\n        return { ...p, cpu_load: cpu, temperature: temp };\n      });\n    }, 350);\n    return () => window.clearInterval(id);\n  }, [os.power]);\n\n  useEffect(() => {\n    if (os.power !== 'on') return;\n    setLoginBusy(false);\n    setLoginError(null);\n  }, [os.power]);\n\n  useEffect(() => {\n    function onMove(e: MouseEvent | TouchEvent) {\n      const d = drag.current;\n      if (!d.id || !d.mode) return;\n\n      let clientX, clientY;\n      if ('touches' in e) {\n        clientX = e.touches[0].clientX;\n        clientY = e.touches[0].clientY;\n        // e.preventDefault(); // Handled by passive: false listener if possible, else rely on CSS\n      } else {\n        clientX = (e as MouseEvent).clientX;\n        clientY = (e as MouseEvent).clientY;\n      }\n\n      dragPosRef.current = { x: clientX, y: clientY };\n      if (dragRafRef.current !== null) return;\n\n      const s = practicalScaleRef.current || 1;\n\n      dragRafRef.current = window.requestAnimationFrame(() => {\n        dragRafRef.current = null;\n        const p = dragPosRef.current;\n        const dx = (p.x - d.sx) / s;\n        const dy = (p.y - d.sy) / s;\n\n        setWins((prev) => {\n          const w = prev[d.id!];\n          if (!w) return prev;\n          const vw = window.innerWidth / s;\n          const vh = window.innerHeight / s;\n          if (d.mode === 'move') {\n            return {\n              ...prev,\n              [d.id!]: {\n                ...w,\n                x: clamp(d.x + dx, 10, Math.max(10, vw - w.w - 10)),\n                y: clamp(d.y + dy, 10, Math.max(10, vh - w.h - 10)),\n              },\n            };\n          }\n          return {\n            ...prev,\n            [d.id!]: {\n              ...w,\n              w: clamp(d.w + dx, 360, Math.max(360, vw - d.x - 10)),\n              h: clamp(d.h + dy, 260, Math.max(260, vh - d.y - 10)),\n            },\n          };\n        });\n      });\n    }\n\n    function onUp() {\n      drag.current = { id: null, mode: null, sx: 0, sy: 0, x: 0, y: 0, w: 0, h: 0 };\n      if (dragRafRef.current !== null) {\n        window.cancelAnimationFrame(dragRafRef.current);\n        dragRafRef.current = null;\n      }\n    }\n\n    const opts: AddEventListenerOptions = { passive: false };\n    window.addEventListener('mousemove', onMove);\n    window.addEventListener('mouseup', onUp);\n    window.addEventListener('touchmove', onMove, opts);\n    window.addEventListener('touchend', onUp);\n    return () => {\n      window.removeEventListener('mousemove', onMove);\n      window.removeEventListener('mouseup', onUp);\n      window.removeEventListener('touchmove', onMove, opts);\n      window.removeEventListener('touchend', onUp);\n    };\n  }, []);\n\n  function focus(id: WindowId) {\n    setActiveWin(id);\n    setWins((prev) => {\n      const maxZ = Math.max(...Object.values(prev).map((w) => w.z));\n      return { ...prev, [id]: { ...prev[id], open: true, minimized: false, z: maxZ + 1 } };\n    });\n  }\n\n  function toggleMin(id: WindowId) {\n    setWins((prev) => ({ ...prev, [id]: { ...prev[id], minimized: !prev[id].minimized, open: true } }));\n  }\n\n  function pickBestActiveWindow(next: Record<WindowId, WindowState>) {\n    const open = Object.values(next)\n      .filter((w) => w.open && !w.minimized)\n      .sort((a, b) => b.z - a.z);\n    return (open[0]?.id ?? 'taskmgr') as WindowId;\n  }\n\n  function taskbarToggle(id: WindowId) {\n    setWins((prev) => {\n      const w = prev[id];\n      if (!w) return prev;\n      const maxZ = Math.max(...Object.values(prev).map((x) => x.z));\n\n      if (!w.open) {\n        setActiveWin(id);\n        return { ...prev, [id]: { ...w, open: true, minimized: false, z: maxZ + 1 } };\n      }\n      if (w.minimized) {\n        setActiveWin(id);\n        return { ...prev, [id]: { ...w, minimized: false, z: maxZ + 1 } };\n      }\n\n      const next = { ...prev, [id]: { ...w, minimized: true } };\n      setActiveWin(pickBestActiveWindow(next));\n      return next;\n    });\n  }\n\n  function close(id: WindowId) {\n    setWins((prev) => ({ ...prev, [id]: { ...prev[id], open: false, minimized: false } }));\n  }\n\n  function notify(kind: 'alert' | 'info', title: string, body: string) {\n    setOs((p) => ({ ...p, notifications: [...p.notifications, { id: uid('m'), kind, title, body }] }));\n  }\n\n  function helper(msg: string, kind: 'info' | 'alert' = 'info') {\n    notify(kind, tone === 'formal' ? 'Assistant' : 'BrightOS Helper', msg);\n  }\n\n  function completeMissionOnce() {\n    if (missionCompletedRef.current) return;\n    missionCompletedRef.current = true;\n\n    awardFixedMissionXP('brightos:malware-incident', 100, 'Mission complete');\n    markMissionCompleted('brightos:malware-incident', 100);\n\n    if (user && db) {\n      const todayKey = new Date().toISOString().slice(0, 10);\n      const isNewDay = (userData?.lastLearningDay || '') !== todayKey;\n      const updates: any = {\n        xp: increment(100),\n        bCoins: increment(50),\n        lastLearningDay: todayKey,\n        lastLearningAt: serverTimestamp(),\n        lastActive: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      };\n      updates.xp_today = isNewDay ? 100 : increment(100);\n      updateDoc(doc(db, 'users', user.uid), updates).catch(() => undefined);\n    }\n    const sid = liveSessionIdRef.current;\n    if (sid && !liveSessionEndedRef.current) {\n      endLiveSession(sid, { status: 'completed', xpEarned: 100 });\n      liveSessionEndedRef.current = true;\n    }\n    const { cooldown } = registerMissionCompletionAndMaybeCooldown('brightos:malware-incident');\n\n    helper(tone === 'formal' ? 'Mission complete. +100 XP and +50 B-Coins earned.' : 'Mission clear. +100 XP and +50 B-Coins gain.', 'info');\n\n    if (cooldown) {\n      setCooldownUntil(cooldown.until);\n      helper(\n        tone === 'formal'\n          ? `Daily limit reached. Cooldown active for ${Math.round((cooldown.until - Date.now()) / 60000)} minutes.`\n          : `Yuh hit the daily limit. Cooldown active.`,\n        'alert'\n      );\n    }\n  }\n\n  function endMiner() {\n    setOs((p) => (p.malware_active ? { ...p, cpu_load: 10 } : p));\n    helper(tone === 'formal' ? 'CPU dropped briefly, but the process appears persistent.' : 'Yeah nah‚Ä¶ that thing persistent.', 'alert');\n    window.setTimeout(() => {\n      setOs((p) => (p.malware_active ? { ...p, cpu_load: 90 } : p));\n    }, 2000);\n  }\n\n  function endTask(pid: number) {\n    const p = processes.find(x => x.pid === pid);\n    if (!p) return;\n    if (p.kind === 'malware') {\n      endMiner();\n    } else {\n      helper(`Closing ${p.name}...`, 'info');\n    }\n  }\n\n  function termPush(lines: TerminalLine[]) {\n    setTermLines((p) => [...p, ...lines]);\n  }\n\n  function run(raw: string) {\n    const cmd = raw.trim();\n    if (!cmd) return;\n    termPush([{ id: uid('in'), kind: 'in', text: `> ${cmd}` }]);\n\n    const low = cmd.toLowerCase();\n\n    if (low === 'help') {\n      termPush([\n        { id: uid('o'), kind: 'out', text: 'scan --deep' },\n        { id: uid('o'), kind: 'out', text: 'delete /system/cache/miner_x.exe' },\n        { id: uid('o'), kind: 'out', text: 'apps' },\n        { id: uid('o'), kind: 'out', text: 'apps uninstall \"<name>\"' },\n        { id: uid('o'), kind: 'out', text: 'reg get <key> [value]' },\n        { id: uid('o'), kind: 'out', text: 'reg set <key> <value> <data>' },\n        { id: uid('o'), kind: 'out', text: 'reg delete <key>' },\n        { id: uid('o'), kind: 'out', text: 'clear' },\n      ]);\n      return;\n    }\n\n    if (low === 'clear') {\n      setTermLines([{ id: uid('sys'), kind: 'sys', text: 'Terminal cleared.' }]);\n      return;\n    }\n\n    if (low === 'scan --deep') {\n      termPush([\n        { id: uid('o'), kind: 'out', text: 'Deep scan initiated‚Ä¶' },\n        { id: uid('o'), kind: 'out', text: 'Tracing persistence hooks‚Ä¶' },\n      ]);\n      window.setTimeout(() => {\n        termPush([\n          { id: uid('o'), kind: 'out', text: os.malware_active ? 'Found persistence source: /system/cache/miner_x.exe' : 'No active persistence sources found.' },\n          { id: uid('o'), kind: 'out', text: os.malware_active ? 'Recommended: delete /system/cache/miner_x.exe' : 'System looks clean.' },\n        ]);\n      }, 800);\n      return;\n    }\n\n    if (low === 'delete /system/cache/miner_x.exe') {\n      if (!os.malware_active) {\n        termPush([{ id: uid('o'), kind: 'out', text: 'Target not active.' }]);\n        return;\n      }\n      termPush([\n        { id: uid('o'), kind: 'out', text: 'Deleting‚Ä¶ OK' },\n        { id: uid('o'), kind: 'out', text: 'Persistence removed.' },\n      ]);\n\n      completeMissionOnce();\n      setOs((p) => ({\n        ...p,\n        malware_active: false,\n        cpu_load: 10,\n        badge: { title: 'Malware Neutralized', subtitle: 'System Stabilized (+100 XP)' },\n        user_reputation: p.user_reputation + 50,\n      }));\n      helper(tone === 'formal' ? 'Persistence removed. System stabilized. Finalizing mission...' : 'That fix worked clean. Mission complete! Shutting down.');\n\n      window.setTimeout(() => {\n        setOs(p => ({ ...p, power: 'shutting-down' }));\n        window.setTimeout(() => {\n          window.location.href = '/practicals';\n        }, 3000);\n      }, 4000);\n      return;\n    }\n\n    if (low === 'apps') {\n      const list = Object.values(os.apps);\n      termPush([\n        { id: uid('o'), kind: 'out', text: 'Installed Apps:' },\n        ...list.map((a) => ({\n          id: uid('o'),\n          kind: 'out' as const,\n          text: `  ${a.installed ? '[+]' : '[ ]'} ${a.malware ? '[MALWARE]' : '[OK   ]'} ${a.name}`,\n        })),\n      ]);\n      return;\n    }\n\n    if (low.startsWith('apps uninstall')) {\n      const name = cmd.slice('apps uninstall'.length).trim().replace(/^[\"']|[\"']$/g, '');\n      const appEntry = Object.entries(os.apps).find(([, a]) => a.name.toLowerCase() === name.toLowerCase());\n      if (!appEntry) {\n        termPush([{ id: uid('o'), kind: 'out', text: `App not found: ${name}` }]);\n        return;\n      }\n      const [appId, app] = appEntry;\n      if (!app.installed) {\n        termPush([{ id: uid('o'), kind: 'out', text: `${app.name} is already uninstalled.` }]);\n        return;\n      }\n\n      setOs((p) => {\n        const newApps = { ...p.apps, [appId]: { ...app, installed: false } };\n        const newRegistry = { ...p.registry };\n        if (app.registryKeys) app.registryKeys.forEach((k) => delete newRegistry[k]);\n        return { ...p, apps: newApps, registry: newRegistry };\n      });\n      termPush([{ id: uid('o'), kind: 'out', text: `Uninstalled ${app.name}. Registry entries removed.` }]);\n      return;\n    }\n\n    if (low.startsWith('reg get')) {\n      const parts = cmd.trim().split(/\\s+/).slice(2);\n      const key = parts[0];\n      const value = parts[1];\n      if (!key) {\n        termPush([{ id: uid('o'), kind: 'out', text: 'Usage: reg get <key> [value]' }]);\n        return;\n      }\n      const full = value ? `${key}\\\\${value}` : key;\n      const data = os.registry[full];\n      termPush([{ id: uid('o'), kind: 'out', text: data === undefined ? `${full} not found.` : `${full} = ${data}` }]);\n      return;\n    }\n\n    if (low.startsWith('reg set')) {\n      const parts = cmd.trim().split(/\\s+/).slice(2);\n      if (parts.length < 2) {\n        termPush([{ id: uid('o'), kind: 'out', text: 'Usage: reg set <key> <value> <data>' }]);\n        return;\n      }\n      const key = parts[0];\n      const value = parts[1];\n      const data = parts.slice(2).join(' ');\n      setOs((p) => ({ ...p, registry: { ...p.registry, [`${key}\\\\${value}`]: data } }));\n      termPush([{ id: uid('o'), kind: 'out', text: `Set ${key}\\\\${value} = ${data}` }]);\n      return;\n    }\n\n    if (low.startsWith('reg delete')) {\n      const key = cmd.trim().split(/\\s+/).slice(2).join(' ');\n      if (!key) {\n        termPush([{ id: uid('o'), kind: 'out', text: 'Usage: reg delete <key>' }]);\n        return;\n      }\n      setOs((p) => {\n        const next = { ...p.registry };\n        Object.keys(next)\n          .filter((k) => k.startsWith(key))\n          .forEach((k) => delete next[k]);\n        return { ...p, registry: next };\n      });\n      termPush([{ id: uid('o'), kind: 'out', text: `Deleted registry key and subkeys: ${key}` }]);\n      return;\n    }\n\n    termPush([{ id: uid('o'), kind: 'out', text: `Unknown command: ${cmd}` }]);\n  }\n\n  const bg = 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1d4ed8 100%)';\n\n  const stutterMotion = uiStutter\n    ? {\n      x: [0, -1, 1, -1, 0],\n      y: [0, 1, -1, 1, 0],\n      filter: ['blur(0px)', 'blur(0.2px)', 'blur(0px)'],\n    }\n    : {};\n\n  return (\n    <div className=\"fixed inset-0 bg-[#000] overflow-hidden selection:bg-[var(--brand-primary)]/30 font-sans\">\n      {/* OS Background */}\n      <div\n        className=\"absolute inset-0 transition-all duration-1000\"\n        style={{ background: bg }}\n      />\n\n      {/* Desktop Icons */}\n      <div className=\"absolute top-6 left-6 z-[50] flex flex-col gap-5 select-none\">\n        <DesktopIcon label=\"Recycle Bin\" emoji=\"üóëÔ∏è\" onOpen={() => focus('recycle')} pulse={false} />\n        <DesktopIcon label=\"Microsoft Edge\" emoji=\"üåê\" onOpen={() => focus('edge')} pulse={false} />\n        <DesktopIcon label=\"Task Manager\" emoji=\"üìä\" onOpen={() => focus('taskmgr')} pulse={os.malware_active} />\n        <DesktopIcon label=\"Terminal\" emoji=\">_\" onOpen={() => focus('terminal')} pulse={false} />\n        <DesktopIcon label=\"Security\" emoji=\"üõ°Ô∏è\" onOpen={() => focus('defend')} pulse={securityPulse} />\n      </div>\n\n      {/* Windows Shell Layer */}\n      <motion.div\n        className=\"absolute inset-0 z-[100] origin-top-left\"\n        style={{ scale: practicalScale, width: `${100 / practicalScale}%`, height: `${100 / practicalScale}%` }}\n        animate={stutterMotion as any}\n        transition={uiStutter ? { duration: 0.22, repeat: Infinity } : { duration: 0.18 }}\n      >\n        {/* Render Windows */}\n        {(['taskmgr', 'terminal', 'defend', 'edge', 'recycle'] as WindowId[]).map((id) => (\n          <WindowFrame\n            key={id}\n            win={wins[id]}\n            active={activeWin === id}\n            onFocus={() => focus(id)}\n            onMoveStart={(e: any) => {\n              focus(id);\n              const cx = e.touches ? e.touches[0].clientX : e.clientX;\n              const cy = e.touches ? e.touches[0].clientY : e.clientY;\n              drag.current = { id, mode: 'move', sx: cx, sy: cy, x: wins[id].x, y: wins[id].y, w: wins[id].w, h: wins[id].h };\n            }}\n            onResizeStart={(e: any) => {\n              focus(id);\n              const cx = e.touches ? e.touches[0].clientX : e.clientX;\n              const cy = e.touches ? e.touches[0].clientY : e.clientY;\n              drag.current = { id, mode: 'resize', sx: cx, sy: cy, x: wins[id].x, y: wins[id].y, w: wins[id].w, h: wins[id].h };\n            }}\n            onMinimize={() => toggleMin(id)}\n            onClose={() => close(id)}\n          >\n            {id === 'taskmgr' && (\n              <TaskManager\n                cpu={os.cpu_load}\n                temp={os.temperature}\n                processes={processes}\n                hintTier={os.difficulty_tier}\n                onEndTask={endTask}\n              />\n            )}\n            {id === 'terminal' && (\n              <Terminal\n                lines={termLines}\n                value={termInput}\n                onChange={setTermInput}\n                onRun={() => {\n                  const v = termInput;\n                  setTermInput('');\n                  run(v);\n                }}\n                onPreset={(cmd) => run(cmd)}\n              />\n            )}\n            {id === 'defend' && (\n              <Defend firewall={os.firewall} malware={os.malware_active} onOpenTerminal={() => focus('terminal')} />\n            )}\n            {id === 'edge' && (\n              <Edge />\n            )}\n            {id === 'recycle' && (\n              <RecycleBin />\n            )}\n          </WindowFrame>\n        ))}\n\n        {/* Start Menu */}\n        <StartMenu\n          open={os.startMenuOpen}\n          onClose={() => setOs(p => ({ ...p, startMenuOpen: false }))}\n          onOpenApp={(id) => focus(id)}\n        />\n\n        {/* Quick Settings */}\n        <QuickSettings\n          open={os.quickSettingsOpen}\n          onClose={() => setOs(p => ({ ...p, quickSettingsOpen: false }))}\n          cpu={os.cpu_load}\n          temp={os.temperature}\n          fan={fan}\n        />\n\n        {/* Taskbar */}\n        <div className=\"absolute bottom-0 left-0 right-0 z-[150] flex justify-center pb-2\">\n          <div className=\"w-fit\">\n            <Taskbar\n              fan={fan}\n              cpu={os.cpu_load}\n              temp={os.temperature}\n              securityPulse={securityPulse}\n              wins={wins}\n              onToggle={taskbarToggle}\n              onStartToggle={() => setOs(p => ({ ...p, startMenuOpen: !p.startMenuOpen, quickSettingsOpen: false }))}\n              onQuickToggle={() => setOs(p => ({ ...p, quickSettingsOpen: !p.quickSettingsOpen, startMenuOpen: false }))}\n            />\n          </div>\n        </div>\n\n        {/* Notifications */}\n        <div className=\"absolute bottom-16 right-4 z-[120] flex flex-col gap-3 w-[360px] max-w-[92vw]\">\n          <AnimatePresence>\n            {os.notifications.slice(-3).map((n) => (\n              <motion.div\n                key={n.id}\n                initial={{ x: 400, opacity: 0 }}\n                animate={{ x: 0, opacity: 1 }}\n                exit={{ x: 400, opacity: 0 }}\n                className={`rounded-lg border p-4 shadow-xl backdrop-blur-xl ${n.kind === 'alert' ? 'border-red-500/30 bg-red-900/40' : 'border-white/10 bg-zinc-900/60'\n                  }`}\n              >\n                <div className=\"flex items-start justify-between gap-3\">\n                  <div className=\"flex-1\">\n                    <div className=\"text-[11px] font-bold text-white/50 mb-1\">{n.title}</div>\n                    <div className=\"text-[12px] text-white/90 leading-tight\">{n.body}</div>\n                  </div>\n                  <button\n                    onClick={() => setOs((p) => ({ ...p, notifications: p.notifications.filter((x) => x.id !== n.id) }))}\n                    className=\"w-6 h-6 flex items-center justify-center rounded hover:bg-white/10 text-white/40 hover:text-white transition-colors\"\n                  >\n                    ‚úï\n                  </button>\n                </div>\n              </motion.div>\n            ))}\n          </AnimatePresence>\n        </div>\n\n        {/* Milestone Badge */}\n        <AnimatePresence>\n          {os.badge && (\n            <motion.div\n              initial={{ y: 100, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              exit={{ y: 100, opacity: 0 }}\n              className=\"absolute left-1/2 -translate-x-1/2 bottom-20 z-[180] w-[400px] max-w-[90vw]\"\n            >\n              <div className=\"rounded-xl border border-emerald-500/30 bg-emerald-900/40 backdrop-blur-xl p-6 shadow-2xl flex items-center gap-4\">\n                <div className=\"w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-2xl\">üèÜ</div>\n                <div>\n                  <div className=\"text-[10px] font-bold uppercase tracking-widest text-emerald-400\">Mission Accomplished</div>\n                  <div className=\"text-lg font-bold text-white\">{os.badge.title}</div>\n                  <div className=\"text-xs text-emerald-200/60\">{os.badge.subtitle}</div>\n                </div>\n              </div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </motion.div>\n\n      {/* Boot, Lock & Shutdown Screens (Overlays) */}\n      <AnimatePresence>\n        {os.power === 'booting' && <BootScreen phase={os.boot_phase} />}\n        {os.power === 'shutting-down' && <ShutdownScreen />}\n        {os.power === 'lock' && (\n          <LockScreen\n            now={now}\n            password={password}\n            setPassword={setPassword}\n            error={loginError}\n            busy={loginBusy}\n            cooldown={cooldownActive ? cooldownLabel : null}\n            onLogin={() => {\n              const candidate = password.trim().toLowerCase();\n              setLoginBusy(true);\n              window.setTimeout(() => {\n                if (candidate === BRIGHTOS_PASSWORD) {\n                  setOs((p) => ({ ...p, power: 'on' }));\n                } else {\n                  setLoginBusy(false);\n                  setLoginError('Incorrect password');\n                }\n              }, 450);\n            }}\n            onExit={() => {\n              setOs(p => ({ ...p, power: 'shutting-down' }));\n              window.setTimeout(() => {\n                window.location.href = '/practicals';\n              }, 2000);\n            }}\n          />\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\nfunction DesktopIcon({ label, emoji, onOpen, pulse }: { label: string; emoji: string; onOpen: () => void; pulse: boolean }) {\n  return (\n    <div className=\"flex flex-col items-center select-none\">\n      <button\n        onClick={(e) => {\n          e.currentTarget.focus();\n          onOpen();\n        }}\n        className={`\n          w-[74px] group p-2 flex flex-col items-center gap-1 rounded transition-all relative outline-none\n          hover:bg-white/10 active:scale-95 focus:bg-white/10 focus:ring-1 focus:ring-white/20 select-none\n          ${pulse ? 'animate-attention-glow' : ''}\n        `}\n      >\n        <div className=\"text-[32px] transition-transform group-active:scale-90 drop-shadow-md select-none leading-none h-10 flex items-center justify-center pointer-events-none\">{emoji}</div>\n        <span className=\"text-[11px] text-white text-center leading-tight drop-shadow-lg font-normal select-none px-0.5 max-h-8 overflow-hidden pointer-events-none\">{label}</span>\n        {pulse && <div className=\"absolute top-2 right-4 w-2.5 h-2.5 bg-red-500 rounded-full border border-white shadow-sm\" />}\n      </button>\n    </div>\n  );\n}\n\nfunction BootScreen({ phase }: { phase: number }) {\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"absolute inset-0 z-[200] bg-black flex flex-col items-center justify-center p-8 text-white font-mono\"\n    >\n      <div className=\"w-16 h-16 border-4 border-t-white border-white/10 rounded-full animate-spin mb-12\" />\n      <div className=\"w-[400px] max-w-full space-y-2 opacity-50 text-[12px]\">\n        <div>{phase >= 0 ? '> Initializing BrightOS Kernel...' : ''}</div>\n        <div>{phase >= 1 ? '> Loading system drivers...' : ''}</div>\n        <div>{phase >= 2 ? '> Mounting encrypted volumes...' : ''}</div>\n        <div>{phase >= 3 ? '> Starting security subsystems...' : ''}</div>\n        <div>{phase >= 4 ? '> Preparing graphical shell...' : ''}</div>\n        <div className=\"text-blue-400\">{phase >= 5 ? '> System ready. Awaiting user.' : ''}</div>\n      </div>\n    </motion.div>\n  );\n}\n\nfunction LockScreen({ now, password, setPassword, error, busy, cooldown, onLogin, onExit }: { now: Date | null; password: string; setPassword: (s: string) => void; error: string | null; busy: boolean; cooldown: string | null; onLogin: () => void; onExit: () => void }) {\n  const timeDisplay = now ? now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--';\n  const dateDisplay = now ? now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' }) : 'Loading...';\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"absolute inset-0 z-[190] bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center flex flex-col items-center justify-center p-12\"\n    >\n      <div className=\"absolute inset-0 bg-black/40 backdrop-blur-md\" />\n\n      <div className=\"relative z-10 mb-12 text-center text-white\">\n        <div className=\"text-8xl font-sans font-black mb-2 tracking-tighter drop-shadow-2xl\">{timeDisplay}</div>\n        <div className=\"text-xl font-bold opacity-90 drop-shadow-md\">{dateDisplay}</div>\n      </div>\n\n      <div className=\"relative z-10 w-[420px] bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[3rem] p-10 flex flex-col items-center gap-8 shadow-2xl\">\n        <div className=\"w-28 h-28 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 border-4 border-white/20 p-1 shadow-xl overflow-hidden active:scale-95 transition-transform cursor-pointer\">\n          <div className=\"w-full h-full rounded-full bg-white/10 flex items-center justify-center text-5xl\">üë§</div>\n        </div>\n        <div className=\"text-3xl font-black text-white drop-shadow-sm tracking-tight\">Student Technician</div>\n\n        <div className=\"w-full space-y-6\">\n          <div className=\"relative\">\n            <input\n              type=\"password\"\n              value={password}\n              onChange={(e) => setPassword(e.target.value)}\n              onKeyDown={(e) => e.key === 'Enter' && onLogin()}\n              placeholder=\"Enter Password\"\n              autoFocus\n              className=\"w-full h-14 px-6 bg-white/10 border-2 border-white/10 rounded-2xl text-white text-lg placeholder:text-white/30 outline-none focus:ring-4 ring-[var(--brand-primary)]/40 focus:border-[var(--brand-primary)] transition-all backdrop-blur-sm\"\n            />\n            {busy && <div className=\"absolute right-4 top-4.5 w-5 h-5 border-2 border-[var(--brand-primary)] border-t-transparent rounded-full animate-spin\" />}\n          </div>\n\n          {error && <div className=\"text-red-400 text-center text-sm font-bold animate-shake\">{error}</div>}\n          {cooldown && <div className=\"text-amber-400 text-center text-sm font-bold\">Cooldown active: {cooldown}</div>}\n\n          <button\n            onClick={onLogin}\n            disabled={busy}\n            className=\"duo-btn duo-btn-primary w-full h-14 text-sm tracking-widest\"\n          >\n            {busy ? 'SIGNING IN...' : 'UNLOCK SYSTEM'}\n          </button>\n\n          <div className=\"text-center opacity-40\">\n            <span className=\"text-[10px] font-black uppercase tracking-[0.2em]\">Password hint: </span>\n            <code className=\"text-xs font-black text-[var(--brand-primary)]\">brightos</code>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"absolute bottom-10 right-10 flex gap-4\">\n        <button\n          onClick={onExit}\n          className=\"w-14 h-14 rounded-2xl border-2 border-white/10 bg-white/5 backdrop-blur-xl flex items-center justify-center text-2xl text-white hover:bg-red-500 hover:border-red-500 transition-all active:scale-90\"\n          title=\"Exit Practical\"\n        >\n          ‚èª\n        </button>\n      </div>\n    </motion.div>\n  );\n}\n\nfunction ShutdownScreen() {\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"absolute inset-0 z-[300] bg-black flex flex-col items-center justify-center gap-8 text-white\"\n    >\n      <div className=\"w-16 h-16 border-4 border-t-blue-500 border-white/10 rounded-full animate-spin\" />\n      <div className=\"text-center space-y-2\">\n        <h2 className=\"text-2xl font-light tracking-wide\">Shutting down</h2>\n        <p className=\"text-xs opacity-40 font-mono\">Cleaning system memory and securing encrypted volumes...</p>\n      </div>\n    </motion.div>\n  );\n}\n\nfunction Taskbar({\n  fan,\n  cpu,\n  temp,\n  securityPulse,\n  wins,\n  onToggle,\n  onStartToggle,\n  onQuickToggle,\n}: {\n  fan: number;\n  cpu: number;\n  temp: number;\n  securityPulse: boolean;\n  wins: Record<WindowId, WindowState>;\n  onToggle: (id: WindowId) => void;\n  onStartToggle: () => void;\n  onQuickToggle: () => void;\n}) {\n  const [mounted, setMounted] = useState(false);\n  const [timeStr, setTimeStr] = useState('--:--');\n  const [dateStr, setDateStr] = useState('--/--/--');\n\n  useEffect(() => {\n    setMounted(true);\n    const updateTime = () => {\n      const now = new Date();\n      setTimeStr(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));\n      setDateStr(now.toLocaleDateString([], { month: '2-digit', day: '2-digit', year: 'numeric' }));\n    };\n    updateTime();\n    const id = window.setInterval(updateTime, 1000);\n    return () => window.clearInterval(id);\n  }, []);\n  return (\n    <div className=\"h-14 px-2 flex items-center justify-center relative bg-zinc-900/60 backdrop-blur-3xl border border-white/10 rounded-[1.25rem] shadow-[0_8px_32px_rgba(0,0,0,0.5)]\">\n      {/* Centered App Icons */}\n      <div className=\"flex items-center gap-1.5 px-3 py-1 bg-white/[0.02] rounded-xl\">\n        {/* Start Button */}\n        <button\n          onClick={onStartToggle}\n          className=\"w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/10 transition-colors group\"\n        >\n          <div className=\"w-6 h-6 relative transition-transform group-active:scale-90\">\n            <Image\n              src=\"/BrightEdLogo.png\"\n              alt=\"Start\"\n              fill\n              sizes=\"24px\"\n              className=\"object-contain opacity-90 group-hover:opacity-100\"\n            />\n          </div>\n        </button>\n\n        {/* Windows Search Placeholder */}\n        <button className=\"w-10 h-10 flex items-center justify-center rounded-lg hover:bg-white/10 transition-colors\">\n          <span className=\"text-xl opacity-80\">üîç</span>\n        </button>\n\n        <div className=\"w-[1px] h-6 bg-white/10 mx-1\" />\n\n        {/* App Icons */}\n        <TaskbarBtn\n          emoji=\"üìä\"\n          active={wins.taskmgr.open && !wins.taskmgr.minimized}\n          onClick={() => onToggle('taskmgr')}\n        />\n        <TaskbarBtn\n          emoji=\">_\"\n          active={wins.terminal.open && !wins.terminal.minimized}\n          onClick={() => onToggle('terminal')}\n        />\n        <TaskbarBtn\n          emoji=\"üõ°Ô∏è\"\n          active={wins.defend.open && !wins.defend.minimized}\n          onClick={() => onToggle('defend')}\n          pulse={securityPulse}\n        />\n      </div>\n\n      {/* System Tray (Right Side) */}\n      <div className=\"absolute right-3 h-full flex items-center gap-1 text-white/90\">\n        <button\n          onClick={onQuickToggle}\n          className=\"flex items-center gap-3 px-3 py-1.5 rounded-lg hover:bg-white/10 transition-colors\"\n        >\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-xs opacity-80\">Wifi</span>\n            <span className=\"text-xs opacity-80\">{fan >= 2 ? 'üí®' : 'üåÄ'}</span>\n          </div>\n          <div className=\"flex flex-col items-end leading-tight select-none\">\n            <span className=\"text-[10px] font-bold\">{timeStr}</span>\n            <span className=\"text-[9px] opacity-60 tracking-tighter\">{dateStr}</span>\n          </div>\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction TaskbarBtn({ emoji, active, onClick, pulse }: { emoji: string; active: boolean; onClick: () => void; pulse?: boolean }) {\n  return (\n    <button\n      onClick={onClick}\n      className={`\n        w-10 h-10 flex flex-col items-center justify-center rounded-lg transition-all relative group\n        hover:bg-white/10\n        ${active ? 'bg-white/10' : ''}\n        ${pulse ? 'animate-urgent-pulse' : ''}\n      `}\n    >\n      <div className=\"text-xl transition-transform group-active:scale-90 group-hover:-translate-y-0.5\">{emoji}</div>\n      <div className={`mt-auto h-0.5 rounded-full bg-[var(--brand-primary)] transition-all duration-300 ${active ? 'w-4' : 'w-0'}`} />\n    </button>\n  );\n}\n\nfunction WindowFrame({\n  win,\n  active,\n  children,\n  onClose,\n  onMinimize,\n  onFocus,\n  onMoveStart,\n  onResizeStart,\n}: {\n  win: WindowState;\n  active: boolean;\n  children: React.ReactNode;\n  onClose: () => void;\n  onMinimize: () => void;\n  onFocus: () => void;\n  onMoveStart: (e: any) => void;\n  onResizeStart: (e: any) => void;\n}) {\n  if (!win.open || win.minimized) return null;\n  return (\n    <motion.div\n      initial={{ scale: 0.9, opacity: 0 }}\n      animate={{ scale: 1, opacity: 1 }}\n      className={`absolute flex flex-col rounded-xl overflow-hidden shadow-2xl transition-all duration-200 ${active\n        ? 'ring-1 ring-white/20 bg-zinc-900/80 backdrop-blur-3xl'\n        : 'ring-1 ring-white/10 bg-zinc-900/60 backdrop-blur-xl'\n        }`}\n      style={{ left: win.x, top: win.y, width: win.w, height: win.h, zIndex: win.z }}\n      onMouseDown={onFocus}\n    >\n      {/* Title Bar */}\n      <div\n        className=\"h-9 px-3 flex items-center justify-between gap-3 bg-white/[0.03] select-none cursor-default active:cursor-grabbing\"\n        onMouseDown={onMoveStart}\n        onTouchStart={onMoveStart}\n      >\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-[11px] font-medium text-white/80\">{win.title}</span>\n        </div>\n        <div className=\"flex items-center\">\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onMinimize();\n            }}\n            className=\"w-10 h-9 flex items-center justify-center hover:bg-white/10 transition-colors text-white/80\"\n          >\n            <span className=\"text-lg\">Ôºç</span>\n          </button>\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onClose();\n            }}\n            className=\"w-10 h-9 flex items-center justify-center hover:bg-red-500 transition-colors group\"\n          >\n            <span className=\"text-lg text-white/80 group-hover:text-white\">‚úï</span>\n          </button>\n        </div>\n      </div>\n\n      {/* Window Content */}\n      <div className=\"flex-1 overflow-hidden\">{children}</div>\n\n      {/* Resize Handle */}\n      <div\n        className=\"absolute right-0 bottom-0 w-4 h-4 cursor-se-resize z-50\"\n        onMouseDown={onResizeStart}\n        onTouchStart={onResizeStart}\n      />\n    </motion.div>\n  );\n}\n\nfunction StartMenu({ open, onOpenApp, onClose }: { open: boolean; onOpenApp: (id: WindowId) => void; onClose: () => void }) {\n  return (\n    <AnimatePresence>\n      {open && (\n        <>\n          <div className=\"fixed inset-0 z-[155]\" onClick={onClose} />\n          <motion.div\n            initial={{ y: 300, opacity: 0, scale: 0.9 }}\n            animate={{ y: 0, opacity: 1, scale: 1 }}\n            exit={{ y: 300, opacity: 0, scale: 0.9 }}\n            className=\"absolute left-1/2 -translate-x-1/2 bottom-20 w-[640px] max-w-[95vw] h-[720px] bg-zinc-900/40 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] shadow-[0_32px_128px_rgba(0,0,0,0.8)] z-[160] overflow-hidden flex flex-col\"\n          >\n            {/* Search Bar */}\n            <div className=\"p-10 pb-6\">\n              <div className=\"relative group\">\n                <span className=\"absolute left-6 top-1/2 -translate-y-1/2 opacity-40 text-lg\">üîç</span>\n                <input\n                  disabled\n                  placeholder=\"Search for apps, settings, and documents\"\n                  className=\"w-full h-12 pl-14 pr-6 bg-white/5 border border-white/10 rounded-full text-sm text-white placeholder:text-white/30 outline-none focus:ring-4 ring-[var(--brand-primary)]/20 transition-all shadow-inner\"\n                />\n              </div>\n            </div>\n\n            {/* Pinned Apps */}\n            <div className=\"px-10 flex-1 overflow-auto sleek-scrollbar\">\n              <div className=\"flex items-center justify-between mb-6 px-2\">\n                <span className=\"text-[13px] font-black text-white/90 uppercase tracking-widest\">Pinned</span>\n                <button className=\"text-[11px] font-bold bg-white/5 hover:bg-white/10 px-4 py-1.5 rounded-full transition-all text-white/60\">All apps &gt;</button>\n              </div>\n              <div className=\"grid grid-cols-6 gap-y-8\">\n                <StartMenuIcon label=\"Task Manager\" emoji=\"üìä\" onClick={() => { onOpenApp('taskmgr'); onClose(); }} />\n                <StartMenuIcon label=\"Terminal\" emoji=\">_\" onClick={() => { onOpenApp('terminal'); onClose(); }} />\n                <StartMenuIcon label=\"Security\" emoji=\"üõ°Ô∏è\" onClick={() => { onOpenApp('defend'); onClose(); }} />\n                <StartMenuIcon label=\"Explorer\" emoji=\"üìÅ\" onClick={() => { onOpenApp('recycle'); onClose(); }} />\n                <StartMenuIcon label=\"Edge\" emoji=\"üåê\" onClick={() => { onOpenApp('edge'); onClose(); }} />\n                <StartMenuIcon label=\"Store\" emoji=\"üõçÔ∏è\" opacity={0.4} />\n                <StartMenuIcon label=\"Photos\" emoji=\"üñºÔ∏è\" opacity={0.4} />\n                <StartMenuIcon label=\"Settings\" emoji=\"‚öôÔ∏è\" opacity={0.4} />\n                <StartMenuIcon label=\"Word\" emoji=\"üìù\" opacity={0.4} />\n                <StartMenuIcon label=\"Excel\" emoji=\"üìà\" opacity={0.4} />\n                <StartMenuIcon label=\"PowerPoint\" emoji=\"üìΩÔ∏è\" opacity={0.4} />\n                <StartMenuIcon label=\"Mail\" emoji=\"‚úâÔ∏è\" opacity={0.4} />\n              </div>\n\n              {/* Recommended Section (New Windows 11 Style) */}\n              <div className=\"mt-12\">\n                <div className=\"flex items-center justify-between mb-6 px-2\">\n                  <span className=\"text-[13px] font-black text-white/90 uppercase tracking-widest\">Recommended</span>\n                  <button className=\"text-[11px] font-bold bg-white/5 hover:bg-white/10 px-4 py-1.5 rounded-full transition-all text-white/60\">More &gt;</button>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <RecommendedItem label=\"incident_report.docx\" emoji=\"üìÑ\" sub=\"Recently edited\" />\n                  <RecommendedItem label=\"network_scan.log\" emoji=\"üìë\" sub=\"Added 2h ago\" />\n                </div>\n              </div>\n            </div>\n\n            {/* Bottom Section */}\n            <div className=\"mt-auto bg-black/40 p-6 px-10 flex items-center justify-between border-t border-white/5\">\n              <div className=\"flex items-center gap-4 hover:bg-white/5 p-2 pr-6 rounded-full transition-all cursor-pointer group\">\n                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 border border-white/20 flex items-center justify-center text-sm shadow-lg group-active:scale-95 transition-transform\">üë§</div>\n                <div className=\"flex flex-col\">\n                  <span className=\"text-[13px] font-black text-white/90 leading-none mb-1\">Student Technician</span>\n                  <span className=\"text-[10px] text-white/30 uppercase tracking-tighter\">Level 1 Admin</span>\n                </div>\n              </div>\n              <button\n                onClick={() => window.location.reload()}\n                className=\"w-12 h-12 rounded-2xl hover:bg-white/10 flex items-center justify-center transition-all text-white/60 hover:text-red-400 active:scale-90\"\n                title=\"Power Options\"\n              >\n                ‚èª\n              </button>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n\nfunction RecommendedItem({ label, emoji, sub }: { label: string; emoji: string; sub: string }) {\n  return (\n    <div className=\"flex items-center gap-4 p-3 rounded-2xl hover:bg-white/5 transition-all cursor-pointer group\">\n      <div className=\"text-2xl group-hover:scale-110 transition-transform\">{emoji}</div>\n      <div className=\"flex flex-col min-w-0\">\n        <span className=\"text-[12px] font-bold text-white/90 truncate\">{label}</span>\n        <span className=\"text-[10px] text-white/40\">{sub}</span>\n      </div>\n    </div>\n  );\n}\n\nfunction StartMenuIcon({ label, emoji, onClick, opacity = 1 }: { label: string; emoji: string; onClick?: () => void; opacity?: number }) {\n  return (\n    <button\n      onClick={onClick}\n      style={{ opacity }}\n      className=\"flex flex-col items-center gap-2 group p-2 rounded hover:bg-white/5 transition-colors\"\n    >\n      <div className=\"text-3xl transition-transform group-active:scale-90\">{emoji}</div>\n      <span className=\"text-[11px] text-white/80 text-center leading-tight whitespace-nowrap overflow-hidden w-full px-1\">{label}</span>\n    </button>\n  );\n}\n\nfunction QuickSettings({ open, onClose, cpu, temp, fan }: { open: boolean; onClose: () => void; cpu: number; temp: number; fan: number }) {\n  return (\n    <AnimatePresence>\n      {open && (\n        <>\n          <div className=\"fixed inset-0 z-[155]\" onClick={onClose} />\n          <motion.div\n            initial={{ x: 300, opacity: 0 }}\n            animate={{ x: 0, opacity: 1 }}\n            exit={{ x: 300, opacity: 0 }}\n            className=\"absolute right-3 bottom-16 w-[360px] bg-zinc-900/85 backdrop-blur-3xl border border-white/[0.08] rounded-xl shadow-2xl z-[160] p-6 flex flex-col gap-6\"\n          >\n            <div className=\"grid grid-cols-3 gap-3\">\n              <QuickSettingToggle label=\"Wi-Fi\" emoji=\"üåê\" active={true} />\n              <QuickSettingToggle label=\"Bluetooth\" emoji=\"ü¶∑\" active={true} />\n              <QuickSettingToggle label=\"Airplane\" emoji=\"‚úàÔ∏è\" active={false} />\n              <QuickSettingToggle label=\"Night light\" emoji=\"üåô\" active={false} />\n              <QuickSettingToggle label=\"Location\" emoji=\"üìç\" active={false} />\n              <QuickSettingToggle label=\"Project\" emoji=\"üìΩÔ∏è\" active={false} />\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"space-y-1.5\">\n                <div className=\"flex justify-between text-[11px] font-medium text-white/60\">\n                  <span>Performance (CPU)</span>\n                  <span className={cpu > 80 ? 'text-red-400' : ''}>{Math.round(cpu)}%</span>\n                </div>\n                <div className=\"h-1 rounded-full bg-white/10 overflow-hidden\">\n                  <motion.div\n                    className={`h-full ${cpu > 80 ? 'bg-red-500' : 'bg-[var(--brand-primary)]'}`}\n                    animate={{ width: `${cpu}%` }}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-1.5\">\n                <div className=\"flex justify-between text-[11px] font-medium text-white/60\">\n                  <span>Temperature</span>\n                  <span className={temp > 75 ? 'text-amber-400' : ''}>{Math.round(temp)}¬∞C</span>\n                </div>\n                <div className=\"h-1 rounded-full bg-white/10 overflow-hidden\">\n                  <motion.div\n                    className={`h-full ${temp > 75 ? 'bg-amber-500' : 'bg-emerald-500'}`}\n                    animate={{ width: `${Math.min(temp, 100)}%` }}\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex items-center justify-between border-t border-white/5 pt-4 text-white/60 text-[11px]\">\n              <div className=\"flex items-center gap-2\">\n                <span>üîã 100% (Plugged in)</span>\n              </div>\n              <span>Fan Level: {fan}</span>\n            </div>\n          </motion.div>\n        </>\n      )}\n    </AnimatePresence>\n  );\n}\n\nfunction QuickSettingToggle({ label, emoji, active }: { label: string; emoji: string; active: boolean }) {\n  return (\n    <button className=\"flex flex-col items-center gap-2 group\">\n      <div className={`w-full h-12 flex items-center justify-center rounded-lg transition-colors ${active ? 'bg-[var(--brand-primary)] text-white' : 'bg-white/5 text-white/60 hover:bg-white/10'}`}>\n        <span className=\"text-xl\">{emoji}</span>\n      </div>\n      <span className=\"text-[10px] font-medium text-white/80\">{label}</span>\n    </button>\n  );\n}\n\n\n\nfunction TaskManager({\n  cpu,\n  temp,\n  processes,\n  hintTier,\n  onEndTask,\n}: {\n  cpu: number;\n  temp: number;\n  processes: ProcessRow[];\n  hintTier: DifficultyTier;\n  onEndTask: (pid: number) => void;\n}) {\n  const [activeTab, setActiveTab] = useState<'processes' | 'performance'>('processes');\n\n  return (\n    <div className=\"h-full flex bg-[#1c1c1c] text-white\">\n      {/* Sidebar */}\n      <div className=\"w-12 flex flex-col items-center py-4 bg-white/5 border-r border-white/5 gap-1\">\n        <button\n          onClick={() => setActiveTab('processes')}\n          title=\"Processes\"\n          className={`w-10 h-10 flex items-center justify-center rounded-lg transition-colors ${activeTab === 'processes' ? 'bg-white/10 text-[var(--brand-primary)]' : 'text-white/40 hover:bg-white/5 hover:text-white/80'}`}\n        >\n          <span className=\"text-lg\">üìÑ</span>\n        </button>\n        <button\n          onClick={() => setActiveTab('performance')}\n          title=\"Performance\"\n          className={`w-10 h-10 flex items-center justify-center rounded-lg transition-colors ${activeTab === 'performance' ? 'bg-white/10 text-[var(--brand-primary)]' : 'text-white/40 hover:bg-white/5 hover:text-white/80'}`}\n        >\n          <span className=\"text-lg\">üìà</span>\n        </button>\n        <div className=\"mt-auto\">\n          <button className=\"w-10 h-10 flex items-center justify-center rounded-lg text-white/20 hover:text-white/60 transition-colors\">‚öôÔ∏è</button>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"flex-1 flex flex-col overflow-hidden\">\n        {activeTab === 'processes' ? (\n          <div className=\"flex-1 flex flex-col overflow-hidden\">\n            <div className=\"grid grid-cols-[1fr_80px_80px_80px] gap-2 px-4 py-2 text-[11px] font-medium text-white/40 border-b border-white/5 uppercase tracking-wider\">\n              <span>Name</span>\n              <span className=\"text-right\">CPU</span>\n              <span className=\"text-right\">Memory</span>\n              <span className=\"text-right\">Action</span>\n            </div>\n            <div className=\"flex-1 overflow-auto py-1\">\n              {processes.map((p) => (\n                <div\n                  key={p.pid}\n                  className={`grid grid-cols-[1fr_80px_80px_80px] gap-2 px-4 py-1.5 text-[12px] hover:bg-white/5 group border-b border-white/[0.02] last:border-0 ${p.kind === 'malware' ? 'bg-red-500/5' : ''}`}\n                >\n                  <div className=\"flex flex-col min-w-0\">\n                    <span className=\"truncate font-medium text-white/90\">{p.name}{p.kind === 'malware' && hintTier <= 1 ? ' (suspicious)' : ''}</span>\n                    <span className=\"text-[10px] text-white/30\">PID {p.pid}</span>\n                  </div>\n                  <span className=\"text-right self-center text-white/70 font-mono\">{Math.round(p.cpu)}%</span>\n                  <span className=\"text-right self-center text-white/70 font-mono\">{Math.round(p.mem)}%</span>\n                  <div className=\"flex justify-end items-center opacity-0 group-hover:opacity-100 transition-opacity\">\n                    <button\n                      onClick={() => onEndTask(p.pid)}\n                      className={`px-3 py-1 rounded-md text-[10px] uppercase font-bold transition-all bg-[var(--brand-primary)] text-white hover:bg-[var(--brand-primary)]/80 shadow-lg shadow-[var(--brand-primary)]/20 active:scale-95`}\n                    >\n                      End Task\n                    </button>\n                  </div>\n                </div>\n              ))}\n            </div>\n            <div className=\"p-3 bg-black/10 border-t border-white/5 text-[10px] text-white/40 italic\">\n              Tip: Ending a process may not stop the infection persistence.\n            </div>\n          </div>\n        ) : (\n          <div className=\"p-6 flex flex-col gap-8\">\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-sm font-semibold text-white/90\">CPU Consumption</h3>\n                <span className=\"text-2xl font-bold text-[var(--brand-primary)]\">{Math.round(cpu)}%</span>\n              </div>\n              <div className=\"h-32 rounded bg-black/40 border border-white/5 relative overflow-hidden\">\n                {/* Visual Graph Mockup */}\n                <div className=\"absolute inset-x-0 bottom-0 h-full flex items-end\">\n                  {[...Array(20)].map((_, i) => (\n                    <motion.div\n                      key={i}\n                      className=\"flex-1 bg-[var(--brand-primary)]/20 border-t border-[var(--brand-primary)]/40\"\n                      animate={{ height: `${Math.random() * 20 + cpu * 0.8}%` }}\n                      transition={{ duration: 0.5, repeat: Infinity, repeatType: 'reverse' }}\n                    />\n                  ))}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"p-4 rounded bg-white/[0.03] border border-white/5\">\n                <div className=\"text-[11px] text-white/50 uppercase font-bold tracking-widest mb-1\">Temperature</div>\n                <div className={`text-xl font-bold ${temp > 75 ? 'text-amber-400' : 'text-emerald-400'}`}>{Math.round(temp)}¬∞C</div>\n              </div>\n              <div className=\"p-4 rounded bg-white/[0.03] border border-white/5\">\n                <div className=\"text-[11px] text-white/50 uppercase font-bold tracking-widest mb-1\">Uptime</div>\n                <div className=\"text-xl font-bold text-white/90\">0:04:22:12</div>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction Terminal({\n  lines,\n  value,\n  onChange,\n  onRun,\n  onPreset,\n}: {\n  lines: TerminalLine[];\n  value: string;\n  onChange: (v: string) => void;\n  onRun: () => void;\n  onPreset: (cmd: string) => void;\n}) {\n  const scrollRef = useRef<HTMLDivElement | null>(null);\n  useEffect(() => {\n    scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' });\n  }, [lines.length]);\n\n  return (\n    <div className=\"h-full flex flex-col bg-[#300a24]/95 text-white font-mono selection:bg-[#fb8c00]/40\">\n      {/* Ubuntu Style Header */}\n      <div className=\"flex h-11 bg-[#4a4a4a] items-center px-4 justify-between border-b border-black/20\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex items-center gap-2 bg-[#300a24] px-4 py-1.5 rounded-t-lg border-t-2 border-[#fb8c00]\">\n            <span className=\"text-[11px] font-bold tracking-tight\">ubuntu@brighted: ~</span>\n            <span className=\"text-[10px] opacity-40\">‚úï</span>\n          </div>\n          <button className=\"text-lg opacity-40 hover:opacity-100 transition-all\">Ôºã</button>\n        </div>\n        <div className=\"flex items-center gap-3 opacity-60\">\n          <span>üîç</span>\n          <span>‚ò∞</span>\n        </div>\n      </div>\n\n      <div className=\"flex-1 flex flex-col p-6 overflow-hidden\">\n        <div ref={scrollRef} className=\"flex-1 overflow-auto mb-4 sleek-scrollbar text-[14px] leading-relaxed\">\n          <div className=\"text-[#fb8c00] font-bold mb-4\">\n            Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-79-generic x86_64)\n            <br />\n            * Documentation: https://help.ubuntu.com\n            <br />\n            * Management:    https://landscape.canonical.com\n          </div>\n          {lines.map((l) => (\n            <div\n              key={l.id}\n              className={`mb-1.5 animate-in fade-in slide-in-from-left-2 duration-300 ${l.kind === 'in' ? 'text-[#87ff5f]' :\n                l.kind === 'sys' ? 'text-white/40 italic font-sans' :\n                  'text-white'\n                }`}\n            >\n              {l.kind === 'in' && <span className=\"mr-3 text-[#fb8c00]\">ubuntu@brighted:~$</span>}\n              {l.text}\n            </div>\n          ))}\n        </div>\n\n        <div className=\"space-y-4 pt-4 border-t border-white/10 mt-auto\">\n          <div className=\"flex gap-2\">\n            <button onClick={() => onPreset('scan --deep')} className=\"duo-btn duo-btn-primary h-8 px-4 text-[9px]\">\n              SCAN SYSTEM\n            </button>\n            <button onClick={() => onPreset('help')} className=\"duo-btn duo-btn-secondary h-8 px-4 text-[9px]\">\n              HELP\n            </button>\n          </div>\n\n          <div className=\"flex items-center gap-3 bg-black/20 border-2 border-white/5 rounded-xl px-4 h-12 focus-within:border-[#fb8c00]/50 transition-all\">\n            <span className=\"text-[#fb8c00] text-sm font-black\">$</span>\n            <input\n              value={value}\n              onChange={(e) => onChange(e.target.value)}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter') onRun();\n              }}\n              placeholder=\"Enter command...\"\n              className=\"flex-1 bg-transparent text-[14px] text-white outline-none caret-[#fb8c00]\"\n              autoFocus\n            />\n            <button onClick={onRun} className=\"text-[#fb8c00] font-black hover:scale-110 transition-transform\">\n              ‚èé\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction Defend({ firewall, malware, onOpenTerminal }: { firewall: 'enabled' | 'disabled'; malware: boolean; onOpenTerminal: () => void }) {\n  const [scanning, setScanning] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [scanResult, setScanResult] = useState<string | null>(null);\n\n  const startScan = () => {\n    setScanning(true);\n    setProgress(0);\n    setScanResult(null);\n    const interval = setInterval(() => {\n      setProgress((p) => {\n        if (p >= 100) {\n          clearInterval(interval);\n          setScanning(false);\n          setScanResult(malware ? 'Threat detected: miner_x.exe' : 'No threats found.');\n          return 100;\n        }\n        return p + Math.random() * 15;\n      });\n    }, 150);\n  };\n\n  return (\n    <div className=\"h-full bg-[#f3f3f3] text-[#201f1e] flex font-sans select-none selection:bg-[var(--brand-primary)]/30\">\n      {/* Search Sidebar - Windows 11 Settings Style */}\n      <div className=\"w-64 bg-black/5 border-r border-black/5 p-6 flex flex-col gap-2\">\n        <div className=\"flex items-center gap-4 px-4 py-3 mb-4\">\n          <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 border-2 border-white shadow-md flex items-center justify-center text-xl\">üë§</div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-[14px] font-black leading-none\">Student Technician</span>\n            <span className=\"text-[11px] opacity-60\">Admin Access</span>\n          </div>\n        </div>\n\n        <NavItem label=\"Home\" icon=\"üè†\" active />\n        <NavItem label=\"System\" icon=\"üíª\" />\n        <NavItem label=\"Bluetooth & devices\" icon=\"üéß\" />\n        <NavItem label=\"Network & internet\" icon=\"üåê\" />\n        <NavItem label=\"Personalization\" icon=\"üñåÔ∏è\" />\n        <NavItem label=\"Apps\" icon=\"üì±\" />\n        <NavItem label=\"Accounts\" icon=\"üë§\" />\n        <NavItem label=\"Time & language\" icon=\"üåê\" />\n        <NavItem label=\"Gaming\" icon=\"üéÆ\" />\n        <NavItem label=\"Accessibility\" icon=\"üë§\" />\n        <NavItem label=\"Privacy & security\" icon=\"üõ°Ô∏è\" />\n        <NavItem label=\"Windows Update\" icon=\"üîÑ\" />\n      </div>\n\n      {/* Main Content */}\n      <div className=\"flex-1 p-12 flex flex-col gap-10 bg-white/50 backdrop-blur-3xl overflow-auto sleek-scrollbar\">\n        <header>\n          <h2 className=\"text-4xl font-black mb-2 tracking-tight\">Security at a glance</h2>\n          <p className=\"text-[14px] opacity-60 font-medium\">Manage the security and health of your BrightOS device.</p>\n        </header>\n\n        {scanning ? (\n          <div className=\"p-12 rounded-[2.5rem] border-2 border-blue-100 bg-blue-50/50 flex flex-col items-center gap-8 animate-in zoom-in-95 duration-500 shadow-xl shadow-blue-500/10\">\n            <div className=\"w-20 h-20 border-4 border-t-blue-500 border-blue-100 rounded-full animate-spin shadow-lg\"></div>\n            <div className=\"text-center space-y-4\">\n              <h3 className=\"text-2xl font-black text-slate-800 tracking-tight\">Scanning for threats...</h3>\n              <div className=\"w-80 h-3 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n                <motion.div\n                  className=\"h-full bg-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.5)]\"\n                  initial={{ width: 0 }}\n                  animate={{ width: `${progress}%` }}\n                />\n              </div>\n              <p className=\"text-xs font-black text-slate-400 uppercase tracking-widest\">Exploring: C:\\SYSTEM\\REGISTRY\\...</p>\n            </div>\n          </div>\n        ) : (\n          <div className=\"grid grid-cols-2 gap-8\">\n            <div className=\"p-8 rounded-[2.5rem] border border-slate-100 bg-white shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all group flex flex-col gap-6\">\n              <div className=\"flex items-center justify-between\">\n                <span className={`text-5xl drop-shadow-lg ${malware ? 'grayscale-0' : 'grayscale opacity-20'}`}>{malware ? 'üî•' : 'üõ°Ô∏è'}</span>\n                <span className={`text-[10px] font-black uppercase tracking-widest px-4 py-1.5 rounded-full border-2 ${malware ? 'bg-red-50 border-red-200 text-red-600' : 'bg-emerald-50 border-emerald-200 text-emerald-600'}`}>\n                  {malware ? 'Threats Found' : 'Protected'}\n                </span>\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"text-[18px] font-black text-slate-800 tracking-tight\">Virus & threat protection</div>\n                <div className=\"text-sm text-slate-500 leading-relaxed font-medium\">\n                  {scanResult || (malware ? 'Action is required. Threat detected.' : 'No actions needed. Your device is safe.')}\n                </div>\n              </div>\n              <button\n                onClick={startScan}\n                className=\"duo-btn duo-btn-secondary h-11 w-full text-[10px]\"\n              >\n                QUICK SCAN\n              </button>\n            </div>\n\n            <div className=\"p-8 rounded-[2.5rem] border border-slate-100 bg-white shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all flex flex-col gap-6\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-5xl drop-shadow-lg opacity-80\">üß±</span>\n                <span className={`text-[10px] font-black uppercase tracking-widest px-4 py-1.5 rounded-full border-2 ${firewall === 'disabled' ? 'bg-amber-50 border-amber-200 text-amber-600' : 'bg-emerald-50 border-emerald-200 text-emerald-600'}`}>\n                  {firewall === 'disabled' ? 'Disabled' : 'Active'}\n                </span>\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"text-[18px] font-black text-slate-800 tracking-tight\">Firewall & network</div>\n                <div className=\"text-sm text-slate-500 leading-relaxed font-medium\">Everything looks good on the network.</div>\n              </div>\n              <button className=\"duo-btn duo-btn-secondary h-11 w-full text-[10px]\">\n                MANAGE FIREWALL\n              </button>\n            </div>\n          </div>\n        )}\n\n        {malware && !scanning && (\n          <div className=\"mt-auto p-8 bg-red-50 border-2 border-red-100 rounded-[2.5rem] flex gap-8 animate-attention\">\n            <span className=\"text-5xl drop-shadow-xl\">‚ö†Ô∏è</span>\n            <div className=\"space-y-4\">\n              <div className=\"text-xl font-black text-red-900 tracking-tight underline decoration-red-500/30 decoration-4 underline-offset-4\">Critical Threat Alert: miner_x.exe</div>\n              <p className=\"text-[15px] text-red-700/80 leading-relaxed font-semibold\">\n                Windows Security detected a high-reputation threat hiding in system cache. This process is consuming excessive resources and may be part of a botnet. Use the <strong className=\"text-red-900\">BrightOS Terminal</strong> to perform a deep scan and manual deletion.\n              </p>\n              <button\n                onClick={onOpenTerminal}\n                className=\"duo-btn duo-btn-danger h-12 px-8 text-xs\"\n              >\n                OPEN TERMINAL TO FIX\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction NavItem({ label, icon, active = false }: { label: string; icon: string; active?: boolean }) {\n  return (\n    <div className={`flex items-center gap-4 px-5 py-2.5 rounded-xl text-[13px] font-black tracking-tight transition-all cursor-pointer ${active\n      ? 'bg-white shadow-sm border border-black/5 text-[var(--brand-primary)]'\n      : 'text-slate-600 hover:bg-black/5'\n      }`}>\n      <span className=\"text-lg opacity-80\">{icon}</span>\n      <span className=\"truncate\">{label}</span>\n      {active && <div className=\"ml-auto w-1 h-4 rounded-full bg-[var(--brand-primary)]\" />}\n    </div>\n  );\n}\nfunction Edge() {\n  return (\n    <div className=\"h-full bg-white flex flex-col font-sans selection:bg-[var(--brand-primary)]/30\">\n      {/* Edge Address Bar - Windows 11 Style */}\n      <div className=\"h-14 bg-zinc-50 border-b border-black/10 flex items-center px-6 gap-6 shadow-sm\">\n        <div className=\"flex gap-6 text-black/40 text-[14px] font-bold\">\n          <span className=\"cursor-pointer hover:text-black transition-colors\">‚¨ÖÔ∏è</span>\n          <span className=\"cursor-pointer hover:text-black transition-colors\">‚û°Ô∏è</span>\n          <span className=\"cursor-pointer hover:text-black transition-colors\">üîÑ</span>\n        </div>\n        <div className=\"flex-1 bg-white border-2 border-slate-100 rounded-full px-6 py-2 text-[13px] font-bold text-slate-500 truncate flex items-center gap-3 shadow-inner group focus-within:border-[var(--brand-primary)] transition-all\">\n          <span className=\"text-[12px] text-emerald-500\">üîí</span>\n          https://portal.brighted.com/cases/incident-0422\n        </div>\n        <div className=\"flex items-center gap-4 text-black/40 px-4 border-l border-black/10\">\n          <span className=\"text-lg opacity-40 hover:opacity-100 cursor-pointer\">‚≠ê</span>\n          <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 border border-white/20 shadow-sm flex items-center justify-center text-xs text-white font-black\">ST</div>\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-auto p-12 bg-zinc-50/30 sleek-scrollbar\">\n        <div className=\"max-w-4xl mx-auto space-y-12\">\n          <div className=\"flex items-center gap-8 animate-in fade-in slide-in-from-top-6 duration-1000\">\n            <div className=\"w-24 h-24 bg-[var(--brand-primary)] rounded-[2.5rem] flex items-center justify-center text-white text-5xl font-black shadow-2xl shadow-[var(--brand-primary)]/40 hover:scale-110 transition-transform cursor-pointer\">B</div>\n            <div className=\"space-y-1\">\n              <h1 className=\"text-5xl font-black text-slate-800 tracking-tighter\">BrightEd Portal</h1>\n              <p className=\"text-lg text-slate-500 font-bold uppercase tracking-widest opacity-60\">Operations & Logistics</p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-8\">\n            <PortalCard title=\"Mission briefing\" subtitle=\"Review active incident reports\" icon=\"üìã\" color=\"orange\" />\n            <PortalCard title=\"Knowledge hub\" subtitle=\"Technical guides & manuals\" icon=\"üìö\" color=\"emerald\" />\n          </div>\n\n          <div className=\"p-10 bg-slate-900 rounded-[3rem] text-white shadow-2xl relative overflow-hidden group border-4 border-white/5\">\n            <div className=\"absolute top-0 right-0 p-10 opacity-5 text-9xl transform rotate-12 group-hover:rotate-0 transition-all duration-700 pointer-events-none\">üìù</div>\n            <div className=\"relative z-10\">\n              <h2 className=\"text-2xl font-black mb-6 flex items-center gap-4\">\n                <span className=\"w-3 h-3 rounded-full bg-[var(--brand-primary)] animate-pulse shadow-[0_0_15px_var(--brand-primary)]\"></span>\n                System Handover Note\n              </h2>\n              <div className=\"h-[2px] w-full bg-white/10 mb-8 rounded-full\"></div>\n              <p className=\"text-lg font-bold text-white/80 leading-relaxed italic\">\n                &quot;Technician, we have a Level 2 incident in lab 4. The machines are screaming. CPU is pinned, fans are at 100%. I tried various kills but the process persists. Start with the registry and file system. I suspect a trojan hiding in plain sight.&quot;\n              </p>\n              <div className=\"mt-8 flex items-center gap-4 text-[11px] font-black text-white/30 uppercase tracking-[0.25em]\">\n                <div className=\"w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs\">DA</div>\n                <span>From: SeniorAdmin_Dave | Mar 21, 09:12 AM</span>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-blue-600/5 border-2 border-blue-600/10 p-6 rounded-[2.5rem] flex items-center gap-6 shadow-sm\">\n            <span className=\"text-3xl drop-shadow-md\">üí°</span>\n            <p className=\"text-sm text-blue-800/80 font-bold leading-relaxed\">\n              <strong className=\"text-blue-900 uppercase tracking-widest text-xs block mb-1\">Investigation Tip:</strong>\n              Malware often uses common system names to avoid suspicion. Check <code>HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</code> for suspicious startup entries.\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"h-8 bg-zinc-100/50 border-t border-black/5 px-8 flex items-center justify-between text-[10px] font-black text-black/30 uppercase tracking-[0.2em]\">\n        <div className=\"flex gap-6\">\n          <span>Done</span>\n          <span>v2.8.4-stable</span>\n        </div>\n        <div className=\"flex gap-6\">\n          <span>Connection: Secured (WPA3)</span>\n          <span>English (US)</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction PortalCard({ title, subtitle, icon, color }: any) {\n  const colors: any = {\n    orange: 'bg-orange-100 text-orange-600 border-orange-200',\n    emerald: 'bg-emerald-100 text-emerald-600 border-emerald-200'\n  };\n  return (\n    <div className=\"p-8 bg-white border border-slate-100 rounded-[2.5rem] shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all cursor-pointer group\">\n      <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:scale-110 group-hover:rotate-6 transition-all border-2 ${colors[color]}`}>\n        {icon}\n      </div>\n      <h3 className=\"text-xl font-black text-slate-800 mb-2 truncate\">{title}</h3>\n      <p className=\"text-[13px] text-slate-500 font-bold uppercase tracking-widest opacity-60 leading-tight\">{subtitle}</p>\n    </div>\n  );\n}\n\nfunction RecycleBin() {\n  return (\n    <div className=\"h-full bg-[#191919] flex flex-col font-sans select-none text-white selection:bg-[var(--brand-primary)]/30\">\n      {/* File Explorer Ribbon - Windows 11 Style */}\n      <div className=\"h-14 bg-black/20 border-b border-white/10 flex items-center px-6 gap-6\">\n        <div className=\"flex items-center gap-2\">\n          <button className=\"duo-btn duo-btn-primary h-9 px-4 text-[10px] flex items-center gap-2\">\n            <span>‚ûï</span> NEW\n          </button>\n          <div className=\"w-[1px] h-6 bg-white/10 mx-2\" />\n          <div className=\"flex items-center gap-4 text-white/40\">\n            <span className=\"text-lg opacity-20\">‚úÇÔ∏è</span>\n            <span className=\"text-lg opacity-20\">üìã</span>\n            <span className=\"text-lg opacity-20\">üè∑Ô∏è</span>\n            <span className=\"text-lg opacity-20\">üóëÔ∏è</span>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-4 ml-auto text-[11px] font-bold text-white/40\">\n          <button className=\"flex items-center gap-2 hover:text-white transition-colors\"><span>‚ÜïÔ∏è</span> SORT</button>\n          <button className=\"flex items-center gap-2 hover:text-white transition-colors\"><span>‚ò∞</span> VIEW</button>\n        </div>\n      </div >\n\n      {/* Breadcrumb Bar */}\n      <div className=\"h-10 border-b border-white/5 flex items-center px-6 gap-4 bg-black/10\">\n        <div className=\"flex items-center gap-4 text-white/40\">\n          <span>‚¨ÖÔ∏è</span>\n          <span>‚û°Ô∏è</span>\n          <span>‚¨ÜÔ∏è</span>\n        </div>\n        <div className=\"flex-1 h-7 bg-white/5 border border-white/10 rounded px-3 flex items-center gap-3 text-[11px] text-white/60\">\n          <span className=\"opacity-40\">üìÅ</span>\n          <span>This PC</span>\n          <span className=\"opacity-30\">&gt;</span>\n          <span>Recycle Bin</span>\n        </div>\n        <div className=\"w-48 h-7 bg-white/5 border border-white/10 rounded px-3 flex items-center gap-2 text-[11px] text-white/30\">\n          <span>üîç</span>\n          <span>Search Recycle Bin</span>\n        </div>\n      </div>\n\n      <div className=\"flex-1 flex\">\n        {/* Navigation Pane */}\n        <div className=\"w-56 border-r border-white/5 p-4 flex flex-col gap-1 text-[12px] font-medium text-white/70\">\n          <div className=\"px-3 py-1.5 hover:bg-white/5 rounded-lg flex items-center gap-3 transition-colors cursor-pointer\">\n            <span className=\"text-lg\">‚≠ê</span> Quick access\n          </div>\n          <div className=\"px-3 py-1.5 hover:bg-white/5 rounded-lg flex items-center gap-3 transition-colors cursor-pointer text-white font-bold bg-white/5\">\n            <span className=\"text-lg\">üñ•Ô∏è</span> This PC\n          </div>\n          <div className=\"px-3 py-1.5 hover:bg-white/5 rounded-lg flex items-center gap-3 transition-colors cursor-pointer\">\n            <span className=\"text-lg\">‚òÅÔ∏è</span> Cloud Storage\n          </div>\n          <div className=\"px-3 py-1.5 hover:bg-white/5 rounded-lg flex items-center gap-3 transition-colors cursor-pointer\">\n            <span className=\"text-lg\">üåê</span> Network\n          </div>\n        </div>\n\n        {/* File View */}\n        <div className=\"flex-1 p-10\">\n          <div className=\"flex flex-col items-center justify-center h-full opacity-10 gap-6 grayscale\">\n            <div className=\"w-32 h-32 bg-white/5 rounded-full flex items-center justify-center text-7xl shadow-inner\">üóëÔ∏è</div>\n            <div className=\"text-center space-y-2\">\n              <span className=\"text-xl font-black text-white block\">This folder is empty.</span>\n              <span className=\"text-sm text-white/60 max-w-xs block\">Deleted system files and quarantined threats will appear here.</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"h-7 bg-black/40 border-t border-white/5 px-6 flex items-center justify-between text-[10px] font-bold text-white/30 uppercase tracking-widest\">\n        <span>0 items</span>\n        <div className=\"flex items-center gap-6\">\n          <span>Size: 0 KB</span>\n          <span>Available: 512 GB</span>\n        </div>\n      </div>\n    </div >\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/profile/[username]/avatar/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[235,247],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4749,4752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4749,4752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5378,5381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5378,5381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5569,5572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5569,5572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":142,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5799,5802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5799,5802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6392,6395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6392,6395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":181,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7318,7321],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7318,7321],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":182,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7353,7356],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7353,7356],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":186,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7488,7491],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7488,7491],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'label' is defined but never used. Allowed unused args must match /^_/u.","line":434,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":434,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":434,"column":142,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":434,"endColumn":145,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25569,25572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25569,25572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'username' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":436,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":436,"endColumn":19}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { useParams, useRouter } from 'next/navigation';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { db } from '@/lib/firebase';\nimport { doc, updateDoc } from 'firebase/firestore';\nimport { createAvatar } from '@dicebear/core';\nimport { avataaars } from '@dicebear/collection';\n\n// --- OPTIONS DATA ---\n\nconst CHARACTER_PRESETS = [\n    {\n        id: 'scholar',\n        name: 'The Scholar',\n        description: 'Focused',\n        icon: 'üéì',\n        params: { top: 'shortFlat', hairColor: '2c1b18', clothing: 'blazerAndShirt', accessories: 'prescription01', eyes: 'default', mouth: 'smile', skinColor: 'ffdbb4' }\n    },\n    {\n        id: 'entrepreneur',\n        name: 'The Founder',\n        description: 'Bold',\n        icon: 'üíº',\n        params: { top: 'shavedSides', hairColor: '4a312c', clothing: 'graphicShirt', accessories: 'blank', eyes: 'wink', mouth: 'smile', skinColor: 'edb98a' }\n    },\n    {\n        id: 'visionary',\n        name: 'The Visionary',\n        description: 'Creative',\n        icon: '‚ú®',\n        params: { top: 'curly', hairColor: 'b58143', clothing: 'hoodie', accessories: 'round', eyes: 'happy', mouth: 'smile', skinColor: 'f8d25c' }\n    },\n    {\n        id: 'strategist',\n        name: 'The Strategist',\n        description: 'Logical',\n        icon: 'üõ°Ô∏è',\n        params: { top: 'dreads01', hairColor: '2c1b18', clothing: 'overall', accessories: 'blank', eyes: 'default', mouth: 'serious', skinColor: 'ae5d29' }\n    },\n    {\n        id: 'hacker',\n        name: 'The Tech Wiz',\n        description: 'Agile',\n        icon: 'üíª',\n        params: { top: 'frizzle', hairColor: '2c1b18', clothing: 'hoodie', accessories: 'wayfarers', eyes: 'default', mouth: 'smile', skinColor: '614335' }\n    },\n    {\n        id: 'artist',\n        name: 'The Artist',\n        description: 'Expressive',\n        icon: 'üé®',\n        params: { top: 'longButNotTooLong', hairColor: '724133', clothing: 'overall', accessories: 'blank', eyes: 'happy', mouth: 'smile', skinColor: 'ffdbb4' }\n    }\n];\n\nconst TOPS = {\n    masculine: [\n        'shortFlat', 'shavedSides', 'dreads01', 'frizzle', 'theCaesar', 'shortCurly', 'shortRound', 'shortWaved', 'sides', 'theCaesarAndSidePart', 'shaggy', 'bob'\n    ],\n    feminine: [\n        'curly', 'longButNotTooLong', 'straight02', 'straight01', 'straightAndStrand', 'curvy', 'dreads02', 'frida', 'fro', 'froBand', 'miaWallace', 'shaggyMullet'\n    ],\n    hats: ['hat', 'hijab', 'turban', 'winterHat1', 'winterHat02', 'winterHat03', 'winterHat04']\n};\n\nconst HAIR_COLORS = ['a55728', '2c1b18', 'b58143', 'd6b370', '724133', '4a312c', 'f59797', 'ecdcbf', 'c93305', 'e8e1e1'];\n\nconst EYES = ['default', 'closed', 'cry', 'eyeRoll', 'happy', 'hearts', 'side', 'squint', 'surprised', 'wink', 'winkWacky', 'xDizzy'];\n\nconst MOUTHS = ['smile', 'concerned', 'default', 'disbelief', 'eating', 'grimace', 'sad', 'screamOpen', 'serious', 'tongue', 'twinkle', 'vomit'];\n\nconst CLOTHING = {\n    masculine: ['blazerAndShirt', 'blazerAndSweater', 'collarAndSweater', 'graphicShirt', 'hoodie', 'shirtCrewNeck', 'shirtVNeck'],\n    feminine: ['shirtScoopNeck', 'overall', 'hoodie', 'graphicShirt', 'collarAndSweater', 'blazerAndSweater']\n};\n\nconst CLOTHES_COLORS = ['262e33', '65c9ff', '5199e4', '25557c', 'e6e6e6', '929598', '3c4f5c', 'b1e2ff', 'a7ffc4', 'ffdeb5', 'ffafb9', 'ffffb1', 'ff488e', 'ff5c5c', 'ffffff'];\n\nconst ACCESSORIES = ['blank', 'prescription01', 'prescription02', 'round', 'sunglasses', 'wayfarers', 'eyepatch'];\n\nconst FACIAL_HAIR = ['blank', 'beardLight', 'beardMajestic', 'beardMedium', 'moustacheFancy', 'moustacheMagnum'];\n\nconst SKIN_COLORS = ['614335', 'd08b5b', 'ae5d29', 'edb98a', 'ffdbb4', 'fd9841', 'f8d25c'];\n\nconst BACKGROUND_COLORS = [\n    { name: 'Coral', value: 'FF8A8A' },\n    { name: 'Emerald', value: '8AFF8A' },\n    { name: 'Azure', value: '8A8AFF' },\n    { name: 'Lemon', value: 'FFFFA1' },\n    { name: 'Lavender', value: 'FFA1FF' },\n    { name: 'Ice', value: 'A1FFF4' },\n    { name: 'Midnight', value: '2C3E50' },\n    { name: 'Gold', value: 'F1C40F' }\n];\n\ntype Category = 'Presets' | 'Hair' | 'Face' | 'Clothing' | 'Extras';\n\nexport default function AvatarCustomizationPage() {\n    const params = useParams();\n    const router = useRouter();\n    const { user, userData, loading: authLoading } = useAuth();\n    const [saving, setSaving] = useState(false);\n    const [activeCategory, setActiveCategory] = useState<Category>('Presets');\n    const [sex, setSex] = useState<'masculine' | 'feminine'>('masculine');\n\n    // Granular States\n    const [config, setConfig] = useState<any>({\n        top: 'shortFlat',\n        hairColor: '2c1b18',\n        eyes: 'default',\n        mouth: 'smile',\n        clothing: 'blazerAndShirt',\n        clothingColor: '262e33',\n        accessories: 'blank',\n        facialHair: 'blank',\n        skinColor: 'ffdbb4',\n        backgroundColor: 'FF8A8A'\n    });\n\n    const [hasInitialized, setHasInitialized] = useState(false);\n\n    useEffect(() => {\n        if (userData?.avatarCustomization && !hasInitialized) {\n            const saved = userData.avatarCustomization;\n            // Handle legacy clothesColor if it exists\n            const { clothesColor, ...rest } = saved as any;\n            const normalizedSaved = {\n                ...rest,\n                clothingColor: saved.clothingColor || clothesColor || '262e33'\n            };\n            setConfig((prev: any) => ({ ...prev, ...normalizedSaved }));\n            setHasInitialized(true);\n        }\n    }, [userData, hasInitialized]);\n\n    const username = params?.username as string;\n\n    const constructLocalSvg = React.useCallback((c: any) => {\n        const avatar = createAvatar(avataaars, {\n            seed: username,\n            backgroundColor: [c.backgroundColor],\n            top: [c.top],\n            hairColor: [c.hairColor],\n            clothing: [c.clothing],\n            clothesColor: [c.clothingColor],\n            accessories: [c.accessories],\n            eyes: [c.eyes],\n            mouth: [c.mouth],\n            skinColor: [c.skinColor],\n            facialHair: [c.facialHair],\n            backgroundType: ['solid']\n        });\n        return avatar.toString();\n    }, [username]);\n\n    const getCloudUrl = (c: any) => {\n        const seedValue = encodeURIComponent(username);\n        return `https://api.dicebear.com/9.x/avataaars/svg?seed=${seedValue}&backgroundType=solid&backgroundColor=${c.backgroundColor}&top=${c.top}&hairColor=${c.hairColor}&clothing=${c.clothing}&clothingColor=${c.clothingColor}&accessories=${c.accessories}&eyes=${c.eyes}&mouth=${c.mouth}&skinColor=${c.skinColor}&facialHair=${c.facialHair}`;\n    };\n\n    const handleSave = async () => {\n        if (!user) return;\n        setSaving(true);\n        try {\n            const url = getCloudUrl(config);\n            await updateDoc(doc(db, 'users', user.uid), {\n                avatarCustomization: config,\n                avatarUrl: url\n            });\n            router.push(`/profile/${username}`);\n        } catch (error) {\n            console.error(\"Error saving avatar:\", error);\n        }\n        setSaving(false);\n    };\n\n    const applyPreset = (preset: any) => {\n        setConfig((prev: any) => ({ ...prev, ...preset.params }));\n    };\n\n    const updateField = (field: string, value: string) => {\n        setConfig((prev: any) => ({ ...prev, [field]: value }));\n    };\n\n    const previewSvg = React.useMemo(() => constructLocalSvg(config), [config, constructLocalSvg]);\n\n    if (authLoading) return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n        </div>\n    );\n\n    const categories: Category[] = ['Presets', 'Hair', 'Face', 'Clothing', 'Extras'];\n\n    return (\n        <div className=\"h-screen bg-[var(--bg-primary)] overflow-hidden flex flex-col relative\">\n            <div className=\"max-w-6xl mx-auto w-full flex-1 flex flex-col gap-4 px-4 py-4 md:py-6\">\n\n                {/* Compact Header */}\n                <div className=\"flex items-center justify-between\">\n                    <button onClick={() => router.back()} className=\"flex items-center gap-1.5 text-[var(--text-muted)] hover:text-white transition-colors font-black uppercase text-[10px] tracking-widest\">\n                        <span>‚Üê</span> Back\n                    </button>\n                    <BrightHeading level={1} className=\"text-xl md:text-3xl tracking-tight text-center flex-1\">\n                        Character <span className=\"text-[var(--brand-primary)]\">Editor</span>\n                    </BrightHeading>\n                    <BrightButton variant=\"primary\" size=\"sm\" onClick={handleSave} isLoading={saving} className=\"px-6 py-2 text-xs\">\n                        Done\n                    </BrightButton>\n                </div>\n\n                <div className=\"flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 min-h-0 overflow-hidden\">\n\n                    {/* Preview Area */}\n                    <div className=\"flex flex-col items-center justify-center bg-[var(--bg-glass)] backdrop-blur-3xl rounded-[2.5rem] border border-white/5 relative overflow-hidden group shadow-xl h-full\">\n                        <div className=\"absolute inset-0 bg-gradient-to-br from-[var(--brand-primary)]/5 to-transparent pointer-events-none\" />\n\n                        {/* Sex Toggle */}\n                        <div className=\"absolute top-6 left-6 z-20 flex bg-white/5 p-1 rounded-2xl border border-white/10\">\n                            <button\n                                onClick={() => setSex('masculine')}\n                                className={`px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${sex === 'masculine' ? 'bg-[var(--brand-primary)] text-white' : 'text-white/40 hover:text-white'}`}\n                            >\n                                M\n                            </button>\n                            <button\n                                onClick={() => setSex('feminine')}\n                                className={`px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${sex === 'feminine' ? 'bg-[var(--brand-primary)] text-white' : 'text-white/40 hover:text-white'}`}\n                            >\n                                F\n                            </button>\n                        </div>\n\n                        <motion.div\n                            key={previewSvg}\n                            initial={{ scale: 0.95, opacity: 0 }}\n                            animate={{ scale: 1, opacity: 1 }}\n                            className=\"relative z-10 w-48 h-48 md:w-80 md:h-80 flex items-center justify-center p-4 bg-white/5 rounded-full border border-white/5 shadow-2xl overflow-hidden\"\n                            dangerouslySetInnerHTML={{ __html: previewSvg }}\n                        />\n\n                        <div className=\"mt-4 flex flex-col items-center gap-1\">\n                            <div className=\"px-6 py-2 bg-[var(--brand-primary)]/20 text-[var(--brand-primary)] rounded-full text-[10px] font-black uppercase tracking-[0.2em] border border-[var(--brand-primary)]/30\">\n                                Live Designer\n                            </div>\n                        </div>\n                    </div>\n\n                    {/* Editor Panel */}\n                    <div className=\"flex flex-col min-h-0 bg-[var(--bg-glass)] backdrop-blur-2xl rounded-[2.5rem] border border-white/10 shadow-xl relative overflow-hidden\">\n\n                        {/* Tab Navigation */}\n                        <div className=\"flex p-2 gap-1 border-b border-white/5 bg-white/[0.02]\">\n                            {categories.map(cat => (\n                                <button\n                                    key={cat}\n                                    onClick={() => setActiveCategory(cat)}\n                                    className={`flex-1 py-3 px-2 rounded-2xl text-[9px] font-black uppercase tracking-widest transition-all ${activeCategory === cat ? 'bg-white/10 text-white border border-white/10' : 'text-[var(--text-muted)] hover:text-white'}`}\n                                >\n                                    {cat}\n                                </button>\n                            ))}\n                        </div>\n\n                        <div className=\"flex-1 overflow-y-auto p-5 md:p-8 custom-scrollbar\">\n                            <AnimatePresence mode=\"wait\">\n                                <motion.div\n                                    key={activeCategory}\n                                    initial={{ opacity: 0, x: 20 }}\n                                    animate={{ opacity: 1, x: 0 }}\n                                    exit={{ opacity: 0, x: -20 }}\n                                    transition={{ duration: 0.2 }}\n                                    className=\"space-y-8\"\n                                >\n                                    {activeCategory === 'Presets' && (\n                                        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3\">\n                                            {CHARACTER_PRESETS.map((preset) => (\n                                                <button\n                                                    key={preset.id}\n                                                    onClick={() => applyPreset(preset)}\n                                                    className={`p-3 rounded-2xl border-2 transition-all flex flex-col items-center gap-2 group relative overflow-hidden ${config.presetId === preset.id ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)]/10 shadow-lg' : 'border-white/5 bg-white/[0.02] hover:bg-white/5 hover:border-white/10'}`}\n                                                >\n                                                    <div className=\"text-2xl group-hover:scale-110 transition-transform\">{preset.icon}</div>\n                                                    <div className=\"text-center min-w-0\">\n                                                        <div className=\"font-black text-[10px] tracking-tight\">{preset.name}</div>\n                                                    </div>\n                                                </button>\n                                            ))}\n                                        </div>\n                                    )}\n\n                                    {activeCategory === 'Hair' && (\n                                        <>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Styles</h3>\n                                                <div className=\"grid grid-cols-4 gap-2\">\n                                                    {[...TOPS[sex], ...TOPS.hats].map(t => (\n                                                        <OptionButton\n                                                            key={t}\n                                                            active={config.top === t}\n                                                            onClick={() => updateField('top', t)}\n                                                            label={t}\n                                                            type=\"top\"\n                                                            config={{ ...config, top: t }}\n                                                        />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Colors</h3>\n                                                <div className=\"flex flex-wrap gap-2\">\n                                                    {HAIR_COLORS.map(c => (\n                                                        <ColorCircle\n                                                            key={c}\n                                                            color={c}\n                                                            active={config.hairColor === c}\n                                                            onClick={() => updateField('hairColor', c)}\n                                                        />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                        </>\n                                    )}\n\n                                    {activeCategory === 'Face' && (\n                                        <>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Skin Tone</h3>\n                                                <div className=\"flex flex-wrap gap-2\">\n                                                    {SKIN_COLORS.map(c => (\n                                                        <ColorCircle\n                                                            key={c}\n                                                            color={c}\n                                                            active={config.skinColor === c}\n                                                            onClick={() => updateField('skinColor', c)}\n                                                        />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                            <div className=\"grid grid-cols-2 gap-8\">\n                                                <div className=\"space-y-4\">\n                                                    <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Eyes</h3>\n                                                    <div className=\"grid grid-cols-3 gap-2\">\n                                                        {EYES.map(e => (\n                                                            <OptionButton key={e} active={config.eyes === e} onClick={() => updateField('eyes', e)} label={e} type=\"face\" config={{ ...config, eyes: e }} />\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                                <div className=\"space-y-4\">\n                                                    <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Mouth</h3>\n                                                    <div className=\"grid grid-cols-3 gap-2\">\n                                                        {MOUTHS.map(m => (\n                                                            <OptionButton key={m} active={config.mouth === m} onClick={() => updateField('mouth', m)} label={m} type=\"face\" config={{ ...config, mouth: m }} />\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </>\n                                    )}\n\n                                    {activeCategory === 'Clothing' && (\n                                        <>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Outfits</h3>\n                                                <div className=\"grid grid-cols-4 gap-2\">\n                                                    {CLOTHING[sex].map(c => (\n                                                        <OptionButton key={c} active={config.clothing === c} onClick={() => updateField('clothing', c)} label={c} type=\"clothing\" config={{ ...config, clothing: c }} />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Colors</h3>\n                                                <div className=\"flex flex-wrap gap-2\">\n                                                    {CLOTHES_COLORS.map(c => (\n                                                        <ColorCircle key={c} color={c} active={config.clothingColor === c} onClick={() => updateField('clothingColor', c)} />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                        </>\n                                    )}\n\n                                    {activeCategory === 'Extras' && (\n                                        <>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Accessories</h3>\n                                                <div className=\"grid grid-cols-4 gap-2\">\n                                                    {ACCESSORIES.map(a => (\n                                                        <OptionButton key={a} active={config.accessories === a} onClick={() => updateField('accessories', a)} label={a} type=\"extras\" config={{ ...config, accessories: a }} />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Facial Hair</h3>\n                                                <div className=\"grid grid-cols-4 gap-2\">\n                                                    {FACIAL_HAIR.map(f => (\n                                                        <OptionButton key={f} active={config.facialHair === f} onClick={() => updateField('facialHair', f)} label={f} type=\"extras\" config={{ ...config, facialHair: f }} />\n                                                    ))}\n                                                </div>\n                                            </div>\n                                            <div className=\"space-y-4\">\n                                                <h3 className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Scene Background</h3>\n                                                <div className=\"grid grid-cols-4 gap-2\">\n                                                    {BACKGROUND_COLORS.map(c => (\n                                                        <button key={c.value} onClick={() => updateField('backgroundColor', c.value)} className={`aspect-square rounded-xl border-2 transition-all group relative overflow-hidden ${config.backgroundColor === c.value ? 'border-[var(--brand-primary)] scale-105 shadow-md' : 'border-white/5 hover:border-white/20'}`}>\n                                                            <div className=\"absolute inset-0\" style={{ backgroundColor: `#${c.value}` }} />\n                                                            {config.backgroundColor === c.value && <div className=\"absolute inset-0 flex items-center justify-center text-white text-[10px] drop-shadow-md\">‚úì</div>}\n                                                        </button>\n                                                    ))}\n                                                </div>\n                                            </div>\n                                        </>\n                                    )}\n                                </motion.div>\n                            </AnimatePresence>\n                        </div>\n\n                        {/* Minimal Footer */}\n                        <div className=\"p-4 border-t border-white/5 flex items-center justify-between opacity-30 px-8\">\n                            <span className=\"text-[8px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Dicebear Avataaars v9</span>\n                            <span className=\"text-[8px] font-bold text-white tracking-widest uppercase\">Deep Custom v2.0</span>\n                        </div>\n                    </div>\n\n                </div>\n            </div>\n        </div>\n    );\n}\n\nfunction OptionButton({ active, onClick, label, type, config }: { active: boolean, onClick: () => void, label: string, type: string, config: any }) {\n    const params = useParams();\n    const username = (params?.username as string) || 'test';\n\n    const svg = React.useMemo(() => {\n        const avatar = createAvatar(avataaars, {\n            seed: 'test',\n            top: [config.top],\n            clothing: [config.clothing],\n            accessories: [config.accessories],\n            eyes: [config.eyes],\n            mouth: [config.mouth],\n            skinColor: [config.skinColor],\n            facialHair: [config.facialHair],\n            hairColor: [config.hairColor],\n            clothesColor: [config.clothingColor],\n        });\n        return avatar.toString();\n    }, [config]);\n\n    return (\n        <button\n            onClick={onClick}\n            className={`aspect-square rounded-2xl border-2 transition-all overflow-hidden bg-white/5 flex flex-col items-center justify-center p-1 group relative ${active ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)]/10' : 'border-white/5 hover:border-white/10'}`}\n        >\n            <div className=\"w-full h-full relative overflow-hidden flex items-center justify-center\">\n                <div\n                    className={`w-[200%] h-[200%] absolute ${type === 'face' ? '-top-12' : type === 'top' ? '-top-4' : type === 'clothing' ? '-top-28' : '-top-10'}`}\n                    dangerouslySetInnerHTML={{ __html: svg }}\n                />\n            </div>\n            {active && <div className=\"absolute top-1 right-1 text-[var(--brand-primary)] text-[8px]\">‚úì</div>}\n        </button>\n    );\n}\n\nfunction ColorCircle({ color, active, onClick }: { color: string, active: boolean, onClick: () => void }) {\n    return (\n        <button\n            onClick={onClick}\n            className={`w-8 h-8 rounded-full border-2 transition-all p-0.5 ${active ? 'border-[var(--brand-primary)] scale-110 shadow-lg' : 'border-white/5 hover:border-white/20'}`}\n        >\n            <div className=\"w-full h-full rounded-full\" style={{ backgroundColor: `#${color}` }} />\n        </button>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/profile/[username]/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1065,1068],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1065,1068],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2770,2773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2770,2773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5075,5078],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5075,5078],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5638,5641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5638,5641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'xp' is defined but never used. Allowed unused args must match /^_/u.","line":494,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":494,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isOpen' is defined but never used. Allowed unused args must match /^_/u.","line":522,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":522,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onFollow' is defined but never used. Allowed unused args must match /^_/u.","line":522,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":522,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":522,"column":123,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":522,"endColumn":126,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28931,28934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28931,28934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":524,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":524,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29059,29062],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29059,29062],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isOpen' is defined but never used. Allowed unused args must match /^_/u.","line":640,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":640,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onFollow' is defined but never used. Allowed unused args must match /^_/u.","line":640,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":640,"endColumn":78},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":640,"column":174,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":640,"endColumn":177,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35603,35606],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35603,35606],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":642,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":642,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35733,35736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35733,35736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { useParams, useRouter } from 'next/navigation';\nimport Link from 'next/link';\nimport Image from 'next/image';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { db } from '@/lib/firebase';\nimport { collection, query, where, getDocs, doc, getDoc, updateDoc, arrayUnion, arrayRemove, limit } from 'firebase/firestore';\nimport { ProfessorBrightMascot } from '@/components/learning';\nimport { ALL_ACHIEVEMENTS, checkAchievement } from '@/lib/achievements';\nimport { createAvatar } from '@dicebear/core';\nimport { avataaars } from '@dicebear/collection';\nimport { resolveMasteryPercent } from '@/lib/user-stats';\n\nexport default function UserProfilePage() {\n    const params = useParams();\n    const router = useRouter();\n    const { user, userData: currentUserData, loading: authLoading } = useAuth();\n    const [profileData, setProfileData] = useState<any>(null);\n    const [loading, setLoading] = useState(true);\n    const [isOwner, setIsOwner] = useState(false);\n    const [showSearch, setShowSearch] = useState(false);\n    const [showSocialModal, setShowSocialModal] = useState(false);\n\n    const username = params?.username as string;\n\n    useEffect(() => {\n        if (authLoading) return;\n\n        const fetchProfile = async () => {\n            setLoading(true);\n            try {\n                // If it's the current user, use local data for speed\n                if (currentUserData?.username === username) {\n                    setProfileData(currentUserData);\n                    setIsOwner(true);\n                    setLoading(false);\n                    return;\n                }\n\n                // Otherwise search Firestore by username\n                const usersRef = collection(db, 'users');\n                const q = query(usersRef, where('username', '==', username));\n                const snapshot = await getDocs(q);\n\n                if (snapshot.empty) {\n                    // Handle 404\n                    setLoading(false);\n                    return;\n                }\n\n                const data = snapshot.docs[0].data();\n                setProfileData({ ...data, id: snapshot.docs[0].id });\n                setIsOwner(user?.uid === snapshot.docs[0].id);\n            } catch (error) {\n                console.error(\"Error fetching profile:\", error);\n            }\n            setLoading(false);\n        };\n\n        fetchProfile();\n    }, [username, currentUserData, authLoading, user]);\n\n    const [socialTab, setSocialTab] = useState<'following' | 'followers'>('following');\n    const [socialList, setSocialList] = useState<any[]>([]);\n    const [socialLoading, setSocialLoading] = useState(false);\n    const [bizValuation, setBizValuation] = useState(0);\n    const masteryPercent = resolveMasteryPercent(profileData);\n\n    useEffect(() => {\n        const fetchSocialDetails = async () => {\n            if (!profileData) return;\n\n            // Fetch business if exists\n            if (profileData.businessID) {\n                try {\n                    const bizSnap = await getDoc(doc(db, 'businesses', profileData.businessID));\n                    if (bizSnap.exists()) {\n                        setBizValuation(bizSnap.data().valuation || 0);\n                    }\n                } catch (e) {\n                    console.error(\"Error fetching biz:\", e);\n                }\n            }\n\n            const ids = socialTab === 'following' ? (profileData.following || []) : (profileData.followers || []);\n\n            if (ids.length === 0) {\n                setSocialList([]);\n                return;\n            }\n\n            setSocialLoading(true);\n            try {\n                const details = await Promise.all(ids.slice(0, 5).map(async (id: string) => {\n                    const d = await getDoc(doc(db, 'users', id));\n                    return d.exists() ? { id: d.id, ...d.data() } : null;\n                }));\n                setSocialList(details.filter(Boolean));\n            } catch (error) {\n                console.error(\"Error fetching social details:\", error);\n            }\n            setSocialLoading(false);\n        };\n\n        fetchSocialDetails();\n    }, [profileData, socialTab]);\n\n    const isFollowing = currentUserData?.following?.includes(profileData?.id);\n\n    const handleFollowToggle = async () => {\n        if (!user || !profileData || !currentUserData) return;\n\n        const currentUserId = user.uid;\n        const profileUserId = profileData.id;\n\n        try {\n            if (isFollowing) {\n                // Unfollow\n                await updateDoc(doc(db, 'users', currentUserId), {\n                    following: arrayRemove(profileUserId)\n                });\n                await updateDoc(doc(db, 'users', profileUserId), {\n                    followers: arrayRemove(currentUserId)\n                });\n\n                // Optimistic Update\n                setProfileData((prev: any) => ({\n                    ...prev,\n                    followers: prev.followers.filter((id: string) => id !== currentUserId)\n                }));\n            } else {\n                // Follow\n                await updateDoc(doc(db, 'users', currentUserId), {\n                    following: arrayUnion(profileUserId)\n                });\n                await updateDoc(doc(db, 'users', profileUserId), {\n                    followers: arrayUnion(currentUserId)\n                });\n\n                // Optimistic Update\n                setProfileData((prev: any) => ({\n                    ...prev,\n                    followers: [...(prev.followers || []), currentUserId]\n                }));\n            }\n\n            // Force refresh of social list if open\n            setSocialTab(prev => prev);\n        } catch (error) {\n            console.error(\"Error toggling follow:\", error);\n            // Revert on error (could implement full revert logic here, simplicity for now)\n        }\n    };\n\n    // Local SVG Generation for Profile - Moved UP to fix Rules of Hooks\n    const avatarSvg = React.useMemo(() => {\n        if (profileData?.avatarCustomization) {\n            const c = profileData.avatarCustomization;\n            const avatar = createAvatar(avataaars, {\n                seed: username,\n                backgroundColor: [c.backgroundColor || 'FF8A8A'],\n                top: [c.top || 'shortFlat'],\n                hairColor: [c.hairColor || '2c1b18'],\n                clothing: [c.clothing || 'blazerAndShirt'],\n                clothesColor: [c.clothingColor || c.clothesColor || '262e33'],\n                accessories: [c.accessories || 'blank'],\n                eyes: [c.eyes || 'default'],\n                mouth: [c.mouth || 'smile'],\n                skinColor: [c.skinColor || 'ffdbb4'],\n                facialHair: [c.facialHair || 'blank'],\n                backgroundType: ['solid']\n            });\n            return avatar.toString();\n        }\n        return null;\n    }, [profileData?.avatarCustomization, username]);\n\n    if (loading || authLoading) {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center\">\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n            </div>\n        );\n    }\n\n    if (!profileData) {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col items-center justify-center p-4\">\n                <div className=\"text-6xl mb-6\">üèúÔ∏è</div>\n                <BrightHeading level={1} className=\"mb-4\">User Not Found</BrightHeading>\n                <p className=\"text-[var(--text-muted)] mb-8\">The explorer &quot;{username}&quot; hasn&apos;t joined BrightEd yet.</p>\n                <BrightButton onClick={() => router.push('/')}>Back to Safety</BrightButton>\n            </div>\n        );\n    }\n\n    const JOIN_DATE = profileData.createdAt\n        ? new Date(profileData.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })\n        : 'November 2023';\n\n    const fallbackAvatarUrl = `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(username)}&backgroundType=solid&backgroundColor=FF8A8A`;\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] pb-24 pt-20 safe-padding\">\n            <div className=\"max-w-6xl mx-auto px-4\">\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n\n                    {/* Main Profile Info */}\n                    <div className=\"lg:col-span-2 space-y-12\">\n\n                        {/* Identity Header */}\n                        <section className=\"relative group\">\n                            <div className=\"flex flex-col md:flex-row items-center md:items-start gap-8\">\n                                {/* Avatar */}\n                                <div className=\"relative\">\n                                    <div className=\"w-40 h-40 md:w-52 md:h-52 rounded-full overflow-hidden border-4 border-[var(--brand-primary)] shadow-2xl relative bg-white/5\">\n                                        <div className=\"absolute inset-0 bg-gradient-to-br from-[var(--brand-primary)]/20 to-transparent pointer-events-none\" />\n                                        {avatarSvg ? (\n                                            <div\n                                                className=\"w-full h-full\"\n                                                dangerouslySetInnerHTML={{ __html: avatarSvg }}\n                                            />\n                                        ) : (\n                                            <Image\n                                                src={profileData.avatarUrl || fallbackAvatarUrl}\n                                                alt={username}\n                                                fill\n                                                sizes=\"(max-width: 768px) 160px, 208px\"\n                                                className=\"object-cover\"\n                                            />\n                                        )}\n                                    </div>\n                                    {isOwner && (\n                                        <Link href={`/profile/${username}/avatar`}>\n                                            <button className=\"absolute bottom-2 right-2 bg-[var(--brand-primary)] text-white p-2 rounded-full shadow-lg border-2 border-[var(--bg-primary)] hover:scale-110 transition-transform\">\n                                                ‚úèÔ∏è\n                                            </button>\n                                        </Link>\n                                    )}\n                                </div>\n\n                                {/* Names & Social */}\n                                <div className=\"flex-1 text-center md:text-left pt-4\">\n                                    <BrightHeading level={1} className=\"text-4xl md:text-5xl mb-2\">\n                                        {profileData.firstName || username} {profileData.lastName || ''}\n                                    </BrightHeading>\n                                    <p className=\"text-xl font-bold text-[var(--text-muted)] mb-4\">@{username}</p>\n\n                                    <div className=\"flex items-center justify-center md:justify-start gap-2 mb-2 text-[var(--text-secondary)] font-medium\">\n                                        <span>üìÖ Joined {JOIN_DATE}</span>\n                                    </div>\n\n                                    {(profileData.school || profileData.country) && (\n                                        <div className=\"flex flex-wrap items-center justify-center md:justify-start gap-3 mb-6 text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider\">\n                                            {profileData.formLevel && (\n                                                <span className=\"bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] px-2 py-1 rounded border border-[var(--brand-primary)]/20\">\n                                                    Form {profileData.formLevel}\n                                                </span>\n                                            )}\n                                            {profileData.school && (\n                                                <span className=\"flex items-center gap-1\">\n                                                    üè´ {profileData.school}\n                                                </span>\n                                            )}\n                                            {profileData.country && (\n                                                <span className=\"flex items-center gap-1 opacity-70\">\n                                                    üìç {profileData.country}\n                                                </span>\n                                            )}\n                                        </div>\n                                    )}\n\n                                    <div className=\"flex items-center justify-center md:justify-start gap-4 mb-6\">\n                                        <div className=\"flex items-center gap-6\">\n                                            <div className=\"cursor-pointer group\">\n                                                <span className=\"text-[var(--brand-primary)] font-black text-xl group-hover:underline\">{profileData.following?.length || 0}</span>\n                                                <span className=\"text-[var(--text-muted)] font-bold ml-1 uppercase text-xs tracking-widest\">Following</span>\n                                            </div>\n                                            <div className=\"cursor-pointer group\">\n                                                <span className=\"text-[var(--brand-accent)] font-black text-xl group-hover:underline\">{profileData.followers?.length || 0}</span>\n                                                <span className=\"text-[var(--text-muted)] font-bold ml-1 uppercase text-xs tracking-widest\">Followers</span>\n                                            </div>\n                                        </div>\n\n                                        {!isOwner && user && (\n                                            <BrightButton\n                                                variant={isFollowing ? \"outline\" : \"primary\"}\n                                                size=\"sm\"\n                                                onClick={handleFollowToggle}\n                                                className=\"ml-4\"\n                                            >\n                                                {isFollowing ? \"Unfollow\" : \"Follow\"}\n                                            </BrightButton>\n                                        )}\n                                    </div>\n\n                                    {/* Owner-Only Action Buttons */}\n                                    {isOwner && (\n                                        <div className=\"flex flex-wrap items-center justify-center md:justify-start gap-3\">\n                                            <Link href={`/profile/${username}/avatar`}>\n                                                <BrightButton variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                                                    ‚úèÔ∏è Edit Avatar\n                                                </BrightButton>\n                                            </Link>\n                                            <Link href={`/profile/${username}/settings`}>\n                                                <BrightButton variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                                                    ‚öôÔ∏è Settings\n                                                </BrightButton>\n                                            </Link>\n                                            {profileData.hasBusiness && (\n                                                <Link href=\"/business\">\n                                                    <BrightButton variant=\"primary\" size=\"sm\" className=\"gap-2\">\n                                                        üè¢ My Business\n                                                    </BrightButton>\n                                                </Link>\n                                            )}\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        </section>\n\n                        <hr className=\"border-white/5\" />\n\n                        {/* Statistics Grid - Expanded for Owners */}\n                        <section>\n                            <BrightHeading level={2} className=\"mb-6\">Statistics</BrightHeading>\n                            <div className={`grid gap-4 ${isOwner ? 'grid-cols-2 md:grid-cols-4' : 'grid-cols-2'}`}>\n                                <StatCard icon=\"üî•\" label=\"Day Streak\" value={profileData.streak || 0} color=\"text-orange-500\" />\n                                <StatCard icon=\"‚ö°\" label=\"Total XP\" value={profileData.xp?.toLocaleString() || 0} color=\"text-yellow-500\" />\n                                {isOwner && (\n                                    <>\n                                        <StatCard icon=\"üí∞\" label=\"B-Coins\" value={profileData.bCoins?.toLocaleString() || 0} color=\"text-[var(--brand-primary)]\" />\n                                        <StatCard icon=\"üß†\" label=\"Mastery\" value={`${masteryPercent}%`} color=\"text-purple-500\" />\n                                    </>\n                                )}\n                            </div>\n                        </section>\n\n                        <hr className=\"border-white/5\" />\n\n                        {/* Trophy Case */}\n                        <section>\n                            <div className=\"flex justify-between items-end mb-6\">\n                                <BrightHeading level={2}>Trophy Case</BrightHeading>\n                                <Link href=\"/achievements\" className=\"text-[var(--brand-primary)] font-black uppercase text-xs tracking-widest hover:underline\">View All</Link>\n                            </div>\n                            <div className=\"grid grid-cols-3 md:grid-cols-4 gap-4\">\n                                {ALL_ACHIEVEMENTS.map((ach) => {\n                                    const isUnlocked = checkAchievement(ach, profileData, bizValuation);\n                                    return (\n                                        <div key={ach.id} className=\"flex flex-col items-center group\">\n                                            <div className={`w-20 h-20 md:w-24 md:h-24 rounded-3xl bg-white/5 border-2 flex items-center justify-center text-4xl mb-2 transition-all duration-500 ${isUnlocked ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)]/10 shadow-lg shadow-[var(--brand-primary)]/20' : 'border-white/5 grayscale opacity-30 group-hover:opacity-50'}`}>\n                                                {ach.icon}\n                                            </div>\n                                            <span className={`text-[10px] font-black uppercase tracking-wider text-center ${isUnlocked ? 'text-white' : 'text-[var(--text-muted)]'}`}>\n                                                {ach.name}\n                                            </span>\n                                        </div>\n                                    );\n                                })}\n                            </div>\n                        </section>\n\n                    </div>\n\n                    {/* Sidebar */}\n                    <div className=\"lg:col-span-1 space-y-8\">\n                        {/* Friends/Following Sections */}\n                        <BrightLayer variant=\"glass\" padding=\"none\" className=\"overflow-hidden\">\n                            <div className=\"p-4 border-b border-white/5 flex gap-4\">\n                                <button\n                                    onClick={() => setSocialTab('following')}\n                                    className={`flex-1 pb-2 transition-all text-sm font-black uppercase tracking-widest ${socialTab === 'following' ? 'border-b-2 border-[var(--brand-primary)] text-white' : 'text-[var(--text-muted)] hover:text-white'}`}\n                                >\n                                    Following\n                                </button>\n                                <button\n                                    onClick={() => setSocialTab('followers')}\n                                    className={`flex-1 pb-2 transition-all text-sm font-black uppercase tracking-widest ${socialTab === 'followers' ? 'border-b-2 border-[var(--brand-primary)] text-white' : 'text-[var(--text-muted)] hover:text-white'}`}\n                                >\n                                    Followers\n                                </button>\n                            </div>\n                            <div className=\"divide-y divide-white/5\">\n                                {socialLoading ? (\n                                    <div className=\"p-8 flex justify-center\"><div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--brand-primary)]\" /></div>\n                                ) : socialList.length > 0 ? (\n                                    socialList.map(friend => (\n                                        <FriendRow\n                                            key={friend.id}\n                                            name={friend.firstName || friend.username || 'Explorer'}\n                                            username={friend.username}\n                                            sub={friend.streak ? `${friend.streak} day streak` : `${friend.xp || 0} XP`}\n                                            xp={friend.xp}\n                                        />\n                                    ))\n                                ) : (\n                                    <div className=\"p-8 text-center text-xs text-[var(--text-muted)] font-bold uppercase tracking-widest\">No {socialTab} yet</div>\n                                )}\n                            </div>\n                            {socialList.length > 0 && (\n                                <div className=\"p-4 bg-white/5 border-t border-white/5\">\n                                    <button\n                                        onClick={() => setShowSocialModal(true)}\n                                        className=\"w-full text-center text-xs font-black uppercase tracking-[0.2em] text-[var(--brand-primary)] hover:underline\"\n                                    >\n                                        View All\n                                    </button>\n                                </div>\n                            )}\n                        </BrightLayer>\n\n\n                        {/* Add Friends */}\n                        <BrightLayer variant=\"glass\" padding=\"md\" className=\"space-y-4\">\n                            <BrightHeading level={3} className=\"text-lg\">Add Friends</BrightHeading>\n                            <div className=\"space-y-2\">\n                                <button\n                                    onClick={() => setShowSearch(true)}\n                                    className=\"w-full flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors group\"\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <span className=\"text-xl\">üîç</span>\n                                        <span className=\"font-bold text-sm\">Find friends</span>\n                                    </div>\n                                    <span className=\"text-[var(--text-muted)] group-hover:translate-x-1 transition-transform\">‚Ä∫</span>\n                                </button>\n                                <button className=\"w-full flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors group\">\n                                    <div className=\"flex items-center gap-3\">\n                                        <span className=\"text-xl\">‚úâÔ∏è</span>\n                                        <span className=\"font-bold text-sm\">Invite friends</span>\n                                    </div>\n                                    <span className=\"text-[var(--text-muted)] group-hover:translate-x-1 transition-transform\">‚Ä∫</span>\n                                </button>\n                            </div>\n                        </BrightLayer>\n                    </div>\n\n                </div>\n            </div>\n\n            {/* User Search Modal */}\n            <AnimatePresence>\n                {showSearch && (\n                    <UserSearchModal\n                        isOpen={showSearch}\n                        onClose={() => setShowSearch(false)}\n                        currentUser={currentUserData}\n                        onFollow={handleFollowToggle}\n                    />\n                )}\n                {showSocialModal && (\n                    <SocialListModal\n                        isOpen={showSocialModal}\n                        onClose={() => setShowSocialModal(false)}\n                        initialTab={socialTab}\n                        profileData={profileData}\n                        onFollow={handleFollowToggle} // Recycled but works for quick toggle if logic matches\n                    />\n                )}\n            </AnimatePresence>\n\n            {/* Mascot */}\n            <ProfessorBrightMascot\n                feedback={{\n                    tone: 'encouraging',\n                    message: isOwner ? \"Your profile is looking sharp! Keep it up.\" : `Checking out ${username}'s progress? They're doing great!`,\n                    emoji: 'ü¶â',\n                    spriteClass: 'owl-magic'\n                }}\n            />\n        </div>\n    );\n}\n\nfunction StatCard({ icon, label, value, subtext, color }: { icon: string, label: string, value: string | number, subtext?: string, color: string }) {\n    return (\n        <BrightLayer variant=\"elevated\" padding=\"md\" className=\"flex flex-col items-center justify-center text-center gap-3 border-b-[6px] border-black/10 hover:border-white/10 transition-colors min-h-[140px]\">\n            <div className={`text-4xl ${color} bg-white/5 p-3 rounded-2xl shadow-inner mb-1`}>{icon}</div>\n            <div className=\"w-full overflow-hidden\">\n                <div className=\"text-2xl font-black leading-none mb-1\">{value}</div>\n                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)] whitespace-nowrap\">{label}</div>\n                {subtext && <div className=\"text-[10px] font-bold text-[var(--brand-primary)] uppercase mt-1\">{subtext}</div>}\n            </div>\n        </BrightLayer>\n    );\n}\n\nfunction FriendRow({ name, username, sub, xp }: { name: string, username: string, sub: string, xp?: number }) {\n    return (\n        <Link href={`/profile/${username}`} className=\"block\">\n            <div className=\"p-4 flex items-center justify-between group hover:bg-white/[0.02] transition-colors\">\n                <div className=\"flex items-center gap-3\">\n                    <div className=\"w-10 h-10 rounded-full border border-white/10 shadow-lg overflow-hidden flex items-center justify-center bg-white/5 group-hover:scale-105 transition-transform\">\n                        <div className=\"relative w-full h-full\">\n                            <Image\n                                src={`https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(username)}&backgroundType=solid&backgroundColor=FF8A8A`}\n                                alt={username}\n                                fill\n                                sizes=\"40px\"\n                                className=\"object-cover\"\n                            />\n                        </div>\n                    </div>\n                    <div>\n                        <div className=\"font-black text-sm group-hover:text-[var(--brand-primary)] transition-colors\">{name}</div>\n                        <div className=\"text-[10px] text-[var(--text-muted)] font-bold tracking-tight\">{sub}</div>\n                    </div>\n                </div>\n                <div className=\"text-[10px] text-[var(--text-muted)] font-black uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity\">\n                    View\n                </div>\n            </div>\n        </Link>\n    );\n}\nfunction UserSearchModal({ isOpen, onClose, currentUser, onFollow }: { isOpen: boolean, onClose: () => void, currentUser: any, onFollow: () => void }) {\n    const [searchTerm, setSearchTerm] = useState('');\n    const [results, setResults] = useState<any[]>([]);\n    const [loading, setLoading] = useState(false);\n\n    useEffect(() => {\n        const searchUsers = async () => {\n            setLoading(true);\n            try {\n                const usersRef = collection(db, 'users');\n                let q;\n\n                if (searchTerm.length < 2) {\n                    // Show suggested users when search is empty\n                    q = query(usersRef, limit(6));\n                } else {\n                    // prefix search\n                    q = query(\n                        usersRef,\n                        where('username', '>=', searchTerm.toLowerCase()),\n                        where('username', '<=', searchTerm.toLowerCase() + '\\uf8ff'),\n                        limit(6)\n                    );\n                }\n\n                const snap = await getDocs(q);\n                const users = snap.docs\n                    .map(doc => ({ id: doc.id, ...doc.data() }))\n                    .filter(u => u.id !== currentUser?.id);\n                setResults(users);\n            } catch (e) {\n                console.error(\"Search error:\", e);\n            }\n            setLoading(false);\n        };\n\n        const timer = setTimeout(searchUsers, searchTerm.length < 2 ? 0 : 300);\n        return () => clearTimeout(timer);\n    }, [searchTerm, currentUser]);\n\n    return (\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-6\">\n            <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                exit={{ opacity: 0 }}\n                onClick={onClose}\n                className=\"absolute inset-0 bg-black/60 backdrop-blur-md\"\n            />\n\n            <motion.div\n                initial={{ scale: 0.9, opacity: 0, y: 20 }}\n                animate={{ scale: 1, opacity: 1, y: 0 }}\n                exit={{ scale: 0.9, opacity: 0, y: 20 }}\n                className=\"relative w-full max-w-xl bg-[var(--bg-glass)] rounded-[3rem] border border-white/10 shadow-2xl overflow-hidden nebula-stroke\"\n            >\n                <div className=\"p-8\">\n                    <div className=\"flex items-center justify-between mb-8\">\n                        <BrightHeading level={2}>Find Friends</BrightHeading>\n                        <button onClick={onClose} className=\"text-[var(--text-muted)] hover:text-white text-2xl\">‚úï</button>\n                    </div>\n\n                    <div className=\"relative mb-8\">\n                        <div className=\"absolute left-5 top-1/2 -translate-y-1/2 text-xl opacity-40\">üîç</div>\n                        <input\n                            autoFocus\n                            type=\"text\"\n                            placeholder=\"Search by username...\"\n                            value={searchTerm}\n                            onChange={(e) => setSearchTerm(e.target.value)}\n                            className=\"w-full bg-white/5 border-2 border-white/10 rounded-2xl py-4 pl-14 pr-6 font-bold focus:border-[var(--brand-primary)] focus:bg-white/[0.08] outline-none transition-all\"\n                        />\n                    </div>\n\n                    <div className=\"space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar\">\n                        {loading ? (\n                            <div className=\"p-8 flex justify-center\"><div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--brand-primary)]\" /></div>\n                        ) : results.length > 0 ? (\n                            results.map(u => (\n                                <Link key={u.id} href={`/profile/${u.username}`} onClick={onClose}>\n                                    <div className=\"flex items-center justify-between p-4 rounded-3xl bg-white/5 hover:bg-white/10 transition-all border border-transparent hover:border-white/10 group\">\n                                        <div className=\"flex items-center gap-4\">\n                                            <div className=\"w-12 h-12 rounded-full border-2 border-[var(--brand-primary)] p-0.5 overflow-hidden\">\n                                                <div className=\"relative w-full h-full rounded-full bg-white/10 overflow-hidden\">\n                                                    <Image\n                                                        src={u.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(u.username)}&backgroundType=solid&backgroundColor=FF8A8A`}\n                                                        alt={u.username}\n                                                        fill\n                                                        sizes=\"48px\"\n                                                        className=\"object-cover\"\n                                                    />\n                                                </div>\n                                            </div>\n                                            <div>\n                                                <div className=\"font-black text-sm group-hover:text-[var(--brand-primary)] transition-colors\">{u.firstName || u.username}</div>\n                                                <div className=\"text-[10px] text-[var(--text-muted)] font-bold uppercase tracking-widest\">@{u.username}</div>\n                                            </div>\n                                        </div>\n                                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] opacity-0 group-hover:opacity-100 transition-opacity\">\n                                            View Profile ‚Ä∫\n                                        </div>\n                                    </div>\n                                </Link>\n                            ))\n                        ) : (\n                            <div className=\"text-center p-8 text-[var(--text-muted)] font-black uppercase tracking-widest text-xs opacity-40\">No users found</div>\n                        )}\n                    </div>\n                </div>\n\n                <div className=\"p-6 bg-white/5 border-t border-white/5 flex justify-center\">\n                    <p className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Search results are updated live</p>\n                </div>\n            </motion.div>\n        </div>\n    );\n}\n\nfunction SocialListModal({ isOpen, onClose, initialTab, profileData, onFollow }: { isOpen: boolean, onClose: () => void, initialTab: 'following' | 'followers', profileData: any, onFollow: () => void }) {\n    const [activeTab, setActiveTab] = useState(initialTab);\n    const [users, setUsers] = useState<any[]>([]);\n    const [loading, setLoading] = useState(false);\n\n    useEffect(() => {\n        const fetchAll = async () => {\n            setLoading(true);\n            const ids = activeTab === 'following' ? (profileData.following || []) : (profileData.followers || []);\n\n            if (ids.length === 0) {\n                setUsers([]);\n                setLoading(false);\n                return;\n            }\n\n            try {\n                // Fetch in chunks of 10 for performance if list is huge, but here we do simple all\n                const details = await Promise.all(ids.map(async (id: string) => {\n                    const d = await getDoc(doc(db, 'users', id));\n                    return d.exists() ? { id: d.id, ...d.data() } : null;\n                }));\n                setUsers(details.filter(Boolean));\n            } catch (error) {\n                console.error(\"Error fetching full social list:\", error);\n            }\n            setLoading(false);\n        }\n        fetchAll();\n    }, [activeTab, profileData]);\n\n    return (\n        <div className=\"fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-6\">\n            <motion.div\n                initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}\n                onClick={onClose}\n                className=\"absolute inset-0 bg-black/60 backdrop-blur-md\"\n            />\n            <motion.div\n                initial={{ scale: 0.9, opacity: 0, y: 20 }} animate={{ scale: 1, opacity: 1, y: 0 }} exit={{ scale: 0.9, opacity: 0, y: 20 }}\n                className=\"relative w-full max-w-lg bg-[#0e1217] rounded-3xl border border-white/10 shadow-2xl overflow-hidden flex flex-col h-[70vh]\"\n            >\n                {/* Header Tabs */}\n                <div className=\"flex border-b border-white/10\">\n                    <button\n                        onClick={() => setActiveTab('following')}\n                        className={`flex-1 py-4 text-center text-sm font-black uppercase tracking-widest transition-colors ${activeTab === 'following' ? 'text-white border-b-2 border-[#1CB0F6]' : 'text-[var(--text-muted)] hover:text-white'}`}\n                    >\n                        Following\n                    </button>\n                    <button\n                        onClick={() => setActiveTab('followers')}\n                        className={`flex-1 py-4 text-center text-sm font-black uppercase tracking-widest transition-colors ${activeTab === 'followers' ? 'text-white border-b-2 border-[#1CB0F6]' : 'text-[var(--text-muted)] hover:text-white'}`}\n                    >\n                        Followers\n                    </button>\n                </div>\n\n                {/* List */}\n                <div className=\"flex-1 overflow-y-auto p-4 custom-scrollbar\">\n                    {loading ? (\n                        <div className=\"p-8 flex justify-center\"><div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-[#1CB0F6]\" /></div>\n                    ) : users.length > 0 ? (\n                        users.map(u => (\n                            <Link key={u.id} href={`/profile/${u.username}`} onClick={onClose}>\n                                <div className=\"flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition-colors group\">\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className=\"w-10 h-10 rounded-full bg-white/10 overflow-hidden relative border border-white/10\">\n                                            <Image\n                                                src={u.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${u.username}`}\n                                                fill\n                                                alt={u.username}\n                                                className=\"object-cover\"\n                                            />\n                                        </div>\n                                        <div>\n                                            <div className=\"font-bold text-white text-sm\">{u.firstName || u.username}</div>\n                                            <div className=\"text-[10px] text-[var(--text-muted)] font-black uppercase\">@{u.username}</div>\n                                        </div>\n                                    </div>\n                                    <div className=\"text-[#1CB0F6] opacity-0 group-hover:opacity-100 transition-opacity\">\n                                        ‚Üí\n                                    </div>\n                                </div>\n                            </Link>\n                        ))\n                    ) : (\n                        <div className=\"text-center mt-20 text-[var(--text-muted)] text-sm\">No users found.</div>\n                    )}\n                </div>\n\n                {/* Close Footer */}\n                <div className=\"p-4 border-t border-white/10 bg-[#0e1217]\">\n                    <button onClick={onClose} className=\"w-full py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-colors\">\n                        Close\n                    </button>\n                </div>\n            </motion.div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/profile/[username]/settings/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'updateProfile' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"updateProfile"},"fix":{"range":[476,490],"text":""},"desc":"Remove unused variable \"updateProfile\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'updateEmail' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"updateEmail"},"fix":{"range":[489,502],"text":""},"desc":"Remove unused variable \"updateEmail\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[920,923],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[920,923],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showDangerZone' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setShowDangerZone' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":31,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":154,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":164,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":164,"endColumn":23}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useMemo } from 'react'\nimport { useRouter } from 'next/navigation'\nimport Link from 'next/link'\nimport Image from 'next/image'\nimport { useAuth } from '@/lib/auth-context'\nimport { BrightHeading, BrightButton, BrightLayer } from '@/components/system'\nimport { doc, getDoc, updateDoc, collection, query, where, getDocs, arrayRemove } from 'firebase/firestore'\nimport { getFirebaseDb, getFirebaseAuth } from '@/lib/firebase'\nimport { updateProfile, updateEmail, sendPasswordResetEmail, signOut } from 'firebase/auth'\nimport { toast } from 'react-hot-toast'\n\nexport default function ProfileSettingsPage({ params }: { params: { username: string } }) {\n    const router = useRouter()\n    const { user, userData, loading } = useAuth()\n    const blockedUsers = useMemo(() => userData?.blockedUsers || [], [userData?.blockedUsers]);\n    const [blockedList, setBlockedList] = useState<any[]>([])\n    const [loadingBlocked, setLoadingBlocked] = useState(false)\n\n    // Form States\n    const [firstName, setFirstName] = useState('')\n    const [lastName, setLastName] = useState('')\n    const [bio, setBio] = useState('')\n    const [newUsername, setNewUsername] = useState('')\n    const [email, setEmail] = useState('')\n\n    const [saving, setSaving] = useState(false)\n\n    // Security States\n    const [showDangerZone, setShowDangerZone] = useState(false)\n\n    // Redirect if not owner\n    useEffect(() => {\n        if (!loading && userData && userData.username !== params.username) {\n            router.push(`/profile/${params.username}`)\n        }\n    }, [loading, userData, params.username, router])\n\n    // Initialize Form\n    useEffect(() => {\n        if (userData) {\n            setFirstName(userData.firstName || '')\n            setLastName(userData.lastName || '')\n            setBio(userData.bio || '')\n            setNewUsername(userData.username || '')\n            setEmail(user?.email || '')\n        }\n    }, [userData, user])\n\n    // Fetch blocked users details\n    useEffect(() => {\n        const fetchBlockedDetails = async () => {\n            if (blockedUsers.length === 0) {\n                setBlockedList([])\n                return\n            }\n\n            setLoadingBlocked(true)\n            try {\n                const db = getFirebaseDb()\n                const details = await Promise.all(blockedUsers.map(async (id) => {\n                    const d = await getDoc(doc(db, 'users', id))\n                    return d.exists() ? { id: d.id, ...d.data() } : null\n                }))\n                setBlockedList(details.filter(Boolean))\n            } catch (error) {\n                console.error(\"Error fetching blocked users:\", error)\n            }\n            setLoadingBlocked(false)\n        }\n\n        fetchBlockedDetails()\n    }, [blockedUsers])\n\n    const handleUnblock = async (userId: string) => {\n        try {\n            if (!user) return\n            const db = getFirebaseDb()\n            await updateDoc(doc(db, 'users', user.uid), {\n                blockedUsers: arrayRemove(userId)\n            })\n            toast.success('User unblocked')\n        } catch (err) {\n            console.error(\"Failed to unblock:\", err)\n            toast.error('Failed to unblock')\n        }\n    }\n\n    const handleSaveProfile = async () => {\n        if (!user) return\n        setSaving(true)\n        try {\n            const db = getFirebaseDb()\n            await updateDoc(doc(db, 'users', user.uid), {\n                firstName,\n                lastName,\n                bio\n            })\n            toast.success('Profile updated!')\n        } catch (error) {\n            console.error(\"Error updating profile:\", error)\n            toast.error('Failed to update profile')\n        }\n        setSaving(false)\n    }\n\n    const handleUsernameChange = async () => {\n        if (!user || !userData) return\n        if (newUsername === userData.username) return\n\n        const now = Date.now()\n        const lastChange = userData.lastUsernameChange || 0\n        const sevenDaysMs = 7 * 24 * 60 * 60 * 1000\n\n        if (now - lastChange < sevenDaysMs) {\n            const daysLeft = Math.ceil((sevenDaysMs - (now - lastChange)) / (24 * 60 * 60 * 1000))\n            toast.error(`You can change your username again in ${daysLeft} days.`)\n            return\n        }\n\n        setSaving(true)\n        try {\n            // Check Uniqueness\n            const usersRef = collection(getFirebaseDb(), 'users')\n            const q = query(usersRef, where('username', '==', newUsername))\n            const snapshot = await getDocs(q)\n\n            if (!snapshot.empty) {\n                toast.error('Username already taken')\n                setSaving(false)\n                return\n            }\n\n            await updateDoc(doc(getFirebaseDb(), 'users', user.uid), {\n                username: newUsername,\n                lastUsernameChange: now\n            })\n            toast.success('Username updated!')\n            router.push(`/profile/${newUsername}/settings`)\n        } catch (error) {\n            console.error(\"Error updating username:\", error)\n            toast.error('Failed to update username')\n        }\n        setSaving(false)\n    }\n\n    const handleChangePassword = async () => {\n        if (!email) return\n        try {\n            const auth = getFirebaseAuth()\n            await sendPasswordResetEmail(auth, email)\n            toast.success('Password reset email sent!')\n        } catch (error) {\n            toast.error('Failed to send reset email')\n        }\n    }\n\n    const handleSignOut = async () => {\n        try {\n            const auth = getFirebaseAuth()\n            await signOut(auth)\n            router.push('/login')\n        } catch (error) {\n            toast.error('Failed to sign out')\n        }\n    }\n\n    if (loading || !userData) {\n        return <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center text-white\">Loading...</div>\n    }\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] p-6 pt-24 text-[var(--text-primary)] relative overflow-hidden\">\n            {/* Background blobs for premium feel */}\n            <div className=\"absolute top-0 right-0 w-[500px] h-[500px] bg-[var(--brand-primary)]/5 rounded-full blur-[100px] pointer-events-none\" />\n            <div className=\"absolute bottom-0 left-0 w-[500px] h-[500px] bg-[var(--brand-accent)]/5 rounded-full blur-[100px] pointer-events-none\" />\n\n            <div className=\"max-w-4xl mx-auto relative z-10\">\n                <div className=\"flex items-center gap-4 mb-8\">\n                    <Link href={`/profile/${params.username}`}>\n                        <button className=\"text-[var(--text-secondary)] hover:text-white transition-colors flex items-center gap-2 font-bold px-4 py-2 rounded-xl hover:bg-white/5\">\n                            <span>‚Üê</span> Back to Profile\n                        </button>\n                    </Link>\n                </div>\n\n                <div className=\"flex items-end justify-between mb-8\">\n                    <BrightHeading level={1} className=\"text-5xl\">Settings</BrightHeading>\n                    <div className=\"text-[var(--brand-primary)] text-sm font-black uppercase tracking-widest bg-[var(--brand-primary)]/10 px-3 py-1 rounded-full border border-[var(--brand-primary)]/20\">\n                        User Controls\n                    </div>\n                </div>\n\n                <div className=\"grid gap-8\">\n\n                    {/* Public Profile */}\n                    <section>\n                        <BrightLayer variant=\"glass\" padding=\"lg\" className=\"border-t-4 border-[var(--brand-primary)]\">\n                            <h2 className=\"text-2xl font-black mb-6 flex items-center gap-3\">\n                                <span>üë§</span> Public Profile\n                            </h2>\n                            <div className=\"grid md:grid-cols-2 gap-6\">\n                                <div className=\"space-y-2\">\n                                    <label className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)]\">First Name</label>\n                                    <input\n                                        value={firstName}\n                                        onChange={(e) => setFirstName(e.target.value)}\n                                        className=\"w-full bg-black/20 border border-white/10 rounded-xl p-3 font-bold focus:border-[var(--brand-primary)] outline-none transition-all\"\n                                    />\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <label className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)]\">Last Name</label>\n                                    <input\n                                        value={lastName}\n                                        onChange={(e) => setLastName(e.target.value)}\n                                        className=\"w-full bg-black/20 border border-white/10 rounded-xl p-3 font-bold focus:border-[var(--brand-primary)] outline-none transition-all\"\n                                    />\n                                </div>\n                                <div className=\"md:col-span-2 space-y-2\">\n                                    <label className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)]\">Bio</label>\n                                    <textarea\n                                        value={bio}\n                                        onChange={(e) => setBio(e.target.value)}\n                                        rows={3}\n                                        className=\"w-full bg-black/20 border border-white/10 rounded-xl p-3 font-medium focus:border-[var(--brand-primary)] outline-none transition-all resize-none\"\n                                    />\n                                </div>\n                                <div className=\"md:col-span-2 flex justify-end\">\n                                    <BrightButton onClick={handleSaveProfile} disabled={saving} size=\"md\">\n                                        {saving ? 'Saving...' : 'Save Changes'}\n                                    </BrightButton>\n                                </div>\n                            </div>\n\n                            <div className=\"mt-8 pt-8 border-t border-white/5\">\n                                <h3 className=\"text-lg font-black mb-4\">Username</h3>\n                                <div className=\"flex gap-4\">\n                                    <input\n                                        value={newUsername}\n                                        onChange={(e) => setNewUsername(e.target.value)}\n                                        className=\"flex-1 bg-black/20 border border-white/10 rounded-xl p-3 font-mono font-bold focus:border-[var(--brand-primary)] outline-none transition-all\"\n                                    />\n                                    <BrightButton variant=\"outline\" onClick={handleUsernameChange} disabled={saving}>\n                                        Change Username\n                                    </BrightButton>\n                                </div>\n                                <p className=\"text-xs text-[var(--text-muted)] mt-2\">\n                                    *You can check your username once every 7 days.\n                                </p>\n                            </div>\n                        </BrightLayer>\n                    </section>\n\n                    {/* Account Security */}\n                    <section>\n                        <BrightLayer variant=\"glass\" padding=\"lg\" className=\"border-t-4 border-emerald-500\">\n                            <h2 className=\"text-2xl font-black mb-6 flex items-center gap-3\">\n                                <span>üõ°Ô∏è</span> Security\n                            </h2>\n\n                            <div className=\"space-y-6\">\n                                <div className=\"flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5\">\n                                    <div>\n                                        <div className=\"font-bold text-lg\">Email Address</div>\n                                        <div className=\"text-[var(--text-muted)]\">{email}</div>\n                                    </div>\n                                    <BrightButton variant=\"outline\" size=\"sm\" disabled>\n                                        Change Email\n                                    </BrightButton>\n                                </div>\n\n                                <div className=\"flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5\">\n                                    <div>\n                                        <div className=\"font-bold text-lg\">Password</div>\n                                        <div className=\"text-[var(--text-muted)] text-sm\">Last changed recently</div>\n                                    </div>\n                                    <BrightButton variant=\"outline\" size=\"sm\" onClick={handleChangePassword}>\n                                        Reset Password\n                                    </BrightButton>\n                                </div>\n                            </div>\n                        </BrightLayer>\n                    </section>\n\n                    {/* Blocked Users Section */}\n                    <section>\n                        <BrightLayer variant=\"glass\" padding=\"lg\" className=\"border-t-4 border-red-400\">\n                            <h2 className=\"text-2xl font-black mb-6 text-red-400 flex items-center gap-3\">\n                                <span>üö´</span> Blocked Users\n                            </h2>\n\n                            {loadingBlocked ? (\n                                <div className=\"text-center p-8\">Loading...</div>\n                            ) : blockedList.length > 0 ? (\n                                <div className=\"space-y-4 max-h-[300px] overflow-y-auto custom-scrollbar\">\n                                    {blockedList.map(u => (\n                                        <div key={u.id} className=\"flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5\">\n                                            <div className=\"flex items-center gap-4\">\n                                                <div className=\"w-10 h-10 rounded-full bg-white/10 overflow-hidden relative\">\n                                                    <Image\n                                                        src={u.avatarUrl || `https://api.dicebear.com/9.x/avataaars/svg?seed=${u.username}`}\n                                                        fill\n                                                        alt={u.username}\n                                                        className=\"object-cover\"\n                                                    />\n                                                </div>\n                                                <div>\n                                                    <div className=\"font-bold text-white\">{u.firstName || u.username}</div>\n                                                    <div className=\"text-xs text-[var(--text-muted)]\">@{u.username}</div>\n                                                </div>\n                                            </div>\n                                            <BrightButton\n                                                variant=\"outline\"\n                                                size=\"sm\"\n                                                onClick={() => handleUnblock(u.id)}\n                                                className=\"text-red-400 border-red-500/20 hover:bg-red-500/10\"\n                                            >\n                                                Unblock\n                                            </BrightButton>\n                                        </div>\n                                    ))}\n                                </div>\n                            ) : (\n                                <div className=\"text-center p-12 bg-white/5 rounded-2xl border-dashed border-2 border-white/10 text-[var(--text-muted)]\">\n                                    No blocked users.\n                                </div>\n                            )}\n                        </BrightLayer>\n                    </section>\n\n                    {/* Danger Zone */}\n                    <section>\n                        <div className=\"border border-red-500/30 bg-red-500/5 rounded-3xl p-8\">\n                            <h2 className=\"text-2xl font-black mb-2 text-red-500\">Danger Zone</h2>\n                            <p className=\"text-[var(--text-muted)] mb-6 text-sm\">Be careful with these settings.</p>\n\n                            <div className=\"flex items-center justify-between\">\n                                <div>\n                                    <div className=\"font-bold text-white\">Sign Out</div>\n                                    <div className=\"text-xs text-[var(--text-muted)]\">Log out of your account on this device</div>\n                                </div>\n                                <button\n                                    onClick={handleSignOut}\n                                    className=\"px-6 py-3 rounded-xl bg-red-500 text-white font-black uppercase tracking-widest text-xs hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20\"\n                                >\n                                    Sign Out\n                                </button>\n                            </div>\n                        </div>\n                    </section>\n\n                </div>\n            </div>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/profile/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/progress/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"motion"},"fix":{"range":[58,97],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'StreakCelebration' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"StreakCelebration"},"fix":{"range":[382,400],"text":""},"desc":"Remove unused variable \"StreakCelebration\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":104,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":107,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2454,2457],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2454,2457],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { motion } from 'framer-motion'\nimport { useRouter } from 'next/navigation'\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system'\nimport { TopicMasteryDashboard, TopicMastery } from '@/components/learning'\nimport { useAuth } from '@/lib/auth-context' // Assuming auth context exists\nimport { StreakCelebration, ProfessorBrightMascot } from '@/components/learning'\nimport { FeedbackResponse } from '@/lib/professor-bright'\nimport LabProgress from '@/components/science/LabProgress'\nimport { resolveMasteryPercent } from '@/lib/user-stats'\n\nexport default function ProgressPage() {\n    const router = useRouter()\n    const { user, userData, loading: authLoading } = useAuth()\n\n    const [loading, setLoading] = useState(true)\n    const [topics, setTopics] = useState<TopicMastery[]>([])\n    const [overallStats, setOverallStats] = useState({\n        mastery: 0,\n        confidence: 0,\n        streak: 0,\n        totalSkills: 0\n    })\n    const [mascotFeedback, setMascotFeedback] = useState<FeedbackResponse | null>(null)\n\n    useEffect(() => {\n        if (authLoading) return\n        if (!user) {\n            router.push('/login')\n            return\n        }\n\n        const fetchData = async () => {\n            try {\n                const token = await user.getIdToken()\n                const res = await fetch('/api/nable/status', {\n                    headers: {\n                        'Authorization': `Bearer ${token}`\n                    }\n                })\n\n                if (res.ok) {\n                    const data = await res.json()\n                    const masteryPercent = resolveMasteryPercent(userData)\n                    const resolvedMastery = masteryPercent > 0 ? masteryPercent : (data.overview?.overallMastery || 0)\n                    const resolvedStreak = typeof userData?.streak === 'number'\n                        ? userData.streak\n                        : (data.session?.currentStreak || 0)\n\n                    // Transform NABLE data to TopicMastery format\n                    // Assuming NABLE skills are essentially topics or can be mapped\n                    // For this implementation, we'll treat top-level skill entries as topics\n                    // In a real app, you might want a mapping of skill ID -> Topic Name\n\n                    const transformedTopics: TopicMastery[] = (data.skills?.details || []).map((skill: any) => ({\n                        topicId: skill.id,\n                        topicName: formatTopicName(skill.id),\n                        mastery: skill.mastery / 100,\n                        subSkills: [], // If NABLE had hierarchy, we'd populate this\n                        questionsCompleted: skill.streak * 5,\n                        totalQuestions: Math.max(100, (skill.streak * 5) + 20)\n                    }))\n\n                    setTopics(transformedTopics)\n\n                    setOverallStats({\n                        mastery: resolvedMastery,\n                        confidence: data.overview?.overallConfidence || 0,\n                        streak: resolvedStreak,\n                        totalSkills: data.overview?.totalSkillsTracked || 0\n                    })\n\n                    // Mascot Feedback Logic\n                    const mastery = resolvedMastery\n                    setTimeout(() => {\n                        setMascotFeedback({\n                            tone: mastery > 70 ? 'celebratory' : 'supportive',\n                            message: mastery > 70\n                                ? \"Look at those stats! You're becoming a pro! üåü\"\n                                : \"Consistency is key. Keep building that knowledge! üß†\",\n                            emoji: mastery > 70 ? 'üåü' : 'üìà',\n                            spriteClass: mastery > 70 ? 'owl-happy' : 'owl-neutral'\n                        })\n                    }, 1000)\n                }\n            } catch (error) {\n                console.error('Failed to fetch progress:', error)\n            } finally {\n                setLoading(false)\n            }\n        }\n\n        fetchData()\n    }, [user, authLoading, router, userData])\n\n    useEffect(() => {\n        if (!userData) return\n        const masteryPercent = resolveMasteryPercent(userData)\n        setOverallStats((prev) => ({\n            ...prev,\n            mastery: masteryPercent > 0 ? masteryPercent : prev.mastery,\n            streak: typeof userData.streak === 'number' ? userData.streak : prev.streak\n        }))\n    }, [userData])\n\n    // Helper to make IDs looks like names (e.g., \"algebra_basics\" -> \"Algebra Basics\")\n    const formatTopicName = (id: string) => {\n        return id\n            .split(/[-_]/)\n            .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n            .join(' ')\n    }\n\n    if (loading || authLoading) {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center\">\n                <div className=\"animate-pulse text-[var(--brand-primary)]\">Loading Progress...</div>\n            </div>\n        )\n    }\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] safe-padding pb-20\">\n            <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n\n                {/* Header Section */}\n                <div className=\"mb-8\">\n                    <BrightHeading level={1}>Your Progress</BrightHeading>\n                    <p className=\"text-[var(--text-secondary)] mt-2\">\n                        Track your mastery across all subjects and topics.\n                    </p>\n                </div>\n\n                {/* Stats Overview */}\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-10\">\n                    <StatsCard\n                        label=\"Overall Mastery\"\n                        value={`${overallStats.mastery}%`}\n                        icon=\"üèÜ\"\n                        trend={overallStats.mastery > 50 ? 'positive' : 'neutral'}\n                    />\n                    <StatsCard\n                        label=\"Confidence\"\n                        value={`${overallStats.confidence}%`}\n                        icon=\"üß†\"\n                        trend=\"neutral\"\n                    />\n                    <StatsCard\n                        label=\"Current Streak\"\n                        value={overallStats.streak.toString()}\n                        icon=\"üî•\"\n                        trend=\"positive\"\n                    />\n                    <StatsCard\n                        label=\"Skills Tracked\"\n                        value={overallStats.totalSkills.toString()}\n                        icon=\"üìö\"\n                        trend=\"neutral\"\n                    />\n                </div>\n\n                {/* Lab Progress Section */}\n                <LabProgress userData={userData} />\n\n                {/* Main Dashboard */}\n                <TopicMasteryDashboard\n                    topics={topics}\n                    onTopicClick={(topicId) => router.push(`/learn?topic=${topicId}`)}\n                />\n\n                {/* Empty State */}\n                {topics.length === 0 && (\n                    <BrightLayer variant=\"glass\" padding=\"lg\" className=\"text-center mt-8\">\n                        <div className=\"text-4xl mb-4\">üå±</div>\n                        <h3 className=\"text-xl font-bold mb-2\">No Data Yet</h3>\n                        <p className=\"text-[var(--text-secondary)] mb-6\">\n                            Start practicing to track your progress!\n                        </p>\n                        <BrightButton onClick={() => router.push('/learn')}>\n                            Start Learning\n                        </BrightButton>\n                    </BrightLayer>\n                )}\n            </div>\n            {/* Professor Bright Mascot */}\n            <ProfessorBrightMascot feedback={mascotFeedback} webMode={true} />\n        </div>\n    )\n}\n\nfunction StatsCard({ label, value, icon, trend }: { label: string, value: string, icon: string, trend: 'positive' | 'negative' | 'neutral' }) {\n    return (\n        <BrightLayer variant=\"elevated\" padding=\"md\" className=\"flex flex-col items-center text-center\">\n            <span className=\"text-2xl mb-2\">{icon}</span>\n            <span className=\"text-sm text-[var(--text-muted)] uppercase tracking-wider font-bold mb-1\">{label}</span>\n            <span className={`text-2xl font-black ${trend === 'positive' ? 'text-green-500' :\n                trend === 'negative' ? 'text-red-500' : 'text-[var(--text-primary)]'\n                }`}>\n                {value}\n            </span>\n        </BrightLayer>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/signup/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[31,42],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":58,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'authLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":58,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8026,8029],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8026,8029],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":206,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7169,7172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7169,7172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\nimport Link from 'next/link'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { z } from 'zod'\nimport { useAuth } from '@/lib/auth-context'\n\n// --- Types & Constants ---\n\nconst SignUpSchema = z.object({\n  firstName: z.string().min(2, 'First name is too short'),\n  lastName: z.string().min(2, 'Last name is too short'),\n  email: z.string().email('Invalid email address').min(1, 'Email is required'),\n  password: z.string().min(6, 'Password must be at least 6 characters').max(100, 'Password too long'),\n  username: z.string().min(3, 'Username must be at least 3 characters').max(30, 'Username too long').regex(/^[a-zA-Z0-9_]+$/, 'Username can only contain letters, numbers, and underscores'),\n})\n\nconst MascotOwl = ({ pose = 'owl-happy', size = 'sm' }: { pose?: string, size?: 'sm' | 'md' | 'lg' }) => {\n  const sizes = { sm: 48, md: 96, lg: 192 }\n  const pixels = sizes[size]\n\n  const poses: Record<string, number> = {\n    'owl-happy': 0, 'owl-relieved': 1, 'owl-shocked': 2, 'owl-sad-rain': 3,\n    'owl-thinking': 4, 'owl-sad-cloud': 5, 'owl-idea': 6, 'owl-smart': 7,\n    'owl-wink': 8, 'owl-confused': 9, 'owl-reading': 10, 'owl-studying': 11,\n    'owl-sleeping': 12, 'owl-magic': 13, 'owl-zzz': 14, 'owl-bored': 15\n  }\n  const index = poses[pose] || 0\n  const row = Math.floor(index / 4)\n  const col = index % 4\n\n  const posX = (col * 100) / 3\n  const posY = (row * 100) / 3\n\n  return (\n    <div\n      style={{\n        width: `${pixels}px`,\n        height: `${pixels}px`,\n        backgroundImage: \"url('/professor-bright-sprite.png')\",\n        backgroundSize: '400% 400%',\n        backgroundPosition: `${posX}% ${posY}%`,\n        imageRendering: 'pixelated',\n        flexShrink: 0\n      }}\n      className=\"flex-shrink-0\"\n    />\n  )\n}\n\n// --- Main Component ---\n\nexport default function SignUpPage() {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { user, loading: authLoading } = useAuth()\n\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n  const [termsAccepted, setTermsAccepted] = useState(false)\n\n  const subjectsParam = searchParams?.get('subjects')\n  const hasSubjects = !!subjectsParam\n  const notifyParam = searchParams?.get('notify')\n\n  const [formData, setFormData] = useState({\n    firstName: '',\n    lastName: '',\n    email: '',\n    password: '',\n    username: '',\n    subjects: subjectsParam?.split(',') || []\n  })\n\n  // Redirect handled by AuthGate\n  /*\n  useEffect(() => {\n    if (!authLoading && user) {\n      router.push('/home')\n    }\n  }, [user, authLoading, router])\n  */\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError(null)\n\n    if (!hasSubjects) {\n      router.push('/welcome')\n      return\n    }\n\n    if (!termsAccepted) {\n      setError('Please accept the Privacy Policy and Terms & Conditions to continue.')\n      return\n    }\n\n    const { isFirebaseReady } = await import('@/lib/firebase')\n    if (!isFirebaseReady) {\n      setError(\"Authentication service is temporarily unavailable. Please try again later.\")\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      // Validate form\n      const validationResult = SignUpSchema.safeParse({\n        firstName: formData.firstName.trim(),\n        lastName: formData.lastName.trim(),\n        email: formData.email.trim(),\n        password: formData.password,\n        username: formData.username.trim(),\n      })\n\n      if (!validationResult.success) {\n        throw new Error(validationResult.error.errors[0].message)\n      }\n\n      const validatedData = validationResult.data\n\n      // 1. Create User\n      const { createUserWithEmailAndPassword, updateProfile } = await import('firebase/auth')\n      const { auth, db } = await import('@/lib/firebase')\n      const { doc, setDoc, collection, writeBatch } = await import('firebase/firestore')\n\n      const userCredential = await createUserWithEmailAndPassword(auth, validatedData.email, validatedData.password)\n      const newUser = userCredential.user\n\n      // Update display name immediately\n      await updateProfile(newUser, { displayName: `${validatedData.firstName} ${validatedData.lastName}` })\n\n      // 2. Prepare User Data (Bypassing Onboarding)\n      const userDocRef = doc(db, 'users', newUser.uid)\n\n      const lvlsParam = searchParams?.get('lvls')\n      const diagnosticMastery = searchParams?.get('mastery')\n      const diagStatsParam = searchParams?.get('diag_stats')\n\n      // Capture Onboarding Data\n      const examParam = searchParams?.get('exam')\n      const schoolParam = searchParams?.get('school')\n      const countryParam = searchParams?.get('country')\n      const formParam = searchParams?.get('form')\n\n      let proficiencyMap: Record<string, string> = {}\n      try {\n        if (lvlsParam) proficiencyMap = JSON.parse(lvlsParam)\n      } catch (e) {\n        console.error('Failed to parse lvls:', e)\n      }\n\n      const subjectProgress: Record<string, number> = {}\n      formData.subjects.forEach(s => {\n        // If we have a specific diagnostic mastery, we could apply it globally or to specific subjects\n        // For now, if diagnosticMastery exists, we use it as the base.\n        const baseMastery = diagnosticMastery ? parseFloat(diagnosticMastery) : (parseInt(proficiencyMap[s] || '1') * 0.1)\n        subjectProgress[s] = baseMastery\n      })\n\n      await setDoc(userDocRef, {\n        uid: newUser.uid,\n        username: validatedData.username,\n        firstName: validatedData.firstName,\n        lastName: validatedData.lastName,\n        displayName: `${validatedData.firstName} ${validatedData.lastName}`,\n        email: validatedData.email,\n        mastery: diagnosticMastery ? parseFloat(diagnosticMastery) : 0.1,\n        streak: 1,\n        xp: 50,\n        bCoins: 100,\n        hasBusiness: false,\n        businessID: null,\n        consistency: 10,\n        subjectProgress,\n        subjects: formData.subjects,\n        proficiencies: proficiencyMap,\n        diagnosticStats: diagStatsParam ? JSON.parse(diagStatsParam) : null,\n        diagnosticCompleted: !!diagnosticMastery,\n        onboardingCompleted: true,\n        onboardingCompletedAt: new Date().toISOString(),\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n        examTrack: examParam || 'CSEC',\n        formLevel: formParam || '3',\n        country: countryParam || 'Trinidad and Tobago',\n        school: schoolParam || null,\n        notificationPermission: notifyParam || null\n      })\n\n      // 3. Initialize Learning Path\n      try {\n        const { paths } = await fetch(\n          '/api/learning-path?' + new URLSearchParams({ subjects: formData.subjects.join(',') })\n        ).then((res) => res.json())\n\n        if (paths) {\n          const batch = writeBatch(db)\n          const progressRef = collection(userDocRef, 'progress')\n          let isFirstModule = true\n\n          for (const [subj, objectives] of Object.entries(paths)) {\n            // eslint-disable-next-line\n            const objectivesList = objectives as any[]\n            for (const obj of objectivesList) {\n              const moduleRef = doc(progressRef, obj.id)\n              batch.set(moduleRef, {\n                moduleId: obj.id,\n                subject: subj,\n                isUnlocked: isFirstModule,\n                status: isFirstModule ? 'active' : 'locked',\n                mastery: 0,\n                attempts: 0,\n              })\n              if (isFirstModule) isFirstModule = false\n            }\n          }\n          await batch.commit()\n        }\n      } catch (pathError) {\n        console.error(\"Failed to init learning path:\", pathError)\n      }\n\n      const diagParams = new URLSearchParams()\n      diagParams.set('subjects', formData.subjects.join(','))\n      diagParams.set('lvls', lvlsParam || '{}')\n      router.push(`/welcome/diagnostic?${diagParams.toString()}`)\n    } catch (err: any) {\n      console.error('Signup Error:', err)\n      setError(err.message || 'An error occurred during signup')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] font-sans flex items-center justify-center p-4\">\n\n      {/* Header / Logo */}\n      <div className=\"absolute top-6 left-6 flex items-center gap-2\">\n        <MascotOwl pose=\"owl-happy\" size=\"sm\" />\n        <span className=\"font-heading font-extrabold text-2xl text-[var(--brand-secondary)] tracking-tighter\">BrightEd</span>\n      </div>\n\n      <AnimatePresence mode=\"wait\">\n        {!hasSubjects ? (\n          <motion.div\n            key=\"redirect\"\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            className=\"flex flex-col items-center gap-8 text-center\"\n          >\n            <MascotOwl pose=\"owl-smart\" size=\"lg\" />\n            <div>\n              <h2 className=\"text-3xl font-extrabold text-[var(--text-primary)]\">Ready to learn?</h2>\n              <p className=\"text-[var(--text-secondary)] font-bold mt-2\">First, let&apos;s pick your subjects!</p>\n            </div>\n            <Link\n              href=\"/welcome\"\n              className=\"bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold px-12 py-4 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n            >\n              GET STARTED\n            </Link>\n          </motion.div>\n        ) : (\n          <motion.div\n            key=\"form\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"w-full max-w-md\"\n          >\n            <div className=\"text-center mb-8\">\n              <div className=\"flex justify-center mb-4\">\n                <MascotOwl pose=\"owl-happy\" size=\"md\" />\n              </div>\n              <h2 className=\"text-3xl font-extrabold text-[var(--text-primary)]\">Create your profile</h2>\n              <p className=\"text-[var(--text-secondary)] font-bold mt-2\">To save your progress!</p>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <input\n                  type=\"text\"\n                  placeholder=\"First Name\"\n                  className=\"w-full p-4 rounded-2xl border-2 border-[var(--border-subtle)] focus:border-[var(--brand-secondary)] bg-[var(--bg-elevated)] text-[var(--text-primary)] font-bold outline-none transition-all\"\n                  value={formData.firstName}\n                  onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}\n                  required\n                />\n                <input\n                  type=\"text\"\n                  placeholder=\"Last Name\"\n                  className=\"w-full p-4 rounded-2xl border-2 border-[var(--border-subtle)] focus:border-[var(--brand-secondary)] bg-[var(--bg-elevated)] text-[var(--text-primary)] font-bold outline-none transition-all\"\n                  value={formData.lastName}\n                  onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}\n                  required\n                />\n              </div>\n              <input\n                type=\"text\"\n                placeholder=\"Username\"\n                className=\"w-full p-4 rounded-2xl border-2 border-[var(--border-subtle)] focus:border-[var(--brand-secondary)] bg-[var(--bg-elevated)] text-[var(--text-primary)] font-bold outline-none transition-all\"\n                value={formData.username}\n                onChange={(e) => setFormData({ ...formData, username: e.target.value })}\n                required\n              />\n              <input\n                type=\"email\"\n                placeholder=\"Email\"\n                className=\"w-full p-4 rounded-2xl border-2 border-[var(--border-subtle)] focus:border-[var(--brand-secondary)] bg-[var(--bg-elevated)] text-[var(--text-primary)] font-bold outline-none transition-all\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                required\n              />\n              <input\n                type=\"password\"\n                placeholder=\"Password\"\n                className=\"w-full p-4 rounded-2xl border-2 border-[var(--border-subtle)] focus:border-[var(--brand-secondary)] bg-[var(--bg-elevated)] text-[var(--text-primary)] font-bold outline-none transition-all\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                required\n              />\n\n              <label className=\"flex items-start gap-3 rounded-2xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] p-4 text-sm font-bold text-[var(--text-secondary)]\">\n                <input\n                  type=\"checkbox\"\n                  checked={termsAccepted}\n                  onChange={(e) => setTermsAccepted(e.target.checked)}\n                  className=\"mt-1 h-4 w-4 rounded border-[var(--border-subtle)] text-[var(--brand-secondary)]\"\n                  required\n                />\n                <span>\n                  I agree to the{' '}\n                  <a\n                    href=\"/privacy-policy.pdf\"\n                    target=\"_blank\"\n                    rel=\"noreferrer\"\n                    className=\"text-[var(--brand-secondary)] underline\"\n                  >\n                    Privacy Policy\n                  </a>{' '}\n                  and{' '}\n                  <a\n                    href=\"/terms-and-conditions.pdf\"\n                    target=\"_blank\"\n                    rel=\"noreferrer\"\n                    className=\"text-[var(--brand-secondary)] underline\"\n                  >\n                    Terms &amp; Conditions\n                  </a>.\n                </span>\n              </label>\n\n              {error && (\n                <div className=\"p-4 bg-red-50 text-red-500 font-bold rounded-2xl border-2 border-red-100 text-sm\">\n                  {error}\n                </div>\n              )}\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-4 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all disabled:opacity-50 tracking-widest uppercase mt-4 shadow-lg shadow-indigo-500/10\"\n              >\n                {loading ? 'CREATING...' : 'CREATE ACCOUNT'}\n              </button>\n            </form>\n\n            <p className=\"text-center mt-8 text-[var(--text-muted)] font-bold\">\n              Already have an account? <Link href=\"/login\" className=\"text-[var(--brand-secondary)]\">Log in</Link>\n            </p>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/welcome/diagnostic/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[301,314],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[313,326],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightHeading' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":50,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightHeading"},"fix":{"range":[292,371],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useRef, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { updateSkillMetrics, UserSkillStats, PerformanceSnapshot } from '@/lib/learning-algorithm'\nimport { BrightButton, BrightLayer, BrightHeading } from '@/components/system'\nimport { useAuth } from '@/lib/auth-context'\nimport { doc, updateDoc } from 'firebase/firestore'\nimport { db } from '@/lib/firebase'\n\n// --- Types & Definitions ---\n\ninterface DiagnosticQuestion {\n    id: string\n    question: string\n    difficulty: number // 1-10\n    tags: string[]\n    options: string[]\n    correctAnswer: number\n}\n\nconst ADAPTIVE_BANK: Record<string, DiagnosticQuestion[]> = {\n    Mathematics: [\n        { id: 'm_easy_1', difficulty: 2, tags: ['math'], question: 'What is the sum of 1/4 and 1/2?', options: ['3/4', '2/6', '1/6', '1/8'], correctAnswer: 0 },\n        { id: 'm_med_1', difficulty: 5, tags: ['math', 'geometry'], question: 'If the radius of a circle is 7, what is its approximate circumference? (Use œÄ ‚âà 22/7)', options: ['22', '44', '154', '49'], correctAnswer: 1 },\n        { id: 'm_hard_1', difficulty: 8, tags: ['math', 'algebra'], question: 'Simplify: (x^2 - 4) / (x + 2)', options: ['x + 2', 'x - 2', 'x^2', '4'], correctAnswer: 1 },\n    ],\n    'Principles of Business': [\n        { id: 'pob_easy_1', difficulty: 3, tags: ['business'], question: 'Which is a primary function of management?', options: ['Planning', 'Manufacturing', 'Spending', 'Competing'], correctAnswer: 0 },\n        { id: 'pob_med_1', difficulty: 6, tags: ['business', 'marketing'], question: 'The \"Four Ps\" of marketing are Product, Price, Place, and:', options: ['Personnel', 'Promotion', 'Packaging', 'Profit'], correctAnswer: 1 },\n        { id: 'pob_hard_1', difficulty: 9, tags: ['business', 'logistics'], question: 'A document allowing a buyer to take possession of goods before payment is:', options: ['Invoice', 'Bill of Lading', 'Credit Note', 'Debit Note'], correctAnswer: 1 },\n    ],\n    'Principles of Accounts': [\n        { id: 'poa_easy_1', difficulty: 3, tags: ['accounts'], question: 'The accounting equation is: Assets = Liabilities + ___', options: ['Expenses', 'Capital', 'Revenue', 'Drawings'], correctAnswer: 1 },\n        { id: 'poa_med_1', difficulty: 6, tags: ['accounts'], question: 'Which account usually has a debit balance?', options: ['Accounts Payable', 'Sales', 'Rent Expense', 'Bank Loan'], correctAnswer: 2 },\n    ],\n    'Information Technology': [\n        { id: 'it_easy_1', difficulty: 3, tags: ['it'], question: 'What does HTTP stand for?', options: ['High Tech Text Protocol', 'HyperText Transfer Protocol', 'Helpful Tool Transfer Process', 'Hyper Transfer Text Path'], correctAnswer: 1 },\n        { id: 'it_med_1', difficulty: 6, tags: ['it', 'programming'], question: 'In programming, a logic error is also known as a:', options: ['Syntax Error', 'Runtime Error', 'Semantic Bug', 'Hardware Failure'], correctAnswer: 2 },\n        { id: 'it_hard_1', difficulty: 9, tags: ['it', 'networking'], question: 'Which layer of the OSI model is responsible for IP addressing?', options: ['Data Link', 'Transport', 'Network', 'Physical'], correctAnswer: 2 },\n    ],\n    'English A': [\n        { id: 'eng_easy_1', difficulty: 3, tags: ['english'], question: 'Select the correctly spelled word:', options: ['Accomodate', 'Accommodate', 'Acommodate', 'Acomodate'], correctAnswer: 1 },\n        { id: 'eng_med_1', difficulty: 6, tags: ['english'], question: 'What is the \"Thesis Statement\" of an essay?', options: ['The conclusion', 'The central argument', 'A summary of facts', 'A list of references'], correctAnswer: 1 },\n    ],\n    'Physics': [\n        { id: 'phy_med_1', difficulty: 5, tags: ['physics'], question: 'Power is defined as the rate of doing:', options: ['Force', 'Work', 'Velocity', 'Acceleration'], correctAnswer: 1 },\n        { id: 'phy_hard_1', difficulty: 8, tags: ['physics'], question: 'What is the SI unit of Magnetic Flux?', options: ['Tesla', 'Weber', 'Henry', 'Farad'], correctAnswer: 1 },\n    ],\n    'Chemistry': [\n        { id: 'chem_med_1', difficulty: 6, tags: ['chemistry'], question: 'What is the pH of a neutral solution?', options: ['1', '14', '7', '0'], correctAnswer: 2 },\n    ],\n    Biology: [\n        { id: 'bio_med_1', difficulty: 6, tags: ['biology'], question: 'Which organelle is responsible for cellular respiration?', options: ['Ribosome', 'Mitochondria', 'Golgi Body', 'Lysosome'], correctAnswer: 1 },\n    ],\n}\n\nconst GENERAL_BANK: DiagnosticQuestion[] = [\n    { id: 'g_1', difficulty: 4, tags: ['logic'], question: 'Sequence: 2, 4, 8, 16, ...', options: ['24', '30', '32', '64'], correctAnswer: 2 },\n    { id: 'g_2', difficulty: 6, tags: ['logic'], question: 'If All A are B, and some B are C...', options: ['All A are C', 'Some A are C', 'No A are C', 'Cannot determine'], correctAnswer: 3 },\n]\n\nconst MascotOwl = ({ pose = 'owl-happy', size = 'sm' }: { pose?: string, size?: 'sm' | 'md' | 'lg' }) => {\n    const sizes = { sm: 48, md: 96, lg: 192 }\n    const pixels = sizes[size]\n\n    const poses: Record<string, number> = {\n        'owl-happy': 0, 'owl-relieved': 1, 'owl-shocked': 2, 'owl-sad-rain': 3,\n        'owl-thinking': 4, 'owl-sad-cloud': 5, 'owl-idea': 6, 'owl-smart': 7,\n        'owl-wink': 8, 'owl-confused': 9, 'owl-reading': 10, 'owl-studying': 11,\n        'owl-sleeping': 12, 'owl-magic': 13, 'owl-zzz': 14, 'owl-bored': 15\n    }\n    const index = poses[pose] || 0\n    const row = Math.floor(index / 4)\n    const col = index % 4\n\n    const posX = (col * 100) / 3\n    const posY = (row * 100) / 3\n\n    return (\n        <div\n            style={{\n                width: `${pixels}px`,\n                height: `${pixels}px`,\n                backgroundImage: \"url('/professor-bright-sprite.png')\",\n                backgroundSize: '400% 400%',\n                backgroundPosition: `${posX}% ${posY}%`,\n                imageRendering: 'pixelated',\n                flexShrink: 0\n            }}\n            className=\"shrink-0\"\n        />\n    )\n}\n\n// --- Main Components ---\n\nfunction DiagnosticContent() {\n    const router = useRouter()\n    const searchParams = useSearchParams()\n    const { user, userData } = useAuth()\n    const [isMounted, setIsMounted] = useState(false)\n    \n    useEffect(() => {\n        setIsMounted(true)\n    }, [])\n\n    // Params from Welcome Flow, fallback to user data\n    const subjects = userData?.subjects || (isMounted ? searchParams?.get('subjects')?.split(',') : []) || []\n    const source = userData?.source || (isMounted ? searchParams?.get('source') : '') || ''\n    const lvlsStr = isMounted ? searchParams?.get('lvls') || '{}' : '{}'\n    const lvls = userData?.proficiencies || JSON.parse(lvlsStr)\n\n    // State\n    const [phase, setPhase] = useState<'ready' | 'testing' | 'analyzing' | 'complete'>('ready')\n    const [currentQuestion, setCurrentQuestion] = useState<DiagnosticQuestion | null>(null)\n    const [questionIndex, setQuestionIndex] = useState(0)\n    const [stats, setStats] = useState<UserSkillStats>({\n        generalLevel: 1.0, // Start from scratch (easiest)\n        consistency: 0.5,\n        topicMastery: {},\n        behavioralSignals: { avgResponseTime: 0, perfectStreaks: 0, rapidGuessPenalty: 0 }\n    })\n\n    const [history, setHistory] = useState<Set<string>>(new Set())\n    const questionStartTime = useRef<number>(Date.now())\n\n    const startDiagnostic = () => {\n        setPhase('testing')\n        pickNextQuestion()\n    }\n\n    const pickNextQuestion = () => {\n        // Determine eligible subjects (only those in the ADAPTIVE_BANK)\n        const eligibleBanks = subjects.map((s: string) => ADAPTIVE_BANK[s]).filter(Boolean)\n        const pool = eligibleBanks.flat().concat(GENERAL_BANK)\n        const unseen = pool.filter(q => !history.has(q.id))\n\n        if (unseen.length === 0 || questionIndex >= 10) {\n            setPhase('analyzing')\n            setTimeout(() => setPhase('complete'), 3000)\n            return\n        }\n\n        const targetDifficulty = stats.generalLevel\n        const bestMatch = unseen.reduce((prev, curr) => {\n            const prevDiff = Math.abs(prev.difficulty - targetDifficulty)\n            const currDiff = Math.abs(curr.difficulty - targetDifficulty)\n            return currDiff < prevDiff ? curr : prev\n        })\n\n        setCurrentQuestion(bestMatch)\n        setHistory(prev => new Set(prev).add(bestMatch.id))\n        setQuestionIndex(prev => prev + 1)\n        questionStartTime.current = Date.now()\n    }\n\n    const handleAnswer = (answerIndex: number) => {\n        if (!currentQuestion) return\n\n        const endTime = Date.now()\n        const responseTime = (endTime - questionStartTime.current) / 1000\n\n        const snapshot: PerformanceSnapshot = {\n            correct: answerIndex === currentQuestion.correctAnswer,\n            responseTime,\n            questionDifficulty: currentQuestion.difficulty,\n            tags: currentQuestion.tags\n        }\n\n        const updatedStats = updateSkillMetrics(stats, snapshot)\n        setStats(updatedStats)\n        pickNextQuestion()\n    }\n\n    const handleComplete = async () => {\n        const mastery = Math.max(0.1, Math.min(1, stats.generalLevel / 10))\n        const params = new URLSearchParams()\n        params.set('subjects', subjects.join(','))\n        params.set('source', source)\n        params.set('lvls', lvls)\n        params.set('diag_stats', JSON.stringify(stats))\n        params.set('mastery', mastery.toString())\n\n        if (user) {\n            // Save to Firestore since user is logged in\n            try {\n                await updateDoc(doc(db, 'users', user.uid), {\n                    mastery,\n                    diagnosticStats: stats,\n                    diagnosticCompleted: true,\n                    diagnosticCompletedAt: new Date().toISOString(),\n                })\n            } catch (e) {\n                console.error(\"Failed to save diag results:\", e)\n            }\n            router.push('/home')\n        } else {\n            // Fallback for unexpected session loss\n            router.push(`/home`)\n        }\n    }\n\n    if (phase === 'ready') {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n                <div className=\"text-center max-w-md w-full flex flex-col items-center gap-8\">\n                    <MascotOwl pose=\"owl-idea\" size=\"lg\" />\n                    <div>\n                        <h1 className=\"text-3xl font-extrabold text-[var(--text-primary)] mb-4\">Quick Evaluation</h1>\n                        <p className=\"text-[var(--text-secondary)] font-bold mb-8\">\n                            This short evaluation helps us find the perfect starting point for you.\n                            If it seems easy at first, don&apos;t worry‚Äîit&apos;s just calibrating!\n                        </p>\n                    </div>\n                    <button\n                        onClick={startDiagnostic}\n                        className=\"w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-4 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n                    >\n                        START EVALUATION\n                    </button>\n                </div>\n            </div>\n        )\n    }\n\n    if (phase === 'analyzing') {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col items-center justify-center p-4\">\n                <div className=\"animate-spin-slow mb-8\">\n                    <MascotOwl pose=\"owl-thinking\" size=\"lg\" />\n                </div>\n                <h2 className=\"text-3xl font-extrabold text-[var(--text-primary)] mb-2\">Finding your level...</h2>\n                <p className=\"text-[var(--text-secondary)] font-bold animate-pulse\">Personalizing your learning path</p>\n            </div>\n        )\n    }\n\n    if (phase === 'complete') {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center p-4\">\n                <div className=\"text-center max-w-2xl w-full flex flex-col items-center gap-10\">\n                    <MascotOwl pose=\"owl-happy\" size=\"lg\" />\n                    <div>\n                        <h2 className=\"text-4xl font-extrabold text-[var(--text-primary)] mb-2\">Evaluation Complete!</h2>\n                        <p className=\"text-[var(--text-secondary)] font-bold text-xl uppercase tracking-widest\">Recommended Level: {stats.generalLevel.toFixed(1)}/10</p>\n                    </div>\n\n                    <div className=\"w-full bg-[var(--bg-elevated)] p-8 rounded-3xl border-2 border-[var(--border-subtle)]\">\n                        <div className=\"flex justify-between text-xs font-black text-[var(--text-muted)] uppercase tracking-tighter mb-3\">\n                            <span>Novice</span>\n                            <span>Expert</span>\n                        </div>\n                        <div className=\"h-6 bg-[var(--bg-secondary)] rounded-full overflow-hidden relative border-b-4 border-[var(--border-subtle)]\">\n                            <motion.div\n                                initial={{ width: 0 }}\n                                animate={{ width: `${stats.generalLevel * 10}%` }}\n                                transition={{ duration: 1.5, ease: \"circOut\" }}\n                                className=\"h-full bg-gradient-to-r from-[var(--brand-primary)] to-[var(--brand-secondary)]\"\n                            />\n                        </div>\n                        <p className=\"mt-6 text-[var(--text-secondary)] font-bold\">\n                            We&apos;ve unlocked the <strong>{stats.generalLevel > 6 ? 'Advanced' : 'Foundational'}</strong> learning path based on your performance.\n                        </p>\n                    </div>\n\n                    <button\n                        onClick={handleComplete}\n                        className=\"w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-5 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n                    >\n                        GO TO DASHBOARD\n                    </button>\n                </div>\n            </div>\n        )\n    }\n\n    if (!currentQuestion) return null\n\n    const progress = (questionIndex / 10) * 100\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col items-center p-6 pt-36\">\n            <div className=\"w-full max-w-2xl mb-12\">\n                <div className=\"flex justify-between items-end mb-3\">\n                    <div className=\"flex items-center gap-3\">\n                        <MascotOwl pose=\"owl-reading\" size=\"sm\" />\n                        <span className=\"text-xs font-black uppercase tracking-widest text-[var(--brand-secondary)]\">\n                            Difficulty: {currentQuestion.difficulty}/10\n                        </span>\n                    </div>\n                    <span className=\"text-sm font-black text-slate-300 uppercase\">Step {questionIndex}/10</span>\n                </div>\n                <div className=\"h-4 bg-[var(--bg-secondary)] rounded-full overflow-hidden border-b-2 border-[var(--border-subtle)]\">\n                    <motion.div\n                        animate={{ width: `${progress}%` }}\n                        className=\"h-full bg-[var(--brand-secondary)]\"\n                        style={{ boxShadow: '0 4px 0 rgba(0,0,0,0.1) inset' }}\n                    />\n                </div>\n            </div>\n\n            <AnimatePresence mode=\"wait\">\n                <motion.div\n                    key={currentQuestion.id}\n                    initial={{ opacity: 0, x: 20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -20 }}\n                    className=\"w-full max-w-2xl\"\n                >\n                    <div className=\"bg-[var(--bg-elevated)] rounded-3xl p-8 mb-10 min-h-[160px] flex items-center justify-center border-2 border-[var(--border-subtle)] shadow-sm relative\">\n                        <div className=\"absolute -bottom-3 left-1/2 -translate-x-1/2 w-6 h-6 bg-[var(--bg-elevated)] border-r-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n                        <h2 className=\"text-3xl font-extrabold text-[var(--text-primary)] text-center leading-tight\">\n                            {currentQuestion.question}\n                        </h2>\n                    </div>\n\n                    <div className=\"grid gap-4\">\n                        {currentQuestion.options.map((opt, idx) => (\n                            <button\n                                key={idx}\n                                onClick={() => handleAnswer(idx)}\n                                className=\"w-full text-left py-6 px-8 rounded-2xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] hover:border-[var(--brand-secondary)]/50 active:translate-y-1 border-b-4 flex items-center gap-6 group transition-all\"\n                            >\n                                <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-secondary)] border-2 border-[var(--border-subtle)] flex items-center justify-center font-black text-[var(--text-muted)] group-hover:text-[var(--text-primary)] transition-colors\">\n                                    {String.fromCharCode(65 + idx)}\n                                </div>\n                                <span className=\"text-xl font-extrabold text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors\">{opt}</span>\n                            </button>\n                        ))}\n                    </div>\n                </motion.div>\n            </AnimatePresence>\n        </div>\n    )\n}\n\nexport default function DiagnosticPageWrapper() {\n    return (\n        <Suspense fallback={<div className=\"min-h-screen flex items-center justify-center text-slate-400 font-bold\">Loading...</div>}>\n            <DiagnosticContent />\n        </Suspense>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/app/welcome/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightHeading' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightHeading"},"fix":{"range":[194,208],"text":""},"desc":"Remove unused variable \"BrightHeading\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[207,221],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":50,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightLayer"},"fix":{"range":[185,264],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[397,426],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":589,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":589,"endColumn":19}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'proficiencies', 'selectedSubjects', and 'source'. Either include them or remove the dependency array.","line":648,"column":8,"nodeType":"ArrayExpression","endLine":648,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [proficiencies, searchParams, selectedSubjects, source]","fix":{"range":[32674,32688],"text":"[proficiencies, searchParams, selectedSubjects, source]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, Suspense } from 'react'\nimport { useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { BrightHeading, BrightButton, BrightLayer } from '@/components/system'\nimport { useAuth } from '@/lib/auth-context'\nimport { doc, updateDoc } from 'firebase/firestore'\nimport { db } from '@/lib/firebase'\nimport Link from 'next/link'\n\n// --- Definitions ---\n\nconst SUBJECTS = [\n    { id: 'Mathematics', name: 'Mathematics', icon: 'üìê' },\n    { id: 'English A', name: 'English A', icon: 'üìñ' },\n    { id: 'English B', name: 'English B', icon: 'üé≠' },\n    { id: 'Principles of Business', name: 'Principles of Business', icon: 'üíº' },\n    { id: 'Principles of Accounts', name: 'Principles of Accounts', icon: 'üìä' },\n    { id: 'Social Studies', name: 'Social Studies', icon: 'üåç' },\n    { id: 'Spanish', name: 'Spanish', icon: 'üá™üá∏' },\n    { id: 'French', name: 'French', icon: 'üá´üá∑' },\n    { id: 'Geography', name: 'Geography', icon: 'üó∫Ô∏è' },\n    { id: 'Theatre Arts', name: 'Theatre Arts', icon: 'üé≠' },\n    { id: 'Music', name: 'Music', icon: 'üéµ' },\n    { id: 'Information Technology', name: 'Information Technology', icon: 'üíª' },\n    { id: 'Physics', name: 'Physics', icon: '‚öõÔ∏è' },\n    { id: 'Chemistry', name: 'Chemistry', icon: 'üß™' },\n    { id: 'Biology', name: 'Biology', icon: 'üß¨' },\n    { id: 'Economics', name: 'Economics', icon: 'üìà' },\n    { id: 'History', name: 'History', icon: 'üìú' },\n    { id: 'Physical Education', name: 'Physical Education', icon: '‚öΩ' },\n]\n\nconst SOURCES = [\n    { id: 'tiktok', name: 'TikTok', icon: 'üì±' },\n    { id: 'google', name: 'Google Search', icon: 'üîç' },\n    { id: 'friends', name: 'Friends/Family', icon: 'ü§ù' },\n    { id: 'youtube', name: 'YouTube', icon: 'üì∫' },\n    { id: 'social', name: 'Facebook/Instagram', icon: 'ü§≥' },\n    { id: 'news', name: 'News/Blog', icon: 'üì∞' },\n    { id: 'other', name: 'Other', icon: '‚ú®' },\n]\n\nconst EXAM_TYPES = [\n    { id: 'csec', name: 'CSEC', desc: 'Caribbean Secondary Education Certificate', icon: 'üìö' },\n    { id: 'cape', name: 'CAPE', desc: 'Caribbean Advanced Proficiency Examination', icon: 'üéì' },\n]\n\n// Schools data imported from JSON\nimport schoolsData from '@/data/schools.json'\nconst COUNTRIES = Object.keys(schoolsData) as (keyof typeof schoolsData)[]\n\nconst PROFICIENCY_LEVELS = [\n    { id: '1', label: \"I'm new to this\", desc: \"Starting from ground zero\", icon: 'üå±' },\n    { id: '2', label: \"I know some basics\", desc: \"I can handle simple concepts\", icon: 'üåø' },\n    { id: '3', label: \"I'm intermediate\", desc: \"I understand core theories\", icon: 'üå≥' },\n    { id: '4', label: \"I'm advanced\", desc: \"I'm ready for exam-style challenges\", icon: 'üöÄ' },\n]\n\ntype NotificationStatus = 'default' | 'granted' | 'denied' | 'unsupported' | 'skipped'\n\nconst NOTIFICATION_PERKS = [\n    {\n        id: 'streaks',\n        title: 'Streak reminders',\n        description: 'Quick nudges from Professor Bright to keep your momentum alive.',\n        pose: 'owl-wink'\n    },\n    {\n        id: 'missions',\n        title: 'New missions',\n        description: 'Get notified when fresh challenges and lessons drop.',\n        pose: 'owl-idea'\n    },\n    {\n        id: 'tips',\n        title: 'Exam tips',\n        description: 'Short bursts of prep help before big assessment days.',\n        pose: 'owl-smart'\n    }\n]\n\n// --- Sub-Components (Steps) ---\n\nconst MascotOwl = ({ pose = 'owl-happy', size = 'sm' }: { pose?: string, size?: 'sm' | 'md' | 'lg' }) => {\n    const sizes = { sm: 48, md: 96, lg: 192 }\n    const pixels = sizes[size]\n\n    const poses: Record<string, number> = {\n        'owl-happy': 0, 'owl-relieved': 1, 'owl-shocked': 2, 'owl-sad-rain': 3,\n        'owl-thinking': 4, 'owl-sad-cloud': 5, 'owl-idea': 6, 'owl-smart': 7,\n        'owl-wink': 8, 'owl-confused': 9, 'owl-reading': 10, 'owl-studying': 11,\n        'owl-sleeping': 12, 'owl-magic': 13, 'owl-zzz': 14, 'owl-bored': 15\n    }\n    const index = poses[pose] || 0\n    const row = Math.floor(index / 4)\n    const col = index % 4\n\n    const posX = (col * 100) / 3\n    const posY = (row * 100) / 3\n\n    return (\n        <div\n            style={{\n                width: `${pixels}px`,\n                height: `${pixels}px`,\n                backgroundImage: \"url('/professor-bright-sprite.png')\",\n                backgroundSize: '400% 400%',\n                backgroundPosition: `${posX}% ${posY}%`,\n                imageRendering: 'pixelated',\n                flexShrink: 0\n            }}\n            className=\"shrink-0\"\n        />\n    )\n}\n\nconst StepHeader = ({ progress, onBack }: { progress: number, onBack?: () => void }) => (\n    <header className=\"fixed top-0 left-0 w-full bg-[var(--bg-primary)]/90 backdrop-blur-md z-50 px-6 py-4 flex items-center justify-center border-b-2 border-[var(--border-subtle)]\">\n        <div className=\"max-w-5xl w-full flex items-center gap-4\">\n            <div className=\"flex items-center gap-2 mr-2\">\n                <MascotOwl pose=\"owl-happy\" size=\"sm\" />\n                <span className=\"font-heading font-extrabold text-xl text-[var(--brand-secondary)] tracking-tighter hidden sm:block\">BrightEd</span>\n            </div>\n\n            {onBack && (\n                <button onClick={onBack} className=\"text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\">\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeLinejoin=\"round\"><path d=\"M19 12H5M12 19l-7-7 7-7\" /></svg>\n                </button>\n            )}\n            <div className=\"flex-1 h-4 bg-[var(--bg-secondary)] rounded-full overflow-hidden\">\n                <motion.div\n                    className=\"h-full bg-[var(--brand-secondary)]\"\n                    initial={{ width: 0 }}\n                    animate={{ width: `${progress}%` }}\n                    transition={{ duration: 0.5 }}\n                    style={{ boxShadow: '0 4px 0 rgba(0,0,0,0.1) inset' }}\n                />\n            </div>\n            <button className=\"text-[var(--text-muted)] hover:text-[var(--text-secondary)] font-bold uppercase tracking-widest text-xs ml-4\">\n                Help\n            </button>\n        </div>\n    </header>\n)\n\nconst StepSubjectSelection = ({ selected, onToggle, onNext }: { selected: string[], onToggle: (id: string) => void, onNext: () => void }) => (\n    <div className=\"max-w-4xl mx-auto pt-28 pb-32\">\n        <div className=\"flex flex-col items-center gap-4 mb-10\">\n            <MascotOwl pose=\"owl-happy\" size=\"md\" />\n            <h1 className=\"text-3xl font-extrabold text-[var(--text-primary)] text-center\">I want to learn...</h1>\n            <p className=\"text-[var(--text-secondary)] font-bold\">Pick one or more subjects to get started!</p>\n        </div>\n\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 px-4\">\n            {SUBJECTS.map((s) => {\n                const isSelected = selected.includes(s.id);\n                return (\n                    <button\n                        key={s.id}\n                        onClick={() => onToggle(s.id)}\n                        className={`relative p-6 rounded-3xl border-2 transition-all flex flex-col items-center gap-3 active:translate-y-1 group ${isSelected\n                            ? 'border-[var(--brand-secondary)] bg-[var(--brand-secondary)]/10 text-[var(--brand-secondary)]'\n                            : 'border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:border-[var(--brand-secondary)]/50 text-[var(--text-secondary)]'\n                            }`}\n                        style={{ boxShadow: isSelected ? 'none' : '0 4px 0 var(--border-subtle)' }}\n                    >\n                        <span className=\"text-4xl group-hover:scale-110 transition-transform\">{s.icon}</span>\n                        <span className=\"font-bold text-base text-center\">{s.name}</span>\n                        {isSelected && (\n                            <div className=\"absolute top-2 right-2 bg-[var(--brand-secondary)] text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold\">\n                                ‚úì\n                            </div>\n                        )}\n                    </button>\n                )\n            })}\n        </div>\n\n        <div className=\"fixed bottom-0 left-0 w-full bg-[var(--bg-primary)] border-t-2 border-[var(--border-subtle)] p-6 flex justify-center z-50\">\n            <button\n                onClick={onNext}\n                disabled={selected.length === 0}\n                className=\"max-w-md w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-4 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all disabled:opacity-50 tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n            >\n                CONTINUE\n            </button>\n        </div>\n    </div>\n)\n\nconst StepNotifications = ({\n    status,\n    onEnable,\n    onContinue\n}: {\n    status: NotificationStatus\n    onEnable: () => void\n    onContinue: () => void\n}) => {\n    const statusCopy = {\n        default: {\n            label: 'Optional',\n            detail: 'We only send the good stuff: streaks, missions, and exam nudges.'\n        },\n        granted: {\n            label: 'Enabled',\n            detail: 'You&apos;re all set! Expect friendly reminders and mission updates.'\n        },\n        denied: {\n            label: 'Blocked',\n            detail: 'No worries - you can enable notifications in your browser settings later.'\n        },\n        unsupported: {\n            label: 'Unavailable',\n            detail: 'This browser doesn&apos;t support push notifications yet.'\n        },\n        skipped: {\n            label: 'Skipped',\n            detail: 'You can always turn notifications on from your profile settings.'\n        }\n    } as const\n\n    const statusStyles: Record<NotificationStatus, string> = {\n        default: 'bg-[var(--brand-secondary)]/10 text-[var(--brand-secondary)] border-[var(--brand-secondary)]/30',\n        granted: 'bg-emerald-50 text-emerald-600 border-emerald-200',\n        denied: 'bg-red-50 text-red-500 border-red-200',\n        unsupported: 'bg-slate-100 text-slate-500 border-slate-200',\n        skipped: 'bg-amber-50 text-amber-600 border-amber-200'\n    }\n\n    return (\n        <div className=\"max-w-5xl mx-auto pt-28 pb-32\">\n            <div className=\"flex flex-col items-center gap-6 text-center mb-12 px-4\">\n                <MascotOwl pose={status === 'granted' ? 'owl-magic' : 'owl-idea'} size=\"lg\" />\n                <div>\n                    <h1 className=\"text-3xl font-extrabold text-[var(--text-primary)]\">Turn on push notifications</h1>\n                    <p className=\"text-[var(--text-secondary)] font-bold mt-3 max-w-xl\">\n                        Get streak reminders, exam alerts, and quick tips - just enough to keep you moving.\n                    </p>\n                </div>\n                <div className={`px-4 py-2 rounded-full border-2 text-xs font-black uppercase tracking-widest ${statusStyles[status]}`}>\n                    {statusCopy[status].label}\n                </div>\n                <p className=\"text-[var(--text-muted)] font-bold text-sm max-w-md\">\n                    {statusCopy[status].detail}\n                </p>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-[1.1fr_1fr] gap-6 px-4\">\n                <div className=\"space-y-4\">\n                    {NOTIFICATION_PERKS.map((perk) => (\n                        <div\n                            key={perk.id}\n                            className=\"flex items-start gap-4 rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] p-5 shadow-sm\"\n                        >\n                            <div className=\"bg-[var(--brand-secondary)]/10 rounded-2xl p-2\">\n                                <MascotOwl pose={perk.pose} size=\"sm\" />\n                            </div>\n                            <div>\n                                <p className=\"text-lg font-extrabold text-[var(--text-primary)]\">{perk.title}</p>\n                                <p className=\"text-[var(--text-secondary)] font-bold\">{perk.description}</p>\n                            </div>\n                        </div>\n                    ))}\n                </div>\n\n                <div className=\"relative rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] p-6 shadow-sm overflow-hidden\">\n                    <div className=\"flex items-center justify-between text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">\n                        <div className=\"flex items-center gap-2\">\n                            <span className=\"w-2.5 h-2.5 rounded-full bg-red-400\" />\n                            <span className=\"w-2.5 h-2.5 rounded-full bg-yellow-400\" />\n                            <span className=\"w-2.5 h-2.5 rounded-full bg-green-400\" />\n                        </div>\n                        <span>Browser Prompt</span>\n                    </div>\n\n                    <div className=\"mt-6 flex items-start gap-4\">\n                        <div className=\"w-14 h-14 rounded-2xl bg-[var(--brand-secondary)]/10 flex items-center justify-center\">\n                            <MascotOwl pose=\"owl-thinking\" size=\"sm\" />\n                        </div>\n                        <div>\n                            <p className=\"text-base font-extrabold text-[var(--text-primary)]\">BrightEd wants to send notifications</p>\n                            <p className=\"text-sm font-bold text-[var(--text-secondary)]\">Click Allow to get streak nudges and mission drops.</p>\n                        </div>\n                    </div>\n\n                    <div className=\"mt-6 flex items-center justify-end gap-3\">\n                        <button className=\"px-4 py-2 rounded-xl border-2 border-[var(--border-subtle)] text-[var(--text-secondary)] font-bold bg-[var(--bg-secondary)]\">\n                            Block\n                        </button>\n                        <div className=\"relative\">\n                            <div className=\"absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-black uppercase tracking-widest text-[var(--brand-secondary)]\">\n                                Click Allow\n                            </div>\n                            <span className=\"absolute -top-3 left-1/2 -translate-x-1/2 w-2.5 h-2.5 rounded-full bg-[var(--brand-secondary)] animate-ping\" />\n                            <button className=\"px-5 py-2 rounded-xl bg-[var(--brand-secondary)] text-white font-extrabold border-b-4 border-[#4338ca]\">\n                                Allow\n                            </button>\n                        </div>\n                    </div>\n\n                    <div className=\"absolute -bottom-8 -right-6 opacity-70\">\n                        <MascotOwl pose=\"owl-wink\" size=\"sm\" />\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"mt-10 flex flex-col sm:flex-row gap-4 justify-center px-4\">\n                <button\n                    onClick={onEnable}\n                    disabled={status === 'granted' || status === 'unsupported'}\n                    className=\"max-w-md w-full sm:w-auto bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-4 px-8 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n                >\n                    {status === 'granted' ? 'Notifications Enabled' : 'Enable Notifications'}\n                </button>\n                <button\n                    onClick={onContinue}\n                    className=\"max-w-md w-full sm:w-auto bg-[var(--bg-elevated)] text-[var(--text-secondary)] font-extrabold py-4 px-8 rounded-2xl border-2 border-[var(--border-subtle)] hover:border-[var(--brand-secondary)]/50 active:translate-y-1 transition-all tracking-widest uppercase\"\n                >\n                    Continue\n                </button>\n            </div>\n        </div>\n    )\n}\n\nconst StepSourceSelection = ({ onSelect }: { onSelect: (id: string) => void }) => (\n    <div className=\"max-w-2xl mx-auto pt-28\">\n        <div className=\"flex flex-col items-center gap-6 mb-12\">\n            <MascotOwl pose=\"owl-smart\" size=\"lg\" />\n            <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-6 relative shadow-sm max-w-sm\">\n                <p className=\"font-extrabold text-[var(--text-primary)] text-xl text-center\">How did you hear about BrightEd?</p>\n                <div className=\"absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-[var(--bg-elevated)] border-l-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n            </div>\n        </div>\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 px-4\">\n            {SOURCES.map((s) => (\n                <button\n                    key={s.id}\n                    onClick={() => onSelect(s.id)}\n                    className=\"p-5 rounded-2xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] flex items-center gap-4 transition-all active:translate-y-1 border-b-4 font-bold text-[var(--text-secondary)] hover:text-[var(--text-primary)] group\"\n                >\n                    <span className=\"text-3xl group-hover:scale-110 transition-transform\">{s.icon}</span>\n                    <span className=\"text-lg\">{s.name}</span>\n                </button>\n            ))}\n        </div>\n    </div>\n)\n\nconst StepExamSelection = ({ onSelect }: { onSelect: (id: string) => void }) => (\n    <div className=\"max-w-2xl mx-auto pt-28\">\n        <div className=\"flex flex-col items-center gap-6 mb-12\">\n            <MascotOwl pose=\"owl-studying\" size=\"lg\" />\n            <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-6 relative shadow-sm max-w-sm\">\n                <p className=\"font-extrabold text-[var(--text-primary)] text-xl text-center\">What exam are you preparing for?</p>\n                <div className=\"absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-[var(--bg-elevated)] border-l-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n            </div>\n        </div>\n        <div className=\"flex flex-col gap-4 px-4\">\n            {EXAM_TYPES.map((e) => (\n                <button\n                    key={e.id}\n                    onClick={() => onSelect(e.id)}\n                    className=\"p-6 rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] flex items-center gap-6 transition-all active:translate-y-1 border-b-4 text-left group\"\n                >\n                    <span className=\"text-4xl group-hover:scale-110 transition-transform\">{e.icon}</span>\n                    <div>\n                        <p className=\"font-extrabold text-[var(--text-primary)] text-xl\">{e.name}</p>\n                        <p className=\"text-[var(--text-secondary)] font-bold\">{e.desc}</p>\n                    </div>\n                </button>\n            ))}\n        </div>\n    </div>\n)\n\nconst FORM_LEVELS = [\n    { id: '1', label: 'Form 1' },\n    { id: '2', label: 'Form 2' },\n    { id: '3', label: 'Form 3' },\n    { id: '4', label: 'Form 4' },\n    { id: '5', label: 'Form 5' },\n    { id: '6L', label: 'Lower 6' },\n    { id: '6U', label: 'Upper 6' },\n]\n\nconst StepFormSelection = ({ onSelect }: { onSelect: (id: string) => void }) => (\n    <div className=\"max-w-2xl mx-auto pt-28\">\n        <div className=\"flex flex-col items-center gap-6 mb-12\">\n            <MascotOwl pose=\"owl-thinking\" size=\"lg\" />\n            <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-6 relative shadow-sm max-w-sm\">\n                <p className=\"font-extrabold text-[var(--text-primary)] text-xl text-center\">Which form are you in?</p>\n                <div className=\"absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-[var(--bg-elevated)] border-l-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n            </div>\n        </div>\n        <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-4 px-4\">\n            {FORM_LEVELS.map((f) => (\n                <button\n                    key={f.id}\n                    onClick={() => onSelect(f.id)}\n                    className=\"p-6 rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] flex flex-col items-center justify-center transition-all active:translate-y-1 border-b-4 group\"\n                >\n                    <span className=\"text-xl font-extrabold text-[var(--text-primary)]\">{f.label}</span>\n                </button>\n            ))}\n        </div>\n    </div>\n)\n\nconst StepSchoolSelection = ({\n    selectedCountry,\n    selectedSchool,\n    onCountryChange,\n    onSchoolChange,\n    onNext\n}: {\n    selectedCountry: string,\n    selectedSchool: string,\n    onCountryChange: (c: string) => void,\n    onSchoolChange: (s: string) => void,\n    onNext: () => void\n}) => {\n    const schools = selectedCountry ? (schoolsData as Record<string, string[]>)[selectedCountry] || [] : []\n    const [searchTerm, setSearchTerm] = useState('')\n    const filteredSchools = schools.filter(s => s.toLowerCase().includes(searchTerm.toLowerCase()))\n\n    return (\n        <div className=\"max-w-2xl mx-auto pt-28 pb-32\">\n            <div className=\"flex flex-col items-center gap-6 mb-8\">\n                <MascotOwl pose=\"owl-thinking\" size=\"lg\" />\n                <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-6 relative shadow-sm max-w-sm\">\n                    <p className=\"font-extrabold text-[var(--text-primary)] text-xl text-center\">What school do you attend?</p>\n                    <div className=\"absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-[var(--bg-elevated)] border-l-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n                </div>\n            </div>\n\n            <div className=\"px-4 space-y-6\">\n                {/* Country Selection */}\n                <div>\n                    <label className=\"block text-sm font-bold text-[var(--text-muted)] mb-2 uppercase tracking-widest\">Country</label>\n                    <select\n                        value={selectedCountry}\n                        onChange={(e) => { onCountryChange(e.target.value); onSchoolChange(''); setSearchTerm('') }}\n                        className=\"w-full p-4 rounded-2xl bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] text-[var(--text-primary)] font-bold focus:border-[var(--brand-secondary)] focus:outline-none transition-colors\"\n                    >\n                        <option value=\"\">Select your country...</option>\n                        {COUNTRIES.map((c) => (\n                            <option key={c} value={c}>{c}</option>\n                        ))}\n                    </select>\n                </div>\n\n                {/* School Selection */}\n                {selectedCountry && (\n                    <div>\n                        <label className=\"block text-sm font-bold text-[var(--text-muted)] mb-2 uppercase tracking-widest\">School</label>\n                        <input\n                            type=\"text\"\n                            value={searchTerm}\n                            onChange={(e) => setSearchTerm(e.target.value)}\n                            placeholder=\"Search for your school...\"\n                            className=\"w-full p-4 rounded-2xl bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] text-[var(--text-primary)] font-bold focus:border-[var(--brand-secondary)] focus:outline-none transition-colors mb-3\"\n                        />\n                        <div className=\"max-h-64 overflow-y-auto rounded-2xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)]\">\n                            {filteredSchools.map((school) => (\n                                <button\n                                    key={school}\n                                    onClick={() => { onSchoolChange(school); setSearchTerm(school) }}\n                                    className={`w-full p-4 text-left font-bold transition-colors border-b border-[var(--border-subtle)] last:border-b-0 ${selectedSchool === school\n                                        ? 'bg-[var(--brand-secondary)]/10 text-[var(--brand-secondary)]'\n                                        : 'text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]'\n                                        }`}\n                                >\n                                    {school}\n                                    {selectedSchool === school && <span className=\"float-right\">‚úì</span>}\n                                </button>\n                            ))}\n                            {filteredSchools.length === 0 && (\n                                <div className=\"p-4 text-center text-[var(--text-muted)] font-bold\">No schools found</div>\n                            )}\n                        </div>\n                    </div>\n                )}\n            </div>\n\n            <div className=\"fixed bottom-0 left-0 w-full bg-[var(--bg-primary)] border-t-2 border-[var(--border-subtle)] p-6 flex justify-center z-50\">\n                <button\n                    onClick={onNext}\n                    disabled={!selectedSchool}\n                    className=\"max-w-md w-full bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white font-extrabold py-4 rounded-2xl border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 transition-all disabled:opacity-50 tracking-widest uppercase shadow-lg shadow-indigo-500/10\"\n                >\n                    CONTINUE\n                </button>\n            </div>\n        </div>\n    )\n}\n\nconst StepProficiency = ({ subject, onSelect }: { subject: string, onSelect: (id: string) => void }) => (\n    <div className=\"max-w-2xl mx-auto pt-28\">\n        <div className=\"flex flex-col items-center gap-6 mb-12\">\n            <MascotOwl pose=\"owl-reading\" size=\"lg\" />\n            <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-6 relative shadow-sm max-w-sm\">\n                <p className=\"font-extrabold text-[var(--text-primary)] text-xl text-center\">How much <span className=\"text-[var(--brand-secondary)]\">{subject}</span> do you know?</p>\n                <div className=\"absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-[var(--bg-elevated)] border-l-2 border-b-2 border-[var(--border-subtle)] rotate-45\" />\n            </div>\n        </div>\n        <div className=\"flex flex-col gap-4 px-4\">\n            {PROFICIENCY_LEVELS.map((l) => (\n                <button\n                    key={l.id}\n                    onClick={() => onSelect(l.id)}\n                    className=\"p-6 rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] flex items-center gap-6 transition-all active:translate-y-1 border-b-4 text-left group\"\n                >\n                    <span className=\"text-4xl group-hover:scale-110 transition-transform\">{l.icon}</span>\n                    <div>\n                        <p className=\"font-extrabold text-[var(--text-primary)] text-lg\">{l.label}</p>\n                        <p className=\"text-[var(--text-secondary)] font-bold\">{l.desc}</p>\n                    </div>\n                </button>\n            ))}\n        </div>\n    </div>\n)\n\nconst StepPlacement = ({ onChoice }: { onChoice: () => void }) => (\n    <div className=\"max-w-2xl mx-auto pt-28 text-center px-4\">\n        <MascotOwl pose=\"owl-happy\" size=\"md\" />\n        <h1 className=\"text-3xl font-extrabold text-[var(--text-primary)] mt-6 mb-4\">Now let&apos;s find the best place to start!</h1>\n        <p className=\"text-[var(--text-secondary)] font-bold mb-12 text-lg\">We&apos;ll do a quick evaluation with easy questions to calibrate your learning path.</p>\n\n        <div className=\"flex flex-col gap-6 max-w-md mx-auto\">\n            <button\n                onClick={onChoice}\n                className=\"group p-8 rounded-3xl border-2 border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] flex items-center gap-8 transition-all active:translate-y-1 border-b-4 text-left\"\n            >\n                <div className=\"w-16 h-16 bg-[var(--brand-secondary)]/10 rounded-2xl flex items-center justify-center text-4xl group-hover:scale-110 transition-transform\">üöÄ</div>\n                <div>\n                    <h3 className=\"text-xl font-extrabold text-[var(--text-primary)]\">Start Evaluation</h3>\n                    <p className=\"text-[var(--text-secondary)] font-bold\">Begin with simple questions to find your level.</p>\n                </div>\n            </button>\n        </div>\n    </div>\n)\n\n// --- Navigation Layout Wrapper ---\n\nfunction WelcomeContent() {\n    const router = useRouter()\n    const { user } = useAuth()\n    const searchParams = useSearchParams()\n    const [isMounted, setIsMounted] = useState(false)\n    \n    useEffect(() => {\n        setIsMounted(true)\n    }, [])\n    \n    const step = isMounted ? ((searchParams && searchParams.get('step')) || 'selection') : 'selection'\n    const profIndex = isMounted ? parseInt((searchParams && searchParams.get('si')) || '0') : 0\n\n    const [selectedSubjects, setSelectedSubjects] = useState<string[]>(() => {\n        const subs = isMounted ? searchParams?.get('subjects') : null\n        return subs ? subs.split(',').filter(Boolean) : []\n    })\n    const [examType, setExamType] = useState<string | null>(() =>\n        isMounted ? searchParams?.get('exam') || null : null\n    )\n    const [selectedCountry, setSelectedCountry] = useState<string>(() =>\n        isMounted ? searchParams?.get('country') || '' : ''\n    )\n    const [selectedSchool, setSelectedSchool] = useState<string>(() =>\n        isMounted ? searchParams?.get('school') || '' : ''\n    )\n    const [source, setSource] = useState<string | null>(() =>\n        isMounted ? searchParams?.get('source') || null : null\n    )\n    const [formLevel, setFormLevel] = useState<string | null>(() =>\n        isMounted ? searchParams?.get('form') || null : null\n    )\n    const [notificationStatus, setNotificationStatus] = useState<NotificationStatus>('default')\n    const [proficiencies, setProficiencies] = useState<Record<string, string>>(() => {\n        try {\n            const lvls = isMounted ? searchParams?.get('lvls') : null\n            return lvls ? JSON.parse(lvls) : {}\n        } catch (e) {\n            return {}\n        }\n    })\n\n    const toggleSubject = (id: string) => {\n        setSelectedSubjects(prev =>\n            prev.includes(id) ? prev.filter(s => s !== id) : [...prev, id]\n        )\n    }\n\n    const nextStep = (next: string, extraParams?: Record<string, string>) => {\n        const params = new URLSearchParams(searchParams?.toString() || '')\n        params.set('step', next)\n        if (selectedSubjects.length > 0) {\n            params.set('subjects', selectedSubjects.join(','))\n        }\n        if (extraParams) {\n            Object.entries(extraParams).forEach(([k, v]) => params.set(k, v))\n        }\n        router.push(`/welcome?${params.toString()}`)\n    }\n\n    // Sync state from URL params on load/change\n    useEffect(() => {\n        if (typeof window === 'undefined') return\n        if (!('Notification' in window)) {\n            setNotificationStatus('unsupported')\n            return\n        }\n        setNotificationStatus(Notification.permission)\n    }, [])\n\n    useEffect(() => {\n        const subjectsParam = searchParams?.get('subjects')\n        if (subjectsParam) {\n            const subs = subjectsParam.split(',')\n            if (JSON.stringify(subs) !== JSON.stringify(selectedSubjects)) {\n                setSelectedSubjects(subs)\n            }\n        }\n\n        const lvlsParam = searchParams?.get('lvls')\n        if (lvlsParam) {\n            try {\n                const parsed = JSON.parse(lvlsParam)\n                if (JSON.stringify(parsed) !== JSON.stringify(proficiencies)) {\n                    setProficiencies(parsed)\n                }\n            } catch (e) {\n                console.error(\"Failed to parse lvls from URL\", e)\n            }\n        }\n\n        const sourceParam = searchParams?.get('source')\n        if (sourceParam && sourceParam !== source) {\n            setSource(sourceParam)\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [searchParams])\n\n    const goBack = () => {\n        router.back()\n    }\n\n    const logMetadata = async () => {\n        try {\n            await fetch('/api/metadata', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    subjects: selectedSubjects,\n                    source,\n                    proficiencies,\n                    timestamp: new Date().toISOString()\n                })\n            })\n        } catch (err) {\n            console.error('Failed to log metadata:', err)\n        }\n    }\n\n    const requestNotificationPermission = async () => {\n        if (typeof window === 'undefined') return\n        if (!('Notification' in window)) {\n            setNotificationStatus('unsupported')\n            return\n        }\n        const permission = await Notification.requestPermission()\n        setNotificationStatus(permission)\n    }\n\n    const onComplete = async (to: string, finalNotificationStatus: NotificationStatus = notificationStatus) => {\n        await logMetadata()\n\n        // If user is already logged in, update their profile\n        if (user) {\n            try {\n                await updateDoc(doc(db, 'users', user.uid), {\n                    subjects: selectedSubjects,\n                    examTrack: examType || 'CSEC',\n                    country: selectedCountry || 'Trinidad and Tobago',\n                    school: selectedSchool || null,\n                    formLevel: formLevel || '3',\n                    source: source || 'other',\n                    proficiencies: proficiencies,\n                    notificationPermission: finalNotificationStatus,\n                    onboardingCompleted: true,\n                    onboardingCompletedAt: new Date().toISOString(),\n                    updatedAt: new Date().toISOString()\n                })\n            } catch (err) {\n                console.error('Failed to update user profile:', err)\n            }\n        }\n\n        const params = new URLSearchParams()\n        params.set('subjects', selectedSubjects.join(','))\n        if (examType) params.set('exam', examType)\n        if (selectedCountry) params.set('country', selectedCountry)\n        if (selectedSchool) params.set('school', selectedSchool)\n        if (formLevel) params.set('form', formLevel)\n        if (source) params.set('source', source)\n        params.set('lvls', JSON.stringify(proficiencies))\n        params.set('notify', finalNotificationStatus)\n\n        if (user && to === '/welcome/diagnostic') {\n            router.push(to)\n            return\n        }\n\n        router.push(`${to}?${params.toString()}`)\n    }\n\n    // Determine progress\n    const stepsOrder = ['selection', 'exam', 'school', 'form', 'source', 'proficiency', 'placement', 'notifications']\n    const currentIndex = stepsOrder.indexOf(step)\n\n    // Calculate total mini-steps if in proficiency\n    let displayProgress = ((currentIndex) / stepsOrder.length) * 100\n    if (step === 'proficiency') {\n        const subProgress = (profIndex / selectedSubjects.length) / stepsOrder.length\n        displayProgress += subProgress * 100\n    }\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)]\">\n            <StepHeader progress={displayProgress} onBack={currentIndex > 0 ? goBack : undefined} />\n\n            <main className=\"p-6\">\n                <AnimatePresence mode=\"wait\">\n                    <motion.div\n                        key={step + (step === 'proficiency' ? profIndex : '')}\n                        initial={{ opacity: 0, x: 20 }}\n                        animate={{ opacity: 1, x: 0 }}\n                        exit={{ opacity: 0, x: -20 }}\n                        transition={{ duration: 0.3 }}\n                    >\n                        {step === 'selection' && (\n                            <StepSubjectSelection\n                                selected={selectedSubjects}\n                                onToggle={toggleSubject}\n                                onNext={() => nextStep('exam')}\n                            />\n                        )}\n                        {step === 'exam' && (\n                            <StepExamSelection\n                                onSelect={(id) => {\n                                    setExamType(id)\n                                    nextStep('school', { exam: id })\n                                }}\n                            />\n                        )}\n\n                        {step === 'school' && (\n                            <StepSchoolSelection\n                                selectedCountry={selectedCountry}\n                                selectedSchool={selectedSchool}\n                                onCountryChange={setSelectedCountry}\n                                onSchoolChange={setSelectedSchool}\n                                onNext={() => nextStep('form', { country: selectedCountry, school: selectedSchool })}\n                            />\n                        )}\n                        {step === 'form' && (\n                            <StepFormSelection\n                                onSelect={(id) => {\n                                    setFormLevel(id)\n                                    nextStep('source', { form: id })\n                                }}\n                            />\n                        )}\n                        {step === 'source' && (\n                            <StepSourceSelection\n                                onSelect={(id) => {\n                                    setSource(id);\n                                    nextStep('proficiency', { source: id })\n                                }}\n                            />\n                        )}\n                        {step === 'proficiency' && (\n                            <StepProficiency\n                                subject={selectedSubjects[profIndex] || \"Learning\"}\n                                onSelect={(id) => {\n                                    const subj = selectedSubjects[profIndex]\n                                    const nextProficiencies = { ...proficiencies, [subj]: id }\n                                    setProficiencies(nextProficiencies)\n\n                                    if (profIndex < selectedSubjects.length - 1) {\n                                        nextStep('proficiency', {\n                                            si: (profIndex + 1).toString(),\n                                            lvls: JSON.stringify(nextProficiencies)\n                                        })\n                                    } else {\n                                        nextStep('placement', {\n                                            lvls: JSON.stringify(nextProficiencies)\n                                        })\n                                    }\n                                }}\n                            />\n                        )}\n                        {step === 'placement' && (\n                            <StepPlacement\n                                onChoice={() => nextStep('notifications')}\n                            />\n                        )}\n                        {step === 'notifications' && (\n                            <StepNotifications\n                                status={notificationStatus}\n                                onEnable={requestNotificationPermission}\n                                onContinue={() => {\n                                    const finalStatus = notificationStatus === 'default' ? 'skipped' : notificationStatus\n                                    setNotificationStatus(finalStatus)\n                                    onComplete(user ? '/welcome/diagnostic' : '/signup', finalStatus)\n                                }}\n                            />\n                        )}\n                    </motion.div>\n                </AnimatePresence>\n            </main>\n        </div>\n    )\n}\n\nexport default function WelcomePage() {\n    return (\n        <Suspense fallback={<div className=\"min-h-screen flex items-center justify-center text-slate-400 font-bold\">Loading...</div>}>\n            <WelcomeContent />\n        </Suspense>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/AuthGate.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ONBOARDING_PATHS' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":8,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useEffect, useState } from 'react'\nimport { usePathname, useRouter } from 'next/navigation'\nimport { useAuth } from '@/lib/auth-context'\n\nconst PUBLIC_PATHS = new Set<string>(['/', '/landing', '/login', '/signup', '/welcome'])\nconst ONBOARDING_PATHS = ['/welcome']\nconst PROTECTED_PATHS = ['/home', '/community', '/learn', '/simulate', '/lesson', '/leaderboard', '/profile', '/achievements', '/practicals', '/progress']\n\nexport function AuthGate({ children }: { children: React.ReactNode }) {\n  const router = useRouter()\n  const pathname = usePathname() || '/'\n  const { user, userData, loading } = useAuth()\n  const [isChecking, setIsChecking] = useState(true)\n\n  useEffect(() => {\n    if (loading) return\n\n    const isPublic = PUBLIC_PATHS.has(pathname) || pathname.startsWith('/welcome')\n    const isOnboarding = pathname.startsWith('/welcome') && !pathname.includes('/diagnostic')\n    const isDiagnostic = pathname.includes('/welcome/diagnostic')\n    const isProtected = PROTECTED_PATHS.some(p => pathname.startsWith(p))\n\n    // Not logged in\n    if (!user) {\n      if (!isPublic) {\n        router.replace('/')\n      }\n      setIsChecking(false)\n      return\n    }\n\n    // Check completion status from userData (Firestore) with localStorage fallback\n    // This prevents random redirects to /welcome if Firestore is slow or flickering\n    const localOnboarding = typeof window !== 'undefined' ? localStorage.getItem('brighted_onboarding_complete') === 'true' : false\n    const localDiagnostic = typeof window !== 'undefined' ? localStorage.getItem('brighted_diagnostic_complete') === 'true' : false\n\n    const onboardingDone = userData?.onboardingCompleted === true || localOnboarding\n    const diagnosticDone = userData?.diagnosticCompleted === true || localDiagnostic\n\n    // Sync TO localStorage for fast checks on subsequent loads\n    if (typeof window !== 'undefined') {\n      if (userData?.onboardingCompleted === true) localStorage.setItem('brighted_onboarding_complete', 'true')\n      if (userData?.diagnosticCompleted === true) localStorage.setItem('brighted_diagnostic_complete', 'true')\n    }\n\n    // Route logic\n    if (!onboardingDone) {\n      // User hasn't completed basic onboarding\n      if (!isOnboarding || isDiagnostic) {\n        // Double check loading state before forcing redirect\n        if (!loading && userData !== undefined) {\n          router.replace('/welcome')\n          setIsChecking(false)\n          return\n        }\n      }\n    } else if (!diagnosticDone) {\n      // Onboarding done, but diagnostic not done\n      if (isProtected || pathname === '/') {\n        // Block protected routes, force to diagnostic\n        router.replace('/welcome/diagnostic')\n        setIsChecking(false)\n        return\n      }\n      // Allow access to diagnostic page\n      if (isOnboarding && !isDiagnostic) {\n        // If they try to go back to regular onboarding, push to diagnostic\n        router.replace('/welcome/diagnostic')\n        setIsChecking(false)\n        return\n      }\n    } else {\n      // Both complete - user has full access\n      // Redirect away from onboarding and diagnostic if fully done\n      if (isOnboarding || isDiagnostic) {\n        router.replace('/home')\n        setIsChecking(false)\n        return\n      }\n      // Redirect root to home\n      if (pathname === '/' || (isPublic && !isProtected)) {\n        router.replace('/home')\n        setIsChecking(false)\n        return\n      }\n    }\n\n    setIsChecking(false)\n  }, [loading, user, userData, pathname, router])\n\n  // Show loading while checking auth state\n  if (loading || isChecking) {\n    return (\n      <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"relative\">\n            <div className=\"animate-spin rounded-full h-16 w-16 border-4 border-[var(--brand-primary)]/20 border-t-[var(--brand-primary)]\" />\n            <div className=\"absolute inset-0 flex items-center justify-center\">\n              <span className=\"text-2xl\">ü¶â</span>\n            </div>\n          </div>\n          <p className=\"text-[var(--text-muted)] font-bold text-sm uppercase tracking-widest animate-pulse\">\n            Loading BrightEd...\n          </p>\n        </div>\n      </div>\n    )\n  }\n\n  return <>{children}</>\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/BCoinIcon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/ConditionalMain.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/ConditionalNavigation.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isOnboardingPage' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":8,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { usePathname } from 'next/navigation'\nimport { Navigation } from './Navigation'\n\nexport function ConditionalNavigation() {\n  const pathname = usePathname()\n  const isOnboardingPage = pathname?.startsWith('/welcome')\n  const isLandingPage = pathname === '/' || pathname === '/signup' || pathname === '/login' || (pathname?.startsWith('/welcome') && !pathname?.startsWith('/welcome/diagnostic'))\n  const isImmersivePractical = pathname?.startsWith('/practicals/technology-practicality')\n\n  const isDiagnostic = pathname?.startsWith('/welcome/diagnostic')\n\n  // Use minimal navigation for diagnostic\n  if (isDiagnostic) {\n    return <Navigation variant=\"minimal\" />\n  }\n\n  // Hide navigation on immersive practicals AND landing page (which has its own header)\n  if (isImmersivePractical || isLandingPage) {\n    return null\n  }\n\n  // Show navigation on all other pages\n  return <Navigation />\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/ConsoleBrandSplash.tsx","messages":[],"suppressedMessages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":140,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":140,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7984,8021],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8073,8100],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":144,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":144,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8152,8228],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":146,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":146,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8280,8328],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/HydrationFix.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/Navigation.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isActive' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":126,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":126,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useEffect, useState } from 'react'\nimport Link from 'next/link'\nimport { usePathname } from 'next/navigation'\nimport Image from 'next/image'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { ThemeToggle } from './system/ThemeToggle'\nimport { useAuth } from '@/lib/auth-context'\nimport { BCoinIcon } from '@/components/BCoinIcon'\n\nconst navItems = [\n  { href: '/home', label: 'Home', icon: 'üè†' },\n  { href: '/community', label: 'Community', icon: 'üí¨' },\n  { href: '/learn', label: 'Learn', icon: 'üìö' },\n  { href: '/practicals', label: 'Practicals', icon: 'üß™' },\n  { href: '/leaderboard', label: 'Rankings', icon: 'üèÜ' },\n  { href: '/progress', label: 'Progress', icon: 'üìà' },\n  { href: '/achievements', label: 'Locker', icon: 'üéñÔ∏è' },\n  { href: '/profile', label: 'Profile', icon: 'üë§' },\n]\n\nconst publicNavItems = [\n  { href: '/landing', label: 'Home' },\n  { href: '/signup', label: 'Sign Up' },\n  { href: '/login', label: 'Login' },\n]\n\nexport function Navigation({ variant = 'default' }: { variant?: 'default' | 'minimal' }) {\n  const pathname = usePathname()\n  const { user, userData, loading } = useAuth()\n  const [isMenuOpen, setIsMenuOpen] = useState(false)\n  const [scrolled, setScrolled] = useState(false)\n\n  // Derive state\n  const isAuthenticated = !!user\n\n  // Handle Scroll Effect\n  useEffect(() => {\n    const handleScroll = () => setScrolled(window.scrollY > 20)\n    window.addEventListener('scroll', handleScroll)\n    return () => window.removeEventListener('scroll', handleScroll)\n  }, [])\n\n  if (variant === 'minimal') {\n    return (\n      <nav className=\"fixed top-6 left-1/2 -translate-x-1/2 w-[90%] max-w-7xl z-50\">\n        <div className=\"bg-[var(--bg-elevated)]/70 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl px-6 py-4 flex items-center justify-between\">\n          <Link href=\"/\" className=\"flex items-center space-x-3 opacity-80 hover:opacity-100 transition-opacity\">\n            <div className=\"relative w-8 h-8\">\n              <Image src=\"/BrightEdLogo.png\" alt=\"Logo\" fill sizes=\"32px\" className=\"object-contain\" />\n            </div>\n            <span className=\"font-bold text-lg tracking-tight\">BrightEd</span>\n          </Link>\n          <div className=\"p-1 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 transition-colors\">\n            <ThemeToggle />\n          </div>\n        </div>\n      </nav>\n    )\n  }\n\n  return (\n    <nav className={`fixed left-1/2 -translate-x-1/2 z-40 transition-all duration-500 ease-out \n        ${scrolled ? 'top-2 w-[99%] max-w-full' : 'top-4 w-[96%] max-w-[1920px]'}`}\n    >\n      <div className={`relative bg-[var(--bg-elevated)]/80 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.12)] px-3 md:px-6 transition-all duration-300 ${scrolled ? 'py-2' : 'py-3'}`}>\n\n        <div className=\"flex items-center justify-between\">\n          {/* Logo Section */}\n          <Link\n            href={isAuthenticated ? \"/home\" : \"/\"}\n            className=\"flex items-center space-x-3 group relative z-10\"\n          >\n            <div className={`relative transition-all duration-500 ${scrolled ? 'w-8 h-8' : 'w-10 h-10'} group-hover:scale-110 drop-shadow-xl`}>\n              <div className=\"absolute inset-0 bg-[var(--brand-primary)] opacity-20 blur-lg rounded-full group-hover:opacity-40 transition-opacity animate-pulse-slow\" />\n              <Image\n                src=\"/BrightEdLogo.png\"\n                alt=\"BrightEd Logo\"\n                fill\n                sizes=\"(max-width: 768px) 32px, 40px\"\n                className=\"object-contain relative z-10\"\n                priority\n              />\n            </div>\n            <span className={`font-heading font-black text-[var(--text-primary)] tracking-tighter hidden xl:block bg-clip-text text-transparent bg-gradient-to-r from-white via-white to-gray-400 group-hover:via-[var(--brand-primary)] transition-all duration-700 ${scrolled ? 'text-lg' : 'text-xl'}`}>\n              BrightEd\n            </span>\n          </Link>\n\n          {/* Desktop Nav */}\n          <div className=\"hidden 2xl:flex items-center gap-0.5 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2\">\n            {isAuthenticated ? (\n              navItems.map((item) => {\n                const isActive = pathname?.startsWith(item.href)\n                const href = item.label === 'Profile' && userData?.username\n                  ? `/profile/${userData.username}`\n                  : item.href\n\n                return (\n                  <Link\n                    key={item.href}\n                    href={href}\n                    className={`relative px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all duration-300 flex items-center gap-1.5 group/item ${isActive\n                      ? 'text-white'\n                      : 'text-[var(--text-muted)] hover:text-[var(--text-primary)]'\n                      }`}\n                  >\n                    {isActive && (\n                      <motion.div\n                        layoutId=\"nav-pill\"\n                        className=\"absolute inset-0 bg-[var(--brand-primary)] rounded-lg -z-10 shadow-lg shadow-[var(--brand-primary)]/20\"\n                        transition={{ type: 'spring', bounce: 0.2, duration: 0.6 }}\n                      />\n                    )}\n                    <span className={`text-base transition-transform duration-300 group-hover/item:scale-110`}>\n                      {item.icon}\n                    </span>\n                    <span className=\"relative z-10\">{item.label}</span>\n                  </Link>\n                )\n              })\n            ) : (\n              <div className=\"flex gap-1\">\n                {!loading && publicNavItems.map((item) => {\n                  const isActive = pathname === item.href\n                  return (\n                    <Link\n                      key={item.href}\n                      href={item.href}\n                      className={`px-6 py-2 rounded-xl font-black text-xs uppercase tracking-widest transition-all ${item.label === 'Sign Up'\n                        ? 'bg-[var(--brand-primary)] text-white hover:shadow-lg hover:-translate-y-0.5'\n                        : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-white/5'\n                        }`}\n                    >\n                      {item.label}\n                    </Link>\n                  )\n                })}\n              </div>\n            )}\n          </div>\n\n          {/* Right Actions */}\n          <div className=\"flex items-center gap-2 md:gap-3 relative z-10\">\n            {isAuthenticated && (\n              <div className=\"flex items-center gap-1 md:gap-2 bg-white/5 px-2 md:px-3 py-1.5 rounded-2xl border border-white/10\">\n                {/* Flag / Subject */}\n                <div className=\"hidden lg:flex items-center gap-1.5 group/stat cursor-pointer\">\n                  <span className=\"text-lg md:text-xl\">üáπüáπ</span>\n                  <span className=\"text-xs md:text-sm font-black text-white/40 group-hover/stat:text-white transition-colors\">11</span>\n                </div>\n\n                <div className=\"hidden lg:block w-[1px] h-4 bg-white/10 mx-1\" />\n\n                {/* Streak */}\n                <div className=\"flex items-center gap-1.5 group/stat cursor-pointer\">\n                  <span className=\"text-lg md:text-xl filter drop-shadow-[0_0_8px_rgba(255,165,0,0.5)]\">üî•</span>\n                  <span className=\"text-xs md:text-sm font-black text-[var(--brand-accent)]\">{userData?.streak || 0}</span>\n                </div>\n\n                <div className=\"w-[1px] h-4 bg-white/10 mx-0.5\" />\n\n                {/* Gems / B-Coins */}\n                <div className=\"flex items-center gap-1.5 group/stat cursor-pointer\">\n                  <BCoinIcon size={18} className=\"filter drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]\" />\n                  <span className=\"text-xs md:text-sm font-black text-blue-400\">{userData?.bCoins?.toLocaleString() || '0'}</span>\n                </div>\n\n                <div className=\"hidden xs:flex w-[1px] h-4 bg-white/10 mx-0.5\" />\n\n                {/* Hearts / Consistency */}\n                <div className=\"hidden xs:flex items-center gap-1.5 group/stat cursor-pointer\">\n                  <span className=\"text-lg md:text-xl filter drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]\">‚ù§Ô∏è</span>\n                  <span className=\"text-xs md:text-sm font-black text-red-500\">5</span>\n                </div>\n              </div>\n            )}\n\n            <div className=\"bg-white/5 rounded-full p-1 border border-white/5 hover:bg-white/10 transition-colors\">\n              <ThemeToggle />\n            </div>\n\n            {/* Mobile Toggle */}\n            <button\n              onClick={() => setIsMenuOpen(!isMenuOpen)}\n              className=\"xl:hidden ml-1 p-2.5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 active:scale-90 transition-all text-[var(--text-primary)]\"\n              aria-label=\"Toggle menu\"\n            >\n              <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                {isMenuOpen ? (\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2.5} d=\"M6 18L18 6M6 6l12 12\" />\n                ) : (\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2.5} d=\"M4 6h16M4 12h16M4 18h16\" />\n                )}\n              </svg>\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Mobile Menu Dropdown */}\n      <AnimatePresence>\n        {isMenuOpen && (\n          <motion.div\n            initial={{ opacity: 0, y: -10, scale: 0.98 }}\n            animate={{ opacity: 1, y: 0, scale: 1 }}\n            exit={{ opacity: 0, y: -10, scale: 0.98 }}\n            className=\"absolute top-full left-0 right-0 mt-3 p-2\"\n          >\n            <div className=\"bg-[var(--bg-elevated)]/90 backdrop-blur-3xl border border-white/10 rounded-[2rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] p-3 flex flex-col gap-1.5 overflow-hidden\">\n              {isAuthenticated ? (\n                <div className=\"grid grid-cols-2 gap-2\">\n                  {navItems.map((item) => (\n                    <Link\n                      key={item.href}\n                      href={item.label === 'Profile' && userData?.username ? `/profile/${userData.username}` : item.href}\n                      onClick={() => setIsMenuOpen(false)}\n                      className={`p-4 rounded-2xl font-black flex flex-col items-center justify-center gap-2 transition-all active:scale-95 ${pathname?.startsWith(item.href)\n                        ? 'bg-[var(--brand-primary)] text-white shadow-xl shadow-[var(--brand-primary)]/30'\n                        : 'bg-white/5 text-[var(--text-primary)] hover:bg-white/10'\n                        }`}\n                    >\n                      <span className=\"text-2xl\">{item.icon}</span>\n                      <span className=\"text-[10px] uppercase tracking-widest\">{item.label}</span>\n                    </Link>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"flex flex-col gap-2\">\n                  {publicNavItems.map(item => (\n                    <Link\n                      key={item.href}\n                      href={item.href}\n                      onClick={() => setIsMenuOpen(false)}\n                      className={`p-4 rounded-2xl font-black text-center transition-all active:scale-95 ${item.label === 'Sign Up'\n                        ? 'bg-[var(--brand-primary)] text-white'\n                        : 'bg-white/5 text-[var(--text-primary)] hover:bg-white/10'\n                        }`}\n                    >\n                      {item.label}\n                    </Link>\n                  ))}\n                </div>\n              )}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </nav>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/PageTransition.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/ProgressWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/RecommendationCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/SkeletonLoader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/StreakIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/analytics/PostHogPageView.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessAccessGate.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[73,90],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useRouter } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system'\nimport Link from 'next/link'\nimport { useAuth } from '@/lib/auth-context'\n\ninterface BusinessAccessGateProps {\n  children: React.ReactNode\n  subject: string // 'Principles of Business' or 'Accounts'\n}\n\nexport default function BusinessAccessGate({ children, subject }: BusinessAccessGateProps) {\n  const { userData, loading } = useAuth()\n  const router = useRouter()\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n      </div>\n    )\n  }\n\n  // Check if this subject requires business registration\n  const requiresBusiness = subject.toLowerCase().includes('business') || \n                           subject.toLowerCase().includes('principles of business') ||\n                           subject.toLowerCase().includes('accounts') ||\n                           subject.toLowerCase().includes('accounting')\n\n  if (requiresBusiness && !userData?.hasBusiness) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[var(--bg-primary)] p-4\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.95 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"w-full max-w-md\"\n        >\n          <BrightLayer variant=\"glass\" padding=\"lg\" className=\"text-center border-[var(--brand-primary)]/30 neon-glow-primary\">\n            <div className=\"text-6xl mb-6\">üöÄ</div>\n            <BrightHeading level={2} className=\"mb-4\">\n              Empire Required!\n            </BrightHeading>\n            <p className=\"text-[var(--text-secondary)] mb-8 leading-relaxed\">\n              You need to register a business before you can access {subject} simulations. \n              These real-world scenarios require an active business entity.\n            </p>\n            <Link href=\"/practicals/business/register\">\n              <BrightButton variant=\"primary\" size=\"lg\" className=\"w-full mb-4\">\n                Register Your Business\n              </BrightButton>\n            </Link>\n            <button\n              onClick={() => router.back()}\n              className=\"text-sm text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\"\n            >\n              ‚Üê Go Back\n            </button>\n          </BrightLayer>\n        </motion.div>\n      </div>\n    )\n  }\n\n  return <>{children}</>\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessCard3D.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessCreditCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessDuolingoLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"motion"},"fix":{"range":[119,159],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DialogProvider' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogProvider"},"fix":{"range":[181,197],"text":""},"desc":"Remove unused variable \"DialogProvider\"."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React from 'react';\nimport Link from 'next/link';\nimport { usePathname } from 'next/navigation';\nimport { motion } from 'framer-motion';\nimport { BrightHeading, DialogProvider } from '@/components/system';\nimport { useAuth } from '@/lib/auth-context';\n\nconst NAV_ITEMS = [\n    { href: '/practicals/business', label: 'Hub', icon: 'üè†' },\n    { href: '/practicals/business/operations', label: 'Operations', icon: '‚ö°' },\n    { href: '/practicals/business/supply', label: 'Supply', icon: 'üì¶' },\n    { href: '/practicals/business/market', label: 'Market', icon: 'üß∞' },\n    { href: '/practicals/business/team', label: 'Team', icon: 'üë•' },\n    { href: '/practicals/business/credit', label: 'Credit', icon: 'üí≥' },\n    { href: '/practicals/business/stocks', label: 'Stocks', icon: 'üìà' },\n    { href: '/practicals/business/reports', label: 'Reports', icon: 'üìä' },\n    { href: '/practicals/business/meetings', label: 'Meetings', icon: 'üßë‚Äçüíº' },\n];\n\nexport default function BusinessDuolingoLayout({ children }: { children: React.ReactNode }) {\n    const pathname = usePathname();\n    const { userData } = useAuth();\n    const hasBusiness = userData?.hasBusiness || false;\n\n    const masteryPercent = typeof userData?.mastery === 'number'\n        ? Math.round(userData.mastery * 100)\n        : (userData?.globalMastery ? Math.round(userData.globalMastery * 100) : 0);\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)]\">\n            {/* Desktop Sidebar */}\n            <aside className=\"fixed left-0 top-0 h-screen w-64 bg-[var(--bg-elevated)] border-r-2 border-[var(--border-subtle)] hidden lg:flex flex-col p-6 z-50\">\n                <div className=\"flex items-center gap-3 mb-10 px-2\">\n                    <div className=\"w-10 h-10 bg-[var(--brand-primary)] rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-[var(--brand-primary)]/20\">\n                        B\n                    </div>\n                    <BrightHeading level={3} className=\"text-xl tracking-tight\">BrightEd</BrightHeading>\n                </div>\n\n                <nav className=\"flex-1 flex flex-col gap-2\">\n                    {NAV_ITEMS.map((item) => {\n                        const active = pathname === item.href;\n                        const isLocked = !hasBusiness && item.href !== '/practicals/business';\n\n                        return (\n                            <Link\n                                key={item.href}\n                                href={isLocked ? '#' : item.href}\n                                className={`flex items-center justify-between px-4 py-3 rounded-2xl transition-all font-bold text-sm tracking-wide border-2 ${active\n                                    ? 'bg-[var(--brand-primary)]/10 text-[var(--brand-primary)] border-[var(--brand-primary)] shadow-[0_4px_0_0_rgba(var(--brand-primary-rgb),0.2)]'\n                                    : isLocked\n                                        ? 'text-[var(--text-muted)] opacity-50 cursor-not-allowed border-transparent'\n                                        : 'text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)] border-transparent'\n                                    }`}\n                            >\n                                <div className=\"flex items-center gap-4\">\n                                    <span className={`text-xl ${isLocked ? 'grayscale' : ''}`}>{item.icon}</span>\n                                    {item.label}\n                                </div>\n                                {isLocked && <span className=\"text-xs\">üîí</span>}\n                            </Link>\n                        );\n                    })}\n                </nav>\n\n                <div className=\"mt-auto pt-6 border-t border-[var(--border-subtle)]\">\n                    <Link\n                        href=\"/practicals\"\n                        className=\"flex items-center gap-3 px-4 py-3 rounded-2xl text-[var(--text-muted)] hover:text-[var(--text-primary)] font-bold text-sm\"\n                    >\n                        <span>‚Üê</span> Back to Hub\n                    </Link>\n                </div>\n            </aside>\n\n            {/* Main Content Area */}\n            <main className=\"lg:ml-64 min-h-screen relative pb-24 lg:pb-10\">\n                {/* Top Header - Global Stats */}\n                <header className=\"sticky top-0 z-40 bg-[var(--bg-primary)]/80 backdrop-blur-md border-b-2 border-[var(--border-subtle)] py-4 px-6 lg:px-10 flex items-center justify-between\">\n                    <div className=\"lg:hidden\">\n                        <div className=\"w-8 h-8 bg-[var(--brand-primary)] rounded-lg flex items-center justify-center text-white font-black text-lg\">B</div>\n                    </div>\n\n                    <div className=\"flex items-center gap-4 ml-auto\">\n                        <div className=\"flex items-center gap-2 bg-[var(--bg-elevated)] px-4 py-2 rounded-2xl border-2 border-[var(--border-subtle)] border-b-4 shadow-sm\">\n                            <span className=\"text-lg\">üí∞</span>\n                            <span className=\"font-black text-sm\">‡∏ø {userData?.bCoins?.toLocaleString() || '0'}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2 bg-[var(--bg-elevated)] px-4 py-2 rounded-2xl border-2 border-[var(--border-subtle)] border-b-4 shadow-sm\">\n                            <span className=\"text-lg\">‚≠ê</span>\n                            <span className=\"font-black text-sm\">{masteryPercent}%</span>\n                        </div>\n                    </div>\n                </header>\n\n                <div className=\"p-6 lg:p-10 max-w-[1400px] mx-auto\">\n                    {children}\n                </div>\n            </main>\n\n            {/* Mobile Bottom Nav */}\n            <nav className=\"fixed bottom-0 left-0 right-0 bg-[var(--bg-elevated)] border-t-2 border-[var(--border-subtle)] lg:hidden flex items-center gap-2 p-2 z-50 safe-area-inset-bottom overflow-x-auto sleek-scrollbar\">\n                {NAV_ITEMS.map((item) => {\n                    const active = pathname === item.href;\n                    const isLocked = !hasBusiness && item.href !== '/practicals/business';\n\n                    return (\n                        <Link\n                            key={item.href}\n                            href={isLocked ? '#' : item.href}\n                            className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all relative min-w-[64px] ${active ? 'text-[var(--brand-primary)]' : 'text-[var(--text-muted)]'\n                                } ${isLocked ? 'opacity-40 grayscale pointer-events-none' : ''}`}\n                        >\n                            <span className=\"text-2xl\">{item.icon}</span>\n                            <span className=\"text-[10px] font-black uppercase tracking-tighter line-clamp-1\">{item.label}</span>\n                            {isLocked && <span className=\"absolute top-0 right-1 text-[10px]\">üîí</span>}\n                        </Link>\n                    );\n                })}\n            </nav>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessFeed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[24,34],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useState"},"fix":{"range":[15,60],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[152,166],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport Link from 'next/link';\nimport { motion } from 'framer-motion';\nimport { BrightHeading, BrightButton } from '@/components/system';\nimport { useEconomyBusiness } from '@/lib/economy/use-economy-business';\nimport { useAuth } from '@/lib/auth-context';\nimport BusinessCreditCard from '@/components/business/BusinessCreditCard';\nimport BusinessDuolingoLayout from '@/components/business/BusinessDuolingoLayout';\n\nexport default function BusinessHub() {\n    const { user, loading: authLoading } = useAuth();\n    const { business, businessType, loading } = useEconomyBusiness();\n\n    if (authLoading || loading) {\n        return (\n            <div className=\"min-h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--brand-primary)]\" />\n            </div>\n        );\n    }\n\n    if (!user) {\n        return (\n            <div className=\"min-h-screen bg-[var(--bg-primary)] flex items-center justify-center px-4\">\n                <div className=\"duo-card max-w-md w-full text-center\">\n                    <BrightHeading level={2} className=\"mb-3\">Sign in required</BrightHeading>\n                    <p className=\"text-[var(--text-secondary)] mb-6\">Please sign in to access your business.</p>\n                    <Link href=\"/\">\n                        <button className=\"duo-btn duo-btn-primary w-full\">Go Home</button>\n                    </Link>\n                </div>\n            </div>\n        );\n    }\n\n    if (!business) {\n        return (\n            <BusinessDuolingoLayout>\n                <div className=\"max-w-xl mx-auto py-20 text-center\">\n                    <motion.div\n                        initial={{ opacity: 0, scale: 0.9 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        className=\"duo-card border-dashed border-2 border-[var(--brand-primary)]/30\"\n                    >\n                        <div className=\"text-7xl mb-6\">üíº</div>\n                        <BrightHeading level={2} className=\"mb-4\">Start Your Empire</BrightHeading>\n                        <p className=\"text-[var(--text-secondary)] mb-8 text-lg font-medium\">\n                            Register your first business to unlock the simulation dashboard and start building your legacy.\n                        </p>\n                        <Link href=\"/practicals/business/register\" className=\"w-full\">\n                            <button className=\"duo-btn duo-btn-primary w-full py-4 text-lg\">\n                                Create Business\n                            </button>\n                        </Link>\n                    </motion.div>\n                </div>\n            </BusinessDuolingoLayout>\n        );\n    }\n\n    const MENU_ITEMS = [\n        {\n            href: '/practicals/business/operations',\n            label: 'Operations',\n            desc: 'Fulfill orders and earn revenue',\n            icon: '‚ö°',\n            color: 'text-amber-500'\n        },\n        {\n            href: '/practicals/business/supply',\n            label: 'Supply',\n            desc: 'Manage inventory and restock',\n            icon: 'üì¶',\n            color: 'text-blue-500'\n        },\n        {\n            href: '/practicals/business/market',\n            label: 'Market',\n            desc: 'Upgrade tools and systems',\n            icon: 'üß∞',\n            color: 'text-indigo-500'\n        },\n        {\n            href: '/practicals/business/team',\n            label: 'Team',\n            desc: 'Manage payroll and hire staff',\n            icon: 'üë•',\n            color: 'text-green-500'\n        },\n        {\n            href: '/practicals/business/credit',\n            label: 'Credit',\n            desc: 'Cards, limits and vendor lines',\n            icon: 'üí≥',\n            color: 'text-purple-500'\n        },\n        {\n            href: '/practicals/business/stocks',\n            label: 'Stocks',\n            desc: 'Trade and grow your portfolio',\n            icon: 'üìà',\n            color: 'text-rose-500'\n        },\n        {\n            href: '/practicals/business/reports',\n            label: 'Reports',\n            desc: 'Financials and performance',\n            icon: 'üìä',\n            color: 'text-cyan-500'\n        },\n        {\n            href: '/practicals/business/meetings',\n            label: 'Meetings',\n            desc: 'Run business calls & decisions',\n            icon: 'üßë‚Äçüíº',\n            color: 'text-amber-500'\n        },\n    ];\n\n    return (\n        <BusinessDuolingoLayout>\n            <div className=\"space-y-10\">\n                <section className=\"flex flex-col md:flex-row gap-10 items-start\">\n                    <div className=\"flex-1 space-y-4\">\n                        <div className=\"text-xs font-black uppercase tracking-[0.2em] text-[var(--brand-primary)]\">Business Entity</div>\n                        <BrightHeading level={1} className=\"text-5xl\">{business.businessName}</BrightHeading>\n                        <p className=\"text-xl text-[var(--text-secondary)] font-bold\">\n                            {businessType?.name || 'Venture'} ‚Ä¢ <span className=\"text-[var(--state-success)] font-black\">Startup Tier</span>\n                        </p>\n\n                        <div className=\"pt-4\">\n                            <BusinessCreditCard\n                                businessName={business.businessName}\n                                ownerName={user.displayName || 'Director'}\n                                themeColor={business.branding?.themeColor}\n                                logoUrl={business.branding?.logoUrl}\n                                icon={business.branding?.icon}\n                            />\n                        </div>\n                    </div>\n\n                    <div className=\"w-full md:w-80 space-y-4\">\n                        <div className=\"duo-card bg-[var(--brand-primary)] text-white border-transparent\">\n                            <div className=\"text-xs font-black uppercase tracking-widest opacity-80 mb-1\">Current Status</div>\n                            <div className=\"text-2xl font-black mb-4\">Operations Active</div>\n                            <Link href=\"/practicals/business/operations\">\n                                <button className=\"duo-btn w-full bg-white text-[var(--brand-primary)] shadow-[0_5px_0_0_#e2e8f0]\">\n                                    Enter Console\n                                </button>\n                            </Link>\n                        </div>\n\n                        <div className=\"duo-card\">\n                            <div className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)] mb-1\">Reputation</div>\n                            <div className=\"text-3xl font-black text-[var(--text-primary)]\">{business.reputation}/100</div>\n                            <div className=\"mt-2 w-full bg-[var(--bg-secondary)] h-3 rounded-full overflow-hidden border border-[var(--border-subtle)]\">\n                                <motion.div\n                                    initial={{ width: 0 }}\n                                    animate={{ width: `${business.reputation}%` }}\n                                    className=\"h-full bg-gradient-to-r from-[var(--brand-primary)] to-[var(--brand-accent)]\"\n                                />\n                            </div>\n                        </div>\n                    </div>\n                </section>\n\n                <section>\n                    <div className=\"flex items-center justify-between mb-6\">\n                        <BrightHeading level={3}>Management Suite</BrightHeading>\n                    </div>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-8\">\n                        {MENU_ITEMS.map((item) => (\n                            <Link key={item.href} href={item.href} className=\"group\">\n                                <div className=\"duo-card h-full group-hover:border-[var(--brand-primary)] transition-colors\">\n                                    <div className={`text-4xl mb-4 ${item.color}`}>{item.icon}</div>\n                                    <div className=\"text-xl font-black text-[var(--text-primary)] mb-1\">{item.label}</div>\n                                    <div className=\"text-sm text-[var(--text-secondary)] font-medium leading-relaxed\">\n                                        {item.desc}\n                                    </div>\n                                    <div className=\"mt-auto pt-6 flex justify-end\">\n                                        <div className=\"w-10 h-10 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-[var(--text-muted)] group-hover:bg-[var(--brand-primary)] group-hover:text-white transition-all\">\n                                            ‚Üí\n                                        </div>\n                                    </div>\n                                </div>\n                            </Link>\n                        ))}\n                    </div>\n                </section>\n            </div>\n        </BusinessDuolingoLayout>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessMeetingTablet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessRegistration.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[493,506],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":35,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightLayer"},"fix":{"range":[484,549],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1271,1274],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1271,1274],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used. Allowed unused caught errors must match /^_/u.","line":277,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":277,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":277,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13649,13652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13649,13652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { BrightHeading } from '@/components/system';\nimport { BusinessTypeSelector } from '@/components/business/BusinessTypeSelector';\nimport { BusinessType } from '@/lib/economy/economy-types';\nimport { getFirebaseAuth } from '@/lib/firebase';\nimport { useAuth } from '@/lib/auth-context';\nimport Link from 'next/link';\nimport { BrightButton, BrightLayer } from '@/components/system';\nimport BusinessCreditCard from '@/components/business/BusinessCreditCard';\nimport { useDialog } from '@/components/system';\n\ninterface BusinessRegistrationProps {\n    onComplete: (name: string) => void;\n}\n\nexport default function BusinessRegistration({ onComplete }: BusinessRegistrationProps) {\n    const router = useRouter();\n    const { userData, loading } = useAuth();\n    const [step, setStep] = useState<'select' | 'processing' | 'success'>('select');\n    const [error, setError] = useState<string | null>(null);\n    const [registeredName, setRegisteredName] = useState('');\n    const { showConfirm } = useDialog();\n\n    // State for existing business management\n    const [businessData, setBusinessData] = useState<any>(null);\n    const [fetchingBusiness, setFetchingBusiness] = useState(false);\n    const [actionLoading, setActionLoading] = useState(false);\n\n    // Fetch business data if user has one\n    useEffect(() => {\n        if (userData?.hasBusiness && userData.businessID) {\n            setFetchingBusiness(true);\n            let unsub: (() => void) | undefined;\n\n            import('@/lib/firebase').then(({ getFirebaseDb }) => {\n                import('firebase/firestore').then(({ doc, onSnapshot }) => {\n                    const db = getFirebaseDb();\n                    unsub = onSnapshot(doc(db, 'businesses', userData.businessID!), (snap) => {\n                        if (snap.exists()) {\n                            setBusinessData({ id: snap.id, ...snap.data() });\n                        } else {\n                            // Handle orphan case in dashboard view specific logic if needed\n                            setBusinessData(null);\n                        }\n                        setFetchingBusiness(false);\n                    });\n                });\n            });\n\n            return () => {\n                if (unsub) unsub();\n            };\n        }\n    }, [userData?.hasBusiness, userData?.businessID]);\n\n    const handleToggleStatus = async () => {\n        const auth = getFirebaseAuth();\n        if (!auth.currentUser) return;\n        setActionLoading(true);\n        try {\n            const token = await auth.currentUser.getIdToken();\n            await fetch('/api/business/toggle-status', {\n                method: 'POST',\n                headers: { Authorization: `Bearer ${token}` }\n            });\n            // Snapshot will update UI\n        } catch (e) {\n            console.error(e);\n        } finally {\n            setActionLoading(false);\n        }\n    };\n\n    const handleShutdown = async () => {\n        showConfirm(\n            'Are you sure you want to SHUT DOWN your business? This cannot be undone and you will lose all progress permanently.',\n            async () => {\n                const auth = getFirebaseAuth();\n                if (!auth.currentUser) return;\n                setActionLoading(true);\n                try {\n                    const token = await auth.currentUser.getIdToken();\n                    const res = await fetch('/api/business/shutdown', {\n                        method: 'POST',\n                        headers: { Authorization: `Bearer ${token}` }\n                    });\n\n                    if (res.ok) {\n                        window.location.reload();\n                    }\n                } catch (e) {\n                    console.error(e);\n                } finally {\n                    setActionLoading(false);\n                }\n            },\n            { title: 'DISSOLVE ENTITY', type: 'danger', confirmLabel: 'SHUTDOWN' }\n        );\n    };\n\n    // View: Already Has Business (Dashboard)\n    if (!loading && userData?.hasBusiness) {\n        if (fetchingBusiness && !businessData) {\n            return <div className=\"p-12 text-center text-[var(--text-muted)] animate-pulse\">Loading Empire...</div>;\n        }\n\n        return (\n            <div className=\"max-w-4xl mx-auto\">\n                <div className=\"duo-card p-0 overflow-hidden\">\n                    {/* Header */}\n                    <div className=\"bg-gradient-to-r from-[var(--bg-secondary)] to-[var(--bg-elevated)] p-8 border-b-2 border-[var(--border-subtle)] flex flex-col md:flex-row items-center justify-between gap-6\">\n                        <div>\n                            <div className=\"flex items-center gap-3 mb-2\">\n                                <div className=\"text-4xl\">{businessData?.branding?.icon || businessData?.category?.emoji || 'üè¢'}</div>\n                                <BrightHeading level={2} className=\"text-3xl tracking-tight m-0\">\n                                    {businessData?.businessName || 'Your Business'}\n                                </BrightHeading>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                                <div className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border-2 ${businessData?.status === 'paused'\n                                    ? 'bg-amber-500/10 text-amber-500 border-amber-500/20'\n                                    : 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20'\n                                    }`}>\n                                    {businessData?.status === 'paused' ? '‚è∏ Operations Paused' : '‚óè Active Entity'}\n                                </div>\n                                <span className=\"text-xs text-[var(--text-muted)] font-black tracking-widest uppercase\">ID: {userData.businessID?.slice(0, 8)}</span>\n                            </div>\n                        </div>\n\n                        <Link href=\"/practicals/business/operations\">\n                            <button className=\"duo-btn duo-btn-primary px-8\">\n                                Enter Console\n                            </button>\n                        </Link>\n                    </div>\n\n                    {/* Content */}\n                    <div className=\"p-8 grid grid-cols-1 md:grid-cols-2 gap-10 items-center\">\n                        {/* Left: Card Visualization */}\n                        <div className=\"relative group perspective-1000\">\n                            <div className=\"absolute inset-x-8 -bottom-4 h-10 bg-black/20 blur-xl rounded-full opacity-60\" />\n\n                            <BusinessCreditCard\n                                businessName={businessData?.businessName || 'Business'}\n                                ownerName={businessData?.ownerName || 'DIRECTOR'}\n                                themeColor={businessData?.branding?.themeColor}\n                                logoUrl={businessData?.branding?.logoUrl}\n                                icon={businessData?.branding?.icon}\n                                cardLabel={businessData?.status === 'paused' ? 'PAUSED' : 'ACTIVE'}\n                                className=\"transform transition-transform duration-500 hover:rotate-y-12 hover:rotate-x-6 hover:scale-105\"\n                            />\n                        </div>\n\n                        {/* Right: Actions */}\n                        <div className=\"space-y-6\">\n                            <div className=\"bg-[var(--bg-secondary)] rounded-3xl p-6 border-2 border-[var(--border-subtle)] space-y-4\">\n                                <h3 className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)]\">Entity Controls</h3>\n\n                                <button\n                                    onClick={handleToggleStatus}\n                                    disabled={actionLoading}\n                                    className=\"w-full flex items-center justify-between p-4 rounded-2xl bg-[var(--bg-elevated)] hover:bg-[var(--bg-primary)] border-2 border-[var(--border-subtle)] border-b-4 active:border-b-2 active:translate-y-0.5 transition-all group\"\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className=\"w-10 h-10 rounded-xl bg-amber-500/20 text-amber-500 flex items-center justify-center text-xl group-hover:scale-110 transition-transform\">\n                                            {businessData?.status === 'paused' ? '‚ñ∂Ô∏è' : '‚è∏'}\n                                        </div>\n                                        <div className=\"text-left\">\n                                            <div className=\"text-sm font-black text-[var(--text-primary)]\">\n                                                {businessData?.status === 'paused' ? 'Resume Operations' : 'Pause Operations'}\n                                            </div>\n                                            <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-secondary)] opacity-60\">\n                                                {businessData?.status === 'paused' ? 'Start daily costs' : 'Halt costs and revenue'}\n                                            </div>\n                                        </div>\n                                    </div>\n                                    {actionLoading && <div className=\"text-xl animate-spin\">‚è≥</div>}\n                                </button>\n\n                                <button\n                                    onClick={handleShutdown}\n                                    disabled={actionLoading}\n                                    className=\"w-full flex items-center justify-between p-4 rounded-2xl bg-red-500/5 hover:bg-red-500/10 border-2 border-red-500/20 border-b-4 active:border-b-2 active:translate-y-0.5 transition-all group\"\n                                >\n                                    <div className=\"flex items-center gap-3\">\n                                        <div className=\"w-10 h-10 rounded-xl bg-red-500/20 text-red-500 flex items-center justify-center text-xl group-hover:scale-110 transition-transform\">\n                                            üõë\n                                        </div>\n                                        <div className=\"text-left\">\n                                            <div className=\"text-sm font-black text-red-600\">\n                                                Dissolve Entity\n                                            </div>\n                                            <div className=\"text-[10px] font-black uppercase tracking-widest text-red-500/60\">\n                                                Permanent reset\n                                            </div>\n                                        </div>\n                                    </div>\n                                </button>\n                            </div>\n\n                            <p className=\"text-[10px] uppercase font-black tracking-widest text-center text-[var(--text-muted)]\">\n                                Registry of Currencydom Registered\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        );\n    }\n\n    const handleRegistration = async (\n        type: BusinessType,\n        name: string,\n        branding?: { themeColor?: string; logoUrl?: string; icon?: string }\n    ) => {\n        const auth = getFirebaseAuth();\n        const user = auth.currentUser;\n        if (!user) {\n            setError('Please log in again to register.');\n            return;\n        }\n\n        setStep('processing');\n        setError(null);\n\n        try {\n            const token = await user.getIdToken();\n\n            const cleanBranding = branding\n                ? Object.fromEntries(\n                    Object.entries(branding).filter(([k, v]) => {\n                        if (v === undefined) return false;\n                        if (k === 'logoUrl' && (!v || typeof v !== 'string' || !v.startsWith('http'))) return false;\n                        return true;\n                    })\n                )\n                : undefined;\n\n            const res = await fetch('/api/business/register', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    Authorization: `Bearer ${token}`,\n                },\n                body: JSON.stringify({\n                    name,\n                    businessTypeId: type.id,\n                    branding: cleanBranding,\n                }),\n            });\n\n            if (!res.ok) {\n                const data = await res.json().catch(() => ({}));\n                const msg = typeof data?.error === 'string' ? data.error : 'Failed to register business. Please try again.';\n                setError(msg);\n                setStep('select');\n                return;\n            }\n\n            setRegisteredName(name);\n\n            // Short feedback delay to keep the UI feeling responsive\n            await new Promise((resolve) => setTimeout(resolve, 700));\n\n            setStep('success');\n\n            // Complete shortly after success to avoid a sluggish feel\n            setTimeout(() => {\n                onComplete(name);\n                router.refresh();\n            }, 900);\n\n        } catch (err: any) {\n            setError('Failed to register business. Please try again.');\n            setStep('select');\n        }\n    };\n\n    return (\n        <div className=\"w-full\">\n            <AnimatePresence mode=\"wait\">\n                {step === 'select' && (\n                    <motion.div\n                        key=\"select\"\n                        initial={{ opacity: 0, y: 20 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        exit={{ opacity: 0, scale: 0.95 }}\n                    >\n                        {error && (\n                            <div className=\"mb-6 p-4 bg-red-500/10 border border-red-500/30 rounded-2xl text-red-200 text-center font-bold\">\n                                {error}\n                            </div>\n                        )}\n\n                        {/* B-Coin balance display and flat cost notice */}\n                        <div className=\"mb-8 flex flex-col md:flex-row items-center justify-between gap-4 p-6 bg-yellow-500/10 border-2 border-yellow-500/20 rounded-3xl\">\n                            <div className=\"flex items-center gap-4\">\n                                <div className=\"w-12 h-12 rounded-2xl bg-yellow-500/20 flex items-center justify-center text-2xl\">ü™ô</div>\n                                <div>\n                                    <div className=\"text-[10px] font-black uppercase tracking-widest text-yellow-500/70\">Registration Fee</div>\n                                    <div className=\"text-xl font-black text-yellow-500 tracking-tight\">250 B-Coins</div>\n                                </div>\n                            </div>\n                            <div className=\"h-full w-px bg-yellow-500/10 hidden md:block\" />\n                            <div className=\"flex items-center gap-4\">\n                                <div className=\"text-right\">\n                                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Your Balance</div>\n                                    <div className={`text-xl font-black ${(userData?.bCoins || 0) < 250 ? 'text-red-500' : 'text-[var(--text-primary)]'}`}>\n                                        {userData?.bCoins?.toLocaleString() || 0} B-Coins\n                                    </div>\n                                </div>\n                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl ${(userData?.bCoins || 0) < 250 ? 'bg-red-500/20' : 'bg-emerald-500/20'}`}>\n                                    {(userData?.bCoins || 0) < 250 ? '‚ö†Ô∏è' : '‚úÖ'}\n                                </div>\n                            </div>\n                        </div>\n\n                        {(userData?.bCoins || 0) < 250 && (\n                            <motion.div\n                                initial={{ opacity: 0, y: 10 }}\n                                animate={{ opacity: 1, y: 0 }}\n                                className=\"mb-8 p-10 bg-red-500/5 border-2 border-red-500/20 rounded-[2.5rem] text-center relative overflow-hidden group\"\n                            >\n                                <div className=\"absolute top-0 right-0 p-8 text-6xl opacity-5 grayscale pointer-events-none group-hover:scale-110 transition-transform duration-700\">ü™ô</div>\n                                <div className=\"relative z-10\">\n                                    <div className=\"w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 border-2 border-red-500/20 shadow-lg shadow-red-500/5 overflow-hidden\">\n                                        <div className=\"absolute inset-0 bg-red-500/20 animate-pulse\" />\n                                        <span className=\"relative z-10\">üí≥</span>\n                                    </div>\n                                    <h3 className=\"text-red-500 font-black text-xl uppercase tracking-wider mb-3\">Insufficient Capital</h3>\n                                    <p className=\"text-[var(--text-secondary)] text-sm font-bold max-w-sm mx-auto leading-relaxed mb-8 opacity-80\">\n                                        You need a minimum of <span className=\"text-white\">250 B-Coins</span> to secure your legal charter. Complete missions or lessons to build your starting fund!\n                                    </p>\n\n                                    <Link href=\"/learn\" className=\"inline-block\">\n                                        <button className=\"duo-btn duo-btn-primary px-10 py-4 text-sm flex items-center gap-3 group/btn\">\n                                            <span>EARN B-COINS NOW</span>\n                                            <span className=\"group-hover/btn:translate-x-1 transition-transform\">‚Üí</span>\n                                        </button>\n                                    </Link>\n                                </div>\n                            </motion.div>\n                        )}\n\n                        <div className={(userData?.bCoins || 0) < 250 ? 'opacity-50 pointer-events-none' : ''}>\n                            <BusinessTypeSelector onSelect={handleRegistration} />\n                        </div>\n                    </motion.div>\n                )}\n\n                {step === 'processing' && (\n                    <motion.div\n                        key=\"processing\"\n                        initial={{ opacity: 0, scale: 0.9 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        exit={{ opacity: 0 }}\n                        className=\"text-center py-20 px-8 duo-card border-none bg-white/[0.03] backdrop-blur-xl\"\n                    >\n                        <div className=\"relative w-32 h-32 mx-auto mb-10\">\n                            <div className=\"absolute inset-0 border-[6px] border-white/5 rounded-full\"></div>\n                            <div className=\"absolute inset-0 border-[6px] border-[var(--brand-primary)] rounded-full border-t-transparent animate-spin shadow-[0_0_20px_rgba(var(--brand-primary-rgb),0.3)]\"></div>\n                            <div className=\"absolute inset-0 flex items-center justify-center text-5xl animate-pulse\">üèõÔ∏è</div>\n                        </div>\n                        <BrightHeading level={2} className=\"text-3xl mb-4 tracking-tight\">Filing Your Charter</BrightHeading>\n                        <p className=\"text-[var(--text-secondary)] font-black uppercase tracking-widest text-[10px] max-w-xs mx-auto opacity-70\">\n                            BrightEd Enterprise is processing your legal registration for the <span className=\"text-[var(--text-primary)]\">Registry of Currencydom</span>.\n                        </p>\n                    </motion.div>\n                )}\n\n                {step === 'success' && (\n                    <motion.div\n                        key=\"success\"\n                        initial={{ opacity: 0, scale: 0.8, y: 20 }}\n                        animate={{ opacity: 1, scale: 1, y: 0 }}\n                        className=\"text-center py-20 px-8 duo-card border-[3px] border-[var(--brand-primary)] bg-[var(--brand-primary)]/5 shadow-2xl overflow-hidden relative\"\n                    >\n                        {/* Background particles/glow */}\n                        <div className=\"absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-[var(--brand-primary)] opacity-10 blur-[80px] rounded-full\" />\n\n                        <div className=\"relative z-10\">\n                            <div className=\"inline-flex items-center justify-center w-28 h-28 rounded-3xl bg-[var(--brand-primary)] text-white text-6xl mb-8 shadow-[0_8px_0_0_#0369a1] animate-bounce-slow\">\n                                üè¢\n                            </div>\n                            <BrightHeading level={1} className=\"text-5xl text-[var(--brand-primary)] mb-4 tracking-tighter\">\n                                Approved!\n                            </BrightHeading>\n                            <p className=\"text-2xl text-[var(--text-primary)] font-black mb-2\">\n                                {registeredName}\n                            </p>\n                            <div className=\"inline-block px-4 py-1.5 rounded-full bg-[var(--brand-primary)]/20 text-[var(--brand-primary)] text-[10px] font-black uppercase tracking-[0.2em] mb-8\">\n                                Official Legal Entity\n                            </div>\n\n                            <p className=\"text-sm text-[var(--text-secondary)] max-w-sm mx-auto font-black uppercase tracking-widest leading-relaxed opacity-70\">\n                                Your business is now live. Launching your operations dashboard...\n                            </p>\n                        </div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessSectionNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessStatsBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessToolMarket.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":55,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useMemo, useState } from 'react';\nimport { BrightHeading, useDialog } from '@/components/system';\nimport { BusinessState, BusinessType, updateBusinessFinancials } from '@/lib/economy';\nimport { getNetWorthSnapshot } from '@/lib/economy/valuation';\nimport { getToolById, getToolMarketForBusiness } from '@/lib/economy/business-tools';\nimport type { BusinessTool } from '@/lib/economy/economy-types';\n\ninterface BusinessToolMarketProps {\n    business: BusinessState;\n    businessType: BusinessType | null;\n}\n\nexport default function BusinessToolMarket({ business, businessType }: BusinessToolMarketProps) {\n    const { showAlert } = useDialog();\n    const [purchasingId, setPurchasingId] = useState<string | null>(null);\n\n    const tools = useMemo(() => {\n        if (!businessType) return [];\n        return getToolMarketForBusiness(businessType.category);\n    }, [businessType]);\n\n    const ownedTools = new Set(business.ownedTools || []);\n\n    const handlePurchase = async (toolId: string) => {\n        const tool = getToolById(toolId);\n        if (!tool) return;\n\n        if (ownedTools.has(tool.id)) return;\n        if (business.cashBalance < tool.cost) {\n            showAlert('Insufficient cash to purchase this tool. Complete more orders or sell inventory.', {\n                title: 'INSUFFICIENT FUNDS'\n            });\n            return;\n        }\n\n        setPurchasingId(tool.id);\n        try {\n            const updatedTools = [...ownedTools, tool.id];\n            const cashDelta = -tool.cost;\n            const updatedBusiness = {\n                ...business,\n                cashBalance: business.cashBalance + cashDelta,\n                ownedTools: updatedTools\n            };\n            const snapshot = getNetWorthSnapshot(updatedBusiness);\n\n            await updateBusinessFinancials(business.id, {\n                cashDelta,\n                ownedTools: updatedTools,\n                netWorth: snapshot.netWorth,\n                valuation: snapshot.valuation\n            });\n        } catch (error) {\n            showAlert('Purchase failed. Please try again.', { title: 'PURCHASE ERROR' });\n        } finally {\n            setPurchasingId(null);\n        }\n    };\n\n    return (\n        <div className=\"duo-card p-8 space-y-8\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6\">\n                <div>\n                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">General Market</div>\n                    <BrightHeading level={2} className=\"text-3xl m-0\">Business Tool Vault</BrightHeading>\n                    <p className=\"text-xs text-[var(--text-secondary)] font-bold mt-1 opacity-70\">\n                        Upgrade your systems with tools tailored to your business model.\n                    </p>\n                </div>\n                <div className=\"px-5 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Available Cash</div>\n                    <div className=\"text-xl font-black text-[var(--brand-primary)]\">‡∏ø{business.cashBalance.toLocaleString()}</div>\n                </div>\n            </div>\n\n            {tools.length === 0 ? (\n                <div className=\"py-16 text-center bg-[var(--bg-secondary)]/30 rounded-[2rem] border-2 border-dashed border-[var(--border-subtle)]\">\n                    <div className=\"text-4xl mb-4 grayscale opacity-30\">üß∞</div>\n                    <p className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)]\">No upgrades available</p>\n                    <p className=\"text-[10px] text-[var(--text-secondary)] mt-2\">Check back as your business evolves.</p>\n                </div>\n            ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n                    {tools.map((tool: BusinessTool) => {\n                        const isOwned = ownedTools.has(tool.id);\n                        const isPurchasing = purchasingId === tool.id;\n                        return (\n                            <div key={tool.id} className=\"duo-card p-5 border-2 border-[var(--border-subtle)]/80 bg-[var(--bg-elevated)]/80\">\n                                <div className=\"flex items-start justify-between gap-4 mb-4\">\n                                    <div>\n                                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">{tool.category}</div>\n                                        <div className=\"text-lg font-black text-[var(--text-primary)] mt-1\">{tool.name}</div>\n                                    </div>\n                                    <div className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${isOwned ? 'bg-emerald-500/15 text-emerald-500' : 'bg-[var(--brand-primary)]/10 text-[var(--brand-primary)]'}`}>\n                                        {isOwned ? 'Owned' : `‡∏ø${tool.cost}`}\n                                    </div>\n                                </div>\n                                <p className=\"text-xs text-[var(--text-secondary)] font-medium leading-relaxed mb-4\">{tool.description}</p>\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-accent)] mb-5\">\n                                    {tool.boostLabel}\n                                </div>\n                                <button\n                                    disabled={isOwned || isPurchasing}\n                                    onClick={() => handlePurchase(tool.id)}\n                                    className={`duo-btn w-full text-[10px] py-2 ${isOwned ? 'bg-[var(--bg-secondary)] text-[var(--text-muted)] border-[var(--border-subtle)]' : 'duo-btn-primary'}`}\n                                >\n                                    {isOwned ? 'Installed' : isPurchasing ? 'Processing...' : 'Purchase Upgrade'}\n                                </button>\n                            </div>\n                        );\n                    })}\n                </div>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessTypeSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[256,270],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'logoError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":36,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":92,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Economy ‚Äî Business Type Selector\n * Allows players to choose their business type during onboarding.\n */\n\nimport { useMemo, useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { BrightLayer, BrightButton, BrightHeading } from '@/components/system';\nimport { CharacterDialogue } from '@/components/cinematic';\nimport { ALL_BUSINESS_TYPES, BusinessType } from '@/lib/economy';\nimport { DialogueNode } from '@/lib/cinematic/character-types';\nimport BusinessCreditCard from '@/components/business/BusinessCreditCard';\nimport { auth, storage } from '@/lib/firebase';\nimport { getDownloadURL, ref, uploadBytes } from 'firebase/storage';\n\ninterface BusinessTypeSelectorProps {\n    onSelect: (\n        businessType: BusinessType,\n        businessName: string,\n        branding?: { themeColor?: string; logoUrl?: string; icon?: string }\n    ) => void;\n    onBack?: () => void;\n}\n\nexport function BusinessTypeSelector({ onSelect, onBack }: BusinessTypeSelectorProps) {\n    const [selectedType, setSelectedType] = useState<BusinessType | null>(null);\n    const [businessName, setBusinessName] = useState('');\n    const [step, setStep] = useState<'select' | 'name' | 'brand' | 'confirm'>('select');\n\n    const [themeColor, setThemeColor] = useState<string>('#7c3aed');\n    const [icon, setIcon] = useState<string>('üè¢');\n    const [logoUrl, setLogoUrl] = useState<string>('');\n    const [logoUploading, setLogoUploading] = useState(false);\n    const [logoError, setLogoError] = useState<string | null>(null);\n\n    const handleTypeSelect = (type: BusinessType) => {\n        setSelectedType(type);\n        setStep('name');\n    };\n\n    const handleNameSubmit = () => {\n        if (businessName.trim().length < 3) return;\n        setStep('brand');\n    };\n\n    const handleConfirm = () => {\n        if (selectedType && businessName.trim()) {\n            onSelect(selectedType, businessName.trim(), {\n                themeColor: themeColor.trim() || '#7c3aed',\n                logoUrl: logoUrl || undefined,\n                icon: icon || 'üè¢',\n            });\n        }\n    };\n\n    const handleBack = () => {\n        if (step === 'name') {\n            setStep('select');\n            setSelectedType(null);\n        } else if (step === 'brand') {\n            setStep('name');\n        } else if (step === 'confirm') {\n            setStep('brand');\n        } else {\n            onBack?.();\n        }\n    };\n\n    const presetIcons = useMemo(\n        () => ['üè¢', 'üßæ', 'üß†', 'üõçÔ∏è', 'üçΩÔ∏è', 'üì¶', 'üß∞', 'üß™', 'üéß', 'üßë‚Äçüíª', 'üöö', 'üåê', 'üè¶', 'üßø'],\n        []\n    );\n\n    const handleLogoUpload = async (file: File) => {\n        const user = auth.currentUser;\n        if (!user) {\n            setLogoError('Please log in again to upload a logo.');\n            return;\n        }\n\n        setLogoError(null);\n        setLogoUploading(true);\n        try {\n            const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');\n            const path = `business-logos/${user.uid}/${Date.now()}_${safeName}`;\n            const objRef = ref(storage, path);\n            await uploadBytes(objRef, file);\n            const url = await getDownloadURL(objRef);\n            setLogoUrl(url);\n        } catch (e) {\n            setLogoError('Failed to upload logo. Please try again.');\n        } finally {\n            setLogoUploading(false);\n        }\n    };\n\n    // Luka's intro dialogue\n    const introDialogue: DialogueNode = {\n        id: 'business_intro',\n        characterId: 'luka',\n        text: \"Every empire starts with a choice. What kind of business speaks to you? Each path has different challenges and rewards.\",\n        emotion: 'neutral',\n    };\n\n    const categoryStyles: Record<string, { gradient: string; glow: string }> = {\n        service: {\n            gradient: 'from-purple-500/20 to-pink-500/20',\n            glow: 'group-hover:shadow-purple-500/30'\n        },\n        retail: {\n            gradient: 'from-blue-500/20 to-cyan-500/20',\n            glow: 'group-hover:shadow-blue-500/30'\n        },\n        food: {\n            gradient: 'from-orange-500/20 to-yellow-500/20',\n            glow: 'group-hover:shadow-orange-500/30'\n        },\n        digital: {\n            gradient: 'from-green-500/20 to-teal-500/20',\n            glow: 'group-hover:shadow-green-500/30'\n        },\n    };\n\n    return (\n        <div className=\"w-full pb-20\">\n            <div className=\"max-w-7xl mx-auto px-4 sm:px-6\">\n\n                {/* Header & Branding */}\n                <motion.div\n                    className=\"text-center mb-8 duo-card border-none bg-[var(--bg-elevated)]/30 shadow-2xl backdrop-blur-sm\"\n                    initial={{ opacity: 0, y: -20 }}\n                    animate={{ opacity: 1, y: 0 }}\n                >\n                    <div className=\"flex items-center justify-center gap-3 mb-4\">\n                        <div className=\"w-12 h-12 bg-[var(--brand-primary)] rounded-2xl flex items-center justify-center text-white shadow-[0_5px_0_0_#0369a1]\">\n                            <span className=\"text-2xl font-black\">B</span>\n                        </div>\n                        <span className=\"text-2xl font-black uppercase tracking-widest text-[var(--text-primary)]\">BrightEd <span className=\"text-[var(--brand-primary)]\">Enterprise</span></span>\n                    </div>\n\n                    <BrightHeading level={1} className=\"text-4xl md:text-5xl mb-4 tracking-tighter\">\n                        Choose Your <span className=\"text-[var(--brand-primary)] underline decoration-wavy decoration-8 underline-offset-8\">Path</span>\n                    </BrightHeading>\n                    <p className=\"text-xs md:text-sm text-[var(--text-secondary)] font-black uppercase tracking-widest max-w-xl mx-auto opacity-70\">\n                        Select a business model. Your choice defines your starting capital, daily costs, and success metrics.\n                    </p>\n                </motion.div>\n\n                <AnimatePresence mode=\"wait\">\n                    {/* Step 1: Select Business Type */}\n                    {step === 'select' && (\n                        <motion.div\n                            key=\"select\"\n                            initial={{ opacity: 0, x: -20 }}\n                            animate={{ opacity: 1, x: 0 }}\n                            exit={{ opacity: 0, x: 20 }}\n                        >\n                            {/* Luka's guidance - Compacted */}\n                            <div className=\"mb-8 scale-90 origin-top\">\n                                <CharacterDialogue\n                                    node={introDialogue}\n                                    typewriterSpeed={15}\n                                />\n                            </div>\n\n                            {/* Business Type Grid - 4 Columns for No Scroll */}\n                            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                                {ALL_BUSINESS_TYPES.map((type, idx) => (\n                                    <motion.div\n                                        key={type.id}\n                                        initial={{ opacity: 0, scale: 0.9 }}\n                                        animate={{ opacity: 1, scale: 1 }}\n                                        transition={{ delay: idx * 0.05 }}\n                                    >\n                                        <button\n                                            onClick={() => handleTypeSelect(type)}\n                                            className=\"w-full text-left group\"\n                                        >\n                                            <div\n                                                className={`relative duo-card h-[380px] flex flex-col justify-between transition-all group-hover:border-[var(--brand-primary)]\n                          ${categoryStyles[type.category].glow}`}\n                                            >\n                                                {/* Category Label */}\n                                                <div className={`\n                                                   absolute top-0 right-0 px-4 py-1.5 rounded-bl-2xl text-[10px] font-black uppercase tracking-widest text-white shadow-sm z-20\n                                                   ${type.category === 'service' ? 'bg-purple-500 shadow-[0_4px_0_0_#7e22ce]' :\n                                                        type.category === 'retail' ? 'bg-blue-500 shadow-[0_4px_0_0_#1d4ed8]' :\n                                                            type.category === 'food' ? 'bg-orange-500 shadow-[0_4px_0_0_#c2410c]' : 'bg-emerald-500 shadow-[0_4px_0_0_#047857]'}\n                                                `}>\n                                                    {type.category}\n                                                </div>\n\n                                                <div className=\"relative z-10 flex flex-col h-full\">\n                                                    {/* Visual Section */}\n                                                    <div className=\"flex flex-col items-center text-center mb-4\">\n                                                        <div className=\"w-20 h-20 rounded-3xl bg-[var(--bg-secondary)] border-2 border-[var(--border-subtle)] border-b-4 flex items-center justify-center text-5xl mb-4 group-hover:scale-110 group-hover:bg-white/10 transition-all duration-500\">\n                                                            {type.emoji}\n                                                        </div>\n                                                        <h3 className=\"text-xl font-black text-[var(--text-primary)] leading-tight\">\n                                                            {type.name}\n                                                        </h3>\n                                                    </div>\n\n                                                    {/* Body */}\n                                                    <p className=\"text-xs text-[var(--text-secondary)] font-bold line-clamp-3 mb-6 opacity-80 group-hover:opacity-100 transition-opacity\">\n                                                        {type.description}\n                                                    </p>\n\n                                                    {/* Footer Info */}\n                                                    <div className=\"mt-auto space-y-4\">\n                                                        <div className=\"flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">\n                                                            <span>Start Capital</span>\n                                                            <span className=\"text-[var(--brand-accent)] text-xs\">‡∏ø{type.startingCapital.toLocaleString()}</span>\n                                                        </div>\n\n                                                        <div className=\"flex justify-between items-center bg-[var(--bg-secondary)] p-3 rounded-xl border-2 border-[var(--border-subtle)]\">\n                                                            <div className=\"flex items-center gap-2\">\n                                                                <span className=\"text-sm\">üì¶</span>\n                                                                <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-secondary)]\">{type.products.length} Items</span>\n                                                            </div>\n                                                            <div className=\"flex items-center gap-2\">\n                                                                <span className=\"text-sm\">üïí</span>\n                                                                <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-secondary)]\">\n                                                                    {type.category === 'food' ? 'Lunch' :\n                                                                        type.category === 'retail' ? 'Evening' :\n                                                                            type.category === 'service' ? 'Afternoon' : 'Day'}\n                                                                </span>\n                                                            </div>\n                                                        </div>\n\n                                                        <div className=\"pt-2\">\n                                                            <div className=\"duo-btn duo-btn-primary w-full text-[10px] group-hover:scale-105 transition-transform\">\n                                                                CHOOSE PATH\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </button>\n                                    </motion.div>\n                                ))}\n                            </div>\n\n                            {onBack && (\n                                <div className=\"mt-8 text-center\">\n                                    <button\n                                        onClick={onBack}\n                                        className=\"text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\"\n                                    >\n                                        ‚Üê Go back\n                                    </button>\n                                </div>\n                            )}\n                        </motion.div>\n                    )}\n\n                    {/* Step 2: Name Your Business */}\n                    {step === 'name' && selectedType && (\n                        <motion.div\n                            key=\"name\"\n                            initial={{ opacity: 0, x: 20 }}\n                            animate={{ opacity: 1, x: 0 }}\n                            exit={{ opacity: 0, x: -20 }}\n                            className=\"max-w-xl mx-auto px-4\"\n                        >\n                            <div className=\"duo-card text-center overflow-hidden\">\n                                <div className=\"absolute top-0 inset-x-0 h-1 bg-[var(--brand-primary)] opacity-50\" />\n                                <div className=\"w-24 h-24 rounded-3xl bg-[var(--bg-secondary)] border-2 border-[var(--border-subtle)] border-b-4 flex items-center justify-center text-7xl mx-auto mb-8 shadow-inner animate-bounce-slow\">\n                                    {selectedType.emoji}\n                                </div>\n                                <BrightHeading level={2} className=\"text-3xl mb-4 tracking-tighter\">\n                                    Name Your <span className=\"text-[var(--brand-primary)]\">{selectedType.name}</span>\n                                </BrightHeading>\n                                <p className=\"text-xs font-black uppercase tracking-widest text-[var(--text-secondary)] mb-10 opacity-70\">\n                                    This name will appear on your official charter and credit card.\n                                </p>\n\n                                <div className=\"relative group max-w-md mx-auto\">\n                                    <input\n                                        type=\"text\"\n                                        value={businessName}\n                                        onChange={(e) => setBusinessName(e.target.value)}\n                                        placeholder={`e.g., \"${selectedType.category === 'food' ? \"Mama's Kitchen\" :\n                                            selectedType.category === 'service' ? \"Style Studio\" :\n                                                selectedType.category === 'retail' ? \"Corner Mart\" :\n                                                    \"Creative Design Co.\"}`}\n                                        className=\"w-full px-8 py-5 text-2xl bg-[var(--bg-secondary)] border-2 border-[var(--border-subtle)] border-b-4 rounded-3xl\n                        text-[var(--text-primary)] placeholder:text-[var(--text-muted)] \n                        focus:border-[var(--brand-primary)] focus:outline-none transition-all text-center font-black shadow-inner\"\n                                        autoFocus\n                                        maxLength={40}\n                                    />\n                                </div>\n\n                                <div className=\"mt-12 flex flex-col sm:flex-row justify-center gap-6\">\n                                    <button\n                                        onClick={handleBack}\n                                        className=\"duo-btn text-[var(--text-muted)] border-[var(--border-subtle)] px-8\"\n                                    >\n                                        ‚Üê Back\n                                    </button>\n                                    <button\n                                        onClick={handleNameSubmit}\n                                        disabled={businessName.trim().length < 3}\n                                        className=\"duo-btn duo-btn-primary px-12 py-5 text-lg\"\n                                    >\n                                        Confirm Name ‚Üí\n                                    </button>\n                                </div>\n                            </div>\n                        </motion.div>\n                    )}\n\n                    {/* Step 3: Brand Your Business */}\n                    {step === 'brand' && selectedType && (\n                        <motion.div\n                            key=\"brand\"\n                            initial={{ opacity: 0, x: 20 }}\n                            animate={{ opacity: 1, x: 0 }}\n                            exit={{ opacity: 0, x: -20 }}\n                            className=\"max-w-6xl mx-auto px-4\"\n                        >\n                            <div className=\"grid grid-cols-1 xl:grid-cols-12 gap-8 items-start\">\n                                {/* Left: Card Preview */}\n                                <div className=\"xl:col-span-5 flex flex-col gap-6\">\n                                    <div className=\"relative group\">\n                                        <div className=\"absolute inset-x-0 -bottom-8 bg-[var(--brand-primary)]/10 h-10 rounded-[3rem] blur-2xl group-hover:bg-[var(--brand-primary)]/20 transition-all opacity-0 group-hover:opacity-100\" />\n                                        <BusinessCreditCard\n                                            businessName={businessName}\n                                            ownerName=\"Director\"\n                                            themeColor={themeColor}\n                                            logoUrl={logoUrl || undefined}\n                                            icon={icon}\n                                            cardLabel=\"BUSINESS CREDIT\"\n                                            className=\"transform rotate-0 group-hover:-rotate-1 group-hover:scale-[1.02] transition-all duration-500 shadow-2xl\"\n                                        />\n                                    </div>\n                                    <BrightLayer variant=\"glass\" padding=\"sm\" className=\"bg-white/[0.02] border border-white/5 rounded-2xl text-center\">\n                                        <p className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Live Preview ‚Ä¢ Legal Identity</p>\n                                    </BrightLayer>\n                                </div>\n\n                                {/* Right: Controls */}\n                                <div className=\"xl:col-span-7\">\n                                    <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"border-b-[8px] border-[var(--border-subtle)] relative overflow-hidden bg-white/[0.02]\">\n                                        <div className=\"absolute top-0 right-0 p-8 text-5xl opacity-10 pointer-events-none\">üé®</div>\n\n                                        <div className=\"relative z-10\">\n                                            <div className=\"mb-8\">\n                                                <BrightHeading level={2} className=\"text-3xl tracking-tight mb-2\">Corporate Identity</BrightHeading>\n                                                <p className=\"text-[var(--text-secondary)] font-medium\">Define your brand visual assets to differentiate in the market.</p>\n                                            </div>\n\n                                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\n                                                {/* Theme Color */}\n                                                <div className=\"space-y-4\">\n                                                    <div className=\"text-[11px] font-black uppercase tracking-widest text-[var(--text-muted)] flex items-center gap-2\">\n                                                        <span className=\"w-1.5 h-1.5 rounded-full bg-[var(--brand-primary)]\" /> Theme Color\n                                                    </div>\n                                                    <div className=\"flex items-center gap-4 p-2 bg-[var(--bg-secondary)] rounded-2xl border border-[var(--border-subtle)] group focus-within:border-[var(--brand-primary)]/50 transition-colors\">\n                                                        <input\n                                                            type=\"color\"\n                                                            value={themeColor}\n                                                            onChange={(e) => setThemeColor(e.target.value)}\n                                                            className=\"h-12 w-12 rounded-xl border-0 bg-transparent cursor-pointer overflow-hidden p-0\"\n                                                        />\n                                                        <input\n                                                            type=\"text\"\n                                                            value={themeColor}\n                                                            onChange={(e) => setThemeColor(e.target.value)}\n                                                            className=\"flex-1 bg-transparent border-0 text-lg font-black text-[var(--text-primary)] focus:outline-none uppercase\"\n                                                            placeholder=\"#7c3aed\"\n                                                        />\n                                                    </div>\n                                                </div>\n\n                                                {/* Logo Upload */}\n                                                <div className=\"space-y-4\">\n                                                    <div className=\"text-[11px] font-black uppercase tracking-widest text-[var(--text-muted)] flex items-center gap-2\">\n                                                        <span className=\"w-1.5 h-1.5 rounded-full bg-emerald-500\" /> Logo Upload\n                                                    </div>\n                                                    <div className=\"flex items-center gap-3\">\n                                                        <label className=\"flex-1 group\">\n                                                            <input\n                                                                type=\"file\"\n                                                                accept=\"image/*\"\n                                                                onChange={(e) => {\n                                                                    const file = e.target.files?.[0];\n                                                                    if (file) handleLogoUpload(file);\n                                                                }}\n                                                                className=\"hidden\"\n                                                            />\n                                                            <div className=\"px-6 py-4 rounded-2xl border-2 border-dashed border-[var(--border-subtle)] bg-[var(--bg-secondary)] hover:border-[var(--brand-primary)] hover:bg-[var(--brand-primary)]/5 transition-all cursor-pointer text-sm font-black text-[var(--text-primary)] text-center shadow-inner\">\n                                                                {logoUploading ? '‚è≥ Uploading...' : (logoUrl ? '‚úÖ Replace' : 'üìÅ Upload File')}\n                                                            </div>\n                                                        </label>\n                                                        {logoUrl && (\n                                                            <button\n                                                                type=\"button\"\n                                                                onClick={() => setLogoUrl('')}\n                                                                className=\"p-4 rounded-2xl border border-[var(--border-subtle)] bg-transparent hover:bg-red-500/10 hover:border-red-500/30 transition-all text-sm font-black text-red-500\"\n                                                            >\n                                                                üóëÔ∏è\n                                                            </button>\n                                                        )}\n                                                    </div>\n                                                </div>\n\n                                                {/* Preset Icon */}\n                                                <div className=\"md:col-span-2 space-y-4\">\n                                                    <div className=\"text-[11px] font-black uppercase tracking-widest text-[var(--text-muted)] flex items-center gap-2\">\n                                                        <span className=\"w-1.5 h-1.5 rounded-full bg-amber-500\" /> Symbol Pack\n                                                    </div>\n                                                    <div className=\"grid grid-cols-4 sm:grid-cols-7 lg:grid-cols-10 gap-2 sm:gap-3\">\n                                                        {presetIcons.map((i) => (\n                                                            <button\n                                                                key={i}\n                                                                type=\"button\"\n                                                                onClick={() => setIcon(i)}\n                                                                className={`h-11 w-11 sm:h-12 sm:w-12 rounded-2xl border-2 transition-all text-xl active:scale-90 flex items-center justify-center ${icon === i\n                                                                    ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)] shadow-[0_0_20px_rgba(var(--brand-primary-rgb),0.3)] text-white scale-110 z-10'\n                                                                    : 'border-[var(--border-subtle)] bg-[var(--bg-elevated)]/30 hover:border-white/20'\n                                                                    }`}\n                                                            >\n                                                                {i}\n                                                            </button>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            </div>\n\n                                            <div className=\"mt-12 flex flex-col sm:flex-row justify-between items-center gap-6\">\n                                                <button onClick={handleBack} className=\"duo-btn text-[var(--text-muted)] border-[var(--border-subtle)] px-8 w-full sm:w-auto\">\n                                                    ‚Üê Back\n                                                </button>\n                                                <button\n                                                    onClick={() => setStep('confirm')}\n                                                    disabled={logoUploading}\n                                                    className=\"duo-btn duo-btn-primary px-12 py-5 text-lg w-full sm:w-auto\"\n                                                >\n                                                    Finalize Identity ‚Üí\n                                                </button>\n                                            </div>\n                                        </div>\n                                    </BrightLayer>\n                                </div>\n                            </div>\n                        </motion.div>\n                    )}\n\n                    {/* Step 4: Confirm Launch */}\n                    {step === 'confirm' && selectedType && (\n                        <motion.div\n                            key=\"confirm\"\n                            initial={{ opacity: 0, scale: 0.95 }}\n                            animate={{ opacity: 1, scale: 1 }}\n                            exit={{ opacity: 0, scale: 0.95 }}\n                            className=\"max-w-2xl mx-auto px-4\"\n                        >\n                            <BrightLayer\n                                variant=\"elevated\"\n                                padding=\"lg\"\n                                className=\"text-center border-b-[8px] border-[var(--brand-primary)] overflow-hidden relative\"\n                            >\n                                {/* Background flare */}\n                                <div className=\"absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-transparent via-[var(--brand-primary)] to-transparent opacity-50\" />\n                                <div className=\"absolute -top-24 -left-24 w-64 h-64 bg-[var(--brand-primary)] opacity-10 blur-[100px] rounded-full\" />\n\n                                <div className=\"relative z-10\">\n                                    <div className=\"w-24 h-24 rounded-full bg-[var(--brand-primary)] text-white text-5xl mx-auto mb-6 flex items-center justify-center shadow-[0_0_30px_rgba(var(--brand-primary-rgb),0.3)] animate-pulse\">\n                                        üöÄ\n                                    </div>\n                                    <BrightHeading level={1} className=\"text-4xl md:text-5xl mb-2 tracking-tighter\">\n                                        Ready for <span className=\"text-[var(--brand-primary)]\">Launch?</span>\n                                    </BrightHeading>\n                                    <p className=\"text-[var(--text-secondary)] mb-10 font-medium\">Final review of your business charter.</p>\n\n                                    <div className=\"space-y-4 mb-10\">\n                                        <div className=\"bg-white/[0.03] rounded-3xl p-6 border border-white/5 flex flex-col sm:flex-row items-center gap-6 text-left\">\n                                            <div className=\"w-20 h-20 rounded-2xl bg-white/[0.03] flex items-center justify-center text-5xl shrink-0\">\n                                                {icon || selectedType.emoji}\n                                            </div>\n                                            <div>\n                                                <h4 className=\"text-2xl font-black text-[var(--text-primary)] leading-tight mb-1\">{businessName}</h4>\n                                                <div className=\"flex flex-wrap gap-2\">\n                                                    <span className=\"px-3 py-0.5 rounded-full bg-[var(--brand-primary)]/20 text-[var(--brand-primary)] text-[10px] font-black uppercase tracking-widest\">{selectedType.name}</span>\n                                                    <span className=\"px-3 py-0.5 rounded-full bg-amber-500/20 text-amber-500 text-[10px] font-black uppercase tracking-widest\">‡∏ø{selectedType.startingCapital.toLocaleString()} Capital</span>\n                                                </div>\n                                            </div>\n                                        </div>\n\n                                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                                            <div className=\"bg-white/[0.02] rounded-3xl p-5 border border-white/5 text-left h-full\">\n                                                <div className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest mb-3 flex items-center gap-2\">\n                                                    <span className=\"w-1.5 h-1.5 rounded-full bg-red-500\" /> Operational Risks\n                                                </div>\n                                                <ul className=\"space-y-2 text-xs text-[var(--text-secondary)] font-medium\">\n                                                    <li>‚Ä¢ Daily operating costs apply</li>\n                                                    <li>‚Ä¢ System spoilage risk: {selectedType.category === 'food' ? 'High' : 'Medium'}</li>\n                                                </ul>\n                                            </div>\n                                            <div className=\"bg-white/[0.02] rounded-3xl p-5 border border-white/5 text-left h-full\">\n                                                <div className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest mb-3 flex items-center gap-2\">\n                                                    <span className=\"w-1.5 h-1.5 rounded-full bg-emerald-500\" /> Success Metrics\n                                                </div>\n                                                <ul className=\"space-y-2 text-xs text-[var(--text-secondary)] font-medium\">\n                                                    <li>‚Ä¢ Reputation-based demand</li>\n                                                    <li>‚Ä¢ Profit margin tracking</li>\n                                                </ul>\n                                            </div>\n                                        </div>\n                                    </div>\n\n                                    <div className=\"flex flex-col sm:flex-row justify-center gap-6\">\n                                        <button\n                                            onClick={handleBack}\n                                            className=\"duo-btn text-[var(--text-muted)] border-[var(--border-subtle)] px-8 order-2 sm:order-1\"\n                                        >\n                                            ‚Üê Adjust Brand\n                                        </button>\n                                        <button\n                                            onClick={handleConfirm}\n                                            className=\"duo-btn duo-btn-primary px-16 py-6 text-xl order-1 sm:order-2\"\n                                        >\n                                            Launch My Empire ü•Ç\n                                        </button>\n                                    </div>\n                                </div>\n                            </BrightLayer>\n                        </motion.div>\n                    )}\n                </AnimatePresence>\n            </div>\n        </div>\n    );\n}\n\nexport default BusinessTypeSelector;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/BusinessWorkspace.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[158,170],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[184,198],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'businessType' is defined but never used. Allowed unused args must match /^_/u.","line":31,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":64}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { BrightLayer, BrightHeading, BrightButton } from '@/components/system';\nimport { Order, BusinessType } from '@/lib/economy/economy-types';\nimport { BCoinIcon } from '@/components/BCoinIcon';\nimport { getDicebearAvatarUrl } from '@/lib/avatars';\n\ninterface BusinessWorkspaceProps {\n    order: Order;\n    businessType: BusinessType;\n    onComplete: (qualityScore: number) => void;\n    onCancel: () => void;\n}\n\ninterface WorkspaceStep {\n    id: string;\n    title: string;\n    description: string;\n    type: 'decision' | 'outcome' | 'action';\n    options?: {\n        label: string;\n        qualityImpact: number;\n        feedback: string;\n        story?: string;\n    }[];\n}\n\nexport default function BusinessWorkspace({ order, businessType, onComplete, onCancel }: BusinessWorkspaceProps) {\n    const [currentStepIdx, setCurrentStepIdx] = useState(0);\n    const [qualityScore, setQualityScore] = useState(70); // Base quality\n    const [steps, setSteps] = useState<WorkspaceStep[]>([]);\n    const [selectedOption, setSelectedOption] = useState<number | null>(null);\n    const [isTransitioning, setIsTransitioning] = useState(false);\n\n    // Initial Generator (MVP: 3 steps per order)\n    useEffect(() => {\n        const item = order.items[0]?.productName || 'Order Items';\n\n        const generatedSteps: WorkspaceStep[] = [\n            {\n                id: 'prep',\n                title: 'Reviewing Order Requirements',\n                description: `${order.customerName} requested ${order.items.map(i => `${i.quantity}x ${i.productName}`).join(', ')}. How do you want to prioritize this fulfillment?`,\n                type: 'decision',\n                options: [\n                    { label: 'Speed First: Rush preparation', qualityImpact: -5, feedback: 'Fast but may sacrifice detail.', story: 'You rush the prep. The clock is ticking!' },\n                    { label: 'Quality First: Double check all items', qualityImpact: 10, feedback: 'Higher customer satisfaction ensured.', story: 'You carefully inspect every item for defects.' },\n                    { label: 'Standard: Follow normal procedure', qualityImpact: 0, feedback: 'Balance between speed and care.', story: 'You stick to the playbook.' }\n                ]\n            },\n            {\n                id: 'execution',\n                title: 'Fulfillment Execution',\n                description: `A minor issue arose during ${item} preparation. A packaging seal looks slightly weak.`,\n                type: 'decision',\n                options: [\n                    { label: 'Fix it: Use premium packaging', qualityImpact: 15, feedback: 'Customer will love the presentation!', story: 'You upgrade the packaging. It looks professional.' },\n                    { label: 'Ship it: It is probably fine', qualityImpact: -15, feedback: 'Customer might notice the defect.', story: 'You decide to risk it to save time.' },\n                    { label: 'Patch it: Quick reinforcement', qualityImpact: 5, feedback: 'Reliable enough for transport.', story: 'A quick bit of tape resolves the seal issue.' }\n                ]\n            },\n            {\n                id: 'delivery',\n                title: 'Delivery & Handover',\n                description: `${order.customerName} is a ${order.customerType} customer. Final check?`,\n                type: 'decision',\n                options: [\n                    { label: 'Professional: Include a thank you note', qualityImpact: 10, feedback: 'Personal touches build loyalty!', story: 'A handwritten note goes a long way.' },\n                    { label: 'Efficiency: Send out immediately', qualityImpact: 5, feedback: 'Delivery time optimized.', story: 'Package dispatched!' }\n                ]\n            }\n        ];\n\n        setSteps(generatedSteps);\n    }, [order]);\n\n    const handleOptionSelect = (idx: number) => {\n        if (selectedOption !== null) return;\n\n        setSelectedOption(idx);\n        const option = steps[currentStepIdx].options?.[idx];\n        if (option) {\n            setQualityScore(prev => Math.min(100, Math.max(0, prev + option.qualityImpact)));\n        }\n\n        setTimeout(() => {\n            if (currentStepIdx < steps.length - 1) {\n                setIsTransitioning(true);\n                setTimeout(() => {\n                    setCurrentStepIdx(prev => prev + 1);\n                    setSelectedOption(null);\n                    setIsTransitioning(false);\n                }, 400);\n            } else {\n                onComplete(qualityScore);\n            }\n        }, 1500);\n    };\n\n    if (steps.length === 0) return null;\n\n    const currentStep = steps[currentStepIdx];\n    const customerAvatarUrl = getDicebearAvatarUrl(order.customerId);\n\n    return (\n        <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"fixed inset-0 z-[100] bg-[var(--bg-primary)] flex flex-col pt-20\"\n        >\n            {/* Header Overlay */}\n            <div className=\"absolute top-0 left-0 right-0 h-20 bg-[var(--bg-elevated)] border-b border-[var(--border-subtle)] flex items-center px-8 justify-between\">\n                <div className=\"flex items-center gap-4\">\n                    <button onClick={onCancel} className=\"text-[var(--text-muted)] hover:text-[var(--text-primary)]\">‚úï Exit Workspace</button>\n                    <div className=\"h-6 w-px bg-[var(--border-subtle)]\" />\n                    <div className=\"flex items-center gap-3\">\n                        <Image\n                            src={customerAvatarUrl}\n                            alt={order.customerName}\n                            width={40}\n                            height={40}\n                            className=\"h-10 w-10 rounded-2xl border border-[var(--border-subtle)] object-cover\"\n                        />\n                        <BrightHeading level={4} className=\"m-0\">Business Workspace: {order.customerName}</BrightHeading>\n                    </div>\n                </div>\n                <div className=\"flex items-center gap-6\">\n                    <div className=\"text-right\">\n                        <p className=\"text-[10px] font-black uppercase text-[var(--text-muted)] tracking-widest\">Quality Forecast</p>\n                        <p className={`text-xl font-black ${qualityScore > 80 ? 'text-[var(--state-success)]' : qualityScore > 50 ? 'text-[var(--brand-accent)]' : 'text-[var(--state-error)]'}`}>\n                            {qualityScore}%\n                        </p>\n                    </div>\n                </div>\n            </div>\n\n            <main className=\"flex-1 max-w-4xl mx-auto w-full px-6 py-12 flex flex-col\">\n                {/* Progress Bar */}\n                <div className=\"w-full h-1 bg-[var(--bg-elevated)] rounded-full mb-12 overflow-hidden\">\n                    <motion.div\n                        className=\"h-full bg-[var(--brand-primary)]\"\n                        animate={{ width: `${((currentStepIdx + 1) / steps.length) * 100}%` }}\n                    />\n                </div>\n\n                <div className=\"flex-1\">\n                    <AnimatePresence mode=\"wait\">\n                        {!isTransitioning && (\n                            <motion.div\n                                key={currentStep.id}\n                                initial={{ opacity: 0, x: 20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                exit={{ opacity: 0, x: -20 }}\n                                className=\"space-y-8\"\n                            >\n                                <div>\n                                    <span className=\"px-3 py-1 bg-[var(--brand-secondary)]/10 text-[var(--brand-secondary)] rounded-full text-[10px] font-black uppercase tracking-widest border border-[var(--brand-secondary)]/20 mb-4 inline-block\">\n                                        Step {currentStepIdx + 1}: {currentStep.title}\n                                    </span>\n                                    <BrightHeading level={2}>{currentStep.description}</BrightHeading>\n                                </div>\n\n                                <div className=\"grid gap-4\">\n                                    {currentStep.options?.map((opt, i) => (\n                                        <button\n                                            key={i}\n                                            onClick={() => handleOptionSelect(i)}\n                                            disabled={selectedOption !== null}\n                                            className={`\n                                                w-full text-left p-6 rounded-2xl border-2 transition-all group\n                                                ${selectedOption === i\n                                                    ? 'border-[var(--brand-primary)] bg-[var(--brand-primary)]/10'\n                                                    : 'border-[var(--border-subtle)] bg-[var(--bg-elevated)] hover:border-[var(--brand-primary)]/50'\n                                                }\n                                            `}\n                                        >\n                                            <div className=\"flex justify-between items-center\">\n                                                <span className=\"font-bold text-lg text-[var(--text-primary)]\">{opt.label}</span>\n                                                {selectedOption === i && <span className=\"text-xl\">üëâ</span>}\n                                            </div>\n                                            <AnimatePresence>\n                                                {selectedOption === i && (\n                                                    <motion.p\n                                                        initial={{ height: 0, opacity: 0 }}\n                                                        animate={{ height: 'auto', opacity: 1 }}\n                                                        className=\"mt-4 text-[var(--text-secondary)] font-medium\"\n                                                    >\n                                                        {opt.story}\n                                                    </motion.p>\n                                                )}\n                                            </AnimatePresence>\n                                        </button>\n                                    ))}\n                                </div>\n                            </motion.div>\n                        )}\n                    </AnimatePresence>\n                </div>\n\n                {/* Sidebar summary in Workspace? Not needed for now, keep it clean */}\n            </main>\n\n            {/* Footer Order Info */}\n            <div className=\"h-24 bg-[var(--bg-elevated)] border-t border-[var(--border-subtle)] flex items-center px-8\">\n                <div className=\"flex gap-8\">\n                    <div>\n                        <p className=\"text-[10px] font-black uppercase text-[var(--text-muted)] mb-1\">Contract Value</p>\n                        <p className=\"font-black flex items-center gap-1 text-[var(--brand-accent)]\"><BCoinIcon size={14} /> {order.totalAmount}</p>\n                    </div>\n                    <div className=\"h-10 w-px bg-[var(--border-subtle)]\" />\n                    <div>\n                        <p className=\"text-[10px] font-black uppercase text-[var(--text-muted)] mb-1\">Target Quality</p>\n                        <p className=\"font-black text-[var(--text-primary)] capitalize\">{order.qualityRequirement}</p>\n                    </div>\n                </div>\n            </div>\n        </motion.div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/EmployeeIDCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/EmployeeShop.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2263,2266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2263,2266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":78,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2823,2826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2823,2826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Image from 'next/image';\nimport { BrightHeading, useDialog } from '@/components/system';\nimport { BusinessState, Employee } from '@/lib/economy/economy-types';\nimport EmployeeIDCard from '@/components/business/EmployeeIDCard';\nimport { useAuth } from '@/lib/auth-context';\nimport { getDicebearAvatarUrl } from '@/lib/avatars';\n\ninterface EmployeeShopProps {\n    business: BusinessState;\n}\n\nexport default function EmployeeShop({ business }: EmployeeShopProps) {\n    const candidates = business.recruitmentPool || [];\n    const { showAlert, showConfirm } = useDialog();\n    const { user } = useAuth();\n\n    const postEmployeeAction = async (payload: {\n        businessId: string;\n        action: 'hire' | 'decline' | 'pay' | 'pay_all' | 'fire' | 'assign_specialization';\n        candidateId?: string;\n        employeeId?: string;\n        specialization?: string;\n    }) => {\n        if (!user) throw new Error('Not authenticated');\n\n        const token = await user.getIdToken();\n        const response = await fetch('/api/business/employees', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify(payload)\n        });\n\n        const data = await response.json();\n        if (!response.ok) {\n            throw new Error(data.error || 'Failed to process employee action');\n        }\n        return data;\n    };\n\n    const handleHire = (candidate: Employee) => {\n        const hiringCost = Math.floor(candidate.salaryPerDay * 1);\n\n        if (business.cashBalance < hiringCost) {\n            showAlert(\"Insufficient funds for hiring deposit! Earn more capital before expanding your team.\", { title: 'INSUFFICIENT FUNDS' });\n            return;\n        }\n\n        showConfirm(\n            `Hire ${candidate.name} for a daily rate of ‡∏ø${candidate.salaryPerDay}? A 1-day deposit (‡∏ø${hiringCost}) is required.`,\n            async () => {\n                try {\n                    await postEmployeeAction({\n                        businessId: business.id,\n                        action: 'hire',\n                        candidateId: candidate.id\n                    });\n                } catch (e: any) {\n                    console.error(\"Hiring failed:\", e);\n                    showAlert(e.message || \"Failed to process hiring. Please check your connection and try again.\");\n                }\n            },\n            { title: 'CONFIRM HIRING', confirmLabel: 'HIRE' }\n        );\n    };\n\n    const handleDecline = async (candidate: Employee) => {\n        try {\n            await postEmployeeAction({\n                businessId: business.id,\n                action: 'decline',\n                candidateId: candidate.id\n            });\n        } catch (e: any) {\n            console.error(\"Decline failed:\", e);\n            showAlert(e.message || \"Failed to decline candidate. Please try again.\");\n        }\n    };\n\n    return (\n        <div className=\"duo-card p-8 space-y-8\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6\">\n                <div>\n                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Recruitment</div>\n                    <BrightHeading level={2} className=\"text-3xl m-0\">Talent Marketplace</BrightHeading>\n                    <p className=\"text-xs text-[var(--text-secondary)] font-bold mt-1 opacity-70\">Found {candidates.length} candidates available for hire.</p>\n                </div>\n\n                {/* Visual Flair - Randomized Avatars */}\n                <div className=\"flex -space-x-3\">\n                    {candidates.slice(0, 3).map(c => (\n                        <div key={c.id} className=\"w-12 h-12 rounded-2xl border-4 border-[var(--bg-primary)] bg-[var(--bg-elevated)] overflow-hidden shadow-lg transition-transform hover:translate-y-[-4px] hover:z-20\">\n                            <Image\n                                src={getDicebearAvatarUrl(c.id)}\n                                alt=\"candidate\"\n                                width={48}\n                                height={48}\n                                className=\"w-full h-full object-cover\"\n                            />\n                        </div>\n                    ))}\n                    {candidates.length > 3 && (\n                        <div className=\"w-12 h-12 rounded-2xl border-4 border-[var(--bg-primary)] bg-[var(--brand-primary)] text-white flex items-center justify-center text-xs font-black shadow-lg z-10 transition-transform hover:scale-110\">\n                            +{candidates.length - 3}\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {candidates.length === 0 ? (\n                <div className=\"py-20 text-center bg-[var(--bg-secondary)]/30 rounded-[3rem] border-2 border-dashed border-[var(--border-subtle)]\">\n                    <div className=\"text-6xl mb-6 grayscale opacity-30\">üïµÔ∏è‚Äç‚ôÄÔ∏è</div>\n                    <BrightHeading level={3} className=\"mb-2 text-[var(--text-muted)] tracking-tighter\">Market Exhausted</BrightHeading>\n                    <p className=\"text-sm font-black uppercase tracking-widest text-[var(--text-secondary)] opacity-50\">Headhunters are refreshing the pool...</p>\n                </div>\n            ) : (\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 auto-rows-fr\">\n                    {candidates.map(candidate => (\n                        <EmployeeIDCard\n                            key={candidate.id}\n                            employee={candidate}\n                            mode=\"hiring\"\n                            onAction={() => handleHire(candidate)}\n                            onSecondaryAction={() => handleDecline(candidate)}\n                            actionLabel={`HIRE (‡∏ø${(candidate.salaryPerDay).toLocaleString()})`}\n                            secondaryLabel=\"PASS\"\n                            cost={candidate.salaryPerDay}\n                            currencyContext={business.cashBalance}\n                            disabled={business.cashBalance < candidate.salaryPerDay}\n                        />\n                    ))}\n                </div>\n            )}\n        </div>\n    );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/EmployeeSkillsPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/InventoryPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/LoyaltyDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/Marketplace.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":57,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'rect' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":133,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":195,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":195,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8633,8636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8633,8636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":196,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8676,8679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8676,8679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { BrightHeading, useDialog } from '@/components/system';\nimport { MarketItem, BusinessState } from '@/lib/economy/economy-types';\nimport { ensureMarketRestock } from '@/lib/economy';\nimport {\n    SupplyDemandCurve,\n    calculatePrice,\n    getPricingResult,\n    simulateMarketDemand\n} from '@/lib/economy/pricing-engine';\nimport { doc, updateDoc, increment } from 'firebase/firestore';\nimport { db } from '@/lib/firebase';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\n\ninterface MarketplaceProps {\n    business: BusinessState;\n}\n\n// Purchase Particle Effect\ntype PurchaseParticle = {\n    id: number;\n    x: number;\n    y: number;\n    text: string;\n};\n\n// Initialize supply/demand curves for market items\nconst initializePricingCurves = (items: MarketItem[]): Map<string, SupplyDemandCurve> => {\n    const curves = new Map<string, SupplyDemandCurve>();\n\n    items.forEach(item => {\n        curves.set(item.id, {\n            productId: item.id,\n            basePrice: item.price,\n            currentSupply: item.stock,\n            currentDemand: Math.floor(item.maxStock * 0.3),\n            elasticity: 0.3,\n            priceHistory: [{ timestamp: new Date().toISOString(), price: item.price }]\n        });\n    });\n\n    return curves;\n};\n\nexport default function Marketplace({ business }: MarketplaceProps) {\n    const [timeLeft, setTimeLeft] = useState<string>('00:00');\n    const [isRestocking, setIsRestocking] = useState(false);\n    const [pricingCurves, setPricingCurves] = useState<Map<string, SupplyDemandCurve>>(new Map());\n    const [particles, setParticles] = useState<PurchaseParticle[]>([]);\n    const { showAlert } = useDialog();\n    const anySrcLoader = ({ src }: { src: string }) => src;\n\n    const { professor, showSuccess: showProfessorSuccess, showHint } = useProfessor({\n        initialMessage: \"Buy materials when prices are low! Watch for the green indicators.\"\n    });\n\n    useEffect(() => {\n        if (business.marketState?.items && business.marketState.items.length > 0) {\n            const curves = initializePricingCurves(business.marketState.items);\n            const hour = new Date().getHours();\n            const demandMultiplier = simulateMarketDemand(hour, business.reputation);\n\n            curves.forEach((curve, itemId) => {\n                const adjustedDemand = Math.floor(curve.currentDemand * demandMultiplier);\n                curves.set(itemId, { ...curve, currentDemand: adjustedDemand });\n            });\n\n            setPricingCurves(curves);\n        }\n    }, [business.marketState?.items, business.reputation]);\n\n    useEffect(() => {\n        let mounted = true;\n        const tryRestockIfDue = async () => {\n            const now = Date.now();\n            const nextRestock = business.marketState?.nextRestock ? new Date(business.marketState.nextRestock).getTime() : 0;\n\n            if (!nextRestock || now >= nextRestock) {\n                if (!mounted) return;\n                setIsRestocking(true);\n                try {\n                    await ensureMarketRestock(business.id);\n                    showProfessorSuccess(\"Market Restocked! Check for new deals.\");\n                } finally {\n                    if (mounted) setIsRestocking(false);\n                }\n            }\n        };\n\n        const timer = setInterval(() => {\n            const now = Date.now();\n            const nextRestock = business.marketState?.nextRestock ? new Date(business.marketState.nextRestock).getTime() : 0;\n\n            if (nextRestock > now) {\n                const diff = nextRestock - now;\n                const m = Math.floor(diff / 60000);\n                const s = Math.floor((diff % 60000) / 1000);\n                setTimeLeft(`${m}:${s.toString().padStart(2, '0')}`);\n            } else {\n                setTimeLeft('Restocking...');\n                if (!isRestocking) {\n                    tryRestockIfDue();\n                }\n            }\n        }, 1000);\n\n        tryRestockIfDue();\n        return () => {\n            mounted = false;\n            clearInterval(timer);\n        };\n    }, [business.id, business.marketState?.nextRestock, isRestocking, showProfessorSuccess]);\n\n    const handleBuy = async (item: MarketItem, quantity: number, event: React.MouseEvent) => {\n        const curve = pricingCurves.get(item.id);\n        const dynamicPrice = curve ? calculatePrice(curve) : item.price;\n        const cost = dynamicPrice * quantity;\n\n        if (business.cashBalance < cost) {\n            showAlert(\"Insufficient Bcoins! Complete more orders to earn cash for supplies.\", { title: 'INSUFFICIENT FUNDS' });\n            return;\n        }\n        if (item.stock < quantity) {\n            showAlert(\"Not enough stock available in the market right now. Wait for the next restock!\", { title: 'OUT OF STOCK' });\n            return;\n        }\n\n        // Add particles\n        const rect = (event.target as HTMLElement).getBoundingClientRect();\n        const newParticle = {\n            id: Date.now(),\n            x: event.clientX,\n            y: event.clientY,\n            text: `+${quantity} ${item.name}`\n        };\n        setParticles(prev => [...prev, newParticle]);\n        setTimeout(() => setParticles(prev => prev.filter(p => p.id !== newParticle.id)), 1000);\n\n        const bizRef = doc(db, 'businesses', business.id);\n        const newMarketItems = marketItems.map(i =>\n            i.id === item.id ? { ...i, stock: i.stock - quantity, price: Math.round(dynamicPrice) } : i\n        );\n\n        if (curve) {\n            const updatedCurve = {\n                ...curve,\n                currentSupply: Math.max(0, curve.currentSupply - quantity),\n                currentDemand: curve.currentDemand + Math.floor(quantity * 0.5),\n                priceHistory: [\n                    ...curve.priceHistory.slice(-20),\n                    { timestamp: new Date().toISOString(), price: dynamicPrice }\n                ]\n            };\n            setPricingCurves(new Map(pricingCurves.set(item.id, updatedCurve)));\n        }\n\n        await updateDoc(bizRef, {\n            [`inventory.${item.id}`]: increment(quantity),\n            cashBalance: increment(-cost),\n            balance: increment(-cost),\n            'marketState.items': newMarketItems\n        });\n\n        if (quantity >= 5) {\n            showProfessorSuccess(`Smart move! Bulk buying ${item.name} saves time.`);\n        }\n    };\n\n    const getDefaultMarketItems = (): MarketItem[] => [\n        { id: 'rice_5kg', name: 'Premium Rice (5kg)', price: 25, stock: 120, maxStock: 120, image: '/products/Rice.png', icon: 'üçö' },\n        { id: 'flour_2kg', name: 'All-Purpose Flour', price: 12, stock: 160, maxStock: 160, image: '/products/Flour.png', icon: 'üåæ' },\n        { id: 'oil_1l', name: 'Vegetable Oil', price: 20, stock: 90, maxStock: 90, image: '/products/CookingOil.png', icon: 'üõ¢Ô∏è' },\n        { id: 'dish_soap', name: 'Sparkle Dish Soap', price: 9, stock: 200, maxStock: 200, image: '/products/DishSoap.png', icon: 'üßº' },\n        { id: 'tissue_4pk', name: 'Soft Tissue Pack', price: 14, stock: 140, maxStock: 140, image: '/products/toilet_paper.png', icon: 'üßª' },\n        { id: 'plantain_chips', name: 'Crunchy Chips', price: 6, stock: 300, maxStock: 300, image: '/products/PlantainChips.png', icon: 'üçå' },\n        { id: 'sugar_1kg', name: 'Cane Sugar', price: 15, stock: 140, maxStock: 140, image: '/products/Surgar.png', icon: 'üç¨' },\n        { id: 'cole_cold', name: 'Cole Cold', price: 8, stock: 240, maxStock: 240, image: '/products/Cole_Cold_copy.png', icon: 'ü•§' },\n        { id: 'fries_pack', name: 'Frozen Fries', price: 10, stock: 180, maxStock: 180, image: '/products/Fries.png', icon: 'üçü' },\n        { id: 'peppers_fresh', name: 'Fresh Peppers', price: 5, stock: 150, maxStock: 150, image: '/products/Peppers.jpg', icon: 'üå∂Ô∏è' },\n        { id: 'salt_pack', name: 'Sea Salt', price: 4, stock: 240, maxStock: 240, image: '/products/Salt.png', icon: 'üßÇ' },\n        { id: 'eco_tshirt', name: 'Eco Tee', price: 28, stock: 120, maxStock: 120, icon: 'üßµ' },\n        { id: 'eco_tote', name: 'Canvas Tote', price: 18, stock: 160, maxStock: 160, icon: 'üëú' },\n        { id: 'upcycle_denim', name: 'Upcycled Denim Jacket', price: 52, stock: 90, maxStock: 90, icon: 'üß•' },\n    ];\n\n    const marketItems = (business.marketState?.items && business.marketState.items.length > 0\n        ? business.marketState.items\n        : getDefaultMarketItems()\n    ).map(item => ({\n        ...item,\n        icon: (item as any).icon || 'üì¶',\n        image: (item as any).image || getDefaultMarketItems().find(d => d.id === item.id)?.image\n    }));\n\n    return (\n        <div className=\"duo-card p-8 space-y-8 flex flex-col h-full relative\">\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6\">\n                <div>\n                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Logistics</div>\n                    <BrightHeading level={2} className=\"text-3xl m-0\">Supply Marketplace</BrightHeading>\n                    <p className=\"text-xs text-[var(--text-secondary)] font-bold mt-1 opacity-70\">Purchase raw materials at dynamic market rates.</p>\n                </div>\n                <div className=\"flex items-center gap-2 px-6 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                    <span className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest\">Next Restock</span>\n                    <span className=\"font-mono font-black text-[var(--brand-primary)] text-lg tabular-nums\">{timeLeft}</span>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-8\">\n                {marketItems.map((item) => {\n                    const stockPercent = (item.stock / item.maxStock) * 100;\n                    const isLowStock = stockPercent < 30;\n                    const isSoldOut = item.stock === 0;\n\n                    const curve = pricingCurves.get(item.id);\n                    const dynamicPrice = curve ? Math.round(calculatePrice(curve)) : item.price;\n                    const pricingResult = curve ? getPricingResult(curve) : null;\n                    const priceChanged = dynamicPrice !== item.price;\n\n                    return (\n                        <div key={item.id} className=\"duo-card p-0 overflow-hidden flex flex-col group h-full\">\n                            {/* Stock Bar */}\n                            <div className=\"absolute top-0 left-0 right-0 h-1.5 z-10 bg-[var(--bg-secondary)]\">\n                                <div\n                                    className={`h-full transition-all duration-700 ${isSoldOut ? 'bg-[var(--state-error)]' : isLowStock ? 'bg-orange-500' : 'bg-emerald-500'}`}\n                                    style={{ width: `${stockPercent}%` }}\n                                />\n                            </div>\n\n                            {/* Image Area */}\n                            <div className=\"aspect-square relative bg-[var(--bg-secondary)]/50 p-6 flex items-center justify-center group-hover:bg-white/10 transition-colors\">\n                                {item.image ? (\n                                    <Image\n                                        loader={anySrcLoader}\n                                        unoptimized\n                                        src={item.image}\n                                        alt={item.name}\n                                        fill\n                                        sizes=\"(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 20vw\"\n                                        className=\"object-contain filter drop-shadow-xl group-hover:scale-110 transition-transform duration-700\"\n                                    />\n                                ) : (\n                                    <div className=\"text-5xl group-hover:scale-110 transition-transform duration-700\">{item.icon}</div>\n                                )}\n\n                                <div className={`absolute top-4 right-4 px-3 py-1 rounded-xl text-[10px] font-black uppercase tracking-widest border-2 shadow-lg backdrop-blur-md ${isSoldOut ? 'bg-red-500/90 text-white border-red-500/20' : 'bg-black/50 text-white border-white/20'}`}>\n                                    {isSoldOut ? 'Sold Out' : `${item.stock} left`}\n                                </div>\n\n                                {pricingResult && pricingResult.trend !== 'stable' && (\n                                    <div className={`absolute top-4 left-4 px-3 py-1 rounded-xl text-[10px] font-black backdrop-blur-md border-2 shadow-lg ${pricingResult.trend === 'rising' ? 'bg-orange-500/80 text-white border-orange-500/20' : 'bg-emerald-500/80 text-white border-emerald-500/20'}`}>\n                                        {pricingResult.trend === 'rising' ? '‚ñ≤ PRICE' : '‚ñº PRICE'}\n                                    </div>\n                                )}\n                            </div>\n\n                            {/* Details */}\n                            <div className=\"p-5 flex-1 flex flex-col\">\n                                <h4 className=\"font-black text-[var(--text-primary)] text-sm mb-2 truncate\" title={item.name}>{item.name}</h4>\n                                <div className=\"flex items-baseline gap-2 mb-4\">\n                                    <span className={`font-black text-2xl ${priceChanged ? 'text-orange-500' : 'text-[var(--brand-primary)]'}`}>\n                                        ‡∏ø{dynamicPrice}\n                                    </span>\n                                    {priceChanged && (\n                                        <span className=\"text-xs text-[var(--text-muted)] line-through font-bold opacity-50\">\n                                            ‡∏ø{item.price}\n                                        </span>\n                                    )}\n                                </div>\n\n                                {pricingResult && (\n                                    <p className=\"text-[10px] font-bold text-[var(--text-muted)] mb-6 leading-relaxed opacity-70\">\n                                        {pricingResult.reason}\n                                    </p>\n                                )}\n\n                                <div className=\"mt-auto space-y-3\">\n                                    <button\n                                        disabled={item.stock < 1 || business.cashBalance < dynamicPrice}\n                                        onClick={(e) => handleBuy(item, 1, e)}\n                                        className=\"duo-btn w-full text-[10px] py-2 border-b-4 border-black/10\"\n                                    >\n                                        Buy 1 Units\n                                    </button>\n                                    <button\n                                        disabled={item.stock < 5 || business.cashBalance < dynamicPrice * 5}\n                                        onClick={(e) => handleBuy(item, 5, e)}\n                                        className=\"duo-btn duo-btn-primary w-full text-[10px] py-2\"\n                                    >\n                                        Bulk Buy (5)\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    );\n                })}\n            </div>\n\n            {/* Floating Particles */}\n            <AnimatePresence>\n                {particles.map((p) => (\n                    <motion.div\n                        key={p.id}\n                        initial={{ opacity: 1, y: 0, x: 0 }}\n                        animate={{ opacity: 0, y: -100 }}\n                        exit={{ opacity: 0 }}\n                        className=\"fixed pointer-events-none z-[100] text-emerald-400 font-black text-xl drop-shadow-lg\"\n                        style={{ top: p.y, left: p.x }}\n                    >\n                        {p.text}\n                    </motion.div>\n                ))}\n            </AnimatePresence>\n\n            <ProfessorBright state={professor} />\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/OrderDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":277,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":277,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12192,12195],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12192,12195],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":278,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12244,12247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12244,12247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":279,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12305,12308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12305,12308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Economy ‚Äî Order Dashboard\n * Displays active orders, pending payments, and financial summary.\n */\n\nimport { useEffect, useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { BrightLayer, BrightButton, BrightHeading } from '@/components/system';\nimport { Order, OrderStatus, BusinessState, QualityTier } from '@/lib/economy/economy-types';\nimport { BusinessType } from '@/lib/economy/economy-types';\nimport { getDicebearAvatarUrl } from '@/lib/avatars';\n\ninterface OrderDashboardProps {\n    businessState: BusinessState;\n    businessType: BusinessType;\n    orders: Order[];\n    onAcceptOrder: (orderId: string) => void;\n    onRejectOrder: (orderId: string) => void;\n    onCompleteOrder: (orderId: string) => void;\n    onFulfill: (order: Order) => void;\n}\n\nconst STATUS_COLORS: Record<OrderStatus, string> = {\n    pending: 'var(--state-warning)',\n    accepted: 'var(--state-info)',\n    in_progress: 'var(--brand-primary)',\n    completed: 'var(--state-success)',\n    failed: 'var(--state-error)',\n    cancelled: 'var(--text-muted)',\n    expired: 'var(--text-muted)',\n};\n\nconst STATUS_LABELS: Record<OrderStatus, string> = {\n    pending: 'New Order',\n    accepted: 'Accepted',\n    in_progress: 'In Progress',\n    completed: 'Completed',\n    failed: 'Failed',\n    cancelled: 'Cancelled',\n    expired: 'Expired',\n};\n\nconst QUALITY_EMOJI: Record<QualityTier, string> = {\n    basic: '‚≠ê',\n    standard: '‚≠ê‚≠ê',\n    premium: '‚≠ê‚≠ê‚≠ê',\n};\n\nexport function OrderDashboard({\n    businessState,\n    businessType,\n    orders,\n    onAcceptOrder,\n    onRejectOrder,\n    onCompleteOrder,\n    onFulfill,\n}: OrderDashboardProps) {\n    const [now, setNow] = useState(0);\n\n    useEffect(() => {\n        setNow(Date.now());\n        const interval = setInterval(() => setNow(Date.now()), 60000);\n        return () => clearInterval(interval);\n    }, []);\n\n    // Group orders by status\n    const pendingOrders = orders.filter(o => o.status === 'pending');\n    const activeOrders = orders.filter(o => o.status === 'accepted' || o.status === 'in_progress');\n    const completedOrders = orders.filter(o => o.status === 'completed').slice(0, 5);\n\n    // Time until next deadline\n    const activeWithDeadlines = activeOrders\n        .filter(o => o.deadline)\n        .map(o => new Date(o.deadline))\n        .sort((a, b) => a.getTime() - b.getTime());\n\n    const nextDeadline = activeWithDeadlines[0];\n\n    const formatTimeRemaining = (deadline: Date): string => {\n        if (!now) return '...';\n        const diff = deadline.getTime() - now;\n        if (diff < 0) return 'OVERDUE';\n        const mins = Math.floor(diff / 60000);\n        const hours = Math.floor(mins / 60);\n        if (hours > 0) return `${hours}h ${mins % 60}m`;\n        return `${mins}m`;\n    };\n\n    const getAvatarSeed = (order: Order) =>\n        businessState.customerProfiles?.[order.customerId]?.avatarSeed ?? order.customerId;\n\n    return (\n        <div className=\"space-y-8 layout-transition\">\n            {/* Incoming Orders (Pending) */}\n            <div className=\"min-h-[140px] flex flex-col\">\n                <BrightHeading level={3} className=\"mb-4 flex items-center gap-3\">\n                    <span className=\"relative flex h-3 w-3\">\n                        <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-[var(--state-warning)] opacity-75\"></span>\n                        <span className=\"relative inline-flex rounded-full h-3 w-3 bg-[var(--state-warning)]\"></span>\n                    </span>\n                    <span className=\"tracking-tight\">Market Requests</span>\n                    <span className=\"ml-auto text-[10px] font-black bg-[var(--bg-elevated)] px-2 py-0.5 rounded-full border border-[var(--border-subtle)]\">\n                        {pendingOrders.length} QUEUED\n                    </span>\n                </BrightHeading>\n\n                <div className=\"space-y-3 relative flex-1\">\n                    <AnimatePresence initial={false} mode=\"popLayout\">\n                        {pendingOrders.map((order) => (\n                            <motion.div\n                                key={order.id}\n                                layout\n                                initial={{ opacity: 0, y: 10, scale: 0.95 }}\n                                animate={{ opacity: 1, y: 0, scale: 1 }}\n                                exit={{ opacity: 0, scale: 0.9, x: -20 }}\n                                transition={{ type: 'spring', stiffness: 400, damping: 30 }}\n                            >\n                                <OrderCard\n                                    order={order}\n                                    businessType={businessType}\n                                    customerAvatarSeed={getAvatarSeed(order)}\n                                    onAccept={() => onAcceptOrder(order.id)}\n                                    onReject={() => onRejectOrder(order.id)}\n                                    showActions={true}\n                                    now={now}\n                                />\n                            </motion.div>\n                        ))}\n                    </AnimatePresence>\n                    {pendingOrders.length === 0 && (\n                        <div className=\"flex-1 flex items-center justify-center p-8 border border-dashed border-[var(--border-subtle)] rounded-2xl bg-[var(--bg-elevated)]/5\">\n                            <p className=\"text-xs text-[var(--text-muted)] italic font-medium\">Scanning for new market opportunities...</p>\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {/* Active Operations */}\n            <div className=\"min-h-[220px] flex flex-col\">\n                <div className=\"flex justify-between items-end mb-4\">\n                    <BrightHeading level={3} className=\"tracking-tight\">Live Operations</BrightHeading>\n                    {nextDeadline && (\n                        <span className=\"text-[10px] font-black text-[var(--state-warning)] bg-[var(--state-warning)]/10 px-2 py-1 rounded border border-[var(--state-warning)]/20 uppercase tracking-widest\">\n                            Urgent Due: {formatTimeRemaining(nextDeadline)}\n                        </span>\n                    )}\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 relative flex-1\">\n                    <AnimatePresence initial={false} mode=\"popLayout\">\n                        {activeOrders.map(order => (\n                            <motion.div\n                                key={order.id}\n                                layout\n                                initial={{ opacity: 0, scale: 0.9, y: 10 }}\n                                animate={{ opacity: 1, scale: 1, y: 0 }}\n                                exit={{ opacity: 0, scale: 0.8, filter: 'blur(8px)' }}\n                                transition={{ type: 'spring', stiffness: 350, damping: 25 }}\n                            >\n                                <OrderCard\n                                    order={order}\n                                    businessType={businessType}\n                                    customerAvatarSeed={getAvatarSeed(order)}\n                                    onComplete={() => onCompleteOrder(order.id)}\n                                    onFulfill={() => onFulfill(order)}\n                                    showActions={true}\n                                    showDeadline={true}\n                                    now={now}\n                                />\n                            </motion.div>\n                        ))}\n                    </AnimatePresence>\n                    {activeOrders.length === 0 && (\n                        <div className=\"col-span-full flex-1 flex flex-col items-center justify-center p-10 bg-[var(--bg-elevated)]/10 rounded-2xl border border-[var(--border-subtle)]\">\n                            <span className=\"text-2xl mb-2 opacity-50\">‚ö°</span>\n                            <p className=\"text-xs text-[var(--text-muted)] font-bold uppercase tracking-widest\">Systems Standby</p>\n                        </div>\n                    )}\n                </div>\n            </div>\n\n            {/* Terminal History */}\n            {completedOrders.length > 0 && (\n                <div className=\"pt-4 border-t border-[var(--border-subtle)]\">\n                    <p className=\"text-[10px] font-black uppercase tracking-[0.25em] text-[var(--text-muted)] mb-4\">Terminal Performance Log</p>\n                    <div className=\"flex gap-3 overflow-x-auto pb-4 sleek-scrollbar\">\n                        <AnimatePresence initial={false}>\n                            {completedOrders.map(order => (\n                                <motion.div\n                                    key={order.id}\n                                    initial={{ opacity: 0, x: 20 }}\n                                    animate={{ opacity: 1, x: 0 }}\n                                    className=\"flex-none min-w-[140px] bg-[var(--bg-elevated)]/40 rounded-xl px-4 py-3 border border-[var(--border-subtle)] hover:border-[var(--brand-primary)]/40 transition-all cursor-default\"\n                                >\n                                    <div className=\"flex items-center gap-2 mb-1\">\n                                        <Image\n                                            src={getDicebearAvatarUrl(getAvatarSeed(order))}\n                                            alt={order.customerName}\n                                            width={24}\n                                            height={24}\n                                            className=\"h-6 w-6 rounded-full border border-white/10 object-cover\"\n                                        />\n                                        <p className=\"text-[10px] font-black text-[var(--text-secondary)] uppercase truncate\">{order.customerName}</p>\n                                    </div>\n                                    <p className=\"text-sm font-black text-[var(--state-success)]\">+‡∏ø{order.paidAmount + order.tipAmount}</p>\n                                </motion.div>\n                            ))}\n                        </AnimatePresence>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n}\n\n// ----------------------------------------------------------------------------\n// Internal OrderCard Component\n// ----------------------------------------------------------------------------\n\ninterface OrderCardProps {\n    order: Order;\n    businessType: BusinessType;\n    customerAvatarSeed?: string;\n    onAccept?: () => void;\n    onReject?: () => void;\n    onComplete?: () => void;\n    onFulfill?: () => void;\n    showActions?: boolean;\n    showDeadline?: boolean;\n    now: number;\n}\n\nfunction OrderCard({\n    order,\n    customerAvatarSeed,\n    onAccept,\n    onReject,\n    onComplete,\n    onFulfill,\n    showActions = false,\n    showDeadline = false,\n    now,\n}: OrderCardProps) {\n    const isPending = order.status === 'pending';\n    const isActive = order.status === 'accepted' || order.status === 'in_progress';\n\n    // Calculate time remaining\n    const deadline = new Date(order.deadline);\n    const timeRemaining = now ? deadline.getTime() - now : null;\n    const isOverdue = timeRemaining !== null && timeRemaining < 0;\n    const isUrgent = timeRemaining !== null && timeRemaining < 5 * 60 * 1000; // Less than 5 mins\n\n    const formatDeadline = () => {\n        if (timeRemaining === null) return '...';\n        if (isOverdue) return 'OVERDUE';\n        const mins = Math.floor(timeRemaining / 60000);\n        if (mins < 60) return `${mins}m remaining`;\n        const hours = Math.floor(mins / 60);\n        return `${hours}h ${mins % 60}m remaining`;\n    };\n\n    const expiresInMinutes = now\n        ? Math.max(0, Math.floor((new Date(order.expiresAt).getTime() - now) / 60000))\n        : null;\n\n    const moodEmoji = {\n        happy: 'üòä',\n        neutral: 'üòê',\n        impatient: 'üò§',\n        demanding: 'üßê',\n    };\n\n    // Extract narrative if available\n    const narrative = (order as any).narrative;\n    const narrativeData = (order as any).narrativeData;\n    const consequenceMessage = (order as any).consequenceMessage;\n    const avatarUrl = getDicebearAvatarUrl(customerAvatarSeed ?? order.customerId);\n\n    return (\n        <BrightLayer\n            variant=\"glass\"\n            padding=\"md\"\n            className={`relative overflow-hidden transition-all duration-300 group/card glass-card-hover ${isPending ? 'border-l-4 border-l-[var(--state-warning)]' :\n                isOverdue ? 'border-l-4 border-l-[var(--state-error)] animate-pulse' :\n                    isUrgent ? 'border-l-4 border-l-[var(--state-warning)]' :\n                        'border-l-4 border-l-[var(--brand-primary)]'\n                }`}\n        >\n            <div className=\"flex justify-between items-start mb-4 gap-2\">\n                <div className=\"flex items-center gap-3 min-w-0\">\n                    <div className=\"relative flex-shrink-0\">\n                        <Image\n                            src={avatarUrl}\n                            alt={order.customerName}\n                            width={40}\n                            height={40}\n                            className=\"h-10 w-10 rounded-2xl border border-white/10 object-cover\"\n                        />\n                        <span className=\"absolute -bottom-1 -right-1 text-xs\">{moodEmoji[order.customerMood]}</span>\n                    </div>\n                    <div className=\"min-w-0\">\n                        <span className=\"block font-black text-sm text-[var(--text-primary)] leading-tight mb-1 truncate\">{order.customerName}</span>\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                            <span className=\"text-[9px] font-black uppercase text-[var(--text-muted)] tracking-widest flex-shrink-0\">{order.customerType}</span>\n                            <span className=\"w-1 h-1 rounded-full bg-[var(--border-subtle)] flex-shrink-0\" />\n                            <span className=\"text-[9px] font-black text-[var(--brand-primary)] uppercase flex-shrink-0\">{QUALITY_EMOJI[order.qualityRequirement]} QUALITY</span>\n                        </div>\n                    </div>\n                </div>\n                <div className=\"text-right flex-shrink-0\">\n                    <div className=\"flex items-center justify-end gap-1 mb-1\">\n                        <span className=\"text-xs font-black text-[var(--brand-accent)]\">‡∏ø</span>\n                        <span className=\"text-lg font-black text-[var(--brand-accent)] leading-none\">{order.totalAmount}</span>\n                    </div>\n                    <span\n                        className=\"text-[8px] px-2 py-0.5 rounded-md font-bold uppercase ring-1 ring-inset\"\n                        style={{\n                            backgroundColor: `color-mix(in srgb, ${STATUS_COLORS[order.status]} 10%, transparent)`,\n                            color: STATUS_COLORS[order.status],\n                            borderColor: `color-mix(in srgb, ${STATUS_COLORS[order.status]} 30%, transparent)`\n                        }}\n                    >\n                        {STATUS_LABELS[order.status]}\n                    </span>\n                </div>\n            </div>\n\n            {/* Items Summary */}\n            <div className=\"bg-[var(--bg-elevated)]/20 rounded-xl p-3 mb-4 space-y-1.5 border border-white/5\">\n                {order.items.map((item, idx) => (\n                    <div key={idx} className=\"flex justify-between items-center text-[11px] font-medium\">\n                        <span className=\"text-[var(--text-secondary)]\">\n                            <span className=\"text-[var(--text-muted)] font-black mr-2 opacity-60\">{item.quantity}X</span>\n                            {item.productName}\n                        </span>\n                        <span className=\"text-[var(--text-muted)] font-mono\">‡∏ø{item.pricePerUnit * item.quantity}</span>\n                    </div>\n                ))}\n            </div>\n\n            {/* Narrative Context */}\n            {narrative && isPending && (\n                <div className=\"bg-[var(--brand-primary)]/5 border border-[var(--brand-primary)]/20 rounded-xl p-3 mb-4\">\n                    <div className=\"text-[9px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-2\">\n                        üìñ Context\n                    </div>\n                    <p className=\"text-[11px] text-[var(--text-secondary)] leading-relaxed italic\">\n                        {narrative}\n                    </p>\n                    {narrativeData?.urgencyReason && (\n                        <div className=\"mt-2 text-[10px] text-[var(--state-warning)] font-bold\">\n                            ‚ö° {narrativeData.urgencyReason}\n                        </div>\n                    )}\n                </div>\n            )}\n\n            {/* Consequence Message (for completed orders) */}\n            {consequenceMessage && order.status === 'completed' && (\n                <div className=\"bg-[var(--state-success)]/5 border border-[var(--state-success)]/20 rounded-xl p-3 mb-4\">\n                    <div className=\"text-[9px] font-black uppercase tracking-widest text-[var(--state-success)] mb-2\">\n                        ‚ú® Outcome\n                    </div>\n                    <p className=\"text-[11px] text-[var(--text-secondary)] leading-relaxed\">\n                        {consequenceMessage}\n                    </p>\n                </div>\n            )}\n\n            {/* Status Feedback */}\n            <div className=\"flex items-center justify-between mt-auto\">\n                <div className=\"flex flex-col gap-1\">\n                    {showDeadline && isActive && (\n                        <div className={`text-[10px] font-black uppercase tracking-wider ${isOverdue ? 'text-[var(--state-error)]' : isUrgent ? 'text-[var(--state-warning)]' : 'text-[var(--text-muted)]'}`}>\n                            ‚è± {formatDeadline()}\n                        </div>\n                    )}\n                    {isPending && (\n                        <div className=\"text-[9px] font-black text-[var(--text-muted)] uppercase tracking-wider\">\n                            {expiresInMinutes === null ? 'Expires soon' : `Expires in ${expiresInMinutes}m`}\n                        </div>\n                    )}\n                </div>\n\n                {/* Actions */}\n                {showActions && (\n                    <div className=\"flex gap-2\">\n                        {isPending && (\n                            <>\n                                <BrightButton variant=\"ghost\" size=\"lg\" onClick={onReject} className=\"px-3 h-8\">\n                                    Decline\n                                </BrightButton>\n                                <BrightButton variant=\"primary\" size=\"lg\" onClick={onAccept} className=\"px-5 h-8 font-black\">\n                                    Accept\n                                </BrightButton>\n                            </>\n                        )}\n                        {isActive && (\n                            <div className=\"flex gap-2\">\n                                <BrightButton variant=\"ghost\" size=\"lg\" onClick={onReject} className=\"px-3 h-8 text-[var(--state-error)]/70 hover:text-[var(--state-error)]\">\n                                    Cancel\n                                </BrightButton>\n                                <BrightButton variant=\"ghost\" size=\"lg\" onClick={onComplete} className=\"px-3 h-8\">\n                                    Done\n                                </BrightButton>\n                                <BrightButton variant=\"primary\" size=\"sm\" onClick={onFulfill} className=\"px-5 h-8 font-black shadow-[0_0_15px_rgba(var(--brand-primary-rgb),0.25)]\">\n                                    Fulfill\n                                </BrightButton>\n                            </div>\n                        )}\n                    </div>\n                )}\n            </div>\n        </BrightLayer>\n    );\n}\n\nexport default OrderDashboard;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/OrgChart.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2068,2071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2068,2071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2762,2765],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2762,2765],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { BusinessState, Employee } from '@/lib/economy/economy-types';\nimport { BrightLayer, BrightHeading, useDialog } from '@/components/system';\nimport { getAvailableSpecializations } from '@/lib/economy/employee-skills';\nimport { useState } from 'react';\nimport EmployeeIDCard from '@/components/business/EmployeeIDCard';\nimport { useAuth } from '@/lib/auth-context';\n\ninterface OrgChartProps {\n    business: BusinessState;\n}\n\nexport default function OrgChart({ business }: OrgChartProps) {\n    const employees = business.employees || [];\n    const [selectedEmployee, setSelectedEmployee] = useState<Employee | null>(null);\n    const { showConfirm, showAlert } = useDialog();\n    const { user } = useAuth();\n\n    const postEmployeeAction = async (payload: {\n        businessId: string;\n        action: 'hire' | 'decline' | 'pay' | 'pay_all' | 'fire' | 'assign_specialization';\n        candidateId?: string;\n        employeeId?: string;\n        specialization?: string;\n    }) => {\n        if (!user) throw new Error('Not authenticated');\n\n        const token = await user.getIdToken();\n        const response = await fetch('/api/business/employees', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify(payload)\n        });\n\n        const data = await response.json();\n        if (!response.ok) {\n            throw new Error(data.error || 'Failed to process employee action');\n        }\n        return data;\n    };\n\n    const handleFire = (employee: Employee) => {\n        showConfirm(\n            `Are you sure you want to fire ${employee.name}? This action cannot be undone and may affect your reputation.`,\n            async () => {\n                try {\n                    await postEmployeeAction({\n                        businessId: business.id,\n                        action: 'fire',\n                        employeeId: employee.id\n                    });\n                } catch (error: any) {\n                    console.error('Failed to fire employee:', error);\n                    showAlert(error.message || 'Failed to fire employee. Please try again.');\n                }\n            },\n            { title: 'TERMINATE CONTRACT', type: 'danger', confirmLabel: 'FIRE' }\n        );\n    };\n\n    const handleAssignSpecialization = async (employee: Employee, specialization: string) => {\n        try {\n            await postEmployeeAction({\n                businessId: business.id,\n                action: 'assign_specialization',\n                employeeId: employee.id,\n                specialization\n            });\n            setSelectedEmployee(null);\n        } catch (error: any) {\n            console.error('Failed to assign specialization:', error);\n            showAlert(error.message || 'Failed to assign specialization. Please try again.');\n        }\n    };\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex justify-between items-end px-2\">\n                <BrightHeading level={3}>Organizational Chart</BrightHeading>\n                <span className=\"text-xs font-bold text-[var(--text-muted)] uppercase tracking-widest\">{employees.length} Active Staff</span>\n            </div>\n\n            {employees.length === 0 ? (\n                <BrightLayer variant=\"glass\" padding=\"lg\" className=\"text-center border-dashed border-2 border-[var(--border-subtle)]\">\n                    <p className=\"text-[var(--text-muted)] font-bold\">No employees hired yet.</p>\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-2\">Visit the Recruitment Center below to build your team.</p>\n                </BrightLayer>\n            ) : (\n                <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                    {employees.map((emp) => (\n                        <EmployeeIDCard\n                            key={emp.id}\n                            employee={emp}\n                            mode=\"managing\"\n                            onAction={() => setSelectedEmployee(emp)}\n                            onFire={() => handleFire(emp)}\n                            actionLabel={emp.specialization ? 'VIEW SKILLS' : 'SELECT SPECIALTY'}\n                            disabled={!emp.skills || !Object.values(emp.skills).some(s => s.level >= 3)}\n                        />\n                    ))}\n                </div>\n            )}\n\n            {/* Specialization Selection Modal */}\n            {selectedEmployee && (\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4\">\n                    <BrightLayer variant=\"elevated\" padding=\"lg\" className=\"max-w-md w-full\">\n                        <div className=\"flex justify-between items-start mb-4\">\n                            <div>\n                                <BrightHeading level={3}>Choose Specialization</BrightHeading>\n                                <p className=\"text-sm text-[var(--text-secondary)]\">{selectedEmployee.name}</p>\n                            </div>\n                            <button\n                                onClick={() => setSelectedEmployee(null)}\n                                className=\"text-[var(--text-muted)] hover:text-white\"\n                            >\n                                ‚úï\n                            </button>\n                        </div>\n\n                        <div className=\"space-y-3\">\n                            {Object.entries(selectedEmployee.skills || {})\n                                .filter(([_, skill]) => skill.level >= 3)\n                                .flatMap(([skillName]) => getAvailableSpecializations(skillName))\n                                .map((spec) => {\n                                    const specInfo = {\n                                        speed_specialist: { name: 'Speed Specialist', desc: '25% faster fulfillment', icon: '‚ö°' },\n                                        quality_master: { name: 'Quality Master', desc: '25% quality boost', icon: 'üíé' },\n                                        customer_relations: { name: 'Customer Relations', desc: 'Better loyalty impact', icon: 'ü§ù' },\n                                        inventory_expert: { name: 'Inventory Expert', desc: 'Reduced waste', icon: 'üì¶' },\n                                        multitasker: { name: 'Multitasker', desc: 'Handle 2 orders simultaneously', icon: 'üéØ' },\n                                    }[spec] || { name: spec, desc: '', icon: '‚≠ê' };\n\n                                    return (\n                                        <button\n                                            key={spec}\n                                            onClick={() => handleAssignSpecialization(selectedEmployee, spec)}\n                                            className=\"w-full p-4 bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] border border-[var(--border-subtle)] hover:border-[var(--brand-primary)] rounded-xl text-left transition-all group\"\n                                        >\n                                            <div className=\"flex items-center gap-3\">\n                                                <div className=\"text-2xl\">{specInfo.icon}</div>\n                                                <div className=\"flex-1\">\n                                                    <div className=\"font-bold text-[var(--text-primary)] group-hover:text-[var(--brand-primary)]\">\n                                                        {specInfo.name}\n                                                    </div>\n                                                    <div className=\"text-xs text-[var(--text-secondary)]\">\n                                                        {specInfo.desc}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </button>\n                                    );\n                                })}\n                        </div>\n                    </BrightLayer>\n                </div>\n            )}\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/PayrollManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showHint' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":80,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":80,"endColumn":80},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4747,4750],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4747,4750],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5400,5403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5400,5403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6440,6443],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6440,6443],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Employee, BusinessState } from '@/lib/economy/economy-types';\nimport { BrightHeading, useDialog } from '@/components/system';\nimport EmployeeIDCard from '@/components/business/EmployeeIDCard';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport ProfessorBright, { useProfessor } from '@/components/science/ProfessorBright';\n\ninterface PayrollManagerProps {\n    business: BusinessState;\n}\n\n// Draggable Cash Stack\nfunction DraggableCash({ id, isOverlay }: { id: string; isOverlay?: boolean }) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({ id });\n\n    return (\n        <div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            className={`\n                cursor-grab active:cursor-grabbing p-4 rounded-full bg-emerald-500 text-white font-black shadow-lg flex items-center justify-center\n                ${isOverlay ? 'scale-110 shadow-2xl z-50 ring-4 ring-emerald-300' : 'hover:scale-105 active:scale-95 transition-transform'}\n                ${isDragging ? 'opacity-0' : 'opacity-100'}\n            `}\n            style={{ width: '80px', height: '80px' }}\n        >\n            <span className=\"text-4xl\">üíµ</span>\n        </div>\n    );\n}\n\n// Droppable Employee Wrapper\nfunction DroppableEmployee({ children, employee }: { children: React.ReactNode; employee: Employee }) {\n    const { setNodeRef, isOver } = useDroppable({\n        id: employee.id,\n        disabled: employee.unpaidWages <= 0\n    });\n\n    return (\n        <div ref={setNodeRef} className=\"relative h-full\">\n            {isOver && employee.unpaidWages > 0 && (\n                <motion.div\n                    initial={{ opacity: 0 }}\n                    animate={{ opacity: 1 }}\n                    className=\"absolute inset-0 z-10 bg-emerald-500/20 rounded-3xl border-4 border-emerald-500 flex items-center justify-center backdrop-blur-[2px]\"\n                >\n                    <div className=\"bg-emerald-500 text-white px-6 py-2 rounded-full font-black text-xs uppercase shadow-xl animate-bounce\">\n                        Release Payment\n                    </div>\n                </motion.div>\n            )}\n            {children}\n        </div>\n    );\n}\n\nexport default function PayrollManager({ business }: PayrollManagerProps) {\n    const employees = business.employees || [];\n    const totalOwed = employees.reduce((sum, e) => sum + (e.unpaidWages || 0), 0);\n    const { showAlert, showConfirm } = useDialog();\n    const [activeId, setActiveId] = useState<string | null>(null);\n    const { user } = useAuth();\n\n    const { professor, showSuccess: showProfessorSuccess, showWarning, showHint } = useProfessor({\n        initialMessage: \"Drag the cash stack to an employee card to pay their wages instantly!\"\n    });\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, { activationConstraint: { distance: 8 } }),\n        useSensor(TouchSensor, { activationConstraint: { delay: 200, tolerance: 8 } })\n    );\n\n    const postEmployeeAction = async (payload: {\n        businessId: string;\n        action: 'hire' | 'decline' | 'pay' | 'pay_all' | 'fire' | 'assign_specialization';\n        candidateId?: string;\n        employeeId?: string;\n        specialization?: string;\n    }) => {\n        if (!user) throw new Error('Not authenticated');\n\n        const token = await user.getIdToken();\n        const response = await fetch('/api/business/employees', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify(payload)\n        });\n\n        const data = await response.json();\n        if (!response.ok) {\n            throw new Error(data.error || 'Failed to process employee action');\n        }\n        return data;\n    };\n\n    const handlePayEmployee = async (employee: Employee) => {\n        if (!employee || employee.unpaidWages <= 0) return;\n\n        if (business.cashBalance < employee.unpaidWages) {\n            showWarning(\"Insufficient funds! Earn more revenue first.\");\n            return;\n        }\n\n        try {\n            await postEmployeeAction({\n                businessId: business.id,\n                action: 'pay',\n                employeeId: employee.id\n            });\n            showProfessorSuccess(`Paid ‡∏ø${employee.unpaidWages.toLocaleString()} to ${employee.name}!`);\n        } catch (error: any) {\n            console.error('Failed to pay employee:', error);\n            showAlert(error.message || 'Failed to pay employee. Please try again.');\n        }\n    };\n\n    const handleFire = (employee: Employee) => {\n        showConfirm(\n            `Terminate ${employee.name}'s employment? All outstanding wages (‡∏ø${employee.unpaidWages}) will be forfeited.`,\n            async () => {\n                try {\n                    await postEmployeeAction({\n                        businessId: business.id,\n                        action: 'fire',\n                        employeeId: employee.id\n                    });\n                } catch (error: any) {\n                    console.error('Failed to fire employee:', error);\n                    showAlert(error.message || 'Failed to fire employee. Please try again.');\n                }\n            },\n            { title: 'TERMINATE CONTRACT', type: 'danger', confirmLabel: 'FIRE' }\n        );\n    };\n\n    const handlePayAll = async () => {\n        if (totalOwed <= 0) return;\n        if (business.cashBalance < totalOwed) {\n            showAlert(\"Insufficient funds to pay all staff! Current debt exceeds your liquid cash.\", { title: 'LIQUIDITY CRISIS' });\n            return;\n        }\n\n        showConfirm(\n            `Are you sure you want to disburse ‡∏ø${totalOwed.toLocaleString()} in total wages?`,\n            async () => {\n                try {\n                    await postEmployeeAction({\n                        businessId: business.id,\n                        action: 'pay_all'\n                    });\n                    showProfessorSuccess(\"All salaries paid! Employee morale boosted.\");\n                } catch (error: any) {\n                    console.error('Failed to pay all employees:', error);\n                    showAlert(error.message || 'Failed to process payroll. Please try again.');\n                }\n            },\n            { title: 'DISBURSE PAYROLL', confirmLabel: 'PAY ALL' }\n        );\n    };\n\n    const handleDragStart = (event: DragStartEvent) => {\n        setActiveId(event.active.id as string);\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        setActiveId(null);\n        const { over } = event;\n\n        if (over) {\n            const employee = employees.find(e => e.id === over.id);\n            if (employee) {\n                handlePayEmployee(employee);\n            }\n        }\n    };\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"duo-card p-8 h-full flex flex-col relative overflow-hidden\">\n                <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-10 relative z-10\">\n                    <div>\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Human Resources</div>\n                        <BrightHeading level={2} className=\"text-3xl m-0\">Payroll & Staff</BrightHeading>\n                        <p className=\"text-xs text-[var(--text-secondary)] font-bold mt-1 opacity-70\">Drag cash to employees to pay wages.</p>\n                    </div>\n\n                    <div className=\"bg-[var(--bg-secondary)] p-6 rounded-3xl border-2 border-[var(--border-subtle)] border-b-4 flex flex-col items-end w-full sm:w-auto\">\n                        <p className=\"text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest mb-1\">Outstanding Wages</p>\n                        <div className=\"flex items-center gap-3\">\n                            <p className={`text-4xl font-black ${totalOwed > 0 ? 'text-orange-500' : 'text-[var(--text-primary)]'}`}>\n                                ‡∏ø{totalOwed.toLocaleString()}\n                            </p>\n                            {totalOwed > 0 && (\n                                <button\n                                    onClick={handlePayAll}\n                                    className=\"duo-btn duo-btn-primary px-6 py-2 text-[10px]\"\n                                >\n                                    PAY ALL\n                                </button>\n                            )}\n                        </div>\n                    </div>\n                </div>\n\n                <div className=\"flex-1 overflow-y-auto pr-4 sleek-scrollbar min-h-[500px] relative z-10 pb-24\">\n                    {employees.length === 0 ? (\n                        <div className=\"h-64 flex flex-col items-center justify-center text-[var(--text-muted)] bg-[var(--bg-secondary)]/30 rounded-[2.5rem] border-2 border-dashed border-[var(--border-subtle)]\">\n                            <span className=\"text-5xl mb-4 grayscale opacity-30\">üë•</span>\n                            <p className=\"text-xs font-black uppercase tracking-widest opacity-50\">No employees hired yet</p>\n                        </div>\n                    ) : (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 auto-rows-fr\">\n                            <AnimatePresence mode=\"popLayout\">\n                                {employees.map((emp) => (\n                                    <motion.div\n                                        key={emp.id}\n                                        initial={{ opacity: 0, y: 20 }}\n                                        animate={{ opacity: 1, y: 0 }}\n                                        exit={{ opacity: 0, scale: 0.95 }}\n                                        className=\"h-full\"\n                                    >\n                                        <DroppableEmployee employee={emp}>\n                                            <EmployeeIDCard\n                                                employee={emp}\n                                                mode=\"managing\"\n                                                onAction={() => handlePayEmployee(emp)}\n                                                onFire={() => handleFire(emp)}\n                                                actionLabel={emp.unpaidWages > 0 ? 'PAY WAGES' : 'PAID UP'}\n                                                disabled={emp.unpaidWages <= 0}\n                                                currencyContext={business.cashBalance}\n                                            />\n                                        </DroppableEmployee>\n                                    </motion.div>\n                                ))}\n                            </AnimatePresence>\n                        </div>\n                    )}\n                </div>\n\n                {/* Floating Cash Dispenser */}\n                <div className=\"absolute bottom-6 right-6 z-20\">\n                    <DraggableCash id=\"cash-stack\" />\n                </div>\n\n                <DragOverlay>\n                    {activeId ? <DraggableCash id=\"cash-stack-overlay\" isOverlay /> : null}\n                </DragOverlay>\n\n                {/* Professor Guide */}\n                <ProfessorBright state={professor} />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/business/StockExchangePanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":92,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useMemo, useState } from 'react';\nimport { BrightHeading, useDialog } from '@/components/system';\nimport { BusinessState, updateBusinessFinancials } from '@/lib/economy';\nimport { calculatePortfolioValue, executeStockTrade, initStockMarketState } from '@/lib/economy/stock-market';\nimport type { StockListingState } from '@/lib/economy/stock-market';\nimport { getNetWorthSnapshot } from '@/lib/economy/valuation';\n\ninterface StockExchangePanelProps {\n    business: BusinessState;\n}\n\nexport default function StockExchangePanel({ business }: StockExchangePanelProps) {\n    const { showAlert } = useDialog();\n    const [processingSymbol, setProcessingSymbol] = useState<string | null>(null);\n\n    const market = business.stockMarket ?? initStockMarketState();\n    const portfolio = business.stockPortfolio ?? { cashReserved: 0, holdings: [], transactions: [], realizedPnL: 0 };\n\n    const holdingsMap = useMemo(() => {\n        return new Map(portfolio.holdings.map((holding) => [holding.symbol, holding]));\n    }, [portfolio.holdings]);\n\n    const portfolioValue = calculatePortfolioValue(market, portfolio);\n\n    const buildSparkline = (points: number[], width: number, height: number) => {\n        if (points.length < 2) {\n            return { line: '', area: '', min: points[0] ?? 0, max: points[0] ?? 0 };\n        }\n\n        const min = Math.min(...points);\n        const max = Math.max(...points);\n        const range = max - min || 1;\n\n        const line = points\n            .map((value, index) => {\n                const x = (index / (points.length - 1)) * width;\n                const y = height - ((value - min) / range) * height;\n                return `${index === 0 ? 'M' : 'L'}${x.toFixed(1)} ${y.toFixed(1)}`;\n            })\n            .join(' ');\n\n        const area = `${line} L ${width} ${height} L 0 ${height} Z`;\n\n        return { line, area, min, max };\n    };\n\n    const handleTrade = async (listing: StockListingState, type: 'buy' | 'sell', shares: number) => {\n        if (shares <= 0) return;\n\n        const holding = holdingsMap.get(listing.symbol);\n        if (type === 'sell' && (!holding || holding.shares < shares)) {\n            showAlert('Not enough shares to sell.', { title: 'TRADE BLOCKED' });\n            return;\n        }\n\n        const cost = listing.price * shares;\n        if (type === 'buy' && business.cashBalance < cost) {\n            showAlert('Not enough cash on hand to place this trade.', { title: 'INSUFFICIENT FUNDS' });\n            return;\n        }\n\n        setProcessingSymbol(listing.symbol);\n        try {\n            const result = executeStockTrade({\n                portfolio,\n                listing,\n                type,\n                shares\n            });\n\n            if (result.error) {\n                showAlert(result.error, { title: 'TRADE ERROR' });\n                return;\n            }\n\n            const cashDelta = result.cashDelta ?? 0;\n            const updatedBusiness = {\n                ...business,\n                cashBalance: business.cashBalance + cashDelta,\n                stockPortfolio: result.portfolio\n            };\n            const snapshot = getNetWorthSnapshot(updatedBusiness);\n\n            await updateBusinessFinancials(business.id, {\n                cashDelta,\n                stockPortfolio: result.portfolio,\n                netWorth: snapshot.netWorth,\n                valuation: snapshot.valuation\n            });\n        } catch (error) {\n            showAlert('Trade failed. Please try again.', { title: 'TRADE ERROR' });\n        } finally {\n            setProcessingSymbol(null);\n        }\n    };\n\n    return (\n        <div className=\"duo-card p-8 space-y-8\">\n            <div className=\"flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6\">\n                <div>\n                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] mb-1\">Business Stock Exchange</div>\n                    <BrightHeading level={2} className=\"text-3xl m-0\">Market Pulse</BrightHeading>\n                    <p className=\"text-xs text-[var(--text-secondary)] font-bold mt-1 opacity-70\">\n                        Trade shares and grow your portfolio alongside your operations.\n                    </p>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"px-5 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Cash</div>\n                        <div className=\"text-xl font-black text-[var(--text-primary)]\">‡∏ø{business.cashBalance.toLocaleString()}</div>\n                    </div>\n                    <div className=\"px-5 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Portfolio</div>\n                        <div className=\"text-xl font-black text-[var(--brand-accent)]\">‡∏ø{portfolioValue.toLocaleString()}</div>\n                    </div>\n                    <div className=\"px-5 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Realized P/L</div>\n                        <div className={`text-xl font-black ${portfolio.realizedPnL >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>\n                            {portfolio.realizedPnL >= 0 ? '+' : ''}‡∏ø{portfolio.realizedPnL.toLocaleString()}\n                        </div>\n                    </div>\n                    <div className=\"px-5 py-3 bg-[var(--bg-secondary)] rounded-2xl border-2 border-[var(--border-subtle)] border-b-4\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">Market Tick</div>\n                        <div className=\"text-xs font-bold text-[var(--text-secondary)]\">\n                            {new Date(market.lastTick).toLocaleTimeString()}\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {market.listings.map((listing) => {\n                    const holding = holdingsMap.get(listing.symbol);\n                    const isProcessing = processingSymbol === listing.symbol;\n                    const changePositive = listing.changePercent >= 0;\n                    const historyPoints = listing.history?.map((point) => point.price) ?? [listing.price];\n                    const chart = buildSparkline(historyPoints, 160, 56);\n                    const strokeColor = changePositive ? '#22c55e' : '#ef4444';\n                    const gradientId = `sparkline-${listing.symbol}`;\n\n                    return (\n                        <div key={listing.symbol} className=\"duo-card p-6 border-2 border-[var(--border-subtle)]/80 bg-[var(--bg-elevated)]/80\">\n                            <div className=\"flex items-start justify-between gap-4 mb-4\">\n                                <div>\n                                    <div className=\"text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">{listing.sector}</div>\n                                    <div className=\"text-lg font-black text-[var(--text-primary)]\">{listing.name}</div>\n                                    <div className=\"text-[11px] font-black text-[var(--brand-primary)]\">{listing.symbol}</div>\n                                </div>\n                                <div className=\"text-right\">\n                                    <div className=\"text-2xl font-black text-[var(--text-primary)]\">‡∏ø{listing.price}</div>\n                                    <div className={`text-[10px] font-black uppercase tracking-widest ${changePositive ? 'text-emerald-500' : 'text-red-500'}`}>\n                                        {changePositive ? '‚ñ≤' : '‚ñº'} {Math.abs(listing.changePercent)}%\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div className=\"mb-4 text-[11px] font-bold text-[var(--text-secondary)]\">\n                                {holding ? `${holding.shares} shares ‚Ä¢ Avg ‡∏ø${holding.avgCost}` : 'No holdings yet'}\n                            </div>\n\n                            <div className=\"mb-5\">\n                                <div className=\"rounded-2xl border border-[var(--border-subtle)]/70 bg-[var(--bg-secondary)]/40 p-3\">\n                                    {chart.line ? (\n                                        <svg width=\"100%\" height=\"60\" viewBox=\"0 0 160 56\" role=\"img\" aria-label={`${listing.name} price history`}>\n                                            <defs>\n                                                <linearGradient id={gradientId} x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                                                    <stop offset=\"0%\" stopColor={strokeColor} stopOpacity=\"0.35\" />\n                                                    <stop offset=\"100%\" stopColor={strokeColor} stopOpacity=\"0\" />\n                                                </linearGradient>\n                                            </defs>\n                                            <path d={chart.area} fill={`url(#${gradientId})`} />\n                                            <path d={chart.line} fill=\"none\" stroke={strokeColor} strokeWidth=\"2.2\" strokeLinecap=\"round\" />\n                                        </svg>\n                                    ) : (\n                                        <div className=\"h-[60px] flex items-center justify-center text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]\">\n                                            Waiting for data\n                                        </div>\n                                    )}\n                                    <div className=\"mt-2 flex justify-between text-[9px] font-black uppercase tracking-widest text-[var(--text-muted)]\">\n                                        <span>Low ‡∏ø{Math.round(chart.min)}</span>\n                                        <span>High ‡∏ø{Math.round(chart.max)}</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-3\">\n                                <div className=\"space-y-2\">\n                                    {[1, 5, 10].map((qty) => (\n                                        <button\n                                            key={`buy-${listing.symbol}-${qty}`}\n                                            disabled={isProcessing || business.cashBalance < listing.price * qty}\n                                            onClick={() => handleTrade(listing, 'buy', qty)}\n                                            className=\"duo-btn duo-btn-primary w-full text-[10px] py-2\"\n                                        >\n                                            Buy {qty}\n                                        </button>\n                                    ))}\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <button\n                                        disabled={isProcessing || !holding || holding.shares < 1}\n                                        onClick={() => handleTrade(listing, 'sell', 1)}\n                                        className=\"duo-btn w-full text-[10px] py-2 border-2 border-[var(--border-subtle)]\"\n                                    >\n                                        Sell 1\n                                    </button>\n                                    <button\n                                        disabled={isProcessing || !holding || holding.shares < 5}\n                                        onClick={() => handleTrade(listing, 'sell', 5)}\n                                        className=\"duo-btn w-full text-[10px] py-2 border-2 border-[var(--border-subtle)]\"\n                                    >\n                                        Sell 5\n                                    </button>\n                                    <button\n                                        disabled={isProcessing || !holding}\n                                        onClick={() => handleTrade(listing, 'sell', holding?.shares || 0)}\n                                        className=\"duo-btn w-full text-[10px] py-2 border-2 border-red-500/40 text-red-500\"\n                                    >\n                                        Sell All\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    );\n                })}\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/CharacterDialogue.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightButton"},"fix":{"range":[527,540],"text":""},"desc":"Remove unused variable \"BrightButton\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Cinematic UI ‚Äî CharacterDialogue Component\n * Renders character dialogue with typewriter effect, choice buttons, and emotion indicators.\n */\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    DialogueNode,\n    DialogueChoice,\n    CharacterEmotion\n} from '@/lib/cinematic/character-types';\nimport { getCharacter } from '@/lib/cinematic/character-registry';\nimport { CharacterSprite } from './CharacterSprite';\nimport { BrightButton, BrightLayer } from '@/components/system';\n\ninterface CharacterDialogueProps {\n    node: DialogueNode;\n    onChoiceSelect?: (choice: DialogueChoice) => void;\n    onComplete?: () => void;\n    autoAdvance?: boolean;\n    typewriterSpeed?: number; // ms per character\n    className?: string;\n}\n\nexport function CharacterDialogue({\n    node,\n    onChoiceSelect,\n    onComplete,\n    autoAdvance = false,\n    typewriterSpeed = 30,\n    className = '',\n}: CharacterDialogueProps) {\n    const [displayedText, setDisplayedText] = useState('');\n    const [isTyping, setIsTyping] = useState(true);\n    const [showChoices, setShowChoices] = useState(false);\n\n    const character = getCharacter(node.characterId);\n    const fullText = node.text;\n\n    // Typewriter effect\n    useEffect(() => {\n        setDisplayedText('');\n        setIsTyping(true);\n        setShowChoices(false);\n\n        let currentIndex = 0;\n        const interval = setInterval(() => {\n            if (currentIndex < fullText.length) {\n                setDisplayedText(fullText.slice(0, currentIndex + 1));\n                currentIndex++;\n            } else {\n                clearInterval(interval);\n                setIsTyping(false);\n\n                // Show choices after typing completes\n                if (node.choices && node.choices.length > 0) {\n                    setTimeout(() => setShowChoices(true), 300);\n                } else if (autoAdvance && node.delay) {\n                    // Auto-advance after delay\n                    setTimeout(() => onComplete?.(), node.delay);\n                }\n            }\n        }, typewriterSpeed);\n\n        return () => clearInterval(interval);\n    }, [node.id, fullText, typewriterSpeed, autoAdvance, node.delay, node.choices, onComplete]);\n\n    // Skip typewriter on click\n    const handleSkip = useCallback(() => {\n        if (isTyping) {\n            setDisplayedText(fullText);\n            setIsTyping(false);\n            if (node.choices && node.choices.length > 0) {\n                setTimeout(() => setShowChoices(true), 100);\n            }\n        } else if (!node.choices || node.choices.length === 0) {\n            // No choices, advance to next\n            onComplete?.();\n        }\n    }, [isTyping, fullText, node.choices, onComplete]);\n\n    const handleChoiceClick = (choice: DialogueChoice) => {\n        if (choice.disabled) return;\n        onChoiceSelect?.(choice);\n    };\n\n    return (\n        <motion.div\n            className={`w-full max-w-2xl mx-auto ${className}`}\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            transition={{ duration: 0.4 }}\n        >\n            <BrightLayer\n                variant=\"glass\"\n                padding=\"lg\"\n                className=\"relative overflow-hidden cursor-pointer\"\n                onClick={handleSkip}\n            >\n                {/* Accent border based on character */}\n                <div\n                    className=\"absolute left-0 top-0 bottom-0 w-1.5 rounded-l-lg\"\n                    style={{ backgroundColor: character.colorAccent }}\n                />\n\n                {/* Character Header */}\n                <div className=\"flex items-start gap-4 mb-4\">\n                    <CharacterSprite\n                        characterId={node.characterId}\n                        emotion={node.emotion || 'neutral'}\n                        isSpeaking={isTyping}\n                        size=\"md\"\n                        showName={false}\n                    />\n\n                    <div className=\"flex-1 min-w-0\">\n                        {/* Character Name & Role */}\n                        <div className=\"flex items-center gap-2 mb-1\">\n                            <span\n                                className=\"text-sm font-bold\"\n                                style={{ color: character.colorAccent }}\n                            >\n                                {character.name}\n                            </span>\n                            {node.emotion && node.emotion !== 'neutral' && (\n                                <EmotionBadge emotion={node.emotion} />\n                            )}\n                        </div>\n                        <span className=\"text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)]\">\n                            {character.role.replace('_', ' ')}\n                        </span>\n                    </div>\n\n                    {/* Skip indicator */}\n                    {isTyping && (\n                        <motion.div\n                            className=\"text-xs text-[var(--text-muted)] opacity-50\"\n                            animate={{ opacity: [0.3, 0.7, 0.3] }}\n                            transition={{ repeat: Infinity, duration: 1.5 }}\n                        >\n                            Click to skip\n                        </motion.div>\n                    )}\n                </div>\n\n                {/* Dialogue Text */}\n                <div className=\"relative min-h-[60px] pl-2\">\n                    <p className=\"text-lg leading-relaxed text-[var(--text-primary)]\">\n                        &ldquo;{displayedText}\n                        {isTyping && (\n                            <motion.span\n                                className=\"inline-block w-0.5 h-5 ml-0.5 bg-current\"\n                                animate={{ opacity: [1, 0] }}\n                                transition={{ repeat: Infinity, duration: 0.5 }}\n                            />\n                        )}\n                        {!isTyping && '&rdquo;'}\n                    </p>\n                </div>\n\n                {/* Continue indicator (when no choices) */}\n                {!isTyping && (!node.choices || node.choices.length === 0) && (\n                    <motion.div\n                        className=\"flex items-center justify-end gap-2 mt-4 text-sm text-[var(--brand-primary)]\"\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        transition={{ delay: 0.3 }}\n                    >\n                        <span className=\"font-medium\">Continue</span>\n                        <motion.span\n                            animate={{ x: [0, 5, 0] }}\n                            transition={{ repeat: Infinity, duration: 1 }}\n                        >\n                            ‚Üí\n                        </motion.span>\n                    </motion.div>\n                )}\n            </BrightLayer>\n\n            {/* Choice Buttons */}\n            <AnimatePresence>\n                {showChoices && node.choices && node.choices.length > 0 && (\n                    <motion.div\n                        className=\"mt-4 space-y-2\"\n                        initial={{ opacity: 0, y: 10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        exit={{ opacity: 0, y: -10 }}\n                        transition={{ staggerChildren: 0.1 }}\n                    >\n                        {node.choices.map((choice, index) => (\n                            <ChoiceButton\n                                key={choice.id}\n                                choice={choice}\n                                index={index}\n                                onClick={() => handleChoiceClick(choice)}\n                            />\n                        ))}\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </motion.div>\n    );\n}\n\n// ============================================================================\n// SUB-COMPONENTS\n// ============================================================================\n\nfunction EmotionBadge({ emotion }: { emotion: CharacterEmotion }) {\n    const emotionConfig: Record<CharacterEmotion, { label: string; color: string }> = {\n        neutral: { label: '', color: '' },\n        happy: { label: 'pleased', color: 'var(--state-success)' },\n        concerned: { label: 'concerned', color: 'var(--state-warning)' },\n        urgent: { label: 'urgent', color: 'var(--state-error)' },\n        disappointed: { label: 'disappointed', color: 'var(--state-error)' },\n        impressed: { label: 'impressed', color: 'var(--brand-accent)' },\n        suspicious: { label: 'suspicious', color: 'var(--state-warning)' },\n    };\n\n    const config = emotionConfig[emotion];\n    if (!config.label) return null;\n\n    return (\n        <span\n            className=\"px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider rounded-full\"\n            style={{\n                backgroundColor: `color-mix(in srgb, ${config.color} 20%, transparent)`,\n                color: config.color,\n            }}\n        >\n            {config.label}\n        </span>\n    );\n}\n\ninterface ChoiceButtonProps {\n    choice: DialogueChoice;\n    index: number;\n    onClick: () => void;\n}\n\nfunction ChoiceButton({ choice, index, onClick }: ChoiceButtonProps) {\n    const toneStyles: Record<DialogueChoice['tone'], string> = {\n        polite: 'border-[var(--state-success)]/30 hover:border-[var(--state-success)] hover:bg-[var(--state-success)]/5',\n        neutral: 'border-[var(--border-subtle)] hover:border-[var(--brand-primary)] hover:bg-[var(--brand-primary)]/5',\n        aggressive: 'border-[var(--state-error)]/30 hover:border-[var(--state-error)] hover:bg-[var(--state-error)]/5',\n    };\n\n    return (\n        <motion.button\n            className={`w-full text-left px-4 py-3 rounded-xl border-2 transition-all ${toneStyles[choice.tone]} ${choice.disabled ? 'opacity-50 cursor-not-allowed' : ''\n                }`}\n            onClick={onClick}\n            disabled={choice.disabled}\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ delay: index * 0.1 }}\n            whileHover={!choice.disabled ? { scale: 1.01 } : undefined}\n            whileTap={!choice.disabled ? { scale: 0.99 } : undefined}\n        >\n            <div className=\"flex items-center gap-3\">\n                {/* Choice indicator */}\n                <span className=\"w-6 h-6 rounded-full bg-[var(--bg-elevated)] flex items-center justify-center text-xs font-bold text-[var(--text-muted)]\">\n                    {index + 1}\n                </span>\n\n                <div className=\"flex-1\">\n                    <p className=\"font-medium text-[var(--text-primary)]\">{choice.text}</p>\n                    {choice.disabled && choice.disabledReason && (\n                        <p className=\"text-xs text-[var(--state-error)] mt-1\">{choice.disabledReason}</p>\n                    )}\n                </div>\n\n                {/* Tone indicator */}\n                {choice.tone !== 'neutral' && (\n                    <span className=\"text-xs opacity-50\">\n                        {choice.tone === 'polite' ? 'ü§ù' : '‚ö°'}\n                    </span>\n                )}\n            </div>\n        </motion.button>\n    );\n}\n\nexport default CharacterDialogue;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/CharacterSprite.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Character' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Character"},"fix":{"range":[272,282],"text":""},"desc":"Remove unused variable \"Character\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ANIMATION_DURATIONS' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ANIMATION_DURATIONS"},"fix":{"range":[371,396],"text":""},"desc":"Remove unused variable \"ANIMATION_DURATIONS\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'positionStyle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":139,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":139,"endColumn":24}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Cinematic UI ‚Äî CharacterSprite Component\n * Renders an animated character with emotion states and entrance/exit animations.\n */\n\nimport { motion, AnimatePresence, Variants } from 'framer-motion';\nimport Image from 'next/image';\nimport {\n    Character,\n    CharacterEmotion,\n    CharacterPosition,\n    CharacterAnimation,\n    POSITION_COORDS,\n    ANIMATION_DURATIONS,\n    EMOTION_VISUALS\n} from '@/lib/cinematic/character-types';\nimport { getCharacter } from '@/lib/cinematic/character-registry';\n\ninterface CharacterSpriteProps {\n    characterId: string;\n    position?: CharacterPosition;\n    emotion?: CharacterEmotion;\n    animation?: CharacterAnimation;\n    isSpeaking?: boolean;\n    size?: 'sm' | 'md' | 'lg' | 'xl';\n    showName?: boolean;\n    className?: string;\n}\n\nconst SIZE_CLASSES = {\n    sm: 'w-16 h-16',\n    md: 'w-24 h-24',\n    lg: 'w-32 h-32',\n    xl: 'w-48 h-48',\n};\n\nconst SIZE_PIXELS = {\n    sm: 64,\n    md: 96,\n    lg: 128,\n    xl: 192,\n} as const;\n\nconst spriteVariants: Variants = {\n    hidden: {\n        opacity: 0,\n        scale: 0.8,\n        y: 20\n    },\n    visible: {\n        opacity: 1,\n        scale: 1,\n        y: 0,\n        transition: {\n            type: 'spring',\n            stiffness: 200,\n            damping: 20\n        }\n    },\n    exit: {\n        opacity: 0,\n        scale: 0.9,\n        y: -10,\n        transition: {\n            duration: 0.3\n        }\n    },\n    speaking: {\n        scale: [1, 1.02, 1],\n        transition: {\n            repeat: Infinity,\n            duration: 0.8,\n        }\n    },\n    gesture: {\n        rotate: [0, -5, 5, -3, 3, 0],\n        transition: {\n            duration: 0.8,\n        }\n    },\n    celebrate: {\n        y: [0, -15, 0],\n        rotate: [0, -5, 5, 0],\n        scale: [1, 1.1, 1],\n        transition: {\n            duration: 0.6,\n            repeat: 2,\n        }\n    },\n    thinking: {\n        y: [0, -5, 0],\n        transition: {\n            repeat: Infinity,\n            duration: 2,\n            ease: 'easeInOut',\n        }\n    },\n};\n\nconst emotionGlowVariants: Variants = {\n    neutral: { boxShadow: 'none' },\n    happy: {\n        boxShadow: '0 0 20px 5px var(--state-success)',\n        transition: { duration: 0.3 }\n    },\n    concerned: {\n        boxShadow: '0 0 15px 3px var(--state-warning)',\n        transition: { duration: 0.3 }\n    },\n    urgent: {\n        boxShadow: [\n            '0 0 10px 2px var(--state-error)',\n            '0 0 25px 8px var(--state-error)',\n            '0 0 10px 2px var(--state-error)',\n        ],\n        transition: { repeat: Infinity, duration: 1.5 }\n    },\n    disappointed: { boxShadow: 'none' },\n    impressed: {\n        boxShadow: '0 0 20px 5px var(--brand-accent)',\n        transition: { duration: 0.3 }\n    },\n    suspicious: { boxShadow: 'none' },\n};\n\nexport function CharacterSprite({\n    characterId,\n    position = 'center',\n    emotion = 'neutral',\n    animation = 'idle',\n    isSpeaking = false,\n    size = 'lg',\n    showName = false,\n    className = '',\n}: CharacterSpriteProps) {\n    const character = getCharacter(characterId);\n    const positionStyle = POSITION_COORDS[position];\n    const emotionVisual = EMOTION_VISUALS[emotion];\n\n    // Determine which animation to play\n    const getAnimationState = () => {\n        if (animation === 'celebrate') return 'celebrate';\n        if (animation === 'thinking') return 'thinking';\n        if (animation === 'gesture') return 'gesture';\n        if (isSpeaking) return 'speaking';\n        return 'visible';\n    };\n\n    return (\n        <AnimatePresence mode=\"wait\">\n            <motion.div\n                key={`${characterId}-${position}`}\n                className={`relative flex flex-col items-center ${className}`}\n                initial=\"hidden\"\n                animate={getAnimationState()}\n                exit=\"exit\"\n                variants={spriteVariants}\n                style={{\n                    transform: position !== 'offscreen' ? undefined : 'translateX(-100%)',\n                }}\n            >\n                {/* Character Avatar Container */}\n                <motion.div\n                    className={`relative ${SIZE_CLASSES[size]} rounded-full overflow-hidden border-4 border-white/20`}\n                    style={{\n                        borderColor: character.colorAccent,\n                        backgroundColor: 'var(--bg-elevated)',\n                    }}\n                    variants={emotionGlowVariants}\n                    animate={emotion}\n                >\n                    {/* Character Image or Emoji Fallback */}\n                    {character.avatar ? (\n                        <Image\n                            src={character.avatar}\n                            alt={character.name}\n                            width={SIZE_PIXELS[size]}\n                            height={SIZE_PIXELS[size]}\n                            className=\"w-full h-full object-cover\"\n                        />\n                    ) : (\n                        <div className=\"w-full h-full flex items-center justify-center text-4xl bg-gradient-to-br from-white/10 to-transparent\">\n                            <span\n                                className=\"select-none\"\n                                style={{\n                                    fontSize: size === 'xl' ? '4rem' : size === 'lg' ? '3rem' : size === 'md' ? '2rem' : '1.5rem'\n                                }}\n                            >\n                                {character.emoji}\n                            </span>\n                        </div>\n                    )}\n\n                    {/* Emotion Indicator Overlay */}\n                    {emotion !== 'neutral' && emotionVisual.glowColor && (\n                        <motion.div\n                            className=\"absolute inset-0 rounded-full pointer-events-none\"\n                            initial={{ opacity: 0 }}\n                            animate={{ opacity: 0.2 }}\n                            style={{ backgroundColor: emotionVisual.glowColor }}\n                        />\n                    )}\n\n                    {/* Speaking Indicator */}\n                    {isSpeaking && (\n                        <motion.div\n                            className=\"absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-white\"\n                            animate={{\n                                scale: [1, 1.2, 1],\n                                opacity: [1, 0.7, 1],\n                            }}\n                            transition={{\n                                repeat: Infinity,\n                                duration: 0.5,\n                            }}\n                        />\n                    )}\n                </motion.div>\n\n                {/* Character Name */}\n                {showName && (\n                    <motion.div\n                        className=\"mt-2 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider\"\n                        style={{\n                            backgroundColor: `color-mix(in srgb, ${character.colorAccent} 20%, transparent)`,\n                            color: character.colorAccent,\n                        }}\n                        initial={{ opacity: 0, y: 5 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        transition={{ delay: 0.2 }}\n                    >\n                        {character.name}\n                    </motion.div>\n                )}\n\n                {/* Emotion Badge (for non-neutral emotions) */}\n                {emotion !== 'neutral' && (\n                    <motion.div\n                        className=\"absolute -top-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs\"\n                        style={{ backgroundColor: emotionVisual.glowColor || 'var(--bg-elevated)' }}\n                        initial={{ scale: 0 }}\n                        animate={{ scale: 1 }}\n                        transition={{ type: 'spring', stiffness: 400 }}\n                    >\n                        {emotion === 'happy' && 'üòä'}\n                        {emotion === 'concerned' && 'üòü'}\n                        {emotion === 'urgent' && '‚ö†Ô∏è'}\n                        {emotion === 'disappointed' && 'üòî'}\n                        {emotion === 'impressed' && 'üåü'}\n                        {emotion === 'suspicious' && 'ü§®'}\n                    </motion.div>\n                )}\n            </motion.div>\n        </AnimatePresence>\n    );\n}\n\nexport default CharacterSprite;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/CinematicProvider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":188,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":188,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[5994,6011],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Cinematic UI ‚Äî CinematicProvider\n * Context provider for managing active scenes, character interruptions, and cinematic state.\n */\n\nimport React, { createContext, useContext, useState, useCallback, ReactNode } from 'react';\nimport { Scene, SceneHistoryEntry } from '@/lib/cinematic/scene-types';\nimport { DialogueChoice } from '@/lib/cinematic/character-types';\nimport { SceneRenderer } from './SceneRenderer';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface CinematicContextValue {\n    // Scene controls\n    playScene: (scene: Scene) => void;\n    endScene: () => void;\n    isSceneActive: boolean;\n    activeScene: Scene | null;\n\n    // Character interrupts (quick messages that don't need full scenes)\n    showInterrupt: (characterId: string, message: string, emotion?: string) => void;\n    hideInterrupt: () => void;\n    interrupt: CharacterInterrupt | null;\n\n    // History\n    sceneHistory: SceneHistoryEntry[];\n\n    // Attention director\n    focusElement: (selector: string) => void;\n    clearFocus: () => void;\n    focusedElement: string | null;\n}\n\ninterface CharacterInterrupt {\n    characterId: string;\n    message: string;\n    emotion?: string;\n}\n\nconst CinematicContext = createContext<CinematicContextValue | null>(null);\n\n// ============================================================================\n// PROVIDER\n// ============================================================================\n\ninterface CinematicProviderProps {\n    children: ReactNode;\n    onSceneComplete?: (sceneId: string, decisions: Record<string, string>) => void;\n    onDecision?: (sceneId: string, nodeId: string, choice: DialogueChoice) => void;\n}\n\nexport function CinematicProvider({\n    children,\n    onSceneComplete,\n    onDecision,\n}: CinematicProviderProps) {\n    const [activeScene, setActiveScene] = useState<Scene | null>(null);\n    const [sceneHistory, setSceneHistory] = useState<SceneHistoryEntry[]>([]);\n    const [interrupt, setInterrupt] = useState<CharacterInterrupt | null>(null);\n    const [focusedElement, setFocusedElement] = useState<string | null>(null);\n    const [sceneStartTime, setSceneStartTime] = useState<number>(0);\n\n    // Play a scene\n    const playScene = useCallback((scene: Scene) => {\n        setActiveScene(scene);\n        setSceneStartTime(Date.now());\n    }, []);\n\n    // End current scene\n    const endScene = useCallback(() => {\n        setActiveScene(null);\n    }, []);\n\n    // Handle scene completion\n    const handleSceneComplete = useCallback((decisions: Record<string, string>) => {\n        if (!activeScene) return;\n\n        const entry: SceneHistoryEntry = {\n            sceneId: activeScene.id,\n            completedAt: new Date().toISOString(),\n            decisions,\n            duration: Date.now() - sceneStartTime,\n        };\n\n        setSceneHistory(prev => [...prev, entry]);\n        onSceneComplete?.(activeScene.id, decisions);\n        setActiveScene(null);\n    }, [activeScene, sceneStartTime, onSceneComplete]);\n\n    // Handle individual decisions\n    const handleDecision = useCallback((nodeId: string, choice: DialogueChoice) => {\n        if (!activeScene) return;\n        onDecision?.(activeScene.id, nodeId, choice);\n    }, [activeScene, onDecision]);\n\n    // Show character interrupt (quick pop-in message)\n    const showInterrupt = useCallback((characterId: string, message: string, emotion?: string) => {\n        setInterrupt({ characterId, message, emotion });\n\n        // Auto-hide after 5 seconds\n        setTimeout(() => {\n            setInterrupt(null);\n        }, 5000);\n    }, []);\n\n    const hideInterrupt = useCallback(() => {\n        setInterrupt(null);\n    }, []);\n\n    // Attention focus\n    const focusElement = useCallback((selector: string) => {\n        setFocusedElement(selector);\n\n        // Apply focus effect to DOM element\n        const el = document.querySelector(selector);\n        if (el) {\n            el.classList.add('cinematic-focus');\n            el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n        }\n    }, []);\n\n    const clearFocus = useCallback(() => {\n        if (focusedElement) {\n            const el = document.querySelector(focusedElement);\n            if (el) {\n                el.classList.remove('cinematic-focus');\n            }\n        }\n        setFocusedElement(null);\n    }, [focusedElement]);\n\n    const value: CinematicContextValue = {\n        playScene,\n        endScene,\n        isSceneActive: activeScene !== null,\n        activeScene,\n        showInterrupt,\n        hideInterrupt,\n        interrupt,\n        sceneHistory,\n        focusElement,\n        clearFocus,\n        focusedElement,\n    };\n\n    return (\n        <CinematicContext.Provider value={value}>\n            {children}\n\n            {/* Scene Overlay */}\n            {activeScene && (\n                <SceneRenderer\n                    scene={activeScene}\n                    onSceneComplete={handleSceneComplete}\n                    onDecision={handleDecision}\n                />\n            )}\n\n            {/* Interrupt Overlay */}\n            {interrupt && <InterruptOverlay interrupt={interrupt} onDismiss={hideInterrupt} />}\n\n            {/* Focus Dimming Overlay */}\n            {focusedElement && <FocusDimmer />}\n        </CinematicContext.Provider>\n    );\n}\n\n// ============================================================================\n// HOOK\n// ============================================================================\n\nexport function useCinematic() {\n    const context = useContext(CinematicContext);\n    if (!context) {\n        throw new Error('useCinematic must be used within a CinematicProvider');\n    }\n    return context;\n}\n\n// ============================================================================\n// SUB-COMPONENTS\n// ============================================================================\n\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { CharacterSprite } from './CharacterSprite';\nimport { getCharacter } from '@/lib/cinematic/character-registry';\nimport { BrightLayer } from '@/components/system';\nimport { CharacterEmotion } from '@/lib/cinematic';\n\nfunction InterruptOverlay({\n    interrupt,\n    onDismiss\n}: {\n    interrupt: CharacterInterrupt;\n    onDismiss: () => void;\n}) {\n    const character = getCharacter(interrupt.characterId);\n\n    return (\n        <motion.div\n            className=\"fixed bottom-6 right-6 z-[60] max-w-md cursor-pointer\"\n            initial={{ opacity: 0, x: 100, scale: 0.9 }}\n            animate={{ opacity: 1, x: 0, scale: 1 }}\n            exit={{ opacity: 0, x: 100, scale: 0.9 }}\n            transition={{ type: 'spring', stiffness: 300, damping: 25 }}\n            onClick={onDismiss}\n        >\n            <BrightLayer\n                variant=\"glass\"\n                padding=\"md\"\n                className=\"border-l-4 shadow-2xl\"\n                style={{ borderLeftColor: character.colorAccent } as React.CSSProperties}\n            >\n                <div className=\"flex gap-3 items-start\">\n                    <CharacterSprite\n                        characterId={interrupt.characterId}\n                        emotion={(interrupt.emotion as CharacterEmotion) || 'neutral'}\n                        size=\"sm\"\n                    />\n                    <div className=\"flex-1\">\n                        <p className=\"text-xs font-bold uppercase tracking-wider mb-1\" style={{ color: character.colorAccent }}>\n                            {character.name}\n                        </p>\n                        <p className=\"text-sm text-[var(--text-primary)]\">\n                            &ldquo;{interrupt.message}&rdquo;\n                        </p>\n                    </div>\n                    <button className=\"text-[var(--text-muted)] hover:text-[var(--text-primary)] text-lg\">\n                        √ó\n                    </button>\n                </div>\n            </BrightLayer>\n        </motion.div>\n    );\n}\n\nfunction FocusDimmer() {\n    return (\n        <motion.div\n            className=\"fixed inset-0 z-40 bg-black/50 pointer-events-none\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            transition={{ duration: 0.3 }}\n            style={{\n                // The focused element is excluded via CSS in globals.css\n                maskImage: 'var(--focus-mask, none)',\n                WebkitMaskImage: 'var(--focus-mask, none)',\n            }}\n        />\n    );\n}\n\nexport default CinematicProvider;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/DashboardAmbience.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/SceneRenderer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SceneAmbience' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SceneAmbience"},"fix":{"range":[308,327],"text":""},"desc":"Remove unused variable \"SceneAmbience\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DialogueNode' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogueNode"},"fix":{"range":[444,457],"text":""},"desc":"Remove unused variable \"DialogueNode\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CharacterEmotion' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CharacterEmotion"},"fix":{"range":[472,490],"text":""},"desc":"Remove unused variable \"CharacterEmotion\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isExiting' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":45,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'idx' is defined but never used. Allowed unused args must match /^_/u.","line":201,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":201,"endColumn":57}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Cinematic UI ‚Äî SceneRenderer Component\n * Full-screen scene composition with background, characters, and dialogue overlay.\n */\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n    Scene,\n    SceneState,\n    SceneAmbience,\n    BACKGROUND_ASSETS,\n    AMBIENCE_STYLES,\n    DEFAULT_TRANSITIONS\n} from '@/lib/cinematic/scene-types';\nimport { DialogueNode, DialogueChoice, CharacterEmotion } from '@/lib/cinematic/character-types';\nimport { CharacterSprite } from './CharacterSprite';\nimport { CharacterDialogue } from './CharacterDialogue';\n\ninterface SceneRendererProps {\n    scene: Scene;\n    onSceneComplete?: (decisions: Record<string, string>) => void;\n    onDecision?: (nodeId: string, choice: DialogueChoice) => void;\n    className?: string;\n}\n\nexport function SceneRenderer({\n    scene,\n    onSceneComplete,\n    onDecision,\n    className = '',\n}: SceneRendererProps) {\n    const [state, setState] = useState<SceneState>({\n        sceneId: scene.id,\n        isActive: true,\n        currentNodeId: scene.startNodeId,\n        visitedNodes: [scene.startNodeId],\n        characterStates: {},\n        startedAt: Date.now(),\n    });\n\n    const [decisions, setDecisions] = useState<Record<string, string>>({});\n    const [isExiting, setIsExiting] = useState(false);\n\n    // Get current dialogue node\n    const currentNode = scene.dialogue.find(n => n.id === state.currentNodeId);\n\n    // Initialize character states from scene config\n    useEffect(() => {\n        const initialStates: SceneState['characterStates'] = {};\n        scene.characters.forEach(char => {\n            initialStates[char.characterId] = {\n                emotion: char.initialEmotion,\n                position: char.initialPosition,\n                isSpeaking: false,\n            };\n        });\n        setState(prev => ({ ...prev, characterStates: initialStates }));\n    }, [scene]);\n\n    // Update speaking character when node changes\n    useEffect(() => {\n        if (!currentNode) return;\n\n        setState(prev => {\n            const newStates = { ...prev.characterStates };\n\n            // Stop all from speaking first\n            Object.keys(newStates).forEach(id => {\n                newStates[id] = { ...newStates[id], isSpeaking: false };\n            });\n\n            // Set current speaker\n            if (currentNode.characterId && newStates[currentNode.characterId]) {\n                newStates[currentNode.characterId] = {\n                    ...newStates[currentNode.characterId],\n                    isSpeaking: true,\n                    emotion: currentNode.emotion || newStates[currentNode.characterId].emotion,\n                };\n            }\n\n            return { ...prev, characterStates: newStates };\n        });\n    }, [currentNode]);\n\n    const completeScene = useCallback((finalDecisions: Record<string, string>) => {\n        setIsExiting(true);\n        setTimeout(() => {\n            onSceneComplete?.(finalDecisions);\n        }, DEFAULT_TRANSITIONS.exit.duration);\n    }, [onSceneComplete]);\n\n    // Handle choice selection\n    const handleChoiceSelect = useCallback((choice: DialogueChoice) => {\n        if (!currentNode) return;\n\n        const newDecisions = { ...decisions, [currentNode.id]: choice.id };\n        setDecisions(newDecisions);\n\n        onDecision?.(currentNode.id, choice);\n\n        // Navigate to next node\n        const nextNodeId = choice.nextNodeId || currentNode.nextNodeId;\n        if (nextNodeId) {\n            setState(prev => ({\n                ...prev,\n                currentNodeId: nextNodeId,\n                visitedNodes: [...prev.visitedNodes, nextNodeId],\n            }));\n        } else {\n            // Scene complete\n            completeScene(newDecisions);\n        }\n    }, [currentNode, decisions, onDecision, completeScene]);\n\n    // Handle dialogue completion (no choices, auto-advance)\n    const handleDialogueComplete = useCallback(() => {\n        if (!currentNode) return;\n\n        const nextNodeId = currentNode.nextNodeId;\n        if (nextNodeId) {\n            setState(prev => ({\n                ...prev,\n                currentNodeId: nextNodeId,\n                visitedNodes: [...prev.visitedNodes, nextNodeId],\n            }));\n        } else {\n            // Scene complete\n            completeScene(decisions);\n        }\n    }, [currentNode, decisions, completeScene]);\n\n    // Get background style\n    const bgAsset = BACKGROUND_ASSETS[scene.background];\n    const ambienceStyle = AMBIENCE_STYLES[scene.ambience];\n\n    return (\n        <AnimatePresence mode=\"wait\">\n            <motion.div\n                key={scene.id}\n                className={`fixed inset-0 z-50 flex flex-col ${className}`}\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                exit={{ opacity: 0 }}\n                transition={{ duration: DEFAULT_TRANSITIONS.enter.duration / 1000 }}\n            >\n                {/* Background Layer */}\n                <div\n                    className=\"absolute inset-0 bg-cover bg-center\"\n                    style={{\n                        backgroundColor: bgAsset.fallbackColor,\n                        // backgroundImage: `url(${bgAsset.dark})` // TODO: theme-aware\n                    }}\n                >\n                    {/* Gradient overlay for depth */}\n                    <div\n                        className=\"absolute inset-0\"\n                        style={{ background: 'linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.5) 100%)' }}\n                    />\n                </div>\n\n                {/* Ambience Overlay */}\n                <motion.div\n                    className=\"absolute inset-0 pointer-events-none\"\n                    style={{ background: ambienceStyle.overlayGradient }}\n                    animate={ambienceStyle.pulseSpeed ? {\n                        opacity: [0.5, 0.7, 0.5],\n                    } : undefined}\n                    transition={ambienceStyle.pulseSpeed ? {\n                        repeat: Infinity,\n                        duration: ambienceStyle.pulseSpeed / 1000,\n                    } : undefined}\n                />\n\n                {/* Vignette Effect */}\n                {ambienceStyle.vignetteIntensity > 0 && (\n                    <div\n                        className=\"absolute inset-0 pointer-events-none\"\n                        style={{\n                            background: `radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,${ambienceStyle.vignetteIntensity}) 100%)`,\n                        }}\n                    />\n                )}\n\n                {/* Screen Effect */}\n                {scene.screenEffect === 'blur-edges' && (\n                    <div className=\"absolute inset-0 pointer-events-none\" style={{\n                        backdropFilter: 'blur(2px)',\n                        WebkitBackdropFilter: 'blur(2px)',\n                        maskImage: 'radial-gradient(ellipse at center, transparent 60%, black 100%)',\n                        WebkitMaskImage: 'radial-gradient(ellipse at center, transparent 60%, black 100%)',\n                    }} />\n                )}\n\n                {/* Character Layer */}\n                <div className=\"flex-1 relative\">\n                    {/* Characters positioned across the scene */}\n                    <div className=\"absolute bottom-32 left-0 right-0 flex justify-between items-end px-12\">\n                        {scene.characters.map((char, idx) => {\n                            const charState = state.characterStates[char.characterId];\n                            if (!charState || charState.position === 'offscreen') return null;\n\n                            return (\n                                <motion.div\n                                    key={char.characterId}\n                                    className={`${charState.position === 'left' ? 'mr-auto' :\n                                            charState.position === 'right' ? 'ml-auto' :\n                                                'mx-auto'\n                                        }`}\n                                    initial={{\n                                        opacity: 0,\n                                        y: 50,\n                                        x: charState.position === 'left' ? -100 : charState.position === 'right' ? 100 : 0\n                                    }}\n                                    animate={{\n                                        opacity: 1,\n                                        y: 0,\n                                        x: 0\n                                    }}\n                                    transition={{\n                                        delay: (char.entranceDelay || 0) / 1000,\n                                        duration: 0.6,\n                                        type: 'spring',\n                                        stiffness: 100,\n                                    }}\n                                >\n                                    <CharacterSprite\n                                        characterId={char.characterId}\n                                        position={charState.position}\n                                        emotion={charState.emotion}\n                                        isSpeaking={charState.isSpeaking}\n                                        size=\"xl\"\n                                        showName={true}\n                                    />\n                                </motion.div>\n                            );\n                        })}\n                    </div>\n                </div>\n\n                {/* Dialogue Layer */}\n                <div className=\"relative z-10 p-6 pb-12\">\n                    <AnimatePresence mode=\"wait\">\n                        {currentNode && (\n                            <CharacterDialogue\n                                key={currentNode.id}\n                                node={currentNode}\n                                onChoiceSelect={handleChoiceSelect}\n                                onComplete={handleDialogueComplete}\n                                autoAdvance={!currentNode.choices || currentNode.choices.length === 0}\n                            />\n                        )}\n                    </AnimatePresence>\n                </div>\n\n                {/* Skip Scene Button (if allowed) */}\n                {scene.canSkip && (\n                    <button\n                        className=\"absolute top-6 right-6 px-4 py-2 rounded-lg bg-black/30 text-white/70 text-sm hover:bg-black/50 transition-colors\"\n                        onClick={() => completeScene(decisions)}\n                    >\n                        Skip Scene\n                    </button>\n                )}\n\n                {/* Scene Title Overlay (brief flash) */}\n                <SceneTitleOverlay name={scene.name} />\n            </motion.div>\n        </AnimatePresence>\n    );\n}\n\n// ============================================================================\n// SUB-COMPONENTS\n// ============================================================================\n\nfunction SceneTitleOverlay({ name }: { name: string }) {\n    const [visible, setVisible] = useState(true);\n\n    useEffect(() => {\n        const timer = setTimeout(() => setVisible(false), 2000);\n        return () => clearTimeout(timer);\n    }, []);\n\n    return (\n        <AnimatePresence>\n            {visible && (\n                <motion.div\n                    className=\"absolute inset-0 flex items-center justify-center pointer-events-none\"\n                    initial={{ opacity: 0 }}\n                    animate={{ opacity: 1 }}\n                    exit={{ opacity: 0 }}\n                    transition={{ duration: 0.5 }}\n                >\n                    <motion.h2\n                        className=\"text-4xl md:text-6xl font-black text-white/90 text-center tracking-tight\"\n                        style={{ textShadow: '0 4px 20px rgba(0,0,0,0.5)' }}\n                        initial={{ y: 20, opacity: 0 }}\n                        animate={{ y: 0, opacity: 1 }}\n                        exit={{ y: -20, opacity: 0 }}\n                        transition={{ delay: 0.2 }}\n                    >\n                        {name}\n                    </motion.h2>\n                </motion.div>\n            )}\n        </AnimatePresence>\n    );\n}\n\nexport default SceneRenderer;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/StatReactor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'displayValue' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":40,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * BrightEd Cinematic UI ‚Äî StatReactor Component\n * Wraps stat cards to add reactive animations based on value thresholds.\n */\n\nimport { useState, useEffect, useRef, ReactNode } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { CharacterSprite } from './CharacterSprite';\nimport { getCharacterForContext } from '@/lib/cinematic/character-registry';\n\ntype StatStatus = 'normal' | 'warning' | 'critical' | 'excellent';\n\ninterface StatReactorProps {\n    value: number;\n    previousValue?: number;\n    warningThreshold?: number;   // Below this = warning\n    criticalThreshold?: number;  // Below this = critical  \n    excellentThreshold?: number; // Above this = excellent (optional)\n    animateChanges?: boolean;\n    showCharacterWarning?: boolean;\n    warningContext?: 'loan_warning' | 'tax_deadline' | 'low_cash';\n    children: ReactNode;\n    className?: string;\n}\n\nexport function StatReactor({\n    value,\n    previousValue,\n    warningThreshold = 1000,\n    criticalThreshold = 500,\n    excellentThreshold,\n    animateChanges = true,\n    showCharacterWarning = false,\n    warningContext = 'low_cash',\n    children,\n    className = '',\n}: StatReactorProps) {\n    const [displayValue, setDisplayValue] = useState(value);\n    const [status, setStatus] = useState<StatStatus>('normal');\n    const [showCharacter, setShowCharacter] = useState(false);\n    const [isAnimating, setIsAnimating] = useState(false);\n    const prevValueRef = useRef(previousValue ?? value);\n\n    // Determine status based on value\n    useEffect(() => {\n        let newStatus: StatStatus = 'normal';\n        if (value <= criticalThreshold) {\n            newStatus = 'critical';\n        } else if (value <= warningThreshold) {\n            newStatus = 'warning';\n        } else if (excellentThreshold && value >= excellentThreshold) {\n            newStatus = 'excellent';\n        }\n        setStatus(newStatus);\n\n        // Show character warning on status change to critical/warning\n        if (showCharacterWarning && (newStatus === 'critical' || newStatus === 'warning')) {\n            setShowCharacter(true);\n            setTimeout(() => setShowCharacter(false), 4000);\n        }\n    }, [value, warningThreshold, criticalThreshold, excellentThreshold, showCharacterWarning]);\n\n    // Animate value changes\n    useEffect(() => {\n        if (!animateChanges) {\n            setDisplayValue(value);\n            return;\n        }\n\n        const prevVal = prevValueRef.current;\n        if (prevVal === value) return;\n\n        setIsAnimating(true);\n        const diff = value - prevVal;\n        const steps = 20;\n        const stepValue = diff / steps;\n        let current = prevVal;\n        let step = 0;\n\n        const interval = setInterval(() => {\n            step++;\n            current += stepValue;\n            setDisplayValue(Math.round(current));\n\n            if (step >= steps) {\n                clearInterval(interval);\n                setDisplayValue(value);\n                setIsAnimating(false);\n                prevValueRef.current = value;\n            }\n        }, 30);\n\n        return () => clearInterval(interval);\n    }, [value, animateChanges]);\n\n    // Status-based classes\n    const statusClasses: Record<StatStatus, string> = {\n        normal: '',\n        warning: 'stat-warning',\n        critical: 'stat-critical',\n        excellent: 'ring-2 ring-[var(--state-success)]',\n    };\n\n    return (\n        <div className={`relative ${className}`}>\n            {/* Main stat wrapper with status styling */}\n            <motion.div\n                className={`${statusClasses[status]} ${isAnimating ? 'stat-counting' : ''}`}\n                animate={status === 'critical' ? { scale: [1, 1.02, 1] } : {}}\n                transition={status === 'critical' ? { repeat: Infinity, duration: 1.5 } : {}}\n            >\n                {children}\n            </motion.div>\n\n            {/* Character peek-in warning */}\n            <AnimatePresence>\n                {showCharacter && (\n                    <motion.div\n                        className=\"absolute -right-2 -top-2 z-20\"\n                        initial={{ scale: 0, rotate: -20 }}\n                        animate={{ scale: 1, rotate: 0 }}\n                        exit={{ scale: 0, rotate: 20 }}\n                        transition={{ type: 'spring', stiffness: 300 }}\n                    >\n                        <CharacterSprite\n                            characterId={getCharacterForContext(warningContext)}\n                            emotion={status === 'critical' ? 'urgent' : 'concerned'}\n                            size=\"sm\"\n                        />\n                    </motion.div>\n                )}\n            </AnimatePresence>\n\n            {/* Value change indicator */}\n            <AnimatePresence>\n                {isAnimating && previousValue !== undefined && (\n                    <motion.div\n                        className={`absolute -top-3 right-2 text-xs font-bold ${value > previousValue ? 'text-[var(--state-success)]' : 'text-[var(--state-error)]'\n                            }`}\n                        initial={{ opacity: 0, y: 10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        exit={{ opacity: 0, y: -10 }}\n                    >\n                        {value > previousValue ? '+' : ''}{value - previousValue}\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </div>\n    );\n}\n\nexport default StatReactor;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/cinematic/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/landing/LandingDuolingo.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'user' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":9,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport Link from 'next/link';\nimport Image from 'next/image';\nimport { motion } from 'framer-motion';\nimport { useAuth } from '@/lib/auth-context';\n\nexport default function LandingDuolingo() {\n    const { user } = useAuth();\n\n    // Custom \"Chunky\" Button Styles to match reference\n    const primaryBtnClass = \"bg-[var(--brand-secondary)] hover:bg-[#4f46e5] text-white border-b-4 border-[#4338ca] active:border-b-0 active:translate-y-1 font-extrabold tracking-widest uppercase rounded-2xl px-10 py-4 text-base transition-all w-full sm:w-auto text-center cursor-pointer\";\n    const secondaryBtnClass = \"bg-[var(--bg-elevated)] hover:bg-[var(--bg-secondary)] text-[var(--brand-secondary)] border-2 border-[var(--border-subtle)] border-b-4 active:border-b-2 active:translate-y-[2px] font-extrabold tracking-widest uppercase rounded-2xl px-10 py-4 text-base transition-all w-full sm:w-auto text-center cursor-pointer\";\n\n    return (\n        <div className=\"min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] font-sans selection:bg-[var(--brand-secondary)] selection:text-white overflow-x-hidden transition-colors duration-300\">\n\n            {/* 1. Header */}\n            <header className=\"fixed top-0 left-0 right-0 z-50 bg-[var(--bg-primary)]/90 backdrop-blur-md border-b-[2px] border-[var(--border-subtle)] h-[70px] flex items-center justify-center px-4 transition-all\">\n                <div className=\"w-full max-w-[980px] flex items-center justify-between\">\n                    <Link href=\"/\" className=\"flex items-center gap-3 group\">\n                        <div className=\"w-10 h-10 relative transition-transform group-hover:scale-110\">\n                            {/* Using owl-happy as a small logo substitute or the actual logo if preferred, \n                        but reference uses mascot head. Let's use the static image if available or sprite. \n                        Using sprite for consistency. */}\n                            <div className=\"owl-sprite owl-happy\" style={{ transform: 'scale(0.25)', transformOrigin: 'top left', width: '150px', height: '150px', position: 'absolute', top: 0, left: 0, paddingLeft: '92px', paddingRight: '92px', paddingTop: 0, paddingBottom: 0, marginLeft: '25px', marginRight: '25px', marginTop: 0, marginBottom: 0 }} />\n                        </div>\n                        <span className=\"font-heading font-extrabold text-3xl text-[var(--brand-secondary)] tracking-tighter ml-8\">BrightEd</span>\n                    </Link>\n\n                    <div className=\"hidden sm:block text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 cursor-pointer transition-colors\">\n                        Site Language: English\n                    </div>\n                </div>\n            </header>\n\n            {/* 2. Hero Section */}\n            <section className=\"pt-[140px] pb-24 md:pt-[180px] md:pb-32 px-4 flex items-center justify-center bg-[url('/grid-pattern.svg')]\">\n                <div className=\"w-full max-w-[980px] flex flex-col lg:flex-row items-center gap-12 lg:gap-24\">\n\n                    {/* Hero Visual - Central Mascot */}\n                    <motion.div\n                        initial={{ opacity: 0, scale: 0.9 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        transition={{ duration: 0.5 }}\n                        className=\"relative w-[300px] h-[300px] md:w-[400px] md:h-[400px] flex-shrink-0\"\n                    >\n                        <div className=\"absolute inset-0 bg-[var(--brand-secondary)]/10 rounded-full blur-[60px] animate-pulse-slow\" />\n                        {/* Large Sprite Display */}\n                        <div className=\"owl-sprite owl-happy w-full h-full text-center align-middle\" style={{ transform: 'scale(2.5)', transformOrigin: 'center center', paddingTop: '78px', paddingBottom: '78px', width: '148px', marginTop: '147px', marginBottom: '147px', marginLeft: '142px', marginRight: '142px' }} />\n                    </motion.div>\n\n                    {/* Hero Content */}\n                    <div className=\"flex flex-col items-center lg:items-start text-center lg:text-left max-w-lg\">\n                        <h1 className=\"text-3xl sm:text-4xl md:text-5xl font-heading font-extrabold text-[var(--text-primary)] leading-tight mb-8\">\n                            The free, fun, and effective way to ace <span className=\"text-[var(--brand-secondary)]\">CSEC & CAPE</span>.\n                        </h1>\n\n                        <div className=\"flex flex-col gap-4 w-full sm:max-w-xs\">\n                            <Link href=\"/welcome\" className={primaryBtnClass}>\n                                Get Started\n                            </Link>\n                            <Link href=\"/login\" className={secondaryBtnClass}>\n                                I Already Have An Account\n                            </Link>\n                        </div>\n                    </div>\n                </div>\n            </section>\n\n            {/* 3. Feature Sections (Alternating) */}\n\n            {/* Feature 1: Free. Fun. Effective. */}\n            <section className=\"py-24 border-t-2 border-[var(--border-subtle)]\">\n                <div className=\"w-full max-w-[980px] mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center\">\n                    <div className=\"order-2 md:order-1\">\n                        <motion.div\n                            whileInView={{ rotate: [0, -5, 5, 0] }}\n                            viewport={{ once: true }}\n                            transition={{ duration: 0.5, delay: 0.2 }}\n                            className=\"flex justify-center\"\n                        >\n                            <div className=\"owl-sprite owl-smart\" style={{ transform: 'scale(1.8)' }} />\n                        </motion.div>\n                    </div>\n                    <div className=\"order-1 md:order-2 text-center md:text-left\">\n                        <h2 className=\"text-[var(--brand-secondary)] font-heading font-extrabold text-3xl md:text-5xl mb-6\">\n                            free. fun. effective.\n                        </h2>\n                        <p className=\"text-lg text-[var(--text-secondary)] font-medium leading-relaxed\">\n                            Learning with BrightEd is fun, and <span className=\"text-[var(--brand-secondary)] font-bold cursor-pointer underline decoration-2 underline-offset-4\">research shows that it works</span>! With quick, bite-sized simulations, you&apos;ll earn points and unlock new levels while gaining real-world skills.\n                        </p>\n                    </div>\n                </div>\n            </section>\n\n            {/* Feature 2: Backed by Science */}\n            <section className=\"py-24 border-t-2 border-[var(--border-subtle)]\">\n                <div className=\"w-full max-w-[980px] mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center\">\n                    <div className=\"order-1 text-center md:text-left\">\n                        <h2 className=\"text-[var(--brand-secondary)] font-heading font-extrabold text-3xl md:text-5xl mb-6\">\n                            backed by science.\n                        </h2>\n                        <p className=\"text-lg text-[var(--text-secondary)] font-medium leading-relaxed\">\n                            We use a combination of research-backed teaching methods and delightful content to create courses that effectively teach reading, writing, listening, and speaking skills!\n                        </p>\n                    </div>\n                    <div className=\"order-2\">\n                        <motion.div\n                            whileInView={{ y: [0, -10, 0] }}\n                            viewport={{ once: true }}\n                            transition={{ duration: 2, repeat: Infinity, ease: 'easeInOut' }}\n                            className=\"flex justify-center\"\n                        >\n                            <div className=\"owl-sprite owl-reading\" style={{ transform: 'scale(1.8)' }} />\n                        </motion.div>\n                    </div>\n                </div>\n            </section>\n\n            {/* Feature 3: Stay Motivated */}\n            <section className=\"py-24 border-t-2 border-[var(--border-subtle)]\">\n                <div className=\"w-full max-w-[980px] mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center\">\n                    <div className=\"order-2 md:order-1\">\n                        <motion.div\n                            whileInView={{ scale: [1, 1.1, 1] }}\n                            viewport={{ once: true }}\n                            transition={{ duration: 0.4 }}\n                            className=\"flex justify-center\"\n                        >\n                            <div className=\"owl-sprite owl-shocked\" style={{ transform: 'scale(1.8)' }} />\n                        </motion.div>\n                    </div>\n                    <div className=\"order-1 md:order-2 text-center md:text-left\">\n                        <h2 className=\"text-[var(--state-warning)] font-heading font-extrabold text-3xl md:text-5xl mb-6\">\n                            stay motivated.\n                        </h2>\n                        <p className=\"text-lg text-[var(--text-secondary)] font-medium leading-relaxed\">\n                            We make it easy to form a habit of learning with game-like features, fun challenges, and reminders from our friendly mascot, Professor Bright.\n                        </p>\n                    </div>\n                </div>\n            </section>\n\n            {/* Feature 4: Personalized Learning */}\n            <section className=\"py-24 border-t-2 border-[var(--border-subtle)]\">\n                <div className=\"w-full max-w-[980px] mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12 items-center\">\n                    <div className=\"order-1 text-center md:text-left\">\n                        <h2 className=\"text-[var(--brand-secondary)] font-heading font-extrabold text-3xl md:text-5xl mb-6\">\n                            personalized learning.\n                        </h2>\n                        <p className=\"text-lg text-[var(--text-secondary)] font-medium leading-relaxed\">\n                            Combining the best of AI and business science, lessons are tailored to help you learn at just the right level and pace.\n                        </p>\n                    </div>\n                    <div className=\"order-2\">\n                        <motion.div\n                            whileInView={{ x: [-5, 5, -5] }}\n                            viewport={{ once: true }}\n                            transition={{ duration: 2, repeat: Infinity }}\n                            className=\"flex justify-center\"\n                        >\n                            <div className=\"owl-sprite owl-studying\" style={{ transform: 'scale(1.8)' }} />\n                        </motion.div>\n                    </div>\n                </div>\n            </section>\n\n            {/* 4. Learn Anytime Section - Floating 3D style */}\n            <section className=\"relative py-32 overflow-hidden border-t-2 border-[var(--border-subtle)] flex justify-center items-center text-center px-4 min-h-[520px] md:min-h-[580px]\" style={{ background: 'linear-gradient(165deg, #E0F2FE 0%, #BAE6FD 35%, #F0F9FF 100%)' }}>\n                {/* Floating decorative elements - CSEC/CAPE themed */}\n                <div className=\"absolute inset-0 pointer-events-none\" aria-hidden>\n                    {/* Floating study cards (device-like) */}\n                    <motion.div className=\"absolute w-14 h-24 md:w-16 md:h-28 rounded-xl border-2 border-slate-300/80 shadow-lg bg-white/90 flex items-center justify-center\" style={{ top: '12%', left: '8%', transform: 'rotate(-12deg) perspective(400px) rotateY(-8deg)' }} animate={{ y: [0, -14, 0], rotate: [-12, -8, -12] }} transition={{ duration: 5, repeat: Infinity, ease: 'easeInOut' }}>\n                        <span className=\"text-[var(--brand-secondary)] font-bold text-lg\">M</span>\n                    </motion.div>\n                    <motion.div className=\"absolute w-14 h-24 md:w-16 md:h-28 rounded-xl border-2 border-slate-300/80 shadow-lg bg-white/90 flex items-center justify-center\" style={{ top: '55%', left: '5%', transform: 'rotate(6deg) perspective(400px) rotateY(10deg)' }} animate={{ y: [0, 12, 0], rotate: [6, 10, 6] }} transition={{ duration: 4.5, repeat: Infinity, ease: 'easeInOut', delay: 0.5 }}><span className=\"text-amber-600 font-bold text-lg\">‚òÖ</span></motion.div>\n                    <motion.div className=\"absolute w-14 h-24 md:w-16 md:h-28 rounded-xl border-2 border-slate-300/80 shadow-lg bg-white/90 flex items-center justify-center\" style={{ top: '18%', right: '10%', transform: 'rotate(10deg) perspective(400px) rotateY(6deg)' }} animate={{ y: [0, -10, 0], rotate: [10, 14, 10] }} transition={{ duration: 5.2, repeat: Infinity, ease: 'easeInOut', delay: 0.2 }}><span className=\"text-emerald-600 font-bold text-sm\">Bio</span></motion.div>\n                    <motion.div className=\"absolute w-14 h-24 md:w-16 md:h-28 rounded-xl border-2 border-slate-300/80 shadow-lg bg-white/90 flex items-center justify-center\" style={{ top: '62%', right: '7%', transform: 'rotate(-8deg) perspective(400px) rotateY(-6deg)' }} animate={{ y: [0, 8, 0], rotate: [-8, -4, -8] }} transition={{ duration: 4.8, repeat: Infinity, ease: 'easeInOut', delay: 0.8 }}><span className=\"text-rose-500 font-bold text-sm\">Chem</span></motion.div>\n                    <motion.div className=\"absolute w-12 h-20 rounded-lg border-2 border-slate-300/70 shadow-md bg-white/80 flex items-center justify-center\" style={{ bottom: '22%', left: '18%', transform: 'rotate(-5deg)' }} animate={{ y: [0, -8, 0] }} transition={{ duration: 4, repeat: Infinity, ease: 'easeInOut', delay: 1 }}><span className=\"text-[var(--brand-secondary)] font-extrabold text-xs\">œÄ</span></motion.div>\n                    <motion.div className=\"absolute w-12 h-20 rounded-lg border-2 border-slate-300/70 shadow-md bg-white/80 flex items-center justify-center\" style={{ bottom: '28%', right: '20%', transform: 'rotate(5deg)' }} animate={{ y: [0, 10, 0] }} transition={{ duration: 4.3, repeat: Infinity, ease: 'easeInOut', delay: 0.3 }}><span className=\"text-amber-500 font-bold text-sm\">üî•</span></motion.div>\n                    {/* 3D-style cubes */}\n                    <motion.div className=\"absolute w-10 h-10 md:w-12 md:h-12 rounded-lg shadow-md\" style={{ top: '25%', left: '22%', background: 'linear-gradient(135deg, #6366F1 0%, #818CF8 100%)', transform: 'rotate(15deg) rotateX(10deg)' }} animate={{ y: [0, -12, 0], rotate: [15, 20, 15] }} transition={{ duration: 5.5, repeat: Infinity, ease: 'easeInOut', delay: 0.4 }} />\n                    <motion.div className=\"absolute w-8 h-8 md:w-10 md:h-10 rounded-lg shadow-md\" style={{ top: '70%', right: '25%', background: 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%)', transform: 'rotate(-20deg)' }} animate={{ y: [0, 8, 0], rotate: [-20, -14, -20] }} transition={{ duration: 4.2, repeat: Infinity, ease: 'easeInOut', delay: 0.6 }} />\n                    <motion.div className=\"absolute w-8 h-8 rounded-lg shadow-md\" style={{ top: '8%', right: '28%', background: 'linear-gradient(135deg, #10B981 0%, #34D399 100%)', transform: 'rotate(25deg)' }} animate={{ y: [0, -6, 0], rotate: [25, 30, 25] }} transition={{ duration: 4.7, repeat: Infinity, ease: 'easeInOut' }} />\n                    <motion.div className=\"absolute w-7 h-7 rounded-md shadow\" style={{ bottom: '35%', left: '28%', background: 'linear-gradient(135deg, #EC4899 0%, #F472B6 100%)', transform: 'rotate(-15deg)' }} animate={{ y: [0, -5, 0] }} transition={{ duration: 3.8, repeat: Infinity, ease: 'easeInOut', delay: 0.7 }} />\n                    <motion.div className=\"absolute w-7 h-7 rounded-md shadow\" style={{ bottom: '18%', right: '32%', background: 'linear-gradient(135deg, #6366F1 0%, #A5B4FC 100%)', transform: 'rotate(18deg)' }} animate={{ y: [0, 6, 0] }} transition={{ duration: 4.4, repeat: Infinity, ease: 'easeInOut', delay: 0.25 }} />\n                    {/* Diamond shapes (rotated squares) */}\n                    <motion.div className=\"absolute w-6 h-6 md:w-8 md:h-8 bg-[var(--brand-secondary)]/80 shadow-sm\" style={{ top: '40%', left: '12%', transform: 'rotate(45deg)' }} animate={{ y: [0, -9, 0], scale: [1, 1.05, 1] }} transition={{ duration: 4.5, repeat: Infinity, ease: 'easeInOut', delay: 0.15 }} />\n                    <motion.div className=\"absolute w-5 h-5 md:w-6 md:h-6 bg-amber-400/90 shadow-sm\" style={{ top: '75%', right: '15%', transform: 'rotate(45deg)' }} animate={{ y: [0, 7, 0] }} transition={{ duration: 3.9, repeat: Infinity, ease: 'easeInOut', delay: 0.5 }} />\n                    <motion.div className=\"absolute w-5 h-5 bg-emerald-400/90 shadow-sm\" style={{ top: '15%', left: '30%', transform: 'rotate(45deg)' }} animate={{ y: [0, -7, 0] }} transition={{ duration: 4.1, repeat: Infinity, ease: 'easeInOut', delay: 0.35 }} />\n                    {/* Subject badges */}\n                    <motion.div className=\"absolute px-2.5 py-1 rounded-lg bg-white/95 border border-slate-200/90 shadow-md font-bold text-[10px] md:text-xs text-[var(--brand-secondary)] uppercase tracking-wide\" style={{ top: '48%', left: '6%', transform: 'rotate(-6deg)' }} animate={{ y: [0, -6, 0] }} transition={{ duration: 4.6, repeat: Infinity, ease: 'easeInOut', delay: 0.2 }}>CSEC</motion.div>\n                    <motion.div className=\"absolute px-2.5 py-1 rounded-lg bg-white/95 border border-slate-200/90 shadow-md font-bold text-[10px] md:text-xs text-[var(--brand-secondary)] uppercase tracking-wide\" style={{ bottom: '38%', right: '6%', transform: 'rotate(4deg)' }} animate={{ y: [0, 6, 0] }} transition={{ duration: 4.3, repeat: Infinity, ease: 'easeInOut', delay: 0.4 }}>CAPE</motion.div>\n                </div>\n\n                <div className=\"relative z-10 max-w-4xl\">\n                    <h2 className=\"text-navy-soft font-heading font-extrabold text-4xl sm:text-5xl md:text-6xl mb-12 drop-shadow-sm\">\n                        learn anytime, <span className=\"block mt-1 md:mt-2\">anywhere.</span>\n                    </h2>\n\n                    <div className=\"flex justify-center items-center\">\n                        <Link href=\"/welcome\" className={primaryBtnClass}>\n                            Get Started Today!\n                        </Link>\n                    </div>\n                </div>\n            </section>\n\n            {/* 5. Footer */}\n            <footer className=\"bg-[var(--brand-secondary)] text-white py-20 px-4\">\n                <div className=\"max-w-[980px] mx-auto text-center\">\n                    <div className=\"flex justify-center mb-8\">\n                        <Image src=\"/BrightEdLogo.png\" alt=\"BrightEd\" width={396} height={313} className=\"w-[396px] h-[313px] object-contain\" priority />\n                    </div>\n                    <div className=\"flex flex-wrap justify-center gap-6 md:gap-12 font-bold opacity-80 mb-12\">\n                        <a href=\"#\" className=\"hover:opacity-100\">About</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Schools</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Apps</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Research</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Careers</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Help</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Privacy</a>\n                        <a href=\"#\" className=\"hover:opacity-100\">Terms</a>\n                    </div>\n                    <div className=\"opacity-60 text-sm font-medium\">\n                        ¬© 2026 BrightEd Caribbean. Made with love for the future.\n                    </div>\n                </div>\n            </footer>\n\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/DailyTip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/ExplanationPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'question' is defined but never used. Allowed unused args must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'selectedAnswer' is defined but never used. Allowed unused args must match /^_/u.","line":18,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { motion } from 'framer-motion'\n\ninterface ExplanationPanelProps {\n  question: string\n  selectedAnswer: string\n  correctAnswer: string\n  explanation: string\n  isCorrect: boolean\n  relatedConcepts?: string[]\n  onContinue: () => void\n  onTryAgain?: () => void\n}\n\nexport default function ExplanationPanel({\n  question,\n  selectedAnswer,\n  correctAnswer,\n  explanation,\n  isCorrect,\n  relatedConcepts = [],\n  onContinue,\n  onTryAgain\n}: ExplanationPanelProps) {\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 50 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: 50 }}\n      className=\"w-full max-w-2xl mx-auto pb-24\"\n    >\n      {/* Result Status Banner */}\n      <motion.div\n        initial={{ scale: 0.9 }}\n        animate={{ scale: 1 }}\n        className={`rounded-3xl p-6 mb-6 text-center border-b-[6px] ${isCorrect\n            ? 'bg-[#d7ffb8] border-[#58cc02] text-[#58cc02]'\n            : 'bg-[#ffdfe0] border-[#ea2b2b] text-[#ea2b2b]'\n          }`}\n      >\n        <div className=\"text-6xl mb-4 animate-bounce-subtle\">\n          {isCorrect ? 'üéâ' : 'ü§î'}\n        </div>\n        <h2 className=\"text-3xl font-black mb-2\">\n          {isCorrect ? 'Correct!' : 'Not quite...'}\n        </h2>\n        {isCorrect && (\n          <p className=\"font-bold opacity-90 text-lg\">\n            XP +50 &nbsp;‚Ä¢&nbsp; Streak +1\n          </p>\n        )}\n      </motion.div>\n\n      {/* Explanation Card */}\n      <div className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-3xl p-6 md:p-8 shadow-sm\">\n        <h3 className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)] mb-4\">\n          Explanation\n        </h3>\n\n        <div className=\"mb-8 leading-relaxed font-medium text-lg\">\n          {explanation}\n        </div>\n\n        {/* Correct Answer Display (if wrong) */}\n        {!isCorrect && (\n          <div className=\"bg-[#f0f9ff] border-2 border-[#1cb0f6] rounded-2xl p-4 mb-6\">\n            <span className=\"text-xs font-black uppercase tracking-wider text-[#1cb0f6] block mb-1\">\n              Correct Answer\n            </span>\n            <span className=\"font-bold text-lg text-[var(--text-primary)]\">\n              {correctAnswer}\n            </span>\n          </div>\n        )}\n\n        {/* Related Concepts Chips */}\n        {relatedConcepts.length > 0 && (\n          <div className=\"flex flex-wrap gap-2\">\n            {relatedConcepts.map((concept, index) => (\n              <span\n                key={index}\n                className=\"px-3 py-1.5 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-secondary)] text-xs font-bold uppercase tracking-wide border border-[var(--border-subtle)]\"\n              >\n                {concept}\n              </span>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Action Area */}\n      <div className=\"mt-8 flex flex-col gap-3\">\n        <button\n          onClick={onContinue}\n          className={`\n            w-full py-4 rounded-2xl font-black text-white text-xl uppercase tracking-widest border-b-[6px] active:border-b-0 active:translate-y-[4px] transition-all shadow-xl\n            bg-[#58cc02] border-[#46a302] hover:bg-[#61e002]\n          `}\n        >\n          Continue\n        </button>\n\n        {!isCorrect && onTryAgain && (\n          <button\n            onClick={onTryAgain}\n            className=\"w-full py-4 rounded-2xl font-black text-[var(--text-secondary)] text-lg uppercase tracking-widest hover:bg-[var(--bg-secondary)] transition-all\"\n          >\n            Try Similar Question\n          </button>\n        )}\n      </div>\n    </motion.div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/GuidebookModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/LearningPathNode.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/LevelCompletionScreen.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'subject' is defined but never used. Allowed unused args must match /^_/u.","line":24,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onContinue' is defined but never used. Allowed unused args must match /^_/u.","line":33,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":13}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { motion } from 'framer-motion'\nimport Link from 'next/link'\nimport { useEffect, useState } from 'react'\n\ninterface LevelCompletionScreenProps {\n  levelName: string\n  subject: string\n  starsEarned: number\n  totalStars: number\n  streak: number\n  masteryPercentage: number\n  consistencyPercentage: number\n  xpGained: number\n  questionsAnswered: number\n  accuracy: number\n  onContinue: () => void\n  onRetry?: () => void\n}\n\nexport default function LevelCompletionScreen({\n  levelName,\n  subject,\n  starsEarned,\n  totalStars,\n  streak,\n  masteryPercentage,\n  consistencyPercentage,\n  xpGained,\n  questionsAnswered,\n  accuracy,\n  onContinue,\n  onRetry\n}: LevelCompletionScreenProps) {\n  const [animatedStars, setAnimatedStars] = useState(0)\n  const [animatedXP, setAnimatedXP] = useState(0)\n  const [animatedMastery, setAnimatedMastery] = useState(0)\n  const [animatedConsistency, setAnimatedConsistency] = useState(0)\n  const [showConfetti, setShowConfetti] = useState(false)\n\n  useEffect(() => {\n    // Animate values\n    const duration = 1500\n    const steps = 30\n    const interval = duration / steps\n\n    let step = 0\n    const timer = setInterval(() => {\n      step++\n      const progress = step / steps\n      const easeOut = 1 - Math.pow(1 - progress, 3)\n\n      setAnimatedStars(Math.min(Math.round(starsEarned * easeOut), starsEarned))\n      setAnimatedXP(Math.min(Math.round(xpGained * easeOut), xpGained))\n      setAnimatedMastery(Math.min(Math.round(masteryPercentage * easeOut), masteryPercentage))\n      setAnimatedConsistency(Math.min(Math.round(consistencyPercentage * easeOut), consistencyPercentage))\n\n      if (step >= steps) {\n        clearInterval(timer)\n        setShowConfetti(true)\n      }\n    }, interval)\n\n    return () => clearInterval(timer)\n  }, [starsEarned, xpGained, masteryPercentage, consistencyPercentage])\n\n  // Generate confetti particles\n  const confettiParticles = Array.from({ length: 50 }, (_, i) => ({\n    id: i,\n    x: Math.random() * 100,\n    delay: Math.random() * 2,\n    color: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#58CC02', '#1cb0f6'][Math.floor(Math.random() * 7)],\n    rotation: Math.random() * 360\n  }))\n\n  const isPerfect = starsEarned === totalStars && accuracy === 100\n  const isPassing = starsEarned >= 2\n\n  return (\n    <div className=\"min-h-screen bg-[var(--bg-primary)] flex flex-col items-center justify-center p-4 relative overflow-hidden\">\n      {/* Confetti Animation */}\n      {showConfetti && (\n        <div className=\"fixed inset-0 pointer-events-none z-50 overflow-hidden\">\n          {confettiParticles.map((particle) => (\n            <motion.div\n              key={particle.id}\n              initial={{ y: -20, x: `${particle.x}vw`, opacity: 1, rotate: 0 }}\n              animate={{ \n                y: '110vh', \n                opacity: 0,\n                rotate: particle.rotation\n              }}\n              transition={{ \n                duration: 3,\n                delay: particle.delay,\n                ease: 'linear'\n              }}\n              className=\"absolute top-0 w-3 h-3\"\n              style={{ backgroundColor: particle.color }}\n            />\n          ))}\n        </div>\n      )}\n\n      <motion.div\n        initial={{ opacity: 0, scale: 0.9 }}\n        animate={{ opacity: 1, scale: 1 }}\n        className=\"w-full max-w-lg text-center relative z-10\"\n      >\n        {/* Header */}\n        <motion.div\n          initial={{ y: -20, opacity: 0 }}\n          animate={{ y: 0, opacity: 1 }}\n          transition={{ delay: 0.2 }}\n        >\n          <h1 className={`text-4xl md:text-5xl font-black uppercase tracking-wider drop-shadow-sm mb-2 ${\n            isPerfect ? 'text-[#ffc800]' : isPassing ? 'text-[#58CC02]' : 'text-[#1cb0f6]'\n          }`}>\n            {isPerfect ? 'Perfect!' : isPassing ? 'Level Complete!' : 'Good Effort!'}\n          </h1>\n          <p className=\"text-[var(--text-secondary)] text-lg font-bold mb-8\">\n            {levelName}\n          </p>\n        </motion.div>\n\n        {/* Stars Display */}\n        <motion.div\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          transition={{ delay: 0.3, type: 'spring', stiffness: 200 }}\n          className=\"flex justify-center gap-2 mb-8\"\n        >\n          {Array.from({ length: totalStars }).map((_, i) => (\n            <motion.div\n              key={i}\n              initial={{ scale: 0, rotate: -180 }}\n              animate={{ \n                scale: i < animatedStars ? 1 : 0.8, \n                rotate: 0 \n              }}\n              transition={{ delay: 0.4 + i * 0.1, type: 'spring', stiffness: 200 }}\n              className={`text-5xl md:text-6xl ${i < animatedStars ? 'filter drop-shadow-lg' : 'opacity-30 grayscale'}`}\n            >\n              ‚≠ê\n            </motion.div>\n          ))}\n        </motion.div>\n\n        {/* Stats Grid */}\n        <div className=\"grid grid-cols-2 gap-4 mb-8\">\n          {/* XP Gained */}\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.5 }}\n            className=\"bg-[#ffc800] rounded-2xl p-5 border-b-4 border-[#e5a000]\"\n          >\n            <div className=\"text-white font-black text-xs uppercase tracking-widest mb-1\">XP Gained</div>\n            <div className=\"text-white font-black text-3xl\">+{animatedXP}</div>\n          </motion.div>\n\n          {/* Accuracy */}\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.6 }}\n            className=\"bg-[#1cb0f6] rounded-2xl p-5 border-b-4 border-[#1899d6]\"\n          >\n            <div className=\"text-white font-black text-xs uppercase tracking-widest mb-1\">Accuracy</div>\n            <div className=\"text-white font-black text-3xl\">{accuracy}%</div>\n          </motion.div>\n\n          {/* Streak */}\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.7 }}\n            className=\"bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl p-5 border-b-4 border-[#c2410c]\"\n          >\n            <div className=\"text-white font-black text-xs uppercase tracking-widest mb-1\">Current Streak</div>\n            <div className=\"text-white font-black text-3xl flex items-center justify-center gap-1\">\n              <span>üî•</span> {streak}\n            </div>\n          </motion.div>\n\n          {/* Mastery */}\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.8 }}\n            className=\"bg-gradient-to-br from-purple-500 to-indigo-500 rounded-2xl p-5 border-b-4 border-[#5b21b6]\"\n          >\n            <div className=\"text-white font-black text-xs uppercase tracking-widest mb-1\">Mastery</div>\n            <div className=\"text-white font-black text-3xl\">{animatedMastery}%</div>\n            <div className=\"w-full bg-black/20 rounded-full h-2 mt-2\">\n              <motion.div \n                initial={{ width: 0 }}\n                animate={{ width: `${animatedMastery}%` }}\n                transition={{ delay: 0.8, duration: 1 }}\n                className=\"h-full bg-white rounded-full\"\n              />\n            </div>\n          </motion.div>\n        </div>\n\n        {/* Consistency & Questions Row */}\n        <div className=\"grid grid-cols-2 gap-4 mb-8\">\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.9 }}\n            className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-4\"\n          >\n            <div className=\"text-[var(--text-muted)] font-black text-xs uppercase tracking-widest mb-1\">Consistency</div>\n            <div className=\"text-[var(--text-primary)] font-black text-2xl flex items-center gap-1\">\n              <span>üìÖ</span> {animatedConsistency}%\n            </div>\n            <p className=\"text-xs text-[var(--text-muted)] mt-1\">30-day activity</p>\n          </motion.div>\n\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 1.0 }}\n            className=\"bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] rounded-2xl p-4\"\n          >\n            <div className=\"text-[var(--text-muted)] font-black text-xs uppercase tracking-widest mb-1\">Questions</div>\n            <div className=\"text-[var(--text-primary)] font-black text-2xl flex items-center gap-1\">\n              <span>üìù</span> {questionsAnswered}\n            </div>\n            <p className=\"text-xs text-[var(--text-muted)] mt-1\">answered this session</p>\n          </motion.div>\n        </div>\n\n        {/* Mascot Message */}\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 1.1 }}\n          className=\"mb-8\"\n        >\n          <div className=\"w-32 h-32 mx-auto relative mb-4\">\n            <div className={`owl-sprite ${isPerfect ? 'owl-magic' : isPassing ? 'owl-happy' : 'owl-neutral'}`} \n                 style={{ transform: 'scale(1.5)', transformOrigin: 'center' }} />\n          </div>\n          <p className=\"text-xl font-bold text-[var(--text-secondary)]\">\n            {isPerfect \n              ? \"Hoo-ray! Perfect score! You're a master of this topic!\" \n              : isPassing \n                ? \"Great work! You're making excellent progress!\" \n                : \"Keep practicing! Every question makes you stronger!\"}\n          </p>\n        </motion.div>\n\n        {/* Actions */}\n        <motion.div\n          initial={{ y: 20, opacity: 0 }}\n          animate={{ y: 0, opacity: 1 }}\n          transition={{ delay: 1.2 }}\n          className=\"flex flex-col gap-3\"\n        >\n          <Link href=\"/learn?animation=unlock\" className=\"block w-full\">\n            <button className=\"w-full py-4 rounded-2xl bg-[#58CC02] border-b-4 border-[#46A302] text-white font-black text-xl uppercase tracking-widest hover:bg-[#46A302] transition-colors active:border-b-0 active:translate-y-[4px]\">\n              Continue Journey\n            </button>\n          </Link>\n          \n          {onRetry && (\n            <button \n              onClick={onRetry}\n              className=\"w-full py-4 rounded-2xl bg-[var(--bg-elevated)] border-2 border-[var(--border-subtle)] text-[var(--text-secondary)] font-black text-lg uppercase tracking-widest hover:bg-[var(--bg-primary)] transition-colors\"\n            >\n              Practice Again\n            </button>\n          )}\n        </motion.div>\n      </motion.div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/MascotIllustration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/PathConnector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[62,72],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useState"},"fix":{"range":[53,97],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { motion } from 'framer-motion'\nimport { useEffect, useState } from 'react'\n\ninterface PathConnectorProps {\n    fromIndex: number\n    isCompleted: boolean\n    isNext: boolean\n    fromOffset: number\n    toOffset: number\n}\n\nexport default function PathConnector({\n    fromIndex,\n    isCompleted,\n    isNext,\n    fromOffset,\n    toOffset\n}: PathConnectorProps) {\n    // Fixed constants for alignment\n    const width = 400;\n    const center = width / 2; // 200\n    const height = 140; // Increased height for better connection\n\n    // Calculate start and end X coordinates relative to the svg center\n    // The SVG is centered on the current node (offset handled by parent)\n    const diff = toOffset - fromOffset;\n    const startX = center;\n    const endX = center + diff;\n\n    // Bezier curve control points - adjusted for smoother S-curve\n    // We want a smooth S-curve that starts vertical and ends vertical\n    const cp1y = height * 0.3;\n    const cp2y = height * 0.7;\n\n    const pathData = `M ${startX} 0 \n                      C ${startX} ${cp1y}, \n                        ${endX} ${cp2y}, \n                        ${endX} ${height}`;\n\n    // Road surface gradient - use fromIndex for unique IDs to prevent duplicate SVG ID conflicts\n    const roadGradient = isCompleted\n        ? `url(#roadGradientCompleted-${fromIndex})`\n        : `url(#roadGradientDefault-${fromIndex})`;\n\n    return (\n        <div\n            className=\"absolute top-[60px] left-1/2 -translate-x-1/2 w-[400px] -z-10 pointer-events-none\"\n            style={{ height: `${height}px` }}\n        >\n            <svg\n                width={width}\n                height={height}\n                viewBox={`0 0 ${width} ${height}`}\n                fill=\"none\"\n                xmlns=\"http://www.w3.org/2000/svg\"\n                className=\"overflow-visible\"\n            >\n                <defs>\n                    <linearGradient id={`roadGradientDefault-${fromIndex}`} x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n                        <stop offset=\"0%\" stopColor=\"#94a3b8\" />\n                        <stop offset=\"50%\" stopColor=\"#cbd5e1\" />\n                        <stop offset=\"100%\" stopColor=\"#e2e8f0\" />\n                    </linearGradient>\n                    <linearGradient id={`roadGradientCompleted-${fromIndex}`} x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n                        <stop offset=\"0%\" stopColor=\"#58cc02\" />\n                        <stop offset=\"50%\" stopColor=\"#46a302\" />\n                        <stop offset=\"100%\" stopColor=\"#2d6a01\" />\n                    </linearGradient>\n                </defs>\n\n                {/* Glow effect for completed paths */}\n                {isCompleted && (\n                    <path\n                        d={pathData}\n                        stroke=\"rgba(88, 204, 2, 0.3)\"\n                        strokeWidth=\"24\"\n                        strokeLinecap=\"round\"\n                        fill=\"none\"\n                        filter=\"blur(4px)\"\n                    />\n                )}\n\n                {/* Outer Shadow/Path Border */}\n                <path\n                    d={pathData}\n                    stroke={isCompleted ? \"#1a4d00\" : \"#64748b\"}\n                    strokeWidth=\"18\"\n                    strokeLinecap=\"round\"\n                    fill=\"none\"\n                    opacity=\"0.4\"\n                />\n\n                {/* Main Surface */}\n                <path\n                    d={pathData}\n                    stroke={roadGradient}\n                    strokeWidth=\"14\"\n                    strokeLinecap=\"round\"\n                    fill=\"none\"\n                />\n\n                {/* Inner Highlight line */}\n                <path\n                    d={pathData}\n                    stroke=\"rgba(255,255,255,0.5)\"\n                    strokeWidth=\"3\"\n                    strokeLinecap=\"round\"\n                    fill=\"none\"\n                    transform=\"translate(0, -3)\"\n                />\n\n                {/* Bottom shadow line */}\n                <path\n                    d={pathData}\n                    stroke=\"rgba(0,0,0,0.1)\"\n                    strokeWidth=\"3\"\n                    strokeLinecap=\"round\"\n                    fill=\"none\"\n                    transform=\"translate(0, 3)\"\n                />\n\n                {/* Animation for next path */}\n                {isNext && !isCompleted && (\n                    <motion.path\n                        d={pathData}\n                        stroke=\"#ffffff\"\n                        strokeWidth=\"5\"\n                        strokeLinecap=\"round\"\n                        strokeDasharray=\"8 12\"\n                        fill=\"none\"\n                        initial={{ strokeDashoffset: 0 }}\n                        animate={{ strokeDashoffset: -40 }}\n                        transition={{ duration: 1.2, repeat: Infinity, ease: \"linear\" }}\n                        filter=\"drop-shadow(0 0 6px rgba(255,255,255,0.8))\"\n                    />\n                )}\n            </svg>\n        </div>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/ProfessorBrightMascot.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'webMode' is assigned a value but never used. Allowed unused args must match /^_/u.","line":14,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":66}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useEffect, useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { FeedbackResponse } from '@/lib/professor-bright'\n\ninterface ProfessorBrightMascotProps {\n    feedback: FeedbackResponse | null\n    webMode?: boolean\n    mini?: boolean\n    className?: string\n}\n\nexport default function ProfessorBrightMascot({ feedback, webMode = false, mini = false, className = '' }: ProfessorBrightMascotProps) {\n    const [isVisible, setIsVisible] = useState(false)\n\n    useEffect(() => {\n        if (feedback) {\n            setIsVisible(true)\n            if (!mini) {\n                const timer = setTimeout(() => {\n                    setIsVisible(false)\n                }, 3000)\n                return () => clearTimeout(timer)\n            }\n        }\n    }, [feedback, mini])\n\n    if (!feedback) return null;\n\n    if (mini) {\n        return (\n            <div className={`relative filter drop-shadow-xl ${className}`}>\n                <div\n                    className={`owl-sprite ${feedback.spriteClass} scale-75 md:scale-100`}\n                    style={{\n                        transformOrigin: 'bottom center'\n                    }}\n                />\n            </div>\n        )\n    }\n\n    return (\n        <AnimatePresence>\n            {isVisible && (\n                <motion.div\n                    initial={{ x: 300, opacity: 0 }}\n                    animate={{ x: 0, opacity: 1 }}\n                    exit={{ x: 300, opacity: 0 }}\n                    transition={{ type: 'spring', damping: 20, stiffness: 100 }}\n                    className={`fixed bottom-0 right-0 z-50 flex items-end p-4 md:p-8 pointer-events-none ${className}`}\n                >\n                    {/* Speech Bubble */}\n                    <div className=\"relative mr-4 mb-20 md:mb-24 w-64 md:w-80 pointer-events-auto\">\n                        <motion.div\n                            initial={{ scale: 0.8, opacity: 0, y: 20 }}\n                            animate={{ scale: 1, opacity: 1, y: 0 }}\n                            transition={{ delay: 0.2 }}\n                            className={`\n                p-6 rounded-2xl rounded-br-none shadow-2xl relative\n                ${feedback.tone === 'celebratory' ? 'bg-gradient-to-br from-yellow-400 to-amber-500 text-white' :\n                                    feedback.tone === 'challenging' ? 'bg-gradient-to-br from-purple-500 to-indigo-600 text-white' :\n                                        feedback.tone === 'supportive' ? 'bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white' :\n                                            'bg-white dark:bg-slate-800 text-slate-800 dark:text-white border-2 border-green-500'}\n              `}\n                        >\n                            {/* Header */}\n                            <div className=\"flex items-center gap-2 mb-2\">\n                                <span className=\"text-xl\">{feedback.emoji}</span>\n                                <h4 className=\"font-black uppercase text-xs tracking-widest opacity-90\">\n                                    {feedback.tone === 'celebratory' ? 'Brilliant!' :\n                                        feedback.tone === 'challenging' ? 'Challenge!' :\n                                            feedback.tone === 'supportive' ? 'Hint:' : 'Correct!'}\n                                </h4>\n                            </div>\n\n                            {/* Message */}\n                            <p className=\"text-sm md:text-base font-bold leading-relaxed mb-2\">\n                                {feedback.message}\n                            </p>\n\n                            {/* Tip (Optional) */}\n                            {feedback.tip && (\n                                <div className=\"mt-2 pt-2 border-t border-black/10 dark:border-white/10 text-xs font-medium opacity-80 flex gap-1\">\n                                    <span>üí°</span>\n                                    <span>{feedback.tip}</span>\n                                </div>\n                            )}\n\n                            {/* Arrow */}\n                            <div className=\"absolute -bottom-2 -right-2 w-6 h-6 bg-inherit transform rotate-45 skew-x-12\" />\n                        </motion.div>\n                    </div>\n\n                    {/* Large Sprite Mascot */}\n                    <div className=\"relative pointer-events-auto filter drop-shadow-2xl\">\n                        {/* Scale up the 150px sprite to be larger (e.g. 1.5x = 225px) */}\n                        <div\n                            className={`owl-sprite ${feedback.spriteClass}`}\n                            style={{\n                                transform: 'scale(1.5)',\n                                transformOrigin: 'bottom right'\n                            }}\n                        />\n                    </div>\n                </motion.div>\n            )}\n        </AnimatePresence>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/SectionHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/StreakCelebration.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/TopicMasteryDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/learning/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/lesson/DragDropQuestion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/lesson/FormulaBuilder.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/lesson/MathDiagram.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/lesson/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/premium/BCoinCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/providers/PostHogProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/science/LabProgress.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[224,227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[224,227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { motion } from 'framer-motion';\nimport { BIOLOGY_LABS } from '@/lib/science/biology-labs';\nimport { BrightHeading, BrightLayer } from '@/components/system';\n\ninterface LabProgressProps {\n    userData: any;\n}\n\nexport default function LabProgress({ userData }: LabProgressProps) {\n    const completedLabs = userData?.completedLabs || {};\n    const totalXP = Object.keys(completedLabs).reduce((sum, labId) => {\n        const lab = BIOLOGY_LABS.find(l => l.id === labId);\n        return sum + (lab?.xpReward || 0);\n    }, 0);\n\n    const completedCount = Object.keys(completedLabs).length;\n    const totalLabs = BIOLOGY_LABS.length;\n    const progressPercent = Math.round((completedCount / totalLabs) * 100);\n\n    return (\n        <div className=\"mb-12\">\n            <div className=\"flex items-end justify-between mb-6\">\n                <div>\n                    <BrightHeading level={2} className=\"text-3xl m-0\">Science Labs</BrightHeading>\n                    <p className=\"text-[var(--text-secondary)] mt-1\">Experimental portfolio status.</p>\n                </div>\n                <div className=\"text-right\">\n                    <div className=\"text-[10px] uppercase font-black tracking-widest text-[var(--text-muted)]\">Total Lab XP</div>\n                    <div className=\"text-3xl font-black text-amber-400\">\n                        {totalXP} XP\n                    </div>\n                </div>\n            </div>\n\n            <BrightLayer variant=\"glass\" padding=\"none\" className=\"p-6 md:p-8\">\n                {/* Progress Bar */}\n                <div className=\"flex items-center gap-4 mb-8\">\n                    <span className=\"text-xs font-black uppercase text-[var(--text-muted)]\">Completion</span>\n                    <div className=\"flex-1 h-3 bg-[var(--bg-secondary)] rounded-full overflow-hidden\">\n                        <motion.div\n                            initial={{ width: 0 }}\n                            animate={{ width: `${progressPercent}%` }}\n                            className=\"h-full bg-emerald-500\"\n                        />\n                    </div>\n                    <span className=\"text-xs font-black text-emerald-500\">{completedCount}/{totalLabs}</span>\n                </div>\n\n                {/* Lab Grid */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                    {BIOLOGY_LABS.map((lab) => {\n                        const isCompleted = !!completedLabs[lab.id];\n                        return (\n                            <div\n                                key={lab.id}\n                                className={`\n                                    relative p-4 rounded-2xl border-2 transition-all\n                                    ${isCompleted\n                                        ? 'bg-emerald-500/5 border-emerald-500/20 hover:bg-emerald-500/10'\n                                        : 'bg-[var(--bg-secondary)] border-[var(--border-subtle)] opacity-70'}\n                                `}\n                            >\n                                <div className=\"flex justify-between items-start mb-2\">\n                                    <span className=\"text-[10px] font-black uppercase tracking-widest text-[var(--brand-primary)] opacity-50\">\n                                        {lab.section}\n                                    </span>\n                                    {isCompleted && (\n                                        <span className=\"bg-emerald-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase\">\n                                            Done\n                                        </span>\n                                    )}\n                                </div>\n\n                                <h4 className={`font-bold mb-1 ${isCompleted ? 'text-white' : 'text-[var(--text-secondary)]'}`}>\n                                    {lab.title}\n                                </h4>\n\n                                <div className=\"flex items-center gap-2 mt-4\">\n                                    <span className=\"text-xs text-amber-400 font-black flex items-center gap-1\">\n                                        ‚ö° {lab.xpReward} XP\n                                    </span>\n                                </div>\n\n                                {/* Date completed */}\n                                {isCompleted && completedLabs[lab.id] && (\n                                    <div className=\"absolute bottom-4 right-4 text-[9px] text-[var(--text-muted)] uppercase tracking-widest\">\n                                        Verified\n                                    </div>\n                                )}\n                            </div>\n                        );\n                    })}\n                </div>\n            </BrightLayer>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/science/LabWorkbench.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useMemo' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useMemo"},"fix":{"range":[52,61],"text":""},"desc":"Remove unused variable \"useMemo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[93,110],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'successVariants' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"successVariants"},"fix":{"range":[411,432],"text":""},"desc":"Remove unused variable \"successVariants\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onComplete' is defined but never used. Allowed unused args must match /^_/u.","line":169,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":169,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'resetToIdle' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":179,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":179,"endColumn":71}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence, useAnimation } from 'framer-motion';\nimport {\n    DndContext,\n    DragEndEvent,\n    DragStartEvent,\n    DragOverlay,\n    useSensor,\n    useSensors,\n    PointerSensor,\n    TouchSensor,\n    useDraggable,\n    useDroppable\n} from '@dnd-kit/core';\nimport {\n    LabItem,\n    ReactionRule,\n    itemVariants,\n    successVariants,\n    shakeVariants,\n    createParticles,\n    Particle\n} from '@/lib/science/virtual-lab.types';\nimport ProfessorBright, { useProfessor } from './ProfessorBright';\n\n// ==========================================\n// DRAGGABLE ITEM COMPONENT\n// ==========================================\n\ninterface DraggableItemProps {\n    item: LabItem;\n    isOverlay?: boolean;\n}\n\nfunction DraggableItem({ item, isOverlay }: DraggableItemProps) {\n    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n        id: item.id,\n        disabled: !item.isDraggable\n    });\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            {...listeners}\n            {...attributes}\n            variants={itemVariants}\n            initial=\"hidden\"\n            animate={isDragging ? \"dragging\" : \"visible\"}\n            whileHover={item.isDraggable ? \"hover\" : undefined}\n            className={`\n        p-4 rounded-2xl cursor-grab active:cursor-grabbing\n        bg-[#1B1B2F]  border border-[#3D3D5C]\n        transition-all select-none\n        ${isDragging ? 'opacity-50' : ''}\n        ${item.isDraggable ? 'hover:bg-white/[0.08] hover:border-emerald-500/30' : 'opacity-60 cursor-not-allowed'}\n        ${isOverlay ? 'shadow-2xl shadow-emerald-500/20' : ''}\n      `}\n        >\n            <div className=\"flex items-center gap-3\">\n                <span className=\"text-2xl\">{item.icon}</span>\n                <div>\n                    <div className=\"text-sm font-black text-white\">{item.name}</div>\n                    <div className=\"text-[9px] font-bold text-zinc-500 uppercase tracking-widest\">\n                        {item.type} ‚Ä¢ {item.properties.state}\n                    </div>\n                </div>\n            </div>\n        </motion.div>\n    );\n}\n\n// ==========================================\n// DROPPABLE ZONE COMPONENT\n// ==========================================\n\ninterface DroppableZoneProps {\n    id: string;\n    item?: LabItem;\n    label?: string;\n    acceptTypes?: string[];\n    onDrop?: (itemId: string) => void;\n    className?: string;\n    children?: React.ReactNode;\n}\n\nfunction DroppableZone({ id, item, label, className, children }: DroppableZoneProps) {\n    const { isOver, setNodeRef } = useDroppable({ id });\n    const controls = useAnimation();\n\n    return (\n        <motion.div\n            ref={setNodeRef}\n            animate={controls}\n            className={`\n        relative rounded-3xl border-2 border-dashed transition-all duration-300\n        ${isOver\n                    ? 'border-emerald-500 bg-emerald-500/10 scale-[1.02]'\n                    : 'border-white/20 bg-[#131325]'\n                }\n        ${className}\n      `}\n        >\n            {label && !item && (\n                <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-600\">\n                        {label}\n                    </span>\n                </div>\n            )}\n            {children}\n        </motion.div>\n    );\n}\n\n// ==========================================\n// PARTICLE EFFECT COMPONENT\n// ==========================================\n\ninterface ParticleEffectProps {\n    particles: Particle[];\n}\n\nfunction ParticleEffect({ particles }: ParticleEffectProps) {\n    return (\n        <>\n            {particles.map((p) => (\n                <motion.div\n                    key={p.id}\n                    initial={{ x: p.x, y: p.y, scale: 1, opacity: 1 }}\n                    animate={{\n                        x: p.x + p.velocity.x,\n                        y: p.y + p.velocity.y,\n                        scale: 0,\n                        opacity: 0\n                    }}\n                    transition={{ duration: 0.8, ease: \"easeOut\" }}\n                    className=\"absolute pointer-events-none rounded-full\"\n                    style={{\n                        width: p.size,\n                        height: p.size,\n                        backgroundColor: p.color\n                    }}\n                />\n            ))}\n        </>\n    );\n}\n\n// ==========================================\n// MAIN LAB WORKBENCH COMPONENT\n// ==========================================\n\ninterface LabWorkbenchProps {\n    labTitle: string;\n    initialInventory: LabItem[];\n    reactionRules: ReactionRule[];\n    objectives: { id: string; description: string; completed: boolean }[];\n    onComplete?: () => void;\n    hints?: string[];\n}\n\nexport default function LabWorkbench({\n    labTitle,\n    initialInventory,\n    reactionRules,\n    objectives,\n    onComplete,\n    hints = []\n}: LabWorkbenchProps) {\n    const [inventory, setInventory] = useState<LabItem[]>(initialInventory);\n    const [workbenchItems, setWorkbenchItems] = useState<LabItem[]>([]);\n    const [activeItem, setActiveItem] = useState<LabItem | null>(null);\n    const [particles, setParticles] = useState<Particle[]>([]);\n    const [shake, setShake] = useState(false);\n    const [hintIndex, setHintIndex] = useState(0);\n\n    const { professor, showSuccess, showWarning, showHint, resetToIdle, recordInteraction } = useProfessor({\n        initialMessage: \"Welcome to the lab! Drag items from the shelf to the workbench.\"\n    });\n\n    const sensors = useSensors(\n        useSensor(PointerSensor, {\n            activationConstraint: { distance: 8 }\n        }),\n        useSensor(TouchSensor, {\n            activationConstraint: { delay: 200, tolerance: 8 }\n        })\n    );\n\n    // Find a matching reaction rule\n    const findReaction = useCallback((sourceId: string, targetId: string): ReactionRule | null => {\n        return reactionRules.find(\n            rule => rule.sourceId === sourceId && rule.targetId === targetId\n        ) || null;\n    }, [reactionRules]);\n\n    const handleDragStart = (event: DragStartEvent) => {\n        const item = inventory.find(i => i.id === event.active.id) ||\n            workbenchItems.find(i => i.id === event.active.id);\n        setActiveItem(item || null);\n        recordInteraction();\n    };\n\n    const handleDragEnd = (event: DragEndEvent) => {\n        const { active, over } = event;\n        setActiveItem(null);\n\n        if (!over) return;\n\n        const sourceItem = inventory.find(i => i.id === active.id) ||\n            workbenchItems.find(i => i.id === active.id);\n\n        if (!sourceItem) return;\n\n        // Dropping onto workbench\n        if (over.id === 'workbench' && !workbenchItems.find(i => i.id === sourceItem.id)) {\n            setInventory(prev => prev.filter(i => i.id !== sourceItem.id));\n            setWorkbenchItems(prev => [...prev, sourceItem]);\n            return;\n        }\n\n        // Check for reaction\n        const reaction = findReaction(sourceItem.id, over.id as string);\n\n        if (reaction) {\n            // SUCCESS! Apply reaction\n            const particleColor = reaction.result.particleColor || '#10B981';\n            const newParticles = createParticles(300, 200, 25, particleColor);\n            setParticles(newParticles);\n\n            // Clear particles after animation\n            setTimeout(() => setParticles([]), 1000);\n\n            // Update items based on reaction result\n            // (This would replace the target with the outcome)\n            showSuccess(reaction.result.professorComment);\n        } else if (over.id !== 'workbench' && over.id !== 'shelf') {\n            // Invalid combination\n            setShake(true);\n            setTimeout(() => setShake(false), 400);\n\n            const failRule = reactionRules.find(r => r.sourceId === sourceItem.id)?.failResult;\n            if (failRule) {\n                showWarning(failRule.professorComment);\n            }\n        }\n    };\n\n    const handleHintRequest = () => {\n        if (hints.length > 0) {\n            showHint(hints[hintIndex % hints.length]);\n            setHintIndex(prev => prev + 1);\n        }\n    };\n\n    return (\n        <DndContext\n            sensors={sensors}\n            onDragStart={handleDragStart}\n            onDragEnd={handleDragEnd}\n        >\n            <div className=\"fixed inset-0 bg-[#050A12] overflow-hidden\">\n                {/* Lab Bench Background */}\n                <div className=\"absolute inset-0\">\n                    {/* Grid pattern */}\n                    <div\n                        className=\"absolute inset-0 opacity-[0.03]\"\n                        style={{\n                            backgroundImage: `\n                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),\n                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)\n              `,\n                            backgroundSize: '50px 50px'\n                        }}\n                    />\n                    {/* Ambient glow */}\n                    <div className=\"absolute top-0 left-1/4 w-1/2 h-1/3 bg-emerald-500/5 blur-[150px] rounded-full\" />\n                    <div className=\"absolute bottom-0 right-1/4 w-1/3 h-1/4 bg-blue-500/5 blur-[120px] rounded-full\" />\n                </div>\n\n                {/* Header */}\n                <header className=\"relative z-20 h-16 bg-[#131325]  border-b border-[#3D3D5C] flex items-center justify-between px-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <a href=\"/practicals/science/biology\" className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\">\n                            ‚Üê Exit Lab\n                        </a>\n                        <div className=\"h-6 w-px bg-white/10\" />\n                        <div className=\"text-sm font-black tracking-tight text-white\">{labTitle}</div>\n                    </div>\n                    <div className=\"flex items-center gap-3 bg-black/30 px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                        <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\n                        <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                            Lab Active\n                        </span>\n                    </div>\n                </header>\n\n                <div className=\"relative z-10 flex h-[calc(100vh-4rem)]\">\n                    {/* Left Sidebar: The Shelf */}\n                    <aside className=\"w-72 bg-[#131325]  border-r border-[#3D3D5C] p-6 overflow-y-auto\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Equipment Shelf\n                        </div>\n                        <div className=\"space-y-3\">\n                            {inventory.map((item) => (\n                                <DraggableItem key={item.id} item={item} />\n                            ))}\n                        </div>\n                    </aside>\n\n                    {/* Center: The Workbench (Main Drop Zone) */}\n                    <main className=\"flex-1 p-8 relative\">\n                        <motion.div\n                            animate={shake ? \"shake\" : undefined}\n                            variants={shakeVariants}\n                        >\n                            <DroppableZone\n                                id=\"workbench\"\n                                label=\"Drop items here to work\"\n                                className=\"h-full min-h-[400px] p-6\"\n                            >\n                                <div className=\"text-[9px] font-black uppercase tracking-widest text-zinc-600 mb-6\">\n                                    Workbench\n                                </div>\n                                <div className=\"grid grid-cols-3 gap-4\">\n                                    {workbenchItems.map((item) => (\n                                        <DraggableItem key={item.id} item={item} />\n                                    ))}\n                                </div>\n                            </DroppableZone>\n                        </motion.div>\n\n                        {/* Particle Effects */}\n                        <ParticleEffect particles={particles} />\n                    </main>\n\n                    {/* Right Sidebar: The Notebook */}\n                    <aside className=\"w-80 bg-[#131325]  border-l border-[#3D3D5C] p-6 overflow-y-auto\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">\n                            Lab Notebook\n                        </div>\n\n                        {/* Objectives */}\n                        <div className=\"space-y-3\">\n                            {objectives.map((obj, i) => (\n                                <div\n                                    key={obj.id}\n                                    className={`p-4 rounded-2xl border transition-all ${obj.completed\n                                            ? 'bg-emerald-500/10 border-emerald-500/30'\n                                            : 'bg-[#131325] border-[#3D3D5C]'\n                                        }`}\n                                >\n                                    <div className=\"flex items-start gap-3\">\n                                        <div className={`mt-0.5 w-5 h-5 rounded-full border-2 flex items-center justify-center text-xs ${obj.completed\n                                                ? 'bg-emerald-500 border-emerald-500 text-white'\n                                                : 'border-zinc-600'\n                                            }`}>\n                                            {obj.completed ? '‚úì' : i + 1}\n                                        </div>\n                                        <p className={`text-xs font-medium ${obj.completed ? 'text-emerald-400' : 'text-zinc-400'\n                                            }`}>\n                                            {obj.description}\n                                        </p>\n                                    </div>\n                                </div>\n                            ))}\n                        </div>\n                    </aside>\n                </div>\n\n                {/* Drag Overlay */}\n                <DragOverlay>\n                    {activeItem ? (\n                        <DraggableItem item={activeItem} isOverlay />\n                    ) : null}\n                </DragOverlay>\n\n                {/* Professor Bright */}\n                <ProfessorBright\n                    state={professor}\n                    onHintRequest={handleHintRequest}\n                />\n            </div>\n        </DndContext>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/science/ProfessorBright.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/science/ScienceLabLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[67,97],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[163,175],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightHeading' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":36,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightHeading"},"fix":{"range":[154,220],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'showInventory' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":29,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setShowInventory' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":29,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":43}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { BrightLayer, BrightHeading } from '@/components/system';\n\ninterface ScienceLabLayoutProps {\n    children: React.ReactNode;\n    labTitle: string;\n    syllabusSection: string;\n    objectives: string[];\n    equipment: { name: string; icon: string }[];\n    currentStep: number;\n    totalSteps: number;\n    onExit?: () => void;\n}\n\nexport default function ScienceLabLayout({\n    children,\n    labTitle,\n    syllabusSection,\n    objectives,\n    equipment,\n    currentStep,\n    totalSteps,\n    onExit\n}: ScienceLabLayoutProps) {\n    const [showInventory, setShowInventory] = useState(false);\n    const [showReport, setShowReport] = useState(false);\n    const [isMounted, setIsMounted] = useState(false);\n\n    useEffect(() => {\n        setIsMounted(true);\n    }, []);\n\n    return (\n        <div className=\"fixed inset-0 bg-[#0A0F18] text-white overflow-hidden flex flex-col z-[100]\">\n            {/* Immersive Background */}\n            <div className=\"absolute inset-0 pointer-events-none opacity-20\">\n                <div className=\"absolute top-0 right-0 w-1/2 h-1/2 bg-emerald-500/10 blur-[150px] rounded-full\" />\n                <div className=\"absolute bottom-0 left-0 w-1/3 h-1/3 bg-blue-500/10 blur-[130px] rounded-full\" />\n            </div>\n\n            {/* Laboratory Header */}\n            <header className=\"relative z-20 h-16 bg-white/[0.03]  border-b border-[#3D3D5C] flex items-center justify-between px-6\">\n                <div className=\"flex items-center gap-6\">\n                    <button\n                        onClick={() => onExit ? onExit() : window.history.back()}\n                        className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400 hover:text-white transition-colors\"\n                    >\n                        ‚Üê Terminate Session\n                    </button>\n                    <div className=\"h-6 w-px bg-white/10\" />\n                    <div className=\"flex flex-col\">\n                        <div className=\"text-[10px] font-black uppercase tracking-widest text-emerald-500 opacity-80\">{syllabusSection}</div>\n                        <div className=\"text-sm font-black tracking-tight\">{labTitle}</div>\n                    </div>\n                </div>\n\n                <div className=\"flex items-center gap-4\">\n                    <div className=\"flex items-center gap-2 bg-black/40 px-4 py-1.5 rounded-full border border-[#3D3D5C]\">\n                        <div className=\"w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse\" />\n                        <span className=\"text-[10px] font-black uppercase tracking-[0.2em] text-zinc-300\">\n                            System Stable ‚Ä¢ {currentStep}/{totalSteps}\n                        </span>\n                    </div>\n                    <button\n                        onClick={() => setShowReport(!showReport)}\n                        className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${showReport ? 'bg-emerald-500 text-white' : 'bg-white/5 text-zinc-400 hover:bg-white/10 border border-[#3D3D5C]'\n                            }`}\n                    >\n                        Notebook\n                    </button>\n                </div>\n            </header>\n\n            <div className=\"flex-1 flex overflow-hidden relative z-10\">\n                {/* Left Toolbar: Equipment & Inventory */}\n                <aside className=\"w-64 border-r border-[#3D3D5C] bg-black/20 -sm flex flex-col p-6\">\n                    <div className=\"mb-10\">\n                        <h3 className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6\">Equipment Room</h3>\n                        <div className=\"space-y-3\">\n                            {equipment.map((item, i) => (\n                                <div\n                                    key={i}\n                                    className=\"group flex items-center gap-4 p-3 rounded-2xl bg-white/[0.03] border border-white/5 hover:border-emerald-500/30 hover:bg-emerald-500/5 transition-all cursor-crosshair\"\n                                >\n                                    <span className=\"text-xl group-hover:scale-110 transition-transform\">{item.icon}</span>\n                                    <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-300 group-hover:text-white\">{item.name}</span>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n\n                    <div className=\"mt-auto\">\n                        <div className=\"p-4 rounded-3xl bg-emerald-500/5 border border-emerald-500/20\">\n                            <div className=\"text-[9px] font-black uppercase tracking-widest text-emerald-500 mb-2\">Safety Protocol</div>\n                            <p className=\"text-[9px] font-bold text-zinc-400 uppercase tracking-widest leading-relaxed\">\n                                Ensure all virtual specimen are handled with the proper laboratory tools.\n                            </p>\n                        </div>\n                    </div>\n                </aside>\n\n                {/* Main Experimentation Area */}\n                <main className=\"flex-1 relative overflow-hidden bg-[radial-gradient(circle_at_center,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:40px_40px]\">\n                    {children}\n                </main>\n\n                {/* Right Sidebar: Objectives & Checklist */}\n                <aside className=\"w-80 border-l border-[#3D3D5C] bg-black/20 -sm p-6 flex flex-col gap-6 overflow-y-auto\">\n                    <div>\n                        <h3 className=\"text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-4\">Scientific Aim</h3>\n                        <div className=\"space-y-4\">\n                            {objectives.map((obj, i) => (\n                                <div key={i} className=\"flex gap-4 group\">\n                                    <div className={`mt-1.5 w-1.5 h-1.5 rounded-full shrink-0 transition-all ${i < currentStep ? 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]' : 'bg-zinc-700'\n                                        }`} />\n                                    <p className={`text-[11px] font-medium leading-relaxed transition-colors ${i < currentStep ? 'text-zinc-400 line-through' : 'text-zinc-200'\n                                        }`}>\n                                        {obj}\n                                    </p>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n\n                    {/* Quick Stats / Environment Monitor */}\n                    <div className=\"mt-auto space-y-4\">\n                        <div className=\"p-5 rounded-[2rem] bg-[#131325] border border-[#3D3D5C] space-y-4\">\n                            <div className=\"flex justify-between items-center\">\n                                <span className=\"text-[9px] font-black uppercase tracking-widest text-zinc-500\">Stability</span>\n                                <span className=\"text-[10px] font-black text-emerald-400\">100%</span>\n                            </div>\n                            <div className=\"h-1 bg-zinc-800 rounded-full overflow-hidden\">\n                                <motion.div\n                                    initial={{ width: 0 }}\n                                    animate={{ width: '100%' }}\n                                    className=\"h-full bg-emerald-500\"\n                                />\n                            </div>\n                        </div>\n                    </div>\n                </aside>\n            </div>\n\n            {/* Lab Notebook Overlay */}\n            <AnimatePresence>\n                {showReport && (\n                    <motion.div\n                        initial={{ opacity: 0, scale: 0.95 }}\n                        animate={{ opacity: 1, scale: 1 }}\n                        exit={{ opacity: 0, scale: 0.95 }}\n                        className=\"absolute inset-x-0 bottom-0 top-16 z-50 p-8 flex items-center justify-center bg-black/60 \"\n                    >\n                        <div className=\"w-full max-w-4xl h-full max-h-[800px] bg-[#fdfdfd] text-zinc-900 rounded-[2.5rem] shadow-2xl p-12 overflow-y-auto relative border-[12px] border-white/20\">\n                            <button\n                                onClick={() => setShowReport(false)}\n                                className=\"absolute top-8 right-8 w-10 h-10 rounded-full bg-zinc-100 flex items-center justify-center text-xl hover:bg-zinc-200 transition-colors\"\n                            >\n                                ‚úï\n                            </button>\n\n                            <div className=\"border-b-2 border-zinc-200 pb-8 mb-8\">\n                                <div className=\"text-[10px] font-black uppercase tracking-widest text-emerald-600 mb-2\">School-Based Assessment (SBA)</div>\n                                <h1 className=\"text-4xl font-serif font-bold italic tracking-tight\">{labTitle}</h1>\n                                <div className=\"mt-4 flex gap-6 text-[10px] font-black uppercase tracking-widest text-zinc-400\">\n                                    <span>Subject: Biology</span>\n                                    <span>Date: {isMounted ? new Date().toLocaleDateString() : '--/--/--'}</span>\n                                </div>\n                            </div>\n\n                            <div className=\"space-y-10 font-serif\">\n                                <section>\n                                    <h2 className=\"text-sm font-black uppercase tracking-widest text-zinc-900 mb-4 border-b border-zinc-100 pb-2\">Apparatus & Materials</h2>\n                                    <ul className=\"grid grid-cols-2 gap-4\">\n                                        {equipment.map((e, i) => (\n                                            <li key={i} className=\"flex items-center gap-3 text-sm text-zinc-500\">\n                                                <span className=\"text-emerald-500\">‚úì</span> {e.name}\n                                            </li>\n                                        ))}\n                                    </ul>\n                                </section>\n\n                                <section>\n                                    <h2 className=\"text-sm font-black uppercase tracking-widest text-zinc-900 mb-4 border-b border-zinc-100 pb-2\">Method / Procedure</h2>\n                                    <p className=\"text-sm text-zinc-500 italic leading-relaxed\">\n                                        Procedure is automatically generated based on the virtual session actions.\n                                    </p>\n                                </section>\n\n                                <section>\n                                    <h2 className=\"text-sm font-black uppercase tracking-widest text-zinc-900 mb-4 border-b border-zinc-100 pb-2\">Results & Observations</h2>\n                                    <div className=\"p-10 rounded-3xl bg-zinc-50 border-2 border-dashed border-zinc-200 text-center\">\n                                        <p className=\"text-xs font-black uppercase tracking-widest text-zinc-400\">Complete the virtual experiment to generate results</p>\n                                    </div>\n                                </section>\n                            </div>\n                        </div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/DecisionCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/DuoActionBar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[79,89],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useState"},"fix":{"range":[70,114],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { useEffect, useState } from 'react'\n\ninterface DuoActionBarProps {\n    status: 'idle' | 'selected' | 'correct' | 'wrong' | 'continue'\n    onCheck: () => void\n    onContinue: () => void\n    feedbackMessage?: string\n    feedbackTitle?: string\n}\n\nexport function DuoActionBar({\n    status,\n    onCheck,\n    onContinue,\n    feedbackMessage,\n    feedbackTitle\n}: DuoActionBarProps) {\n    const isFeedback = status === 'correct' || status === 'wrong'\n\n    // Derived styles based on status\n    const containerBg = status === 'correct' ? 'bg-[#d7ffb8]' : status === 'wrong' ? 'bg-[#ffdfe0]' : 'bg-[var(--bg-elevated)]'\n    const borderColor = status === 'correct' ? 'border-[#b8f28b]' : status === 'wrong' ? 'border-[#ffc1c1]' : 'border-[var(--border-subtle)]'\n    const textColor = status === 'correct' ? 'text-[#58cc02]' : status === 'wrong' ? 'text-[#ea2b2b]' : 'text-[var(--text-primary)]'\n\n    return (\n        <AnimatePresence mode=\"wait\">\n            <motion.div\n                key={status}\n                initial={{ y: 100 }}\n                animate={{ y: 0 }}\n                exit={{ y: 100 }}\n                transition={{ type: 'spring', stiffness: 300, damping: 30 }}\n                className={`fixed bottom-0 left-0 right-0 border-t-2 ${containerBg} ${borderColor} pb-6 pt-4 md:pb-8 md:pt-6 px-4 z-50`}\n            >\n                <div className=\"max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4 md:gap-8\">\n\n                    {/* Feedback Text section */}\n                    <div className=\"flex-1 w-full md:w-auto\">\n                        {isFeedback ? (\n                            <div className=\"flex items-center gap-4\">\n                                <div className={`\n                                    w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-white shadow-sm shrink-0\n                                    ${status === 'correct' ? 'text-[#58cc02]' : 'text-[#ea2b2b]'}\n                                `}>\n                                    {status === 'correct' ? '‚úì' : '‚úó'}\n                                </div>\n                                <div>\n                                    <h3 className={`text-xl md:text-2xl font-black ${textColor} mb-1`}>\n                                        {feedbackTitle || (status === 'correct' ? 'Excellent!' : 'Correct solution:')}\n                                    </h3>\n                                    {feedbackMessage && (\n                                        <p className={`${status === 'correct' ? 'text-[#58cc02]/80' : 'text-[#ea2b2b]/80'} font-medium`}>\n                                            {feedbackMessage}\n                                        </p>\n                                    )}\n                                </div>\n                            </div>\n                        ) : (\n                            <div className=\"hidden md:block\">\n                                <button className=\"px-6 py-3 rounded-2xl font-bold text-[var(--text-muted)] border-2 border-[var(--border-subtle)] hover:bg-[var(--bg-secondary)] hover:border-[var(--border-strong)] transition-all uppercase tracking-wider text-sm\">\n                                    Skip\n                                </button>\n                            </div>\n                        )}\n                    </div>\n\n                    {/* Action Button */}\n                    <div className=\"w-full md:w-auto\">\n                        {(isFeedback || status === 'continue') ? (\n                            <button\n                                onClick={onContinue}\n                                className={`\n                                    w-full md:min-w-[200px] h-14 rounded-2xl font-black text-white text-lg uppercase tracking-widest border-b-[4px] active:border-b-0 active:translate-y-[4px] transition-all\n                                    ${status === 'wrong' ? 'bg-[#ff4b4b] border-[#ea2b2b]' : 'bg-[#58cc02] border-[#46a302]'}\n                                `}\n                            >\n                                Continue\n                            </button>\n                        ) : (\n                            <button\n                                onClick={onCheck}\n                                disabled={status === 'idle'}\n                                className={`\n                                    w-full md:min-w-[200px] h-14 rounded-2xl font-black text-white text-lg uppercase tracking-widest border-b-[4px] active:border-b-0 active:translate-y-[4px] transition-all\n                                    ${status === 'idle'\n                                        ? 'bg-[var(--bg-secondary)] border-[var(--border-subtle)] text-[var(--text-muted)] cursor-not-allowed border-b-0'\n                                        : 'bg-[#58cc02] border-[#46a302] hover:bg-[#61e002]'\n                                    }\n                                `}\n                            >\n                                Check\n                            </button>\n                        )}\n                    </div>\n                </div>\n            </motion.div>\n        </AnimatePresence>\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/DuoMascotBubble.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/DuoProgressBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/DuoSessionLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/ScenarioBrief.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/simulation/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/CampusSquare.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[297,309],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'uploadBytes' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"uploadBytes"},"fix":{"range":[451,464],"text":""},"desc":"Remove unused variable \"uploadBytes\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'userData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":17,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1703,1706],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1703,1706],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'node' is defined but never used. Allowed unused args must match /^_/u.","line":189,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":189,"endColumn":46},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'node' is defined but never used. Allowed unused args must match /^_/u.","line":192,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":192,"endColumn":45}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useRef, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useSocialHub } from '@/lib/social-hub-context';\nimport { useAuth } from '@/lib/auth-context';\nimport { UserSocialBadge } from './UserSocialBadge';\nimport { BrightLayer, BrightButton } from '@/components/system';\nimport ReactMarkdown from 'react-markdown';\nimport { storage } from '@/lib/firebase';\nimport { ref, uploadBytes, getDownloadURL } from 'firebase/storage';\n\nconst REACTIONS = ['üî•', 'üíØ', 'üëè', 'üí°'];\n\nexport function CampusSquare() {\n    const { activeRoom, messages, sendMessage, addReaction, openDM, reportMessage, reportRoom, typingUsers, setTyping } = useSocialHub();\n    const { user, userData } = useAuth();\n    const [messageText, setMessageText] = useState('');\n    const [showReactions, setShowReactions] = useState<string | null>(null);\n    const [expandedThreads, setExpandedThreads] = useState<Set<string>>(new Set());\n    const [fileUploading, setFileUploading] = useState(false);\n    const [uploadProgress, setUploadProgress] = useState(0);\n    const fileInputRef = useRef<HTMLInputElement>(null);\n    const messagesEndRef = useRef<HTMLDivElement>(null);\n    const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n    useEffect(() => {\n        if (messages.length > 0 && messagesEndRef.current) {\n            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n        }\n    }, [messages.length]);\n\n    const handleSendMessage = async () => {\n        if (!messageText.trim() && !fileUploading) return;\n\n        try {\n            await sendMessage(messageText);\n            setMessageText('');\n        } catch (error: any) {\n            alert(error.message || 'Failed to send message');\n        }\n    };\n\n    const handleMessageChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n        const text = e.target.value;\n        setMessageText(text);\n\n        // Notify that user is typing\n        if (text.trim()) {\n            setTyping(true);\n            // Clear previous timeout\n            if (typingTimeoutRef.current) {\n                clearTimeout(typingTimeoutRef.current);\n            }\n            // Set typing to false after 3 seconds of inactivity\n            typingTimeoutRef.current = setTimeout(() => {\n                setTyping(false);\n            }, 3000);\n        } else {\n            setTyping(false);\n        }\n    };\n\n    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (!file) return;\n\n        // Validate file size (20MB max)\n        if (file.size > 20 * 1024 * 1024) {\n            alert('File size must be less than 20MB');\n            return;\n        }\n\n        // Validate file type\n        const allowedTypes = ['.pdf', '.png', '.jpg', '.jpeg', '.docx'];\n        const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();\n        if (!allowedTypes.includes(fileExtension)) {\n            alert('Only PDF, PNG, JPG, and DOCX files are allowed');\n            return;\n        }\n\n        setFileUploading(true);\n        setUploadProgress(0);\n        try {\n            const fileRef = ref(storage, `messages/${Date.now()}_${file.name}`);\n\n            // Use uploadBytesResumable for progress tracking\n            const { uploadBytesResumable } = await import('firebase/storage');\n            const uploadTask = uploadBytesResumable(fileRef, file);\n\n            // Track upload progress\n            uploadTask.on('state_changed',\n                (snapshot) => {\n                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;\n                    setUploadProgress(Math.round(progress));\n                },\n                (error) => {\n                    console.error('Upload error:', error);\n                    alert('Failed to upload file');\n                    setFileUploading(false);\n                    setUploadProgress(0);\n                },\n                async () => {\n                    // Upload complete\n                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);\n                    await sendMessage(`üìé ${file.name}`, downloadURL);\n                    setFileUploading(false);\n                    setUploadProgress(0);\n                }\n            );\n        } catch (error) {\n            console.error('Error uploading file:', error);\n            alert('Failed to upload file');\n            setFileUploading(false);\n            setUploadProgress(0);\n        } finally {\n            if (fileInputRef.current) {\n                fileInputRef.current.value = '';\n            }\n        }\n    };\n\n    const toggleThread = (messageId: string) => {\n        setExpandedThreads((prev) => {\n            const next = new Set(prev);\n            if (next.has(messageId)) {\n                next.delete(messageId);\n            } else {\n                next.add(messageId);\n            }\n            return next;\n        });\n    };\n\n    if (!activeRoom) {\n        return (\n            <div className=\"h-full flex items-center justify-center bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl\">\n                <p className=\"text-[var(--text-muted)] font-medium\">\n                    Select a room to start chatting\n                </p>\n            </div>\n        );\n    }\n\n    const MessageItem = ({ index, style }: { index: number; style: React.CSSProperties }) => {\n        const message = messages[index];\n        if (!message) return <div style={style} />;\n\n        const reactions = message.reactions || {};\n        const hasReactions = Object.keys(reactions).length > 0;\n\n        return (\n            <div style={style} className=\"px-4 py-2\">\n                <motion.div\n                    initial={{ opacity: 0, y: 10 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className=\"bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4 hover:bg-white/10 transition-colors\"\n                >\n                    <div className=\"flex items-start justify-between mb-2\">\n                        <div className=\"flex items-center gap-2\">\n                            <UserSocialBadge\n                                userId={message.senderId}\n                                userName={message.senderName || 'User'}\n                                businessPrestige={message.businessPrestige}\n                            />\n                            <span className=\"text-xs text-[var(--text-muted)]\">\n                                {message.timestamp?.toDate().toLocaleTimeString()}\n                            </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                            <button\n                                onClick={() => openDM(message.senderId, message.senderName || 'User')}\n                                className=\"text-xs px-2 py-1 bg-white/5 rounded hover:bg-white/10 transition-colors text-[var(--text-secondary)]\"\n                            >\n                                DM\n                            </button>\n                            <button\n                                onClick={() => reportMessage(message.id, 'Inappropriate content')}\n                                className=\"text-xs px-2 py-1 bg-white/5 rounded hover:bg-white/10 transition-colors text-[var(--state-error)]\"\n                            >\n                                Report\n                            </button>\n                        </div>\n                    </div>\n\n                    <div className=\"prose prose-invert max-w-none mb-3\">\n                        <ReactMarkdown\n                            components={{\n                                code: ({ node, ...props }) => (\n                                    <code className=\"bg-black/30 px-2 py-1 rounded text-sm\" {...props} />\n                                ),\n                                pre: ({ node, ...props }) => (\n                                    <pre className=\"bg-black/30 p-3 rounded overflow-x-auto\" {...props} />\n                                )\n                            }}\n                        >\n                            {message.text}\n                        </ReactMarkdown>\n                    </div>\n\n                    {message.fileUrl && (\n                        <div className=\"mb-3\">\n                            <a\n                                href={message.fileUrl}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"inline-flex items-center gap-2 px-3 py-2 bg-white/5 rounded-lg hover:bg-white/10 transition-colors text-sm\"\n                            >\n                                <span>üìé</span>\n                                <span className=\"text-[var(--brand-primary)]\">\n                                    {message.text.replace('üìé ', '')}\n                                </span>\n                            </a>\n                        </div>\n                    )}\n\n                    <div className=\"flex items-center gap-4\">\n                        <div className=\"flex items-center gap-2\">\n                            {REACTIONS.map((emoji) => {\n                                const userIds = reactions[emoji] || [];\n                                const hasReacted = userIds.includes(user?.uid || '');\n                                const count = userIds.length;\n\n                                if (showReactions === message.id) {\n                                    return (\n                                        <button\n                                            key={emoji}\n                                            onClick={() => addReaction(message.id, emoji)}\n                                            className={`\n                                                px-2 py-1 rounded-lg text-lg transition-all\n                                                ${hasReacted\n                                                    ? 'bg-[var(--brand-primary)]/30 border border-[var(--brand-primary)]'\n                                                    : 'bg-white/5 hover:bg-white/10'\n                                                }\n                                            `}\n                                        >\n                                            {emoji}\n                                            {count > 0 && (\n                                                <span className=\"ml-1 text-xs\">{count}</span>\n                                            )}\n                                        </button>\n                                    );\n                                }\n\n                                if (count > 0) {\n                                    return (\n                                        <button\n                                            key={emoji}\n                                            onClick={() => addReaction(message.id, emoji)}\n                                            className={`\n                                                px-2 py-1 rounded-lg text-lg transition-all\n                                                ${hasReacted\n                                                    ? 'bg-[var(--brand-primary)]/30 border border-[var(--brand-primary)]'\n                                                    : 'bg-white/5 hover:bg-white/10'\n                                                }\n                                            `}\n                                        >\n                                            {emoji} {count}\n                                        </button>\n                                    );\n                                }\n\n                                return null;\n                            })}\n                        </div>\n\n                        {!showReactions && (\n                            <button\n                                onClick={() => setShowReactions(message.id)}\n                                className=\"text-xs text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\"\n                            >\n                                {hasReactions ? 'Add reaction' : 'React'}\n                            </button>\n                        )}\n\n                        {showReactions === message.id && (\n                            <button\n                                onClick={() => setShowReactions(null)}\n                                className=\"text-xs text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\"\n                            >\n                                Done\n                            </button>\n                        )}\n\n                        <button\n                            onClick={() => toggleThread(message.id)}\n                            className=\"text-xs text-[var(--text-muted)] hover:text-[var(--text-primary)] transition-colors\"\n                        >\n                            {expandedThreads.has(message.id) ? 'Hide replies' : 'Reply'}\n                        </button>\n                    </div>\n\n                    {expandedThreads.has(message.id) && (\n                        <div className=\"mt-4 pl-4 border-l-2 border-white/10\">\n                            <p className=\"text-xs text-[var(--text-muted)] mb-2\">Thread replies coming soon...</p>\n                        </div>\n                    )}\n                </motion.div>\n            </div>\n        );\n    };\n\n    return (\n        <div className=\"h-full flex flex-col bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl\">\n            {/* Header */}\n            <div className=\"p-4 border-b border-white/10 flex justify-between items-center\">\n                <div>\n                    <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">\n                        {activeRoom.name}\n                    </h2>\n                    {activeRoom.type === 'public' && activeRoom.subject && (\n                        <p className=\"text-sm text-[var(--text-muted)]\">{activeRoom.subject}</p>\n                    )}\n                </div>\n\n                <BrightButton\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"text-xs border-white/10 hover:border-red-500/50 hover:text-red-500\"\n                    onClick={() => {\n                        const reason = confirm('Report this room for inappropriate content?');\n                        if (reason) {\n                            reportRoom(activeRoom.id, \"User reported room from header\");\n                            alert(\"Thank you. Our moderation team will review this room.\");\n                        }\n                    }}\n                >\n                    üö© Report Room\n                </BrightButton>\n            </div>\n\n            {/* Messages */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n                <AnimatePresence>\n                    {messages.map((message, index) => (\n                        <MessageItem\n                            key={message.id}\n                            index={index}\n                            style={{}}\n                        />\n                    ))}\n                </AnimatePresence>\n                <div ref={messagesEndRef} />\n            </div>\n\n            {/* Input Area */}\n            <div className=\"p-4 border-t border-white/10\">\n                {/* Typing Indicator */}\n                {typingUsers.length > 0 && (\n                    <div className=\"mb-2 px-2\">\n                        <span className=\"text-xs text-[var(--text-muted)] italic\">\n                            {typingUsers.length === 1\n                                ? `${typingUsers[0].name} is typing...`\n                                : typingUsers.length === 2\n                                    ? `${typingUsers[0].name} and ${typingUsers[1].name} are typing...`\n                                    : `${typingUsers[0].name} and ${typingUsers.length - 1} others are typing...`}\n                        </span>\n                        <span className=\"inline-flex ml-1\">\n                            <span className=\"w-1 h-1 bg-[var(--brand-primary)] rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\n                            <span className=\"w-1 h-1 bg-[var(--brand-primary)] rounded-full animate-bounce ml-0.5\" style={{ animationDelay: '150ms' }} />\n                            <span className=\"w-1 h-1 bg-[var(--brand-primary)] rounded-full animate-bounce ml-0.5\" style={{ animationDelay: '300ms' }} />\n                        </span>\n                    </div>\n                )}\n                {fileUploading && (\n                    <div className=\"mb-3\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                            <span className=\"text-xs text-[var(--text-secondary)]\">Uploading...</span>\n                            <span className=\"text-xs font-bold text-[var(--brand-primary)]\">{uploadProgress}%</span>\n                        </div>\n                        <div className=\"w-full bg-white/5 rounded-full h-2 overflow-hidden\">\n                            <motion.div\n                                className=\"h-full bg-gradient-to-r from-[var(--brand-primary)] to-[var(--brand-accent)]\"\n                                initial={{ width: 0 }}\n                                animate={{ width: `${uploadProgress}%` }}\n                                transition={{ duration: 0.3 }}\n                            />\n                        </div>\n                    </div>\n                )}\n                <div className=\"flex items-end gap-2\">\n                    <button\n                        onClick={() => fileInputRef.current?.click()}\n                        disabled={fileUploading}\n                        className=\"p-2 bg-white/5 rounded-lg hover:bg-white/10 transition-colors disabled:opacity-50\"\n                    >\n                        {fileUploading ? '‚è≥' : 'üìé'}\n                    </button>\n                    <input\n                        ref={fileInputRef}\n                        type=\"file\"\n                        className=\"hidden\"\n                        onChange={handleFileUpload}\n                        accept=\".pdf,.png,.jpg,.jpeg,.docx\"\n                    />\n                    <textarea\n                        value={messageText}\n                        onChange={handleMessageChange}\n                        onKeyDown={(e) => {\n                            if (e.key === 'Enter' && !e.shiftKey) {\n                                e.preventDefault();\n                                handleSendMessage();\n                            }\n                        }}\n                        placeholder=\"Type your message... (Markdown supported)\"\n                        className=\"flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm resize-none focus:outline-none focus:border-[var(--brand-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)]\"\n                        rows={2}\n                    />\n                    <BrightButton\n                        variant=\"primary\"\n                        size=\"sm\"\n                        onClick={handleSendMessage}\n                        disabled={!messageText.trim() && !fileUploading}\n                    >\n                        Send\n                    </BrightButton>\n                </div>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/DMWindow.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[90,107],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightButton' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":22,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BrightButton"},"fix":{"range":[320,372],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport Image from 'next/image';\nimport { useSocialHub } from '@/lib/social-hub-context';\nimport { useAuth } from '@/lib/auth-context';\nimport { UserSocialBadge } from './UserSocialBadge';\nimport { BrightButton } from '@/components/system';\nimport { getFirebaseDb } from '@/lib/firebase';\nimport { collection, query, orderBy, onSnapshot, Timestamp, limit } from 'firebase/firestore';\nimport ReactMarkdown from 'react-markdown';\n\ninterface DMWindowProps {\n    userId: string;\n    userName: string;\n    roomId: string;\n    isMinimized: boolean;\n    onClose: () => void;\n    onMinimize: () => void;\n}\n\nexport function DMWindow({ userId, userName, roomId, isMinimized, onClose, onMinimize }: DMWindowProps) {\n    const { sendDM } = useSocialHub();\n    const { user } = useAuth();\n    const [messages, setMessages] = useState<Array<{ id: string; text: string; senderId: string; senderAvatarUrl?: string; timestamp: Timestamp | null }>>([]);\n    const [messageText, setMessageText] = useState('');\n    const [isMounted, setIsMounted] = useState(false);\n    const messagesEndRef = useRef<HTMLDivElement>(null);\n\n    useEffect(() => {\n        setIsMounted(true);\n    }, []);\n\n    const formatTimestamp = (timestamp?: string) => {\n        if (!timestamp) return '';\n        return isMounted ? new Date(timestamp).toLocaleTimeString() : '--:--';\n    };\n\n    useEffect(() => {\n        if (!roomId || !user) return;\n\n        const db = getFirebaseDb();\n        const messagesRef = collection(db, 'dms', roomId, 'messages');\n        const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(80));\n\n        const unsubscribe = onSnapshot(\n            q,\n            (snapshot) => {\n                const msgs: Array<{ id: string; text: string; senderId: string; senderAvatarUrl?: string; timestamp: Timestamp | null }> = [];\n                snapshot.forEach((doc) => {\n                    const data = doc.data();\n                    msgs.push({\n                        id: doc.id,\n                        text: data.text || '',\n                        senderId: data.senderId || '',\n                        senderAvatarUrl: data.senderAvatarUrl || undefined,\n                        timestamp: data.timestamp || null\n                    });\n                });\n                setMessages(msgs.reverse());\n            },\n            (error) => {\n                console.error('Error loading DM messages:', error);\n                setMessages([]);\n            }\n        );\n\n        return () => unsubscribe();\n    }, [roomId, user]);\n\n    useEffect(() => {\n        if (!isMinimized && messagesEndRef.current) {\n            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n        }\n    }, [messages, isMinimized]);\n\n    const handleSend = async () => {\n        if (!messageText.trim()) return;\n\n        try {\n            await sendDM(userId, messageText);\n            setMessageText('');\n        } catch (error) {\n            console.error('Error sending DM:', error);\n        }\n    };\n\n    if (isMinimized) {\n        return (\n            <motion.div\n                initial={{ y: 100, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                className=\"fixed bottom-4 right-4 z-50\"\n            >\n                <button\n                    onClick={onMinimize}\n                    className=\"bg-[var(--brand-primary)] text-white px-4 py-2 rounded-t-xl shadow-lg hover:bg-[var(--brand-primary)]/90 transition-colors\"\n                >\n                    {userName}\n                </button>\n            </motion.div>\n        );\n    }\n\n    return (\n        <motion.div\n            initial={{ y: 100, opacity: 0, scale: 0.95 }}\n            animate={{ y: 0, opacity: 1, scale: 1 }}\n            exit={{ y: 100, opacity: 0, scale: 0.95 }}\n            className=\"fixed bottom-4 right-4 w-96 h-[500px] bg-[var(--bg-glass)] backdrop-blur-2xl border border-white/10 rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden\"\n        >\n            {/* Header */}\n            <div className=\"p-4 border-b border-white/10 flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                    <UserSocialBadge userId={userId} userName={userName} showHoverCard={false} />\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    <button\n                        onClick={onMinimize}\n                        className=\"p-1 hover:bg-white/10 rounded transition-colors\"\n                    >\n                        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 12H4\" />\n                        </svg>\n                    </button>\n                    <button\n                        onClick={onClose}\n                        className=\"p-1 hover:bg-white/10 rounded transition-colors\"\n                    >\n                        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                    </button>\n                </div>\n            </div>\n\n            {/* Messages */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n                {messages.map((message) => (\n                    <div\n                        key={message.id}\n                        className={`flex ${message.senderId === user?.uid ? 'justify-end' : 'justify-start'}`}\n                    >\n                        <div className={`flex items-end gap-2 ${message.senderId === user?.uid ? 'flex-row-reverse' : 'flex-row'}`}>\n                            <div className=\"w-10 h-10 shrink-0\">\n                                <div className=\"relative w-10 h-10 rounded-xl bg-[var(--bg-secondary)] border-b-[3px] border-black/20 overflow-hidden flex items-center justify-center\">\n                                    {message.senderAvatarUrl ? (\n                                        <Image src={message.senderAvatarUrl} alt=\"Avatar\" fill sizes=\"40px\" className=\"object-cover\" />\n                                    ) : (\n                                        <div className=\"w-full h-full flex items-center justify-center text-sm font-black text-[var(--text-primary)]\">\n                                            {(userName || 'U').charAt(0).toUpperCase()}\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n\n                            <div\n                                className={`\n                                    max-w-[80%] rounded-2xl p-4 border-b-[4px]\n                                    ${message.senderId === user?.uid\n                                        ? 'bg-[#1CB0F6] border-[#1899D6]'\n                                        : 'bg-[#37464F] border-[#202F36]'\n                                    }\n                                `}\n                            >\n                                <div className=\"prose prose-invert max-w-none text-sm font-bold text-white\">\n                                    <ReactMarkdown>{message.text}</ReactMarkdown>\n                                </div>\n                                <p className={`text-[10px] uppercase font-black mt-2 text-white/40`}>\n                                    {formatTimestamp(message.timestamp?.toDate().toISOString())}\n                                </p>\n                            </div>\n                        </div>\n                    </div>\n                ))}\n                <div ref={messagesEndRef} />\n            </div>\n\n            <div className=\"p-4 border-t border-white/5 bg-black/5\">\n                <div className=\"flex gap-2 items-end\">\n                    <textarea\n                        value={messageText}\n                        onChange={(e) => setMessageText(e.target.value)}\n                        onKeyDown={(e) => {\n                            if (e.key === 'Enter' && !e.shiftKey) {\n                                e.preventDefault();\n                                handleSend();\n                            }\n                        }}\n                        placeholder=\"Type a message...\"\n                        className=\"flex-1 bg-white/[0.03] border border-white/10 rounded-2xl px-4 py-3 text-sm resize-none focus:outline-none focus:border-[var(--brand-primary)] text-[var(--text-primary)] placeholder:text-[var(--text-muted)] min-h-[50px]\"\n                        rows={1}\n                    />\n                    <button\n                        onClick={handleSend}\n                        disabled={!messageText.trim()}\n                        className=\"h-12 px-6 rounded-2xl bg-[var(--brand-primary)] border-b-[4px] border-[#1899D6] text-white font-black text-[10px] uppercase tracking-widest transition-all hover:brightness-110 active:border-b-0 active:translate-y-[4px] disabled:opacity-50\"\n                    >\n                        Send\n                    </button>\n                </div>\n            </div>\n        </motion.div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/GuildNavigator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BrightLayer' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BrightLayer"},"fix":{"range":[242,254],"text":""},"desc":"Remove unused variable \"BrightLayer\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1138,1141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1138,1141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5959,5962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5959,5962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":192,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7490,7493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7490,7493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useMemo, useRef } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useSocialHub } from '@/lib/social-hub-context';\nimport { useAuth } from '@/lib/auth-context';\nimport { BrightLayer, BrightButton } from '@/components/system';\nimport Fuse from 'fuse.js';\nimport { debounce } from '@/lib/utils/debounce';\n\nconst SUBJECT_LOUNGES = [\n    { name: 'Principles of Business', subject: 'Principles of Business', icon: 'üíº' },\n    { name: 'Mathematics', subject: 'Mathematics', icon: 'üìê' },\n    { name: 'English A', subject: 'English A', icon: 'üìù' },\n    { name: 'Information Technology', subject: 'Information Technology', icon: 'üíª' },\n    { name: 'Chemistry', subject: 'Chemistry', icon: 'üî¨' }\n];\n\nexport function GuildNavigator() {\n    const { rooms, activeRoom, setActiveRoom, createPrivateRoom, joinRoom, leaveRoom, deleteRoom } = useSocialHub();\n    const { user } = useAuth();\n\n    // Search State\n    const [searchQuery, setSearchQuery] = useState('');\n    const [debouncedQuery, setDebouncedQuery] = useState('');\n    const searchCacheRef = useRef<Record<string, any[]>>({});\n\n    // Modal & Action State\n    const [showJoinModal, setShowJoinModal] = useState(false);\n    const [joinCode, setJoinCode] = useState('');\n    const [isJoining, setIsJoining] = useState(false);\n    const [showCreateModal, setShowCreateModal] = useState(false);\n    const [isCreating, setIsCreating] = useState(false);\n\n    const debouncedSetQuery = useMemo(\n        () => debounce((val: string) => setDebouncedQuery(val), 300),\n        []\n    );\n\n    const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const val = e.target.value;\n        setSearchQuery(val);\n        debouncedSetQuery(val);\n    };\n\n    // Combine subject lounges with private rooms\n    const allRooms = useMemo(() => {\n        const publicRooms = SUBJECT_LOUNGES.map(lounge => ({\n            id: lounge.name,\n            name: lounge.name,\n            type: 'public' as const,\n            subject: lounge.subject,\n            members: [],\n            icon: lounge.icon\n        }));\n\n        const privateRooms = rooms\n            .filter(room => room.type === 'private')\n            .map(room => ({ ...room, icon: 'üîí' }));\n\n        return [...publicRooms, ...privateRooms];\n    }, [rooms]);\n\n    // Fuzzy search\n    const fuse = useMemo(() => {\n        return new Fuse(allRooms, {\n            keys: ['name', 'subject'],\n            threshold: 0.3\n        });\n    }, [allRooms]);\n\n    const filteredRooms = useMemo(() => {\n        const query = debouncedQuery.trim().toLowerCase();\n\n        // Min length check\n        if (query.length < 2) return allRooms;\n\n        // Check local cache\n        if (searchCacheRef.current[query]) {\n            return searchCacheRef.current[query];\n        }\n\n        const results = fuse.search(query);\n        const matched = results.map(result => result.item);\n\n        // Save to cache\n        searchCacheRef.current[query] = matched;\n        return matched;\n    }, [debouncedQuery, fuse, allRooms]);\n\n    const handleJoinRoom = async () => {\n        if (!joinCode.trim() || joinCode.length !== 6) return;\n\n        setIsJoining(true);\n        try {\n            const success = await joinRoom(joinCode);\n            if (success) {\n                setShowJoinModal(false);\n                setJoinCode('');\n            } else {\n                alert('Room not found. Please check the code.');\n            }\n        } catch (error) {\n            console.error('Error joining room:', error);\n            alert('Failed to join room. Please try again.');\n        } finally {\n            setIsJoining(false);\n        }\n    };\n\n    const handleCreateRoom = async () => {\n        setIsCreating(true);\n        try {\n            const code = await createPrivateRoom();\n            setShowCreateModal(false);\n            alert(`Room created! Share this code: ${code}`);\n        } catch (error) {\n            console.error('Error creating room:', error);\n            alert('Failed to create room. Please try again.');\n        } finally {\n            setIsCreating(false);\n        }\n    };\n\n    return (\n        <div className=\"h-full flex flex-col\">\n            {/* Search Bar */}\n            <div className=\"mb-4\">\n                <input\n                    type=\"text\"\n                    placeholder=\"Search rooms...\"\n                    value={searchQuery}\n                    onChange={handleSearchChange}\n                    className=\"w-full bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl px-4 py-3 text-sm font-medium text-[var(--text-primary)] placeholder:text-[var(--text-muted)] focus:outline-none focus:border-[var(--brand-primary)] transition-colors\"\n                />\n            </div>\n\n            {/* Action Buttons */}\n            <div className=\"flex gap-2 mb-4\">\n                <BrightButton\n                    variant=\"secondary\"\n                    size=\"sm\"\n                    className=\"flex-1 text-xs\"\n                    onClick={() => setShowCreateModal(true)}\n                >\n                    + Create\n                </BrightButton>\n                <BrightButton\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"flex-1 text-xs\"\n                    onClick={() => setShowJoinModal(true)}\n                >\n                    Join\n                </BrightButton>\n            </div>\n\n            {/* Room List */}\n            <div className=\"flex-1 overflow-y-auto space-y-2\">\n                <AnimatePresence>\n                    {filteredRooms.map((room) => (\n                        <motion.div\n                            key={room.id}\n                            initial={{ opacity: 0, x: -20 }}\n                            animate={{ opacity: 1, x: 0 }}\n                            exit={{ opacity: 0, x: -20 }}\n                            onClick={() => setActiveRoom(room as any)}\n                            className={`\n                                p-3 rounded-xl cursor-pointer transition-all\n                                ${activeRoom?.id === room.id\n                                    ? 'bg-[var(--brand-primary)]/20 border-2 border-[var(--brand-primary)]'\n                                    : 'bg-white/5 backdrop-blur-xl border border-white/10 hover:bg-white/10'\n                                }\n                            `}\n                        >\n                            <div className=\"flex items-center gap-3\">\n                                <span className=\"text-2xl\">{room.icon}</span>\n                                <div className=\"flex-1 min-w-0\">\n                                    <p className=\"font-bold text-sm text-[var(--text-primary)] truncate\">\n                                        {room.name}\n                                    </p>\n                                    {room.type === 'public' && (\n                                        <p className=\"text-xs text-[var(--text-muted)]\">\n                                            {room.subject}\n                                        </p>\n                                    )}\n                                </div>\n\n                                {/* Management Actions */}\n                                {room.type === 'private' && (\n                                    <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                        {(room as any).ownerId === user?.uid ? (\n                                            <button\n                                                onClick={(e) => {\n                                                    e.stopPropagation();\n                                                    if (confirm('Delete this study den permanently?')) {\n                                                        deleteRoom(room.id);\n                                                    }\n                                                }}\n                                                className=\"p-1.5 hover:bg-red-500/20 rounded-lg text-red-500 transition-colors\"\n                                                title=\"Delete Room\"\n                                            >\n                                                üóëÔ∏è\n                                            </button>\n                                        ) : (\n                                            <button\n                                                onClick={(e) => {\n                                                    e.stopPropagation();\n                                                    if (confirm('Leave this study den?')) {\n                                                        leaveRoom(room.id);\n                                                    }\n                                                }}\n                                                className=\"p-1.5 hover:bg-orange-500/20 rounded-lg text-orange-500 transition-colors\"\n                                                title=\"Leave Room\"\n                                            >\n                                                üö™\n                                            </button>\n                                        )}\n                                    </div>\n                                )}\n                            </div>\n                        </motion.div>\n                    ))}\n                </AnimatePresence>\n            </div>\n\n            {/* Join Room Modal */}\n            <AnimatePresence>\n                {showJoinModal && (\n                    <motion.div\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        exit={{ opacity: 0 }}\n                        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\"\n                        onClick={() => setShowJoinModal(false)}\n                    >\n                        <motion.div\n                            initial={{ scale: 0.9, opacity: 0 }}\n                            animate={{ scale: 1, opacity: 1 }}\n                            exit={{ scale: 0.9, opacity: 0 }}\n                            onClick={(e) => e.stopPropagation()}\n                            className=\"bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6 w-full max-w-md\"\n                        >\n                            <h3 className=\"text-xl font-bold mb-4 text-[var(--text-primary)]\">\n                                Join Study Den\n                            </h3>\n                            <input\n                                type=\"text\"\n                                placeholder=\"Enter 6-digit code\"\n                                value={joinCode}\n                                onChange={(e) => setJoinCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n                                className=\"w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-center text-2xl font-mono font-bold mb-4 focus:outline-none focus:border-[var(--brand-primary)]\"\n                                maxLength={6}\n                                autoFocus\n                            />\n                            <div className=\"flex gap-3\">\n                                <BrightButton\n                                    variant=\"secondary\"\n                                    className=\"flex-1\"\n                                    onClick={() => setShowJoinModal(false)}\n                                >\n                                    Cancel\n                                </BrightButton>\n                                <BrightButton\n                                    variant=\"primary\"\n                                    className=\"flex-1\"\n                                    onClick={handleJoinRoom}\n                                    disabled={isJoining || joinCode.length !== 6}\n                                    isLoading={isJoining}\n                                >\n                                    Join\n                                </BrightButton>\n                            </div>\n                        </motion.div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n\n            {/* Create Room Modal */}\n            <AnimatePresence>\n                {showCreateModal && (\n                    <motion.div\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        exit={{ opacity: 0 }}\n                        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4\"\n                        onClick={() => setShowCreateModal(false)}\n                    >\n                        <motion.div\n                            initial={{ scale: 0.9, opacity: 0 }}\n                            animate={{ scale: 1, opacity: 1 }}\n                            exit={{ scale: 0.9, opacity: 0 }}\n                            onClick={(e) => e.stopPropagation()}\n                            className=\"bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6 w-full max-w-md\"\n                        >\n                            <h3 className=\"text-xl font-bold mb-4 text-[var(--text-primary)]\">\n                                Create Study Den\n                            </h3>\n                            <p className=\"text-sm text-[var(--text-secondary)] mb-6\">\n                                Create a private room for you and your friends. Share the code to invite others.\n                            </p>\n                            <div className=\"flex gap-3\">\n                                <BrightButton\n                                    variant=\"secondary\"\n                                    className=\"flex-1\"\n                                    onClick={() => setShowCreateModal(false)}\n                                >\n                                    Cancel\n                                </BrightButton>\n                                <BrightButton\n                                    variant=\"primary\"\n                                    className=\"flex-1\"\n                                    onClick={handleCreateRoom}\n                                    disabled={isCreating}\n                                    isLoading={isCreating}\n                                >\n                                    Create\n                                </BrightButton>\n                            </div>\n                        </motion.div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </div>\n    );\n}\n\nexport default GuildNavigator;\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/PeoplePrivacy.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'UserSocialBadge' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":25,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"UserSocialBadge"},"fix":{"range":[210,263],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'db' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"db"},"fix":{"range":[314,351],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'collection' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"collection"},"fix":{"range":[360,371],"text":""},"desc":"Remove unused variable \"collection\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'query' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"query"},"fix":{"range":[370,377],"text":""},"desc":"Remove unused variable \"query\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'where' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"where"},"fix":{"range":[377,384],"text":""},"desc":"Remove unused variable \"where\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onSnapshot' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"onSnapshot"},"fix":{"range":[384,396],"text":""},"desc":"Remove unused variable \"onSnapshot\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'orderBy' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"orderBy"},"fix":{"range":[396,405],"text":""},"desc":"Remove unused variable \"orderBy\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'limit' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"limit"},"fix":{"range":[405,412],"text":""},"desc":"Remove unused variable \"limit\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'dmWindows' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":13,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":43}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { motion } from 'framer-motion';\nimport { useSocialHub } from '@/lib/social-hub-context';\nimport { useAuth } from '@/lib/auth-context';\nimport { UserSocialBadge } from './UserSocialBadge';\nimport { BrightLayer } from '@/components/system';\nimport { db } from '@/lib/firebase';\nimport { collection, query, where, onSnapshot, orderBy, limit, Timestamp } from 'firebase/firestore';\n\nexport function PeoplePrivacy() {\n    const { onlineUsers, openDM, dmWindows } = useSocialHub();\n    const { user } = useAuth();\n    const [recentDMs, setRecentDMs] = useState<Array<{\n        userId: string;\n        userName: string;\n        lastMessage: string;\n        timestamp: Timestamp | null\n    }>>([]);\n\n    useEffect(() => {\n        if (!user) return;\n\n        // Simplified: Only load DMs when explicitly needed\n        // For now, we'll show empty state to avoid Firestore errors\n        // DMs will be loaded when opened via DMWindow component\n        setRecentDMs([]);\n\n        // TODO: Implement a more efficient DM loading strategy\n        // that doesn't create nested listeners\n    }, [user]);\n\n    const [isMounted, setIsMounted] = useState(false);\n    \n    useEffect(() => {\n        setIsMounted(true);\n    }, []);\n\n    const formatTimestamp = (timestamp?: string) => {\n        if (!timestamp) return '';\n        return isMounted ? new Date(timestamp).toLocaleTimeString() : '--:--';\n    };\n\n    const onlineUserList = Object.entries(onlineUsers)\n        .sort((a, b) => b[1].lastSeen - a[1].lastSeen)\n        .slice(0, 20);\n\n    return (\n        <div className=\"h-full flex flex-col space-y-4\">\n            {/* Online Users */}\n            <BrightLayer variant=\"glass\" padding=\"md\" className=\"flex-1\">\n                <h3 className=\"text-lg font-bold mb-4 text-[var(--text-primary)] flex items-center gap-2\">\n                    <span className=\"w-2 h-2 bg-green-400 rounded-full animate-pulse\"></span>\n                    Online ({onlineUserList.length})\n                </h3>\n                <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\n                    {onlineUserList.length === 0 ? (\n                        <p className=\"text-sm text-[var(--text-muted)]\">No one online</p>\n                    ) : (\n                        onlineUserList.map(([uid, data]) => (\n                            <motion.div\n                                key={uid}\n                                initial={{ opacity: 0, x: 20 }}\n                                animate={{ opacity: 1, x: 0 }}\n                                className=\"flex items-center justify-between p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer\"\n                                onClick={() => openDM(uid, data.name)}\n                            >\n                                <div className=\"flex items-center gap-2\">\n                                    <div className=\"relative\">\n                                        <div className=\"w-8 h-8 rounded-full bg-[var(--brand-primary)]/20 flex items-center justify-center\">\n                                            <span className=\"text-xs font-bold\">\n                                                {data.name.charAt(0).toUpperCase()}\n                                            </span>\n                                        </div>\n                                        <div className=\"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-400 rounded-full border-2 border-[var(--bg-elevated)]\"></div>\n                                    </div>\n                                    <div>\n                                        <p className=\"text-sm font-medium text-[var(--text-primary)]\">\n                                            {data.name}\n                                        </p>\n                                        <p className=\"text-xs text-[var(--text-muted)]\">\n                                            Online\n                                        </p>\n                                    </div>\n                                </div>\n                                <button className=\"text-xs px-2 py-1 bg-[var(--brand-primary)]/20 rounded hover:bg-[var(--brand-primary)]/30 transition-colors text-[var(--brand-primary)]\">\n                                    DM\n                                </button>\n                            </motion.div>\n                        ))\n                    )}\n                </div>\n            </BrightLayer>\n\n            {/* Recent DMs */}\n            <BrightLayer variant=\"glass\" padding=\"md\" className=\"flex-1\">\n                <h3 className=\"text-lg font-bold mb-4 text-[var(--text-primary)]\">\n                    Recent Messages\n                </h3>\n                <div className=\"space-y-2 max-h-[300px] overflow-y-auto\">\n                    {recentDMs.length === 0 ? (\n                        <p className=\"text-sm text-[var(--text-muted)]\">No recent messages</p>\n                    ) : (\n                        recentDMs.map((dm) => (\n                            <motion.div\n                                key={dm.userId}\n                                initial={{ opacity: 0, y: 10 }}\n                                animate={{ opacity: 1, y: 0 }}\n                                className=\"p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer border border-white/5\"\n                                onClick={() => openDM(dm.userId, dm.userName)}\n                            >\n                                <div className=\"flex items-start justify-between mb-1\">\n                                    <p className=\"text-sm font-bold text-[var(--text-primary)]\">\n                                        {dm.userName}\n                                    </p>\n                                    <span className=\"text-xs text-[var(--text-muted)]\">\n                                        {formatTimestamp(dm.timestamp?.toDate().toISOString())}\n                                    </span>\n                                </div>\n                                <p className=\"text-xs text-[var(--text-secondary)] line-clamp-2\">\n                                    {dm.lastMessage}\n                                </p>\n                            </motion.div>\n                        ))\n                    )}\n                </div>\n            </BrightLayer>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/SocialHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"motion"},"fix":{"range":[65,72],"text":""},"desc":"Remove unused variable \"motion\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { GuildNavigator } from './GuildNavigator';\nimport { CampusSquare } from './CampusSquare';\nimport { PeoplePrivacy } from './PeoplePrivacy';\nimport { DMWindow } from './DMWindow';\nimport { useSocialHub } from '@/lib/social-hub-context';\n\nexport function SocialHub() {\n    const { dmWindows, closeDM, toggleDMMinimize, activeRoom } = useSocialHub();\n    const [mobileTab, setMobileTab] = useState<'rooms' | 'chat' | 'people'>(activeRoom ? 'chat' : 'rooms');\n\n    // Automatically switch to chat tab when a room is selected on mobile\n    React.useEffect(() => {\n        if (activeRoom) {\n            setMobileTab('chat');\n        }\n    }, [activeRoom]);\n\n    return (\n        <div className=\"w-full\">\n            {/* Mobile Navigation Dock - Hidden on LG+ screens */}\n            <div className=\"lg:hidden flex gap-2 mb-4 bg-white/5 p-1.5 rounded-2xl border border-white/10 backdrop-blur-xl\">\n                <button\n                    onClick={() => setMobileTab('rooms')}\n                    className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${mobileTab === 'rooms' ? 'bg-[var(--brand-primary)] text-white shadow-lg' : 'text-[var(--text-muted)] hover:text-[var(--text-primary)]'}`}\n                >\n                    üè∞ Rooms\n                </button>\n                <button\n                    onClick={() => setMobileTab('chat')}\n                    className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${mobileTab === 'chat' ? 'bg-[var(--brand-primary)] text-white shadow-lg' : 'text-[var(--text-muted)] hover:text-[var(--text-primary)]'}`}\n                >\n                    üí¨ Chat\n                </button>\n                <button\n                    onClick={() => setMobileTab('people')}\n                    className={`flex-1 py-3 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${mobileTab === 'people' ? 'bg-[var(--brand-primary)] text-white shadow-lg' : 'text-[var(--text-muted)] hover:text-[var(--text-primary)]'}`}\n                >\n                    ü´Ç People\n                </button>\n            </div>\n\n            {/* Main Layout Content */}\n            <div className=\"grid grid-cols-12 gap-4 min-h-[600px] h-[calc(100vh-280px)] lg:h-[calc(100vh-200px)]\">\n                {/* Left Column - Guild Navigator */}\n                <div className={`col-span-12 lg:col-span-3 h-full ${mobileTab !== 'rooms' ? 'hidden lg:block' : ''}`}>\n                    <GuildNavigator />\n                </div>\n\n                {/* Center Column - Campus Square */}\n                <div className={`col-span-12 lg:col-span-6 h-full ${mobileTab !== 'chat' ? 'hidden lg:block' : ''}`}>\n                    <CampusSquare />\n                </div>\n\n                {/* Right Column - People & Privacy */}\n                <div className={`col-span-12 lg:col-span-3 h-full ${mobileTab !== 'people' ? 'hidden lg:block' : ''}`}>\n                    <PeoplePrivacy />\n                </div>\n            </div>\n\n            {/* DM Windows */}\n            <AnimatePresence>\n                {dmWindows.map((dm) => (\n                    <DMWindow\n                        key={dm.userId}\n                        userId={dm.userId}\n                        userName={dm.userName}\n                        roomId={dm.roomId}\n                        isMinimized={dm.isMinimized}\n                        onClose={() => closeDM(dm.userId)}\n                        onMinimize={() => toggleDMMinimize(dm.userId)}\n                    />\n                ))}\n            </AnimatePresence>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/UserSocialBadge.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'bCoins' is never reassigned. Use 'const' instead.","line":46,"column":21,"nodeType":"Identifier","messageId":"useConst","endLine":46,"endColumn":27,"fix":{"range":[1252,1286],"text":"const bCoins = userData.bCoins || 0;"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1958,1961],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1958,1961],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { db } from '@/lib/firebase';\nimport { doc, getDoc } from 'firebase/firestore';\n\ninterface UserSocialBadgeProps {\n    userId: string;\n    userName: string;\n    businessPrestige?: number;\n    className?: string;\n    showHoverCard?: boolean;\n}\n\ninterface BusinessCard {\n    valuation: number;\n    bCoins: number;\n    topSubject: string;\n    mastery: number;\n}\n\nexport function UserSocialBadge({\n    userId,\n    userName,\n    businessPrestige = 0,\n    className = '',\n    showHoverCard = true\n}: UserSocialBadgeProps) {\n    const [hovered, setHovered] = useState(false);\n    const [businessCard, setBusinessCard] = useState<BusinessCard | null>(null);\n\n    useEffect(() => {\n        if (!showHoverCard || !hovered) return;\n\n        const fetchBusinessCard = async () => {\n            try {\n                // Get user data\n                const userRef = doc(db, 'users', userId);\n                const userSnap = await getDoc(userRef);\n                \n                if (!userSnap.exists()) return;\n\n                const userData = userSnap.data();\n                let valuation = businessPrestige || 0;\n                let bCoins = userData.bCoins || 0;\n\n                // If user has a business, get its valuation\n                if (userData.businessID) {\n                    const bizRef = doc(db, 'businesses', userData.businessID);\n                    const bizSnap = await getDoc(bizRef);\n                    if (bizSnap.exists()) {\n                        valuation = bizSnap.data().valuation || 0;\n                    }\n                }\n\n                // Get top subject mastery\n                const subjectProgress = userData.subjectProgress || {};\n                let topSubject = 'None';\n                let mastery = 0;\n\n                Object.entries(subjectProgress).forEach(([subject, progress]: [string, any]) => {\n                    if (progress > mastery) {\n                        mastery = progress;\n                        topSubject = subject;\n                    }\n                });\n\n                setBusinessCard({\n                    valuation,\n                    bCoins,\n                    topSubject,\n                    mastery\n                });\n            } catch (error) {\n                console.error('Error fetching business card:', error);\n            }\n        };\n\n        fetchBusinessCard();\n    }, [userId, hovered, businessPrestige, showHoverCard]);\n\n    const getTier = (valuation: number) => {\n        if (valuation >= 1000000) return 4; // Mogul\n        if (valuation >= 100000) return 3; // Elite\n        if (valuation >= 10000) return 2; // Pro\n        return 1; // Newbie\n    };\n\n    const tier = getTier(businessPrestige);\n\n    const getTierStyles = () => {\n        switch (tier) {\n            case 2: // Pro\n                return {\n                    container: 'relative',\n                    text: 'text-cyan-400',\n                    glow: 'drop-shadow-[0_0_8px_rgba(34,211,238,0.6)]',\n                    icon: 'üíº'\n                };\n            case 3: // Elite\n                return {\n                    container: 'relative',\n                    text: 'bg-gradient-to-r from-gray-300 via-gray-100 to-gray-300 bg-clip-text text-transparent animate-shimmer',\n                    glow: '',\n                    icon: ''\n                };\n            case 4: // Mogul - The Golden Aura\n                return {\n                    container: 'relative golden-aura',\n                    text: 'bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-400 bg-clip-text text-transparent animate-gradient-x drop-shadow-[0_0_12px_rgba(234,179,8,0.8)]',\n                    glow: 'drop-shadow-[0_0_16px_rgba(234,179,8,0.6)]',\n                    icon: 'üëë'\n                };\n            default:\n                return {\n                    container: '',\n                    text: 'text-[var(--text-primary)]',\n                    glow: '',\n                    icon: ''\n                };\n        }\n    };\n\n    const styles = getTierStyles();\n\n    return (\n        <div\n            className={`relative inline-flex items-center gap-2 ${className}`}\n            onMouseEnter={() => setHovered(true)}\n            onMouseLeave={() => setHovered(false)}\n        >\n            <span className={`font-bold ${styles.text} ${styles.glow} ${tier === 3 ? 'animate-shimmer' : ''}`}>\n                {userName}\n            </span>\n            {tier >= 2 && (\n                <span className=\"text-lg\">{styles.icon}</span>\n            )}\n\n            <AnimatePresence>\n                {hovered && showHoverCard && businessCard && (\n                    <motion.div\n                        initial={{ opacity: 0, y: 10, scale: 0.95 }}\n                        animate={{ opacity: 1, y: 0, scale: 1 }}\n                        exit={{ opacity: 0, y: 10, scale: 0.95 }}\n                        transition={{ duration: 0.2 }}\n                        className=\"absolute bottom-full left-0 mb-2 z-50 w-64 bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl\"\n                    >\n                        <div className=\"space-y-3\">\n                            <div className=\"border-b border-white/10 pb-2\">\n                                <p className=\"text-xs font-black uppercase tracking-widest text-[var(--text-muted)] mb-1\">\n                                    Business Card\n                                </p>\n                                <p className=\"font-bold text-lg text-[var(--text-primary)]\">{userName}</p>\n                            </div>\n\n                            <div className=\"space-y-2\">\n                                <div className=\"flex justify-between items-center\">\n                                    <span className=\"text-xs text-[var(--text-secondary)]\">Valuation</span>\n                                    <span className=\"font-bold text-[var(--brand-accent)]\">\n                                        ${businessCard.valuation.toLocaleString()}\n                                    </span>\n                                </div>\n\n                                <div className=\"flex justify-between items-center\">\n                                    <span className=\"text-xs text-[var(--text-secondary)]\">B-Coins</span>\n                                    <span className=\"font-bold text-[var(--brand-primary)]\">\n                                        ‡∏ø {businessCard.bCoins.toLocaleString()}\n                                    </span>\n                                </div>\n\n                                <div className=\"flex justify-between items-center\">\n                                    <span className=\"text-xs text-[var(--text-secondary)]\">Top Mastery</span>\n                                    <span className=\"font-bold text-[var(--text-primary)]\">\n                                        {businessCard.topSubject}\n                                    </span>\n                                </div>\n                                <div className=\"w-full bg-[var(--bg-secondary)] rounded-full h-2 overflow-hidden\">\n                                    <div\n                                        className=\"h-full bg-gradient-to-r from-[var(--brand-primary)] to-[var(--brand-accent)]\"\n                                        style={{ width: `${Math.min(businessCard.mastery, 100)}%` }}\n                                    />\n                                </div>\n                            </div>\n                        </div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/social/index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/system/DialogProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/system/DuoContextMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/system/DuoDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/system/ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/system/index.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1897,1900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1897,1900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React from 'react'\nimport { motion } from 'framer-motion'\n\n/**\n * BRIGHT BUTTON\n * Standardized button for the platform.\n */\ninterface BrightButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\n    variant?: 'primary' | 'secondary' | 'ghost' | 'outline' | 'danger'\n    size?: 'sm' | 'md' | 'lg'\n    isLoading?: boolean\n    leftIcon?: React.ReactNode\n}\n\nexport function BrightButton({\n    children,\n    variant = 'primary',\n    size = 'md',\n    isLoading,\n    leftIcon,\n    className = '',\n    ...props\n}: BrightButtonProps) {\n    const variants = {\n        primary: 'bg-[var(--brand-primary)] text-white hover:shadow-xl hover:shadow-[var(--brand-primary)]/40 hover:-translate-y-1 btn-press neon-glow-primary',\n        secondary: 'bg-[var(--bg-elevated)] text-[var(--text-primary)] border border-[var(--border-subtle)] hover:bg-[var(--bg-secondary)] hover:border-[var(--brand-primary)]/50 btn-press',\n        ghost: 'bg-transparent text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)] btn-press',\n        outline: 'bg-transparent border-2 border-[var(--brand-primary)] text-[var(--brand-primary)] hover:bg-[var(--brand-primary)]/10 btn-press',\n        danger: 'bg-[var(--state-error)] text-white hover:shadow-xl hover:shadow-[var(--state-error)]/40 hover:-translate-y-1 btn-press',\n    }\n\n    const sizes = {\n        sm: 'px-4 py-2 text-xs',\n        md: 'px-6 py-3 text-sm',\n        lg: 'px-8 py-4 text-base',\n    }\n\n    return (\n        <motion.button\n            whileTap={{ scale: 0.97 }}\n            className={`\n        relative inline-flex items-center justify-center font-black uppercase tracking-[0.2em] rounded-[var(--radius-pill)] transition-all \n        disabled:opacity-50 disabled:cursor-not-allowed\n        ${variants[variant]} ${sizes[size]} ${className}\n      `}\n            disabled={isLoading || props.disabled}\n            {...props as any}\n        >\n            {isLoading && (\n                <svg className=\"animate-spin -ml-1 mr-3 h-4 w-4 text-current\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n            )}\n            {!isLoading && leftIcon && <span className=\"mr-2\">{leftIcon}</span>}\n            {children}\n        </motion.button>\n    )\n}\n\n/**\n * BRIGHT LAYER (Container)\n * Standardized surface for cards, panels, and sections.\n */\ninterface BrightLayerProps extends React.HTMLAttributes<HTMLDivElement> {\n    children?: React.ReactNode\n    variant?: 'elevated' | 'secondary' | 'glass'\n    padding?: 'none' | 'sm' | 'md' | 'lg'\n}\n\nexport function BrightLayer({\n    children,\n    variant = 'elevated',\n    padding = 'md',\n    className = '',\n    ...props\n}: BrightLayerProps) {\n    const variants = {\n        elevated: 'bg-[var(--bg-elevated)] border border-[var(--border-subtle)] shadow-md',\n        secondary: 'bg-[var(--bg-secondary)] border border-[var(--border-subtle)]',\n        glass: 'glass-card shadow-xl',\n    }\n\n    const paddings = {\n        none: 'p-0',\n        sm: 'p-4 md:p-6',\n        md: 'p-6 md:p-8',\n        lg: 'p-6 md:p-12',\n    }\n\n    return (\n        <div\n            className={`rounded-[var(--radius-main)] overflow-hidden transition-colors ${variants[variant]} ${paddings[padding]} ${className}`}\n            {...props}\n        >\n            {children}\n        </div>\n    )\n}\n\n/**\n * BRIGHT TYPOGRAPHY\n */\nexport function BrightHeading({ children, level = 1, className = '' }: { children: React.ReactNode, level?: 1 | 2 | 3 | 4, className?: string }) {\n    const styles = {\n        1: 'text-4xl md:text-5xl lg:text-7xl font-black tracking-tight leading-[1.1] md:leading-tight',\n        2: 'text-2xl md:text-3xl lg:text-4xl font-black tracking-tight leading-snug',\n        3: 'text-xl md:text-2xl font-bold tracking-tight',\n        4: 'text-base md:text-lg font-bold uppercase tracking-widest text-[var(--text-muted)]',\n    }\n    const Tag = `h${level}` as keyof JSX.IntrinsicElements\n    return <Tag className={`font-heading ${styles[level]} ${className}`}>{children}</Tag>\n}\n\nexport * from './DuoDialog'\nexport * from './DialogProvider'\nexport * from './DuoContextMenu'\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/components/whiteboard/WhiteboardSession.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useMemo' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useMemo"},"fix":{"range":[52,61],"text":""},"desc":"Remove unused variable \"useMemo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AnimatePresence"},"fix":{"range":[186,203],"text":""},"desc":"Remove unused variable \"AnimatePresence\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'doc' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"doc"},"fix":{"range":[291,295],"text":""},"desc":"Remove unused variable \"doc\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getDoc"},"fix":{"range":[294,304],"text":""},"desc":"Remove unused variable \"getDoc\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'serverTimestamp' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"serverTimestamp"},"fix":{"range":[304,323],"text":""},"desc":"Remove unused variable \"serverTimestamp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setDoc' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":9,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"setDoc"},"fix":{"range":[280,363],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3309,3312],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3309,3312],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3351,3354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3351,3354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'uid' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":131,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'roomId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":131,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":64},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'activeRoomIdForPosting' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":131,"column":66,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":88},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onPostToHub' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":131,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":101},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isResourceSidebarOpen' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":159,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":159,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setIsResourceSidebarOpen' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":159,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":159,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isSaving' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":160,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setIsSaving' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":160,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'saveError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":161,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":161,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setSaveError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":161,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":161,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":166,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":166,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'pdfPages' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":171,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":171,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setPdfPages' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":171,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":171,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fileInputPdfRef' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":201,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":201,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'words' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":338,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":338,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'line' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":339,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":339,"endColumn":19},{"ruleId":"prefer-const","severity":2,"message":"'line' is never reassigned. Use 'const' instead.","line":339,"column":15,"nodeType":"Identifier","messageId":"useConst","endLine":339,"endColumn":19,"fix":{"range":[11740,11754],"text":"const line = '';"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'translateY' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":340,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":340,"endColumn":25},{"ruleId":"prefer-const","severity":2,"message":"'translateY' is never reassigned. Use 'const' instead.","line":340,"column":15,"nodeType":"Identifier","messageId":"useConst","endLine":340,"endColumn":25,"fix":{"range":[11765,11784],"text":"const translateY = 0;"}},{"ruleId":"prefer-const","severity":2,"message":"'anim' is never reassigned. Use 'const' instead.","line":388,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":388,"endColumn":13,"fix":{"range":[14326,14366],"text":"const anim = requestAnimationFrame(render)"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":455,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":455,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17850,17853],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17850,17853],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":455,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":455,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17874,17877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17874,17877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":585,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":585,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23333,23336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23333,23336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'addImageElementFromDataUrl' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":598,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":598,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":655,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":655,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26255,26258],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26255,26258],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":740,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":740,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29293,29296],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29293,29296],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":741,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":741,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29340,29343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29340,29343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'x' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":985,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":985,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'y' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":985,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":985,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1110,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1110,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[50264,50267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[50264,50267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":38,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":3,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport NextImage from 'next/image'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { db, isFirebaseReady } from '@/lib/firebase'\nimport {\n  doc,\n  getDoc,\n  serverTimestamp,\n  setDoc,\n} from 'firebase/firestore'\nimport { useTheme } from '@/lib/theme-context'\n// --- Types ---\ntype Tool = 'select' | 'hand' | 'pen' | 'rect' | 'circle' | 'arrow' | 'text' | 'image' | 'laser' | 'comment' | 'sticky' | 'frame'\ntype PenColor = 'black' | 'red' | 'blue' | 'green' | 'yellow' | 'white'\n\ninterface WhiteboardElementBase {\n  id: string\n  createdAt: number\n  color: PenColor\n  width: number\n}\n\ntype WhiteboardElement =\n  | (WhiteboardElementBase & { type: 'path'; points: { x: number; y: number }[]; isLaser?: boolean })\n  | (WhiteboardElementBase & { type: 'rect'; x: number; y: number; w: number; h: number })\n  | (WhiteboardElementBase & { type: 'circle'; x: number; y: number; r: number })\n  | (WhiteboardElementBase & { type: 'arrow'; x1: number; y1: number; x2: number; y2: number })\n  | (WhiteboardElementBase & { type: 'text'; x: number; y: number; text: string; fontSize: number })\n  | (WhiteboardElementBase & { type: 'sticky'; x: number; y: number; w: number; h: number; text: string })\n  | (WhiteboardElementBase & { type: 'image'; x: number; y: number; w: number; h: number; url: string })\n\nexport type WhiteboardSaveMode = 'discard' | 'save' | 'post'\n\nexport interface WhiteboardSessionResult {\n  mode: WhiteboardSaveMode\n  binderItemId?: string\n  thumbnailUrl?: string\n  boardName?: string\n}\n\nexport interface WhiteboardSessionProps {\n  isOpen: boolean\n  uid: string\n  initialBoardId?: string\n  initialBoardName?: string\n  roomId?: string | null\n  activeRoomIdForPosting?: string | null\n  onPostToHub?: (payload: {\n    whiteboardId: string\n    whiteboardName: string\n    whiteboardThumbnailUrl?: string\n  }) => Promise<void>\n  onClose: (result: WhiteboardSessionResult) => void\n}\n\n// --- Helpers ---\nfunction getColorHex(color: PenColor) {\n  switch (color) {\n    case 'black': return '#000000';\n    case 'red': return '#EF4444';\n    case 'blue': return '#3B82F6';\n    case 'green': return '#22C55E';\n    case 'yellow': return '#EAB308';\n    case 'white': return '#FFFFFF';\n    default: return '#000000';\n  }\n}\n\nfunction safeUuid() {\n  if (typeof crypto !== 'undefined' && 'randomUUID' in crypto) {\n    return crypto.randomUUID()\n  }\n  return `${Date.now()}_${Math.random().toString(16).slice(2)}`\n}\n\ntype StoredWhiteboardDraft = {\n  id: string\n  name: string\n  elements: WhiteboardElement[]\n  panX: number\n  panY: number\n  zoom: number\n  updatedAt: number\n}\n\nfunction draftKey(boardId: string) {\n  return `brighted_whiteboard_draft_${boardId}`\n}\n\nfunction worldFromClient(opts: { clientX: number; clientY: number; rect: DOMRect; panX: number; panY: number; zoom: number }) {\n  return {\n    x: (opts.clientX - opts.rect.left - opts.panX) / opts.zoom,\n    y: (opts.clientY - opts.rect.top - opts.panY) / opts.zoom,\n  }\n}\n\n// Simple hit testing\nfunction hitTest(x: number, y: number, el: WhiteboardElement): boolean {\n  const buffer = 10;\n  if (el.type === 'rect' || el.type === 'image' || el.type === 'sticky') {\n    return x >= el.x && x <= el.x + (el as any).w && y >= el.y && y <= el.y + (el as any).h;\n  }\n  if (el.type === 'circle') {\n    const dx = x - el.x;\n    const dy = y - el.y;\n    return Math.sqrt(dx * dx + dy * dy) <= el.r;\n  }\n  if (el.type === 'text') {\n    const w = el.text.length * el.fontSize * 0.6;\n    const h = el.fontSize;\n    return x >= el.x && x <= el.x + w && y >= el.y - h && y <= el.y;\n  }\n  if (el.type === 'path') {\n    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\n    for (const p of el.points) {\n      if (p.x < minX) minX = p.x;\n      if (p.x > maxX) maxX = p.x;\n      if (p.y < minY) minY = p.y;\n      if (p.y > maxY) maxY = p.y;\n    }\n    return x >= minX - buffer && x <= maxX + buffer && y >= minY - buffer && y <= maxY + buffer;\n  }\n  return false;\n}\n\n// --- Main Component ---\nexport function WhiteboardSession(props: WhiteboardSessionProps) {\n  const { isOpen, uid, initialBoardId, initialBoardName, roomId, activeRoomIdForPosting, onPostToHub, onClose } = props\n  const { theme, toggleTheme } = useTheme()\n  const [isMobile, setIsMobile] = useState(false)\n\n  useEffect(() => {\n    const checkMobile = () => setIsMobile(window.innerWidth < 768)\n    checkMobile()\n    window.addEventListener('resize', checkMobile)\n    return () => window.removeEventListener('resize', checkMobile)\n  }, [])\n\n  const [isMounted, setIsMounted] = useState(false)\n  const [boardId, setBoardId] = useState<string>(initialBoardId || safeUuid())\n  const [boardName, setBoardName] = useState<string>(initialBoardName || 'Untitled Board')\n\n  // Tools\n  const [tool, setTool] = useState<Tool>('select')\n  const [penColor, setPenColor] = useState<PenColor>('black')\n  const [elements, setElements] = useState<WhiteboardElement[]>([])\n  const [selection, setSelection] = useState<string | null>(null)\n\n  // Viewport\n  const [panX, setPanX] = useState(0)\n  const [panY, setPanY] = useState(0)\n  const [zoom, setZoom] = useState(1)\n\n  // UI State\n  const [isExitModalOpen, setIsExitModalOpen] = useState(false)\n  const [isResourceSidebarOpen, setIsResourceSidebarOpen] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [saveError, setSaveError] = useState<string | null>(null)\n\n  const selectTool = (t: Tool) => {\n    setTool(t)\n    if (typeof navigator !== 'undefined' && navigator.vibrate) {\n      try { navigator.vibrate(10) } catch (e) { }\n    }\n  }\n\n  // Resources\n  const [pdfPages, setPdfPages] = useState<Array<{ pageNumber: number; dataUrl: string; width: number; height: number }> | null>(null)\n\n  // Refs\n  const canvasRef = useRef<HTMLCanvasElement | null>(null)\n  const containerRef = useRef<HTMLDivElement | null>(null)\n  const imageCacheRef = useRef<Map<string, { img: HTMLImageElement; loaded: boolean }>>(new Map())\n\n  const pointerStateRef = useRef<\n    | null\n    | {\n      mode: 'panning' | 'drawing' | 'moving_element' | 'resizing'\n      pointerId: number\n      startClientX: number\n      startClientY: number\n      startPanX: number\n      startPanY: number\n      startWorldX: number\n      startWorldY: number\n      activeElementId: string\n      initialElPos?: { x: number; y: number }\n      handle?: string\n      initialElRect?: { x: number; y: number; w: number; h: number }\n    }\n  >(null)\n\n  const [textEditId, setTextEditId] = useState<string | null>(null)\n  const [textEditValue, setTextEditValue] = useState('')\n  const [textEditPos, setTextEditPos] = useState({ x: 0, y: 0 })\n\n  const fileInputImageRef = useRef<HTMLInputElement | null>(null)\n  const fileInputPdfRef = useRef<HTMLInputElement | null>(null)\n\n  // Multi-touch Zoom\n  const activePointersRef = useRef<Map<number, { x: number; y: number }>>(new Map())\n  const lastPinchDistRef = useRef<number | null>(null)\n\n  useEffect(() => { setIsMounted(true) }, [])\n\n  // Load / Restore\n  useEffect(() => {\n    if (!isOpen) return\n    const initialId = initialBoardId || safeUuid()\n    setBoardId(initialId)\n    setBoardName(initialBoardName || 'Untitled Board')\n\n    // 1. Try Local Draft\n    const stored = localStorage.getItem(draftKey(initialId))\n    if (stored) {\n      try {\n        const parsed = JSON.parse(stored) as StoredWhiteboardDraft\n        setElements(parsed.elements || [])\n        setBoardName(parsed.name || initialBoardName || 'Untitled Board')\n        return\n      } catch { }\n    }\n\n    // 2. Try Firebase (Simplified for this rewrite task, ensuring basic connectivity)\n    if (isFirebaseReady && db) {\n      // ... logic to fetch could go here if needed, keeping it light for now to prioritize UI\n    }\n\n    // Default\n    setElements([])\n  }, [isOpen, initialBoardId, initialBoardName])\n\n  // Save Draft on Change\n  useEffect(() => {\n    if (!isOpen) return\n    const t = setTimeout(() => {\n      const draft: StoredWhiteboardDraft = {\n        id: boardId, name: boardName, elements, panX, panY, zoom, updatedAt: Date.now()\n      }\n      localStorage.setItem(draftKey(boardId), JSON.stringify(draft))\n    }, 1000)\n    return () => clearTimeout(t)\n  }, [elements, boardId, boardName, panX, panY, zoom, isOpen])\n\n\n  // --- Render ---\n  const render = useCallback(() => {\n    const canvas = canvasRef.current\n    const container = containerRef.current\n    if (!canvas || !container) return\n    const ctx = canvas.getContext('2d')\n    if (!ctx) return\n    const rect = container.getBoundingClientRect()\n    const dpr = window.devicePixelRatio || 1\n\n    if (canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {\n      canvas.width = rect.width * dpr\n      canvas.height = rect.height * dpr\n      canvas.style.width = `${rect.width}px`\n      canvas.style.height = `${rect.height}px`\n    }\n\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0)\n    ctx.clearRect(0, 0, rect.width, rect.height)\n\n    // Grid\n    const gridSize = 40 * zoom\n    const offsetX = panX % gridSize\n    const offsetY = panY % gridSize\n    ctx.strokeStyle = theme === 'dark' ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'\n    ctx.lineWidth = 1\n    ctx.beginPath()\n    for (let x = offsetX; x < rect.width; x += gridSize) { ctx.moveTo(x, 0); ctx.lineTo(x, rect.height); }\n    for (let y = offsetY; y < rect.height; y += gridSize) { ctx.moveTo(0, y); ctx.lineTo(rect.width, y); }\n    ctx.stroke()\n\n    ctx.save()\n    ctx.translate(panX, panY)\n    ctx.scale(zoom, zoom)\n\n    // Elements\n    for (const el of elements) {\n      ctx.globalAlpha = 1\n      if (el.id === selection && tool === 'select') {\n        ctx.shadowColor = '#3b82f6'\n        ctx.shadowBlur = 10\n      } else {\n        ctx.shadowBlur = 0\n      }\n\n      const color = getColorHex(el.color)\n\n      if (el.type === 'path') {\n        if (el.points.length < 2) continue\n        ctx.strokeStyle = color\n        ctx.lineWidth = el.width\n        ctx.lineCap = 'round'\n        ctx.lineJoin = 'round'\n        ctx.beginPath()\n        ctx.moveTo(el.points[0].x, el.points[0].y)\n        for (let i = 1; i < el.points.length; i++) ctx.lineTo(el.points[i].x, el.points[i].y);\n        ctx.stroke()\n      } else if (el.type === 'text') {\n        if (el.id !== textEditId) {\n          ctx.fillStyle = color\n          ctx.font = `bold ${el.fontSize}px sans-serif`\n          ctx.fillText(el.text, el.x, el.y)\n        }\n      } else if (el.type === 'image') {\n        const cached = imageCacheRef.current.get(el.url)\n        if (cached?.loaded) {\n          ctx.drawImage(cached.img, el.x, el.y, el.w, el.h)\n        } else if (!cached) {\n          const img = new window.Image()\n          imageCacheRef.current.set(el.url, { img, loaded: false })\n          img.src = el.url\n          img.onload = () => { imageCacheRef.current.set(el.url, { img, loaded: true }) } // Trigger re-render in loop\n        }\n      } else if (el.type === 'rect') {\n        ctx.strokeStyle = color; ctx.lineWidth = el.width || 2;\n        ctx.strokeRect(el.x, el.y, el.w, el.h)\n      } else if (el.type === 'sticky') {\n        // Background\n        ctx.fillStyle = el.color === 'yellow' ? '#FFF9C4' : el.color === 'blue' ? '#E1F5FE' : el.color === 'green' ? '#E8F5E9' : '#FFF9C4';\n        ctx.fillRect(el.x, el.y, el.w, el.h)\n        // Accent border bottom\n        ctx.fillStyle = 'rgba(0,0,0,0.05)';\n        ctx.fillRect(el.x, el.y + el.h - 4, el.w, 4)\n\n        if (el.id !== textEditId) {\n          ctx.fillStyle = '#37474F';\n          ctx.font = `bold ${Math.max(12, 16)}px sans-serif`;\n          ctx.textAlign = 'center';\n          ctx.textBaseline = 'middle';\n          const words = el.text.split(' ');\n          let line = '';\n          let translateY = 0;\n          ctx.fillText(el.text, el.x + el.w / 2, el.y + el.h / 2);\n          ctx.textAlign = 'start';\n          ctx.textBaseline = 'alphabetic';\n        }\n      } else if (el.type === 'circle') {\n        ctx.strokeStyle = color; ctx.lineWidth = el.width || 2;\n        ctx.beginPath(); ctx.arc(el.x, el.y, el.r, 0, Math.PI * 2); ctx.stroke();\n      }\n\n      // Miro-style Selection Highlight\n      if (el.id === selection && tool === 'select') {\n        ctx.strokeStyle = '#2563EB';\n        ctx.lineWidth = 2 / zoom;\n        if (el.type === 'rect' || el.type === 'image' || el.type === 'sticky') {\n          ctx.strokeRect(el.x - 4 / zoom, el.y - 4 / zoom, el.w + 8 / zoom, el.h + 8 / zoom);\n          // Handles\n          ctx.fillStyle = 'white';\n          const hs = 8 / zoom;\n          ctx.fillRect(el.x - 4 / zoom - hs / 2, el.y - 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x - 4 / zoom - hs / 2, el.y - 4 / zoom - hs / 2, hs, hs);\n          ctx.fillRect(el.x + el.w + 4 / zoom - hs / 2, el.y - 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x + el.w + 4 / zoom - hs / 2, el.y - 4 / zoom - hs / 2, hs, hs);\n          ctx.fillRect(el.x - 4 / zoom - hs / 2, el.y + el.h + 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x - 4 / zoom - hs / 2, el.y + el.h + 4 / zoom - hs / 2, hs, hs);\n          ctx.fillRect(el.x + el.w + 4 / zoom - hs / 2, el.y + el.h + 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x + el.w + 4 / zoom - hs / 2, el.y + el.h + 4 / zoom - hs / 2, hs, hs);\n        } else if (el.type === 'circle') {\n          const hs = 8 / zoom;\n          ctx.strokeRect(el.x - el.r - 4 / zoom, el.y - el.r - 4 / zoom, el.r * 2 + 8 / zoom, el.r * 2 + 8 / zoom);\n          ctx.fillStyle = 'white';\n          ctx.fillRect(el.x + el.r + 4 / zoom - hs / 2, el.y + el.r + 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x + el.r + 4 / zoom - hs / 2, el.y + el.r + 4 / zoom - hs / 2, hs, hs);\n        } else if (el.type === 'text') {\n          const w = el.text.length * el.fontSize * 0.6;\n          const h = el.fontSize;\n          const hs = 8 / zoom;\n          ctx.strokeRect(el.x - 4 / zoom, el.y - h - 4 / zoom, w + 8 / zoom, h + 8 / zoom);\n          ctx.fillStyle = 'white';\n          ctx.fillRect(el.x + w + 4 / zoom - hs / 2, el.y + 4 / zoom - hs / 2, hs, hs);\n          ctx.strokeRect(el.x + w + 4 / zoom - hs / 2, el.y + 4 / zoom - hs / 2, hs, hs);\n        }\n      }\n    }\n    ctx.restore()\n  }, [elements, panX, panY, zoom, selection, tool, textEditId, theme])\n\n  useEffect(() => {\n    let anim = requestAnimationFrame(render)\n    return () => cancelAnimationFrame(anim)\n  }) // render loop\n\n  // --- Handlers ---\n  const handlePointerDown = (e: React.PointerEvent) => {\n    activePointersRef.current.set(e.pointerId, { x: e.clientX, y: e.clientY })\n\n    if (!containerRef.current) return\n    const rect = containerRef.current.getBoundingClientRect()\n    const { x, y } = worldFromClient({ clientX: e.clientX, clientY: e.clientY, rect, panX, panY, zoom })\n\n    if (activePointersRef.current.size > 1) {\n      pointerStateRef.current = null\n      lastPinchDistRef.current = null\n      return\n    }\n\n    if (tool === 'hand' || e.button === 1 || e.buttons === 4) {\n      pointerStateRef.current = { mode: 'panning', pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, activeElementId: '' }\n      return\n    }\n\n    if (tool === 'select') {\n      const selEl = selection ? elements.find(el => el.id === selection) : null\n      if (selEl) {\n        const buffer = 15 / zoom\n        if (selEl.type === 'rect' || selEl.type === 'image' || selEl.type === 'sticky') {\n          const corners = [\n            { name: 'tl', cx: selEl.x - 4 / zoom, cy: selEl.y - 4 / zoom },\n            { name: 'tr', cx: selEl.x + selEl.w + 4 / zoom, cy: selEl.y - 4 / zoom },\n            { name: 'bl', cx: selEl.x - 4 / zoom, cy: selEl.y + selEl.h + 4 / zoom },\n            { name: 'br', cx: selEl.x + selEl.w + 4 / zoom, cy: selEl.y + selEl.h + 4 / zoom }\n          ]\n          for (const c of corners) {\n            if (Math.abs(x - c.cx) < buffer && Math.abs(y - c.cy) < buffer) {\n              pointerStateRef.current = { mode: 'resizing', handle: c.name, activeElementId: selEl.id, pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, initialElRect: { x: selEl.x, y: selEl.y, w: selEl.w, h: selEl.h } }\n              return\n            }\n          }\n        } else if (selEl.type === 'circle') {\n          if (Math.abs(x - (selEl.x + selEl.r)) < buffer && Math.abs(y - (selEl.y + selEl.r)) < buffer) {\n            pointerStateRef.current = { mode: 'resizing', handle: 'br', activeElementId: selEl.id, pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, initialElRect: { x: selEl.x, y: selEl.y, w: selEl.r, h: 0 } }\n            return\n          }\n        } else if (selEl.type === 'text') {\n          const w = selEl.text.length * selEl.fontSize * 0.6\n          if (Math.abs(x - (selEl.x + w)) < buffer && Math.abs(y - selEl.y) < buffer) {\n            pointerStateRef.current = { mode: 'resizing', handle: 'br', activeElementId: selEl.id, pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, initialElRect: { x: selEl.x, y: selEl.y, w: selEl.fontSize, h: 0 } }\n            return\n          }\n        }\n      }\n\n      const hit = elements.slice().reverse().find(el => hitTest(x, y, el))\n      if (hit) {\n        setSelection(hit.id)\n        pointerStateRef.current = {\n          mode: 'moving_element',\n          pointerId: e.pointerId,\n          startClientX: e.clientX,\n          startClientY: e.clientY,\n          startPanX: panX,\n          startPanY: panY,\n          startWorldX: x,\n          startWorldY: y,\n          activeElementId: hit.id,\n          initialElPos: { x: (hit as any).x ?? 0, y: (hit as any).y ?? 0 }\n        }\n      } else {\n        setSelection(null)\n        pointerStateRef.current = { mode: 'panning', pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, activeElementId: '' }\n      }\n      return\n    }\n\n    const id = safeUuid()\n\n    if (tool === 'text') {\n      setElements(prev => [...prev, { id, type: 'text', x, y, text: 'Double click to edit', color: penColor, fontSize: 24, createdAt: Date.now(), width: 0 }])\n      setTool('select')\n      return\n    }\n\n    if (tool === 'pen') {\n      setElements(prev => [...prev, { id, type: 'path', points: [{ x, y }], color: penColor, width: 3, createdAt: Date.now() }])\n      pointerStateRef.current = { mode: 'drawing', pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, activeElementId: id }\n    }\n\n    if (tool === 'sticky') {\n      setElements(prev => [...prev, { id, type: 'sticky', x, y, w: 120, h: 120, text: 'New Note', color: penColor, createdAt: Date.now(), width: 0 }])\n      setTool('select')\n      return\n    }\n\n    if (tool === 'rect') {\n      setElements(prev => [...prev, { id, type: 'rect', x, y, w: 0, h: 0, color: penColor, width: 2, createdAt: Date.now() }])\n      pointerStateRef.current = { mode: 'drawing', pointerId: e.pointerId, startClientX: e.clientX, startClientY: e.clientY, startPanX: panX, startPanY: panY, startWorldX: x, startWorldY: y, activeElementId: id }\n    }\n  }\n\n  const handlePointerMove = (e: React.PointerEvent) => {\n    activePointersRef.current.set(e.pointerId, { x: e.clientX, y: e.clientY })\n\n    if (activePointersRef.current.size === 2) {\n      const pts = Array.from(activePointersRef.current.values())\n      const dist = Math.sqrt(Math.pow(pts[0].x - pts[1].x, 2) + Math.pow(pts[0].y - pts[1].y, 2))\n      if (lastPinchDistRef.current !== null) {\n        const delta = dist / lastPinchDistRef.current\n        setZoom(prev => Math.min(3, Math.max(0.1, prev * delta)))\n      }\n      lastPinchDistRef.current = dist\n      return\n    }\n\n    const st = pointerStateRef.current\n    if (!st || st.pointerId !== e.pointerId) return\n    const rect = containerRef.current!.getBoundingClientRect()\n    const { x, y } = worldFromClient({ clientX: e.clientX, clientY: e.clientY, rect, panX, panY, zoom })\n\n    if (st.mode === 'panning') {\n      setPanX(st.startPanX + (e.clientX - st.startClientX))\n      setPanY(st.startPanY + (e.clientY - st.startClientY))\n      return\n    }\n\n    if (st.mode === 'resizing' && st.initialElRect) {\n      const dx = x - st.startWorldX\n      const dy = y - st.startWorldY\n      const r = st.initialElRect\n\n      setElements(prev => prev.map(el => {\n        if (el.id !== st.activeElementId) return el\n\n        if (el.type === 'rect' || el.type === 'image' || el.type === 'sticky') {\n          let nx = r.x, ny = r.y, nw = r.w, nh = r.h\n          if (st.handle === 'br') {\n            nw = Math.max(20, r.w + dx); nh = Math.max(20, r.h + dy);\n          } else if (st.handle === 'tr') {\n            nw = Math.max(20, r.w + dx); nh = Math.max(20, r.h - dy); ny = r.y + (r.h - nh);\n          } else if (st.handle === 'bl') {\n            nw = Math.max(20, r.w - dx); nh = Math.max(20, r.h + dy); nx = r.x + (r.w - nw);\n          } else if (st.handle === 'tl') {\n            nw = Math.max(20, r.w - dx); nh = Math.max(20, r.h - dy); nx = r.x + (r.w - nw); ny = r.y + (r.h - nh);\n          }\n          return { ...el, x: nx, y: ny, w: nw, h: nh }\n        } else if (el.type === 'circle') {\n          const newR = Math.max(5, r.w + dx)\n          return { ...el, r: newR }\n        } else if (el.type === 'text') {\n          const newSize = Math.max(8, r.w + dx)\n          return { ...el, fontSize: newSize }\n        }\n        return el\n      }))\n      return\n    }\n\n    if (st.mode === 'moving_element') {\n      const dx = (e.clientX - st.startClientX) / zoom\n      const dy = (e.clientY - st.startClientY) / zoom\n      setElements(prev => prev.map(el => {\n        if (el.id !== st.activeElementId) return el\n        if (el.type === 'rect' || el.type === 'image' || el.type === 'text' || el.type === 'circle' || el.type === 'sticky') {\n          const initX = (st.initialElPos?.x ?? el.x)\n          const initY = (st.initialElPos?.y ?? el.y)\n          return { ...el, x: initX + dx, y: initY + dy }\n        }\n        return el\n      }))\n      return\n    }\n\n    if (st.mode === 'drawing') {\n      setElements(prev => prev.map(el => {\n        if (el.id !== st.activeElementId) return el\n        if (el.type === 'path') return { ...el, points: [...el.points, { x, y }] }\n        if (el.type === 'rect') return { ...el, w: x - st.startWorldX, h: y - st.startWorldY }\n        return el\n      }))\n    }\n  }\n\n  const handlePointerUp = (e: React.PointerEvent) => {\n    activePointersRef.current.delete(e.pointerId)\n    if (activePointersRef.current.size < 2) {\n      lastPinchDistRef.current = null\n    }\n    pointerStateRef.current = null\n  }\n\n  const handleDoubleClick = (e: React.MouseEvent) => {\n    const rect = containerRef.current!.getBoundingClientRect()\n    const { x, y } = worldFromClient({ clientX: e.clientX, clientY: e.clientY, rect, panX, panY, zoom })\n    const hit = elements.slice().reverse().find(el => hitTest(x, y, el))\n    if (hit && (hit.type === 'text' || hit.type === 'sticky')) {\n      setTextEditId(hit.id)\n      setTextEditValue((hit as any).text)\n      setTextEditPos({ x: hit.x, y: hit.y })\n    }\n  }\n\n  const handleDropSticker = useCallback((e: React.DragEvent) => {\n    e.preventDefault(); if (!containerRef.current) return;\n    const payload = e.dataTransfer.getData('text/plain'); if (!payload) return;\n    const rect = containerRef.current.getBoundingClientRect()\n    const { x, y } = worldFromClient({ clientX: e.clientX, clientY: e.clientY, rect, panX, panY, zoom })\n    setElements(prev => [...prev, { id: safeUuid(), type: 'text', x, y, text: payload, color: 'black', fontSize: 18, createdAt: Date.now(), width: 0 }])\n  }, [panX, panY, zoom])\n\n  const addImageElementFromDataUrl = useCallback((dataUrl: string, w: number, h: number) => {\n    const scale = Math.min(1, 520 / w)\n    setElements(prev => [...prev, { id: safeUuid(), type: 'image', x: 100, y: 100, w: w * scale, h: h * scale, url: dataUrl, createdAt: Date.now(), color: 'black', width: 0 }])\n  }, [])\n\n\n\n  const processFile = useCallback(async (file: File, targetX: number, targetY: number) => {\n    if (file.type.startsWith('image/')) {\n      if (file.size > 20 * 1024 * 1024) return alert('Image too large (max 20MB)')\n      const reader = new FileReader()\n      reader.onload = (e) => {\n        const img = new window.Image()\n        img.src = e.target?.result as string\n        img.onload = () => {\n          const scale = Math.min(1, 520 / (img.width || 520))\n          const w = (img.width || 800) * scale\n          const h = (img.height || 600) * scale\n          setElements(prev => [...prev, {\n            id: safeUuid(),\n            type: 'image',\n            x: targetX,\n            y: targetY,\n            w,\n            h,\n            url: img.src,\n            createdAt: Date.now(),\n            color: 'black',\n            width: 0\n          }])\n        }\n      }\n      reader.readAsDataURL(file)\n    } else if (file.type === 'application/pdf') {\n      try {\n        const arrayBuffer = await file.arrayBuffer()\n\n        // Dynamically import PDF.js to avoid SSR issues\n        const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf.mjs')\n        // Set worker (only needs to be done once, but safe to repeat)\n        if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {\n          pdfjsLib.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjsLib.version}/legacy/build/pdf.worker.min.mjs`\n        }\n\n        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer })\n        const pdf = await loadingTask.promise\n\n        // Render first page as an image\n        const page = await pdf.getPage(1)\n        const viewport = page.getViewport({ scale: 1.5 }) // Render at nice quality\n        const canvas = document.createElement('canvas')\n        const context = canvas.getContext('2d')\n        if (!context) return\n\n        canvas.height = viewport.height\n        canvas.width = viewport.width\n\n        await page.render({ canvasContext: context, viewport } as any).promise\n\n        const imgDataUrl = canvas.toDataURL('image/png')\n        const w = viewport.width / 1.5 // Display at natural size (assuming 1.5 scale was for quality)\n        const h = viewport.height / 1.5\n\n        setElements(prev => [...prev, {\n          id: safeUuid(),\n          type: 'image',\n          x: targetX,\n          y: targetY,\n          w,\n          h,\n          url: imgDataUrl,\n          createdAt: Date.now(),\n          color: 'black',\n          width: 0\n        }])\n\n      } catch (err) {\n        console.error('Error loading PDF:', err)\n        alert('Failed to load PDF. Please try again.')\n      }\n    }\n  }, [])\n\n  const handleUploadImage = useCallback(async (file: File) => {\n    processFile(file, panX + 100 * zoom, panY + 100 * zoom) // Default position if uploaded via button\n  }, [panX, panY, zoom, processFile])\n\n  // --- Copy / Paste Handlers ---\n  useEffect(() => {\n    const handlePaste = async (e: ClipboardEvent) => {\n      // If we are editing text, let default behavior happen\n      if ((e.target as HTMLElement).tagName === 'TEXTAREA' || (e.target as HTMLElement).tagName === 'INPUT') return;\n\n      e.preventDefault()\n\n      const items = e.clipboardData?.items\n      if (!items) return\n\n      // Determine paste position (center of screen or mouse pos if we tracked it globally, \n      // but for now let's use slightly offset from center of view)\n      // We can use the center of the current viewport:\n      const rect = containerRef.current?.getBoundingClientRect()\n      let pasteX = 100\n      let pasteY = 100\n\n      if (rect) {\n        // Center of viewport in world coordinates\n        const centerX = rect.width / 2\n        const centerY = rect.height / 2\n        pasteX = (centerX - panX) / zoom\n        pasteY = (centerY - panY) / zoom\n      }\n\n      // 1. Handle Files (Images/PDFs)\n      for (let i = 0; i < items.length; i++) {\n        if (items[i].kind === 'file') {\n          const file = items[i].getAsFile()\n          if (file) {\n            await processFile(file, pasteX, pasteY)\n            pasteX += 20 // Stagger multiple pastes\n            pasteY += 20\n          }\n        } else if (items[i].kind === 'string' && items[i].type === 'text/plain') {\n          // 2. Handle Text / Internal Elements\n          items[i].getAsString((s) => {\n            try {\n              const parsed = JSON.parse(s)\n              if (Array.isArray(parsed) && parsed[0]?.id && parsed[0]?.type) {\n                // It's likely our elements\n                const newElements = parsed.map((el: WhiteboardElement) => {\n                  const offset = 20\n                  if (el.type === 'path') {\n                    return {\n                      ...el,\n                      id: safeUuid(),\n                      points: el.points.map(p => ({ x: p.x + offset, y: p.y + offset })),\n                      createdAt: Date.now()\n                    }\n                  }\n                  return {\n                    ...el,\n                    id: safeUuid(),\n                    x: (el as any).x + offset,\n                    y: (el as any).y + offset,\n                    createdAt: Date.now()\n                  }\n                })\n                setElements(prev => [...prev, ...newElements])\n                // Select the new elements\n                if (newElements.length === 1) setSelection(newElements[0].id)\n              } else {\n                // Plain text paste -> create sticky note?\n                // Or maybe just text tool?\n              }\n            } catch {\n              // Not JSON, treat as plain text\n              // Maybe create a text element or sticky?\n              // For now, let's create a sticky note with the text\n              /*\n              setElements(prev => [...prev, { \n                  id: safeUuid(), \n                  type: 'sticky', \n                  x: pasteX, \n                  y: pasteY, \n                  w: 200, \n                  h: 200, \n                  text: s, \n                  color: 'yellow', \n                  createdAt: Date.now(), \n                  width: 0 \n              }])\n              */\n            }\n          })\n        }\n      }\n    }\n\n    const handleCopy = (e: ClipboardEvent) => {\n      // If editing text, ignore\n      if ((e.target as HTMLElement).tagName === 'TEXTAREA' || (e.target as HTMLElement).tagName === 'INPUT') return;\n\n      if (selection) {\n        const el = elements.find(e => e.id === selection)\n        if (el) {\n          e.preventDefault()\n          e.clipboardData?.setData('text/plain', JSON.stringify([el])) // Wrap in array for future multi-select support\n\n          // If it's an image, try to write image data too? \n          // (Browser support varies, often requires permissions API or Blob)\n        }\n      }\n    }\n\n    window.addEventListener('paste', handlePaste)\n    window.addEventListener('copy', handleCopy)\n    return () => {\n      window.removeEventListener('paste', handlePaste)\n      window.removeEventListener('copy', handleCopy)\n    }\n  }, [selection, elements, panX, panY, zoom, processFile])\n\n  // --- Rendering UI ---\n  if (!isOpen || !isMounted) return null\n\n  const icons = {\n    Select: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z\" /><path d=\"M13 13l6 6\" />\n      </svg>\n    ),\n    Pen: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z\" />\n      </svg>\n    ),\n    Sticky: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M15.5 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V8.5L15.5 3z\" /><path d=\"M15 3v6h6\" />\n      </svg>\n    ),\n    Shape: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\" />\n      </svg>\n    ),\n    Arrow: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M5 19L19 5\" /><path d=\"M12 5h7v7\" />\n      </svg>\n    ),\n    Text: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M4 7V4h16v3\" /><path d=\"M9 20h6\" /><path d=\"M12 4v16\" />\n      </svg>\n    ),\n    Comment: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z\" />\n      </svg>\n    ),\n    Frame: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" />\n        <path d=\"M3 9h18M3 15h18M9 3v18M15 3v18\" />\n      </svg>\n    ),\n    Laser: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <circle cx=\"12\" cy=\"12\" r=\"10\" />\n        <circle cx=\"12\" cy=\"12\" r=\"3\" fill=\"currentColor\" />\n      </svg>\n    ),\n    Grid: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <rect x=\"3\" y=\"3\" width=\"7\" height=\"7\" /><rect x=\"14\" y=\"3\" width=\"7\" height=\"7\" />\n        <rect x=\"14\" y=\"14\" width=\"7\" height=\"7\" /><rect x=\"3\" y=\"14\" width=\"7\" height=\"7\" />\n      </svg>\n    ),\n    More: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M12 5v14M5 12h14\" />\n      </svg>\n    ),\n    AI: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"0\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M12 3l1.912 5.813h6.113l-4.946 3.592 1.889 5.813-4.968-3.593-4.968 3.593 1.889-5.813-4.946-3.592h6.113L12 3z\" fill=\"currentColor\" />\n      </svg>\n    ),\n    Undo: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M9 14L4 9l5-5\" /><path d=\"M20 20v-7a4 4 0 00-4-4H4\" />\n      </svg>\n    ),\n    Redo: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M15 14l5-5-5-5\" /><path d=\"M4 20v-7a4 4 0 014-4h12\" />\n      </svg>\n    ),\n    Hand: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M18 11V6a2 2 0 00-2-2v0a2 2 0 00-2 2v5\" />\n        <path d=\"M14 10V4a2 2 0 00-2-2v0a2 2 0 00-2 2v10\" />\n        <path d=\"M10 10.5V6a2 2 0 00-2-2v0a2 2 0 00-2 2v8\" />\n        <path d=\"M18 8a2 2 0 114 0v6a8 8 0 01-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 012.83-2.82L7 15\" />\n      </svg>\n    ),\n    Sun: () => (\n      <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <circle cx=\"12\" cy=\"12\" r=\"5\" /><path d=\"M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42\" />\n      </svg>\n    ),\n    Moon: () => (\n      <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <path d=\"M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z\" />\n      </svg>\n    ),\n    Image: () => (\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n        <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\" /><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\" /><path d=\"M21 15l-5-5L5 21\" />\n      </svg>\n    )\n  }\n\n  return createPortal(\n    <div className={`fixed inset-0 z-[100] flex flex-col font-sans select-none overflow-hidden transition-colors duration-300 ${theme === 'dark' ? 'bg-[#121212] text-white' : 'bg-[#FAFAFA] text-slate-900'}`}>\n\n      {/* Grid Styling Overlay */}\n      <style>{`\n        .brighted-grid-bg {\n          background-size: 40px 40px;\n          background-image: \n            linear-gradient(to right, ${theme === 'dark' ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)'} 1px, transparent 1px),\n            linear-gradient(to bottom, ${theme === 'dark' ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)'} 1px, transparent 1px);\n        }\n        .pro-sidebar-shadow {\n          box-shadow: 0 0 0 1px ${theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'}, 0 4px 12px rgba(0,0,0,0.1);\n        }\n      `}</style>\n\n      {/* Top Header */}\n      <div className={`absolute top-0 left-0 right-0 h-14 md:h-16 flex justify-between items-center px-4 md:px-6 z-[120] border-b backdrop-blur-xl ${theme === 'dark' ? 'bg-[#1A1A1A]/80 border-white/5' : 'bg-white/80 border-gray-100'} pointer-events-none`}>\n        <div className=\"flex items-center gap-3 md:gap-6 pointer-events-auto\">\n          {/* Official BrightEd Logo */}\n          <div className=\"flex items-center gap-2 md:gap-3\">\n            <div className=\"w-8 h-8 md:w-11 md:h-11 relative\">\n              <NextImage\n                src=\"/BrightEdLogo.png\"\n                alt=\"BrightEd Logo\"\n                fill\n                sizes=\"(max-width: 768px) 32px, 44px\"\n                className=\"object-contain\"\n              />\n            </div>\n            {!isMobile && (\n              <div className=\"flex flex-col text-left\">\n                <span className={`text-xl font-black tracking-tighter leading-none ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>BrightEd</span>\n                <span className=\"text-[10px] font-black text-[#1CB0F6] uppercase tracking-[0.2em] leading-none mt-1\">Whiteboard</span>\n              </div>\n            )}\n            {isMobile && <span className={`text-lg font-black tracking-tighter ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Whiteboard</span>}\n          </div>\n\n          {!isMobile && <div className=\"h-8 w-[1px] bg-gray-200/20 mx-2\" />}\n\n          {!isMobile && (\n            <div className={`flex items-center gap-2 group cursor-pointer px-3 py-1.5 rounded-xl transition-all ${theme === 'dark' ? 'hover:bg-white/5' : 'hover:bg-black/5'}`}>\n              <span className=\"w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.5)]\"></span>\n              <input\n                className={`font-black text-sm outline-none bg-transparent ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}\n                value={boardName}\n                onChange={e => setBoardName(e.target.value)}\n                aria-label=\"Board name\"\n              />\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex items-center gap-2 pointer-events-auto\">\n          {/* Theme Toggle */}\n          <button\n            onClick={toggleTheme}\n            className={`p-2 rounded-xl transition-all flex items-center gap-2 font-bold text-xs ${theme === 'dark' ? 'bg-white/5 text-yellow-400 hover:bg-white/10' : 'bg-black/5 text-indigo-600 hover:bg-black/10'}`}\n          >\n            {theme === 'dark' ? <icons.Sun /> : <icons.Moon />}\n            {!isMobile && (theme === 'dark' ? 'Light Mode' : 'Dark Mode')}\n          </button>\n\n          <button\n            onClick={() => setIsExitModalOpen(true)}\n            className=\"px-4 py-2 md:px-5 md:py-2.5 bg-[#1CB0F6] hover:bg-[#1999d3] text-white font-black text-[10px] md:text-xs rounded-xl shadow-[0_4px_0_#1899d6] active:shadow-none active:translate-y-0.5 transition-all\"\n          >\n            {isMobile ? 'EXIT' : 'EXIT BOARD'}\n          </button>\n        </div>\n      </div>\n\n      {/* Main Canvas Area */}\n      <div className={`flex-1 relative overflow-hidden pointer-events-auto brighted-grid-bg`} ref={containerRef}\n        onPointerDown={handlePointerDown}\n        onPointerMove={handlePointerMove}\n        onPointerUp={handlePointerUp}\n        onPointerCancel={handlePointerUp}\n        onPointerLeave={handlePointerUp}\n        onDoubleClick={handleDoubleClick}\n        onWheel={(e) => {\n          const rect = containerRef.current!.getBoundingClientRect()\n          const { x, y } = worldFromClient({ clientX: e.clientX, clientY: e.clientY, rect, panX, panY, zoom })\n          const factor = e.deltaY > 0 ? 0.9 : 1.1\n          const nextZoom = Math.min(3, Math.max(0.1, zoom * factor))\n          setZoom(nextZoom)\n        }}\n        onDragOver={e => e.preventDefault()}\n        onDrop={handleDropSticker}\n      >\n        <canvas ref={canvasRef} className=\"absolute inset-0 block touch-none\" />\n\n        {/* Text Editor */}\n        {textEditId && (\n          <textarea\n            className=\"absolute bg-white border-2 border-blue-500 rounded shadow-xl outline-none resize-none p-2 font-bold focus:ring-4 focus:ring-blue-100\"\n            style={{\n              left: textEditPos.x * zoom + panX,\n              top: textEditPos.y * zoom + panY - 24,\n              fontSize: `${24 * zoom}px`,\n              width: `${300 * zoom}px`, height: `${120 * zoom}px`\n            }}\n            value={textEditValue}\n            onChange={e => setTextEditValue(e.target.value)}\n            onBlur={() => {\n              setElements(prev => prev.map(el => el.id === textEditId ? { ...el, text: textEditValue } : el))\n              setTextEditId(null)\n            }}\n            autoFocus\n          />\n        )}\n      </div>\n\n      {/* Floating Toolbar (Left on Desktop, Bottom on Mobile) */}\n      <div className={`absolute z-[130] transition-all duration-300 ${isMobile ? 'bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px]' : 'left-6 top-1/2 -translate-y-1/2 w-14'}`}>\n        <div className={`flex gap-1 pro-sidebar-shadow border transition-colors ${isMobile ? 'flex-row p-1.5 rounded-[2rem] justify-around overflow-x-auto no-scrollbar' : 'flex-col p-2 rounded-2xl'} ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5' : 'bg-white border-black/5'}`}>\n          <ToolButtonPro active={tool === 'hand'} onClick={() => selectTool('hand')} icon={<icons.Hand />} label=\"Hand (Pan)\" theme={theme} isMobile={isMobile} />\n          <ToolButtonPro active={tool === 'select'} onClick={() => selectTool('select')} icon={<icons.Select />} label=\"Select\" theme={theme} isMobile={isMobile} />\n          <ToolButtonPro active={tool === 'pen'} onClick={() => selectTool('pen')} icon={<icons.Pen />} label=\"Pen\" theme={theme} isMobile={isMobile} />\n          <ToolButtonPro active={tool === 'sticky'} onClick={() => selectTool('sticky')} icon={<icons.Sticky />} label=\"Sticky Note\" theme={theme} isMobile={isMobile} />\n          <ToolButtonPro active={tool === 'rect'} onClick={() => selectTool('rect')} icon={<icons.Shape />} label=\"Shapes\" theme={theme} isMobile={isMobile} />\n          <ToolButtonPro active={tool === 'text'} onClick={() => selectTool('text')} icon={<icons.Text />} label=\"Text\" theme={theme} isMobile={isMobile} />\n          {isMobile && <div className=\"w-[1px] h-8 bg-gray-200/20 mx-1\" />}\n          <ToolButtonPro active={false} onClick={() => fileInputImageRef.current?.click()} icon={<icons.Image />} label=\"Upload\" theme={theme} isMobile={isMobile} />\n        </div>\n      </div>\n\n      {/* Undo/Redo & Colors (Top Right Desktop / Floating Top Mobile) */}\n      <div className={`absolute z-[130] flex gap-3 items-center transition-all ${isMobile ? 'top-20 left-1/2 -translate-x-1/2 w-[90%] justify-center' : 'bottom-6 left-6'}`}>\n        {!isMobile && (\n          <div className={`rounded-2xl p-1.5 flex gap-1 pro-sidebar-shadow border transition-colors ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5' : 'bg-white border-black/5'}`}>\n            <button className={`p-2.5 rounded-xl transition-all ${theme === 'dark' ? 'text-white/40 hover:text-white hover:bg-white/5' : 'text-slate-400 hover:text-slate-800 hover:bg-black/5'}`} title=\"Undo\" aria-label=\"Undo\"><icons.Undo /></button>\n            <button className={`p-2.5 rounded-xl transition-all ${theme === 'dark' ? 'text-white/40 hover:text-white hover:bg-white/5' : 'text-slate-400 hover:text-slate-800 hover:bg-black/5'}`} title=\"Redo\" aria-label=\"Redo\"><icons.Redo /></button>\n          </div>\n        )}\n\n        <div className={`rounded-2xl p-1.5 flex gap-1.5 pro-sidebar-shadow border transition-colors ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5' : 'bg-white border-black/5'}`}>\n          {(['black', 'red', 'blue', 'green', 'yellow', 'white'] as PenColor[]).map(c => (\n            <button\n              key={c}\n              onClick={() => setPenColor(c)}\n              className={`w-7 h-7 rounded-full border-2 transition-all shadow-sm ${penColor === c ? 'border-[#1CB0F6] scale-110 ring-2 ring-[#1CB0F6]/20' : 'border-transparent hover:scale-110'}`}\n              style={{ backgroundColor: getColorHex(c) }}\n              title={`Color: ${c}`}\n              aria-label={`Select ${c} color`}\n            />\n          ))}\n        </div>\n      </div>\n\n      {/* Zoom Controls (Bottom Right Desktop / Top Right Mobile) */}\n      <div className={`absolute z-[130] flex items-center gap-1 md:gap-3 rounded-2xl p-1 md:p-1.5 pro-sidebar-shadow border transition-all ${isMobile ? 'top-16 right-4 h-9' : 'bottom-6 right-6 h-12'} ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5' : 'bg-white border-black/5'}`}>\n        {!isMobile && (\n          <button className={`p-2 rounded-xl transition-all ${theme === 'dark' ? 'text-white/60 hover:text-white hover:bg-white/5' : 'text-slate-400 hover:text-slate-800 hover:bg-black/5'}`} title=\"Zoom settings\" aria-label=\"Zoom settings\">\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.5\"><rect x=\"4\" y=\"4\" width=\"16\" height=\"16\" rx=\"2\" /><path d=\"M4 12h16M12 4v16\" /></svg>\n          </button>\n        )}\n        <button className={`p-1.5 rounded-lg transition-all font-black ${theme === 'dark' ? 'text-white hover:bg-white/5' : 'text-slate-800 hover:bg-black/5'}`} onClick={() => setZoom(prev => Math.max(0.1, prev - 0.1))} aria-label=\"Zoom out\">\n          <svg className=\"w-3.5 h-3.5 md:w-5 md:h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"3\"><path d=\"M5 12h14\" /></svg>\n        </button>\n        <span className={`text-[9px] md:text-xs font-black w-8 md:w-14 text-center ${theme === 'dark' ? 'text-white/80' : 'text-slate-600'}`}>{Math.round(zoom * 100)}%</span>\n        <button className={`p-1.5 rounded-lg transition-all font-black ${theme === 'dark' ? 'text-white hover:bg-white/5' : 'text-slate-800 hover:bg-black/5'}`} onClick={() => setZoom(prev => Math.min(3, prev + 0.1))} aria-label=\"Zoom in\">\n          <svg className=\"w-3.5 h-3.5 md:w-5 md:h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"3\"><path d=\"M12 5v14M5 12h14\" /></svg>\n        </button>\n      </div>\n\n      {/* Professor Bright Floating Mascot */}\n      <motion.div\n        className=\"absolute bottom-20 right-8 z-[130] pointer-events-none hidden lg:block\"\n        animate={{ y: [0, -10, 0] }}\n        transition={{ duration: 3, repeat: Infinity, ease: \"easeInOut\" }}\n      >\n        <div className=\"relative\">\n          <div className=\"owl-sprite owl-happy scale-75\" />\n          <div className={`absolute -top-12 -right-4 px-4 py-2 rounded-2xl font-black text-xs shadow-xl border-2 whitespace-nowrap ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5 text-white' : 'bg-white border-gray-100 text-slate-800'}`}>\n            Ready to learn? ü¶â\n            <div className={`absolute bottom-[-10px] left-4 w-4 h-4 rotate-45 border-r-2 border-b-2 ${theme === 'dark' ? 'bg-[#1A1A1A] border-white/5' : 'bg-white border-gray-100'}`}></div>\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Hidden Inputs */}\n      <input ref={fileInputImageRef} type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={e => { if (e.target.files?.[0]) handleUploadImage(e.target.files[0]); e.target.value = '' }} />\n\n      {/* Exit Modal */}\n      {isExitModalOpen && (\n        <div className=\"absolute inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in\">\n          <div className=\"bg-white p-8 max-w-sm w-full text-center shadow-2xl rounded-3xl border-b-8 border-gray-200\">\n            <h3 className=\"text-2xl font-black mb-2 text-slate-800 tracking-tight\">Save board changes?</h3>\n            <p className=\"text-slate-500 font-bold mb-8 leading-relaxed\">Your progress will be saved to your digital binder.</p>\n            <div className=\"space-y-3\">\n              <button onClick={() => onClose({ mode: 'save' })} className=\"w-full py-4 rounded-xl bg-blue-600 text-white font-black hover:bg-blue-700 transition-all active:scale-[0.98]\">\n                Save & Exit\n              </button>\n              <button onClick={() => onClose({ mode: 'discard' })} className=\"w-full py-4 text-slate-400 font-black hover:text-red-500 transition-colors uppercase tracking-widest text-xs\">\n                Discard Changes\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n    </div>,\n    document.body\n  )\n}\n\nfunction ToolButtonPro({ active, icon, label, onClick, theme, isMobile }: any) {\n  return (\n    <button\n      onClick={onClick}\n      className={`\n        relative flex items-center justify-center rounded-xl transition-all group shrink-0\n        ${isMobile ? 'w-12 h-12' : 'w-10 h-10'}\n        ${active\n          ? 'bg-[#1CB0F6] text-white shadow-[0_4px_0_#1899d6] -translate-y-0.5'\n          : theme === 'dark'\n            ? 'hover:bg-white/5 text-white/60 hover:text-white'\n            : 'hover:bg-black/5 text-slate-500 hover:text-slate-800'\n        }\n      `}\n      title={label}\n      aria-label={label}\n    >\n      <div className={`${active ? 'scale-110' : 'scale-100 group-hover:scale-110'} transition-transform duration-200`}>\n        {icon}\n      </div>\n      {!active && !isMobile && (\n        <div className={`absolute left-14 font-black px-3 py-1.5 rounded-xl opacity-0 group-hover:opacity-100 shadow-2xl pointer-events-none whitespace-nowrap transition-all text-xs translate-x-3 group-hover:translate-x-0 ${theme === 'dark' ? 'bg-[#1A1A1A] text-white border border-white/10' : 'bg-slate-800 text-white'}`}>\n          {label}\n        </div>\n      )}\n    </button>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/hooks/useLabCompletion.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2165,2168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2165,2168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useCallback } from 'react';\nimport { useAuth } from '@/lib/auth-context';\n\ninterface LabCompletionResult {\n    success: boolean;\n    xpGain: number;\n    xpToday: number;\n    coinsEarned?: number;\n    isCapped: boolean;\n    alreadyCompleted?: boolean;\n    message: string;\n    error?: string;\n}\n\nexport function useLabCompletion() {\n    const { user } = useAuth();\n    const [isSubmitting, setIsSubmitting] = useState(false);\n    const [result, setResult] = useState<LabCompletionResult | null>(null);\n\n    const completeLab = useCallback(async (\n        labId: string,\n        xpReward: number,\n        score?: number\n    ): Promise<LabCompletionResult | null> => {\n        if (!user) {\n            setResult({\n                success: false,\n                xpGain: 0,\n                xpToday: 0,\n                isCapped: false,\n                message: 'Must be logged in to earn XP',\n                error: 'Not authenticated'\n            });\n            return null;\n        }\n\n        setIsSubmitting(true);\n\n        try {\n            const token = await user.getIdToken();\n            const response = await fetch('/api/labs/complete', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    'Authorization': `Bearer ${token}`\n                },\n                body: JSON.stringify({ labId, xpReward, score })\n            });\n\n            const data = await response.json();\n\n            if (!response.ok) {\n                throw new Error(data.error || 'Failed to complete lab');\n            }\n\n            const completionResult: LabCompletionResult = {\n                success: true,\n                xpGain: data.xpGain || 0,\n                xpToday: data.xpToday || 0,\n                coinsEarned: data.coinsEarned || 0,\n                isCapped: data.isCapped || false,\n                alreadyCompleted: data.alreadyCompleted,\n                message: data.message || `Earned ${data.xpGain} XP & ‡∏ø${data.coinsEarned}!`\n            };\n\n            setResult(completionResult);\n            return completionResult;\n        } catch (error: any) {\n            const errorResult: LabCompletionResult = {\n                success: false,\n                xpGain: 0,\n                xpToday: 0,\n                isCapped: false,\n                message: 'Failed to save progress',\n                error: error.message\n            };\n            setResult(errorResult);\n            return errorResult;\n        } finally {\n            setIsSubmitting(false);\n        }\n    }, [user]);\n\n    return {\n        completeLab,\n        isSubmitting,\n        result\n    };\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/hooks/useQuestionLoader.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useAuth' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":17,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useAuth"},"fix":{"range":[52,97],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[290,293],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[290,293],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[830,833],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[830,833],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4311,4314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4311,4314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4323,4326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4323,4326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5187,5190],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5187,5190],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7453,7456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7453,7456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react'\nimport { useAuth } from '@/lib/auth-context'\nimport { UserData } from '@/lib/auth-context'\nimport { NABLEState } from '@/lib/nable'\n\ninterface UseQuestionLoaderProps {\n    objectiveId: string | null\n    subjectId: string | null\n    user: any\n    userData: UserData | null\n    authLoading: boolean\n    authenticatedFetch: (url: string, options?: RequestInit) => Promise<Response>\n}\n\nexport function useQuestionLoader({\n    objectiveId,\n    subjectId,\n    user,\n    userData,\n    authLoading,\n    authenticatedFetch\n}: UseQuestionLoaderProps) {\n    const userId = user?.uid\n    const mastery = userData?.mastery\n    const [loading, setLoading] = useState(true)\n    const [error, setError] = useState<string | null>(null)\n    const [simulationSteps, setSimulationSteps] = useState<any[]>([])\n    const [objectiveInfo, setObjectiveInfo] = useState<{ title: string; subject: string; difficulty?: number } | null>(null)\n    const [questionVariation, setQuestionVariation] = useState(0)\n    const [earnedStars, setEarnedStars] = useState(0)\n    const [isComplete, setIsComplete] = useState(false)\n    const [starJustEarned, setStarJustEarned] = useState(false)\n\n    // NABLE State\n    const [nableState, setNableState] = useState<NABLEState | null>(null)\n\n    // Prevent duplicate fetches from unstable dependencies\n    const hasFetched = useRef(false)\n    const fetchKey = useRef<string | null>(null)\n    const retryCount = useRef(0)\n    const maxRetries = 2\n\n    useEffect(() => {\n        // Create a unique key for this fetch based on stable params\n        const currentFetchKey = `${objectiveId}-${subjectId}-${userId}`\n\n        // Skip if we've already fetched for this exact configuration\n        if (hasFetched.current && fetchKey.current === currentFetchKey) {\n            return\n        }\n\n        let cancelled = false;\n\n        async function loadQuestion() {\n            // 1. Validation - Fail Fast\n            if (!objectiveId || !subjectId) {\n                setError('Please go to the Learning Path to begin your work.')\n                setLoading(false)\n                return\n            }\n\n            if (authLoading) return\n            if (!userId) {\n                // Handled by auth protection wrapper usually, but safe guard\n                return\n            }\n\n            // Prevent rapid retries\n            if (retryCount.current >= maxRetries) {\n                setError('Failed to load after multiple attempts. Please refresh the page.')\n                setLoading(false)\n                return\n            }\n\n            try {\n                setLoading(true)\n                setError(null)\n                setStarJustEarned(false)\n\n                // 2. Load NABLE State via Secure API (Production Fortress)\n                const [progressRes, nableStatusRes] = await Promise.all([\n                    authenticatedFetch(`/api/progress?userId=${userId}`),\n                    authenticatedFetch(`/api/nable/status`)\n                ]);\n\n                if (cancelled) return;\n\n                // Handle auth errors - don't retry on 401\n                if (nableStatusRes.status === 401 || progressRes.status === 401) {\n                    retryCount.current = maxRetries; // Stop retrying\n                    throw new Error('Authentication failed. Please log in again.')\n                }\n\n                // Handle rate limit - wait and retry once\n                if (nableStatusRes.status === 429 || progressRes.status === 429) {\n                    if (retryCount.current < maxRetries) {\n                        retryCount.current++\n                        await new Promise(r => setTimeout(r, 2000))\n                        if (!cancelled) loadQuestion()\n                        return\n                    }\n                }\n\n                // Process NABLE Status\n                if (!nableStatusRes.ok) throw new Error('Failed to load NABLE status');\n                const nableData = await nableStatusRes.json();\n\n                // We recreate the state structure from the API response for the frontend\n                // This keeps the UI working without exposing the full engine logic\n                setNableState({\n                    userId,\n                    knowledgeGraph: nableData.skills.details.reduce((acc: any, skill: any) => {\n                        acc[skill.id] = {\n                            mastery: skill.mastery / 100,\n                            confidence: skill.confidence / 100,\n                            streakCount: skill.streak,\n                            lastTested: skill.lastTested\n                        };\n                        return acc;\n                    }, {}),\n                    sessionQuestions: [],\n                    currentStreak: nableData.session.currentStreak,\n                    consecutiveErrors: nableData.session.consecutiveErrors,\n                    lastDifficulty: 5,\n                    lastDistractorSimilarity: 0.5,\n                    recentTopicIds: [],\n                    personalStabilityFactor: 1.0,\n                    hearts: 5,\n                    sessionStarted: nableData.session.sessionStarted\n                } as any);\n\n                // Process Progress\n                const progressData = await progressRes.json();\n                const existingProgress = progressData.progress && progressData.progress[objectiveId!];\n                const serverStars = existingProgress?.stars ?? 0;\n\n                // Update local star state from server\n                setEarnedStars(serverStars);\n\n                // If already completed (3 stars), redirect to path or allow practice\n                if (serverStars >= 3) {\n                    setIsComplete(true);\n                    setLoading(false);\n                    return;\n                }\n\n                // Determine which question variation to fetch (star + 1)\n                const targetVariation = serverStars + 1;\n                setQuestionVariation(targetVariation);\n\n                // Fetch question with mastery for adaptive difficulty\n                const subjectParam = subjectId ? `&subjectId=${encodeURIComponent(subjectId)}` : ''\n                const masteryParam = mastery ? `&mastery=${mastery}` : ''\n\n                // Pass real-time NABLE stats for immediate difficulty adaptation\n                // Use nableData directly to avoid React state update delay\n                const streak = nableData?.session?.currentStreak || 0;\n                const errors = nableData?.session?.consecutiveErrors || 0;\n                const res = await authenticatedFetch(`/api/questions/generate?objectiveId=${objectiveId}&variation=${targetVariation}&useAI=true${subjectParam}${masteryParam}&streak=${streak}&errors=${errors}`)\n                if (cancelled) return;\n\n                if (!res.ok) throw new Error('Failed to load question')\n\n                const data = await res.json()\n                if (data.simulationSteps) {\n                    setSimulationSteps(data.simulationSteps)\n                    setObjectiveInfo(data.objective)\n                    // Mark as fetched to prevent duplicate requests\n                    hasFetched.current = true\n                    fetchKey.current = currentFetchKey\n                    retryCount.current = 0 // Reset retry count on success\n                } else {\n                    throw new Error('No steps returned')\n                }\n            } catch (err: any) {\n                if (cancelled) return;\n                console.error(err)\n                setError(err.message || 'Failed to load question.')\n                if (err.message?.includes('Authentication') || err.message?.includes('Unauthorized')) {\n                    retryCount.current = maxRetries // Prevent further retries\n                    // Redirect to login after a short delay to show the error\n                    setTimeout(() => {\n                        if (typeof window !== 'undefined') {\n                            window.location.href = '/login'\n                        }\n                    }, 2000)\n                }\n            } finally {\n                if (!cancelled) {\n                    setLoading(false)\n                }\n            }\n        }\n        loadQuestion()\n\n        return () => { cancelled = true; }\n    }, [objectiveId, subjectId, userId, authLoading, authenticatedFetch, mastery])\n\n    return {\n        loading,\n        error,\n        simulationSteps,\n        setSimulationSteps,\n        objectiveInfo,\n        setObjectiveInfo,\n        questionVariation,\n        setQuestionVariation,\n        earnedStars,\n        setEarnedStars,\n        isComplete,\n        setIsComplete,\n        starJustEarned,\n        setStarJustEarned,\n        setLoading,\n        setError,\n        nableState,\n        setNableState\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/hooks/useQuestionPrefetch.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/achievements.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/auth-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/auth-server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/avatars.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/csec-roadmap-missions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/live-sessions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/mission-progress.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/mission-rewards.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/mission-xp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/system-datasets.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/brightos/wallpapers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/business-context.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5100,5103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5100,5103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5172,5175],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5172,5175],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5360,5363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5360,5363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":123,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5456,5459],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5456,5459],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5716,5719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5716,5719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":129,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5950,5953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5950,5953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6249,6252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6249,6252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6402,6405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6402,6405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":565,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":565,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28978,28981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28978,28981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cache-manager.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":142,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":142,"endColumn":18,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3470,3527],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":155,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":155,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3758,3800],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Client-Side Cache Manager\n * Manages localStorage caching with TTL and automatic invalidation\n */\n\nexport const CACHE_KEYS = {\n  USER_PROGRESS: 'user_progress',\n  LEARNING_PATH: 'learning_path',\n  NABLE_STATE: 'nable_state',\n  LEADERBOARD: 'leaderboard',\n  QUESTIONS: 'questions',\n  BUSINESS_STATE: 'business_state',\n  OBJECTIVE_IDS: 'objective_ids'\n} as const;\n\nexport const CACHE_TTL = {\n  USER_PROGRESS: 5 * 60 * 1000, // 5 minutes\n  LEARNING_PATH: 60 * 60 * 1000, // 1 hour\n  NABLE_STATE: 2 * 60 * 1000, // 2 minutes\n  LEADERBOARD: 15 * 60 * 1000, // 15 minutes\n  QUESTIONS: 10 * 60 * 1000, // 10 minutes\n  BUSINESS_STATE: 30 * 1000, // 30 seconds\n  OBJECTIVE_IDS: 24 * 60 * 60 * 1000 // 24 hours\n} as const;\n\ninterface CacheItem<T> {\n  data: T;\n  timestamp: number;\n  ttl: number;\n  version?: string;\n}\n\nexport class CacheManager {\n  private static readonly VERSION = '1.0.0';\n\n  /**\n   * Set a cache item with optional TTL\n   */\n  static set<T>(key: string, data: T, ttl?: number): void {\n    if (typeof window === 'undefined') return;\n\n    const item: CacheItem<T> = {\n      data,\n      timestamp: Date.now(),\n      ttl: ttl || CACHE_TTL[key as keyof typeof CACHE_TTL] || 5 * 60 * 1000,\n      version: this.VERSION\n    };\n\n    try {\n      localStorage.setItem(key, JSON.stringify(item));\n    } catch (error) {\n      // Handle quota exceeded\n      console.warn('Cache storage full, clearing old items:', error);\n      this.clearExpired();\n\n      try {\n        localStorage.setItem(key, JSON.stringify(item));\n      } catch {\n        console.error('Failed to cache item after cleanup');\n      }\n    }\n  }\n\n  /**\n   * Get a cache item if it exists and hasn't expired\n   */\n  static get<T>(key: string): T | null {\n    if (typeof window === 'undefined') return null;\n\n    const item = localStorage.getItem(key);\n    if (!item) return null;\n\n    try {\n      const parsed: CacheItem<T> = JSON.parse(item);\n\n      // Check version compatibility\n      if (parsed.version !== this.VERSION) {\n        localStorage.removeItem(key);\n        return null;\n      }\n\n      // Check expiration\n      const age = Date.now() - parsed.timestamp;\n      if (age > parsed.ttl) {\n        localStorage.removeItem(key);\n        return null;\n      }\n\n      return parsed.data;\n    } catch (error) {\n      console.warn('Failed to parse cache item:', error);\n      localStorage.removeItem(key);\n      return null;\n    }\n  }\n\n  /**\n   * Invalidate a specific cache key\n   */\n  static invalidate(key: string): void {\n    if (typeof window === 'undefined') return;\n    localStorage.removeItem(key);\n  }\n\n  /**\n   * Invalidate multiple cache keys\n   */\n  static invalidateMultiple(keys: string[]): void {\n    if (typeof window === 'undefined') return;\n    keys.forEach(key => localStorage.removeItem(key));\n  }\n\n  /**\n   * Clear all expired cache items\n   */\n  static clearExpired(): void {\n    if (typeof window === 'undefined') return;\n\n    const keys = Object.keys(localStorage);\n    let cleared = 0;\n\n    keys.forEach(key => {\n      try {\n        const item = localStorage.getItem(key);\n        if (!item) return;\n\n        const parsed: CacheItem<unknown> = JSON.parse(item);\n        const age = Date.now() - parsed.timestamp;\n\n        if (age > parsed.ttl) {\n          localStorage.removeItem(key);\n          cleared++;\n        }\n      } catch {\n        // Invalid item, remove it\n        localStorage.removeItem(key);\n        cleared++;\n      }\n    });\n\n    if (cleared > 0) {\n      console.log(`üßπ Cleared ${cleared} expired cache items`);\n    }\n  }\n\n  /**\n   * Clear all cache items\n   */\n  static clearAll(): void {\n    if (typeof window === 'undefined') return;\n\n    const keys = Object.values(CACHE_KEYS);\n    keys.forEach(key => localStorage.removeItem(key));\n\n    console.log('üßπ Cleared all cache items');\n  }\n\n  /**\n   * Get cache statistics\n   */\n  static getStats(): {\n    totalItems: number;\n    totalSize: number;\n    items: Array<{ key: string; size: number; age: number; expired: boolean }>;\n  } {\n    if (typeof window === 'undefined') {\n      return { totalItems: 0, totalSize: 0, items: [] };\n    }\n\n    const keys = Object.keys(localStorage);\n    let totalSize = 0;\n    const items: Array<{ key: string; size: number; age: number; expired: boolean }> = [];\n\n    keys.forEach(key => {\n      const item = localStorage.getItem(key);\n      if (!item) return;\n\n      const size = new Blob([item]).size;\n      totalSize += size;\n\n      try {\n        const parsed: CacheItem<unknown> = JSON.parse(item);\n        const age = Date.now() - parsed.timestamp;\n        const expired = age > parsed.ttl;\n\n        items.push({ key, size, age, expired });\n      } catch {\n        items.push({ key, size, age: 0, expired: true });\n      }\n    });\n\n    return {\n      totalItems: items.length,\n      totalSize,\n      items: items.sort((a, b) => b.size - a.size)\n    };\n  }\n\n  /**\n   * Check if cache is available\n   */\n  static isAvailable(): boolean {\n    if (typeof window === 'undefined') return false;\n\n    try {\n      const test = '__cache_test__';\n      localStorage.setItem(test, test);\n      localStorage.removeItem(test);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n\n// Auto-cleanup expired items on page load\nif (typeof window !== 'undefined') {\n  // Run cleanup after 2 seconds to not block initial load\n  setTimeout(() => {\n    CacheManager.clearExpired();\n  }, 2000);\n\n  // Run cleanup every 5 minutes\n  setInterval(() => {\n    CacheManager.clearExpired();\n  }, 5 * 60 * 1000);\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/business-meeting-scenes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/character-registry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/character-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/demo-scenes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cinematic/scene-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/cognitive-levels.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/content-cleaner.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/data-manager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/business-templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/business-tools.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/cash-flow.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/economy-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/employee-skills.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/firebase-db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/loyalty-system.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/order-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/order-narratives.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/pricing-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/stock-market.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/use-economy-business.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1337,1340],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1337,1340],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/economy/valuation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/errors/AppError.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/errors/errorHandler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/firebase-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/firebase-monitor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/firebase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/learning-algorithm.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/diagnostic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/difficulty-scaler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/error-classifier.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/global-intelligence.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/mastery-tracker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/quality-control.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/question-normalizer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/spaced-repetition.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/story-analyzer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/nable/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/offline-queue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/ollama.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/professor-bright.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/rate-limit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/request-deduplicator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/sanitize.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/science/biology-labs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/science/chemical-logic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/science/lab-inventory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/science/safety-system.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/science/virtual-lab.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/security/api-wrapper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/security/audit-log.ts","messages":[],"suppressedMessages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":202,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":202,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4812,4867],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":236,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":236,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5734,5964],"text":""},"desc":"Remove the console.log()."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/security/csrf.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/security/rate-limit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/security/validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/social-hub-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stats-updater.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/consequence-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/difficulty.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/npc.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/player.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/reflection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/resources.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/seed-stories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/simulations/business.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/time.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-engine/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/stories-store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/subject-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/supabase/middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/theme-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/user-stats.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/utils/asyncHandler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/utils/debounce.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/utils/serverCache.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/xp-tracker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/lib/xp-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/next-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/next.config.js","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isServer' is defined but never used. Allowed unused args must match /^_/u.","line":32,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":31}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  output: 'standalone',\n  swcMinify: true,\n  compiler: {\n    removeConsole: process.env.NODE_ENV === \"production\",\n  },\n  images: {\n    formats: ['image/avif', 'image/webp'],\n    dangerouslyAllowSVG: true,\n    contentSecurityPolicy: \"default-src 'self'; script-src 'none'; sandbox;\",\n    remotePatterns: [\n      {\n        protocol: 'https',\n        hostname: 'res.cloudinary.com',\n      },\n      {\n        protocol: 'https',\n        hostname: 'firebasestorage.googleapis.com',\n      },\n      {\n        protocol: 'https',\n        hostname: '*.firebasestorage.app',\n      },\n      {\n        protocol: 'https',\n        hostname: 'api.dicebear.com',\n        pathname: '/**',\n      },\n    ],\n  },\n  webpack: (config, { isServer }) => {\n    config.watchOptions = {\n      ...(config.watchOptions || {}),\n      ignored: [\n        '**/node_modules/**',\n        '**/.next/**',\n        '**/pagefile.sys',\n        '**/hiberfil.sys',\n        '**/dumpstack.log.tmp',\n        'C:/pagefile.sys',\n        'C:/hiberfil.sys',\n        'C:/dumpstack.log.tmp'\n      ],\n    };\n    return config\n  },\n  async redirects() {\n    return [\n      {\n        source: '/simulate',\n        destination: '/lesson',\n        permanent: true,\n      },\n      {\n        source: '/onboarding',\n        destination: '/welcome',\n        permanent: true,\n      },\n    ]\n  },\n  // Security Headers Configuration (Security.md Section 9)\n  async headers() {\n    const isDevelopment = process.env.NODE_ENV === 'development';\n    \n    // Content Security Policy directives\n    const cspDirectives = {\n      'default-src': [\"'self'\"],\n      'script-src': isDevelopment \n        ? [\n            \"'self'\",\n            \"'unsafe-inline'\",\n            \"'unsafe-eval'\",\n            \"https://*.firebaseio.com\",\n            \"https://www.googletagmanager.com\",\n            \"https://apis.google.com\",\n            \"https://accounts.google.com\",\n            \"https://www.gstatic.com\",\n          ]\n        : [\n            \"'self'\",\n            \"'unsafe-inline'\",\n            \"https://*.firebaseio.com\",\n            \"https://www.googletagmanager.com\",\n            \"https://apis.google.com\",\n            \"https://accounts.google.com\",\n            \"https://www.gstatic.com\",\n          ],\n      'script-src-elem': isDevelopment\n        ? [\n            \"'self'\",\n            \"'unsafe-inline'\",\n            \"'unsafe-eval'\",\n            \"https://*.firebaseio.com\",\n            \"https://www.googletagmanager.com\",\n            \"https://apis.google.com\",\n            \"https://accounts.google.com\",\n            \"https://www.gstatic.com\",\n          ]\n        : [\n            \"'self'\",\n            \"'unsafe-inline'\",\n            \"https://*.firebaseio.com\",\n            \"https://www.googletagmanager.com\",\n            \"https://apis.google.com\",\n            \"https://accounts.google.com\",\n            \"https://www.gstatic.com\",\n          ],\n      'style-src': [\"'self'\", \"'unsafe-inline'\"],\n      'img-src': [\"'self'\", \"data:\", \"https:\", \"blob:\"],\n      'font-src': [\"'self'\", \"https://fonts.gstatic.com\"],\n      'connect-src': [\n        \"'self'\", \n        \"https://*.googleapis.com\",\n        \"https://*.firebaseio.com\",\n        \"wss://*.firebaseio.com\",\n        \"https://www.google-analytics.com\",\n        \"https://www.googletagmanager.com\",\n        \"https://api.dicebear.com\",\n        isDevelopment ? \"ws://localhost:*\" : \"\"\n      ].filter(Boolean),\n      'frame-src': [\n        \"'self'\",\n        \"https://*.firebaseapp.com\",\n        \"https://*.web.app\",\n        \"https://accounts.google.com\",\n      ],\n      'object-src': [\"'none'\"],\n      'base-uri': [\"'self'\"],\n      'form-action': [\"'self'\"],\n      'frame-ancestors': [\"'none'\"],\n      'worker-src': [\"'self'\", \"blob:\"],\n      'manifest-src': [\"'self'\"],\n      'media-src': [\"'self'\", \"https://firebasestorage.googleapis.com\"],\n      'upgrade-insecure-requests': [],\n    };\n\n    const cspString = Object.entries(cspDirectives)\n      .map(([key, values]) => {\n        if (values.length === 0) return key;\n        return `${key} ${values.join(' ')}`;\n      })\n      .join('; ');\n\n    const cacheableExtensions = [\n      'jpg',\n      'jpeg',\n      'gif',\n      'png',\n      'svg',\n      'ico',\n      'woff',\n      'woff2',\n      'ttf',\n      'eot',\n    ];\n\n    return [\n      {\n        source: '/(.*)',\n        headers: [\n          {\n            key: 'Content-Security-Policy',\n            value: cspString,\n          },\n          {\n            key: 'Strict-Transport-Security',\n            value: 'max-age=63072000; includeSubDomains; preload',\n          },\n          {\n            key: 'X-XSS-Protection',\n            value: '1; mode=block',\n          },\n          {\n            key: 'X-Frame-Options',\n            value: 'DENY',\n          },\n          {\n            key: 'X-Content-Type-Options',\n            value: 'nosniff',\n          },\n          {\n            key: 'Referrer-Policy',\n            value: 'strict-origin-when-cross-origin',\n          },\n          {\n            key: 'Permissions-Policy',\n            value: 'camera=(), microphone=(), geolocation=(), interest-cohort=(), payment=(), usb=(), vr=()',\n          },\n          {\n            key: 'X-DNS-Prefetch-Control',\n            value: 'on',\n          },\n          {\n            key: 'Cross-Origin-Opener-Policy',\n            value: 'same-origin-allow-popups',\n          },\n          {\n            key: 'Cross-Origin-Resource-Policy',\n            value: 'same-origin',\n          },\n          {\n            key: 'Cache-Control',\n            value: 'no-store, max-age=0',\n          },\n        ],\n      },\n      {\n        // Allow caching for static assets\n        source: '/_next/(.*)',\n        headers: [\n          {\n            key: 'Cache-Control',\n            value: 'public, max-age=31536000, immutable',\n          },\n        ],\n      },\n      ...cacheableExtensions.map((ext) => ({\n        // Allow caching for public assets\n        source: `/:path*.${ext}`,\n        headers: [\n          {\n            key: 'Cache-Control',\n            value: 'public, max-age=31536000, immutable',\n          },\n        ],\n      })),\n    ];\n  },\n}\n\nmodule.exports = nextConfig\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/pages/_document.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/aggregate-leaderboards.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":74,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":74,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2073,2119],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":81,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":81,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2239,2290],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":106,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":106,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3052,3128],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":109,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":109,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3180,3235],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":134,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":134,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4032,4116],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":137,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":137,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[4169,4225],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":162,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":162,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5036,5122],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":165,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":165,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5180,5233],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":215,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":215,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6818,6868],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":251,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":251,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[7932,8002],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":254,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":254,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8034,8089],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":255,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":255,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8094,8121],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":256,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":256,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8126,8193],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":257,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":257,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8198,8273],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":258,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":258,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8278,8355],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":259,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":259,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8360,8415],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":260,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":260,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8420,8476],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":266,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":266,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8645,8715],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":267,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":267,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8720,8798],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":278,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":278,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[8969,8994],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Aggregate Leaderboards Script\n * Run this every 15 minutes via cron to update leaderboard cache\n * \n * Usage: npx tsx scripts/aggregate-leaderboards.ts\n */\n\nimport * as admin from 'firebase-admin';\nimport fs from 'fs';\nimport path from 'path';\n\nfunction loadServiceAccount() {\n  const json = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON;\n  const base64 = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64;\n  const serviceAccountPathEnv = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n\n  if (typeof json === 'string' && json.trim()) {\n    return JSON.parse(json);\n  }\n\n  if (typeof base64 === 'string' && base64.trim()) {\n    const decoded = Buffer.from(base64, 'base64').toString('utf8');\n    return JSON.parse(decoded);\n  }\n\n  if (typeof serviceAccountPathEnv === 'string' && serviceAccountPathEnv.trim()) {\n    const resolvedPath = path.isAbsolute(serviceAccountPathEnv)\n      ? serviceAccountPathEnv\n      : path.join(process.cwd(), serviceAccountPathEnv);\n    if (fs.existsSync(resolvedPath)) {\n      return JSON.parse(fs.readFileSync(resolvedPath, 'utf8'));\n    }\n  }\n\n  return null;\n}\n\n// Initialize Firebase Admin directly for standalone script\nif (!admin.apps.length) {\n  const serviceAccount = loadServiceAccount();\n  if (!serviceAccount) {\n    console.error('‚ùå Firebase Admin credentials missing. Set FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON, FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64, or FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH.');\n    process.exit(1);\n  }\n\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n    databaseURL: `https://${serviceAccount.project_id}.firebaseio.com`\n  });\n}\n\nconst adminDb = admin.firestore();\n\ninterface LeaderboardUser {\n  userId: string;\n  displayName: string;\n  xp: number;\n  mastery: number;\n  streak: number;\n  school?: string;\n  schoolId?: string;\n}\n\ninterface SchoolData {\n  schoolId: string;\n  schoolName: string;\n  totalXP: number;\n  studentCount: number;\n  masterySum: number;\n  masteryCount: number;\n}\n\nasync function aggregateLeaderboards() {\n  console.log('üîÑ Aggregating leaderboards...');\n\n  try {\n    const batch = adminDb.batch();\n    let operationCount = 0;\n\n    // 1. Global XP Leaderboard (Top 100)\n    console.log('üìä Fetching global top 100 by XP...');\n    const topXPUsers = await adminDb\n      .collection('users')\n      .orderBy('xp', 'desc')\n      .limit(100)\n      .get();\n\n    const globalXPLeaderboard: LeaderboardUser[] = topXPUsers.docs.map(doc => ({\n      userId: doc.id,\n      displayName: doc.get('displayName') || doc.get('username') || 'Anonymous',\n      xp: doc.get('xp') || 0,\n      mastery: doc.get('globalMastery') || 0,\n      streak: doc.get('streak') || 0,\n      school: doc.get('school'),\n      schoolId: doc.get('schoolId')\n    }));\n\n    batch.set(adminDb.collection('leaderboards').doc('global'), {\n      type: 'xp',\n      users: globalXPLeaderboard,\n      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),\n      count: globalXPLeaderboard.length\n    });\n    operationCount++;\n\n    console.log(`‚úÖ Global XP leaderboard: ${globalXPLeaderboard.length} users`);\n\n    // 2. Global Streak Leaderboard (Top 100)\n    console.log('üî• Fetching global top 100 by streak...');\n    const topStreakUsers = await adminDb\n      .collection('users')\n      .orderBy('streak', 'desc')\n      .limit(100)\n      .get();\n\n    const globalStreakLeaderboard: LeaderboardUser[] = topStreakUsers.docs.map(doc => ({\n      userId: doc.id,\n      displayName: doc.get('displayName') || doc.get('username') || 'Anonymous',\n      xp: doc.get('xp') || 0,\n      mastery: doc.get('globalMastery') || 0,\n      streak: doc.get('streak') || 0,\n      school: doc.get('school'),\n      schoolId: doc.get('schoolId')\n    }));\n\n    batch.set(adminDb.collection('leaderboards').doc('global_streak'), {\n      type: 'streak',\n      users: globalStreakLeaderboard,\n      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),\n      count: globalStreakLeaderboard.length\n    });\n    operationCount++;\n\n    console.log(`‚úÖ Global streak leaderboard: ${globalStreakLeaderboard.length} users`);\n\n    // 3. Global Mastery Leaderboard (Top 100)\n    console.log('üß† Fetching global top 100 by mastery...');\n    const topMasteryUsers = await adminDb\n      .collection('users')\n      .orderBy('globalMastery', 'desc')\n      .limit(100)\n      .get();\n\n    const globalMasteryLeaderboard: LeaderboardUser[] = topMasteryUsers.docs.map(doc => ({\n      userId: doc.id,\n      displayName: doc.get('displayName') || doc.get('username') || 'Anonymous',\n      xp: doc.get('xp') || 0,\n      mastery: doc.get('globalMastery') || 0,\n      streak: doc.get('streak') || 0,\n      school: doc.get('school'),\n      schoolId: doc.get('schoolId')\n    }));\n\n    batch.set(adminDb.collection('leaderboards').doc('global_mastery'), {\n      type: 'mastery',\n      users: globalMasteryLeaderboard,\n      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),\n      count: globalMasteryLeaderboard.length\n    });\n    operationCount++;\n\n    console.log(`‚úÖ Global mastery leaderboard: ${globalMasteryLeaderboard.length} users`);\n\n    // 4. School Leaderboards - aggregate by school\n    console.log('üè´ Aggregating school leaderboards...');\n    const allUsers = await adminDb\n      .collection('users')\n      .get();\n\n    const schoolMap = new Map<string, SchoolData>();\n    const schoolUserMap = new Map<string, LeaderboardUser[]>();\n\n    allUsers.docs.forEach(doc => {\n      const schoolName = doc.get('school');\n      const schoolId = doc.get('schoolId');\n\n      if (!schoolName && !schoolId) return;\n\n      const normalizedSchoolId = schoolId || schoolName.trim().toLowerCase().replace(/[^a-z0-9\\s-]/g, '').replace(/\\s+/g, '-');\n\n      // Aggregate school stats\n      if (!schoolMap.has(normalizedSchoolId)) {\n        schoolMap.set(normalizedSchoolId, {\n          schoolId: normalizedSchoolId,\n          schoolName: schoolName || normalizedSchoolId,\n          totalXP: 0,\n          studentCount: 0,\n          masterySum: 0,\n          masteryCount: 0\n        });\n        schoolUserMap.set(normalizedSchoolId, []);\n      }\n\n      const school = schoolMap.get(normalizedSchoolId)!;\n      school.totalXP += doc.get('xp') || 0;\n      school.studentCount += 1;\n\n      const mastery = doc.get('globalMastery');\n      if (typeof mastery === 'number' && Number.isFinite(mastery)) {\n        school.masterySum += mastery;\n        school.masteryCount += 1;\n      }\n\n      schoolUserMap.get(normalizedSchoolId)!.push({\n        userId: doc.id,\n        displayName: doc.get('displayName') || doc.get('username') || 'Anonymous',\n        xp: doc.get('xp') || 0,\n        mastery: doc.get('globalMastery') || 0,\n        streak: doc.get('streak') || 0,\n        school: schoolName,\n        schoolId: normalizedSchoolId\n      });\n    });\n\n    console.log(`üìö Found ${schoolMap.size} schools`);\n\n    // Save aggregated school rankings\n    const schoolRankings = Array.from(schoolMap.values())\n      .map(s => ({\n        ...s,\n        averageMastery: s.masteryCount > 0 ? s.masterySum / s.masteryCount : 0\n      }))\n      .sort((a, b) => b.totalXP - a.totalXP)\n      .slice(0, 50);\n\n    batch.set(adminDb.collection('leaderboards').doc('global_schools'), {\n      type: 'schools',\n      schools: schoolRankings,\n      lastUpdated: admin.firestore.FieldValue.serverTimestamp(),\n      count: schoolRankings.length\n    });\n    operationCount++;\n\n    // Save individual school leaderboards (top 50 students per school)\n    schoolUserMap.forEach((users, schoolId) => {\n      const sorted = users\n        .sort((a, b) => b.xp - a.xp)\n        .slice(0, 50);\n\n      batch.set(adminDb.collection('leaderboards').doc(`school_${schoolId}`), {\n        schoolId,\n        type: 'school',\n        users: sorted,\n        lastUpdated: admin.firestore.FieldValue.serverTimestamp(),\n        count: sorted.length\n      });\n      operationCount++;\n    });\n\n    // Commit batch\n    console.log(`üíæ Committing ${operationCount} leaderboard updates...`);\n    await batch.commit();\n\n    console.log('‚úÖ Leaderboards aggregated successfully!');\n    console.log(`üìä Summary:`);\n    console.log(`   - Global XP: ${globalXPLeaderboard.length} users`);\n    console.log(`   - Global Streak: ${globalStreakLeaderboard.length} users`);\n    console.log(`   - Global Mastery: ${globalMasteryLeaderboard.length} users`);\n    console.log(`   - Schools: ${schoolMap.size} schools`);\n    console.log(`   - Total operations: ${operationCount}`);\n\n    // Calculate savings\n    const readsPerMonth = 5000 * 3 * 1500; // 5000 users √ó 3 views √ó 1500 viewers\n    const costSaved = (readsPerMonth / 100000) * 0.06;\n\n    console.log(`\\nüí∞ Estimated savings: $${costSaved.toFixed(2)}/month`);\n    console.log(`   (${(readsPerMonth / 1000000).toFixed(1)}M reads eliminated)`);\n\n  } catch (error) {\n    console.error('‚ùå Error aggregating leaderboards:', error);\n    throw error;\n  }\n}\n\n// Run the script\naggregateLeaderboards()\n  .then(() => {\n    console.log('\\n‚ú® Done!');\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error('Fatal error:', error);\n    process.exit(1);\n  });\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/cache-objective-ids.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":55,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":55,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1737,1796],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":69,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":69,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2073,2131],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":88,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":88,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2640,2687],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":89,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":89,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2692,2717],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":90,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":90,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2722,2768],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":91,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":91,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2773,2858],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":92,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":92,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2863,2919],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":97,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":97,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3089,3159],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":98,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":98,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3164,3242],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":109,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":109,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3410,3435],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Pre-compute Objective IDs Cache\n * Run this script weekly via cron to update the cache\n * \n * Usage: npx tsx scripts/cache-objective-ids.ts\n */\n\nimport * as admin from 'firebase-admin';\nimport fs from 'fs';\nimport path from 'path';\n\nfunction loadServiceAccount() {\n  const json = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON;\n  const base64 = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64;\n  const serviceAccountPathEnv = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n\n  if (typeof json === 'string' && json.trim()) {\n    return JSON.parse(json);\n  }\n\n  if (typeof base64 === 'string' && base64.trim()) {\n    const decoded = Buffer.from(base64, 'base64').toString('utf8');\n    return JSON.parse(decoded);\n  }\n\n  if (typeof serviceAccountPathEnv === 'string' && serviceAccountPathEnv.trim()) {\n    const resolvedPath = path.isAbsolute(serviceAccountPathEnv)\n      ? serviceAccountPathEnv\n      : path.join(process.cwd(), serviceAccountPathEnv);\n    if (fs.existsSync(resolvedPath)) {\n      return JSON.parse(fs.readFileSync(resolvedPath, 'utf8'));\n    }\n  }\n\n  return null;\n}\n\n// Initialize Firebase Admin directly for standalone script\nif (!admin.apps.length) {\n  const serviceAccount = loadServiceAccount();\n  if (!serviceAccount) {\n    console.error('‚ùå Firebase Admin credentials missing. Set FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON, FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64, or FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH.');\n    process.exit(1);\n  }\n\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n    databaseURL: `https://${serviceAccount.project_id}.firebaseio.com`\n  });\n}\n\nconst adminDb = admin.firestore();\n\nasync function cacheObjectiveIds() {\n  console.log('üîÑ Fetching objective IDs from Firestore...');\n\n  try {\n    const snap = await adminDb\n      .collection('questions')\n      .select('objectiveId')\n      .get();\n\n    const ids = [...new Set(\n      snap.docs\n        .map(d => d.get('objectiveId'))\n        .filter(id => typeof id === 'string' && id.length > 0)\n    )];\n\n    console.log(`‚úÖ Found ${ids.length} unique objective IDs`);\n\n    // Create data directory if it doesn't exist\n    const dataDir = path.join(process.cwd(), 'data');\n    if (!fs.existsSync(dataDir)) {\n      fs.mkdirSync(dataDir, { recursive: true });\n    }\n\n    // Write to cache file\n    const cacheData = {\n      ids,\n      timestamp: Date.now(),\n      generatedAt: new Date().toISOString(),\n      count: ids.length\n    };\n\n    const cachePath = path.join(dataDir, 'objective-ids-cache.json');\n    fs.writeFileSync(cachePath, JSON.stringify(cacheData, null, 2));\n\n    console.log(`üíæ Cache saved to: ${cachePath}`);\n    console.log(`üìä Stats:`);\n    console.log(`   - Unique IDs: ${ids.length}`);\n    console.log(`   - File size: ${(fs.statSync(cachePath).size / 1024).toFixed(2)} KB`);\n    console.log(`   - Generated: ${cacheData.generatedAt}`);\n\n    // Calculate savings\n    const readsPerMonth = 2000 * 10 * 5000; // 2000 docs √ó 10 sessions √ó 5000 users\n    const costSaved = (readsPerMonth / 100000) * 0.06;\n    console.log(`\\nüí∞ Estimated savings: $${costSaved.toFixed(2)}/month`);\n    console.log(`   (${(readsPerMonth / 1000000).toFixed(1)}M reads eliminated)`);\n\n  } catch (error) {\n    console.error('‚ùå Error caching objective IDs:', error);\n    process.exit(1);\n  }\n}\n\n// Run the script\ncacheObjectiveIds()\n  .then(() => {\n    console.log('\\n‚ú® Done!');\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error('Fatal error:', error);\n    process.exit(1);\n  });\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/migrate-questions.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":18,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":43},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":4,"column":15,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":4,"endColumn":40},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":154,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":154,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5054,5103],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":155,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":155,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5106,5174],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":167,"column":11,"nodeType":"MemberExpression","messageId":"unexpected","endLine":167,"endColumn":22,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[5655,5723],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":178,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":178,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6003,6055],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":180,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":180,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6087,6127],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":204,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":204,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6834,6894],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":207,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":207,"endColumn":14,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[6902,6974],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\nconst path = require('path');\nconst Database = require('better-sqlite3');\nconst admin = require('firebase-admin');\n\nfunction loadServiceAccount() {\n  const explicitPath = process.env.FIREBASE_SERVICE_ACCOUNT_PATH;\n  if (explicitPath && fs.existsSync(explicitPath)) {\n    return JSON.parse(fs.readFileSync(explicitPath, 'utf8'));\n  }\n\n  const rootDir = process.cwd();\n  const files = fs.readdirSync(rootDir);\n  const serviceAccountFile = files.find((f) => f.includes('firebase-adminsdk') && f.endsWith('.json'));\n  if (!serviceAccountFile) {\n    throw new Error('No Firebase Service Account key file (*firebase-adminsdk*.json) found in project root, and FIREBASE_SERVICE_ACCOUNT_PATH is not set.');\n  }\n\n  const serviceAccountPath = path.join(rootDir, serviceAccountFile);\n  return JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));\n}\n\nfunction getAdminDb() {\n  if (admin.apps.length > 0) return admin.firestore();\n  const serviceAccount = loadServiceAccount();\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount),\n    databaseURL: `https://${serviceAccount.project_id}.firebaseio.com`,\n  });\n  return admin.firestore();\n}\n\nfunction tableExists(db, tableName) {\n  const row = db\n    .prepare(\"SELECT name FROM sqlite_master WHERE type='table' AND name = ?\")\n    .get(tableName);\n  return !!row;\n}\n\nfunction getTableRowCount(db, tableName) {\n  try {\n    const row = db.prepare(`SELECT COUNT(*) as c FROM \"${tableName}\"`).get();\n    return Number(row?.c ?? 0);\n  } catch {\n    return 0;\n  }\n}\n\nfunction safeJsonParse(value, fallback) {\n  try {\n    if (typeof value === 'string') return JSON.parse(value);\n    return value ?? fallback;\n  } catch {\n    return fallback;\n  }\n}\n\nfunction normalizeQuestionRow(row, sourceTable) {\n  const nowIso = new Date().toISOString();\n\n  if (sourceTable === 'json') {\n    return {\n      id: row.id,\n      data: {\n        id: row.id,\n        objectiveId: row.objectiveId,\n        subjectId: row.subjectId,\n        variation: Number(row.variation ?? 1),\n        questionText: row.questionText || '',\n        options: typeof row.options === 'string' ? safeJsonParse(row.options, []) : (row.options || []),\n        correctAnswer: Number(row.correctAnswer ?? 0),\n        explanation: row.explanation || '',\n        storyElement: row.storyElement || 'Challenge',\n        difficulty: Number(row.difficulty ?? 5),\n        topic: row.topic || null,\n        createdAt: row.createdAt || nowIso,\n        updatedAt: row.updatedAt || nowIso,\n        migratedAt: nowIso,\n      },\n    };\n  }\n\n  if (sourceTable === 'Questions') {\n    const questionJson = safeJsonParse(row.question_json, null);\n\n    const questionText = row.questionText || questionJson?.question || '';\n    const options = Array.isArray(row.options) ? row.options : safeJsonParse(row.options, questionJson?.options || []);\n\n    return {\n      id: row.id,\n      data: {\n        id: row.id,\n        objectiveId: row.objectiveId,\n        subjectId: row.subjectId,\n        variation: Number(row.variation ?? 1),\n        questionText,\n        options,\n        correctAnswer: Number(row.correctAnswer ?? questionJson?.correctAnswer ?? 0),\n        explanation: row.explanation || questionJson?.explanation || '',\n        storyElement: row.storyElement || questionJson?.storyElement || 'Challenge',\n        difficulty: Number(row.difficulty ?? 5),\n        topic: row.topic || null,\n        createdAt: row.createdAt || nowIso,\n        updatedAt: row.updatedAt || nowIso,\n        migratedAt: nowIso,\n      },\n    };\n  }\n\n  // Legacy generator schema (generate_questions.py)\n  // columns: id, subject_id, objective_id, topic, difficulty, variation, question_json, created_at\n  const qJson = safeJsonParse(row.question_json, {});\n  const options = Array.isArray(qJson.options) ? qJson.options : [];\n\n  return {\n    id: row.id,\n    data: {\n      id: row.id,\n      objectiveId: row.objective_id,\n      subjectId: row.subject_id,\n      variation: Number(row.variation ?? 1),\n      topic: row.topic || null,\n      difficulty: Number(row.difficulty ?? 5),\n      questionText: qJson.question || '',\n      options,\n      correctAnswer: Number(qJson.correctAnswer ?? 0),\n      explanation: qJson.explanation || '',\n      storyElement: qJson.storyElement || 'Challenge',\n      createdAt: row.created_at || nowIso,\n      migratedAt: nowIso,\n    },\n  };\n}\n\nasync function migrate() {\n  const adminDb = getAdminDb();\n\n  const dbPath = path.join(process.cwd(), 'data', 'questions.db');\n  if (!fs.existsSync(dbPath)) {\n    throw new Error(`SQLite DB not found at ${dbPath}`);\n  }\n\n  const sqlite = new Database(dbPath, { readonly: true });\n\n  const candidates = ['Questions', 'questions'].filter((t) => tableExists(sqlite, t));\n  if (candidates.length === 0) {\n    throw new Error('No recognized questions table found. Expected \"Questions\" or \"questions\".');\n  }\n\n  const counts = candidates.map((t) => ({ table: t, count: getTableRowCount(sqlite, t) }));\n  counts.sort((a, b) => b.count - a.count);\n  let sourceTable = counts[0].table;\n\n  console.log('Detected question tables:', counts);\n  console.log(`Starting migration from SQLite table: ${sourceTable}`);\n\n  let rows = sqlite.prepare(`SELECT * FROM \"${sourceTable}\"`).all();\n\n  // If DB is empty, fallback to JSON file (useful for early dev seeding)\n  if (!rows || rows.length === 0) {\n    const jsonPath = path.join(process.cwd(), 'data', 'questions.json');\n    if (fs.existsSync(jsonPath)) {\n      try {\n        const fileContent = fs.readFileSync(jsonPath, 'utf8');\n        const parsed = JSON.parse(fileContent);\n        if (Array.isArray(parsed) && parsed.length > 0) {\n          console.log(`SQLite has 0 rows. Falling back to JSON: ${jsonPath}`);\n          rows = parsed;\n          // Use a synthetic sourceTable marker so normalizeQuestionRow can adapt.\n          sourceTable = 'json';\n        }\n      } catch (e) {\n        console.warn('Failed to read/parse questions.json fallback:', e?.message || e);\n      }\n    }\n  }\n\n  console.log(`Found ${rows.length} rows in SQLite.`);\n  if (rows.length === 0) {\n    console.log('No questions to migrate.');\n    return;\n  }\n\n  const batchSize = 400; // Firestore batch limit is 500\n  let totalMigrated = 0;\n\n  for (let i = 0; i < rows.length; i += batchSize) {\n    const slice = rows.slice(i, i + batchSize);\n    const batch = adminDb.batch();\n\n    for (const row of slice) {\n      const normalized = normalizeQuestionRow(row, sourceTable);\n      if (!normalized.id) continue;\n\n      // Sanity: require objectiveId + subjectId\n      if (!normalized.data.objectiveId || !normalized.data.subjectId) continue;\n\n      const ref = adminDb.collection('questions').doc(String(normalized.id));\n      batch.set(ref, normalized.data, { merge: true });\n    }\n\n    await batch.commit();\n    totalMigrated += slice.length;\n    console.log(`Migrated ~${totalMigrated}/${rows.length}...`);\n  }\n\n  console.log(`Migration complete. Total rows processed: ${rows.length}`);\n}\n\nmigrate().catch((err) => {\n  console.error('Migration failed:', err);\n  process.exitCode = 1;\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/migrate-questions.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":6,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[137,197],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":19,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":19,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[544,599],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":22,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":22,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[646,686],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":48,"column":17,"nodeType":"MemberExpression","messageId":"unexpected","endLine":48,"endColumn":28,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1524,1578],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":59,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":59,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1786,1864],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { adminDb } from '../lib/firebase-admin';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nasync function migrate() {\n    console.log('Starting migration from JSON to Firestore...');\n\n    try {\n        const jsonPath = path.join(process.cwd(), 'data', 'questions.json');\n\n        if (!fs.existsSync(jsonPath)) {\n            console.error('questions.json not found at', jsonPath);\n            return;\n        }\n\n        const fileContent = fs.readFileSync(jsonPath, 'utf8');\n        const rows = JSON.parse(fileContent);\n\n        console.log(`Found ${rows.length} questions in JSON.`);\n\n        if (rows.length === 0) {\n            console.log('No questions to migrate.');\n            return;\n        }\n\n        const batchSize = 400; // Firestore batch limit is 500\n        let batch = adminDb.batch();\n        let count = 0;\n        let totalMigrated = 0;\n\n        for (const row of rows) {\n            const docRef = adminDb.collection('questions').doc(row.id);\n\n            // Transform if necessary\n            const questionData = {\n                ...row,\n                // options is usually an array in the JSON file\n                options: typeof row.options === 'string' ? JSON.parse(row.options) : row.options,\n                migratedAt: new Date().toISOString()\n            };\n\n            batch.set(docRef, questionData, { merge: true });\n            count++;\n\n            if (count >= batchSize) {\n                await batch.commit();\n                totalMigrated += count;\n                console.log(`Migrated ${totalMigrated} questions...`);\n                batch = adminDb.batch();\n                count = 0;\n            }\n        }\n\n        if (count > 0) {\n            await batch.commit();\n            totalMigrated += count;\n        }\n\n        console.log(`Migration complete! Total questions migrated: ${totalMigrated}`);\n\n    } catch (error) {\n        console.error('Migration failed:', error);\n    }\n}\n\nmigrate();\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/seed-english.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":97,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":97,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3049,3098],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":107,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":107,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[3318,3390],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { adminDb } from '../lib/firebase-admin';\n\nconst MOCK_QUESTIONS = [\n    {\n        id: 'ENG-00002_1',\n        objectiveId: 'ENG-00002',\n        subjectId: 'English',\n        variation: 1,\n        questionText: 'Which sentence uses the correct subject-verb agreement?',\n        options: [\n            'The group of students were loud.',\n            'The group of students was loud.',\n            'The students was loud.',\n            'The group were loud.'\n        ],\n        correctAnswer: 1,\n        explanation: 'The subject \"group\" is singular, so it takes the singular verb \"was\". The phrase \"of students\" does not change the number of the subject.',\n        storyElement: 'Correct!',\n        difficulty: 3,\n        createdAt: new Date().toISOString()\n    },\n    {\n        id: 'ENG-00002_2',\n        objectiveId: 'ENG-00002',\n        subjectId: 'English',\n        variation: 2,\n        questionText: 'Identify the sentence with the correct punctuation.',\n        options: [\n            'Its a beautiful day.',\n            'It\\'s a beautiful day.',\n            'Its\\' a beautiful day.',\n            'It is a beautiful day'\n        ],\n        correctAnswer: 1,\n        explanation: '\"It\\'s\" is the contraction for \"it is\". \"Its\" is possessive.',\n        storyElement: 'Nice job!',\n        difficulty: 2,\n        createdAt: new Date().toISOString()\n    },\n    {\n        id: 'ENG-00002_3',\n        objectiveId: 'ENG-00002',\n        subjectId: 'English',\n        variation: 3,\n        questionText: 'Choose the correct form of the verb to complete the sentence: She _____ to the store yesterday.',\n        options: [\n            'go',\n            'gone',\n            'went',\n            'going'\n        ],\n        correctAnswer: 2,\n        explanation: '\"Yesterday\" indicates past tense, so \"went\" is the correct past tense form of \"go\".',\n        storyElement: 'Perfect!',\n        difficulty: 1,\n        createdAt: new Date().toISOString()\n    },\n    {\n        id: 'ENG-00002_4',\n        objectiveId: 'ENG-00002',\n        subjectId: 'English',\n        variation: 4,\n        questionText: 'Which word is a synonym for \"happy\"?',\n        options: [\n            'Sad',\n            'Angry',\n            'Joyful',\n            'Tired'\n        ],\n        correctAnswer: 2,\n        explanation: '\"Joyful\" means feeling or expressing great happiness.',\n        storyElement: 'You got it!',\n        difficulty: 1,\n        createdAt: new Date().toISOString()\n    },\n    {\n        id: 'ENG-00002_5',\n        objectiveId: 'ENG-00002',\n        subjectId: 'English',\n        variation: 5,\n        questionText: 'Identify the adjective in the sentence: The quick brown fox jumps over the lazy dog.',\n        options: [\n            'Fox',\n            'Jumps',\n            'Quick',\n            'The'\n        ],\n        correctAnswer: 2,\n        explanation: '\"Quick\" describes the noun \"fox\", making it an adjective.',\n        storyElement: 'Great work!',\n        difficulty: 2,\n        createdAt: new Date().toISOString()\n    }\n];\n\nasync function seed() {\n    console.log('Seeding mock English questions...');\n\n    const batch = adminDb.batch();\n\n    for (const q of MOCK_QUESTIONS) {\n        const ref = adminDb.collection('questions').doc(q.id);\n        batch.set(ref, q, { merge: true });\n    }\n\n    await batch.commit();\n    console.log(`Seeded ${MOCK_QUESTIONS.length} questions for ENG-00002.`);\n}\n\nseed();\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/scripts/seed-pob.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":55,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":55,"endColumn":16,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1805,1859],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":59,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":59,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[1952,2006],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":72,"column":13,"nodeType":"MemberExpression","messageId":"unexpected","endLine":72,"endColumn":24,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2429,2521],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":75,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":75,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2541,2592],"text":""},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":78,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":78,"endColumn":20,"suggestions":[{"messageId":"removeConsole","data":{"propertyName":"log"},"fix":{"range":[2649,2752],"text":""},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Seed POB Questions to Firestore\n * \n * Usage: npx tsx scripts/seed-pob.ts\n */\n\nimport * as admin from 'firebase-admin';\nimport fs from 'fs';\nimport path from 'path';\n\nfunction loadServiceAccount() {\n    const json = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON;\n    const base64 = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64;\n    const serviceAccountPathEnv = process.env.FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n\n    if (typeof json === 'string' && json.trim()) {\n        return JSON.parse(json);\n    }\n\n    if (typeof base64 === 'string' && base64.trim()) {\n        const decoded = Buffer.from(base64, 'base64').toString('utf8');\n        return JSON.parse(decoded);\n    }\n\n    if (typeof serviceAccountPathEnv === 'string' && serviceAccountPathEnv.trim()) {\n        const resolvedPath = path.isAbsolute(serviceAccountPathEnv)\n            ? serviceAccountPathEnv\n            : path.join(process.cwd(), serviceAccountPathEnv);\n        if (fs.existsSync(resolvedPath)) {\n            return JSON.parse(fs.readFileSync(resolvedPath, 'utf8'));\n        }\n    }\n\n    return null;\n}\n\n// Initialize Firebase Admin\nif (!admin.apps.length) {\n    const serviceAccount = loadServiceAccount();\n    if (!serviceAccount) {\n        console.error('‚ùå Firebase Admin credentials missing. Set FIREBASE_ADMIN_SERVICE_ACCOUNT_JSON, FIREBASE_ADMIN_SERVICE_ACCOUNT_BASE64, or FIREBASE_ADMIN_SERVICE_ACCOUNT_PATH.');\n        process.exit(1);\n    }\n\n    admin.initializeApp({\n        credential: admin.credential.cert(serviceAccount),\n        databaseURL: `https://${serviceAccount.project_id}.firebaseio.com`\n    });\n}\n\nconst adminDb = admin.firestore();\n\nasync function seedPOB() {\n    const filePath = path.join(process.cwd(), 'data', 'pob-question-template.json');\n    console.log(`üîÑ Reading questions from: ${filePath}`);\n\n    try {\n        const questions = JSON.parse(fs.readFileSync(filePath, 'utf8'));\n        console.log(`‚úÖ Loaded ${questions.length} questions`);\n\n        const batchSize = 500;\n        for (let i = 0; i < questions.length; i += batchSize) {\n            const batch = adminDb.batch();\n            const chunk = questions.slice(i, i + batchSize);\n\n            for (const q of chunk) {\n                const ref = adminDb.collection('questions').doc(q.id);\n                batch.set(ref, q, { merge: true });\n            }\n\n            await batch.commit();\n            console.log(`Û∞Ñ¨ Seeded batch ${Math.floor(i / batchSize) + 1} (${chunk.length} questions)`);\n        }\n\n        console.log('\\n‚ú® Seeding completed successfully!');\n\n        // Also trigger cache update if needed\n        console.log('üîÑ Suggestion: Run npx tsx scripts/cache-objective-ids.ts to update the frontend cache.');\n\n    } catch (error) {\n        console.error('‚ùå Error seeding questions:', error);\n        process.exit(1);\n    }\n}\n\nseedPOB()\n    .then(() => process.exit(0))\n    .catch((error) => {\n        console.error('Fatal error:', error);\n        process.exit(1);\n    });\n","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/testing.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'sales' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":10},{"ruleId":"prefer-const","severity":2,"message":"'sales' is never reassigned. Use 'const' instead.","line":1,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":1,"endColumn":10,"fix":{"range":[0,16],"text":"const sales = 123;"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'course' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":2,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":11},{"ruleId":"prefer-const","severity":2,"message":"'course' is never reassigned. Use 'const' instead.","line":2,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":2,"endColumn":11,"fix":{"range":[17,44],"text":"const course = 'Hello World';"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isVerified' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":3,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":15},{"ruleId":"prefer-const","severity":2,"message":"'isVerified' is never reassigned. Use 'const' instead.","line":3,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":3,"endColumn":15,"fix":{"range":[45,67],"text":"const isVerified = true;"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'level' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":11,"column":1,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'render' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'document' is defined but never used. Allowed unused args must match /^_/u.","line":16,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[183,186],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[183,186],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'numbers' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":21,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":12},{"ruleId":"prefer-const","severity":2,"message":"'numbers' is never reassigned. Use 'const' instead.","line":21,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":21,"endColumn":12,"fix":{"range":[203,227],"text":"const numbers = [1, 2, 3];"}}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":4,"fixableWarningCount":0,"source":"let sales = 123;\nlet course = 'Hello World';\nlet isVerified = true;\nlet level;\n\n// Number\nlevel = 1;\n\n//Iterating on Level\n\nlevel = 'string';\n\n\n// Function\n\nfunction render(document: any) {\n\n}\n\n// Array\nlet numbers = [1, 2, 3];","usedDeprecatedRules":[]},{"filePath":"/home/kai/Documents/BrightEd/vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Question {
  id              String   @id @default(uuid())
  objectiveId     String
  subjectId       String
  questionText    String
  correctAnswer   Int
  explanation     String
  storyElement    String
  difficulty      Float    @default(1.0) // 1.0 to 10.0 scale
  variation       Int      @default(0)
  tags            String   @default("[]") // JSON array of topics/tags
  prerequisites   String   @default("[]") // JSON array of required objective IDs
  createdAt       DateTime @default(now())
  
  options         Option[]
  simulationSteps SimulationStep[]
  
  @@index([objectiveId])
  @@index([subjectId])
  @@index([difficulty])
}

model Option {
  id         String   @id @default(uuid())
  questionId String
  text       String
  order      Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model SimulationStep {
  id            String   @id @default(uuid())
  questionId    String
  stepOrder     Int      // 1: decision, 2: outcome, 3: explanation, 4: reflection
  stepType      String   // decision, outcome, explanation, reflection
  content       String
  storyElement  String?
  question      Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model UserProgress {
  id            String   @id @default(uuid())
  userId        String   @default("user") // Single user for now
  objectiveId   String
  subjectId     String
  stars         Int      @default(0) // 0-3
  completed     Boolean  @default(false)
  score         Int      @default(0)
  attempts      Int      @default(0)
  correctRate   Float    @default(0)
  avgResponseTime Float  @default(0) // behavioral signal
  lastAttempt   DateTime @default(now())
  
  @@unique([userId, objectiveId])
}

// =============================================================================
// STORIES ENGINE — Consequence-based simulations (separate from Whiteboard)
// =============================================================================

model Story {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  subject     String   // business, science, math, language, etc.
  config      String   // JSON: timeMultiplier, delays, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sessions    StorySession[]
}

model StoriesPlayerProfile {
  id                 String   @id @default(uuid())
  userId             String   @unique
  intent             String   @default("learner") // learner | owner | both
  onboardingStatus   String   @default("none")    // none | basic | complete
  ageBracket         String   // junior | secondary | senior | adult
  skills             String   // JSON: { financialLiteracy, discipline, ... }
  reputation         String   // JSON: { [npcId]: number, [institutionId]: number }
  bCoins             Int      @default(100)
  timeUnits          Int      @default(100)
  inventory          String   // JSON: { [itemId]: number }
  energy             Int      @default(100)
  financialData      String   @default("{}") // JSON: creditCardTier, interestRate, etc.
  activeConsequences String   // JSON: [{ id, type, expiresAt, effect }]
  lastSimulatedAt    DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  sessions           StorySession[]
  npcMemories        NPCMemory[]
  businesses         Business[]
}

model Business {
  id               String   @id @default(uuid())
  profileId        String
  name             String
  category         String
  description      String?
  status           String   @default("active")
  valuation        Int      @default(0)
  cashFlow         Int      @default(0)
  financialHistory String   @default("[]") // JSON array of performance snapshots
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  profile          StoriesPlayerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model StorySession {
  id               String   @id @default(uuid())
  userId           String
  storyId          String
  state            String   // active | paused | completed | failed
  snapshot         String   // JSON: resources, reputation at start
  businessState    String?  // JSON: Phase 1 business sim (registration, cash, loans, etc.)
  difficultyContext String  // JSON: { ageBracket, skillLevel, ... }
  startedAt        DateTime @default(now())
  lastPlayedAt     DateTime @default(now())
  completedAt      DateTime?
  profile          StoriesPlayerProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  story            Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  decisions        DecisionLog[]
  consequences     Consequence[]
  @@index([userId])
  @@index([storyId])
  @@index([state])
}

model DecisionLog {
  id        String   @id @default(uuid())
  sessionId String
  choiceId  String
  payload   String   // JSON: action-specific data
  at        DateTime @default(now())
  resolved  Boolean  @default(false)
  session   StorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  consequences Consequence[]
  @@index([sessionId])
}

model Consequence {
  id          String   @id @default(uuid())
  decisionId  String
  sessionId   String
  type        String   // immediate | delayed
  scheduledAt DateTime?
  ruleId      String
  effects     String   // JSON: [{ system, key, delta }]
  appliedAt   DateTime?
  decision    DecisionLog @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  session     StorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  @@index([sessionId])
  @@index([scheduledAt])
}

model NPC {
  id            String   @id @default(uuid())
  role          String   // banker, supplier, regulator, client, teacher
  institutionId String
  name          String
  config        String   // JSON: bureaucracy, response curves, etc.
  memories      NPCMemory[]
}

model NPCMemory {
  id               String   @id @default(uuid())
  userId           String
  npcId            String
  interactions     String   // JSON: [{ at, action, outcome, tone }]
  lastInteractionAt DateTime @default(now())
  sentiment        Float    @default(0) // -1..1
  profile          StoriesPlayerProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  npc              NPC      @relation(fields: [npcId], references: [id], onDelete: Cascade)
  @@unique([userId, npcId])
  @@index([npcId])
}

// =============================================================================
// ECONOMY ENGINE — Order-driven business simulation
// =============================================================================

model EconomyProfile {
  id             String   @id @default(uuid())
  firebaseId     String   @unique  // Links to Firebase business document
  userId         String
  businessTypeId String   // salon, minimart, foodtruck, freelance_design
  businessName   String
  cashBalance    Int      @default(500)
  reputation     Int      @default(50)  // 0-100
  customerSat    Int      @default(70)  // Customer satisfaction 0-100
  operatingHours String   @default("{\"open\":8,\"close\":20}")
  staffCount     Int      @default(1)
  inventory      String   @default("{}")  // JSON: { itemId: quantity }
  ordersCompleted Int     @default(0)
  ordersFailed   Int      @default(0)
  totalRevenue   Int      @default(0)
  totalExpenses  Int      @default(0)
  lastTickAt     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  orders         EconomyOrder[]
  expenses       EconomyExpense[]
  
  @@index([userId])
  @@index([firebaseId])
}

model EconomyOrder {
  id              String   @id @default(uuid())
  profileId       String
  customerName    String
  customerType    String   // walk_in, regular, business, vip
  customerMood    String   @default("neutral")
  items           String   // JSON: [{ productId, productName, quantity, pricePerUnit, costPerUnit, qualityTier }]
  totalAmount     Int
  costAmount      Int
  status          String   // pending, accepted, in_progress, completed, failed, cancelled, expired
  deadline        DateTime
  expiresAt       DateTime
  paymentTerms    String   // JSON: { type, upfrontPercent, netDays, collectionRisk }
  qualityReq      String   @default("standard")  // basic, standard, premium
  qualityScore    Float?
  paidAmount      Int      @default(0)
  tipAmount       Int      @default(0)
  createdAt       DateTime @default(now())
  acceptedAt      DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  failedAt        DateTime?
  
  profile         EconomyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId, status])
  @@index([deadline])
  @@index([status])
}

model EconomyExpense {
  id          String   @id @default(uuid())
  profileId   String
  category    String   // rent, utilities, staff, supplies, inventory, maintenance, license, loan_payment, tax
  amount      Int
  description String
  dueAt       DateTime
  paidAt      DateTime?
  recurring   Boolean  @default(false)
  frequency   String?  // daily, weekly, monthly
  
  profile     EconomyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
  @@index([dueAt])
}
